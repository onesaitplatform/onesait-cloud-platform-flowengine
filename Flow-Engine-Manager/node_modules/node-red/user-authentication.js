var request = require('request');
var onesaitPlatformConfig = require('../../onesait-platform/nodes/config/onesait-platform-config.js');
module.exports = {
   type: "credentials",
   users: function(username) {
       return new Promise(function(resolve) {
           // Do whatever work is needed to check username is a valid
           // user.
           var valid = true;
           if (valid) {
               // Resolve with the user object. It must contain
               // properties 'username' and 'permissions'
               var user = { username: username, permissions: "*" };
               resolve(user);
           } else {
               // Resolve with null to indicate this user does not exist
               resolve(null);
           }
       });
   },
   authenticate: function(username,password) {
       return new Promise(function(resolve) {
           // Do whatever work is needed to validate the username/password
           // combination.

           var valid = false;           
           var opts = {};
              opts.url = onesaitPlatformConfig.consoleBasePath + '/controlpanel/nodered/auth/'+username+'/'+password;
              //opts.timeout = node.reqTimeout;
              opts.method = 'GET';
              opts.headers = {
                'Accept': 'application/json',
                'Accept-Charset': 'utf-8',
                'User-Agent': 'my-reddit-client'
              };
              opts.maxRedirects = 21;
              try{
                request(opts, function(err, res, body) {
                  if(!err && res.statusCode == 200){
                    var user = { username: username, permissions: "*" };
                    // Resolve with the user object. Equivalent to having called users(username);
                     resolve(user);
                  } else {
                      console.error("Login failed"+err+" "+opts.url);
                    // Resolve with null to indicate the username/password pair were not valid.
                   resolve(null);
                  }
                });
              }catch(e){
                // Resolve with null to indicate the username/password pair were not valid.
                  console.error("Exception login in "+e);
               resolve(null);
              }
              
               

       });
   },
   default: function() {
       return new Promise(function(resolve) {
           // Resolve with the user object for the default user.
           // If no default user exists, resolve with null.
           resolve({anonymous: false, permissions:"none"});
       });
   }
}
