'use strict';

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _resolve = require('resolve');

var _resolve2 = _interopRequireDefault(_resolve);

var _deepmerge = require('deepmerge');

var _deepmerge2 = _interopRequireDefault(_deepmerge);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

module.exports = function (grunt) {
    grunt.registerMultiTask('webdriver', 'run wdio test runner', function () {
        var done = this.async();
        var opts = (0, _deepmerge2.default)(this.options(), this.data);
        var Launcher = require(_path2.default.join(_path2.default.dirname(_resolve2.default.sync('webdriverio')), 'lib/launcher'));

        if (typeof opts.configFile !== 'string') {
            grunt.log.error('You need to define "configFile" property with the path to your wdio.conf.js');
            return done(1);
        }

        var wdio = new Launcher(opts.configFile, opts);

        grunt.log.debug('spawn wdio with these attributes:\n' + JSON.stringify(opts, null, 2));
        return wdio.run().then(function (code) {
            grunt.log.debug('wdio testrunner finished with exit code ' + code);
            return done(code === 0);
        }, function (e) {
            grunt.log.error('Something went wrong: ' + e);
            return done(false);
        });
    });
};
