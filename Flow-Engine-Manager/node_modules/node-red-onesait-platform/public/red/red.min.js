var RED={};RED.events=function(){var e={};return{on:function(t,n){e[t]=e[t]||[],e[t].push(n)},off:function(t,n){var o=e[t];if(o)for(var i=0;i<o.length;i++)if(o[i]===n)return void o.splice(i,1)},emit:function(t,n){if(e[t])for(var o=0;o<e[t].length;o++)try{e[t][o](n)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n={init:function(e){i18n.init({resGetPath:"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1},function(){e()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(e,t){var n=i18n.functions.toLanguages(i18n.detectLanguage()),o=n.length;n.forEach(function(n){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/"+e+"?lng="+n,success:function(i){i18n.addResourceBundle(n,e,i),0==--o&&t()}})})},loadNodeCatalogs:function(e){var t=i18n.functions.toLanguages(i18n.detectLanguage()),n=t.length;t.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/nodes?lng="+t,success:function(o){Object.keys(o).forEach(function(e){i18n.addResourceBundle(t,e,o[e])}),0==--n&&e()}})})}},RED.settings=function(){var e,t={},n={},o=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},i=function(e){n=e},a=function(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(n){!function(e){for(var n in t)t.hasOwnProperty(n)&&RED.settings.hasOwnProperty(n)&&delete RED.settings[n];for(n in e)e.hasOwnProperty(n)&&(RED.settings[n]=e[n]);t=e}(n),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+n.version),s(e)},error:function(t,n,o){401===t.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&function(e){var t=window.location.search.split("?");if(t.length>=2){for(var n=t[1].split(/[&;]/g),o=0;o<n.length;o++)if(n[o].startsWith(e+"=")){n.splice(o,1);break}window.location.search=n.join("&")}}("access_token"),RED.user.login(function(){a(e)})):console.log("Unexpected error loading settings:",t.status,n)}})};function s(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(t){i(t),e()},error:function(e,t,n){console.log("Unexpected error loading user settings:",e.status,t)}})}function r(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout(function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(n),success:function(e){},error:function(e,t,n){console.log("Unexpected error saving user settings:",e.status,t)}})},300))}return{init:function(e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var n=t[1];RED.settings.set("auth-tokens",{access_token:n})}$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){var n=RED.settings.get("auth-tokens");n&&e.setRequestHeader("Authorization","Bearer "+n.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),a(e)},load:a,loadUserSettings:s,set:function(e,t){o()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(n[e]=t,r()))},get:function(e){if(o())return"auth-tokens"===e?JSON.parse(localStorage.getItem(e)):n[e]},remove:function(e){o()&&("auth-tokens"===e?localStorage.removeItem(e):(delete n[e],r()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var n=e.split("."),o=RED.settings.editorTheme;try{for(var i=0;i<n.length;i++)o=o[n[i]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function e(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),e(),RED.events.emit("login",RED.settings.user.username)})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var t=/^((.+)\.)?read$/,n=/^((.+)\.)?write$/;return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var t=$('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"></a></li>').prependTo(".header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(t.find("a")):$('<i class="fa fa-user"></i>').appendTo(t.find("a")),RED.menu.init({id:"btn-usermenu",options:[]}),e()}},login:function(t,n){"function"==typeof t&&(n=t,t={});var o=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');o.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!!t.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(i){var a=0;if("credentials"==i.type){for(;a<i.prompts.length;a++){var s=i.prompts[a],r=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+s.id+'">'+RED._(s.label)+":</label><br/>").appendTo(r);var d=$('<input style="width: 100%" id="node-dialog-login-'+s.id+'" type="'+s.type+'" tabIndex="'+(a+1)+'"/>').appendTo(r);a<i.prompts.length-1&&d.keypress(function(){var e=r;return function(t){13==t.keyCode&&(e.next("div").find("input").focus(),t.preventDefault())}}()),r.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(t.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(a+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(a+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(o){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var a={client_id:"node-red-editor",grant_type:"password",scope:""},s=0;s<i.prompts.length;s++){var r=i.prompts[s];a[r.id]=$("#node-dialog-login-"+r.id).val()}$.ajax({url:"auth/token",type:"POST",data:a}).done(function(o,i,a){RED.settings.set("auth-tokens",o),$("#node-dialog-login").dialog("destroy").remove(),t.updateMenu&&e(),n()}).fail(function(e,t,n){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),o.preventDefault()})}else if("strategy"==i.type)for(a=0;a<i.prompts.length;a++){s=i.prompts[a],r=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var l=$('<a href="#"></a>',{style:"padding: 10px"}).appendTo(r).click(function(){document.location=s.url});if(s.image)$("<img>",{src:s.image}).appendTo(l);else if(s.label){var c=$("<span></span>").text(s.label);s.icon&&($("<i></i>",{class:"fa fa-2x "+s.icon,style:"vertical-align: middle"}).appendTo(l),c.css({verticalAlign:"middle",marginLeft:"8px"})),c.appendTo(l)}l.button()}t.cancelable&&$("#node-dialog-login-cancel").button().click(function(e){$("#node-dialog-login").dialog("destroy").remove()});var p=i.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){o.dialog("open")}).attr("src",p)}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done(function(e,t,n){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,n){401===e.status?document.location.reload(!0):console.log(t)})},hasPermission:function(e){return""===e||!RED.settings.user||function e(o,i){if(""===i)return!0;var a;if(Array.isArray(i)){for(a=0;a<i.length;a++)if(!e(o,i[a]))return!1;return!0}if(Array.isArray(o)){if(0===o.length)return!1;for(a=0;a<o.length;a++)if(e(o[a],i))return!0;return!1}return"*"===o||o===i||("read"===o||"*.read"===o?t.test(i):("write"===o||"*.write"===o)&&n.test(i))}(RED.settings.user.permissions||"",e)}}}(),RED.comms=function(){var e,t=null,n=null,o=null,i=10,a={},s=!1,r=0,d=!1;return{connect:function l(){d=!0;var c=location.hostname,p=location.port;0!==p.length&&(c=c+":"+p),c=(c+=document.location.pathname)+("/"==c.slice(-1)?"":"/")+"comms",c="ws"+("https:"==document.location.protocol?"s":"")+"://"+c;var u=RED.settings.get("auth-tokens");function f(){for(var t in a)a.hasOwnProperty(t)&&e.send(JSON.stringify({subscribe:t}))}s=null!=u,(e=new WebSocket(c)).onopen=function(){r=0,t&&(n=setTimeout(function(){t.close(),t=null},1e3)),s?e.send(JSON.stringify({auth:u.access_token})):f()},e.onmessage=function(e){for(var t=JSON.parse(e.data),n=0;n<t.length;n++){var o=t[n];if(s&&o.auth)"ok"===o.auth?(s=!1,f()):"fail"===o.auth&&(d=!1,RED.user.login({updateMenu:!0},function(){l()}));else if(o.topic)for(var i in a)if(a.hasOwnProperty(i)&&new RegExp("^"+i.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(o.topic)){var r=a[i];if(r)for(var c=0;c<r.length;c++)r[c](o.topic,o.data)}}},e.onclose=function(){d&&(n&&(clearTimeout(n),n=null),++r<10?(setTimeout(l,1e3),r>5&&null==t&&(t=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):r<20?setTimeout(l,2e3):(i=60,o=setInterval(function(){if(0==--i)t.update(RED._("notification.errors.lostConnection")),clearInterval(o),l();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:i})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";t.update(e),$(t).find("a").click(function(e){e.preventDefault(),t.update(RED._("notification.errors.lostConnection")),clearInterval(o),l()})}},1e3)))}},subscribe:function(t,n){null==a[t]&&(a[t]=[]),a[t].push(n),e&&1==e.readyState&&e.send(JSON.stringify({subscribe:t}))},unsubscribe:function(e,t){if(a[e]){for(var n=0;n<a[e].length;n++)if(a[e][n]===t){a[e].splice(n,1);break}0===a[e].length&&delete a[e]}}}}(),RED.text={},RED.text.bidi=function(){var e="",t="‪",n="‫",o="‬";function i(e){return e>64&&e<91||e>96&&e<123}function a(t){return"auto"==e?function(e){for(var t,n=e.length,o=0;o<n;o++){if((t=e.charCodeAt(o))>=1488&&t<=1535||t>=1536&&t<=1631||t>=1642&&t<=1775||t>=1786&&t<=2047||t>=64285&&t<=65023||t>=65136&&t<=65276)return!0;if(i(e.charCodeAt(o)))return!1}return!1}(t)?"rtl":"ltr":e}function s(){$(this).attr("dir",a($(this).val()))}return{setTextDirection:function(t){e=t,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",a($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",a($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var i=a(e);if("ltr"==i)return t+e+o;if("rtl"==i)return n+e+o}return e},resolveBaseTextDir:a,prepareInput:function(e){e.on("keyup",s).on("paste",s).on("cut",s),s.call(e)}}}(),RED.text.format=function(){var e=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},t=function(){function t(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var n=parseInt(e.length,10);return isNaN(n)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function n(e,t){var n={};for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o]);var i=e.content,a=n.usePos&&n.startPos<i.length;a&&(n.start="",n.loops=!1),n.bStart=a?n.startPos:n.start.length>0?i.indexOf(n.start):0;var s=n.useLength&&n.length>0&&n.bStart+n.length<i.length;return s&&(n.end=""),n.bEnd=s?n.bStart+n.length:n.end.length>0?i.indexOf(n.end,n.bStart+n.start.length)+1:i.length,n.after||(n.start=""),n.before||(n.end=""),n}return{handleSubcontents:function(t,n,o,i,a){if(!o.content||"string"!=typeof o.content||0===o.content.length)return t;var s=!0;void 0!==o.loops&&(s=!!o.loops);for(var r=0;!(r>=t.length);r++)if(!(t[r].isParsed||t.keep||t[r].isSeparator)){var d=t[r].content,l=d.indexOf(o.content);if(!(l<0)){var c,p=0;if(o.continued)do{p++,c=d.indexOf(o.content,l+p*o.content.length)}while(0===c);else p=1;if(c=l+p*o.content.length,t.splice(r,1),l>0&&(t.splice(r,0,new e({content:d.substring(0,l),localGui:n.dir,keep:!0})),r++),t.splice(r,0,new e({content:d.substring(l,c),textDirection:o.subDir,localGui:n.dir})),c<d.length&&t.splice(r+1,0,new e({content:d.substring(c,d.length),localGui:n.dir,keep:!0})),!s)break}}},handleBounds:function(o,i,a,s,r){for(var d=0;d<a.length;d++)if(t(a[d]))for(var l=0;!(l>=o.length);l++)if(!(o[l].isParsed||o[l].inBounds||o.keep||o[l].isSeparator)){var c=n(o[l],a[d]),p=c.bStart,u=c.bEnd;if(!(p<0||u<0)){var f=o[l].content;if(o.splice(l,1),p>0&&(o.splice(l,0,new e({content:f.substring(0,p),localGui:i.dir,keep:!0})),l++),c.start&&(o.splice(l,0,new e({content:c.start,localGui:i.dir,isSeparator:!0})),l++),o.splice(l,0,new e({content:f.substring(p+c.start.length,u-c.end.length),textDirection:c.subDir,localGui:i.dir,inBounds:!0})),c.end&&(l++,o.splice(l,0,new e({content:c.end,localGui:i.dir,isSeparator:!0}))),u+c.end.length<f.length&&o.splice(l+1,0,new e({content:f.substring(u+c.end.length,f.length),localGui:i.dir,keep:!0})),!c.loops)break}}for(d=0;d<o.length;d++)o[d].inBounds=!1;return o},handleCases:function(e,t,n,o,i){if(0===n.length)return e;var a={};for(var s in t)t.hasOwnProperty(s)&&(a[s]=t[s]);for(var r=0;r<n.length;r++)n[r].handler&&"function"==typeof n[r].handler.handle||(n[r].handler=t.commonHandler),n[r].args?(a.cases=n[r].args.cases,a.points=n[r].args.points,a.bounds=n[r].args.bounds,a.subs=n[r].args.subs):(a.cases=[],a.points=[],a.bounds=[],a.subs={}),n[r].handler.handle(o,e,a,i);return e},handlePoints:function(t,n,o,i,a){for(var s=0;s<o.length;s++)for(var r=0;!(r>=t.length);r++)if(!(t[r].isParsed||t[r].keep||t[r].isSeparator)){var d=t[r].content,l=d.indexOf(o[s]);l>=0&&(t.splice(r,1),l>0&&(t.splice(r,0,new e({content:d.substring(0,l),textDirection:n.subDir,localGui:n.dir,inPoints:!0})),r++),t.splice(r,0,new e({content:o[s],localGui:n.dir,isSeparator:!0})),l+o[s].length+1<=d.length&&t.splice(r+1,0,new e({content:d.substring(l+o[s].length),textDirection:n.subDir,localGui:n.dir,inPoints:!0})))}for(s=0;s<t.length;s++)t[s].keep?t[s].keep=!1:t[s].inPoints&&(t[s].isParsed=!0,t[s].inPoints=!1);return t}}}(),n={handle:function(e,n,o,i){var a=[];Array.isArray(o.cases)&&(a=o.cases);var s=[];void 0!==o.points&&(Array.isArray(o.points)?s=o.points:"string"==typeof o.points&&(s=o.points.split("")));var r={};"object"==typeof o.subs&&(r=o.subs);var d=[];return Array.isArray(o.bounds)&&(d=o.bounds),t.handleBounds(n,o,d,e,i),t.handleSubcontents(n,o,r,e,i),t.handleCases(n,o,a,e,i),t.handlePoints(n,o,s,e,i),n}},o={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),function(e){var t=e?e.split("-")[0]:"";return!(!t||t.length<2)&&["iw","he","ar","fa","ur"].some(function(e){return e===t})}(e=e.toLowerCase())){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,n,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;n=/^(rtl|ltr)$/i.test(n)?n:"ltr";var i=o?e.split("").reverse().join(""):e,a=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(i);return a?a[0]<="z"?"ltr":"rtl":n},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var n="",o=0;o<e.length;o++){var i=""+e.charAt(o);switch(i){case"‎":n+="<LRM>";break;case"‏":n+="<RLM>";break;case"‪":n+="<LRE>";break;case"‫":n+="<RLE>";break;case"‭":n+="<LRO>";break;case"‮":n+="<RLO>";break;case"‬":n+="<PDF>";break;default:n+=i}}var a=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return a+n+(""===a?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},i=function(){var t={};function i(e,t){var o=Array.isArray(e)?e[0]:e;return o.guiDir||(o.guiDir="ltr"),o.dir||(o.dir=o.guiDir),t?(void 0===o.points&&(o.points=[]),o.cases||(o.cases=[]),o.bounds||(o.bounds=[]),o.commonHandler=n,o):o}function a(t,o,a){if(!t||!o)return new e({content:""});var s=i(o,!0),r=[new e({content:t,actual:t,localGui:s.dir})],d=n.handle;return s.handler&&"function"==typeof s.handler&&(d=s.handler.handle),d(t,r,s,a),r}function s(e,t,n){var a=i(t,!1);return n?function(e,t,n){for(var i="",a="",s=0;s<e.length;s++)if(e[s].isVisible){var r=e[s].textDirection,d=e[s].localGui;if(""!==d&&""===a?i+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>":""===a||""!==d&&d===a&&!stop||(i+="</bdi>"+(s==e.length-1&&""!==d?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==d&&(i+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>")),"auto"===r&&(r=o.getDirection(e[s].content,r,t.guiDir)),/^(rtl|ltr)$/i.test(r)?(i+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>"+e[s].content+"</bdi>",r):(i+=e[s].content,o.getDirection(e[s].content,r,t.guiDir,!0)),s<e.length-1){var l=d&&e[s+1].localGui?d:t.dir;i+="<span style='unicode-bidi: embed; direction: "+("rtl"===l?"rtl":"ltr")+";'></span>"}else""!==a&&(i+="</bdi>");a=d,stop=!1}else stop=!0;var c="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(i="<bdi dir='"+("rtl"===c?"rtl":"ltr")+"'>"+i+"</bdi>");return i}(e,a):function(e,t,n){for(var i="",a="",s=!1,r=0;r<e.length;r++)if(e[r].isVisible){var d=e[r].textDirection,l=e[r].localGui;if(""!==l&&""===a?i+="rtl"===l?o.RLE:o.LRE:""===a||""!==l&&l===a&&!s||(i+=o.PDF+(r==e.length-1&&""!==l?"":"rtl"===t.dir?o.RLM:o.LRM),""!==l&&(i+="rtl"===l?o.RLE:o.LRE)),"auto"===d&&(d=o.getDirection(e[r].content,d,t.guiDir)),/^(rtl|ltr)$/i.test(d)?(i+=("rtl"===d?o.RLE:o.LRE)+e[r].content+o.PDF,d):(i+=e[r].content,o.getDirection(e[r].content,d,t.guiDir,!0)),r<e.length-1){var c=l&&e[r+1].localGui?l:t.dir;i+="rtl"===c?o.RLM:o.LRM}else""!==a&&(i+=o.PDF);a=l,s=!1}else s=!0;var p="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;p!==t.guiDir&&(i=("rtl"===p?o.RLE:o.LRE)+i+o.PDF);return i}(e,a)}return t.parseAndDisplayStructure=function(e,t,n,o){return e&&t?s(a(e,t,o),t,n):e},t.parseStructure=a,t.displayStructure=s,t.restore=function(e,t){return e},t}(),a={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",subs:{content:">",continued:!0,subDir:n?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:n?"ltr":"rtl"}}}]};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},s={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:","};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},r=function(){function e(e,t){if("ar"!==o.getLocaleDetails(t).lang)return"ltr";var n=e.indexOf("@");return n>0&&n<e.length-1&&o.hasArabicChar(e.substring(n+1))?"rtl":"ltr"}return{format:function(t,o,a,s,r,d){var l={guiDir:a?"rtl":"ltr",dir:e(t,r),points:"<>.:,;@",cases:[{handler:n,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return d?i.parseStructure(t,l,!!s,r):i.parseAndDisplayStructure(t,l,!!s,r)}}}(),d={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"/\\:."};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},l={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},c={format:function(e,t,o,a,s,r){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:n,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:n,args:{subs:{content:" ",continued:!0}}},{handler:n,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return r?i.parseStructure(e,d,!!a,s):i.parseAndDisplayStructure(e,d,!!a,s)}},p={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"_"};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},u={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},f={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",points:" ,.!?;:"};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},h={format:function(e,t,o,a,s,r){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:n,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return r?i.parseStructure(e,d,!!a,s):i.parseAndDisplayStructure(e,d,!!a,s)}},g={format:function(e,t,n,o,a,s){var r={},d="",l=Array.isArray(t)?t[0]:t;for(d in l)l.hasOwnProperty(d)&&(r[d]=l[d]);return r.guiDir=n?"rtl":"ltr",r.dir=r.dir?r.dir:r.guiDir,s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},v=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function n(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function o(e){0===e.msgDir.length&&(e.msgDir=n(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:n(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function b(e){switch(e){case"breadcrumb":return a;case"comma":return s;case"email":return r;case"filepath":return d;case"formula":return l;case"sql":return c;case"underscore":return p;case"url":return u;case"word":return f;case"xpath":return h;default:return g}}function m(e,t,n,i,a){if(!e||1!=e.nodeType)return!1;v||(v=document.createEvent("Event")).initEvent("TF",!0,!0),e.setAttribute("data-tf-type",t);var s="undefined"===n?"{}":JSON.stringify(Array.isArray(n)?n[0]:n);e.setAttribute("data-tf-args",s);var r="ltr";if("undefined"===i&&(e.dir?r=e.dir:e.style&&e.style.direction&&(r=e.style.direction),i="rtl"===r.toLowerCase()),e.setAttribute("data-tf-dir",i),e.setAttribute("data-tf-locale",o.getLocaleDetails(a).lang),function(e){var t=window.navigator.userAgent;if(t.indexOf("MSIE")>=0||t.indexOf("Trident")>=0||t.indexOf("Edge")>=0)return!1;var n=document.createElement(e.tagName);n.contentEditable=!0;var o="oninput"in n;return o||(n.setAttribute("oninput","return;"),o="function"==typeof n.oninput),n=null,o}(e)){e.oninput;e.oninput=function(e){y(e.target)}}else e.onkeyup=function(t){y(t.target),e.dispatchEvent(v)},e.onmouseup=function(t){y(t.target),e.dispatchEvent(v)};return y(e),!0}function y(e){var t=e.textContent||"",n=document.getSelection();if(0===t.length||!n||n.rangeCount<=0)e.dispatchEvent(v);else{var o,i,a=n.getRangeAt(0),s=a.cloneRange();o=a.startContainer,i=a.startOffset;var r=0;3===o.nodeType&&(r+=i),s.setStart(e,0),s.setEndBefore(o);var d=document.createElement("div");d.appendChild(s.cloneContents()),r+=d.textContent.length,e.innerHTML=b(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var l=e,c=e,p=0,u=!1;for(n.removeAllRanges(),a.setStart(e,0),a.setEnd(e,0);c;){if(3===c.nodeType){if(p+c.nodeValue.length>=r){a.setStart(c,r-p);break}p+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(l=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(l===e){u=!0;break}c=l.nextSibling,l=l.parentNode}if(u)break}n.addRange(a),e.dispatchEvent(v)}}return{getHtml:function(e,t,n,o,i){return b(t).format(e,n,o,!0,i)},attach:function(e,t,n,o,i){return m(e,t,n,o,i)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9,PANNING:10},RED.nodes=function(){var e,t,o=[],a={},s=[],r={},d=[],l={},c=null,p=!1;var u=function(){var e={},t=[],n={},o={},i={},a={};i.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}};var s={setModulePendingUpdated:function(t,n){e[t].pending_version=n,RED.events.emit("registry:module-updated",{module:t,version:n})},getModule:function(t){return e[t]},getNodeSetForType:function(e){return s.getNodeSet(o[e])},getModuleList:function(){return e},getNodeList:function(){return t},getNodeTypes:function(){return Object.keys(i)},setNodeList:function(e){t=[];for(var n=0;n<e.length;n++){var o=e[n];s.addNodeSet(o)}},addNodeSet:function(i){i.added=!1,n[i.id]=i;for(var a=0;a<i.types.length;a++)o[i.types[a]]=i.id;t.push(i),e[i.module]=e[i.module]||{name:i.module,version:i.version,local:i.local,sets:{}},i.pending_version&&(e[i.module].pending_version=i.pending_version),e[i.module].sets[i.name]=i,RED.events.emit("registry:node-set-added",i)},removeNodeSet:function(i){for(var a=n[i],s=0;s<a.types.length;s++)delete o[a.types[s]];delete n[i];for(var r=0;r<t.length;r++)if(t[r].id===i){t.splice(r,1);break}return delete e[a.module].sets[a.name],0===Object.keys(e[a.module].sets).length&&delete e[a.module],RED.events.emit("registry:node-set-removed",a),a},getNodeSet:function(e){return n[e]},enableNodeSet:function(e){var t=n[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=n[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var a;(i[e]=t,t.type=e,"subflow:"!=e.substring(0,8))&&(t.set=n[o[e]],n[o[e]].added=!0,n[o[e]].enabled=!0,a="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=a+":"+e[0]);var n=RED._.apply(null,e);return n===e[0]&&(n=t),n});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete i[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return i[e]},setIconSets:function(e){a=e},getIconSets:function(){return a}};return s}();function f(){return(1+4294967295*Math.random()).toString(16)}function h(e){if(0!==e.type.indexOf("subflow")?e._=e._def._:e._=RED._,"config"==e._def.category)a[e.id]=e;else{if(e.ports=[],e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.outputs)for(var t=0;t<e.outputs;t++)e.ports.push(t);if(e.dirty=!0,C(e),"subflows"==e._def.category&&void 0===e.i){var n=0;RED.nodes.eachNode(function(e){n=Math.max(n,e.i||0)}),e.i=n+1}o.push(e)}RED.events.emit("nodes:add",e)}function g(e){s.push(e)}function v(e){if(e in a)return a[e];for(var t in o)if(o[t].id==e)return o[t];return null}function b(e){var t,i=[],r=[];if(e in a)t=a[e],delete a[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=v(e)){o.splice(o.indexOf(t),1),(i=s.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){s.splice(s.indexOf(e),1)});var d=!1;for(var l in t._def.defaults)if(t._def.defaults.hasOwnProperty(l)){var c=t._def.defaults[l];if(c.type){var p=u.getNodeType(c.type);if(p&&"config"==p.category){var f=a[t[l]];if(f)if(d=!0,f._def.exclusive)b(t[l]),r.push(f);else{var h=f.users;h.splice(h.indexOf(t),1)}}}}d&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:i,nodes:r}}function m(e){r[e.id]=e,e._def=RED.nodes.getType("tab"),d.push(e.id)}function y(e,t){if(t){var n=Object.keys(l).map(function(e){return l[e].name});n.sort();var o=1,i=e.name;n.forEach(function(t){i==t&&(o++,i=e.name+" ("+o+")")}),e.name=i}l[e.id]=e,RED.nodes.registerType("subflow:"+e.id,{defaults:{name:{value:""}},info:e.info,icon:function(){return e.icon||"subflow.png"},category:e.category||"subflows",inputs:e.in.length,outputs:e.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(e.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(e.id).name},inputLabels:function(t){return e.inputLabels?e.inputLabels[t]:null},outputLabels:function(t){return e.outputLabels?e.outputLabels[t]:null},set:{module:"node-red"}}),e._def=RED.nodes.getType("subflow:"+e.id)}function w(e){return l[e]}function D(e,t){for(var n=0;n<o.length;n++){var i=o[n];if(i.z===e){var a=/^subflow:(.+)$/.exec(i.type);if(a){if(a[1]===t)return!0;if(D(a[1],t))return!0}}}return!1}function E(e){var t={};for(var n in t.id=e.id,t.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(t[n]=e[n]);return t}function R(e,t){if("tab"===e.type)return E(e);t=t||!1;var n={};if(n.id=e.id,n.type=e.type,n.z=e.z,"unknown"==n.type)for(var o in e._orig)e._orig.hasOwnProperty(o)&&(n[o]=e._orig[o]);else{for(var i in e._def.defaults)e._def.defaults.hasOwnProperty(i)&&(n[i]=e[i]);if(t&&e.credentials){var a={};for(var r in n.credentials={},e._def.credentials)e._def.credentials.hasOwnProperty(r)&&("password"==e._def.credentials[r].type?(!e.credentials._||e.credentials["has_"+r]!=e.credentials._["has_"+r]||e.credentials["has_"+r]&&e.credentials[r])&&(a[r]=e.credentials[r]):null==e.credentials[r]||e.credentials._&&e.credentials[r]==e.credentials._[r]||(a[r]=e.credentials[r]));Object.keys(a).length>0&&(n.credentials=a)}}if("config"!=e._def.category){n.x=e.x,n.y=e.y,n.wires=[];for(var d=0;d<e.outputs;d++)n.wires.push([]);for(var l=s.filter(function(t){return t.source===e}),c=0;c<l.length;c++){var p=l[c];"subflow"!=p.target.type&&p.sourcePort<n.wires.length&&n.wires[p.sourcePort].push(p.target.id)}if(e.inputs>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(n.inputLabels=e.inputLabels.slice()),e.outputs>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(n.outputLabels=e.outputLabels.slice()),(!e._def.defaults||!e._def.defaults.hasOwnProperty("icon"))&&e.icon){var u=RED.utils.getDefaultNodeIcon(e._def,e);e.icon!==u.module+"/"+u.file&&(n.icon=e.icon)}}return n}function x(e){var t={};return t.id=e.id,t.type=e.type,t.name=e.name,t.info=e.info,t.category=e.category,t.in=[],t.out=[],e.in.forEach(function(e){for(var n={x:e.x,y:e.y,wires:[]},o=s.filter(function(t){return t.source===e}),i=0;i<o.length;i++){var a=o[i];"subflow"!=a.target.type&&n.wires.push({id:a.target.id})}t.in.push(n)}),e.out.forEach(function(n,o){var a={x:n.x,y:n.y,wires:[]},r=s.filter(function(e){return e.target===n});for(i=0;i<r.length;i++)"subflow"!=r[i].source.type?a.wires.push({id:r[i].source.id,port:r[i].sourcePort}):a.wires.push({id:e.id,port:0});t.out.push(a)}),t.in.length>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(t.inputLabels=e.inputLabels.slice()),t.out.length>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(t.outputLabels=e.outputLabels.slice()),e.icon&&"node-red/subflow.png"!==e.icon&&(t.icon=e.icon),t}function T(e,t,n){var o=[];n=n||{},t=t||{};for(var i=0;i<e.length;i++){var s=e[i];if("subflow:"==s.type.substring(0,8)){var r=s.type.substring(8);if(!t[r]){t[r]=!0;var d=[w(r)];RED.nodes.eachNode(function(e){e.z==r&&d.push(e)}),o=T(d,t,n).concat(o)}}if("subflow"!=s.type){var l=RED.nodes.convertNode(s);for(var c in s._def.defaults)if(s._def.defaults[c].type&&s[c]in a){var p=a[s[c]],f=u.getNodeType(s._def.defaults[c].type).exportable;null==f||f?s[c]in n||(n[s[c]]=!0,e.push(p)):l[c]=""}o.push(l)}else{var h=x(s);o.push(h)}}return o}function _(e,t){var n,o=null;try{RED.nodes.eachSubflow(function(i){if(i.name==e.name&&i.info==e.info&&i.in.length==e.in.length&&i.out.length==e.out.length){var a=RED.nodes.filterNodes({z:i.id});if(a.length==t.length){var s=[e].concat(t),r=[i].concat(a),d=JSON.stringify(s),l=JSON.stringify(T(r));for(n=0;n<a.length;n++)d=d.replace(new RegExp('"'+t[n].id+'"',"g"),'"'+a[n].id+'"');if((d=d.replace(new RegExp('"'+e.id+'"',"g"),'"'+i.id+'"'))===l)throw o=i,new Error}}})}catch(e){console.log(e.stack)}return o}function k(e,t,n){if(n&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var i in o.defaults)if(o.defaults.hasOwnProperty(i)){var a=e[i],s=t[i];if(typeof a!=typeof s)return!1;if(null===a||"string"==typeof a||"number"==typeof a){if(a!==s)return!1}else if(JSON.stringify(a)!==JSON.stringify(s))return!1}return!0}function j(n,o,i){var s,d,l,c={};if("string"==typeof n){if(""===n)return;try{l=JSON.parse(n)}catch(j){var p=new Error(RED._("clipboard.invalidFlow",{message:j.message}));throw p.code="NODE_RED",p}}else l=n;$.isArray(l)||(l=[l]);var v=!1;t||(v=!0,t=JSON.parse(JSON.stringify(l)));var b=[];for(s=0;s<l.length;s++)"workspace"==(d=l[s]).type||"tab"==d.type||"subflow"==d.type||u.getNodeType(d.type)||"subflow:"==d.type.substring(0,8)||-1!=b.indexOf(d.type)||b.push(d.type),d.z&&(c[d.z]=c[d.z]||[],c[d.z].push(d));if(!v&&b.length>0){var E="<ul><li>"+b.join("</li><li>")+"</li></ul>";b.length;RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:b.length})+"</p>"+E,"error",!1,1e4)}var R=RED.workspaces.active(),x=w(R);for(s=0;s<l.length;s++){var T=/^subflow:(.+)$/.exec(l[s].type);if(T){var j,C=T[1],S=w(l[s].z||R);if(S)if(C===S.id&&(j=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),D(C,S.id)&&(j=new Error(RED._("notification.errors.cannotAddCircularReference"))),j)throw j.code="NODE_RED",j}}var O,L,P,N,I=[],z={},A=[],M={},B={},J={},U=[],V=[],F=null;for(s=0;s<l.length;s++)if("workspace"===(d=l[s]).type||"tab"===d.type)"workspace"===d.type&&(d.type="tab"),null==e&&(e=d),o&&(O=f(),z[d.id]=O,d.id=O),m(d),RED.workspaces.add(d),I.push(d);else if("subflow"===d.type){var G=_(d,c[d.id]);G?B[d.id]=G:(M[d.id]=d,o&&(O=f(),d.id=O),d.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=d.id,e.i=t,e.id=f()}),d.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=d.id,e.i=t,e.id=f()}),A.push(d),y(d,o))}for(null==e&&(m(e={type:"tab",id:f(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(e),I.push(e),R=RED.workspaces.active()),s=0;s<l.length;s++)if(d=l[s],(L=u.getNodeType(d.type))&&"config"==L.category){var q=null;if(o){if(d.z){if(B[d.z])continue;M[d.z]?d.z=M[d.z].id:(d.z=z[d.z],r[d.z]||(i?(null===F&&(F=RED.workspaces.add(null,!0),I.push(F)),d.z=F.id):d.z=R))}if((q=RED.nodes.node(d.id))&&d.z&&q.z!==d.z)for(var W in q=null,a)if(a.hasOwnProperty(W)&&a[W].z===d.z&&k(a[W],d,!1)){q=a[W],J[d.id]=a[W];break}}if(!q||q._def.exclusive){for(N in P={id:d.id,z:d.z,type:d.type,users:[],_config:{}},L.defaults)L.defaults.hasOwnProperty(N)&&(P[N]=d[N],P._config[N]=JSON.stringify(d[N]));if(L.hasOwnProperty("credentials")&&d.hasOwnProperty("credentials"))for(N in P.credentials={},L.credentials)L.credentials.hasOwnProperty(N)&&d.credentials.hasOwnProperty(N)&&(P.credentials[N]=d.credentials[N]);P.label=L.label,P._def=L,o&&(P.id=f()),J[d.id]=P,U.push(P),RED.nodes.add(P)}}for(s=0;s<l.length;s++)if("workspace"!==(d=l[s]).type&&"tab"!==d.type&&"subflow"!==d.type&&(!(L=u.getNodeType(d.type))||"config"!=L.category)){var H={x:d.x,y:d.y,z:d.z,type:0,wires:d.wires,inputLabels:d.inputLabels,outputLabels:d.outputLabels,icon:d.icon,changed:!1,_config:{}};if(o){if(B[d.z])continue;M[H.z]?H.z=M[H.z].id:(H.z=z[H.z],r[H.z]||(i?(null===F&&(F=RED.workspaces.add(null,!0),I.push(F)),H.z=F.id):H.z=R)),H.id=f()}else H.id=d.id,null!=H.z&&(r[H.z]||M[H.z])||(i?(null===F&&(F=RED.workspaces.add(null,!0),I.push(F)),H.z=F.id):H.z=R);if(H.type=d.type,H._def=L,"subflow"===d.type.substring(0,7)){var K=d.type.split(":")[1],X=B[K]||M[K]||w(K);o&&(K=X.id,H.type="subflow:"+K,H._def=u.getNodeType(H.type),delete H.i),H.name=d.name,H.outputs=X.out.length,H.inputs=X.in.length}else{if(!H._def){H.x&&H.y?H._def={color:"#fee",defaults:{},label:"unknown: "+d.type,labelStyle:"node_label_italic",outputs:d.outputs||d.wires.length,set:u.getNodeSet("node-red/unknown")}:(H._def={category:"config",set:u.getNodeSet("node-red/unknown")},H.users=[],delete H.x,delete H.y,delete H.wires,delete H.inputLabels,delete H.outputLabels);var Y={};for(var Q in d)d.hasOwnProperty(Q)&&"x"!=Q&&"y"!=Q&&"z"!=Q&&"id"!=Q&&"wires"!=Q&&(Y[Q]=d[Q]);H._orig=Y,H.name=d.type,H.type="unknown"}if("config"!=H._def.category){for(N in d.hasOwnProperty("inputs")?(H.inputs=d.inputs,H._config.inputs=JSON.stringify(d.inputs)):H.inputs=H._def.inputs,d.hasOwnProperty("outputs")?(H.outputs=d.outputs,H._config.outputs=JSON.stringify(d.outputs)):H.outputs=H._def.outputs,H.hasOwnProperty("wires")&&H.wires.length>H.outputs&&(H._def.defaults.hasOwnProperty("outputs")&&isNaN(parseInt(d.outputs))?H.outputs=H.wires.length:(console.log("Warning: node.wires longer than node.outputs - trimming wires:",H.id," wires:",H.wires.length," outputs:",H.outputs),H.wires=H.wires.slice(0,H.outputs))),H._def.defaults)H._def.defaults.hasOwnProperty(N)&&"inputs"!==N&&"outputs"!==N&&(H[N]=d[N],H._config[N]=JSON.stringify(d[N]));if(H._config.x=H.x,H._config.y=H.y,H._def.hasOwnProperty("credentials")&&d.hasOwnProperty("credentials"))for(N in H.credentials={},H._def.credentials)H._def.credentials.hasOwnProperty(N)&&d.credentials.hasOwnProperty(N)&&(H.credentials[N]=d.credentials[N])}}h(H),RED.editor.validateNode(H),J[d.id]=H,"unknown"!==H.type&&"config"===H._def.category||U.push(H)}var Z={catch:"scope",status:"scope","link in":"links","link out":"links"};for(s=0;s<U.length;s++){if((d=U[s]).wires){for(var ee=0;ee<d.wires.length;ee++)for(var te=d.wires[ee]instanceof Array?d.wires[ee]:[d.wires[ee]],ne=0;ne<te.length;ne++)if(J.hasOwnProperty(te[ne]))if(d.z===J[te[ne]].z){var oe={source:d,sourcePort:ee,target:J[te[ne]]};g(oe),V.push(oe)}else console.log("Warning: dropping link that crosses tabs:",d.id,"->",J[te[ne]].id);delete d.wires}for(var ie in d._def.defaults)if(d._def.defaults.hasOwnProperty(ie))if(d._def.defaults[ie].type&&J[d[ie]])d[ie]=J[d[ie]].id,(P=RED.nodes.node(d[ie]))&&-1===P.users.indexOf(d)&&P.users.push(d);else if(Z.hasOwnProperty(d.type)&&Z[d.type]===ie&&void 0!==d[ie]&&null!==d[ie])for(var ae=0;ae<d[ie].length;ae++)J[d[ie][ae]]&&(d[ie][ae]=J[d[ie][ae]].id);x&&/^link /.test(d.type)&&d.links&&(d.links=d.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===R})),RED.editor.validateNode(d)}for(s=0;s<A.length;s++)(d=A[s]).in.forEach(function(e){e.wires.forEach(function(t){var n={source:e,sourcePort:0,target:J[t.id]};g(n),V.push(n)}),delete e.wires}),d.out.forEach(function(e){e.wires.forEach(function(t){var n;g(n=M[t.id]&&M[t.id].id==d.id?{source:d.in[t.port],sourcePort:t.port,target:e}:{source:J[t.id]||M[t.id],sourcePort:t.port,target:e}),V.push(n)}),delete e.wires});return RED.workspaces.refresh(),[U,V,I,A,F]}function C(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var n=e._def.defaults[t];if(n.type){var o=u.getNodeType(n.type);if(o&&"config"==o.category){var i=a[e[t]];i&&-1===i.users.indexOf(e)&&i.users.push(e)}}}}return{init:function(){RED.events.on("registry:node-type-added",function(e){u.getNodeType(e);var t=[];if(RED.nodes.eachNode(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),RED.nodes.eachConfig(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),t.length>0){var n=[];t.forEach(function(e){a.hasOwnProperty(e.id)?delete a[e.id]:o.splice(o.indexOf(e),1),n.push(R(e))}),RED.view.redraw(!0);var i=j(n,!1),s={};i[0].forEach(function(e){s[e.id]=e}),RED.nodes.eachLink(function(e){s.hasOwnProperty(e.source.id)&&(e.source=s[e.source.id]),s.hasOwnProperty(e.target.id)&&(e.target=s[e.target.id])}),RED.view.redraw(!0)}})},registry:u,setNodeList:u.setNodeList,getNodeSet:u.getNodeSet,addNodeSet:u.addNodeSet,removeNodeSet:u.removeNodeSet,enableNodeSet:u.enableNodeSet,disableNodeSet:u.disableNodeSet,setIconSets:u.setIconSets,getIconSets:u.getIconSets,registerType:u.registerNodeType,getType:u.getNodeType,convertNode:R,add:h,remove:b,clear:function(){o=[],s=[],a={},d=[],Object.keys(l).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(r).forEach(function(e){RED.workspaces.remove(r[e])}),e=null,t=null,RED.nodes.dirty(!1),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh()},addLink:g,removeLink:function(e){var t=s.indexOf(e);-1!=t&&s.splice(t,1)},addWorkspace:m,removeWorkspace:function(e){delete r[e],d.splice(d.indexOf(e),1);var t,n,i=[],s=[];for(t=0;t<o.length;t++)(n=o[t]).z==e&&i.push(n);for(t in a)a.hasOwnProperty(t)&&(n=a[t]).z==e&&i.push(n);for(t=0;t<i.length;t++){var l=b(i[t].id);s=s.concat(l.links)}return{nodes:i,links:s}},getWorkspaceOrder:function(){return d},setWorkspaceOrder:function(e){d=e},workspace:function(e){return r[e]},addSubflow:y,removeSubflow:function(e){delete l[e.id],u.removeNodeType("subflow:"+e.id)},subflow:w,subflowContains:D,eachNode:function(e){for(var t=0;t<o.length;t++)e(o[t])},eachLink:function(e){for(var t=0;t<s.length;t++)e(s[t])},eachConfig:function(e){for(var t in a)a.hasOwnProperty(t)&&e(a[t])},eachSubflow:function(e){for(var t in l)l.hasOwnProperty(t)&&e(l[t])},eachWorkspace:function(e){for(var t=0;t<d.length;t++)e(r[d[t]])},node:v,version:function(e){if(void 0===e)return c;c=e},originalFlow:function(e){if(void 0===e)return t;t=e},filterNodes:function(e){for(var t=[],n=0;n<o.length;n++){var i=o[n];e.hasOwnProperty("z")&&i.z!==e.z||e.hasOwnProperty("type")&&i.type!==e.type||t.push(i)}return t},filterLinks:function(e){for(var t=[],n=0;n<s.length;n++){var o=s[n];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||t.push(o)}return t},import:j,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var n=[e],o=[e];0!==o.length;)for(var i=o.shift(),a=s.filter(function(e){return e.source===i||e.target===i}),r=0;r<a.length;r++){var d=a[r].source===i?a[r].target:a[r].source,l=d.id;l||(l=d.direction+":"+d.i),t[l]||(t[l]=!0,n.push(d),o.push(d))}return n},createExportableNodeSet:T,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,n=[];for(t=0;t<d.length;t++)"tab"==r[d[t]].type&&n.push(E(r[d[t]]));for(t in l)l.hasOwnProperty(t)&&n.push(x(l[t]));for(t in a)a.hasOwnProperty(t)&&n.push(R(a[t],e));for(t=0;t<o.length;t++){var i=o[t];n.push(R(i,e))}return n},updateConfigNodeUsers:C,id:f,dirty:function(e){if(null==e)return p;!function(e){p=e,RED.events.emit("nodes:change",{dirty:p})}(e)}}}(),RED.history=function(){var e=[];return{markAllDirty:function(){for(var t=0;t<e.length;t++)e[t].dirty=!0},list:function(){return e},depth:function(){return e.length},push:function(t){e.push(t)},pop:function(){!function e(t){var n,o,i,a={};if(t){if("multi"==t.t)for(n=t.events.length-1;n>=0;n--)e(t.events[n]);else if("replace"==t.t)RED.nodes.clear(),RED.nodes.import(t.config)[0].forEach(function(e){t.changed[e.id]&&(e.changed=!0)}),RED.nodes.version(t.rev);else if("add"==t.t){if(t.nodes)for(n=0;n<t.nodes.length;n++)(o=RED.nodes.node(t.nodes[n])).z&&(a[o.z]=!0),RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.removeWorkspace(t.workspaces[n].id),RED.workspaces.remove(t.workspaces[n]);if(t.subflows)for(n=0;n<t.subflows.length;n++)RED.nodes.removeSubflow(t.subflows[n]),RED.workspaces.remove(t.subflows[n]);if(t.subflow&&(t.subflow.instances&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("changed")&&(i=RED.nodes.subflow(t.subflow.id))&&(i.changed=t.subflow.changed)),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("delete"==t.t){if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.addWorkspace(t.workspaces[n]),RED.workspaces.add(t.workspaces[n]);if(t.subflow&&t.subflow.subflow&&RED.nodes.addSubflow(t.subflow.subflow),t.subflowInputs&&t.subflowInputs.length>0&&((i=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),i.in[0].dirty=!0),t.subflowOutputs&&t.subflowOutputs.length>0)for(i=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),n=0;n<t.subflowOutputs.length;n++){var s=t.subflowOutputs[n];i.out.splice(s.i,0,s);for(var r=s.i+1;r<i.out.length;r++)i.out[r].i++,i.out[r].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+i.id&&e.sourcePort>=s.i&&e.sourcePort++})}if(t.subflow&&t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),i&&RED.nodes.filterNodes({type:"subflow:"+i.id}).forEach(function(e){for(e.inputs=i.in.length,e.outputs=i.out.length;e.outputs>e.ports.length;)e.ports.push(e.ports.length);e.resize=!0,e.dirty=!0}),t.nodes)for(n=0;n<t.nodes.length;n++)RED.nodes.add(t.nodes[n]),a[t.nodes[n].z]=!0;if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);if(t.changes)for(n in t.changes)if(t.changes.hasOwnProperty(n)&&(o=RED.nodes.node(n))){for(var d in t.changes[n])t.changes[n].hasOwnProperty(d)&&(o[d]=t.changes[n][d]);o.dirty=!0}}else if("move"==t.t){for(n=0;n<t.nodes.length;n++){var l=t.nodes[n];l.n.x=l.ox,l.n.y=l.oy,l.n.dirty=!0,l.n.moved=l.moved}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("edit"==t.t){for(n in t.changes)if(t.changes.hasOwnProperty(n)){if(t.node._def.defaults&&t.node._def.defaults[n]&&t.node._def.defaults[n].type){var c=RED.nodes.node(t.node[n]);c&&c.users.splice(c.users.indexOf(t.node),1);var p=RED.nodes.node(t.changes[n]);p&&p.users.push(t.node)}t.node[n]=t.changes[n]}if(t.subflow)t.subflow.hasOwnProperty("inputCount")&&(t.node.in.length>t.subflow.inputCount?t.node.in.splice(t.subflow.inputCount):t.subflow.inputs.length>0&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(t.node.out.length>t.subflow.outputCount?t.node.out.splice(t.subflow.outputCount):t.subflow.outputs.length>0&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),RED.editor.validateNode(t.node),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e),RED.editor.validateNode(e)});else{var u;if(t.outputMap)for(var f in u={},t.outputMap)t.outputMap.hasOwnProperty(f)&&"-1"!==t.outputMap[f]&&(u[t.outputMap[f]]=f);RED.editor.updateNodeProperties(t.node,u),RED.editor.validateNode(t.node)}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(t.nodes)for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).forEach(function(e){e.z=t.activeWorkspace,e.dirty=!0}),n=0;n<t.nodes.length;n++)RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else"reorder"==t.t&&t.order&&RED.workspaces.order(t.order);Object.keys(a).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(t.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}}(e.pop())},peek:function(){return e[e.length-1]},clear:function(){e=[]}}}(),RED.validators={number:function(e){return function(t){return e&&(""===t||void 0===t)||""!==t&&!isNaN(t)}},regex:function(e){return function(t){return e.test(t)}},typedInput:function(e,t){return function(n){var o=$("#node-"+(t?"config-":"")+"input-"+e).val()||this[e];if("json"===o)try{return JSON.parse(n),!0}catch(e){return!1}else{if("msg"===o||"flow"===o||"global"===o)return RED.utils.validatePropertyExpression(n);if("num"===o)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(n)}return!0}}},RED.utils=function(){function e(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function t(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function n(n){var o;if(Array.isArray(n))o=$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("array["+n.length+"]");else if(null===n)o=$('<span class="debug-message-object-value debug-message-type-null">null</span>');else if("object"==typeof n)o=n.hasOwnProperty("type")&&"Buffer"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("buffer["+n.length+"]"):n.hasOwnProperty("type")&&"array"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("array["+n.length+"]"):n.hasOwnProperty("type")&&"function"===n.type?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("function"):n.hasOwnProperty("type")&&"number"===n.type?$('<span class="debug-message-object-value debug-message-type-number"></span>').text(n.data):$('<span class="debug-message-object-value debug-message-type-meta">object</span>');else if("string"==typeof n){var i;i=n.length>30?t(n.substring(0,30))+"&hellip;":t(n),o=$('<span class="debug-message-object-value debug-message-type-string"></span>').html('"'+e(i)+'"')}else o="number"==typeof n?$('<span class="debug-message-object-value debug-message-type-number"></span>').text(""+n):$('<span class="debug-message-object-value debug-message-type-other"></span>').text(""+n);return o}function o(e,t,n,o){e.addClass("debug-message-expandable"),e.prop("toggle",function(){return function(n){var o=e.parent();if(o.hasClass("collapsed")){if(n)return t&&!o.hasClass("built")&&(t(),o.addClass("built")),o.removeClass("collapsed"),!0}else if(!n)return o.addClass("collapsed"),!0;return!1}}),e.click(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&n&&n(!t),e.preventDefault()}),o&&e.click()}var i={},a={};function s(e,t,n,o){if(t&&t.length>0){if(""===e&&void 0===n)return!0;for(var i=0;i<t.length;i++){var a=t[i];if(0===a.indexOf(e)&&("."===a[e.length]||"["===a[e.length])){if(void 0===n||"["!==a[e.length])return!0;var s=a.substring(e.length),r=/\[(\d+)\]/.exec(s);if(r){var d=parseInt(r[1]);return n<=d&&d<=o}}}}return!1}function r(e,t,n,o,i,s){var r=a[n]&&a[n][o]&&a[n][o].number||s||"dec";i?(r="dec"===r?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===r||"dateS"==r?"hex":"dec",a[n]=a[n]||{},a[n][o]=a[n][o]||{},a[n][o].number=r):void 0!==s&&(a[n]=a[n]||{},a[n][o]=a[n][o]||{},a[n][o].number=r),"dec"===r?e.text(""+t):"dateMS"===r?e.text(new Date(t).toISOString()):"dateS"===r?e.text(new Date(1e3*t).toISOString()):"hex"===r&&e.text("0x"+t.toString(16))}function d(e,t,n,o,i){var s=a[n]&&a[n][o]&&a[n][o].buffer||"raw";i&&(s="raw"===s?"string":"raw",a[n]=a[n]||{},a[n][o]=a[n][o]||{},a[n][o].buffer=s),"raw"===s?(t.text("raw"),e.removeClass("debug-message-buffer-string").addClass("debug-message-buffer-raw")):"string"===s&&(t.text("string"),e.addClass("debug-message-buffer-string").removeClass("debug-message-buffer-raw"))}function l(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var n,o,i=[],a=0,s=!1,r=!1,d=0;d<t;d++){var l=e[d];if(s){if(l===n){if(d-a==0)throw new Error("Invalid property expression: zero-length string at position "+a);if(i.push(e.substring(a,d)),r&&!/\]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected array expression at position "+a);if(!r&&d+1!==t&&!/[\[\.]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" expression at position "+(d+1));a=d+1,s=!1}}else if("'"===l||'"'===l){if(d!=a)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);s=!0,n=l,a=d+1}else if("."===l){if(0===d)throw new Error("Invalid property expression: unexpected . at position 0");if(a!=d&&(o=e.substring(a,d),/^\d+$/.test(o)?i.push(parseInt(o)):i.push(o)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1}else if("["===l){if(0===d)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d&&i.push(e.substring(a,d)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1,r=!0}else if("]"===l){if(!r)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d){if(o=e.substring(a,d),!/^\d+$/.test(o))throw new Error("Invalid property expression: unexpected array expression at position "+a);i.push(parseInt(o))}a=d+1,r=!1}else if(" "===l)throw new Error("Invalid property expression: unexpected ' ' at position "+d)}if(r||s)throw new Error("Invalid property expression: unterminated expression");return a<t&&i.push(e.substring(a)),i}function c(e,t){var n,o=null;return"string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),n=l(t)):n=t,n.reduce(function(e,t){return void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(o=void 0!==e.data[t]?e.data[t]:void 0),o},e),o}function p(e){var t={module:"",file:""};if(e){var n=e.indexOf("/");-1!==n?(t.module=e.slice(0,n),t.file=e.slice(n+1)):t.file=e}return t}function u(e,t){var n;if(t&&"subflow"===t.type)n="node-red/subflow.png";else if("function"==typeof e.icon)try{n=e.icon.call(t)}catch(t){console.log("Definition error: "+e.type+".icon",t),n="arrow-in.png"}else n=e.icon;var o=p(n);return o.module||(e.set?o.module=e.set.module:o.module="node-red"),o}function f(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}var h={};return{createObjectElement:function a(p,u){var f,h,g,v,b,m,y=(u=u||{}).key,w=u.typeHint,D=u.hideKey,E=u.path,R=u.sourceId,x=u.rootPath,T=u.expandPaths,_=u.ontoggle,k=u.exposeApi,j={};void 0!==E&&void 0!==x&&(m=E.substring(x.length+("."===E[x.length]?1:0)));var C=$('<span class="debug-message-element"></span>');if(C.collapse=function(){C.find(".debug-message-expandable").parent().addClass("collapsed")},v=$('<span class="debug-message-row"></span>').appendTo(C),R&&function(e,t,n,o,a,s){i.hasOwnProperty(t)||(i[t]={});var r=$('<span class="debug-message-tools"></span>').appendTo(e),d=$('<span class="debug-message-tools-copy button-group"></span>').appendTo(r);if(n)var c=$('<button class="editor-button editor-button-small"><i class="fa fa-terminal"></i></button>').appendTo(d).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(n,c,"clipboard.copyMessagePath")});var p=$('<button class="editor-button editor-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(d).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(o,p,"clipboard.copyMessageValue")});if(void 0!==s&&""!==s){var u=i[t].hasOwnProperty(s);$('<button class="editor-button editor-button-small debug-message-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(r).click(function(n){if(n.preventDefault(),n.stopPropagation(),i[t].hasOwnProperty(s))delete i[t][s],$(this).removeClass("selected"),e.removeClass("debug-message-row-pinned");else{var o="$"+("["===s[0]?"":".")+s;i[t][s]=l(o),$(this).addClass("selected"),e.addClass("debug-message-row-pinned")}}).toggleClass("selected",u),e.toggleClass("debug-message-row-pinned",u)}}(v,R,E,p,0,m),y)D||($('<span class="debug-message-object-key"></span>').text(y).appendTo(v),$("<span>: </span>").appendTo(v));else if(C.addClass("debug-message-top-level"),R){var S=i[R];if(T=[],S){for(var O in S)if(S.hasOwnProperty(O))try{void 0!==c({$:p},S[O])&&T.push(O)}catch(e){}T.sort()}C.clearPinned=function(){C.find(".debug-message-row-pinned").removeClass("debug-message-row-pinned"),i[R]={}}}g=$('<span class="debug-message-object-value"></span>').appendTo(v);var L=Array.isArray(p),P=!1;if(p&&"object"==typeof p&&p.hasOwnProperty("type")&&p.hasOwnProperty("data")&&(p.__enc__&&"array"===p.type||"Buffer"===p.type)&&(L=!0,P=!0),null==p)$('<span class="debug-message-type-null">'+p+"</span>").appendTo(g);else if(p.__enc__&&"number"===p.type)h=$('<span class="debug-message-type-number debug-message-object-header"></span>').text(p.data).appendTo(g);else if("function"===w||p.__enc__&&"function"===p.type)h=$('<span class="debug-message-type-meta debug-message-object-header"></span>').text("function").appendTo(g);else if("internal"===w||p.__enc__&&"internal"===p.type)h=$('<span class="debug-message-type-meta debug-message-object-header"></span>').text("[internal]").appendTo(g);else if("string"==typeof p)/[\t\n\r]/.test(p)&&(C.addClass("collapsed"),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text(w||"string").appendTo(v);var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(C);$('<pre class="debug-message-type-string"></pre>').text(p).appendTo(e)},function(e){_&&_(E,e)},s(m,T))),h=$('<span class="debug-message-type-string debug-message-object-header"></span>').html('"'+e(t(p))+'"').appendTo(g),/^#[0-9a-f]{6}$/i.test(p)&&$('<span class="debug-message-type-string-swatch"></span>').css("backgroundColor",p).appendTo(h);else if("number"==typeof p)h=$('<span class="debug-message-type-number"></span>').appendTo(g),Number.isInteger(p)&&p>=0&&(h.addClass("debug-message-type-number-toggle"),h.click(function(e){e.preventDefault(),r($(this),p,R,E,!0)})),r(h,p,R,E,!1,"hex"===w?"hex":void 0);else if(L){C.addClass("collapsed");var N=p.length;if(w){var I=/\[(\d+)\]/.exec(w);I&&(N=parseInt(I[1]))}var z=p,A="array";P?(z=p.data,void 0===N&&(N=z.length),z.__enc__&&(z=z.data),A=p.type.toLowerCase()):/buffer/.test(w)&&(A="buffer");var M=z.length;if(N>0){$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v);var B=$('<div class="debug-message-array-rows"></div>').appendTo(C);C.addClass("debug-message-buffer-raw")}if(y)b=$('<span class="debug-message-type-meta"></span>').text(w||A+"["+N+"]").appendTo(g);else{b=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>[ </span>").appendTo(b);var J=Math.min(N,10);for(f=0;f<J;f++)n(z[f]).appendTo(b),f<J-1&&$("<span>, </span>").appendTo(b);N>J&&$("<span> &hellip;</span>").appendTo(b),0===J&&$('<span class="debug-message-type-meta">empty</span>').appendTo(b),$("<span> ]</span>").appendTo(b)}N>0&&o(v,function(){if(y||(b=$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text(w||A+"["+N+"]").appendTo(v)),"buffer"===A){var e=$('<div class="debug-message-string-rows"></div>').appendTo(C),t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(e),n="";try{n=String.fromCharCode.apply(null,new Uint16Array(z))}catch(e){console.log(e)}$('<pre class="debug-message-type-string"></pre>').text(n).appendTo(t);var i=$('<span class="debug-message-buffer-opts"></span>').appendTo(b),r=$('<a href="#"></a>').addClass("selected").text("raw").appendTo(i).click(function(e){e.preventDefault(),e.stopPropagation(),d(C,$(this),R,E,!0)});d(C,r,R,E,!1)}var l;if(M<=10)for(f=0;f<M;f++)l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),j[E+"["+f+"]"]=a(z[f],{key:""+f,typeHint:"buffer"===A&&"hex",hideKey:!1,path:E+"["+f+"]",sourceId:R,rootPath:x,expandPaths:T,ontoggle:_,exposeApi:k}).appendTo(l);else{for(f=0;f<M;f+=10){var c=f;l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),v=$("<span></span>").appendTo(l),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').appendTo(v),o(v,function(){var e=c,t=Math.min(M-1,c+9),n=l;return function(){for(var o=e;o<=t;o++){var i=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(n);j[E+"["+o+"]"]=a(z[o],{key:""+o,typeHint:"buffer"===A&&"hex",hideKey:!1,path:E+"["+o+"]",sourceId:R,rootPath:x,expandPaths:T,ontoggle:_,exposeApi:k}).appendTo(i)}}}(),function(){var e=e+"["+f+"]";return function(t){_&&_(e,t)}}(),s(m,T,c,Math.min(M-1,c+9))),$('<span class="debug-message-object-key"></span>').html("["+c+" &hellip; "+Math.min(M-1,c+9)+"]").appendTo(v)}M<N&&$('<div class="debug-message-object-entry collapsed"><span class="debug-message-object-key">['+M+" &hellip; "+N+"]</span></div>").appendTo(B)}},function(e){_&&_(E,e)},s(m,T))}else if("object"==typeof p){C.addClass("collapsed");var U=Object.keys(p);if((y||U.length>0)&&($('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){for(y||$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text("object").appendTo(v),f=0;f<U.length;f++){var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(C),t=E;void 0!==t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(U[f])?t+=(t.length>0?".":"")+U[f]:t+='["'+U[f].replace(/"/,'\\"')+'"]'),j[t]=a(p[U[f]],{key:U[f],typeHint:!1,hideKey:!1,path:t,sourceId:R,rootPath:x,expandPaths:T,ontoggle:_,exposeApi:k}).appendTo(e)}0===U.length&&$('<div class="debug-message-object-entry debug-message-type-meta collapsed"></div>').text("empty").appendTo(C)},function(e){_&&_(E,e)},s(m,T))),y)$('<span class="debug-message-type-meta"></span>').text("object").appendTo(g);else{b=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>{ </span>").appendTo(b);var V=Math.min(U.length,5);for(f=0;f<V;f++)$('<span class="debug-message-object-key"></span>').text(U[f]).appendTo(b),$("<span>: </span>").appendTo(b),n(p[U[f]]).appendTo(b),f<V-1&&$("<span>, </span>").appendTo(b);U.length>V&&$("<span> &hellip;</span>").appendTo(b),0===V&&$('<span class="debug-message-type-meta">empty</span>').appendTo(b),$("<span> }</span>").appendTo(b)}}else $('<span class="debug-message-type-other"></span>').text(""+p).appendTo(g);return k&&C.prop("expand",function(){return function(e,t){if(E===e)v.prop("toggle")&&v.prop("toggle")(t);else if(j[e]&&j[e].prop("expand"))j[e].prop("expand")(e,t);else for(var n in j)if(j.hasOwnProperty(n)&&0===e.indexOf(n)){j[n].prop("expand")&&j[n].prop("expand")(e,t);break}}}),C},getMessageProperty:c,normalisePropertyExpression:l,validatePropertyExpression:function(e){try{return l(e),!0}catch(e){return!1}},separateIconPath:p,getDefaultNodeIcon:u,getNodeIcon:function(e,t){if("config"===e.category)return"icons/node-red/cog.png";if(t&&"tab"===t.type)return"icons/node-red/subflow.png";if(t&&"unknown"===t.type)return"icons/node-red/alert.png";if(t&&t.icon&&f(n=p(t.icon)))return"icons/"+t.icon;var n=u(e,t);return"subflows"!==e.category||f(n)?"icons/"+n.module+"/"+n.file:"icons/node-red/subflow.png"},getNodeLabel:function(e,t){var n;if(t=t||"","tab"===e.type)n=e.label||t;else{n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||t}catch(o){console.log("Definition error: "+e.type+".label",o),n=t}}return RED.text.bidi.enforceTextDirectionWithUCC(n)},getNodeColor:function(e,t){var n=t.color,o=RED.settings.theme("palette.theme")||[];if(o.length>0){if(!h.hasOwnProperty(e))for(var i=o.length,a=0;a<i;a++){var s=o[a];if((!s.hasOwnProperty("category")||(s.hasOwnProperty("_category")||(s._category=new RegExp(s.category)),s._category.test(t.category)))&&(!s.hasOwnProperty("type")||(s.hasOwnProperty("_type")||(s._type=new RegExp(s.type)),s._type.test(e)))){h[e]=s.color||t.color;break}}n=h[e]}return n},addSpinnerOverlay:function(e,t){var n=$('<div class="projects-dialog-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&n.addClass("projects-dialog-spinner-contain"),n},decodeObject:function(e,t){if("number"===t&&"NaN"===e)e=Number.NaN;else if("number"===t&&"Infinity"===e)e=1/0;else if("number"===t&&"-Infinity"===e)e=-1/0;else if("Object"===t||/^array/.test(t)||"boolean"===t||"number"===t)e=JSON.parse(e);else if(/error/i.test(t))e=((e=JSON.parse(e)).name?e.name+": ":"")+e.message;else if("null"===t)e=null;else if("undefined"===t)e=void 0;else if(/^buffer/.test(t)){var n=e;e=[];for(var o=0;o<n.length;o+=2)e.push(parseInt(n.substr(o,2),16))}return e},parseContextKey:function(e){var t={},n=/^#:\((\S+?)\)::(.*)$/.exec(e);return n?(t.store=n[1],t.key=n[2]):(t.key=e,RED.settings.context&&(t.store=RED.settings.context.default)),t}}}(),function(e){e.widget("nodered.editableList",{_create:function(){var t,n=this;(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton)&&(t="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",e('<a href="#" class="editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+t+"</a>").appendTo(this.topContainer).click(function(e){e.preventDefault(),n.addItem({})}));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=n.element.css(e);"auto"!==t&&""!==t&&(n.topContainer.css(e,t),n.uiContainer.css(e,"0"),n.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var o=this.element.css("minHeight");"0px"!==o&&(this.uiContainer.css("minHeight",o),this.element.css("minHeight",0));var i=this.element.css("maxHeight");"0px"!==i&&(this.uiContainer.css("maxHeight",i),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var a,s=this.element.attr("style");if(null!==(a=/width\s*:\s*(\d+%)/i.exec(s))&&(this.element.width("100%"),this.uiContainer.width(a[1])),this.options.sortable){var r={axis:"y",update:function(e,t){n.options.sortItems&&n.options.sortItems(n.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(r.connectWith=this.options.connectWith),this.element.sortable(r)}this._resize()},_resize:function(){var t=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-t),this.options.resize&&this.options.resize(),this.options.resizeItem){var n=this;this.element.children().each(function(t){n.options.resizeItem(e(this).find(".red-ui-editableList-item-content"),t)})}},_destroy:function(){},_refreshFilter:function(){var e=this,t=0;return this.activeFilter?(this.items().each(function(n,o){var i=o.data("data");try{e.activeFilter(i)?(o.parent().show(),t++):o.parent().hide()}catch(e){console.log(e),o.parent().show(),t++}}),t):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var t=this.element.children(),n=this;t.sort(function(t,o){return n.activeSort(e(t).find(".red-ui-editableList-item-content").data("data"),e(o).find(".red-ui-editableList-item-content").data("data"))}),e.each(t,function(e,t){n.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},addItem:function(t){var n=this;t=t||{};var o=e("<li>"),i=!1;if(this.activeSort){this.items().each(function(e,a){if(!i){var s=a.data("data");n.activeSort(t,s)<0&&(o.insertBefore(a.closest("li")),i=!0)}})}i||o.appendTo(this.element);var a=e("<div/>").addClass("red-ui-editableList-item-content").appendTo(o);if(a.data("data",t),!0===this.options.sortable&&(e('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(o),o.addClass("red-ui-editableList-item-sortable")),this.options.removable){var s=e("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(o);e("<i/>",{class:"fa fa-remove"}).appendTo(s),o.addClass("red-ui-editableList-item-removable"),s.click(function(t){t.preventDefault();var i=a.data("data");o.addClass("red-ui-editableList-item-deleting"),o.fadeOut(300,function(){e(this).remove(),n.options.removeItem&&n.options.removeItem(i)})})}if(this.options.addItem){var r=n.element.children().length-1;setTimeout(function(){if(n.options.addItem(a,r,t),n.activeFilter)try{n.activeFilter(t)||o.hide()}catch(e){}!n.activeSort&&n.scrollOnAdd&&setTimeout(function(){n.uiContainer.scrollTop(n.element.height())},0)},0)}},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t){this.element.children().filter(function(n){return t===e(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(t){return e(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length}})}(jQuery),function(e){e.widget("nodered.checkboxSet",{_create:function(){var t=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var n=this.element.prop("checked");this.options=[e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],n?this.options[1].show():this.options[0].show(),this.element.change(function(){this.checked?(t.options[0].hide(),t.options[1].show(),t.options[2].hide()):(t.options[1].hide(),t.options[0].show(),t.options[2].hide());var e=this.checked;t.children.forEach(function(t){t.checkboxSet("state",e,!1,!0)})}),this.uiElement.click(function(e){e.stopPropagation(),t.state(!1===t.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)},updateChild:function(e){var t=0;this.children.forEach(function(e,n){!0===e.checkboxSet("state")&&t++}),0===t?this.state(!1,!0):t===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,n){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var o=this.partialFlag||e;this.element.prop("checked",o),!0===e?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):!1===e?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===e&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),t||this.element.trigger("change",null),!n&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var e={};function t(a){var s,r;if(null!==a&&a.id&&!1===RED.settings.theme("menu."+a.id))return null;if(null===a)s=$('<li class="divider"></li>');else{s=$("<li></li>"),a.group&&s.addClass("menu-group-"+a.group);var d="<a "+(a.id?'id="'+a.id+'" ':"")+'tabindex="-1" href="#">';a.toggle&&(d+='<i class="fa fa-square pull-left"></i>',d+='<i class="fa fa-check-square pull-left"></i>'),void 0!==a.icon&&(/\.png/.test(a.icon)?d+='<img src="'+a.icon+'"/> ':d+='<i class="'+(a.icon?a.icon:'" style="display: inline-block;"')+'"></i> '),a.sublabel?d+='<span class="menu-label-container"><span class="menu-label">'+a.label+'</span><span class="menu-sublabel">'+a.sublabel+"</span></span>":d+='<span class="menu-label">'+a.label+"</span>",d+="</a>";var l=$(d).appendTo(s);if(e[a.id]=a,a.onselect?(l.click(function(t){if(t.preventDefault(),!$(this).parent().hasClass("disabled"))if(a.toggle){var s=o(a.id);if("string"==typeof a.toggle){if(!s){for(var r in e)if(e.hasOwnProperty(r)){var d=e[r];d.id!=a.id&&a.toggle==d.toggle&&i(d.id,!1)}i(a.id,!0)}}else i(a.id,!s)}else n(a.id)}),a.toggle&&(r=RED.settings.get("menu-"+a.id),a.setting&&(null!==r?(RED.settings.set(a.setting,r),RED.settings.remove("menu-"+a.id)):r=RED.settings.get(a.setting)),r?(l.addClass("active"),n(a.id,!0)):!1===r?(l.removeClass("active"),n(a.id,!1)):a.hasOwnProperty("selected")&&(a.selected?l.addClass("active"):l.removeClass("active"),n(a.id,a.selected)))):a.href?l.attr("target","_blank").attr("href",a.href):a.options||(s.addClass("disabled"),l.click(function(e){e.preventDefault()})),a.options){s.addClass("dropdown-submenu pull-left");for(var c=$('<ul id="'+a.id+'-submenu" class="dropdown-menu"></ul>').appendTo(s),p=0;p<a.options.length;p++){var u=t(a.options[p]);u&&u.appendTo(c)}}a.disabled&&s.addClass("disabled")}return s}function n(t,n){var o=e[t],i=o.onselect;"string"==typeof o.onselect&&(i=RED.actions.get(o.onselect)),i?i.call(o,n):console.log("No callback for",t,o.onselect)}function o(e){return $("#"+e).hasClass("active")}function i(t,i){if(o(t)!=i){var a=e[t];i?$("#"+t).addClass("active"):$("#"+t).removeClass("active"),a&&a.onselect&&n(a.id,i),RED.settings.set(a.setting||"menu-"+a.id,i)}}return{init:function(e){var n=$("#"+e.id),o=$("<ul/>",{id:e.id+"-submenu",class:"dropdown-menu pull-right"});1===n.length&&o.insertAfter(n);for(var i=!1,a=0;a<e.options.length;a++){var s=e.options[a];if(null!==s||!i){var r=t(s);r&&(r.appendTo(o),i=null===s)}}return o},setSelected:i,isSelected:o,toggleSelected:function(e){i(e,!o(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,n){var o=t(n);if(n.group){var i=$("#"+e+"-submenu").children(".menu-group-"+n.group);if(0===i.length)o.appendTo("#"+e+"-submenu");else{for(var a=0;a<i.length;a++){var s=i[a],r=$(s).find(".menu-label").html();if(n.label<r){$(s).before(o);break}}a===i.length&&o.appendTo("#"+e+"-submenu")}}else o.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(t,n){var o=e[t];o&&(o.onselect=n)}}}(),RED.panels=function(){return{create:function(e){var t=e.container||$("#"+e.id),n=t.children();if(2!==n.length)throw new Error("Container must have exactly two children");t.addClass("red-ui-panels");var o,i,a=$('<div class="red-ui-panels-separator"></div>').insertAfter(n[0]),s=[],r=!1;return a.draggable({axis:"y",containment:t,scroll:!1,start:function(e,i){t.height(),o=i.position.top,s=[$(n[0]).height(),$(n[1]).height()]},drag:function(a,r){var d=t.height(),l=r.position.top-o,c=[s[0]+l,s[1]-l];$(n[0]).height(c[0]),$(n[1]).height(c[1]),e.resize&&e.resize(c[0],c[1]),r.position.top-=l,i=c[0]/d},stop:function(e,t){r=!0}}),{resize:function(o){var a=[$(n[0]).height(),$(n[1]).height()];if(t.height(o),r){var s=i*o;a=[s,o-s-48],$(n[0]).height(a[0]),$(n[1]).height(a[1])}e.resize&&e.resize(a[0],a[1])}}}}}(),RED.popover=function(){var e={default:{top:10,leftRight:17,leftLeft:25,leftBottom:8},small:{top:5,leftRight:17,leftLeft:16,leftBottom:3}};return{create:function(t){var n=t.target,o=t.direction||"right",i=t.trigger,a=t.content,s=t.delay,r=t.autoClose,d=t.width||"auto",l=t.size||"default";if(!e[l])throw new Error("Invalid RED.popover size value:",l);var c,p,u=null,f=function(t){if(c){if(p=$('<div class="red-ui-popover red-ui-popover-'+o+'"></div>'),"default"!==l&&p.addClass("red-ui-popover-size-"+l),"function"==typeof a){var i=a.call(g);if(null===i)return;"string"==typeof i?p.text(i):p.append(i)}else p.html(a);"auto"!==d&&p.width(d),p.appendTo("body");var s=n.offset(),r=n.outerWidth(),u=n.outerHeight(),f=p.height(),h=p.width();"right"===o?p.css({top:s.top+u/2-f/2-e[l].top,left:s.left+r+e[l].leftRight}):"left"===o?p.css({top:s.top+u/2-f/2-e[l].top,left:s.left-e[l].leftLeft-h}):"bottom"===o&&p.css({top:s.top+u+e[l].top,left:s.left+r/2-h/2-e[l].leftBottom}),t?p.show():p.fadeIn("fast")}},h=function(e){c||p&&(e?$(this).remove():p.fadeOut("fast",function(){$(this).remove()}),p=null)};"hover"===i?(n.on("mouseenter",function(e){clearTimeout(u),c=!0,u=setTimeout(f,s.show)}),n.on("mouseleave",function(e){u&&clearTimeout(u),c=!1,setTimeout(h,s.hide)})):"click"===i?n.click(function(e){e.preventDefault(),e.stopPropagation(),(c=!c)?f():h()}):r&&setTimeout(function(){c=!1,h()},r);var g={setContent:function(e){return a=e,g},open:function(e){return c=!0,f(e),g},close:function(e){return c=!1,h(e),g}};return g},tooltip:function(e,t){RED.popover.create({target:e,trigger:"hover",size:"small",direction:"bottom",content:t,delay:{show:550,hide:10}})}}}(),function(e){e.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),e('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=e('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.focus()}),this.resultCount=e("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(n){t._change(e(this).val())}),this.element.on("focus",function(){e("body").one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var n=!1;""===e?(this.clearButton.hide(),n=!0):(this.clearButton.show(),n=e.length>=(this.options.minimumLength||0));var o=this.element.val();if(n=n&&o!==this.lastSent)if(!t&&this.options.delay>0){clearTimeout(this.currentTimeout);var i=this;this.currentTimeout=setTimeout(function(){i.lastSent=i.element.val(),i._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){var e="fa fa-lemon-o";return{create:function(t){var n,o,i,a,s={},r=0,d=0,l=t.element||$("#"+t.id),c=l.wrap("<div>").parent(),p=l.wrap("<div>").parent();if(c.addClass("red-ui-tabs"),t.vertical&&c.addClass("red-ui-tabs-vertical"),t.addButton&&"function"==typeof t.addButton&&(c.addClass("red-ui-tabs-add"),$('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(c).find("a").click(function(e){e.preventDefault(),t.addButton()})),t.scrollable&&(c.addClass("red-ui-tabs-scrollable"),p.addClass("red-ui-tabs-scroll-container"),p.scroll(v),(i=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(c).find("a")).on("mousedown",function(e){h(e,"-=150")}).on("click",function(e){e.preventDefault()}),(a=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(c).find("a")).on("mousedown",function(e){h(e,"+=150")}).on("click",function(e){e.preventDefault()})),t.collapsible){c.addClass("red-ui-tabs-collapsible");var u=$('<div class="red-ui-tab-link-buttons"></div>').appendTo(c),f=$('<a href="#"><i class="fa fa-caret-down"></i></a>').appendTo(u);f.addClass("red-ui-tab-link-button-menu"),f.click(function(t){if(t.preventDefault(),!o){var n=[],i=[];l.children().each(function(t,o){var a=$(o).data("tabId"),r={id:"red-ui-tabs-menu-option-"+a,icon:s[a].iconClass||e,label:s[a].name,onselect:function(){m(a)}};s[a].pinned?n.push(r):i.push(r)}),i=n.concat(i),(o=RED.menu.init({id:"debug-message-option-menu",options:i})).css({position:"absolute"}),o.on("mouseleave",function(){$(this).hide()}),o.on("mouseup",function(){$(this).hide()}),o.appendTo("body")}var a=f.offset();o.css({top:a.top+f.height()-20+"px",left:a.left-o.width()+f.width()+"px"}),o.toggle()})}function h(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var n=p.scrollLeft();p.animate({scrollLeft:t},100);var o=setInterval(function(){var e=p.scrollLeft();e!==n?(n=e,p.animate({scrollLeft:t},100)):clearInterval(o)},100);$(this).one("mouseup",function(){clearInterval(o)})}}function g(){return t.onclick&&t.onclick(s[$(this).attr("href").slice(1)]),m($(this)),!1}function v(){if(0!==l.children().length){var e=p.scrollLeft(),t=p.width(),n=l.width();0===e?i.hide():i.show(),e===n-t?a.hide():a.show()}}function b(){return t.ondblclick&&t.ondblclick(s[$(this).attr("href").slice(1)]),!1}function m(e){if("string"==typeof e&&(e=l.find("a[href='#"+e+"']")),0!==e.length&&!e.parent().hasClass("active")){l.children().removeClass("active"),l.children().css({transition:"width 100ms"}),e.parent().addClass("active");var n=e.parent().attr("id");if(c.find(".red-ui-tab-link-button").removeClass("active selected"),$("#"+n+"-link-button").addClass("active selected"),t.scrollable){var o=e.parent().position().left;o-21<0?p.animate({scrollLeft:"+="+(o-50)},300):o+120>p.width()&&p.animate({scrollLeft:"+="+(o+140-p.width())},300)}t.onchange&&t.onchange(s[e.attr("href").slice(1)]),y(),setTimeout(function(){l.children().css({transition:""})},100)}}function y(){if(!t.vertical){var e=l.find("li.red-ui-tab"),o=c.width(),i=e.size();if(t.collapsible){if((s=o-u.width()-10)<198){for(var a=u.find("a:last").prev();a.is(":not(:visible)");)a=a.prev();a.hasClass("red-ui-tab-link-button-pinned")||a.hide(),s=o-u.width()-10}else o-198-u.width()>40&&(u.find("a:not(:visible):first").show(),s=o-u.width()-10);e.css({width:s})}else{var s;if(d=(n=100*(s=(o-12-6*i)/i)/o+"%")+"%",t.scrollable){s=Math.max(s,140),n=s+"px",d=0;var r=Math.max(c.width(),12+(s+6)*i);l.width(r),v()}else t.hasOwnProperty("minimumActiveTabWidth")&&(s<t.minimumActiveTabWidth?(i-=1,s=(o-12-t.minimumActiveTabWidth-6*i)/i,n=100*s/o+"%",d=t.minimumActiveTabWidth+"px"):d=0);t.collapsible&&console.log(n),e.css({width:n}),s<50?(l.find(".red-ui-tab-close").hide(),l.find(".red-ui-tab-icon").hide(),l.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,s-38))+"px"})):(l.find(".red-ui-tab-close").show(),l.find(".red-ui-tab-icon").show(),l.find(".red-ui-tab-label").css({paddingLeft:""})),0!==d&&(l.find("li.red-ui-tab.active").css({width:t.minimumActiveTabWidth}),l.find("li.red-ui-tab.active .red-ui-tab-close").show(),l.find("li.red-ui-tab.active .red-ui-tab-icon").show(),l.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}}function w(e){var n=l.find("a[href='#"+e+"']").parent();if(n.hasClass("active")){var i=n.prev();0===i.size()&&(i=n.next()),m(i.find("a"))}n.remove(),s[e].pinned&&r--,t.onremove&&t.onremove(s[e]),delete s[e],y(),o=null}return l.children().first().addClass("active"),l.children().addClass("red-ui-tab"),l.find("li.red-ui-tab a").on("click",g).on("dblclick",b),setTimeout(function(){y()},0),{addTab:function(n){s[n.id]=n;var i=$("<li/>",{class:"red-ui-tab"}).appendTo(l);i.attr("id","red-ui-tab-"+n.id.replace(".","-")),i.data("tabId",n.id),t.maximumTabWidth&&i.css("maxWidth",t.maximumTabWidth+"px");var a=$("<a/>",{href:"#"+n.id,class:"red-ui-tab-label"}).appendTo(i);if(n.icon?$('<img src="'+n.icon+'" class="red-ui-tab-icon"/>').appendTo(a):n.iconClass&&$("<i>",{class:"red-ui-tab-icon "+n.iconClass}).appendTo(a),$("<span/>",{class:"bidiAware"}).text(n.label).appendTo(a).attr("dir",RED.text.bidi.resolveBaseTextDir(n.label)),t.collapsible){i.addClass("red-ui-tab-pinned");var d=$('<a href="#'+n.id+'" class="red-ui-tab-link-button"></a>');n.pinned?0===r?d.prependTo(u):d.insertAfter(u.find("a.red-ui-tab-link-button-pinned:last")):d.insertBefore(u.find("a:last")),d.attr("id",i.attr("id")+"-link-button"),n.iconClass?$("<i>",{class:n.iconClass}).appendTo(d):$("<i>",{class:e}).appendTo(d),d.click(function(e){e.preventDefault(),m(n.id)}),n.pinned&&(d.addClass("red-ui-tab-link-button-pinned"),r++),RED.popover.tooltip($(d),n.name)}if(a.on("click",g),a.on("dblclick",b),n.closeable){var c=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(i);c.append('<i class="fa fa-times" />'),c.on("click",function(e){e.preventDefault(),w(n.id)})}if(t.onadd&&t.onadd(n),a.attr("title",n.label),1==l.find("li.red-ui-tab").size()&&m(a),t.onreorder){var f,h,v,D=[];i.draggable({axis:"x",distance:20,start:function(e,t){f=[],D=[],l.children().each(function(e){D[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(i)&&(h=e,v=e),f.push($(this).data("tabId"))}),l.children().each(function(e){e!==h&&$(this).css({position:"absolute",left:D[e].left+"px",width:D[e].width+2,transition:"left 0.3s"})}),i.hasClass("active")||i.css({zIndex:1})},drag:function(e,t){t.position.left+=D[h].left+p.scrollLeft();for(var n=t.position.left+D[h].width/2-p.scrollLeft(),o=0;o<D.length;o++)if(o!==h&&n>D[o].left&&n<D[o].left+D[o].width){o<h?(D[o].left+=D[h].width+8,D[h].el.detach().insertBefore(D[o].el)):(D[o].left-=D[h].width+8,D[h].el.detach().insertAfter(D[o].el)),D[o].el.css({left:D[o].left+"px"}),D.splice(o,0,D.splice(h,1)[0]),h=o;break}},stop:function(e,n){l.children().css({position:"relative",left:"",transition:""}),i.hasClass("active")||i.css({zIndex:""}),y(),v!==h&&t.onreorder(f,$.makeArray(l.children().map(function(){return $(this).data("tabId")}))),m(D[h].el.data("tabId"))}})}setTimeout(function(){y()},10),o=null},removeTab:w,activateTab:m,nextTab:function(){var e=l.find("li.active").next();e.length>0&&m(e.find("a"))},previousTab:function(){var e=l.find("li.active").prev();e.length>0&&m(e.find("a"))},resize:y,count:function(){return l.find("li.red-ui-tab").size()},contains:function(e){return l.find("a[href='#"+e+"']").length>0},renameTab:function(e,t){s[e].label=t;var n=l.find("a[href='#"+e+"']");n.attr("title",t),n.find("span.bidiAware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),y()},order:function(e){var t=$.makeArray(l.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var n,o=!0;for(n=0;n<e.length;n++)if(e[n]!==t[n]){o=!1;break}if(!o){var i={};for(l.children().detach().each(function(){i[$(this).data("tabId")]=$(this)}),n=0;n<e.length;n++)i[e[n]].appendTo(l)}}}}}}}(),RED.stack=function(){return{create:function(e){var t=e.container;t.addClass("red-ui-stack");var n=0,o=[],i=!0,a=function(){if(o.length>0){var e=0;o.forEach(function(t){e+=t.header.outerHeight()});var i=t.innerHeight();n=i-e-(o.length-1),o.forEach(function(e){e.contentWrap.height(n)})}};return e.fill&&e.singleExpanded&&($(window).resize(a),$(window).focus(a)),{add:function(s){o.push(s),s.container=$('<div class="palette-category">').appendTo(t),i||s.container.hide();var r=$('<div class="palette-header"></div>').appendTo(s.container);if(s.header=r,s.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(s.container),e.fill&&s.contentWrap.css("height",n),s.content=$("<div></div>").appendTo(s.contentWrap),!1!==s.collapsible){r.click(function(){if(e.singleExpanded){if(!s.isExpanded()){for(var t=0;t<o.length;t++)o[t].isExpanded()&&o[t].collapse();s.expand()}}else s.toggle()});var d=$('<i class="fa fa-angle-down"></i>').appendTo(r);s.expanded?(s.container.addClass("palette-category-expanded"),d.addClass("expanded")):s.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(r),r.css("cursor","default");return s.title=$("<span></span>").html(s.title).appendTo(r),s.toggle=function(){return s.isExpanded()?(s.collapse(),!1):(s.expand(),!0)},s.expand=function(){if(!s.isExpanded())return s.onexpand&&s.onexpand.call(s),e.singleExpanded&&o.forEach(function(e){e!==s&&e.collapse()}),d.addClass("expanded"),s.container.addClass("palette-category-expanded"),s.contentWrap.slideDown(200),!0},s.collapse=function(){if(s.isExpanded())return d.removeClass("expanded"),s.container.removeClass("palette-category-expanded"),s.contentWrap.slideUp(200),!0},s.isExpanded=function(){return s.container.hasClass("palette-category-expanded")},e.fill&&e.singleExpanded&&a(),s},hide:function(){return i=!1,o.forEach(function(e){e.container.hide()}),this},show:function(){return i=!0,o.forEach(function(e){e.container.show()}),this},resize:function(){a&&a()}}}}}(),function(e){var t=function(e){var t=RED.utils.parseContextKey(e);return{option:t.store,value:t.key}},n=function(e,t){if(!t)return e;var n="string"==typeof t?t:t.value;return n!==RED.settings.context.default?"#:("+n+")::"+e:e},o={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:t,export:n},global:{value:"global",label:"global.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:t,export:n},str:{value:"str",label:"string",icon:"red/images/typedInput/az.png"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.png",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var e=this,t=this.value();try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}RED.editor.editJSON({value:t,complete:function(t){var n=t;try{n=JSON.stringify(JSON.parse(t))}catch(e){}e.value(n)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.png"},date:{value:"date",label:"timestamp",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.png",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var e=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(t){e.value(t.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.png",expand:function(){var e=this;RED.editor.editBuffer({value:this.value(),complete:function(t){e.value(t)}})}},env:{value:"env",label:"env variable",icon:"red/images/typedInput/env.png"}},i=!1;e.widget("nodered.typedInput",{_create:function(){try{if(!i&&RED&&RED._){for(var t in o)o.hasOwnProperty(t)&&(o[t].label=RED._("typedInput.type."+t,{defaultValue:o[t].label}));var n=RED.settings.context.stores.map(function(e){return{value:e,label:e,icon:'<i class="red-ui-typedInput-icon fa fa-database" style="color: #'+("memory"===e?"ddd":"777")+'"></i>'}});n.length<2?(o.flow.options=[],o.global.options=[]):(o.flow.options=n,o.global.options=n)}i=!0;var a=this;this.disarmClick=!1,this.input=e('<input type="text"></input>'),this.input.insertAfter(this.element),this.input.val(this.element.val()),this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.input.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var s,r=this.element.attr("style");if(null!==(s=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(r))?(this.input.css("width","100%"),this.uiSelect.width(s[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=a.element.css("margin"+e);a.uiSelect.css("margin"+e,t),a.input.css("margin"+e,0)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.element.attr("type","hidden"),this.options.types=this.options.types||Object.keys(o),this.selectTrigger=e('<button tabindex="0"></button>').prependTo(this.uiSelect),e('<i class="red-ui-typedInput-icon fa fa-sort-desc"></i>').toggle(this.options.types.length>1).appendTo(this.selectTrigger),this.selectLabel=e('<span class="red-ui-typedInput-type-label"></span>').appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=e(this.options.typeField).hide();var d=this.typeField.val();d&&this.typeMap[d]&&(this.options.default=d)}else this.typeField=e("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.input.on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.input.on("blur",function(){a.uiSelect.removeClass("red-ui-typedInput-focus")}),this.input.on("change",function(){a.validate(),a.element.val(a.value()),a.element.trigger("change",a.propertyType,a.value())}),this.selectTrigger.click(function(e){e.preventDefault(),a._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&a._showTypeMenu()}).on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=e('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-sort-desc"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=e('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),RED.popover.tooltip(this.optionSelectLabel,function(){return a.optionValue}),this.optionSelectTrigger.click(function(e){e.preventDefault(),a._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&a._showOptionSelectMenu()}).on("blur",function(){a.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=e('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"><i class="red-ui-typedInput-icon fa fa-ellipsis-h"></i></button>').appendTo(this.uiSelect),this.type(this.options.default||this.typeList[0].value)}catch(e){console.log(e.stack)}},_showTypeMenu:function(){this.typeList.length>1?(this._showMenu(this.menu,this.selectTrigger),this.menu.find("[value='"+this.propertyType+"']").focus()):this.input.focus()},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectTrigger);var e=this.optionMenu.find("[value='"+this.optionValue+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.focus()}},_hideMenu:function(t){e(document).off("mousedown.close-property-select"),t.hide(),this.elementDiv.is(":visible")?this.input.focus():this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.focus():this.selectTrigger.focus()},_createMenu:function(t,n){var o=this,i=e("<div>").addClass("red-ui-typedInput-options");return t.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var a=e('<a href="#"></a>').attr("value",t.value).appendTo(i);t.label&&a.text(t.label),t.icon?0===t.icon.indexOf("<")?e(t.icon).prependTo(a):-1!==t.icon.indexOf("/")?e("<img>",{src:t.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(a):e("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(a):a.css({paddingLeft:"18px"}),t.icon||t.label||a.text(t.value),a.click(function(e){e.preventDefault(),n(t.value),o._hideMenu(i)})}),i.css({display:"none"}),i.appendTo(document.body),i.on("keydown",function(t){40===t.keyCode?e(this).children(":focus").next().focus():38===t.keyCode?e(this).children(":focus").prev().focus():27===t.keyCode&&o._hideMenu(i)}),i},_showMenu:function(t,n){if(this.disarmClick)this.disarmClick=!1;else{var o=this,i=n.offset(),a=n.height(),s=t.height(),r=a+i.top-3;r+s>e(window).height()&&(r-=r+s-e(window).height()+5),t.css({top:r+"px",left:2+i.left+"px"}),t.slideDown(100),this._delay(function(){o.uiSelect.addClass("red-ui-typedInput-focus"),e(document).on("mousedown.close-property-select",function(i){e(i.target).closest(t).length||o._hideMenu(t),e(i.target).closest(n).length&&(o.disarmClick=!0,i.preventDefault())})})}},_getLabelWidth:function(t){var n=t.outerWidth();if(0===n){var o=e('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body);n=t.clone().appendTo(o).outerWidth(),o.remove()}return n},_resize:function(){null!==this.uiWidth&&this.uiSelect.width(this.uiWidth);var e=this.typeMap[this.propertyType];if(e&&!1===e.hasValue)this.selectTrigger.addClass("red-ui-typedInput-full-width");else{this.selectTrigger.removeClass("red-ui-typedInput-full-width");var t=this._getLabelWidth(this.selectTrigger);if(this.elementDiv.css("left",t+"px"),this.optionExpandButton.is(":visible")?this.elementDiv.css("right","22px"):(this.elementDiv.css("right","0"),this.input.css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"})),this.optionSelectTrigger)if(e&&e.options&&!0===e.hasValue){this.optionSelectLabel.css({left:"auto"});var n=this._getLabelWidth(this.optionSelectLabel);this.optionSelectTrigger.css({width:23+n+"px"}),this.elementDiv.css("right",23+n+"px"),this.input.css({"border-top-right-radius":0,"border-bottom-right-radius":0})}else this.optionSelectLabel.css({left:"0"}),this.optionSelectTrigger.css({width:"calc( 100% - "+t+"px )"}),this.optionExpandButton.is(":visible")||(this.elementDiv.css({right:0}),this.input.css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"}))}},_updateOptionSelectLabel:function(t){var n=this.typeMap[this.propertyType];this.optionSelectLabel.empty(),t.icon?0===t.icon.indexOf("<")?e(t.icon).prependTo(this.optionSelectLabel):-1!==t.icon.indexOf("/")?e("<img>",{src:t.icon,style:"height: 18px;"}).prependTo(this.optionSelectLabel):e("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(this.optionSelectLabel):t.label?this.optionSelectLabel.text(t.label):this.optionSelectLabel.text(t.value),n.hasValue&&(this.optionValue=t.value,this._resize(),this.input.trigger("change",this.propertyType,this.value()))},_destroy:function(){this.optionMenu&&this.optionMenu.remove(),this.menu.remove()},types:function(e){var t=this,n=this.type();this.typeMap={},this.typeList=e.map(function(e){var n;return n="string"==typeof e?o[e]:e,t.typeMap[n.value]=n,n}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.selectTrigger.find(".fa-sort-desc").toggle(this.typeList.length>1),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(e){t.type(e)}),n&&!this.typeMap.hasOwnProperty(n)?this.type(this.typeList[0].value):(this.propertyType=null,this.type(n)),setTimeout(function(){t._resize()},0)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){if(!arguments.length){var t=this.input.val();return this.typeMap[this.propertyType].export&&(t=this.typeMap[this.propertyType].export(t,this.optionValue)),t}var n;if(this.typeMap[this.propertyType].options){for(var o=0;o<this.typeMap[this.propertyType].options.length;o++){var i=this.typeMap[this.propertyType].options[o];if("string"==typeof i){if(i===e){n=this.activeOptions[i];break}}else if(i.value===e){n=i;break}}n||(n={value:""}),this._updateOptionSelectLabel(n)}this.input.val(e),this.input.trigger("change",this.type(),e)},type:function(t){if(!arguments.length)return this.propertyType;var n=this,o=this.typeMap[t];if(o&&this.propertyType!==t){var i,a;if(this.propertyType=t,this.typeField&&this.typeField.val(t),this.selectLabel.empty(),o.icon?((i=new Image).name=o.icon,i.src=o.icon,e("<img>",{src:o.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):this.selectLabel.text(o.label),o.options){if(this.optionExpandButton&&this.optionExpandButton.hide(),this.optionSelectTrigger)if(this.optionSelectTrigger.show(),o.hasValue?this.elementDiv.show():this.elementDiv.hide(),this.activeOptions={},o.options.forEach(function(e){"string"==typeof e?n.activeOptions[e]={label:e,value:e}:n.activeOptions[e.value]=e}),n.activeOptions.hasOwnProperty(n.optionValue)||(n.optionValue=null),this.optionMenu=this._createMenu(o.options,function(e){n._updateOptionSelectLabel(n.activeOptions[e]),o.hasValue||n.value(n.activeOptions[e].value)}),o.hasValue){var s=this.optionValue||o.options[0];if(o.parse){var r=o.parse(this.input.val());r.option&&(s=r.option,this.activeOptions.hasOwnProperty(s)||(r.option=Object.keys(this.activeOptions)[0],s=r.option)),this.input.val(r.value),o.export&&this.element.val(o.export(r.value,r.option||s))}"string"==typeof s?(this.optionValue=s,this.activeOptions.hasOwnProperty(s)||(s=Object.keys(this.activeOptions)[0]),s?this._updateOptionSelectLabel(this.activeOptions[s]):this.optionSelectTrigger.hide()):s?(this.optionValue=s.value,this._updateOptionSelectLabel(s)):this.optionSelectTrigger.hide()}else{for(var d=this.input.val(),l=!1,c=0;c<o.options.length;c++){if("string"==typeof(a=o.options[c])&&a===d){n._updateOptionSelectLabel({value:d}),l=!0;break}if(a.value===d){n._updateOptionSelectLabel(a),l=!0;break}}l||("string"==typeof(a=o.options[0])?(this.value(a),n._updateOptionSelectLabel({value:a})):(this.value(a.value),n._updateOptionSelectLabel(a)))}}else this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===o.hasValue?(this.oldValue=this.input.val(),this.input.val(""),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.input.val(this.oldValue),delete this.oldValue),this.elementDiv.show()),this.optionExpandButton&&(o.expand&&"function"==typeof o.expand?(this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){e.preventDefault(),o.expand.call(n)})):this.optionExpandButton.hide()),this.input.trigger("change",this.propertyType,this.value());i?(i.onload=function(){n._resize()},i.onerror=function(){n._resize()}):this._resize()}},validate:function(){var e,t=this.value(),n=this.type();if(this.typeMap[n]&&this.typeMap[n].validate){var o=this.typeMap[n].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.actions=function(){var e={};return{add:function(t,n){e[t]=n},remove:function(t){delete e[t]},get:function(t){return e[t]},invoke:function(t){e.hasOwnProperty(t)&&e[t]()},list:function(){var t=[];return Object.keys(e).forEach(function(e){var n=RED.keyboard.getShortcut(e);t.push({id:e,scope:n?n.scope:void 0,key:n?n.key:void 0,user:n?n.user:void 0})}),t}}}(),RED.deploy=function(){var e={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},t={unknown:!1,unusedConfig:!1,invalid:!1},n="full",o=!1,i=null;function a(t){n=t,$("#btn-deploy-icon").attr("src",e[t].img)}function s(e){var t="";if(e.z){var n=RED.nodes.workspace(e.z);t=n?n.label:(n=RED.nodes.subflow(e.z)).name}var o=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:o}}function r(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function d(e,t){var n=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(n);var o=$('<div id="node-dialog-confirm-deploy-conflict-checking" class="node-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(n),a=$('<div class="node-dialog-confirm-conflict-row"><i style="color: #3a3;" class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(n),s=$('<div id="node-dialog-confirm-deploy-conflict-manual-merge" class="node-dialog-confirm-conflict-row"><i style="color: #999;" class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(n);n.i18n(),i=null;var r=[{text:RED._("common.label.cancel"),click:function(){d.close()}},{id:"node-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),d.close())}},{id:"node-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(i),d.close())}}];t&&r.push({id:"node-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){c(!0,t),d.close()}});var d=RED.notify(n,{modal:!0,fixed:!0,width:600,buttons:r}),l=Date.now();RED.diff.getRemoteDiff(function(e){var t=Math.max(1e3-(Date.now()-l),0);i=e,setTimeout(function(){o.hide(),0===Object.keys(e.conflicts).length?(a.show(),$("#node-dialog-confirm-deploy-merge").removeClass("disabled")):s.show(),$("#node-dialog-confirm-deploy-review").removeClass("disabled")},t)})}function l(e){if(e.length>5){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function c(e,i){if(!$("#btn-deploy").hasClass("disabled")){if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");if(!e){var a,p=!1,u=!1,f=[],h=[];RED.nodes.eachNode(function(e){p=p||!e.valid,e.valid||h.push(s(e)),"unknown"===e.type&&-1==f.indexOf(e.name)&&f.push(e.name)}),a=f.length>0;var g=[];RED.nodes.eachConfig(function(e){0===e.users.length&&!1!==e._def.hasUsers&&(g.push(s(e)),u=!0)});var v,b,m=!1,y=[];if(a&&!t.unknown?(m=!0,v="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+l(f).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",y=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){c(!0),b.close()}}]):p&&!t.invalid&&(m=!0,h.sort(r),v="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+l(h.map(function(e){return(e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")"})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",y=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){c(!0),b.close()}}]),m)return y.unshift({text:RED._("common.label.cancel"),click:function(){b.close()}}),void(b=RED.notify(v,{modal:!0,fixed:!0,buttons:y}))}var w=RED.nodes.createCompleteNodeSet(),D=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var E={flows:w};i||(E.rev=RED.nodes.version()),o=!0,$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(E),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":n}}).done(function(e,t,n){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(w),u?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachSubflow(function(e){e.changed=!1}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,n){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?d(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){o=!1;var e=Math.max(0,300-(Date.now()-D));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide(),$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide()},e)})}}return{init:function(e){var t,n=(e=e||{}).type||"default";if("default"==n)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&a("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&a("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&a("nodes")}}]});else if("simple"==n){var i=e.label||RED._("deploy.deploy"),s="red/images/deploy-full-o.png";e.hasOwnProperty("icon")&&(s=e.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(s?'<img id="btn-deploy-icon" src="'+s+'"> ':"")+"<span>"+i+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(e){e.preventDefault(),c()}),RED.actions.add("core:deploy-flows",c),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))}),RED.comms.subscribe("notification/runtime-deploy",function(e,n){if(!t){var i=RED.nodes.version();if(null===i||o||i===n.revision)return;var a=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));t=RED.notify(a,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){t.close(),t=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){t.close(),d(RED.nodes.createCompleteNodeSet(),!1),t=null}}]})}})},setDeployInflight:function(e){o=e}}}(),RED.diff=function(){var e=!1;function t(e,t,n){var i=$('<div class="node-dialog-view-diff-panel"></div>').appendTo(e),d=$('<div class="node-dialog-view-diff-headers"></div>').appendTo(i);"merge"===n.mode&&i.addClass("node-dialog-view-diff-panel-merge");var l=function(e,t){var n=$('<ol class="node-dialog-view-diff-diff"></ol>').appendTo(e);return n.editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,n,i){var d=i.diff,l=i.remoteDiff,c=i.tab.n,p=i.def,u=t.conflicts,f=$("<div>",{class:"node-diff-tab"}).appendTo(e);f.addClass("collapsed");var h,g,v=$("<div>",{class:"node-diff-tab-title"}).appendTo(f),b=$("<div>").appendTo(f),m=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(v),y=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(v);l&&(h=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(v)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(m),o(c,p).appendTo(m);var w=(i.newTab||i.tab).n,D=$("<span>",{class:"node-diff-tab-title-meta"}).appendTo(m);"tab"===w.type?D.text(w.label||w.id):"subflow"===c.type?D.text(w.name||w.id):D.text(RED._("diff.globalNodes"));var E={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(i.newTab||i.remoteTab){var R,x={node:d.newConfig.all[c.id],all:d.newConfig.all,diff:d};if(l&&(R={node:l.newConfig.all[c.id]||null,all:l.newConfig.all,diff:l}),void 0!==c.type){var T,_=$("<div>",{class:"node-diff-node-entry node-diff-node-props collapsed"}).appendTo(b),k=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(_),j=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(k),C=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(k);d.newConfig.all[c.id]?d.added[c.id]?(C.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(C)):d.changed[c.id]?(C.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(C)):(C.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(C)):C.addClass("node-diff-empty"),l&&(T=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(k),l.newConfig.all[c.id]?l.added[c.id]?(T.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(T)):l.changed[c.id]?(T.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(T)):(T.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(T)):(T.addClass("node-diff-empty"),l.deleted[c.id])),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(j),$("<span>").text(RED._("diff.flowProperties")).appendTo(j),k.click(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),s(p,c,x,R).appendTo(_),g="",u[c.id]?(E.conflicts++,C.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(C),T.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(T),_.addClass("node-diff-node-entry-conflict")):g=t.resolutions[c.id],r(c,_,C,T,!0,!u[c.id],g,t)}}var S=0,O=0,L={};if(i.tab.nodes.forEach(function(e){L[e.id]=!0,a(e,E,t).appendTo(b)}),i.newTab&&(S=i.newTab.nodes.length,i.newTab.nodes.forEach(function(e){L[e.id]||(L[e.id]=!0,a(e,E,t).appendTo(b))})),i.remoteTab&&(O=i.remoteTab.nodes.length,i.remoteTab.nodes.forEach(function(e){L[e.id]||a(e,E,t).appendTo(b)})),v.click(function(e){v.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".node-diff-node-entry").addClass("collapsed"),$(this).parent().find(".debug-message-element").addClass("collapsed"))}),d.deleted[c.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(y);else if(i.newTab)if(d.added[c.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(y);else{c.id&&(d.changed[c.id]?E.local.changedCount++:E.local.unchangedCount++);var P=$("<span>",{class:"node-diff-tab-stats"}).appendTo(y);$('<span class="node-diff-status"></span>').text(RED._("diff.nodeCount",{count:S})).appendTo(P),E.conflicts+E.local.addedCount+E.local.changedCount+E.local.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(P),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(P),E.local.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.local.addedCount+"</span></span>").appendTo(P),E.local.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.local.changedCount+"</span></span>").appendTo(P),E.local.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.local.deletedCount+"</span></span>").appendTo(P),$('<span class="node-diff-status"> ] </span>').appendTo(P))}else y.addClass("node-diff-empty");if(l){if(l.deleted[c.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(i.remoteTab)if(l.added[c.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{c.id&&(l.changed[c.id]?E.remote.changedCount++:E.remote.unchangedCount++);var N=$("<span>",{class:"node-diff-tab-stats"}).appendTo(h);$('<span class="node-diff-status"></span>').text(RED._("diff.nodeCount",{count:O})).appendTo(N),E.conflicts+E.remote.addedCount+E.remote.changedCount+E.remote.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(N),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(N),E.remote.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.remote.addedCount+"</span></span>").appendTo(N),E.remote.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.remote.changedCount+"</span></span>").appendTo(N),E.remote.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.remote.deletedCount+"</span></span>").appendTo(N),$('<span class="node-diff-status"> ] </span>').appendTo(N))}else h.addClass("node-diff-empty");if(g="",E.conflicts>0?v.addClass("node-diff-node-entry-conflict"):g=t.resolutions[c.id],c.id){var I=!(E.conflicts>0&&(d.deleted[c.id]||l.deleted[c.id]));r(c,v,y,h,!1,I,g,t)}}0===f.find(".node-diff-node-entry").length&&f.addClass("node-diff-tab-empty"),e.i18n()}}),n}(i,t),c=t.localDiff,p=t.remoteDiff,u=(t.conflicts,c.currentConfig),f=c.newConfig;if(void 0!==p){i.addClass("node-diff-three-way");var h=n.oldRevTitle||RED._("diff.local"),g=n.newRevTitle||RED._("diff.remote");$("<div></div>").text(h).appendTo(d),$("<div></div>").text(g).appendTo(d)}else i.removeClass("node-diff-three-way");return{list:l,finish:function(){var e={diff:c,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:u.globals},newTab:{n:{},nodes:f.globals}};void 0!==p&&(e.remoteTab={n:{},nodes:p.newConfig.globals},e.remoteDiff=p),l.editableList("addItem",e);var t,n={};for(t in u.tabOrder.forEach(function(e){var t=u.tabs[e],o={diff:c,def:RED.nodes.getType("tab"),tab:t};f.tabs.hasOwnProperty(e)&&(o.newTab=f.tabs[e]),void 0!==p&&(o.remoteTab=p.newConfig.tabs[e],o.remoteDiff=p),n[e]=!0,l.editableList("addItem",o)}),f.tabOrder.forEach(function(e){if(!n[e]){n[e]=!0;var t=f.tabs[e],o={diff:c,def:RED.nodes.getType("tab"),tab:t,newTab:t};void 0!==p&&(o.remoteDiff=p),l.editableList("addItem",o)}}),void 0!==p&&p.newConfig.tabOrder.forEach(function(e){if(!n[e]){var t=p.newConfig.tabs[e],o={diff:c,remoteDiff:p,def:RED.nodes.getType("tab"),tab:t,remoteTab:t};l.editableList("addItem",o)}}),u.subflows)u.subflows.hasOwnProperty(t)&&(n[t]=!0,e={diff:c,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:u.subflows[t]},f.subflows.hasOwnProperty(t)&&(e.newTab=f.subflows[t]),void 0!==p&&(e.remoteTab=p.newConfig.subflows[t],e.remoteDiff=p),l.editableList("addItem",e));for(t in f.subflows)f.subflows.hasOwnProperty(t)&&!n[t]&&(n[t]=!0,e={diff:c,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:f.subflows[t],newTab:f.subflows[t]},void 0!==p&&(e.remoteDiff=p),l.editableList("addItem",e));if(void 0!==p)for(t in p.newConfig.subflows)p.newConfig.subflows.hasOwnProperty(t)&&!n[t]&&(e={diff:c,remoteDiff:p,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:p.newConfig.subflows[t],remoteTab:p.newConfig.subflows[t]},l.editableList("addItem",e))}}}function n(e,t){var n=$("<div>",{class:"node-diff-property-wires"}),o=$("<ol></ol>"),a=0;return e.forEach(function(e,n){var s=$("<li>").appendTo(o);if(e&&e.length>0){$("<span>").text(n+1).appendTo(s);var r=$("<ul>").appendTo(s);e.forEach(function(e){a++;var n=$("<li>").appendTo(r),o=t[e];o?i(o,RED.nodes.getType(o.type)||{}).appendTo(n):n.text(e)})}else s.text("none")}),0===a?n.text("none"):o.appendTo(n),n}function o(e,t){var n=$("<div>",{class:"node-diff-node-entry-node"}),o=RED.utils.getNodeColor(e.type,t),i=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(o="#C0DEED"),n.css("backgroundColor",o);var a=$("<div/>",{class:"palette_icon_container"}).appendTo(n);return $("<div/>",{class:"palette_icon",style:"background-image: url("+i+")"}).appendTo(a),n}function i(e,t){var n=$("<div>",{class:"node-diff-node-entry-title"});o(e,t).appendTo(n);var i=$("<div>",{class:"node-diff-node-description"}).appendTo(n),a=e.label||e.name||e.id;return $("<span>",{class:"node-diff-node-label"}).text(a).appendTo(i),n}function a(e,t,n){var o=n.localDiff,a=n.remoteDiff,d=n.conflicts[e.id],l=!0;o.added[e.id]&&(t.local.addedCount++,l=!1),a&&a.added[e.id]&&(t.remote.addedCount++,l=!1),o.deleted[e.id]&&(t.local.deletedCount++,l=!1),a&&a.deleted[e.id]&&(t.remote.deletedCount++,l=!1),o.changed[e.id]&&(t.local.changedCount++,!0,l=!1),a&&a.changed[e.id]&&(t.remote.changedCount++,!0,l=!1);var c=RED.nodes.getType(e.type);void 0===c&&(c=/^subflow:/.test(e.type)?{icon:"subflow.png",category:"subflows",color:"#da9",defaults:{name:{value:""}}}:{});var p,u=$("<div>",{class:"node-diff-node-entry collapsed"}),f=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(u),h=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(f),g=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(f);if(a&&(p=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(f)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(h),l)t.local.unchangedCount++,i(e,c).appendTo(h),g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g),a&&(t.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p)),u.addClass("node-diff-node-unchanged");else if(o.added[e.id])g.addClass("node-diff-node-added"),p&&p.addClass("node-diff-empty"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(g),i(e,c).appendTo(h);else if(a&&a.added[e.id])g.addClass("node-diff-empty"),p.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(p),i(e,c).appendTo(h);else{if(i(e,c).appendTo(h),o.moved[e.id]){var v=o.newConfig.all[e.id];if(o.deleted[e.z]||e.z===v.z||""===e.z||o.newConfig.all[e.z]){g.addClass("node-diff-node-moved");var b="";b=e.z===v.z?RED._("diff.type.movedFrom",{id:o.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:v.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+b+"</span>").appendTo(g)}else g.addClass("node-diff-empty");!0}else o.deleted[e.z]?(g.addClass("node-diff-empty"),!0):o.deleted[e.id]?(g.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(g),!0):o.changed[e.id]?o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(g.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(g),!0):o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(t.local.unchangedCount++,g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g));if(a)if(a.moved[e.id]){var m=a.newConfig.all[e.id];if(a.deleted[e.z]||e.z===m.z||""===e.z||a.newConfig.all[e.z]){p.addClass("node-diff-node-moved");var y="";y=e.z===m.z?RED._("diff.type.movedFrom",{id:a.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:m.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+y+"</span>").appendTo(p)}else p.addClass("node-diff-empty")}else a.deleted[e.z]?p.addClass("node-diff-empty"):a.deleted[e.id]?(p.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(p)):a.changed[e.id]?a.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(p.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(p)):a.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(t.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p))}var w,D={node:o.newConfig.all[e.id],all:o.newConfig.all,diff:o};a&&(w={node:a.newConfig.all[e.id]||null,all:a.newConfig.all,diff:a}),s(c,e,D,w).appendTo(u);var E="";return d?(t.conflicts++,g.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(g),p.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(p),u.addClass("node-diff-node-entry-conflict")):E=n.resolutions[e.id],r(e,u,g,p,!1,!d,E,n),f.click(function(e){$(this).parent().toggleClass("collapsed")}),u}function s(e,t,o,i){var a,s={},r=o.node;i&&(a=i.node);var d=$("<div>",{class:"node-diff-node-entry-properties"}),l=$("<table>").appendTo(d),c=$("<colgroup><col/><col/></colgroup>").appendTo(l);void 0!==a&&$("<col/>").appendTo(c);var p,u,f,h,g,b,m,y=$("<tbody>").appendTo(l),w=!1,D=!1,E=!1;p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).text("id").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"></span>').appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.id"]=RED.utils.createObjectElement(r.id).appendTo(h)):u.addClass("node-diff-empty"),void 0!==a&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-unchanged"),a?($('<span class="node-diff-status"></span>').appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.id"]=RED.utils.createObjectElement(a.id).appendTo(h)):f.addClass("node-diff-empty")),t.hasOwnProperty("x")&&(r&&(r.x===t.x&&r.y===t.y||(w=!0,0)),a&&(a.x===t.x&&a.y===t.y||(D=!0,0)),(D&&w&&(r.x!==a.x||r.y!==a.y)||!w&&D&&o.diff.deleted[t.id]||w&&!D&&i.diff.deleted[t.id])&&(E=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).text("position").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.position"]=RED.utils.createObjectElement({x:r.x,y:r.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["remote."+e]&&s["remote."+e].prop("expand")(e,t)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==a&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-"+(D?"changed":"unchanged")),a?($('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.position"]=RED.utils.createObjectElement({x:a.x,y:a.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["local."+e]&&s["local."+e].prop("expand")(e,t)}}).appendTo(h)):f.addClass("node-diff-empty"))),w=D=E=!1,t.hasOwnProperty("wires")&&(g=JSON.stringify(t.wires),r&&(b=JSON.stringify(r.wires),g!==b&&(w=!0,0)),a&&(m=JSON.stringify(a.wires),g!==m&&(D=!0,0)),(D&&w&&b!==m||!w&&D&&o.diff.deleted[t.id]||w&&!D&&i.diff.deleted[t.id])&&(E=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).text("wires").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(E?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),n(r.wires,o.all).appendTo(u)):u.addClass("node-diff-empty"),void 0!==a&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),a?(E?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(D?"changed":"unchanged")),$('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),n(a.wires,i.all).appendTo(f)):f.addClass("node-diff-empty")));var R=Object.keys(t).filter(function(t){return!("inputLabels"==t||"outputLabels"==t||"z"==t||"wires"==t||"x"===t||"y"===t||"id"===t||"type"===t||e.defaults&&e.defaults.hasOwnProperty(t))});return e.defaults&&(R=R.concat(Object.keys(e.defaults))),"tab"!==t.type&&(R=R.concat(["inputLabels","outputLabels"])),R.forEach(function(e){w=!1,D=!1,E=!1,g=JSON.stringify(t[e]),r&&(b=JSON.stringify(r[e]),g!==b&&(w=!0,0)),a&&(m=JSON.stringify(a[e]),g!==m&&(D=!0,0)),(D&&w&&b!==m||!w&&D&&o.diff.deleted[t.id]||w&&!D&&i.diff.deleted[t.id])&&(E=!0),p=$("<tr>").appendTo(y);var n=$("<td>",{class:"node-diff-property-cell-label"}).text(e).appendTo(p);u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(E?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local."+e]=RED.utils.createObjectElement(r[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["remote."+e]&&s["remote."+e].prop("expand")(t,n)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==a&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),a?(E?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(D?"changed":"unchanged")),$('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote."+e]=RED.utils.createObjectElement(a[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["local."+e]&&s["local."+e].prop("expand")(t,n)}}).appendTo(h)):f.addClass("node-diff-empty")),r&&a&&"string"==typeof r[e]&&(/\n/.test(r[e])||/\n/.test(a[e]))&&$('<button class="editor-button editor-button-small node-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').click(function(){v(r[e],a[e])}).appendTo(n)}),d}function r(e,t,n,o,i,a,s,r){var l="node-diff-selectbox-"+e.id.replace(/\./g,"-")+(i?"-props":""),c="";(e.z||i)&&(c="node-diff-selectbox-tab-"+(i?e.id:e.z).replace(/\./g,"-"));var p=!i&&("tab"===e.type||"subflow"===e.type),u=function(n){var o;if(void 0===e.type);else if(p)o="node-diff-selectbox-tab-"+e.id.replace(/\./g,"-"),$("."+o+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-remote")):($("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-remote"));else{var a="node-diff-selectbox-"+(i?e.id:e.z).replace(/\./g,"-");$("#"+a+"-local").prop("checked",!1),$("#"+a+"-remote").prop("checked",!1);var s=$("#"+a+"-local").closest(".node-diff-tab").find(".node-diff-tab-title");s.removeClass("node-diff-select-local"),s.removeClass("node-diff-select-remote")}"local"===this.value?(t.removeClass("node-diff-select-remote"),t.addClass("node-diff-select-local")):"remote"===this.value&&(t.addClass("node-diff-select-remote"),t.removeClass("node-diff-select-local")),d(r)},f=$("<label>",{class:"node-diff-selectbox",for:l+"-local"}).click(function(e){e.stopPropagation()}).appendTo(n),h=$("<input>",{id:l+"-local",type:"radio",value:"local",name:l,class:c+"-local"+(p?"":" node-diff-select-node")}).data("node-id",e.id).change(u).appendTo(f),g=$("<label>",{class:"node-diff-selectbox",for:l+"-remote"}).click(function(e){e.stopPropagation()}).appendTo(o),v=$("<input>",{id:l+"-remote",type:"radio",value:"remote",name:l,class:c+"-remote"+(p?"":" node-diff-select-node")}).data("node-id",e.id).change(u).appendTo(g);"local"===s?h.prop("checked",!0):"remote"===s&&v.prop("checked",!0),(a||n.hasClass("node-diff-empty")||o.hasClass("node-diff-empty"))&&(f.hide(),g.hide())}function d(e){var t=0;$(".node-diff-selectbox>input:checked").each(function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()});var n=Object.keys(e.conflicts).length;n-t==0?$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})):$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})),n===t&&($("#node-diff-view-diff-merge").removeClass("disabled"),$("#node-diff-view-resolve-diff").removeClass("disabled"))}function l(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){var n=RED.nodes.createCompleteNodeSet(),o=RED.nodes.originalFlow(),i=t.flows,a=u(o,n),s=u(o,i);s.rev=t.rev,e(f(a,s))}})}function c(n){void 0===n?l(c):function(n,o){if(e)return;(o=o||{}).mode,n.localDiff;var i=n.remoteDiff,a=n.conflicts,s={title:o.title||RED._("diff.reviewChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("merge"===o.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var s=e.find(".editor-tray-body"),r=($('<div class="node-diff-toolbar"><span><span id="node-diff-toolbar-resolved-conflicts"></span></span> </div>').prependTo(s),$('<div class="node-diff-container"></div>').appendTo(s)),l=t(r,n,o);l.list.hide(),i?($("#node-diff-view-diff-merge").show(),0===Object.keys(a).length?$("#node-diff-view-diff-merge").removeClass("disabled"):$("#node-diff-view-diff-merge").addClass("disabled")):$("#node-diff-view-diff-merge").hide(),d(n),setTimeout(function(){l.finish(),l.list.show()},300),$("#sidebar-shade").show()},close:function(){e=!1,$("#sidebar-shade").hide()},show:function(){}};"merge"===o.mode&&s.buttons.push({id:"node-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-diff-view-diff-merge").hasClass("disabled")||(d(n),g(n),RED.tray.close())}});RED.tray.show(s)}(n,{mode:"merge"})}function p(e){var t=[],n={},o={},i=[],a={};return e.forEach(function(e){a[e.id]=e,"tab"===e.type?(t.push(e.id),n[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(o[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(n[e.z]?n[e.z].nodes.push(e):o[e.z]?o[e.z].nodes.push(e):i.push(e))}),{all:a,tabOrder:t,tabs:n,subflows:o,globals:i}}function u(e,t){var n=p(e),o=p(t),i={},a={},s={},r={};return Object.keys(n.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);o.all.hasOwnProperty(e)?JSON.stringify(n.all[e])!==JSON.stringify(o.all[e])&&(s[e]=!0,n.all[e].z!==o.all[e].z&&(r[e]=!0)):a[e]=!0}),Object.keys(o.all).forEach(function(e){n.all.hasOwnProperty(e)||(i[e]=!0)}),{currentConfig:n,newConfig:o,added:i,deleted:a,changed:s,moved:r}}function f(e,t){var n,o,i={},a={},s={localDiff:e,remoteDiff:t,conflicts:i,resolutions:a},r={};for(n in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(n)){r[n]=!0;var d=e.newConfig.all[n];if(e.changed[n]&&t.deleted[n])i[n]=!0;else if(e.deleted[n]&&t.changed[n])i[n]=!0;else if(e.changed[n]&&t.changed[n]){var l=t.newConfig.all[n];JSON.stringify(d)!==JSON.stringify(l)&&(i[n]=!0)}i[n]||(t.added[n]||t.changed[n]||t.deleted[n]?a[n]="remote":a[n]="local")}for(n in e.added)e.added.hasOwnProperty(n)&&(o=e.newConfig.all[n],t.deleted[o.z]?i[n]=!0:a[n]="local");for(n in t.added)t.added.hasOwnProperty(n)&&(o=t.newConfig.all[n],e.deleted[o.z]?i[n]=!0:a[n]="remote");return s}function h(e){e.localDiff.currentConfig;var t,n=e.localDiff,o=e.remoteDiff,i=e.conflicts,a=e.resolutions;for(t in i)if(i.hasOwnProperty(t)&&!a.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var s,r=[],d={},l={};for(t in n.newConfig.all)n.newConfig.all.hasOwnProperty(t)&&(s=RED.nodes.node(t),"local"===a[t]?(s&&(d[t]=s.changed),r.push(n.newConfig.all[t])):"remote"===a[t]?!o.deleted[t]&&o.newConfig.all.hasOwnProperty(t)&&(s&&(d[t]=s.changed),l[t]=!0,r.push(o.newConfig.all[t])):console.log("Unresolved",t));for(t in o.added)o.added.hasOwnProperty(t)&&((s=RED.nodes.node(t))&&(d[t]=s.changed),n.added.hasOwnProperty(t)||(l[t]=!0,r.push(o.newConfig.all[t])));return{config:r,nodeChangedStates:d,localChangedStates:l}}function g(e){var t=h(e),n=t.config,o=t.nodeChangedStates,i=t.localChangedStates,a={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:o,dirty:RED.nodes.dirty(),rev:RED.nodes.version()};RED.history.push(a),RED.nodes.clear(),RED.nodes.import(n)[0].forEach(function(e){(o[e.id]||i[e.id])&&(e.changed=!0)}),RED.nodes.version(e.remoteDiff.rev),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}function v(t,n){var o={title:RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var o=e.find(".editor-tray-body"),i=$('<div class="node-text-diff"></div>').appendTo(o),a=$("<table>",{class:"node-text-diff-content"}).appendTo(i);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(a);for(var s,r=$("<tbody>").appendTo(a),d=function(e,t,n){var o,i,a=e.split(/\r?\n/),s=t.split(/\r?\n/),r=a.length,d=s.length,l={a:[],b:[]},c=[];for(o=0;o<r+1;o++)for(c[o]=[],i=0;i<d+1;i++)c[o][i]=0;for(o=r-1;o>=0;o--)for(i=d-1;i>=0;i--)0,1!==y(a[o],s[i],n)?c[o][i]=c[o+1][i+1]+1:c[o][i]=Math.max(c[o+1][i],c[o][i+1]);o=0,i=0;for(;o<r&&i<d;){var p=y(a[o],s[i],n);if(1!==p){var u=0;0===p?u=0:2==p&&(u=3),l.a.push({i:o+1,j:i+1,line:a[o],type:u}),l.b.push({i:i+1,j:o+1,line:s[i],type:u}),o++,i++}else c[o+1][i]>=c[o][i+1]?(l.a.push({i:o+1,line:a[o],type:1}),o++):(l.b.push({i:i+1,line:s[i],type:4}),i++)}for(;o<r||i<d;)o==r?(l.b.push({i:i+1,line:s[i],type:4}),i++):i==d&&(l.a.push({i:o+1,line:a[o],type:1}),o++);return l}(t||"",n||""),l=0,c=0,p=Math.max(d.a.length,d.b.length),u=[],f=[],h=0,g=0,v=0;v<p;v++){d[v];var w=l<d.a.length?d.a[l]:{type:2,line:""},D=c<d.b.length?d.b[c]:{type:2,line:""};0===w.type&&0!==D.type?(w={type:2,line:""},c++):0===D.type&&0!==w.type?(D={type:2,line:""},l++):(l++,c++),u.push({a:w,b:D}),void 0===s?(s={start:v,end:v},h=0,g=0===w.type&&0===D.type?0:1):0===w.type&&0===D.type?0===g?(s.end=v,h++):1===g?(s.end=v,g=2,h=0):2===g&&(s.end=v,8===++h&&(s.end-=5,f.push(s),s={start:v-5,end:v-5},g=0,h=0)):(s.end=v,h++,0===g?(s.end>3&&(s.end-=3,s.empty=!0,f.push(s),s={start:v-3,end:v-3}),g=1):2===g&&(g=1))}0===g&&(s.empty=!0),s.end=p,f.push(s);for(var E=0;E<f.length;E++)if((s=f[E]).empty)b(s.start,s.end,u).appendTo(r);else for(v=s.start;v<s.end;v++){var R=m(u[v]).appendTo(r);v===s.start?R.addClass("start-block"):v===s.end-1&&R.addClass("end-block")}},close:function(){e=!1},show:function(){}};RED.tray.show(o)}function b(e,t,n){diffRow=$('<tr class="node-text-diff-header node-text-diff-expand">');var o=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),i=$("<span></span>").appendTo(o);return t<n.length-1&&i.text("@@ -"+(n[t-1].a.i+1)+" +"+(n[t-1].b.i+1)),diffRow.click(function(o){if(t-e>20){var a=$(this).offset();if(e>0){for(var s=e;s<e+10;s++)m(n[s]).addClass("unchanged").insertBefore($(this));e+=10}if(t<n.length-1){for(s=t-1;s>t-11;s--)m(n[s]).addClass("unchanged").insertAfter($(this));t-=10}t<n.length-1&&i.text("@@ -"+(n[t-1].a.i+1)+" +"+(n[t-1].b.i+1));var r=$(this).offset().top-a.top;$(".node-text-diff").scrollTop($(".node-text-diff").scrollTop()+r)}else{for(s=e;s<t;s++)m(n[s]).addClass("unchanged").insertBefore($(this));$(this).remove()}}),diffRow}function m(e){var t=$("<tr>"),n=e.a,o=e.b,i=$('<td class="lineno">').text(2===n.type?"":n.i).appendTo(t),a=$('<td class="linetext">').text(n.line).appendTo(t);return 2===n.type?(i.addClass("blank"),a.addClass("blank")):4===n.type?(i.addClass("added"),a.addClass("added")):1===n.type&&(i.addClass("removed"),a.addClass("removed")),i=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),a=$('<td class="linetext">').text(o.line).appendTo(t),2===o.type?(i.addClass("blank"),a.addClass("blank")):4===o.type?(i.addClass("added"),a.addClass("added")):1===o.type&&(i.addClass("removed"),a.addClass("removed")),t}function y(e,t,n){return n?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function w(e,n){var o=$("<div></div>");return e.forEach(function(e){var i=e.hunks,a=e.binary,s=$("<table>",{class:"node-text-diff-content"}).appendTo(o);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(s);var r=$("<tbody>").appendTo(s),l=$('<tr class="node-text-diff-file-header">').appendTo(r),c=$('<td colspan="3"></td>').appendTo(l);$('<i class="node-diff-chevron fa fa-angle-down"></i>').appendTo(c);l.click(function(e){l.toggleClass("collapsed");var t=l.hasClass("collapsed");l.nextUntil(".node-text-diff-file-header").toggle(!t)});$('<span class="filename"></span>').text(e.file).appendTo(c);var p,h=0,g=0,v={};if(n.project.files&&n.project.files.flow===e.file){n.unmerged&&$('<span style="float: right;"><span id="node-diff-toolbar-resolved-conflicts"></span></span>').appendTo(c);var b=$('<tr class="node-text-diff-header">').appendTo(r),m=$('<td class="flow-diff" colspan="3"></td>').appendTo(b),y=n.project.name,w=n.project.files.flow,D="projects/"+y+"/files/"+n.commonRev+"/"+w,E="projects/"+y+"/files/"+n.oldRev+"/"+w,R="projects/"+y+"/files/"+n.newRev+"/"+w,x=[$.Deferred(),$.Deferred(),$.Deferred()];if(n.commonRev){D="projects/"+y+"/files/"+n.commonRev+"/"+w;$.ajax({dataType:"json",url:D}).then(function(e){x[0].resolve(e)}).fail(function(){x[0].resolve(null)})}else x[0].resolve(null);$.ajax({dataType:"json",url:E}).then(function(e){x[1].resolve(e)}).fail(function(){x[1].resolve({content:"[]"})}),$.ajax({dataType:"json",url:R}).then(function(e){x[2].resolve(e)}).fail(function(){x[2].resolve({content:"[]"})}),$.when.apply($,x).always(function(e,o,i){var a,s,r;if(e)try{a=JSON.parse(e.content||"[]")}catch(e){return console.log(RED._("diff.commonVersionError"),D),void console.log(e)}try{s=JSON.parse(o.content||"[]")}catch(e){return console.log(RED._("diff.oldVersionError"),E),void console.log(e)}a||(a=s);try{r=JSON.parse(i.content||"[]")}catch(e){return console.log(RED._("diff.newVersionError"),r),void console.log(e)}var l=u(a,s),c=u(a,r);n.currentDiff=f(l,c);var p=t(m,n.currentDiff,{title:w,mode:n.commonRev?"merge":"view",oldRevTitle:n.oldRevTitle,newRevTitle:n.newRevTitle});p.list.hide(),d(n.currentDiff),setTimeout(function(){p.finish(),p.list.show()},300)})}else if(a){var T=$('<tr class="node-text-diff-header">').appendTo(r),_=$('<td colspan="3"></td>').appendTo(T);$("<span></span>").text(RED._("diff.noBinaryFileShowed")).appendTo(_)}else n.unmerged&&(p=$('<span style="float: right;">'+RED._("diff.conflictHeader",{resolved:g,unresolved:h})+"</span>").appendTo(c)),i.forEach(function(t){var o=$('<tr class="node-text-diff-header">').appendTo(r),i=$('<td colspan="3"></td>').appendTo(o),a=($("<span></span>").text(t.header).appendTo(i),t.conflict),s=t.localStartLine,d=t.remoteStartLine;a&&h++,t.lines.forEach(function(o,i){var l,c=t.diffStart+i,u=a&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(o),f=$("<tr>").appendTo(r),b=$('<td class="lineno">').appendTo(f);u?b.attr("colspan",2):l=$('<td class="lineno">').appendTo(f);var m=$('<td class="linetext">').appendTo(f),y=1;if(a&&(y=2),u){if(f.addClass("mergeHeader"),/^\+\+=======$/.test(o))t.changeSeparator=c,f.addClass("mergeHeader-separator");else{var w=/^..<<<<<<</.test(o);w?($("<span>").text("<<<<<<< Local Changes").appendTo(m),t.localChangeStart=c):(t.remoteChangeEnd=c,$("<span>").text(">>>>>>> Remote Changes").appendTo(m)),f.addClass("mergeHeader-"+(w?"ours":"theirs")),$('<button class="editor-button editor-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(w?"down":"up")+'"></i> use '+(w?"local":"remote")+" changes</button>").appendTo(m).click(function(o){var i,a;o.preventDefault(),g++,w?((a=(i=f.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),a.next().remove()):((a=(i=f.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),a.prev().remove()),a.remove(),f.remove(),i.find(".linetext").addClass("added"),p.empty(),$("<span>"+RED._("diff.conflictHeader",{resolved:g,unresolved:h})+"</span>").appendTo(p),v[e.file]=v[e.file]||{},v[e.file][t.localChangeStart]={changeStart:t.localChangeStart,separator:t.changeSeparator,changeEnd:t.remoteChangeEnd,selection:w?"A":"B"},n.resolveConflict&&n.resolveConflict({conflicts:h,resolved:g,resolutions:v})})}}else{var D=o[0];a&&!n.unmerged&&" "===D&&(D=o[1]),$('<span class="prefix">').text(D).appendTo(m);var E=!1;a&&n.unmerged?($('<span class="prefix">').text(o[1]).appendTo(m),"+"===o[0]&&(b.text(s++),E=!0),"+"===o[1]&&(l.text(d++),E=!0)):"+"===o[0]||a&&"+"===o[1]?(b.addClass("added"),l.addClass("added"),m.addClass("added"),l.text(d++),E=!0):("-"===o[0]||a&&"-"===o[1])&&(b.addClass("removed"),l.addClass("removed"),m.addClass("removed"),b.text(s++),E=!0),E||(m.addClass("unchanged"),s>0&&"\\"!==o[0]&&""!==o&&b.text(s++),d>0&&"\\"!==o[0]&&""!==o&&l.text(d++)),$("<span>").text(o.substring(y)).appendTo(m)}})})}),o}function D(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var n,o,i=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,a=/^\+\+\+ b\/(.*)\t?/,s=/^Binary files /,r=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,d=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,l=[],c=0;c<t.length;c++){var p=t[c],u=i.exec(p);if(u)o&&(n.hunks.push(o),l.push(n)),o=null,n={file:u[1]||u[3],hunks:[]};else if(s.test(p))n&&(n.binary=!0);else{var f=a.exec(p);if(f)n.file=f[1];else{var h=r.exec(p);if(h){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=d.exec(p)){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}o&&o.lines.push(p)}}}return o&&n.hunks.push(o),l.push(n),l}return{init:function(){RED.actions.add("core:show-remote-diff",c)},getRemoteDiff:l,showRemoteDiff:c,showUnifiedDiff:function(t){var n,o=t.diff,i=t.title,a=D(o);t.unmerged&&(t.resolveConflict=function(e){n=e,e.conflicts===e.resolved&&$("#node-diff-view-resolve-diff").removeClass("disabled")});var s={title:i||RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._(t.unmerged?"common.label.cancel":"common.label.close"),click:function(){t.oncancel&&t.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){var n=e.find(".editor-tray-body"),o=$('<div class="node-text-diff"></div>').appendTo(n);w(a,t).appendTo(o)},close:function(){e=!1},show:function(){}};t.unmerged&&s.buttons.push({id:"node-diff-view-resolve-diff",text:RED._("diff.saveConflict"),class:"primary disabled",click:function(){if(!$("#node-diff-view-resolve-diff").hasClass("disabled")){if(t.currentDiff){var e=h(t.currentDiff);(n={resolutions:{}}).resolutions[t.project.files.flow]=JSON.stringify(e.config,"",4)}t.onresolve&&t.onresolve(n),RED.tray.close()}}}),RED.tray.show(s)},showCommitDiff:function(t){var n=function(e){for(var t={},n=e.split("\n"),o=[],i=0;i<n.length;i++)if(/^commit /.test(n[i]))t.sha=n[i].substring(7);else if(/^Author: /.test(n[i])){t.author=n[i].substring(8);var a=/^(.*) <(.*)>$/.exec(t.author);a&&(t.authorName=a[1],t.authorEmail=a[2])}else if(/^Date: /.test(n[i]))t.date=n[i].substring(8);else if(/^    /.test(n[i]))t.title?(4!==n[i].length||o.length>0)&&o.push(n[i].substring(4)):t.title=n[i].substring(4);else if(/^diff /.test(n[i])){t.files=D(n.slice(i));break}return t.comment=o.join("\n"),t}(t.commit),o={title:RED._("diff.viewCommitDiff"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var o=e.find(".editor-tray-body"),i=$('<div class="node-text-diff"></div>').appendTo(o),a=$("<table>",{class:"node-text-diff-content"}).appendTo(i);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(a);var s=$("<tbody>").appendTo(a),r=$('<tr class="node-text-diff-commit-header">').appendTo(s),d=$('<td colspan="3"></td>').appendTo(r);$("<h3>").text(n.title).appendTo(d),$('<div class="commit-body"></div>').text(n.comment).appendTo(d);var l=$('<div class="commit-summary"></div>').appendTo(d);$('<div style="float: right">').text("Commit "+n.sha).appendTo(l),$("<div>").text((n.authorName||n.author)+" - "+t.date).appendTo(l),n.files&&w(n.files,t).appendTo(i)},close:function(){e=!1},show:function(){}};RED.tray.show(o)},mergeDiff:g}}(),RED.keyboard=function(){var e,t=/Mac/i.test(window.navigator.platform),n={},o={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},a={16:!0,17:!0,18:!0,91:!0,93:!0},s={},r={},d={59:186,61:187,173:189};function l(e){for(var t,n=e.toLowerCase().split("-"),i={},a=0;a<n.length;a++)switch(n[a]){case"ctrl":case"cmd":i.ctrl=!0,i.meta=!0;break;case"alt":i.alt=!0;break;case"shift":i.shift=!0;break;case"":0,t=o["-"];break;default:if(o.hasOwnProperty(n[a]))t=o[n[a]];else{if(n[a].length>1)return null;t=n[a].toUpperCase().charCodeAt(0)}}return[t,i]}function c(e,t,o,i){var a=o,r=i;"function"!=typeof o&&"string"!=typeof o||(a={},r=o);var d=[],c=0;if("string"==typeof t){"string"==typeof r&&(s[r]={scope:e,key:t},"boolean"==typeof i&&(s[r].user=i));var p=t.split(" ");for(c=0;c<p.length;c++){var u=l(p[c]);if(!u)return;d.push(u)}}else d.push([t,a]);var f=n;for(c=0;c<d.length;c++)t=d[c][0],(a=d[c][1]).ctrl&&(f.ctrl=f.ctrl||{},f=f.ctrl),a.shift&&(f.shift=f.shift||{},f=f.shift),a.alt&&(f.alt=f.alt||{},f=f.alt),f[t]=f[t]||{},f=f[t];f.scope=e,f.ondown=r}function p(e,t){var o=t||{},i=[],a=0;if("string"==typeof e){var r=e.split(" ");for(a=0;a<r.length;a++){var d=l(r[a]);if(!d)return void console.log("Unrecognised key specifier:",e);i.push(d)}}else i.push([e,o]);var c=n;for(a=0;a<i.length;a++){if(e=i[a][0],(o=i[a][1]).ctrl&&(c=c.ctrl),c&&o.shift&&(c=c.shift),c&&o.alt&&(c=c.alt),!c[e])return;c=c[e]}"string"==typeof c.ondown&&("boolean"==typeof t&&t?s[c.ondown]={user:t}:delete s[c.ondown]),delete c.scope,delete c.ondown}d3.select(window).on("keydown",function(){if(!a[d3.event.keyCode]){var t=function t(o){var i=e||n;(o.ctrlKey||o.metaKey)&&(i=i.ctrl),i&&o.shiftKey&&(i=i.shift),i&&o.altKey&&(i=i.alt);var a=d[o.keyCode]||o.keyCode;if(i&&i[a]){var s=i[a];if(!s.scope)return e?(e=null,t(o)):Object.keys(s).length>0?(e=s,o.preventDefault(),null):null;if(s.scope&&"*"!==s.scope){for(var r=o.target;"BODY"!==r.nodeName&&r.id!==s.scope;)r=r.parentElement;"BODY"===r.nodeName&&(s=null)}return e=null,s}if(e)return e=null,t(o)}(d3.event);t&&t.ondown&&("string"==typeof t.ondown?RED.actions.invoke(t.ondown):t.ondown(),d3.event.preventDefault())}});function u(e){e.preventDefault();var t=$(this),n=t.data("data");if(!t.hasClass("keyboard-shortcut-entry-expanded")){f();var o=t.find(".keyboard-shortcut-entry-key"),i=t.find(".keyboard-shortcut-entry-scope");t.addClass("keyboard-shortcut-entry-expanded");var a=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(n.key||"").appendTo(o);a.on("keyup",function(e){if(13===e.keyCode)return f();var t=$(this).val(),n=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!n)});var s=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(i);s.i18n(),s.val(n.scope||"*");var r=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(i),d=$('<button class="editor-button editor-button-small"><i class="fa fa-check"></i></button>').appendTo(r),l=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(r);d.click(function(e){e.stopPropagation(),f()}),l.click(function(e){e.stopPropagation(),RED.keyboard.revertToDefault(n.id),t.empty(),t.removeClass("keyboard-shortcut-entry-expanded");var o=RED.keyboard.getShortcut(n.id),i=RED.settings.get("keymap")||{},a=RED.settings.get("editor")||{};(i=a.keymap||{})[n.id]=null,a.keymap=i,RED.settings.set("editor",a);var s={id:n.id,scope:o?o.scope:void 0,key:o?o.key:void 0,user:o?o.user:void 0};h(t,s)}),a.focus()}}function f(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var n=t.data("data"),o=t.find(".keyboard-shortcut-entry-key input"),i=t.find(".keyboard-shortcut-entry-scope select");if(!e){var a=o.val().trim(),s=i.val();if(""===a||RED.keyboard.validateKey(a)){var r=RED.keyboard.getShortcut(n.id);if(!r&&a||r&&(r.scope!==s||r.key!==a)){var d=t.find(".keyboard-shortcut-entry-key"),l=t.find(".keyboard-shortcut-entry-scope");d.empty(),l.empty(),n.key&&RED.keyboard.remove(n.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===a?(d.parent().addClass("keyboard-shortcut-entry-unassigned"),d.append($("<span>").text(RED._("keyboard.unassigned"))),delete n.key,delete n.scope):(d.parent().removeClass("keyboard-shortcut-entry-unassigned"),d.append(RED.keyboard.formatKey(a)),$("<span>").text(s).appendTo(l),n.key=a,n.scope=s,RED.keyboard.add(n.scope,n.key,n.id,!0));var c=RED.settings.get("editor")||{},p=c.keymap||{};p[n.id]=RED.keyboard.getShortcut(n.id),c.keymap=p,RED.settings.set("editor",c)}}}o.remove(),i.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function h(e,t){var n=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var o=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),i=$("<div>").addClass("keyboard-shortcut-entry-text").text(o).appendTo(n),a=$('<i class="fa fa-user"></i>').prependTo(i);t.user||a.css("opacity",0);var s=$('<div class="keyboard-shortcut-entry-key">').appendTo(n);t.key?s.append(RED.keyboard.formatKey(t.key)):(n.addClass("keyboard-shortcut-entry-unassigned"),s.append($("<span>").text(RED._("keyboard.unassigned"))));var r=$('<div class="keyboard-shortcut-entry-scope">').appendTo(n);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(r),e.click(u)}function g(){var e=$('<div id="user-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="user-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("input").searchBox({delay:100,change:function(){var e=$(this).val().trim();""===e?t.editableList("filter",null):(e=e.replace(/\s/g,""),t.editableList("filter",function(t){return t.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(e)>-1}))}});var t=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){h(e,n)}}),n=RED.actions.list();return n.sort(function(e,t){var n=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),o=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return n.localeCompare(o)}),n.forEach(function(e){t.editableList("addItem",e)}),e}return{init:function(){!function(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");if(null!==e){localStorage.removeItem("keymap");var t=RED.settings.get("editor")||{};t.keymap=JSON.parse(e),RED.settings.set("editor",t)}}}();var e=(RED.settings.get("editor")||{}).keymap||{};$.getJSON("red/keymap.json",function(t){for(var n in t)if(t.hasOwnProperty(n)){var o=t[n];for(var i in o)o.hasOwnProperty(i)&&(e.hasOwnProperty(o[i])||c(n,i,o[i],!1),r[o[i]]={scope:n,key:i,user:!1})}for(var a in e)if(e.hasOwnProperty(a)){var s=e[a];s.hasOwnProperty("key")&&c(s.scope,s.key,a,!0)}}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:g,focus:function(){setTimeout(function(){$("#user-settings-tab-keyboard-filter").focus()},200)}})},add:c,remove:p,getShortcut:function(e){return s[e]},revertToDefault:function(e){var t=s[e];if(t&&p(t.key),r.hasOwnProperty(e)){var n=r[e];c(n.scope,n.key,e,!1)}},formatKey:function(e){var n=t?e.replace(/ctrl-?/,"&#8984;"):e;return'<span class="help-key-block"><span class="help-key">'+(n=(n=(n=(n=(n=(n=t?n.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;")).split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++)if(!l(t[i]))return!1;return!0}}}(),RED.workspaces=function(){var e,t=0,n=0;function o(t,o){if(t)e.addTab(t),e.resize();else{var i=RED.nodes.id();do{n+=1}while(0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:n})+"']").size());t={type:"tab",id:i,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:n})},RED.nodes.addWorkspace(t),e.addTab(t),e.activateTab(i),o||(RED.history.push({t:"add",workspaces:[t],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),t}function i(e){if(1!==s){c(e);var t=RED.nodes.removeWorkspace(e.id);t.t="delete",t.dirty=RED.nodes.dirty(),t.workspaces=[e],RED.history.push(t),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function a(t){var n,o=RED.nodes.workspace(t);RED.view.state(RED.state.EDITING);var a={title:RED._("workspace.editFlow",{name:o.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===s?" disabled":""),text:RED._("common.label.delete"),click:function(){i(o),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var t=$("#node-input-name").val(),i=!1,a={};o.label!=t&&(a.label=o.label,i=!0,o.label=t,e.renameTab(o.id,t));var s=$("#node-input-disabled").prop("checked");o.disabled!==s&&(a.disabled=o.disabled,i=!0,o.disabled=s);var r=n.getValue();if(o.info!==r&&(a.info=o.info,i=!0,o.info=r),$("#red-ui-tab-"+o.id.replace(".","-")).toggleClass("workspace-disabled",o.disabled),i){var d={t:"edit",changes:a,node:o,dirty:RED.nodes.dirty()};o.changed=!0,RED.history.push(d),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var l=RED.view.selection();l.nodes||l.links||RED.sidebar.info.refresh(o)}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<t.size();i++)o-=$(t[i]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),o-=28,$(".node-text-editor").css("height",o+"px"),n.resize()},open:function(e){var t=e.find(".editor-tray-body"),i=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(i),$('<div class="form-row"><label for="node-input-disabled-btn" data-i18n="editor:workspace.status"></label><button id="node-input-disabled-btn" class="editor-button"><i class="fa fa-toggle-on"></i> <span id="node-input-disabled-label"></span></button> <input type="checkbox" id="node-input-disabled" style="display: none;"/></div>').appendTo(i),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(i),n=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<div class="form-tips" data-i18n="editor:workspace.tip"></div>').appendTo(i),i.find("#node-input-disabled-btn").on("click",function(e){var t=$(this).find("i");t.hasClass("fa-toggle-off")?(t.addClass("fa-toggle-on"),t.removeClass("fa-toggle-off"),$("#node-input-disabled").prop("checked",!1),$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))):(t.addClass("fa-toggle-off"),t.removeClass("fa-toggle-on"),$("#node-input-disabled").prop("checked",!0),$("#node-input-disabled-label").text(RED._("editor:workspace.disabled")))}),o.hasOwnProperty("disabled")?($("#node-input-disabled").prop("checked",o.disabled),o.disabled?(i.find("#node-input-disabled-btn i").removeClass("fa-toggle-on").addClass("fa-toggle-off"),$("#node-input-disabled-label").text(RED._("editor:workspace.disabled"))):$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))):(o.disabled=!1,$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))),$('<input type="text" style="display: none;" />').prependTo(i),i.submit(function(e){e.preventDefault()}),$("#node-input-name").val(o.label),RED.text.bidi.prepareInput($("#node-input-name")),n.getSession().setValue(o.info||"",-1),i.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(o),n.destroy()}};RED.tray.show(a)}var s=0;function r(){e=RED.tabs.create({id:"workspace-tabs",onchange:function(e){var n={old:t};t=e.id,n.workspace=t,RED.events.emit("workspace:change",n),window.location.hash="flow/"+e.id,RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?a(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&s++,$('<span class="workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",s<=1),1===s&&($("#workspace .red-ui-tabs").show(),$("#chart").show(),$("#workspace-footer").children().show())},onremove:function(e){"tab"===e.type&&s--,RED.menu.setDisabled("menu-item-workspace-delete",s<=1),0===s&&d()},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),p(t)},minimumActiveTabWidth:150,scrollable:!0,addButton:function(){o()}}),s=0}function d(){$("#workspace .red-ui-tabs").hide(),$("#chart").hide(),$("#workspace-footer").children().hide()}function l(e){a(e||t)}function c(n){n?e.contains(n.id)&&e.removeTab(n.id):i(RED.nodes.workspace(t)),n.id===t&&(t=0)}function p(t){RED.nodes.setWorkspaceOrder(t.filter(function(e){return void 0!==RED.nodes.workspace(e)})),e.order(t)}return{init:function(){r(),RED.events.on("sidebar:resize",e.resize),RED.actions.add("core:show-next-tab",e.nextTab),RED.actions.add("core:show-previous-tab",e.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){i(RED.nodes.workspace(t))}),$(window).resize(function(){e.resize()}),RED.actions.add("core:add-flow",o),RED.actions.add("core:edit-flow",l),RED.actions.add("core:remove-flow",c),d()},add:o,remove:c,order:p,edit:l,contains:function(t){return e.contains(t)},count:function(){return s},active:function(){return t},show:function(t){if(!e.contains(t)){var n=RED.nodes.subflow(t);if(!n)return;o({type:"subflow",id:t,icon:"red/images/subflow_tab.png",label:n.name,closeable:!0})}e.activateTab(t)},refresh:function(){RED.nodes.eachWorkspace(function(t){e.renameTab(t.id,t.label)}),RED.nodes.eachSubflow(function(t){e.contains(t.id)&&e.renameTab(t.id,t.name)}),RED.sidebar.config.refresh()},resize:function(){e.resize()}}}(),RED.view=function(){var e,t,n=5e3,o=5e3,i=.75,a=1,s=100,r=30,d=1e3,l=0,c=[],p=0,u={},f=20,h=!1,g=!1,v=null,b=[],m=[],y=[],w=null,D=null,E=null,R=null,x=0,T=null,_=[0,0],k=null,j=0,C=[],S=null,O=!1,L=null,P=null,N=0,I=0,z=[],A=!1,M=null,B="",J={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},U=1,V=0,F=$("#chart"),G=d3.select("#chart").append("svg:svg").attr("width",n).attr("height",o).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){Pe()}).on("contextmenu",function(){d3.event.preventDefault()}),q=G.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","innerCanvas").on("mousemove",oe).on("mousedown",function(){var e;if(1===d3.event.button)return j=RED.state.PANNING,k=[d3.event.pageX,d3.event.pageY],void(z=[F.scrollLeft(),F.scrollTop()]);E||D||(w=null,pe());0===j&&S&&(S.remove(),S=null);if((0===j||j===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){e=d3.mouse(this),d3.event.stopPropagation();var t=$("#main-container").position();j!==RED.state.QUICK_JOINING&&(j=RED.state.QUICK_JOINING,$(window).on("keyup",De)),A=!0,RED.typeSearch.show({x:d3.event.clientX-t.left-s/2,y:d3.event.clientY-t.top-r/2,cancel:function(){A=!1,we()},add:function(t){A=!1;var n=ne(t);if(n){var o=n.node,i=n.historyEvent;if(o.x=e[0],o.y=e[1],j===RED.state.QUICK_JOINING||M){if(M||Y.length>0){var a,s,r=M||Y[0],d=null;if(r.portType===V&&o.inputs>0?(d=r.node,s=r.port,a=o):r.portType===U&&o.outputs>0&&(d=o,a=r.node,s=0),null!==d){var l={source:d,sourcePort:s,target:a};RED.nodes.addLink(l),i.links=[l],Z(),!M&&r.portType===V&&o.outputs>0?Q([{node:o,port:0,portType:V}]):!M&&r.portType===U&&o.inputs>0?Q([{node:o,port:0,portType:U}]):we()}else Z(),we()}else o.outputs>0?Q([{node:o,port:0,portType:V}]):o.inputs>0?Q([{node:o,port:0,portType:U}]):we();M=null}RED.history.push(i),RED.nodes.add(o),RED.editor.validateNode(o),RED.nodes.dirty(!0),le(),o.selected=!0,C.push({n:o}),ee(),pe(),Le()}}}),ee(),pe(),Le()}0!==j||d3.event.metaKey||d3.event.ctrlKey||p||(e=d3.mouse(this),S=q.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault())}).on("mouseup",ie).on("mouseenter",function(){S?1!==d3.event.buttons&&(S.remove(),S=null):j===RED.state.PANNING&&4!==d3.event.buttons&&we()}).on("touchend",function(){clearTimeout(p),p=null,RED.touch.radialMenu.active()||(S&&W.attr("fill","#fff"),ie.call(this))}).on("touchcancel",ie).on("touchstart",function(){var e;if(d3.event.touches.length>1){clearTimeout(p),p=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),n=e.pageY-t.pageY,o=e.pageX-t.pageX,i=$("#chart").offset(),s=[$("#chart").scrollLeft(),$("#chart").scrollTop()];c=[(t.pageX+o/2-i.left+s[0])/a,(t.pageY+n/2-i.top+s[1])/a],[t.pageX+o/2,t.pageY+n/2],l=Math.sqrt(n*n+o*o)}else{var r=d3.select(document.body),u=[(e=d3.event.touches.item(0)).pageX,e.pageY];c=[e.pageX,e.pageY],l=0;d3.touches(this)[0];p=setTimeout(function(){p=null,Oe(r,u)},d)}}).on("touchmove",function(){var e;if(RED.touch.radialMenu.active())d3.event.preventDefault();else if(d3.event.touches.length<2){if(p){var t=(e=d3.event.touches.item(0)).pageX-c[0],n=e.pageY-c[1];Math.abs(t*t+n*n)>64&&(clearTimeout(p),p=null)}else S&&d3.event.preventDefault();oe.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),i=e.pageY-o.pageY,s=e.pageX-o.pageX,r=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),d=Math.sqrt(i*i+s*s),u=[o.pageX+s/2,o.pageY+i/2];if(!isNaN(d)){oldScaleFactor=a,a=Math.min(2,Math.max(.3,a+Math.floor(100*d-100*l)/1e4));var f=[c[0]*(a-oldScaleFactor),c[1]*(a-oldScaleFactor)];l=d,u,$("#chart").scrollLeft(r[0]+f[0]),$("#chart").scrollTop(r[1]+f[1]),Le()}}}),W=q.append("svg:rect").attr("width",n).attr("height",o).attr("fill","#fff"),H=q.append("g");function K(){for(var e=[],t=0;t<n;t+=+f)e.push(t);H.selectAll("line.horizontal").remove(),H.selectAll("line.horizontal").data(e).enter().append("line").attr({class:"horizontal",x1:0,x2:n,y1:function(e){return e},y2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),H.selectAll("line.vertical").remove(),H.selectAll("line.vertical").data(e).enter().append("line").attr({class:"vertical",y1:0,y2:n,x1:function(e){return e},x2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"})}K();var X=q.append("g"),Y=[];function Q(e){for(var t=0;t<e.length;t++){var n=e[t];n.el=X.append("svg:path").attr("class","drag_line"),Y.push(n)}}function Z(){for(;Y.length;){var e=Y.pop();e.el&&e.el.remove()}}function ee(){var e=RED.workspaces.active();b=RED.nodes.filterNodes({z:e}),m=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function te(e,t,n,o,a){var d=o-t,l=n-e,c=Math.sqrt(d*d+l*l),p=i;if(l*a>0?c<s&&(p=.75-(s-c)/s*.75):p=.4-.2*Math.max(0,(s-Math.min(Math.abs(l),Math.abs(d)))/s),l*a>0)return"M "+e+" "+t+" C "+(e+a*(s*p))+" "+(t+0*r)+" "+(n-a*p*s)+" "+(o-0*r)+" "+n+" "+o;var u=Math.floor(n-l/2),f=Math.floor(o-d/2);0===d&&(f=o+r);var h=r/2,g=(o+f)/2,v=e+a*s*p,b=d>0?Math.min(g-d/2,t+h):Math.max(g-d/2,t-h),m=n-a*s*p,y=d>0?Math.max(g,o-h):Math.min(g,o+h),w=(e+v)/2,D=d>0?1:-1,E=[[w,t],[v,d>0?Math.max(t,b-h):Math.min(t,b+h)],[w,d>0?Math.min(f,b+h):Math.max(f,b-h)],[m,d>0?Math.max(f,y-h):Math.min(f,y+h)],[(n+m)/2,o]];return E[2][1]===b+D*h&&(Math.abs(d)<10*h&&(E[1][1]=b-D*h/2,E[3][1]=y-D*h/2),E[2][0]=v),"M "+e+" "+t+" C "+E[0][0]+" "+E[0][1]+" "+E[1][0]+" "+E[1][1]+" "+v+" "+b+" S "+E[2][0]+" "+E[2][1]+" "+u+" "+f+" S "+E[3][0]+" "+E[3][1]+" "+m+" "+y+" S "+E[4][0]+" "+E[4][1]+" "+n+" "+o}function ne(e,t,n){var o=/^subflow:(.+)$/.exec(e);if(v&&o){if(o[1]===v.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(o[1],v.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var i={id:RED.nodes.id(),z:RED.workspaces.active()};if(i.type=e,i._def=RED.nodes.getType(i.type),o){var a=RED.nodes.subflow(o[1]);i.name="",i.inputs=a.in.length,i.outputs=a.out.length}else{for(var d in i.inputs=i._def.inputs||0,i.outputs=i._def.outputs,i._def.defaults)i._def.defaults.hasOwnProperty(d)&&void 0!==i._def.defaults[d].value&&(i[d]=JSON.parse(JSON.stringify(i._def.defaults[d].value)));if(i._def.onadd)try{i._def.onadd.call(i)}catch(e){console.log("Definition error: "+i.type+".onadd:",e)}}i.changed=!0,i.moved=!0,i.w=s,i.h=Math.max(r,15*(i.outputs||0));var l={t:"add",nodes:[i.id],dirty:RED.nodes.dirty()};if(v){var c=RED.subflow.refresh(!0);c&&(l.subflow={id:v.id,changed:v.changed,instances:c.instances})}return{node:i,historyEvent:l}}function oe(){var i,a;if(j===RED.state.PANNING){var s=[d3.event.pageX,d3.event.pageY],r=[k[0]-s[0],k[1]-s[1]];return F.scrollLeft(z[0]+r[0]),void F.scrollTop(z[1]+r[1])}if(k=d3.touches(this)[0]||d3.mouse(this),S){var d,l,c=parseInt(S.attr("ox")),p=parseInt(S.attr("oy")),u=parseInt(S.attr("x")),v=parseInt(S.attr("y"));return d=k[0]<c?c-(u=k[0]):k[0]-u,l=k[1]<p?p-(v=k[1]):k[1]-v,void S.attr("x",u).attr("y",v).attr("width",d).attr("height",l)}if(j==RED.state.QUICK_JOINING||j==RED.state.IMPORT_DRAGGING||E||null!=w){var b;if(j==RED.state.JOINING||j===RED.state.QUICK_JOINING){if(0===Y.length&&null!==R){if(d3.event.shiftKey){var m,y=[],D=[];if(w&&(R===V&&w.source===E&&w.sourcePort===x||R===U&&w.target===E))D=[w];else m=R===V?{source:E,sourcePort:x}:{target:E},D=RED.nodes.filterLinks(m);for(i=0;i<D.length;i++){var $=D[i];RED.nodes.removeLink($),y.push({link:$,node:R===V?$.target:$.source,port:R===V?0:$.sourcePort,portType:R===V?U:V})}0===y.length?(we(),Le()):(Q(y),j=0,ee(),Le(),j=RED.state.JOINING)}else E&&Q([{node:E,port:x,portType:R}]);w=null}for(b=k,i=0;i<Y.length;i++){var T=Y[i],O=-((T.portType===V&&T.node.outputs||1)-1)/2*13+13*T.port,L=T.portType===V?1:-1;T.el.attr("d",te(T.node.x+L*T.node.w/2,T.node.y+O,b[0],b[1],L))}d3.event.preventDefault()}else if(j==RED.state.MOVING){b=d3.mouse(document.body),isNaN(b[0])&&(b=d3.touches(document.body)[0]),(_[0]-b[0])*(_[0]-b[0])+(_[1]-b[1])*(_[1]-b[1])>3&&(j=RED.state.MOVING_ACTIVE,I=0,g=!1,1===C.length&&(a=C[0],g=a.n.hasOwnProperty("_def")&&a.n._def.inputs>0&&a.n._def.outputs>0&&0===RED.nodes.filterLinks({source:a.n}).length&&0===RED.nodes.filterLinks({target:a.n}).length))}else if(j==RED.state.MOVING_ACTIVE||j==RED.state.IMPORT_DRAGGING){b=k;for(var P=0,N=0,A=n,M=o,B=0;B<C.length;B++)a=C[B],d3.event.shiftKey&&(a.n.ox=a.n.x,a.n.oy=a.n.y),a.n.x=b[0]+a.dx,a.n.y=b[1]+a.dy,a.n.dirty=!0,P=Math.min(a.n.x-a.n.w/2-5,P),N=Math.min(a.n.y-a.n.h/2-5,N),A=Math.max(a.n.x+a.n.w/2+5,A),M=Math.max(a.n.y+a.n.h/2+5,M);if(0!==P||0!==N)for(i=0;i<C.length;i++)(a=C[i]).n.x-=P,a.n.y-=N;if(A!==n||M!==o)for(i=0;i<C.length;i++)(a=C[i]).n.x-=A-n,a.n.y-=M-o;if(h!=d3.event.shiftKey&&C.length>0){var J=[0,0];if(a=C[0],J[0]=a.n.x-(f*Math.floor((a.n.x-a.n.w/2)/f)+a.n.w/2),J[1]=a.n.y-f*Math.floor(a.n.y/f),0!==J[0]||0!==J[1])for(i=0;i<C.length;i++)(a=C[i]).n.x-=J[0],a.n.y-=J[1],a.n.x==a.n.ox&&a.n.y==a.n.oy&&(a.dirty=!1)}j!=RED.state.MOVING_ACTIVE&&j!=RED.state.IMPORT_DRAGGING||1!==C.length||(a=C[0],g&&(t||(t=setTimeout(function(){var n=[],o=1/0,i=null,s=a.n.x,r=a.n.y;if(G[0][0].getIntersectionList){var d=G[0][0].createSVGRect();d.x=s,d.y=r,d.width=1,d.height=1,n=G[0][0].getIntersectionList(d,G[0][0])}else n=RED.view.getLinksAtPoint(s,r);for(var l=0;l<n.length;l++)if(d3.select(n[l]).classed("link_background"))for(var c=n[l].getTotalLength(),p=0;p<c;p+=10){var u=n[l].getPointAtLength(p),f=(u.x-s)*(u.x-s)+(u.y-r)*(u.y-r);f<200&&f<o&&(o=f,i=n[l])}e&&e!==i&&d3.select(e.parentNode).classed("link_splice",!1),i?d3.select(i.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),e=i,t=null},100))))}0!==j&&Le()}}function ie(){var t,n;if(j!==RED.state.PANNING){if(j!==RED.state.QUICK_JOINING){if(E&&j==RED.state.JOINING){var o=[];for(t=0;t<Y.length;t++)Y[t].link&&o.push(Y[t].link);n={t:"delete",links:o,dirty:RED.nodes.dirty()},RED.history.push(n),Z()}if(S){var i=parseInt(S.attr("x")),a=parseInt(S.attr("y")),s=i+parseInt(S.attr("width")),r=a+parseInt(S.attr("height"));d3.event.ctrlKey||le(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>i&&e.x<s&&e.y>a&&e.y<r,e.selected&&(e.dirty=!0,C.push({n:e})))}),v&&(v.in.forEach(function(e){e.selected=e.x>i&&e.x<s&&e.y>a&&e.y<r,e.selected&&(e.dirty=!0,C.push({n:e}))}),v.out.forEach(function(e){e.selected=e.x>i&&e.x<s&&e.y>a&&e.y<r,e.selected&&(e.dirty=!0,C.push({n:e}))})),pe(),S.remove(),S=null}else j!=RED.state.DEFAULT||null!=D||d3.event.ctrlKey||d3.event.metaKey||(le(),pe());if(j==RED.state.MOVING_ACTIVE&&C.length>0){for(var d=[],l=0;l<C.length;l++){var c=C[l];c.ox===c.n.x&&c.oy===c.n.y||(d.push({n:c.n,ox:c.ox,oy:c.oy,moved:c.n.moved}),c.n.dirty=!0,c.n.moved=!0)}if(d.length>0){if(n={t:"move",nodes:d,dirty:RED.nodes.dirty()},e){var p=d3.select(e).data()[0];RED.nodes.removeLink(p);var u={source:p.source,sourcePort:p.sourcePort,target:C[0].n},f={source:C[0].n,sourcePort:0,target:p.target};RED.nodes.addLink(u),RED.nodes.addLink(f),n.links=[u,f],n.removedLinks=[p],ee()}RED.nodes.dirty(!0),RED.history.push(n)}}if(j==RED.state.MOVING||j==RED.state.MOVING_ACTIVE)for(t=0;t<C.length;t++)delete C[t].ox,delete C[t].oy;j==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),ee(),RED.nodes.dirty(!0)),we(),Le()}}else we()}function ae(){a<2&&(a+=.1,RED.view.navigator.resize(),Le())}function se(){a>.3&&(a-=.1,RED.view.navigator.resize(),Le())}function re(){a=1,RED.view.navigator.resize(),Le()}function de(){RED.nodes.eachNode(function(e){e.z==RED.workspaces.active()&&(e.selected||(e.selected=!0,e.dirty=!0,C.push({n:e})))}),v&&(v.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,C.push({n:e}))}),v.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,C.push({n:e}))})),w=null,pe(),Le()}function le(){for(var e=0;e<C.length;e++){var t=C[e];t.n.dirty=!0,t.n.selected=!1}C=[],w=null}var ce=null;function pe(){var e={};C.length>0&&(e.nodes=C.map(function(e){return e.n})),null!=w&&(e.link=w);var t=RED.workspaces.active();m=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var n={};y=[];for(var o=0;o<C.length;o++)if("link out"===C[o].n.type||"link in"===C[o].n.type){var i=C[o].n,a={};i.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link out"===i.type?t.z===i.z?n[i.id+":"+t.id]||(m.push({source:i,sourcePort:0,target:t,link:!0}),n[i.id+":"+t.id]=!0):(a[t.z]=a[t.z]||[],a[t.z].push(t)):t.z===i.z?n[t.id+":"+i.id]||(m.push({source:t,sourcePort:0,target:i,link:!0}),n[t.id+":"+i.id]=!0):(a[t.z]=a[t.z]||[],a[t.z].push(t)))}),Object.keys(a).length>0&&y.push({refresh:Math.floor(1e4*Math.random()),node:i,links:a})}var s=t+":"+JSON.stringify(e,function(e,t){return"nodes"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t});s!==ce&&(ce=s,RED.events.emit("view:selection-changed",e))}function ue(){if(fe=!1,C.length>0){for(var e=[],t=0;t<C.length;t++)e.push({n:C[t].n,ox:C[t].ox,oy:C[t].oy,moved:C[t].n.moved}),C[t].n.moved=!0,C[t].n.dirty=!0,delete C[t].ox,delete C[t].oy;Le(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}var fe=!1;function he(e,t){if(C.length>0){fe||($(document).one("keyup",ue),fe=!0);for(var n,o=0,i=0,a=0;a<C.length;a++)(n=C[a]).n.moved=!0,n.n.dirty=!0,null==n.ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y),n.n.x+=e,n.n.y+=t,n.n.dirty=!0,o=Math.min(n.n.x-n.n.w/2-5,o),i=Math.min(n.n.y-n.n.h/2-5,i);if(0!==o||0!==i)for(var s=0;s<C.length;s++)(n=C[s]).n.x-=o,n.n.y-=i;Le()}}function ge(){if(C.length>0){var e=C[0].n;"subflow"===e.type?RED.editor.editSubflow(v):RED.editor.edit(e)}}function ve(){if(C.length>0||null!=w){var e,t=[],n=[],o=[],i=[],a=[],s=RED.nodes.dirty();if(C.length>0){for(var r=0;r<C.length;r++){var d=C[r].n;if(d.selected=!1,"subflow"!=d.type){d.x<0&&(d.x=25);var l=RED.nodes.remove(d.id);t.push(d),t=t.concat(l.nodes),n=n.concat(l.links)}else"out"===d.direction?o.push(d):"in"===d.direction&&i.push(d),d.dirty=!0}o.length>0&&(e=RED.subflow.removeOutput(o))&&(n=n.concat(e.links)),1==i.length&&(e=RED.subflow.removeInput())&&(n=n.concat(e.links));var c=RED.subflow.refresh(!0);c&&(a=c.instances),C=[],(t.length>0||o.length>0||i.length>0)&&RED.nodes.dirty(!0)}w&&(RED.nodes.removeLink(w),n.push(w),RED.nodes.dirty(!0));var p={t:"delete",nodes:t,links:n,subflowOutputs:o,subflowInputs:i,subflow:{instances:a},dirty:s};RED.history.push(p),w=null,ee(),pe(),Le()}}function be(){if(C.length>0){for(var e=[],t=0;t<C.length;t++){var n=C[t].n;if("subflow"!=n.type){for(var o in n._def.defaults)if(n._def.defaults.hasOwnProperty(o)&&n._def.defaults[o].type){var i=RED.nodes.node(n[o]);i&&i._def.exclusive&&e.push(RED.nodes.convertNode(i))}e.push(RED.nodes.convertNode(n))}}B=JSON.stringify(e),RED.notify(RED._("clipboard.nodeCopied",{count:e.length}))}}function me(e,t,n){return ye(e,t,n,0)[0]}function ye(e,t,n,o){var i=document.createElement("span");i.className=t,i.style.position="absolute",i.style.top="-1000px",i.textContent=e||"",document.body.appendChild(i);var a=i.offsetWidth,s=i.offsetHeight;return document.body.removeChild(i),[n+a,o+s]}function we(){E=null,T=null,D=null,j=0,R=null,e=null,g=!1,d3.select(".link_splice").classed("link_splice",!1),t&&(clearTimeout(t),t=null)}function De(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(A&&Y.length>0&&(M=Y[0]),we(),Z(),Le(),$(window).off("keyup",De))}function Ee(e,t,n){1!==d3.event.button&&(E=e,R=t,x=n||0,j!==RED.state.QUICK_JOINING&&(j=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(j=RED.state.QUICK_JOINING,Q([{node:E,port:x,portType:R}]),$(window).on("keyup",De))),d3.event.stopPropagation(),d3.event.preventDefault())}function Re(e,t,n){var o;if(!(j===RED.state.QUICK_JOINING&&Y.length>0&&Y[0].node===e)&&(document.body.style.cursor="",j==RED.state.JOINING||j==RED.state.QUICK_JOINING)){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var o=e.w/2,i=e.h/2;e.x-o<k[0]&&e.x+o>k[0]&&e.y-i<k[1]&&e.y+i>k[1]&&(t=(T=e).inputs>0?U:V,n=0)}}):T=e;var i=[],a=[];for(o=0;o<Y.length;o++)Y[o].link&&a.push(Y[o].link);for(o=0;o<Y.length;o++)if(t!=Y[o].portType&&T!==Y[o].node){var s,r,d,l=Y[o];if(l.portType===V?(s=l.node,d=l.port,r=T):l.portType===U&&(s=T,r=l.node,d=n),!(0!==RED.nodes.filterLinks({source:s,target:r,sourcePort:d}).length)){var c={source:s,sourcePort:d,target:r};RED.nodes.addLink(c),i.push(c)}}if(i.length>0||a.length>0){var p={t:"add",links:i,removedLinks:a,dirty:RED.nodes.dirty()};if(v){var u=RED.subflow.refresh(!0);u&&(p.subflow={id:v.id,changed:v.changed,instances:u.instances})}RED.history.push(p),ee(),RED.nodes.dirty(!0)}if(j===RED.state.QUICK_JOINING)return i.length>0&&(Z(),t===U&&e.outputs>0?Q([{node:e,port:0,portType:V}]):t===V&&e.inputs>0?Q([{node:e,port:0,portType:U}]):we()),void Le();we(),Z(),w=null,Le()}}var $e=null,xe=null;function Te(e,t,n,o){clearTimeout($e);var i=j!=RED.state.JOINING||Y.length>0&&Y[0].portType!==n;i&&(n===U&&(t._def&&t._def.inputLabels||t.inputLabels)||n===V&&(t._def&&t._def.outputLabels||t.outputLabels))&&($e=setTimeout(function(){var i=function(e,t,n){var o,i=t===U?e.inputLabels:e.outputLabels;if(i&&i[n])return i[n];var a=t===U?e._def.inputLabels:e._def.outputLabels;if("string"==typeof a)o=a;else if("function"==typeof a)try{o=a.call(e,n)}catch(n){console.log("Definition error: "+e.type+"."+(t===U?"inputLabels":"outputLabels"),n),o=null}else $.isArray(a)&&(o=a[n]);return o}(t,n,o);if(i){var a=function e(t){var n=d3.select(t);if("innerCanvas"===n.attr("class"))return[0,0];var o=[0,0];if("g"===t.nodeName.toLowerCase()){var i=n.attr("transform");i&&(o=d3.transform(i).translate)}else o=[n.attr("x")||0,n.attr("y")||0];var a=e(t.parentNode);return[o[0]+a[0],o[1]+a[1]]}(e.node());$e=null,xe=q.append("g").attr("transform","translate("+(a[0]+(n===U?-2:12))+","+(a[1]+5)+")").attr("class","port_tooltip");var s=i.split("\n"),r=0,d=4,l=[];s.forEach(function(e){var t=ye(e,"port_tooltip_label",8,0);r=Math.max(r,t[0]),l.push(.8*t[1]),d+=.8*t[1]});var c=d/2-5-2,p=d-4;xe.append("path").attr("d",n===U?"M0 0 l -5 -5 v -"+c+" q 0 -2 -2 -2 h -"+r+" q -2 0 -2 2 v "+p+" q 0 2 2 2 h "+r+" q 2 0 2 -2 v -"+c+" l 5 -5":"M0 0 l 5 -5 v -"+c+" q 0 -2 2 -2 h "+r+" q 2 0 2 2 v "+p+" q 0 2 -2 2 h -"+r+" q -2 0 -2 -2 v -"+c+" l -5 -5");var u=-d/2-2;s.forEach(function(e,t){u+=l[t],xe.append("svg:text").attr("class","port_tooltip_label").attr("x",n===U?-10:10).attr("y",u).attr("text-anchor",n===U?"end":"start").text(e)})}},500)),e.classed("port_hovered",i)}function _e(e,t,n,o){clearTimeout($e),xe&&(xe.remove(),xe=null),e.classed("port_hovered",!1)}function ke(e){if(P&&E==e&&I>0&&I<750)return j=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(v),I=0,void d3.event.stopPropagation();Re(e,e._def?e.inputs>0?1:0:"in"==e.direction?0:1,0)}function je(t){if(Pe(),1!==d3.event.button){if(j==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),e){var n=d3.select(e).data()[0];RED.nodes.removeLink(n);var o={source:n.source,sourcePort:n.sourcePort,target:C[0].n},i={source:C[0].n,sourcePort:0,target:n.target};RED.nodes.addLink(o),RED.nodes.addLink(i);var a=RED.history.peek();a.links=[o,i],a.removedLinks=[n],ee()}return pe(),RED.nodes.dirty(!0),Le(),we(),void d3.event.stopPropagation()}if(j!=RED.state.QUICK_JOINING){E=t;var s,r=Date.now();if(I=r-N,N=r,P=!(L!=E||1!==d3.event.buttons||d3.event.shiftKey||d3.event.metaKey||d3.event.altKey||d3.event.ctrlKey),L=E,t.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(E.selected=!1,s=0;s<C.length;s+=1)if(C[s].n===E){C.splice(s,1);break}}else{if(d3.event.shiftKey){le();for(var d=RED.nodes.getAllFlowNodes(E),l=0;l<d.length;l++)d[l].selected=!0,d[l].dirty=!0,C.push({n:d[l]})}else t.selected||(d3.event.ctrlKey||d3.event.metaKey||le(),E.selected=!0,C.push({n:E}));if(w=null,2!=d3.event.button){j=RED.state.MOVING;var c=d3.touches(this)[0]||d3.mouse(this);for(c[0]+=t.x-t.w/2,c[1]+=t.y-t.h/2,s=0;s<C.length;s++)C[s].ox=C[s].n.x,C[s].oy=C[s].n.y,C[s].dx=C[s].n.x-c[0],C[s].dy=C[s].n.y-c[1];_=d3.mouse(document.body),isNaN(_[0])&&(_=d3.touches(document.body)[0])}}t.dirty=!0,pe(),Le(),d3.event.stopPropagation()}else d3.event.stopPropagation()}}function Ce(e){var t=!0;return e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function Se(e){if(v)RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(e._def.button.toggle&&(e[e._def.button.toggle]=!e[e._def.button.toggle],e.dirty=!0),e._def.button.onclick)try{e._def.button.onclick.call(e)}catch(t){console.log("Definition error: "+e.type+".onclick",t)}e.dirty&&Le()}d3.event.preventDefault()}function Oe(e,t){var n=E,o=[];o.push({name:"delete",disabled:0===C.length&&null===w,onselect:function(){ve()}}),o.push({name:"cut",disabled:0===C.length,onselect:function(){be(),ve()}}),o.push({name:"copy",disabled:0===C.length,onselect:function(){be()}}),o.push({name:"paste",disabled:0===B.length,onselect:function(){Ne(B,!1,!0)}}),o.push({name:"edit",disabled:1!=C.length,onselect:function(){RED.editor.edit(n)}}),o.push({name:"select",onselect:function(){de()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,o),we()}function Le(){if(q.attr("transform","scale("+a+")"),G.attr("width",n*a).attr("height",o*a),j!=RED.state.JOINING){var e={};if(v){var t=q.selectAll(".subflowoutput").data(v.out,function(e,t){return e.id});t.exit().remove();var i=t.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});i.each(function(e,t){e.w=40,e.h=40}),i.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",ke).on("mousedown",je).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){Oe(t,o)},d),je.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():ke.call(this,e)}),i.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Ee(e,U,0)}).on("touchstart",function(e,t){Ee(e,U,0)}).on("mouseup",function(e,t){Re(e,U,0)}).on("touchend",function(e,t){Re(e,U,0)}).on("mouseover",function(e){Te(d3.select(this),e,U,0)}).on("mouseout",function(e){_e(d3.select(this))}),i.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),i.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1});var u=q.selectAll(".subflowinput").data(v.in,function(e,t){return e.id});u.exit().remove();var f=u.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});f.each(function(e,t){e.w=40,e.h=40}),f.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",ke).on("mousedown",je).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){Oe(t,o)},d),je.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():ke.call(this,e)}),f.append("g").attr("transform","translate(35,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Ee(e,V,t)}).on("touchstart",function(e,t){Ee(e,V,t)}).on("mouseup",function(e,t){Re(e,V,t)}).on("touchend",function(e,t){Re(e,V,t)}).on("mouseover",function(e){Te(d3.select(this),e,V,0)}).on("mouseout",function(e){_e(d3.select(this))}),f.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),t.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.selectAll(".port_index").text(function(e){return e.i+1}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}}),u.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}})}else q.selectAll(".subflowoutput").remove(),q.selectAll(".subflowinput").remove();var h=q.selectAll(".nodegroup").data(b,function(e){return e.id});h.exit().remove(),h.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(e){return null!=v}).classed("node_link",function(e){return"link in"===e.type||"link out"===e.type}).each(function(e,t){var n=d3.select(this),o="link in"===e.type||"link out"===e.type;n.attr("id",e.id);var i=RED.utils.getNodeLabel(e);if(e.w=o?r:Math.max(s,20*Math.ceil((me(i,"node_label",50)+(e._def.inputs>0?7:0))/20)),e.h=Math.max(r,15*(e.outputs||0)),e._def.badge){var a=n.append("svg:g").attr("class","node_badge_group"),u=a.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);a.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(e._def.badge()),e._def.onbadgeclick&&u.attr("cursor","pointer").on("click",function(e){e._def.onbadgeclick.call(e),d3.event.preventDefault()})}if(e._def.button){var f=n.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class",function(e){return"node_button "+("right"==e._def.align?"node_right_button":"node_left_button")});f.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",r-4).attr("fill","#eee"),f.append("rect").attr("class","node_button_button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",r-12).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)}).attr("cursor","pointer").on("mousedown",function(e){!S&&Ce(e)&&(Pe(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!S&&Ce(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!S&&Ce(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!S&&Ce(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",Se).on("touchstart",Se)}n.append("rect").attr("class","node").classed("node_unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)}).on("mouseup",ke).on("mousedown",je).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){Oe(t,o)},d),je.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():ke.call(this,e)}).on("mouseover",function(e){0===j&&d3.select(this).classed("node_hovered",!0)}).on("mouseout",function(e){d3.select(this).classed("node_hovered",!1)});if(e._def.icon){var h=RED.utils.getNodeIcon(e._def,e),g=n.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),v=(g.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(e){return Math.min(50,e.h-4)}),g.append("image").attr("xlink:href",h).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),b=g.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==e._def.align&&(g.attr("class","node_icon_group node_icon_group_"+e._def.align),b.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)}));var m=new Image;m.src=h,m.onload=function(){v.attr("width",Math.min(m.width,30)),v.attr("height",Math.min(m.height,30)),v.attr("x",15-Math.min(m.width,30)/2)},g.style("pointer-events","none")}if(!o){var y=n.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".35em").attr("text-anchor","start");e._def.align&&(y.attr("class","node_label node_label_"+e._def.align),"right"===e._def.align&&y.attr("text-anchor","end"));var w=n.append("svg:g").attr("class","node_status_group").style("display","none");w.append("rect").attr("class","node_status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),w.append("svg:text").attr("class","node_status_label").attr("x",20).attr("y",9)}n.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-red/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),n.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-red/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),h.each(function(t,n){if(t.dirty){var o="link in"===t.type||"link out"===t.type;if(e[t.id]=t,!o&&t.resize){var i=RED.utils.getNodeLabel(t),a=t.w;t.w=Math.max(s,20*Math.ceil((me(i,"node_label",50)+(t._def.inputs>0?7:0))/20)),t.h=Math.max(r,15*(t.outputs||0)),t.x+=(t.w-a)/2,t.resize=!1}var d=d3.select(this);if(d.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),j!=RED.state.MOVING_ACTIVE){d.selectAll(".node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("node_selected",function(e){return e.selected}).classed("node_highlighted",function(e){return e.highlighted}),d.selectAll(".node_icon_group_right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),d.selectAll(".node_label_right").attr("x",function(e){return e.w-38});var l=d.selectAll(".port_input");if(0!==t.inputs||l.empty()){if(1===t.inputs&&l.empty()){d.append("g").attr("class","port_input").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e){Ee(e,U,0)}).on("touchstart",function(e){Ee(e,U,0)}).on("mouseup",function(e){Re(e,U,0)}).on("touchend",function(e){Re(e,U,0)}).on("mouseover",function(e){Te(d3.select(this),e,U,0)}).on("mouseout",function(e){_e(d3.select(this))})}}else l.remove();var c=t.outputs,p=t.h/2-(c-1)/2*13;if(t.ports=t.ports||d3.range(c),t._ports=d.selectAll(".port_output").data(t.ports),t._ports.enter().append("g").attr("class","port_output").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(y=t,function(e,t){Ee(y,V,t)})).on("touchstart",function(){var e=t;return function(t,n){Ee(e,V,n)}}()).on("mouseup",function(){var e=t;return function(t,n){Re(e,V,n)}}()).on("touchend",function(){var e=t;return function(t,n){Re(e,V,n)}}()).on("mouseover",function(){var e=t;return function(t,n){Te(d3.select(this),e,V,n)}}()).on("mouseout",function(e,t){_e(d3.select(this))}),t._ports.exit().remove(),t._ports){c=t.outputs||1,p=t.h/2-(c-1)/2*13;var u=t.w-5;t._ports.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+u+","+(p+13*t-5)+")"})})}if(d.selectAll("text.node_label").text(function(e,t){var n="";if(e._def.label){n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||"",n=RED.text.bidi.enforceTextDirectionWithUCC(n)}catch(t){console.log("Definition error: "+e.type+".label",t),n=e.type}}return n}).attr("y",function(e){return e.h/2-1}).attr("class",function(e){var t="";if(e._def.labelStyle){t=e._def.labelStyle;try{t=("function"==typeof t?t.call(e):t)||""}catch(n){console.log("Definition error: "+e.type+".labelStyle",n),t=""}t=" "+t}return"node_label"+(e._def.align?" node_label_"+e._def.align:"")+t}),t._def.icon){icon=d.select(".node_icon");var f=icon.attr("xlink:href"),h=RED.utils.getNodeIcon(t._def,t);if(h!==f){icon.attr("xlink:href",h);var g=new Image;g.src=h,g.onload=function(){icon.attr("width",Math.min(g.width,30)),icon.attr("height",Math.min(g.height,30)),icon.attr("x",15-Math.min(g.width,30)/2)}}}d.selectAll(".node_tools").attr("x",function(e){return e.w-35}).attr("y",function(e){return e.h-20}),d.selectAll(".node_changed").attr("x",function(e){return e.w-10}).classed("hidden",function(e){return!(e.changed||e.moved)}),d.selectAll(".node_error").attr("x",function(e){return e.w-10-(e.changed||e.moved?13:0)}).classed("hidden",function(e){return e.valid}),d.selectAll(".port_input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),d.selectAll(".node_icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),d.selectAll(".node_icon_shade").attr("height",function(e){return e.h}),d.selectAll(".node_icon_shade_border").attr("d",function(e){return"M "+("right"==e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),d.selectAll(".node_button").attr("opacity",function(e){return v||!Ce(e)?.4:1}),d.selectAll(".node_button_button").attr("cursor",function(e){return v||!Ce(e)?"":"pointer"}),d.selectAll(".node_right_button").attr("transform",function(e){var t=e.w-6;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-=8),"translate("+t+",2)"}),d.selectAll(".node_right_button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),d.selectAll(".node_badge_group").attr("transform",function(e){return"translate("+(e.w-40)+","+(e.h+3)+")"}),d.selectAll("text.node_badge_label").text(function(e,t){if(e._def.badge){if("function"!=typeof e._def.badge)return e._def.badge;try{return e._def.badge.call(e)}catch(t){return console.log("Definition error: "+e.type+".badge",t),""}}return""})}if(O&&t.status){d.selectAll(".node_status_group").style("display","inline").attr("transform","translate(3,"+(t.h+3)+")");var b,m=J[t.status.fill];if(null==t.status.shape&&null==m)d.selectAll(".node_status").style("display","none");else null==t.status.shape||"dot"==t.status.shape?b={display:"inline",fill:m,stroke:m}:"ring"==t.status.shape&&(b={display:"inline",fill:"#fff",stroke:m}),d.selectAll(".node_status").style(b);t.status.text?d.selectAll(".node_status_label").text(t.status.text):d.selectAll(".node_status_label").text("")}else d.selectAll(".node_status_group").style("display","none");t.dirty=!1}var y});var g=q.selectAll(".link").data(m,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i});g.enter().insert("g",".node").attr("class","link").each(function(e,t){var n=d3.select(this);e.added=!0,n.append("svg:path").attr("class","link_background link_path").on("mousedown",function(e){D=e,le(),w=D,pe(),Le(),Pe(),d3.event.stopPropagation()}).on("touchstart",function(e){D=e,le(),w=D,pe(),Le(),Pe(),d3.event.stopPropagation();var t=d3.select(document.body),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];p=setTimeout(function(){p=null,Oe(t,o)},d)}),n.append("svg:path").attr("class","link_outline link_path"),n.append("svg:path").attr("class","link_line link_path").classed("link_link",function(e){return e.link}).classed("link_subflow",function(e){return!e.link&&v})}),g.exit().remove(),q.selectAll(".link_path").each(function(t){var n=d3.select(this);(t.added||t===w||t.selected||e[t.source.id]||e[t.target.id])&&n.attr("d",function(e){var t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0);return e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y,te(e.x1,e.y1,e.x2,e.y2,1)})}),g.classed("link_selected",function(e){return e===w||e.selected}),g.classed("link_unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var E=q.selectAll(".link_flow_link_g").data(y,function(e){return e.node.id+":"+e.refresh});E.enter().insert("g",".node").attr("class","link_flow_link_g").each(function(e,t){var n=d3.select(this),o=1,i="start";"link in"===e.node.type&&(o=-1,i="end");var a=30*o,d=20*o,l=(n.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+a),e.links),c=Object.keys(l),p=RED.nodes.getWorkspaceOrder();c.sort(function(e,t){return p.indexOf(e)-p.indexOf(t)});var u=r,f=-(c.length-1)*u/2,h=n.selectAll(".link_group").data(c);h.enter().append("g").attr("class","link_group").on("mouseover",function(){d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(t){d3.event.stopPropagation();var n=e.links[t];RED.workspaces.show(t),n.forEach(function(e){e.selected=!0,e.dirty=!0,C.push({n:e})}),pe(),Le()}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+a+" 0 C "+(a+1.7*d)+" 0 "+(a+.1*d)+" "+f+" "+(a+1.5*d)+" "+f+" "),t.append("svg:path").attr("class","link_port").attr("d","M "+(a+1.5*d+17*o)+" "+(f-12)+" h "+10*-o+" a 3 3 45 0 "+(1===o?"0":"1")+" "+-3*o+" 3 v 18 a 3 3 45 0 "+(1===o?"0":"1")+" "+3*o+" 3 h "+10*o),t.append("svg:path").attr("class","link_port").attr("d","M "+(a+1.5*d+20*o)+" "+(f-12)+" h "+30*o+" M "+(a+1.5*d+20*o)+" "+(f+12)+" h "+30*o).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","port link_port").attr("x",a+1.5*d-4+4*o).attr("y",f-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",a+1.5*d-(-1===o?s:0)).attr("y",f-12).attr("width",s).attr("height",24).style("stroke","none").style("fill","transparent");var n,r=RED.nodes.workspace(e);r&&(n=r.label||r.id),t.append("svg:text").attr("class","port_label").attr("x",a+1.5*d+15*o).attr("y",f+1).style("font-size","10px").style("text-anchor",i).text(n),f+=u}),h.exit().remove()}),E.exit().remove(),(E=q.selectAll(".link_flow_link_g")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else q.selectAll(".link_selected").data(m,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("link_selected",!1);RED.view.navigator.refresh(),d3.event&&d3.event.preventDefault()}function Pe(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(e,t)}catch(e){$("#chart").focus()}}function Ne(e,t,n){try{var o;v&&(o=v.changed);var i=RED.nodes.import(e,!0,t);if(i){var a=i[0],d=i[1],l=i[2],c=i[3],p=i[4];t&&p&&RED.workspaces.show(p.id);var u=a.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),f=a.map(function(e){return e.id});if(u.length>0){var h=u[0].n,b=h.x,m=h.y;null==k&&(k=[0,0]);var y,w,D=0,E=0;for(y=0;y<u.length;y++)(w=u[y]).n.selected=!0,w.n.changed=!0,w.n.moved=!0,w.n.x-=b-k[0],w.n.y-=m-k[1],w.dx=w.n.x-k[0],w.dy=w.n.y-k[1],D=Math.min(w.n.x-s/2-5,D),E=Math.min(w.n.y-r/2-5,E);for(y=0;y<u.length;y++)if((w=u[y]).n.x-=D,w.n.y-=E,w.dx-=D,w.dy-=E,w.n._def.onadd)try{w.n._def.onadd.call(w.n)}catch(e){console.log("Definition error: "+w.n.type+".onadd:",e)}n||(j=RED.state.IMPORT_DRAGGING,g=!1,1===u.length&&(w=u[0],g=w.n.hasOwnProperty("_def")&&w.n._def.inputs>0&&w.n._def.outputs>0)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),le(),RED.history.pop(),j=0}),le(),C=u}var R={t:"add",nodes:f,links:d,workspaces:l,subflows:c,dirty:RED.nodes.dirty()};if(0===u.length&&RED.nodes.dirty(!0),v){var $=RED.subflow.refresh(!0);$&&(R.subflow={id:v.id,changed:o,instances:$.instances})}RED.history.push(R),ee(),Le()}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}return{init:function(){RED.events.on("workspace:change",function(e){0!==e.old&&(u[e.old]={left:F.scrollLeft(),top:F.scrollTop()});var t=F.scrollLeft(),n=F.scrollTop();v=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",v),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||v),u[e.workspace]?(F.scrollLeft(u[e.workspace].left),F.scrollTop(u[e.workspace].top)):(F.scrollLeft(0),F.scrollTop(0));var o=F.scrollLeft()-t,i=F.scrollTop()-n;null!=k&&(k[0]+=o,k[1]+=i),le(),RED.nodes.eachNode(function(e){e.dirty=!0}),pe(),ee(),Le()}),RED.view.navigator.init(),$("#btn-zoom-out").click(function(){se()}),$("#btn-zoom-zero").click(function(){re()}),$("#btn-zoom-in").click(function(){ae()}),$("#chart").on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?se():ae())}),$("#chart").droppable({accept:".palette_node",drop:function(e,t){d3.event=e;var n=ne(t.draggable[0].type);if(n){var o=n.historyEvent,i=n.node,s=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),r=d3.touches(this)[0]||d3.mouse(this);r[1]+=this.scrollTop+(i.h/2-s[1]),r[0]+=this.scrollLeft+(i.w/2-s[0]),r[1]/=a,r[0]/=a,h&&(r[0]=f*Math.ceil(r[0]/f),r[1]=f*Math.ceil(r[1]/f)),i.x=r[0],i.y=r[1];var d=$(t.helper).data("splice");if(d){RED.nodes.removeLink(d);var l={source:d.source,sourcePort:d.sourcePort,target:i},c={source:i,sourcePort:0,target:d.target};RED.nodes.addLink(l),RED.nodes.addLink(c),o.links=[l,c],o.removedLinks=[d]}RED.history.push(o),RED.nodes.add(i),RED.editor.validateNode(i),RED.nodes.dirty(!0),le(),i.selected=!0,C.push({n:i}),ee(),pe(),Le(),i._def.autoedit&&RED.editor.edit(i)}}}),$("#chart").focus(function(){$("#workspace-tabs").addClass("workspace-focussed")}),$("#chart").blur(function(){$("#workspace-tabs").removeClass("workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",be),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){be(),ve()}),RED.actions.add("core:paste-from-internal-clipboard",function(){Ne(B)}),RED.actions.add("core:delete-selection",ve),RED.actions.add("core:edit-selected-node",ge),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:select-all-nodes",de),RED.actions.add("core:zoom-in",ae),RED.actions.add("core:zoom-out",se),RED.actions.add("core:zoom-reset",re),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):function(e){e?H.style("visibility","visible"):H.style("visibility","hidden")}(e)}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):function(e){h=e,Le()}(e)}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(O=e,RED.nodes.eachNode(function(e){e.dirty=!0}),Le())}),RED.actions.add("core:move-selection-up",function(){he(0,-1)}),RED.actions.add("core:step-selection-up",function(){he(0,-20)}),RED.actions.add("core:move-selection-right",function(){he(1,0)}),RED.actions.add("core:step-selection-right",function(){he(20,0)}),RED.actions.add("core:move-selection-down",function(){he(0,1)}),RED.actions.add("core:step-selection-down",function(){he(0,20)}),RED.actions.add("core:move-selection-left",function(){he(-1,0)}),RED.actions.add("core:step-selection-left",function(){he(-20,0)})},state:function(e){if(null==e)return j;j=e},redraw:function(e){e&&(ee(),pe()),Le()},focus:Pe,importNodes:Ne,calculateTextWidth:me,select:function(e){if(void 0!==e&&(le(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,C=[{n:t}])}pe(),Le()},selection:function(){var e={};return C.length>0&&(e.nodes=C.map(function(e){return e.n})),null!=w&&(e.link=w),e},scale:function(){return a},getLinksAtPoint:function(e,t){for(var n=[],o=G.selectAll(".link_background")[0],i=0;i<o.length;i++){var a=o[i].getBBox();e>=a.x&&t>=a.y&&e<=a.x+a.width&&t<=a.y+a.height&&n.push(o[i])}return n},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z);var n=[$("#chart").width(),$("#chart").height()],o=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(t.x<o[0]||t.y<o[1]||t.x>n[0]+o[0]||t.y>n[1]+o[1]){var i="-="+(o[0]-t.x+n[0]/2),a="-="+(o[1]-t.y+n[1]/2);$("#chart").animate({scrollLeft:i,scrollTop:a},200)}if(!t._flashing){t._flashing=!0;var s=22,r=function(){s--,t.dirty=!0,s>=0?(t.highlighted=!t.highlighted,setTimeout(r,100)):(t.highlighted=!1,delete t._flashing),RED.view.redraw()};r()}}else"config"===t._def.category&&RED.sidebar.config.show(e)}},gridSize:function(e){if(void 0===e)return f;f=Math.max(5,e),K()},getActiveNodes:function(){return b}}}(),RED.view.navigator=function(){var e,t,n,o,i,a,s,r,d,l=25,c=5e3/l,p=5e3/l,u=!1;function f(){if(u){var e=o.selectAll(".navnode").data(RED.view.getActiveNodes(),function(e){return e.id});e.exit().remove(),e.enter().insert("rect").attr("class","navnode").attr("pointer-events","none"),e.each(function(e){d3.select(this).attr("x",function(e){return(e.x-e.w/2)/l}).attr("y",function(e){return(e.y-e.h/2)/l}).attr("width",function(e){return Math.max(9,e.w/l)}).attr("height",function(e){return Math.max(3,e.h/l)}).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)})})}}function h(){d||g()}function g(){n&&(a=RED.view.scale(),s=[$("#chart").width(),$("#chart").height()],i=[$("#chart").scrollLeft(),$("#chart").scrollTop()],n.attr("x",i[0]/l).attr("y",i[1]/l).attr("width",s[0]/l/a).attr("height",s[1]/l/a))}function v(){u?(u=!1,e.fadeOut(100),$("#chart").off("scroll",h),$("#btn-navigate").removeClass("selected")):(u=!0,$("#btn-navigate").addClass("selected"),g(),f(),$("#chart").on("scroll",h),e.fadeIn(200))}return{init:function(){$(window).resize(g),RED.events.on("sidebar:resize",g),RED.actions.add("core:toggle-navigator",v),e=$("<div>").css({position:"absolute",bottom:$("#workspace-footer").height(),right:0,zIndex:1}).appendTo("#workspace").hide(),(t=d3.select(e[0]).append("svg:svg").attr("width",c).attr("height",p).attr("pointer-events","all").style({position:"absolute",bottom:0,right:0,zIndex:101,"border-left":"1px solid #ccc","border-top":"1px solid #ccc",background:"rgba(245,245,245,0.5)","box-shadow":"-1px 0 3px rgba(0,0,0,0.1)"})).append("rect").attr("x",0).attr("y",0).attr("width",c).attr("height",p).style({fill:"none",stroke:"none",pointerEvents:"all"}).on("mousedown",function(){a=RED.view.scale(),s=[$("#chart").width(),$("#chart").height()],r=[s[0]/l/a,s[1]/l/a];var e=Math.max(0,Math.min(d3.event.offsetX+r[0]/2,c)-r[0]),t=Math.max(0,Math.min(d3.event.offsetY+r[1]/2,p)-r[1]);n.attr("x",e).attr("y",t),d=!0,$("#chart").scrollLeft(e*l*a),$("#chart").scrollTop(t*l*a)}).on("mousemove",function(){if(d)if(0!==d3.event.buttons){var e=Math.max(0,Math.min(d3.event.offsetX+r[0]/2,c)-r[0]),t=Math.max(0,Math.min(d3.event.offsetY+r[1]/2,p)-r[1]);n.attr("x",e).attr("y",t),$("#chart").scrollLeft(e*l*a),$("#chart").scrollTop(t*l*a)}else d=!1}).on("mouseup",function(){d=!1}),n=t.append("rect").attr("stroke-dasharray","5,5").attr("pointer-events","none").style({stroke:"#999",strokeWidth:1,fill:"white"}),o=t.append("svg:g"),$("#btn-navigate").click(function(e){e.preventDefault(),v()})},refresh:f,resize:g,toggle:v}}(),RED.sidebar=function(){var e=RED.tabs.create({id:"sidebar-tabs",onchange:function(e){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},collapsible:!0}),t={};var n={};function o(t){t?($("#main-container").removeClass("sidebar-closed"),e.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function i(n){n&&(a(n)||e.addTab(t[n]),e.activateTab(n),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function a(t){return e.contains(t)}return $("#sidebar-separator").draggable({axis:"x",start:function(e,t){n.closing=!1,n.opening=!1;var o=$(window).width();if(n.start=t.position.left,n.chartWidth=$("#workspace").width(),n.chartRight=o-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){n.opening=!0;$("#sidebar").addClass("closing"),$("#workspace").css("right",7),$("#editor-stack").css("right",8),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}n.width=$("#sidebar").width()},drag:function(t,o){var i=o.position.left-n.start,a=n.width-i;n.opening&&(a-=3),a>150&&n.chartWidth+i<200&&(o.position.left=200+n.start-n.chartWidth,i=o.position.left-n.start,a=n.width-i),a<150?(n.closing||($("#sidebar").addClass("closing"),n.closing=!0),n.opening||(a=150,o.position.left=n.width-(150-n.start),i=o.position.left-n.start)):a>150&&(n.closing||n.opening)&&(n.closing=!1,$("#sidebar").removeClass("closing"));var s=n.chartRight-i;$("#workspace").css("right",s),$("#editor-stack").css("right",s+1),$("#sidebar").width(a),e.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){n.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:function(){RED.actions.add("core:toggle-sidebar",function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):o(e)}),i(),RED.sidebar.info.init(),RED.sidebar.config.init(),RED.sidebar.context.init(),$(window).width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(n,o,a,s){var r;"string"==typeof n?r={id:o.id,label:n,name:n,content:o,closeable:a,visible:s}:"object"==typeof n&&(r=n),delete r.closeable,r.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),r.wrapper.append(r.content),r.wrapper.hide(),r.enableOnEdit||(r.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(r.wrapper)),r.toolbar&&($("#sidebar-footer").append(r.toolbar),$(r.toolbar).hide()),r.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+r.id,label:r.name,onselect:function(){i(r.id)},group:"sidebar-tabs"}),r.iconClass=r.iconClass||"fa fa-square-o",t[r.id]=r,!1!==r.visible&&e.addTab(t[r.id])},removeTab:function(n){e.removeTab(n),$(t[n].wrapper).remove(),t[n].footer&&t[n].footer.remove(),delete t[n],RED.menu.removeItem("menu-item-view-menu-"+n)},show:i,containsTab:a,toggleSidebar:o}}(),RED.palette=function(){var e=["config","unknown","deprecated"],t=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],n={};function o(e,t,n,o){0===$("#palette-base-category-"+t).length&&i(e,t,o+":palette.label."+t),$("#palette-container-"+t).show(),0===$("#palette-"+n).length&&$("#palette-base-category-"+t).append('<div id="palette-'+n+'"></div>')}function i(e,t,o){var i=RED._(o,{defaultValue:t});i=(i||t).replace(/_/g," ");var a=$('<div id="palette-container-'+t+'" class="palette-category palette-close hide"><div id="palette-header-'+t+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+i+'</span></div><div class="palette-content" id="palette-base-category-'+t+'"><div id="palette-'+t+'-input"></div><div id="palette-'+t+'-output"></div><div id="palette-'+t+'-function"></div></div></div>').appendTo("#palette-container");a.data("category",e),a.data("label",i),n[t]={container:a,close:function(){a.removeClass("palette-open"),a.addClass("palette-closed"),$("#palette-base-category-"+t).slideUp(),$("#palette-header-"+t+" i").removeClass("expanded")},open:function(){a.addClass("palette-open"),a.removeClass("palette-closed"),$("#palette-base-category-"+t).slideDown(),$("#palette-header-"+t+" i").addClass("expanded")},toggle:function(){a.hasClass("palette-open")?n[t].close():n[t].open()}},$("#palette-header-"+t).on("click",function(e){n[t].toggle()})}function a(e,t,n,o){for(var i=n.split(/[ -]/),a=[],s=i[0],r=(RED.view.calculateTextWidth(s,"palette_label",0),1);r<i.length;r++){var d=RED.view.calculateTextWidth(s+" "+i[r],"palette_label",0);d<82?(s+=" "+i[r],d):(a.push(s),s=i[r],RED.view.calculateTextWidth(s,"palette_label",0))}a.push(s);var l,c=a.join("<br/>"),p=8+20*a.length;t.css({height:p+"px"}),t.find(".palette_label").html(c).attr("dir",RED.text.bidi.resolveBaseTextDir(c)),t.find(".palette_port").css({top:p/2-5+"px"});try{var u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b></p>";n!=e&&(u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b><br/><i>"+e+"</i></p>"),l=$(u+(o||($("script[data-help-name='"+e+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&this.textContent.trim().length>0}).slice(0,2)}catch(t){console.log("Error generating pop-over label for ",e),console.log(t.toString()),l="<p><b>"+n+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}t.data("popover").setContent(l)}function s(e){return e.replace(" ","_").replace(".","_").replace(":","_")}function r(i,r){var d=s(i);if(!$("#palette_node_"+d).length&&-1===e.indexOf(r.category)){r.category;var l=r.category.replace(/ /g,"_"),c=l.split("-")[0],p=document.createElement("div");p.id="palette_node_"+d,p.type=i;var u=/^(.*?)([ -]in|[ -]out)?$/.exec(i)[1];if(void 0!==r.paletteLabel)try{u=("function"==typeof r.paletteLabel?r.paletteLabel.call(r):r.paletteLabel)||""}catch(e){console.log("Definition error: "+i+".paletteLabel",e)}if($("<div/>",{class:"palette_label"+("right"==r.align?" palette_label_right":"")}).appendTo(p),p.className="palette_node",r.icon){var f=RED.utils.getNodeIcon(r),h=$("<div/>",{class:"palette_icon_container"+("right"==r.align?" palette_icon_container_right":"")}).appendTo(p);$("<div/>",{class:"palette_icon",style:"background-image: url("+f+")"}).appendTo(h)}if(p.style.backgroundColor=RED.utils.getNodeColor(i,r),r.outputs>0){var g=document.createElement("div");g.className="palette_port palette_port_output",p.appendChild(g)}if(r.inputs>0){var v=document.createElement("div");v.className="palette_port palette_port_input",p.appendChild(v)}o(r.category,c,l,-1!==t.indexOf(c)?"node-red":r.set.id),$("#palette-"+l).append(p),$(p).data("category",c),p.onmousedown=function(e){e.preventDefault()};var b=RED.popover.create({target:$(p),trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});$(p).data("popover",b),$(p).click(function(){var e;RED.view.focus(),e=0===i.indexOf("subflow:")?marked(RED.nodes.subflow(i.substring(8)).info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>":$("script[data-help-name='"+p.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",RED.sidebar.info.set(e,RED._("sidebar.info.nodeHelp"))});var m,y,w,D,E,R,x=$("#chart"),T=x.offset(),_=$("#chart>svg").get(0);$(p).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){E=$("#palette").width(),R=$("#palette").parent().position().top+$("#palette-container").position().top,RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),D&&(clearTimeout(D),D=null)},drag:function(e,t){t.position.left+=17.5,r.inputs>0&&r.outputs>0&&(y=t.position.left-E+t.helper.width()/2-T.left+x.scrollLeft(),w=t.position.top-R+t.helper.height()/2-T.top+x.scrollTop(),D||(D=setTimeout(function(){var e=[],n=1/0,o=null;if(_.getIntersectionList){var i=_.createSVGRect();i.x=y,i.y=w,i.width=1,i.height=1,e=_.getIntersectionList(i,_),y/=RED.view.scale(),w/=RED.view.scale()}else y/=RED.view.scale(),w/=RED.view.scale(),e=RED.view.getLinksAtPoint(y,w);for(var a=0;a<e.length;a++)if(d3.select(e[a]).classed("link_background"))for(var s=e[a].getTotalLength(),r=0;r<s;r+=10){var d=e[a].getPointAtLength(r),l=(d.x-y)*(d.x-y)+(d.y-w)*(d.y-w);l<200&&l<n&&(n=l,o=e[a])}m&&m!==o&&d3.select(m.parentNode).classed("link_splice",!1),o?d3.select(o.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),m!==o&&(o?$(t.helper).data("splice",d3.select(o).data()[0]):$(t.helper).removeData("splice")),m=o,D=null},200)))}});var k=null;0===i.indexOf("subflow:")&&($(p).dblclick(function(e){RED.workspaces.show(i.substring(8)),e.preventDefault()}),k=marked(r.info||"")),a(i,$(p),u,k),1===$("#palette-container-"+l).find(".palette_node").length&&n[l].open()}}function d(e){var t=s(e),n=$("#palette_node_"+t),o=n.closest(".palette-category");n.remove(),0===o.find(".palette_node").length&&o.find("i").hasClass("expanded")&&(o.find(".palette-content").slideToggle(),o.find("i").toggleClass("expanded"))}function l(e){var t=s(e),n=$("#palette_node_"+t);n.hide();for(var o=n.closest(".palette-category"),i=o.find(".palette_node"),a=0,r=0;r<i.length;r++)"none"===$(i[r]).css("display")&&(a+=1);a===i.length&&o.hide()}function c(e){var t=s(e),n=$("#palette_node_"+t);n.closest(".palette-category").show(),n.show()}return{init:function(){RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);r(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){d(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){c(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteadd&&"function"==typeof n.onpaletteadd&&n.onpaletteadd.call(n)}}),RED.events.on("registry:node-set-disabled",function(e){console.log(e);for(var t=0;t<e.types.length;t++){l(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){d(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){!function(e){var t=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(var o in $("#palette-container .palette_node").each(function(n,o){var i=$(o).find(".palette_label").text();""===e||t.test(o.id)||t.test(i)?$(this).show():$(this).hide()}),n)n.hasOwnProperty(o)&&(0===n[o].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?n[o].close():n[o].open())}($(this).val())}});var e=t;RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=t),e.forEach(function(e){i(e,e,"palette.label."+e)}),$("#palette-collapse-all").on("click",function(e){for(var t in e.preventDefault(),n)n.hasOwnProperty(t)&&n[t].close()}),$("#palette-expand-all").on("click",function(e){for(var t in e.preventDefault(),n)n.hasOwnProperty(t)&&n[t].open()})},add:r,remove:d,hide:l,show:c,refresh:function(){RED.nodes.eachSubflow(function(e){var t=$("#palette_node_subflow_"+e.id.replace(".","_")),i=t.find(".palette_port_input"),s=t.find(".palette_port_output");if(0===i.length&&e.in.length>0){var r=document.createElement("div");r.className="palette_port palette_port_input",t.append(r)}else 0!==i.length&&0===e.in.length&&i.remove();if(0===s.length&&e.out.length>0){var d=document.createElement("div");d.className="palette_port palette_port_output",t.append(d)}else 0!==s.length&&0===e.out.length&&s.remove();a(e.type+":"+e.id,t,e.name,marked(e.info||"")),function(e,t){var n=e.find(".palette_icon"),o=RED.utils.getNodeIcon(t._def,t);n.attr("style","background-image: url("+o+")")}(t,e);var l=t.data("category"),c=e.category||"subflows";if(l!==c){var p=c.replace(/ /g,"_");o(c,p,p,"node-red");var u=t.closest(".palette-category"),f=$("#palette-"+p);f.append(t),1===f.find(".palette_node").length&&n[p].open(),t.data("category",c),0===u.find(".palette_node").length&&u.find("i").hasClass("expanded")&&(u.find(".palette-content").slideToggle(),u.find("i").toggleClass("expanded"))}})},getCategories:function(){var e=[];return $("#palette-container .palette-category").each(function(t,n){e.push({id:$(n).data("category"),label:$(n).data("label")})}),e}}}(),RED.sidebar.info=function(){var e,t,n,o,i;marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var a={property:!1};function s(){RED.sidebar.show("info")}function r(e){if(void 0!==e){var i;t.show(),$(n.content).empty(),$(o.content).empty();var s,r,l=$('<table class="node-info"></table>').appendTo(n.content),p=$("<tbody>").appendTo(l),u=RED.projects.getActiveProject();if(u&&(i=$('<tr class="node-info-node-row"><td>Project</td><td></td></tr>').appendTo(p),$(i.children()[1]).text(u.name||""),$('<tr class="node-info-property-expand blank"><td colspan="2"></td></tr>').appendTo(p),$('<button class="editor-button editor-button-small" style="position:absolute;right:2px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(i.children()[1]).click(function(e){e.preventDefault(),RED.projects.editProject()})),o.container.show(),null!==e)if(Array.isArray(e))o.container.hide(),i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(p),$(i.children()[1]).text(RED._("sidebar.info.nodes",{count:e.length}));else{var f=/^subflow(:(.+))?$/.exec(e.type);if(f){s=f[2]?RED.nodes.subflow(f[2]):e,r=0;var h="subflow:"+s.id;RED.nodes.eachNode(function(e){e.type===h&&r++})}if("tab"===e.type||"subflow"===e.type){if(i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info."+("tab"===e.type?"flow":"subflow"))+"</td><td></td></tr>").appendTo(p),RED.utils.createObjectElement(e.id).appendTo(i.children()[1]),i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.tabName")+"</td><td></td></tr>").appendTo(p),$(i.children()[1]).text(e.label||e.name||""),"tab"===e.type)i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.status")+"</td><td></td></tr>").appendTo(p),$(i.children()[1]).text(e.disabled?RED._("sidebar.info.disabled"):RED._("sidebar.info.enabled"));else if("subflow"===e.type){i=$('<tr class="node-info-node-row"><td>'+RED._("subflow.category")+"</td><td></td></tr>").appendTo(p);var g=e.category||"subflows";$(i.children()[1]).text(RED._("palette.label."+g,{defaultValue:g}))}}else{var v;if(i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.node")+"</td><td></td></tr>").appendTo(p),RED.utils.createObjectElement(e.id).appendTo(i.children()[1]),"subflow"!==e.type&&"unknown"!==e.type&&e.name&&(i=$('<tr class="node-info-node-row"><td>'+RED._("common.label.name")+"</td><td></td></tr>").appendTo(p),$('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'"></span>').text(e.name).appendTo(i.children()[1])),f||(i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.type")+"</td><td></td></tr>").appendTo(p),$(i.children()[1]).text("unknown"===e.type?e._orig.type:e.type),"unknown"===e.type&&$('<span style="float: right; font-size: 0.8em"><i class="fa fa-warning"></i></span>').prependTo($(i.children()[1]))),!f&&"subflow"!=e.type&&"comment"!=e.type)if("unknown"===e.type?(v={},Object.keys(e._orig).forEach(function(e){"type"!==e&&(v[e]={})})):e._def&&(v=e._def.defaults),v){var b=0;for(var m in v)if("name"!=m&&v.hasOwnProperty(m)){var y=e[m];if(b++,i=$('<tr class="node-info-property-row'+(a.property?"":" hide")+'"><td>'+m+"</td><td></td></tr>").appendTo(p),v[m].type){var w=RED.nodes.node(y);if(w){var D=RED.utils.getNodeLabel(w,y),E=i.children()[1],R=$("<span>",{class:""}).appendTo(E),x=$("<div>",{class:"palette_node palette_node_small"}).appendTo(R),T=RED.utils.getNodeColor(w.type,w._def),_=RED.utils.getNodeIcon(w._def);x.css({backgroundColor:T,cursor:"pointer"});var k=$("<div/>",{class:"palette_icon_container"}).appendTo(x);$("<div/>",{class:"palette_icon",style:"background-image: url("+_+")"}).appendTo(k);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).text(D).appendTo(E);x.on("dblclick",function(){RED.editor.editConfig("",w.type,w.id)})}else RED.utils.createObjectElement(void 0).appendTo(i.children()[1])}else RED.utils.createObjectElement(y).appendTo(i.children()[1])}b>0&&$('<tr class="node-info-property-expand blank"><td colspan="2"><a href="#" class=" node-info-property-header'+(a.property?" expanded":"")+'"><span class="node-info-property-show-more">'+RED._("sidebar.info.showMore")+'</span><span class="node-info-property-show-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(p)}"tab"!==e.type&&f&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(p),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(s.name)+'">'+s.name+"</span></td></tr>").appendTo(p))}if(f){i=$('<tr class="node-info-node-row"><td>'+RED._("subflow.category")+"</td><td></td></tr>").appendTo(p);g=s.category||"subflows";$(i.children()[1]).text(RED._("palette.label."+g,{defaultValue:g})),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+r+"</td></tr>").appendTo(p)}var j="";if(s||"comment"===e.type||"tab"===e.type)"tab"===e.type&&(o.title.text(RED._("sidebar.info.flowDesc")),j=marked(e.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>");else o.title.text(RED._("sidebar.info.nodeHelp")),j=$("script[data-help-name='"+e.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>";if(s)j+=marked(s.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",o.title.text(RED._("sidebar.info.subflowDesc"));else if(e._def&&e._def.info){o.title.text(RED._("sidebar.info.nodeHelp"));var C=e._def.info,S="function"==typeof C?C.call(e):C;j+=marked(S)}j&&d(j),$(".sidebar-node-info-stack").scrollTop(0),$(".node-info-property-header").click(function(e){e.preventDefault(),a.property=!a.property,$(this).toggleClass("expanded",a.property),$(".node-info-property-row").toggle(a.property)})}}else c()}function d(e){var t,n=(t=$('<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>"),$(t).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),t).appendTo(o.content);n.find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");n.find("H3").wrapInner('<a class="node-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').click(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),n=$(this).parent().next();1===n.length&&"H3"!==n[0].nodeName;)n.toggle(!t),n=n.next();$(this).toggleClass("expanded",!t)})}var l=function(){var e,t,n=!0,o=1e3,a=15e3,s=-1;function r(){for(var n,o=Math.floor(Math.random()*s),r=RED._("infotips:info.tip"+o);n=/({{(.*?)}})/.exec(r);){var l=RED.keyboard.getShortcut(n[2]);if(!l)return;r=r.replace(n[1],RED.keyboard.formatKey(l.key))}for(;n=/(\[(.*?)\])/.exec(r);)r=r.replace(n[1],RED.keyboard.formatKey(n[2]));i.html(r).fadeIn(200),e&&(e=null,t=setInterval(d,a))}function d(){i.fadeOut(300,function(){r()})}function l(){if($(".sidebar-node-info").addClass("show-tips"),n&&!e&&!t){if(-1===s)do{s++}while(RED._("infotips:info.tip"+s)!=="infotips:info.tip"+s);e=setTimeout(r,o)}}function c(){$(".sidebar-node-info").removeClass("show-tips"),clearInterval(t),clearTimeout(e),t=null,e=null}return RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(n=e)?l():c()}),{start:l,stop:c,next:function(){clearInterval(t),e=!0,r()},enabled:function(){return n}}}();function c(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?r(RED.nodes.subflow(t.z)):r(t)}else r(e.nodes);else{var n=RED.workspaces.active(),o=RED.nodes.workspace(n)||RED.nodes.subflow(n);if(o)r(o);else{var i=RED.nodes.workspace(RED.workspaces.active());i&&i.info?r(i):r(null)}}}return RED.events.on("view:selection-changed",c),{init:function(){(e=document.createElement("div")).className="sidebar-node-info",RED.actions.add("core:show-info-tab",s);var a=$("<div>",{class:"sidebar-node-info-stack"}).appendTo(e);t=RED.stack.create({container:a}).hide(),(n=t.add({title:RED._("sidebar.info.info"),collapsible:!0})).expand(),(o=t.add({title:RED._("sidebar.info.nodeHelp"),collapsible:!0})).expand(),o.content.css("padding","6px"),o.container.css("border-bottom","none");var r=$('<div class="node-info-tips"></div>').appendTo(e);i=$('<div class="node-info-tip"></div>').appendTo(r);var d=$('<div class="node-info-tips-buttons"></div>').appendTo(r);$('<a href="#" class="workspace-footer-button"><i class="fa fa-refresh"></a>').appendTo(d).click(function(e){e.preventDefault(),l.next()}),$('<a href="#" class="workspace-footer-button"><i class="fa fa-times"></a>').appendTo(d).click(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),iconClass:"fa fa-info",content:e,pinned:!0,enableOnEdit:!0}),l.enabled()?l.start():l.stop()},show:s,refresh:r,clear:function(){r(null)},set:function(e,t){r(null),n.container.hide(),o.title.text(t||RED._("sidebar.info.info")),d(e),$(".sidebar-node-info-stack").scrollTop(0)}}}(),RED.sidebar.config=function(){var e=document.createElement("div");e.className="sidebar-node-config",$('<div class="button-group sidebar-header"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </div>').appendTo(e);var t=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),n=$("<div>").appendTo(e),o=$("<div>").appendTo(e),i=$("<div>").appendTo(e),a=!1,s={};function r(e,t,n){if(e=e.replace(/\./i,"-"),s[e])s[e].label!==n&&(s[e].list.parent().find(".config-node-label").text(n),s[e].label=n);else{var o=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+e+'"></div>').appendTo(t),i=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(o);n?$('<span class="config-node-label"/>').text(n).appendTo(i):$('<span class="config-node-label" data-i18n="sidebar.config.'+e+'">').appendTo(i),$('<span class="config-node-filter-info"></span>').appendTo(i),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(o),o.i18n();var a=i.find("i"),r={label:n,list:category,size:function(){return r.list.find("li:not(.config_node_none)").length},open:function(e){a.hasClass("expanded")||(a.addClass("expanded"),e?r.list.show():r.list.slideDown())},close:function(e){a.hasClass("expanded")&&(a.removeClass("expanded"),e?r.list.hide():r.list.slideUp())},isOpen:function(){return a.hasClass("expanded")}};i.on("click",function(e){r.isOpen()?r.close():r.open()}),s[e]=r}return s[e]}function d(e,t){var n=r(e.replace(/\./i,"-")),o=n.list;if(t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),a){var i=t.length;(i-=(t=t.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)>0?o.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:i})).show():o.parent().find(".config-node-filter-info").hide()}else o.parent().find(".config-node-filter-info").hide();if(o.empty(),0===t.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(o),n.close(!0);else{var s="";t.forEach(function(e){var t=RED.utils.getNodeLabel(e,e.id);e.type!=s&&($('<li class="config_node_type">'+e.type+"</li>").appendTo(o),s=e.type);var n=$('<li class="palette_node config_node palette_node_id_'+e.id.replace(/\./g,"-")+'"></li>').appendTo(o);if($('<div class="palette_label"></div>').text(t).appendTo(n),!1!==e._def.hasUsers){$("<div/>",{class:"palette_icon_container  palette_icon_container_right"}).text(e.users.length).appendTo(n);0===e.users.length&&n.addClass("config_node_unused")}n.on("click",function(t){RED.sidebar.info.refresh(e)}),n.on("dblclick",function(t){RED.editor.editConfig("",e.type,e.id)});var i=e.users.map(function(e){return e.id});n.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=i.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),n.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),n.open(!0)}}function l(){var e={global:!0};r("global",n),RED.nodes.eachWorkspace(function(t){e[t.id.replace(/\./g,"-")]=!0,r(t.id,o,t.label)}),RED.nodes.eachSubflow(function(t){e[t.id.replace(/\./g,"-")]=!0,r(t.id,i,t.name)}),$(".workspace-config-node-category").each(function(){var t=$(this).attr("id").substring("workspace-config-node-category-".length);e[t]||($(this).remove(),delete s[t])});var t=[],a={};for(var l in RED.nodes.eachConfig(function(e){e.z?(a[e.z.replace(/\./g,"-")]=a[e.z.replace(/\./g,"-")]||[],a[e.z.replace(/\./g,"-")].push(e)):e.z||t.push(e)}),e)e.hasOwnProperty(l)&&d(l,a[l]||[]);d("global",t)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:e,toolbar:t,iconClass:"fa fa-cog",onchange:function(){l()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),$("#workspace-config-node-collapse-all").on("click",function(e){for(var t in e.preventDefault(),s)s.hasOwnProperty(t)&&s[t].close()}),$("#workspace-config-node-expand-all").on("click",function(e){for(var t in e.preventDefault(),s)s.hasOwnProperty(t)&&s[t].size()>0&&s[t].open()}),$("#workspace-config-node-filter-all").on("click",function(e){e.preventDefault(),a&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),a=!a,l())}),$("#workspace-config-node-filter-unused").on("click",function(e){e.preventDefault(),a||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),a=!a,l())})},show:function(e){"boolean"==typeof e&&(e?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),l(),"string"==typeof e&&($("#workspace-config-node-filter-all").click(),e=e.replace(/\./g,"-"),setTimeout(function(){var t=$(".palette_node_id_"+e),n=t.position().top,o=t.height(),i=$(".sidebar-node-config"),a=i.height();n+o>a?i.animate({scrollTop:"-="+(a-(n+o)-30)},150):n<0&&i.animate({scrollTop:"+="+(n-10)},150);var s=21,r=function(){s%2==0?t.removeClass("node_highlighted"):t.addClass("node_highlighted"),--s>=0&&setTimeout(r,100)};r()},100)),RED.sidebar.show("config")},refresh:l}}(),RED.sidebar.context=function(){var e,t,n,o,i,a,s;function r(e,t){a=e,t?e?l(n,"context/node/"+e.id,e.id):l(n):($(n.table).empty(),e?$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(n.table).i18n():$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(n.table).i18n(),n.timestamp.html("&nbsp;"))}function d(e){s=e,e?l(o,"context/flow/"+e.id,e.id):l(o)}function l(e,t,n){var o=e.table;n?function(e,t,n){var o=RED.settings.context.stores,i=e.table;$.getJSON(t,function(a){$(i).empty();var s={};for(var r in a)if(a.hasOwnProperty(r))for(var d in a[r])a[r].hasOwnProperty(d)&&(s.hasOwnProperty(d)||(s[d]=[]),a[r][d].store=r,s[d].push(a[r][d]));var l=Object.keys(s);l.sort();for(var c=l.length,p=0;p<c;p++)s[l[p]].forEach(function(e){var a=l[p],r=(s[a].length,$('<tr class="node-info-node-row"><td class="sidebar-context-property"></td><td></td></tr>').appendTo(i)),d=$(r.children()[0]);d.text(a);var c=$('<span class="debug-message-tools button-group"></span>').appendTo(d),u=($('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(c).click(function(o){o.preventDefault(),o.stopPropagation(),$.getJSON(t+"/"+a+"?store="+e.store,function(e){$(r.children()[1]).empty();var t=e.msg,o=e.format;t=RED.utils.decodeObject(t,o),RED.utils.createObjectElement(t,{typeHint:e.format,sourceId:n+"."+a}).appendTo(r.children()[1])})}),e.msg),f=e.format;u=RED.utils.decodeObject(u,f),RED.utils.createObjectElement(u,{typeHint:e.format,sourceId:n+"."+a}).appendTo(r.children()[1]),o.length>1&&$("<span>",{class:"sidebar-context-property-storename"}).text(e.store).appendTo($(r.children()[0]))});0===c&&$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(i).i18n(),$(e.timestamp).text((new Date).toLocaleString())})}(e,t,n):($(o).empty(),$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(o).i18n())}function c(){RED.sidebar.show("context")}return{init:function(){(e=$("<div>").css({position:"relative",height:"100%"})).className="sidebar-context";var p=$("<div></div>"),u=$("<div>",{class:"sidebar-context-stack"}).appendTo(e);t=RED.stack.create({container:u}),(n=t.add({title:RED._("sidebar.context.node"),collapsible:!0})).expand(),n.content.css({height:"100%"}),n.timestamp=$('<div class="sidebar-context-updated">&nbsp;</div>').appendTo(n.content);var f=$('<table class="node-info"></table>').appendTo(n.content);n.table=$("<tbody>").appendTo(f);var h=$('<div style="float: right"></div>').appendTo(n.header);$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(h).click(function(e){e.stopPropagation(),e.preventDefault(),r(a,!0)}),(o=t.add({title:RED._("sidebar.context.flow"),collapsible:!0})).expand(),o.content.css({height:"100%"}),o.timestamp=$('<div class="sidebar-context-updated">&nbsp;</div>').appendTo(o.content),f=$('<table class="node-info"></table>').appendTo(o.content),o.table=$("<tbody>").appendTo(f),h=$('<div style="float: right"></div>').appendTo(o.header),$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(h).click(function(e){e.stopPropagation(),e.preventDefault(),d(s)}),(i=t.add({title:RED._("sidebar.context.global"),collapsible:!0})).expand(),i.content.css({height:"100%"}),i.timestamp=$('<div class="sidebar-context-updated">&nbsp;</div>').appendTo(i.content),f=$('<table class="node-info"></table>').appendTo(i.content),i.table=$("<tbody>").appendTo(f),h=$('<div style="float: right"></div>').appendTo(i.header),$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(h).click(function(e){e.stopPropagation(),e.preventDefault(),l(i,"context/global","global")}),RED.actions.add("core:show-context-tab",c),RED.sidebar.addTab({id:"context",label:RED._("sidebar.context.label"),name:RED._("sidebar.context.name"),iconClass:"fa fa-database",content:e,toolbar:p,enableOnEdit:!1}),RED.events.on("view:selection-changed",function(e){r(e.nodes&&1===e.nodes.length&&e.nodes[0])}),RED.events.on("workspace:change",function(e){d(RED.nodes.workspace(e.workspace))}),l(i,"context/global","global")}}}(),RED.palette.editor=function(){var e,t,n,o,i,a,s=[],r=[],d={},l={},c={},p={},u="";function f(e,t){var n=Date.now()-e;n=n<300?300:0,setTimeout(function(){t()},n)}function h(e,t,n,o){n.show();var i=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,a){f(i,function(){n.hide(),o()})}).fail(function(e,t,a){f(i,function(){n.hide(),o(e)})})}function g(e,t,n){var o={module:e};t&&(o.version=t),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(o),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){n()}).fail(function(e,t,o){n(e)})}function v(e){p.hasOwnProperty(e)||(p[e]=setTimeout(function(){delete p[e],m(e)},100))}function b(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var n=parseInt(t[1]),o=parseInt(t[2]),i=parseInt(t[3]);if((299*n+587*o+114*i)/1e3>160)return"rgb("+(n=Math.floor(.8*n))+","+(o=Math.floor(.8*o))+","+(i=Math.floor(.8*i))+")"}return e}function m(e){if(c.hasOwnProperty(e)){var t=c[e].info,n=c[e].elements;if(n){var i=0,a=0,s=0;for(var r in n.errorList.empty(),c[e].totalUseCount=0,c[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(r)){var p=0,u=t.sets[r],f=n.sets[r];u.err&&(s++,$("<li>").text(u.err).appendTo(n.errorList)),u.enabled&&(i+=u.types.length),a+=u.types.length;for(var h=0;h<t.sets[r].types.length;h++){var g=t.sets[r].types[h];p+=l[g]||0;var v=f.swatches[g];if(u.enabled){var m=RED.nodes.getType(g);m&&m.color?(v.css({background:RED.utils.getNodeColor(g,m)}),v.css({border:"1px solid "+b(v.css("backgroundColor"))})):v.css({background:"#eee",border:"1px dashed #999"})}else v.css({background:"#eee",border:"1px dashed #999"})}c[e].setUseCount[r]=p,c[e].totalUseCount+=p,p>0?(f.enableButton.text(RED._("palette.editor.inuse")),f.enableButton.addClass("disabled")):(f.enableButton.removeClass("disabled"),u.enabled?f.enableButton.text(RED._("palette.editor.disable")):f.enableButton.text(RED._("palette.editor.enable"))),f.setRow.toggleClass("palette-module-set-disabled",!u.enabled)}0===s?n.errorRow.hide():n.errorRow.show();var y=i===a?a:i+" / "+a;n.setCount.text(RED._("palette.editor.nodeCount",{count:a,label:y})),c[e].totalUseCount>0?(n.enableButton.text(RED._("palette.editor.inuse")),n.enableButton.addClass("disabled"),n.removeButton.hide()):(n.enableButton.removeClass("disabled"),t.local&&n.removeButton.css("display","inline-block"),0===i?n.enableButton.text(RED._("palette.editor.enableall")):n.enableButton.text(RED._("palette.editor.disableall")),n.container.toggleClass("disabled",0===i))}t.pending_version?(n.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(n.metaRow),n.updateButton.text(RED._("palette.editor.updated")).addClass("disabled").show()):d.hasOwnProperty(e)&&1===function(e,t){for(var n=e.split(".").map(function(e){return parseInt(e)}),o=t.split(".").map(function(e){return parseInt(e)}),i=0;i<3;i++){var a=n[i]-o[i];if(a<0)return-1;if(a>0)return 1}return 0}(d[e].version,t.version)?(n.updateButton.show(),n.updateButton.text(RED._("palette.editor.update",{version:d[e].version}))):n.updateButton.hide()}else{c[e]={info:RED.nodes.registry.getModule(e)};var w=[e];for(var D in c[e].info.sets)c[e].info.sets.hasOwnProperty(D)&&(w.push(D),w=w.concat(c[e].info.sets[D].types));c[e].index=w.join(",").toLowerCase(),o.editableList("addItem",c[e])}}var y,w,D=[],E=!1,R=k;function x(e,t,o,i){if(D.push(e||i),e?E=!0:(i.modules&&(i.modules.forEach(function(e){d[e.id]=e,e.index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),s=s.concat(i.modules)),n.searchBox("count",s.length)),a>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+D.length+"/"+a),D.length===a){E&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var r=250-(Date.now()-y);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(r,0))}}function T(){if(0===s.length){s=[],d={},i.editableList("empty"),$(".palette-module-shade-status").text(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];D=[],E=!1,a=e.length,e.length>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#palette-module-install-shade").show(),y=Date.now();var t=0;e.forEach(function(e,o){$.getJSON(e,{_:(new Date).getTime()},function(t){x(null,e,0,t),function(){for(var e in c)c.hasOwnProperty(e)&&m(e)}()}).fail(function(t,n,o){x(t,e)}).always(function(){++t===a&&n.searchBox("change")})})}}function _(){if(i.editableList("empty"),""!==n.searchBox("value").trim()){r.sort(R);for(var e=0;e<Math.min(10,r.length);e++)i.editableList("addItem",r[e]);0===r.length&&i.editableList("addItem",{}),r.length>10&&i.editableList("addItem",{start:10,more:r.length-10})}else i.editableList("addItem",{count:s.length})}function k(e,t){return e.info.id.localeCompare(t.info.id)}function j(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function C(){return T(),e.activateTab("nodes"),w}function S(e,t,n){if(!1!==RED.settings.theme("palette.editable")){var o=[{text:RED._("common.label.cancel"),click:function(){i.close()}}];e.url&&o.push({text:RED._("palette.editor.confirm.button.review"),class:"primary palette-module-install-confirm-button-install",click:function(){var t=e.url||"";window.open(t)}}),o.push({text:RED._("palette.editor.confirm.button.install"),class:"primary palette-module-install-confirm-button-install",click:function(){var o=RED.utils.addSpinnerOverlay(t,!0);g(e.id,e.version,function(t){o.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:e.id,message:t.responseJSON.message})),n(t)}),i.close()}});var i=RED.notify(RED._("palette.editor.confirm.install.body",{module:e.id}),{modal:!0,fixed:!0,buttons:o})}else n(new Error("Palette not editable"))}return{init:function(){!1!==RED.settings.theme("palette.editable")&&(function(){w=$('<div id="user-settings-tab-palette"></div>');var a=$('<div id="palette-editor"><ul id="palette-editor-tabs"></ul></div>').appendTo(w);e=RED.tabs.create({element:w.find("#palette-editor-tabs"),onchange:function(e){a.find(".palette-editor-tab").hide(),e.content.show(),t&&t.searchBox("value",""),n&&n.searchBox("value",""),"install"===e.id?n&&n.focus():t&&t.focus()},minimumActiveTabWidth:110});var l=$("<div>",{class:"palette-editor-tab"}).appendTo(a);e.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:l});var p=$("<div>",{class:"palette-search"}).appendTo(l);t=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(p).searchBox({delay:200,change:function(){!function(e){u=e.toLowerCase();var n=o.editableList("filter"),i=o.editableList("length");""===e?t.searchBox("count"):t.searchBox("count",n+" / "+i)}($(this).val())}}),o=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(l).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===u||""===u||e.index.indexOf(u)>-1},addItem:function(e,t,n){var o=n.info;if(o){var i=$("<div>",{class:"palette-module-header"}).appendTo(e),a=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(i);$("<span>").text(o.name).appendTo(a);var s=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(i),r=$("<span>").text(o.version).appendTo(s),l=$('<div class="palette-module-meta palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(i),c=$('<ul class="palette-module-error-list"></ul>').appendTo(l),p=$("<div>",{class:"palette-module-meta"}).appendTo(i),u=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(p),f=$("<span>").appendTo(u),b=$("<div>",{class:"palette-module-button-group"}).appendTo(p),m=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.update")).appendTo(b);m.attr("id","up_"+Math.floor(1e9*Math.random())),m.click(function(t){t.preventDefault(),$(this).hasClass("disabled")||function(e,t,n,o){if(!1!==RED.settings.theme("palette.editable"))var i=RED.notify(RED._("palette.editor.confirm.update.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary palette-module-install-confirm-button-update",click:function(){var a=RED.utils.addSpinnerOverlay(n,!0);g(e.name,t,function(t){a.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.updateFailed",{module:e.name,message:t.responseJSON.message})),o(t)}),i.close()}}]});else o(new Error("Palette not editable"))}(o,d[o.name].version,e,function(e){})});var y=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.remove")).appendTo(b);y.attr("id","up_"+Math.floor(1e9*Math.random())),y.click(function(t){t.preventDefault(),function(e,t,n){if(!1!==RED.settings.theme("palette.editable"))var o=RED.notify(RED._("palette.editor.confirm.remove.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary palette-module-install-confirm-button-remove",click:function(){var n,i,a=RED.utils.addSpinnerOverlay(t,!0);n=e.name,i=function(t){a.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.removeFailed",{module:e.name,message:t.responseJSON.message}))},$.ajax({url:"nodes/"+n,type:"DELETE"}).done(function(e,t,n){i()}).fail(function(e,t,n){i(e)}),o.close()}}]});else n(new Error("Palette not editable"))}(o,e,function(e){})}),o.local||y.hide();var w=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.disableall")).appendTo(b),D=$("<div>",{class:"palette-module-content"}).appendTo(e),E=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(e);n.elements={updateButton:m,removeButton:y,enableButton:w,errorRow:l,errorList:c,setCount:f,container:e,shade:E,versionSpan:r,sets:{}},u.click(function(t){t.preventDefault(),e.hasClass("expanded")?(e.removeClass("expanded"),D.slideUp()):(e.addClass("expanded"),D.slideDown())});var R=Object.keys(o.sets);R.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),R.forEach(function(e){var t=o.sets[e],i=$("<div>",{class:"palette-module-set"}).appendTo(D),a=$("<div>",{class:"palette-module-set-button-group"}).appendTo(i),s={};t.types.forEach(function(e){var t=$("<div>",{class:"palette-module-type"}).appendTo(i);s[e]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"palette-module-type-node"}).text(e).appendTo(t)});var r=$('<a href="#" class="editor-button editor-button-small"></a>').appendTo(a);r.click(function(o){if(o.preventDefault(),0===n.setUseCount[e]){var i=RED.nodes.registry.getNodeSet(t.id);E.show();var a=!i.enabled;h(t.id,a,E,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(a?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))})}}),n.elements.sets[t.name]={setRow:i,enableButton:r,swatches:s}}),w.click(function(t){t.preventDefault(),0===n.totalUseCount&&h(o.name,e.hasClass("disabled"),E,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))})}),v(o.name)}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}});var f=$("<div>",{class:"palette-editor-tab hide"}).appendTo(a);e.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:f});var b=$("<div>",{class:"palette-editor-toolbar"}).appendTo(f),m=$("<div>",{class:"palette-search"}).appendTo(f);n=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(m).searchBox({delay:300,change:function(){var e=$(this).val().trim().toLowerCase();e.length>0?(r=s.filter(function(t){return t.index.indexOf(e)>-1}).map(function(e){return{info:e}}),_(),n.searchBox("count",r.length+" / "+s.length)):(n.searchBox("count",s.length),i.editableList("empty"),i.editableList("addItem",{count:s.length}))}}),$("<span>").text(RED._("palette.editor.sort")+" ").appendTo(b);var y=$('<span class="button-group"></span>').appendTo(b),D=$('<a href="#" class="sidebar-header-button-toggle selected" data-i18n="palette.editor.sortAZ"></a>').appendTo(y),E=$('<a href="#" class="sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(y);D.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),E.removeClass("selected"),R=k,_())}),E.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),D.removeClass("selected"),R=j,_())});var x=$("<span>").appendTo(b);$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(x).click(function(e){e.preventDefault(),s=[],d={},T()}),i=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(f).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){if(n.count)$("<div>",{class:"red-ui-search-empty"}).text(RED._("palette.editor.moduleCount",{count:n.count})).appendTo(e);else if(n.more){e.addClass("palette-module-more");var o=$("<div>",{class:"palette-module-header palette-module"}).appendTo(e),a=$('<a href="#"></a>').text(RED._("palette.editor.more",{count:n.more})).appendTo(o);a.click(function(e){e.preventDefault(),i.editableList("removeItem",n);for(var t=n.start;t<Math.min(n.start+10,n.start+n.more);t++)i.editableList("addItem",r[t]);n.more>10&&i.editableList("addItem",{start:n.start+10,more:n.more-10})})}else if(n.info){var s=n.info,d=$("<div>",{class:"palette-module-header"}).appendTo(e),l=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(d);$("<span>",{class:"palette-module-name"}).text(s.name||s.id).appendTo(l),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",s.url).appendTo(l);var p=$('<div class="palette-module-meta"></div>').appendTo(d);$("<div>",{class:"palette-module-description"}).text(s.description).appendTo(p);var u=$('<div class="palette-module-meta"></div>').appendTo(d);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+s.version+"</span>").appendTo(u),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var n=Math.floor(t/7);if(n<4)return RED._("palette.editor.times.weeksV",{count:n});var o=Math.floor(n/4);if(n%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var i=Math.floor(o/12);return 0==(o%=12)?RED._("palette.editor.times.yearsV",{count:i}):RED._("palette.editor.times.year"+(i>1?"s":"")+"MonthsV",{y:i,count:o})}(s.updated_at)+"</span>").appendTo(u);var f=$("<div>",{class:"palette-module-meta"}).appendTo(d),h=$("<div>",{class:"palette-module-button-group"}).appendTo(f),g=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.install")).appendTo(h);g.click(function(t){t.preventDefault(),$(this).hasClass("disabled")||S(s,e,function(e){})}),c.hasOwnProperty(s.id)&&(g.addClass("disabled"),g.text(RED._("palette.editor.installed"))),n.elements={installButton:g}}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(f)}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:C,close:function(){w.detach()},focus:function(){e.resize(),setTimeout(function(){t.focus()},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){v(e.module)}),RED.events.on("registry:node-set-enabled",function(e){v(e.module)}),RED.events.on("registry:node-set-disabled",function(e){v(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){v(e.module);for(var t=0;t<r.length;t++)if(r[t].info.id===e.module){var n=r[t].elements.installButton;n.addClass("disabled"),n.text(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=c[e.module];if(t){o.editableList("removeItem",t),delete c[e.module];for(var n=0;n<r.length;n++)if(r[n].info.id===e.module){var i=r[n].elements.installButton;i.removeClass("disabled"),i.text(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(l[e.type]=(l[e.type]||0)+1,1===l[e.type]&&v(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){l.hasOwnProperty(e.type)&&(l[e.type]--,0===l[e.type]&&(delete l[e.type],v(RED.nodes.registry.getNodeSetForType(e.type).module)))}))},install:S}}(),RED.editor=function(){var e=[],t={};function n(e){var t,i,a,s=e.valid,r=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))i=(t=RED.nodes.subflow(e.type.substring(8))).valid,a=t.changed,void 0===i&&(i=n(t),a=t.changed),e.valid=i&&o(e,e._def.defaults,e),e.changed=e.changed||a;else if(e._def)e.valid=o(e,e._def.defaults,e),e._def._creds&&(e.valid=e.valid&&o(e,e._def.credentials,e._def._creds));else if("subflow"==e.type){for(var d=RED.nodes.filterNodes({z:e.id}),l=0;l<d.length;l++)i=d[l].valid,a=d[l].changed,void 0===i&&(i=n(d[l]),a=d[l].changed),e.valid=e.valid&&i,e.changed=e.changed||a;var c=RED.nodes.filterNodes({type:"subflow:"+e.id}),p={};for(l=0;l<c.length;l++)c[l].valid=e.valid,c[l].changed=c[l].changed||e.changed,c[l].dirty=!0,p[c[l].z]=!0;Object.keys(p).forEach(function(e){var t=RED.nodes.subflow(e);t&&n(t)})}return s===e.valid&&r===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&n(t)),e.valid}function o(e,t,n){var o=!0;for(var a in t)t.hasOwnProperty(a)&&(i(e,t,a,n[a])||(o=!1));return o}function i(e,t,n,o){var i=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if("required"in t[n]&&t[n].required&&(i=""!==o),i&&"validate"in t[n])try{i=t[n].validate.call(e,o)}catch(t){console.log("Validation error:",e.type,e.id,"property: "+n,"value:",o,t)}if(i&&t[n].type&&RED.nodes.getType(t[n].type)&&!("validate"in t[n]))if(o&&"_ADD_"!=o){var a=RED.nodes.node(o);i=null!==a&&(null==a.valid||a.valid)}else i=t[n].hasOwnProperty("required")&&!t[n].required;return i}function a(e,t){for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&s(e,e._def.defaults,n,t);if(e._def.credentials)for(n in e._def.credentials)e._def.credentials.hasOwnProperty(n)&&s(e,e._def.credentials,n,t)}function s(e,t,n,o){var a=$("#"+o+"-"+n);if(a.length>0){var s=a.val();t[n].hasOwnProperty("format")&&""!==t[n].format&&"DIV"===a[0].nodeName&&(s=a.text()),i(e,t,n,s)?a.removeClass("input-error"):a.addClass("input-error")}}function r(e,t){e.resize=!0,e.dirty=!0;var n=[];if(e.ports)if(t&&RED.nodes.eachLink(function(o){o.source===e&&t.hasOwnProperty(o.sourcePort)&&("-1"===t[o.sourcePort]?n.push(o):o.sourcePort=t[o.sourcePort])}),e.outputs<e.ports.length){for(;e.outputs<e.ports.length;)e.ports.pop();RED.nodes.eachLink(function(t){t.source===e&&t.sourcePort>=e.outputs&&-1===n.indexOf(t)&&n.push(t)})}else if(e.outputs>e.ports.length)for(;e.outputs>e.ports.length;)e.ports.push(e.ports.length);0===e.inputs&&n.concat(RED.nodes.filterLinks({target:e}));for(var o=0;o<n.length;o++)RED.nodes.removeLink(n[o]);return n}function d(e,t,n,o){var i=$("#"+o+"-"+t);if(0!==i.length){var a,s=i.width(),r=i.attr("style");s=null!==(a=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(r))?a[1]:"70%";var d=$("<div></div>").css({display:"inline-block",position:"relative"}),l=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(d),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(l);d.width(s).height(i.height()),0===d.width()&&d.width("70%"),i.replaceWith(d),c.attr("style","width:100%"),E(t,n,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(d),$("#"+o+"-lookup-"+t).click(function(e){w(t,n,c.find(":selected").val(),o),e.preventDefault()});var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(n);u&&(p=RED.utils.getNodeLabel(u,u.id)),i.val(p)}}function l(e,t,n,o){var i=$("#"+o+"-"+t);i.val(e[t]),i.attr("type","hidden");var a=$("<a>",{id:o+"-edit-"+t,class:"editor-button"});i.after(a),e[t]?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),a.click(function(e){w(t,n,i.val()||"_ADD_",o),e.preventDefault()})}function c(e,t,n,o){var i=$("#"+n+"-"+t);if(0!==i.length)if("checkbox"===i.attr("type"))i.prop("checked",e[t]);else{var a=e[t];null==a&&(a=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===i[0].nodeName?(i.html(RED.text.format.getHtml(a,o[t].format,{},!1,"en")),RED.text.format.attach(i[0],o[t].format,{},!1,"en")):(i.val(a),"INPUT"!==i[0].nodeName&&"TEXTAREA"!==i[0].nodeName||RED.text.bidi.prepareInput(i))}}function p(e,t,n,o){var i=$("#"+o+"-"+n);void 0!==t&&"format"in t[n]&&""!==t[n].format&&"DIV"===i[0].nodeName?$("#"+o+"-"+n).on("change keyup",function(t,n){n||a(e,o)}):$("#"+o+"-"+n).change(function(t,n){n||a(e,o)})}function u(e,t,n,o){var i;for(i in t)t.hasOwnProperty(i)&&("password"==t[i].type?n[i]?$("#"+o+"-"+i).val(n[i]):n["has_"+i]?$("#"+o+"-"+i).val("__PWRD__"):$("#"+o+"-"+i).val(""):c(n,i,o,t),p(e,t,i,o))}function f(e,t,n){var o=!1;for(var i in e.credentials||(e.credentials={_:{}}),t)if(t.hasOwnProperty(i)){var a=$("#"+n+"-"+i).val();if("password"==t[i].type){if(e.credentials["has_"+i]=""!==a,"__PWRD__"==a)continue;o=!0}e.credentials[i]=a,a!=e.credentials._[i]&&(o=!0)}return o}function h(e,t,n,o){for(var i in t.defaults)if(t.defaults.hasOwnProperty(i)){if(t.defaults[i].type){var s=RED.nodes.getType(t.defaults[i].type);s?s.exclusive?l(e,i,t.defaults[i].type,n):d(e,i,t.defaults[i].type,n):(console.log("Unknown type:",t.defaults[i].type),c(e,i,n,t.defaults))}else c(e,i,n,t.defaults);p(e,t.defaults,i,n)}var r,f,h=function(){if(t.oneditprepare)try{t.oneditprepare.call(e)}catch(t){console.log("oneditprepare",e.id,e.type,t.toString())}for(var i in t.defaults)t.defaults.hasOwnProperty(i)&&$("#"+n+"-"+i).trigger("change",[!0]);if(t.credentials)for(i in t.credentials)t.credentials.hasOwnProperty(i)&&$("#"+n+"-"+i).trigger("change",[!0]);a(e,n),o&&o()};t.credentials?e.credentials?(u(e,t.credentials,e.credentials,n),h()):$.getJSON((r=e.type,f=e.id,"credentials/"+r.replace(/\s+/g,"-")+"/"+f),function(o){e.credentials=o,e.credentials._=$.extend(!0,{},o),u(e,t.credentials,e.credentials,n),h()}):h()}function g(){for(var t,n=e.length-1;n<e.length;n++){var o=e[n];if(t=o.type,"_expression"===o.type)t=RED._("expressionEditor.title");else if("_js"===o.type)t=RED._("jsEditor.title");else if("_json"===o.type)t=RED._("jsonEditor.title");else if("_markdown"===o.type)t=RED._("markdownEditor.title");else if("_buffer"===o.type)t=RED._("bufferEditor.title");else if("subflow"===o.type)t=RED._("subflow.editSubflow",{name:o.name});else if(0===o.type.indexOf("subflow:")){var i=RED.nodes.subflow(o.type.substring(8));t=RED._("subflow.editSubflow",{name:i.name})}else{if(void 0!==o._def.paletteLabel)try{t=("function"==typeof o._def.paletteLabel?o._def.paletteLabel.call(o._def):o._def.paletteLabel)||""}catch(e){console.log("Definition error: "+o.type+".paletteLabel",e)}n===e.length-1&&(t=RED.nodes.node(o.id)?RED._("editor.editNode",{type:t}):RED._("editor.addNewConfig",{type:t}))}"<li>"+t+"</li>"}return"</ul>",t}function v(e,t,n,o){var i=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return i.html($("script[data-template-name='"+n+"']").html()),o=o||"node-red",i.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var n=e[t];if(-1===n.indexOf(":")){var i="";if(0===n.indexOf("[")){var a=n.split("]");i=a[0]+"]",n=a[1]}e[t]=i+o+":"+n}}$(this).attr("data-i18n",e.join(";"))}),$('<input type="password" style="display: none;" />').prependTo(i),$('<input type="text" style="display: none;" />').prependTo(i),i.submit(function(e){e.preventDefault()}),i}function b(e,t,n,o){var i=$("<div>",{class:"node-label-form-row"});if(void 0===e)$("<span>").text(RED._("editor.noDefaultLabel")).appendTo(i),i.addClass("node-label-form-none");else{i.addClass("");var a="node-label-form-"+e+"-"+t;$("<label>",{for:a}).text(t+1+".").appendTo(i);var s=$("<input>",{type:"text",id:a,placeholder:o}).val(n).appendTo(i);$('<button class="editor-button editor-button-small"><i class="fa fa-times"></i></button>').appendTo(i).click(function(e){e.preventDefault(),s.val("")})}return i}function m(e,t){var n=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),o=t.inputs||t._def.inputs||0,i=t.outputs||t._def.outputs||0;"subflow"===t.type&&(o=t.in.length,i=t.out.length);var a,s=t.inputLabels||[],r=t.outputLabels||[],d=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),l=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span data-i18n="editor.labelInputs"></span><div id="node-label-form-inputs"></div></div>').appendTo(n);var c=$("#node-label-form-inputs");if(o>0)for(a=0;a<o;a++)b("input",a,s[a],d).appendTo(c);else b().appendTo(c);$('<div class="form-row"><span data-i18n="editor.labelOutputs"></span><div id="node-label-form-outputs"></div></div>').appendTo(n);var p=$("#node-label-form-outputs");if(i>0)for(a=0;a<i;a++)b("output",a,r[a],l).appendTo(p);else b().appendTo(p);if(!t._def.defaults||!t._def.defaults.hasOwnProperty("icon")){$("<hr>").appendTo(n);var u=$('<div class="form-row"></div>').appendTo(n);$('<label style="width: 50px" data-i18n="editor.settingIcon">').appendTo(u);var f=$('<button class="editor-button">').appendTo(u),h=$("<div>",{class:"red-ui-search-result-node"}).appendTo(f),g=RED.utils.getNodeColor(t.type,t._def),v=RED.utils.getNodeIcon(t._def,t);h.css("backgroundColor",g);var m=$("<div/>",{class:"palette_icon_container"}).appendTo(h),y=$("<div/>",{class:"palette_icon",style:"background-image: url("+v+")"}).appendTo(m);f.click(function(e){var n;e.preventDefault();var o=$("#node-settings-icon").text()||"";n=o?RED.utils.separateIconPath(o):RED.utils.getDefaultNodeIcon(t._def,t),function(e,t,n,o){var i=e.offset(),a=$("<div>").css({position:"absolute",top:0,bottom:0,left:0,right:0,zIndex:20}).appendTo("body"),s=i.top-30;s+280>$(window).height()&&(s=$(window).height()-280);var r=$('<div class="red-ui-icon-picker">').css({top:s+"px",left:i.left+"px"}).appendTo("body"),d=function(){a.remove(),r.remove(),RED.keyboard.remove("escape")};RED.keyboard.add("*","escape",function(){d()}),a.on("mousedown",d);var l=$("<div>",{class:"red-ui-search-container"}).appendTo(r);searchInput=$('<input type="text">').attr("placeholder",RED._("editor.searchIcons")).appendTo(l).searchBox({delay:50,change:function(){var e=$(this).val().trim();""===e?(c.find(".red-ui-icon-list-module").show(),c.find(".red-ui-icon-list-icon").show()):(c.find(".red-ui-icon-list-module").hide(),c.find(".red-ui-icon-list-icon").each(function(t,n){-1===$(n).data("icon").indexOf(e)?$(n).hide():$(n).show()}))}}),$("<div>").appendTo(r);var c=$('<div class="red-ui-icon-list">').appendTo(r),p=$('<div class="red-ui-icon-meta"></div>').appendTo(r),u=$("<span>").appendTo(p),f=($('<button class="editor-button editor-button-small">'+RED._("editor.useDefault")+"</button>").appendTo(p).click(function(e){e.preventDefault(),d(),o(null)}),RED.nodes.getIconSets());Object.keys(f).forEach(function(e){var i=f[e];if(i.length>0){var a=$('<div class="red-ui-icon-list-module"></div>').text(e).appendTo(c);$('<i class="fa fa-cube"></i>').prependTo(a),i.forEach(function(i){var a=$("<div>",{class:"red-ui-icon-list-icon"}).appendTo(c),s=$("<div>",{class:"red-ui-search-result-node"}).appendTo(a),r=RED.utils.getNodeColor(t.type,t._def),l="icons/"+e+"/"+i;a.data("icon",l),s.css("backgroundColor",r);var p=$("<div/>",{class:"palette_icon_container"}).appendTo(s);$("<div/>",{class:"palette_icon",style:"background-image: url("+l+")"}).appendTo(p),n.module===e&&n.file===i&&a.addClass("selected"),a.on("mouseover",function(){u.text(i)}),a.on("mouseout",function(){u.html("&nbsp;")}),a.click(function(){d(),o(e+"/"+i)})})}}),r.slideDown(100),searchInput.focus()}(u,t,n,function(e){$("#node-settings-icon").text(e||"");var n=RED.utils.getNodeIcon(t._def,{type:t.type,icon:e});y.css("backgroundImage","url("+n+")")})}),$('<div class="uneditable-input" id="node-settings-icon">').text(t.icon).appendTo(u)}}function y(e,t,n){var o=$("#node-label-form-inputs").children().find("input"),i=$("#node-label-form-outputs").children().find("input"),a=!1,s=!1,r=o.map(function(){var e=$(this).val();return a=a||""!==e,e}).toArray().slice(0,e.inputs);return(void 0===e.inputLabels&&a||void 0!==e.inputLabels&&JSON.stringify(r)!==JSON.stringify(e.inputLabels))&&(t.inputLabels=e.inputLabels,e.inputLabels=r,s=!0),a=!1,r=new Array(e.outputs),i.each(function(){var e=$(this).attr("id").substring(23);if(!n||!n.hasOwnProperty(e)||-1!==(e=parseInt(n[e]))){var t=$(this).val();a=a||""!==t,r[e]=t}}),(void 0===e.outputLabels&&a||void 0!==e.outputLabels&&JSON.stringify(r)!==JSON.stringify(e.outputLabels))&&(t.outputLabels=e.outputLabels,e.outputLabels=r,s=!0),s}function w(t,o,i,a){var s,r="_ADD_"==i,d=RED.nodes.getType(o),l=RED.nodes.node(i);s="node-red"===d.set.module?"node-red":d.set.id;var c="",p=RED.nodes.subflow(RED.workspaces.active());if(p&&(c=p.id),null==l){for(var u in l={id:RED.nodes.id(),_def:d,type:o,z:c,users:[]},d.defaults)d.defaults[u].value&&(l[u]=JSON.parse(JSON.stringify(d.defaults[u].value)));l._=d._}e.push(l),RED.view.state(RED.state.EDITING);var b={title:g(),resize:function(){if(l&&l._def.oneditresize){var e=$("#node-config-dialog-edit-form");try{l._def.oneditresize.call(l,{width:e.width(),height:e.height()})}catch(e){console.log("oneditresize",l.id,l.type,e.toString())}}},open:function(e,t){e.find(".editor-tray-header");var n=e.find(".editor-tray-footer");!1!==d.hasUsers&&n.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),n.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var i=v(e.find(".editor-tray-body"),"node-config-dialog-edit-form",o,s);h(l,d,"node-config-input",function(){l._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var e={};l.users.forEach(function(t){e[t.z]=!0});var n=Object.keys(e).length,o=$("#node-config-dialog-scope").empty();o.off("change"),o.append('<option value=""'+(l.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),o.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(t){var n=t.label;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==l.z?" selected":"")+">"+n+"</option>")}),o.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(t){var n=t.name;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==l.z?" selected":"")+">"+n+"</option>")}),n>0&&o.on("change",function(){var t=$(this).val();""===t?$("#node-config-dialog-scope-warning").hide():!e[t]||n>1?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),o.i18n(),i.i18n(),!1!==d.hasUsers&&$("#node-config-dialog-user-count").find("span").text(RED._("editor.nodesUse",{count:l.users.length})).parent().show(),t()})},close:function(){RED.workspaces.refresh(),e.pop()},show:function(){l&&RED.sidebar.info.refresh(l)}};b.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var e=o,t=l.id,n=RED.nodes.getType(e);if(n.oneditcancel&&n.oneditcancel){var i=RED.nodes.node(t);if(i)try{n.oneditcancel.call(i,!1)}catch(e){console.log("oneditcancel",i.id,i.type,e.toString())}else try{n.oneditcancel.call({id:t},!0)}catch(n){console.log("oneditcancel",t,e,n.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:r?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,i,s=t,d=(l.id,o),c=r,p=RED.nodes.getType(d),u=$("#node-config-dialog-scope").val();if(p.oneditsave)try{p.oneditsave.call(l)}catch(e){console.log("oneditsave",l.id,l.type,e.toString())}for(e in p.defaults){var h;if(p.defaults.hasOwnProperty(e))if(null!=(h="checkbox"===(i=$("#node-config-input-"+e)).attr("type")?i.prop("checked"):"format"in p.defaults[e]&&""!==p.defaults[e].format&&"DIV"===i[0].nodeName?i.text():i.val())&&h!==l[e]){if(l._def.defaults[e].type){"_ADD_"==h&&(h="");var g=RED.nodes.node(l[e]);if(g){var v=g.users;v.splice(v.indexOf(l),1)}(g=RED.nodes.node(h))&&g.users.push(l)}l[e]=h}}l.label=p.label,l.z=u,u&&(l.users=l.users.filter(function(e){var t=!0;for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&e._def.defaults[o].type===l.type&&e[o]===l.id&&e.z!==u&&(t=!1,e[o]=null,e.dirty=!0,e.changed=!0,n(e));return t})),c&&RED.nodes.add(l),p.credentials&&f(l,p.credentials,"node-config-input"),n(l);var b={};b[l.id]=!0;for(var m=l.users.slice();m.length>0;){var y=m.pop();b[y.id]||(b[y.id]=!0,y.users&&(m=m.concat(y.users)),n(y))}RED.nodes.dirty(!0),RED.view.redraw(!0),c||RED.events.emit("editor:save",l),RED.tray.close(function(){E(s,d,l.id,a)})}}],r||b.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=t,i=l.id,s=o,r=RED.nodes.getType(s);try{r.ondelete&&(console.log("Deprecated API warning: config node type ",s," has an ondelete function - should be oneditdelete"),r.ondelete.call(l)),r.oneditdelete&&r.oneditdelete.call(l)}catch(e){console.log("oneditdelete",l.id,l.type,e.toString())}for(var d={t:"delete",nodes:[l],changes:{},dirty:RED.nodes.dirty()},c=0;c<l.users.length;c++){var p=l.users[c];for(var u in d.changes[p.id]={changed:p.changed,valid:p.valid},p._def.defaults)p._def.defaults.hasOwnProperty(u)&&p[u]==i&&(d.changes[p.id][u]=i,p[u]="",p.changed=!0,p.dirty=!0);n(p)}RED.nodes.remove(i),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(d),RED.tray.close(function(){E(e,s,"",a)})}}),RED.tray.show(b)}function D(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function E(e,t,n,o){if(o){var i=$("#"+o+"-edit-"+e);if(i.length)n?i.text(RED._("editor.configEdit")):i.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(n);else{var a=$("#"+o+"-"+e),s=RED.nodes.getType(t);a.children().remove();var r=RED.nodes.workspace(RED.workspaces.active());r||(r=RED.nodes.subflow(RED.workspaces.active()));var d=[];RED.nodes.eachConfig(function(e){if(e.type==t&&(!e.z||e.z===r.id)){var n=RED.utils.getNodeLabel(e,e.id);e.__label__=n,d.push(e)}});var l=D;"function"==typeof s.sort&&(l=s.sort);try{d.sort(l)}catch(e){console.log("Definition error: "+s.type+".sort",e)}d.forEach(function(e){a.append('<option value="'+e.id+'"'+(n==e.id?" selected":"")+">"+RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)+"</option>"),delete e.__label__}),a.append('<option value="_ADD_"'+(""===n?" selected":"")+">"+RED._("editor.addNewType",{type:t})+"</option>"),window.setTimeout(function(){a.change()},50)}}}function R(t,n){RED.editor.types.hasOwnProperty(t)?(e.length>0&&(n.parent=e[e.length-1].id),e.push({type:t}),n.title=n.title||g(),n.onclose=function(){e.pop()},RED.editor.types[t].show(n)):console.log("Unknown type editor:",t)}return{init:function(){for(var e in RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$("#node-dialog-ok").click(),$("#node-config-dialog-ok").click()}),RED.actions.add("core:cancel-edit-tray",function(){$("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()}),RED.editor.types)RED.editor.types.hasOwnProperty(e)&&RED.editor.types[e].init()},types:{},edit:function(o){var i,a,s=o;e.push(o),RED.view.state(RED.state.EDITING);var d=o.type;"subflow:"==o.type.substring(0,8)&&(d="subflow");var l={title:g(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],n=[],o=RED.nodes.remove(s.id);t.push(s);var i={t:"delete",nodes:t=t.concat(o.nodes),links:n=n.concat(o.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(i),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(s._def){if(s._def.oneditcancel)try{s._def.oneditcancel.call(s)}catch(e){console.log("oneditcancel",s.id,s.type,e.toString())}for(var e in s._def.defaults)if(s._def.defaults.hasOwnProperty(e)){var t=s._def.defaults[e];if(t.type){var n=RED.nodes.getType(t.type);if(n&&n.exclusive){var o=$("#node-input-"+e).val()||"";""===o||s[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t,o,d={},l=!1,c=RED.nodes.dirty();if(s._def.oneditsave){var p={};for(e in s._def.defaults)s._def.defaults.hasOwnProperty(e)&&("string"==typeof s[e]||"number"==typeof s[e]?p[e]=s[e]:p[e]=$.extend(!0,{},{v:s[e]}).v);try{!0===s._def.oneditsave.call(s)&&(l=!0)}catch(e){console.log("oneditsave",s.id,s.type,e.toString())}for(e in s._def.defaults)s._def.defaults.hasOwnProperty(e)&&(null===p[e]||"string"==typeof p[e]||"number"==typeof p[e]?p[e]!==s[e]&&(d[e]=p[e],l=!0):JSON.stringify(p[e])!==JSON.stringify(s[e])&&(d[e]=p[e],l=!0))}if(s._def.defaults)for(e in s._def.defaults)if(s._def.defaults.hasOwnProperty(e)){var u=$("#node-input-"+e);if(null!=(o="checkbox"===u.attr("type")?u.prop("checked"):"format"in s._def.defaults[e]&&""!==s._def.defaults[e].format&&"DIV"===u[0].nodeName?u.text():u.val())){if("outputs"===e){if(""===o.trim())continue;if(isNaN(o)){t=JSON.parse(o);var h=0,g=!1;Object.keys(t).forEach(function(e){isNaN(e)?(h++,delete t[e]):(t[e]=t[e]+"","-1"!==t[e]?(h++,t[e]!==e?g=!0:delete t[e]):g=!0)}),o=h,g&&(l=!0)}else o=parseInt(o)}if(s[e]!=o){if(s._def.defaults[e].type){"_ADD_"==o&&(o="");var v=RED.nodes.node(s[e]);if(v){var b=v.users;b.splice(b.indexOf(s),1)}(v=RED.nodes.node(o))&&v.users.push(s)}d[e]=s[e],s[e]=o,l=!0}}}if(s._def.credentials){var m=s._def.credentials,w=f(s,m,"node-input");l=l||w}var D=r(s,t);if(y(s,d,t)&&(l=!0),!s._def.defaults||!s._def.defaults.hasOwnProperty("icon")){var E=$("#node-settings-icon").text()||"";if(i)if(E!==a)d.icon=s.icon,s.icon=E,l=!0;else{var R=RED.utils.getDefaultNodeIcon(s._def,s),x=R.module+"/"+R.file;a!==x&&(d.icon=s.icon,s.icon=x,l=!0)}else E!==s.icon&&(d.icon=s.icon,s.icon=E,l=!0)}if(l){var T=s.changed;s.changed=!0,RED.nodes.dirty(!0);var _=RED.nodes.subflow(RED.workspaces.active()),k=null;_&&(k=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(k.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e))}));var j={t:"edit",node:s,changes:d,links:D,dirty:c,changed:T};t&&(j.outputMap=t),k&&(j.subflow={instances:k}),RED.history.push(j)}s.dirty=!0,n(s),RED.events.emit("editor:save",s),RED.tray.close()}}],resize:function(e){t[d]=e.width,$(".editor-tray-content").height(e.height-78);var n=$(".editor-tray-content form").height(e.height-78-40);if(s&&s._def.oneditresize)try{s._def.oneditresize.call(s,{width:n.width(),height:n.height()})}catch(e){console.log("oneditresize",s.id,s.type,e.toString())}},open:function(e,t){e.find(".editor-tray-footer");var n=e.find(".editor-tray-body");n.parent().css("overflow","hidden");var r=RED.stack.create({container:n,singleExpanded:!0}),l=r.add({title:RED._("editor.nodeProperties"),expanded:!0});l.content.addClass("editor-tray-content");var c,p=r.add({title:RED._("editor.portLabels"),onexpand:function(){!function(e,t){var n,o,i=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),a=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),s=$("#node-label-form-inputs"),r=$("#node-label-form-outputs"),d=t.inputs||t._def.inputs||0,l=s.children(),c=l.length;if(1===c&&$(l[0]).hasClass("node-label-form-none")&&c--,c<d)for(0===c&&$(l[0]).remove(),o=c;o<d;o++)b("input",o,"",i).appendTo(s);else if(c>d){for(o=d;o<c;o++)$(l[o]).remove();0===n&&b().appendTo(s)}var p=$("#node-input-outputs").val();if(void 0===p)n=t.outputs||t._def.outputs||0;else if(isNaN(p)){var u=JSON.parse(p),f=Object.keys(u);l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,n=0;var h=[];f.forEach(function(e){var t=$("#node-label-form-output-"+e).parent();0===t.length&&-1!==u[e]?(0===c&&($(l[0]).remove(),c=-1),t=b("output",e,"",a)):t.detach(),-1!==u[e]&&(n++,h.push({i:parseInt(u[e]),r:t}))}),h.sort(function(e,t){return e.i-t.i}),h.forEach(function(e,t){e.r.find("label").text(t+1+"."),e.r.appendTo(r)}),0===h.length&&b("output",o,"").appendTo(r)}else n=Math.max(0,parseInt(p));if(l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,c<n)for(0===c&&$(l[0]).remove(),o=c;o<n;o++)b("output",o,"").appendTo(r);else if(c>n){for(o=n;o<c;o++)$(l[o]).remove();0===n&&b().appendTo(r)}}(this.content,o)}});p.content.addClass("editor-tray-content"),s&&RED.sidebar.info.refresh(s),c="node-red"===o._def.set.module?"node-red":o._def.set.id;var u=RED.utils.getDefaultNodeIcon(o._def,o);a=u.module+"/"+u.file,i=!o.icon||o.icon===a,v(l.content,"dialog-form",d,c),m(p.content,o),h(o,o._def,"node-input",function(){n.i18n(),t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),s&&RED.sidebar.info.refresh(s),RED.workspaces.refresh(),RED.view.redraw(!0),e.pop()},show:function(){s&&RED.sidebar.info.refresh(s)}};if(t.hasOwnProperty(d)&&(l.width=t[d]),"subflow"===d){var c=s.type.substring(8);l.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(c),$("#node-dialog-ok").click()}})}RED.tray.show(l)},editConfig:w,editSubflow:function(t){var o,i=t;e.push(t),RED.view.state(RED.state.EDITING);var a={title:g(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,a=RED.nodes.dirty(),s=$("#subflow-input-name").val();s!=i.name&&(e.name=i.name,i.name=s,t=!0);var d=o.getValue();d!=i.info&&(e.info=i.info,i.info=d,t=!0),y(i,e,null)&&(t=!0);var l=$("#node-settings-icon").text()||"";(void 0===i.icon&&"node-red/subflow.png"!==l||void 0!==i.icon&&i.icon!==l)&&(e.icon=i.icon,i.icon=l,t=!0);var c=$("#subflow-input-category").val().trim();if("_custom_"===c&&""===(c=$("#subflow-input-custom-category").val().trim())&&(c=i.category),"subflows"===c&&(c=""),c!=i.category&&(e.category=i.category,i.category=c,t=!0),RED.palette.refresh(),t){var p=i.changed;i.changed=!0,n(i);var u=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+i.id&&(u.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e),n(e))}),RED.nodes.dirty(!0);var f={t:"edit",node:i,changes:e,dirty:a,changed:p,subflow:{instances:u}};RED.history.push(f)}i.dirty=!0,RED.tray.close()}}],resize:function(e){$(".editor-tray-content").height(e.height-78),$(".editor-tray-content form").height(e.height-78-40);for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<t.size();i++)n-=$(t[i]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",n+"px"),o.resize()},open:function(e){e.find(".editor-tray-footer");var n=e.find(".editor-tray-body");n.parent().css("overflow","hidden");var a=RED.stack.create({container:n,singleExpanded:!0}),s=a.add({title:RED._("editor.nodeProperties"),expanded:!0});s.content.addClass("editor-tray-content");var r=a.add({title:RED._("editor.portLabels")});r.content.addClass("editor-tray-content"),i&&RED.sidebar.info.refresh(i),v(s.content,"dialog-form","subflow-template"),o=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""}),$("#subflow-input-name").val(t.name),RED.text.bidi.prepareInput($("#subflow-input-name")),$("#subflow-input-category").empty();var d=RED.palette.getCategories();d.sort(function(e,t){return e.label.localeCompare(t.label)}),d.forEach(function(e){$("#subflow-input-category").append($("<option></option>").val(e.id).text(e.label))}),$("#subflow-input-category").append($("<option></option>").attr("disabled",!0).text("---")),$("#subflow-input-category").append($("<option></option>").val("_custom_").text(RED._("palette.addCategory"))),$("#subflow-input-category").change(function(){"_custom_"===$(this).val()?($("#subflow-input-category").width(120),$("#subflow-input-custom-category").show()):($("#subflow-input-category").width(250),$("#subflow-input-custom-category").hide())}),$("#subflow-input-category").val(t.category||"subflows"),o.getSession().setValue(t.info||"",-1);var l=0,c="subflow:"+i.id;RED.nodes.eachNode(function(e){e.type===c&&l++}),$("#subflow-dialog-user-count").text(RED._("subflow.subflowInstances",{count:l})).show(),m(r.content,t),n.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(i),RED.workspaces.refresh(),o.destroy(),e.pop(),i=null},show:function(){}};RED.tray.show(a)},editJavaScript:function(e){R("_js",e)},editExpression:function(e){R("_expression",e)},editJSON:function(e){R("_json",e)},editMarkdown:function(e){R("_markdown",e)},editBuffer:function(e){R("_buffer",e)},buildEditForm:v,validateNode:n,updateNodeProperties:r,createEditor:function(e){var t=ace.edit(e.id||e.element);t.setTheme("ace/theme/tomorrow");var n=t.getSession();return n.on("changeAnnotation",function(){for(var e=n.getAnnotations()||[],t=e.length,o=e.length;t--;)/doctype first\. Expected/.test(e[t].text)?e.splice(t,1):/Unexpected End of file\. Expected/.test(e[t].text)&&e.splice(t,1);o>e.length&&n.setAnnotations(e)}),e.mode&&n.setMode(e.mode),e.foldStyle?n.setFoldStyle(e.foldStyle):n.setFoldStyle("markbeginend"),e.options?t.setOptions(e.options):t.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),e.readOnly&&(t.setOption("readOnly",e.readOnly),t.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&t.renderer.setOption("showGutter",e.lineNumbers),t.$blockScrolling=1/0,e.value&&n.setValue(e.value,-1),e.globals&&setTimeout(function(){n.$worker&&n.$worker.send("setOptions",[{globals:e.globals,esversion:6,sub:!0,asi:!0,maxerr:1e3}])},100),t}}}(),RED.editor.types._buffer=function(){return{init:function(){$('<script type="text/x-red" data-template-name="_buffer"><div id="node-input-buffer-panels"><div id="node-input-buffer-panel-str" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><span class="node-input-buffer-type"><i class="fa fa-exclamation-circle"></i> <span id="node-input-buffer-type-string" data-i18n="bufferEditor.modeString"></span><span id="node-input-buffer-type-array" data-i18n="bufferEditor.modeArray"></span></span></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="node-input-buffer-str"></div></div></div><div id="node-input-buffer-panel-bin" class="red-ui-panel"><div class="form-row node-text-editor-row" style="margin-top: 10px"><div class="node-text-editor" id="node-input-buffer-bin"></div></div></div></div><\/script>').appendTo(document.body)},show:function(e){var t=e.value,n=e.complete;RED.view.state(RED.state.EDITING);var o,i,a=[],s={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){n(JSON.stringify(o)),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();i&&i.resize(t)},open:function(e){e.find(".editor-tray-body");var n,s=RED.editor.buildEditForm(e.find(".editor-tray-body"),"dialog-form","_buffer","editor");(a=RED.editor.createEditor({id:"node-input-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(t||"",-1),bufferBinEditor=RED.editor.createEditor({id:"node-input-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});var r=function(e){var t=!0,n="string"==typeof e,i=[];o=n?function(e){var t=[],n=0,o=e.length;for(n=0;n<o;n++){var i=e.charCodeAt(n);i<128?t.push(i):i<2048?(t.push(192|i>>6),t.push(128|63&i)):i<55296||i>=57344?(t.push(224|i>>12),t.push(128|i>>6&63),t.push(128|63&i)):(n++,i=65536+((1023&i)<<10|1023&e.charAt(n)),t.push(240|i>>18),t.push(128|i>>12&63),t.push(128|i>>6&63),t.push(128|63&i))}return t}(e):e;var a=0,s=o.length;for(a=0;a<s;a++){var r=parseInt(o[a]);if(!n&&(isNaN(r)||r<0||r>255)){t=!1;break}a>0&&(a%8==0?a%16==0?i.push("\n"):i.push("  "):i.push(" ")),i.push((r<16?"0":"")+r.toString(16).toUpperCase())}return t&&($("#node-input-buffer-type-string").toggle(n),$("#node-input-buffer-type-array").toggle(!n),bufferBinEditor.setValue(i.join(""),1)),t},d=function(){var e=a.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var n=JSON.parse(e);t=r(n)}catch(e){t=!1}}t||r(e)};a.getSession().on("change",function(){clearTimeout(n),n=setTimeout(d,200)}),d(),s.i18n(),i=RED.panels.create({id:"node-input-buffer-panels",resize:function(e,t){var n=$("#node-input-buffer-panel-str");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-str").css("height",e-5+"px"),a.resize();var i=$("#node-input-buffer-panel-bin");o=$(i.children()[0]),t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".node-input-buffer-type").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("bufferEditor.modeDesc")),RED.sidebar.info.show()})},close:function(){e.onclose&&e.onclose(),a.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(s)}}}(),RED.editor.types._expression=function(){var e={};return{init:function(){$('<script type="text/x-red" data-template-name="_expression"><div id="node-input-expression-panels"><div id="node-input-expression-panel-expr" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><span class="node-input-expression-legacy"><i class="fa fa-exclamation-circle"></i> <span data-i18n="expressionEditor.compatMode"></span></span><button id="node-input-expression-reformat" class="editor-button editor-button-small"><span data-i18n="expressionEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="node-input-expression"></div></div></div><div id="node-input-expression-panel-info" class="red-ui-panel"><div class="form-row"><ul id="node-input-expression-tabs"></ul><div id="node-input-expression-tab-help" class="node-input-expression-tab-content hide"><div><select id="node-input-expression-func"></select><button id="node-input-expression-func-insert" class="editor-button" data-i18n="expressionEditor.insert"></button></div><div id="node-input-expression-help"></div></div><div id="node-input-expression-tab-test" class="node-input-expression-tab-content hide"><div><span style="display: inline-block; width: calc(50% - 5px);"><span data-i18n="expressionEditor.data"></span><button style="float: right; margin-right: 5px;" id="node-input-example-reformat" class="editor-button editor-button-small"><span data-i18n="jsonEditor.format"></span></button></span><span style="display: inline-block; width: calc(50% - 5px);" data-i18n="expressionEditor.result"></span></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="node-input-expression-test-data"></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="node-input-expression-test-result"></div></div></div></div></div><\/script>').appendTo(document.body)},show:function(t){var n,o,i,a,s=t.parent||"_",r=t.value,d=t.complete;RED.view.state(RED.state.EDITING);var l={title:t.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#node-input-expression-help").text(""),d(n.getValue()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();a&&a.resize(t)},open:function(t){t.find(".editor-tray-body").addClass("node-input-expression-editor");var d=RED.editor.buildEditForm(t.find(".editor-tray-body"),"dialog-form","_expression","editor"),c=$("#node-input-expression-func");Object.keys(jsonata.functions).forEach(function(e){c.append($("<option></option>").val(e).text(e))}),c.change(function(e){var t=$(this).val(),n="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",o=marked(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#node-input-expression-help").html(n+"<p>"+o+"</p>")}),n=RED.editor.createEditor({id:"node-input-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}});var p=null,u=-1;n.getSession().setValue(r||"",-1),n.on("changeSelection",function(){var e=n.getCursorPosition(),t=n.getSession().getTokenAt(e.row,e.column);if(t!==p||t&&/paren/.test(t.type)&&e.column!==u){var o,i;p=t;var a=null;if(t&&"keyword"===t.type)o=e.row,a=t;else{var s=0,r=!1;for(t?("paren.rparen"===t.type&&(u=e.column,s=e.column-(t.start+t.value.length)),o=e.row,i=t.index):(o=e.row-1,i=-1);null===a&&o>-1;){var d=n.getSession().getTokens(o);for(-1===i&&(i=d.length-1);i>-1;){var l=d[i].type;if(r){if("keyword"===l){a=d[i];break}r=!1}"paren.lparen"===l?s-=d[i].value.length:"paren.rparen"===l&&(s+=d[i].value.length),s<0&&(r=!0,s=0),i--}a||o--}}n.session.removeMarker(null),a&&c.val(a.value).change()}}),d.i18n(),$("#node-input-expression-func-insert").click(function(e){e.preventDefault();n.getCursorPosition();var t=c.val(),o=jsonata.getFunctionSnippet(t);n.insertSnippet(o),n.focus()}),$("#node-input-expression-reformat").click(function(e){e.preventDefault();var t=n.getValue()||"";try{t=jsonata.format(t)}catch(e){}n.getSession().setValue(t||"",-1)});var f,h=RED.tabs.create({element:$("#node-input-expression-tabs"),onchange:function(e){$(".node-input-expression-tab-content").hide(),e.content.show(),l.resize()}});h.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#node-input-expression-tab-help")}),h.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#node-input-expression-tab-test")}),o=RED.editor.createEditor({id:"node-input-expression-test-data",value:e[s]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".node-input-expression-legacy").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});var g=function(){var e,t,a=o.getValue(),s=n.getValue(),r=!1,d=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(s);$(".node-input-expression-legacy").toggle(d);try{(t=jsonata(s)).assign("flowContext",function(e){return r=!0,null}),t.assign("globalContext",function(e){return r=!0,null})}catch(e){return void i.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(a)}catch(e){return void i.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var l,c=t.evaluate(d?{msg:e}:e);if(r)return void i.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);l=void 0!==c?JSON.stringify(c,null,4):RED._("expressionEditor.noMatch"),i.setValue(l,-1)}catch(e){i.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};o.getSession().on("change",function(){clearTimeout(f),f=setTimeout(g,200),e[s]=o.getValue()}),n.getSession().on("change",function(){clearTimeout(f),f=setTimeout(g,200)}),i=RED.editor.createEditor({id:"node-input-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),a=RED.panels.create({id:"node-input-expression-panels",resize:function(e,t){var a=$("#node-input-expression-panel-expr");e-=$(a.children()[0]).outerHeight(!0);var s=$(a.children()[1]);e-=parseInt(s.css("marginTop"))+parseInt(s.css("marginBottom")),$("#node-input-expression").css("height",e-5+"px"),n.resize(),t-=$("#node-input-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".node-input-expression-tab-content").height(t),$("#node-input-expression-test-data").css("height",t-5+"px"),o.resize(),$("#node-input-expression-test-result").css("height",t-5+"px"),i.resize()}}),$("#node-input-example-reformat").click(function(e){e.preventDefault();var t=o.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}o.getSession().setValue(t||"",-1)}),g()},close:function(){t.onclose&&t.onclose(),n.destroy(),o.destroy()},show:function(){}};RED.tray.show(l)}}}(),RED.editor.types._js={init:function(){$('<script type="text/x-red" data-template-name="_js"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-js"></div></div><\/script>').appendTo(document.body)},show:function(e){var t,n=e.value,o=e.complete;RED.view.state(RED.state.EDITING);var i={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){o(t.getValue(),t.getCursorPosition()),RED.tray.close()}}],resize:function(e){for(var n=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<n.size();i++)o-=$(n[i]).outerHeight(!0);$(".node-text-editor").css("height",o+"px"),t.resize()},open:function(o){o.find(".editor-tray-body");var i=RED.editor.buildEditForm(o.find(".editor-tray-body"),"dialog-form","_js","editor");t=RED.editor.createEditor({id:"node-input-js",mode:"ace/mode/javascript",value:n,globals:{msg:!0,context:!0,RED:!0,util:!0,flow:!0,global:!0,console:!0,Buffer:!0,setTimeout:!0,clearTimeout:!0,setInterval:!0,clearInterval:!0}}),e.cursor&&t.gotoLine(e.cursor.row+1,e.cursor.column,!1),i.i18n()},close:function(){t.destroy(),e.onclose&&e.onclose()},show:function(){}};RED.tray.show(i)}},RED.editor.types._json={init:function(){$('<script type="text/x-red" data-template-name="_json"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button id="node-input-json-reformat" class="editor-button editor-button-small"><span data-i18n="jsonEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-json"></div></div><\/script>').appendTo(document.body)},show:function(e){var t,n,o=e.value,i=e.complete;RED.view.state(RED.state.EDITING);var a=function(){var e=t.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}},s={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e.requireValid&&!a()||(i(t.getValue()),RED.tray.close())}}],resize:function(e){for(var n=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<n.size();i++)o-=$(n[i]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),t.resize()},open:function(i){i.find(".editor-tray-body");var s=RED.editor.buildEditForm(i.find(".editor-tray-body"),"dialog-form","_json","editor");(t=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(o||"",-1),e.requireValid&&(t.getSession().on("change",function(){clearTimeout(n),n=setTimeout(a,200)}),a()),$("#node-input-json-reformat").click(function(e){e.preventDefault();var n=t.getValue()||"";try{n=JSON.stringify(JSON.parse(n),null,4)}catch(e){}t.getSession().setValue(n||"",-1)}),s.i18n()},close:function(){t.destroy(),e.onclose&&e.onclose()},show:function(){}};RED.tray.show(s)}},RED.editor.types._markdown={init:function(){$('<script type="text/x-red" data-template-name="_markdown"><div class="form-row" id="node-input-markdown-title" style="margin-bottom: 3px; text-align: right;"></div><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-markdown"></div></div><\/script>').appendTo(document.body)},show:function(e){var t,n=e.value,o=e.complete;RED.view.state(RED.state.EDITING);var i={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){o(t.getValue()),RED.tray.close()}}],resize:function(e){for(var n=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<n.size();i++)o-=$(n[i]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),t.resize()},open:function(o){o.find(".editor-tray-body");var i=RED.editor.buildEditForm(o.find(".editor-tray-body"),"dialog-form","_markdown","editor");t=RED.editor.createEditor({id:"node-input-markdown",value:n,mode:"ace/mode/markdown"}),e.header&&e.header.appendTo(o.find("#node-input-markdown-title")),i.i18n()},close:function(){t.destroy(),e.onclose&&e.onclose()},show:function(){}};RED.tray.show(i)}},RED.tray=function(){var e=[],t=$("#editor-stack"),n=!1;function o(o){var a=$('<div class="editor-tray"></div>'),s=$('<div class="editor-tray-header"></div>').appendTo(a),r=$('<div class="editor-tray-body-wrapper"></div>').appendTo(a),d=$('<div class="editor-tray-body"></div>').appendTo(r),l=$('<div class="editor-tray-footer"></div>').appendTo(a),c=$('<div class="editor-tray-resize-handle"></div>').appendTo(a);if(o.title){var p=e.map(function(e){return e.options.title});p.push(o.title);var u='<ul class="editor-tray-breadcrumbs"><li>'+p.join("</li><li>")+"</li></ul>";$('<div class="editor-tray-titlebar">'+u+"</div>").appendTo(s)}o.width===1/0&&(o.maximized=!0,c.addClass("editor-tray-resize-maximised"));var f,h=$('<div class="editor-tray-toolbar"></div>').appendTo(s);if(o.buttons)for(var g=0;g<o.buttons.length;g++){var v=o.buttons[g],b=$("<button>").button().appendTo(h);v.id&&b.attr("id",v.id),v.text&&b.text(v.text),v.click&&b.click(function(e){return function(t){$(this).hasClass("disabled")||e(t)}}(v.click)),v.class&&(b.addClass(v.class),"primary"===v.class&&(f=v))}a.appendTo(t);var m={tray:a,header:s,body:d,footer:l,options:o,primaryButton:f};function y(){$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),m.preferredWidth=Math.max(a.width(),500),o.maximized||d.css({minWidth:m.preferredWidth-40}),o.width?(o.width>$("#editor-stack").position().left-8&&(o.width=$("#editor-stack").position().left-8),a.width(o.width)):a.width(m.preferredWidth),m.width=a.width(),m.width>$("#editor-stack").position().left-8&&(m.width=Math.max(0,$("#editor-stack").position().left-8),a.width(m.width)),a.css({right:-(a.width()+10)+"px",transition:"right 0.25s ease"}),$("#workspace").scrollLeft(0),i(),n=!0,setTimeout(function(){setTimeout(function(){o.width||a.width(Math.min(m.preferredWidth,$("#editor-stack").position().left-8)),o.resize&&o.resize({width:a.width()}),o.show&&o.show(),setTimeout(function(){n=!1},200),d.find(":focusable:first").focus()},150),a.css({right:0})},0)}e.push(m),o.maximized||a.draggable({handle:c,axis:"x",start:function(e,t){a.width("auto")},drag:function(e,n){var o=t.position().left+n.position.left;o<7?n.position.left+=7-o:n.position.left>-m.preferredWidth-1&&(n.position.left=-Math.min(t.position().left-7,m.preferredWidth-1)),m.options.resize&&setTimeout(function(){m.options.resize({width:-n.position.left})},0),m.width=-n.position.left},stop:function(e,t){a.width(-t.position.left),a.css({left:""}),m.options.resize&&m.options.resize({width:-t.position.left}),m.width=-t.position.left}}),o.open?1===o.open.length?(o.open(a),y()):o.open(a,y):y()}function i(){if(e.length>0){var t=e[e.length-1],n=t.tray.height()-t.header.outerHeight()-t.footer.outerHeight();t.body.height(n),t.options.maximized||t.width>$("#editor-stack").position().left-8?(t.width=$("#editor-stack").position().left-8,t.tray.width(t.width)):t.width<t.preferredWidth&&(t.width=Math.min($("#editor-stack").position().left-8,t.preferredWidth),t.tray.width(t.width)),t.options.resize&&t.options.resize({width:t.width,height:n})}}return{init:function(){$(window).resize(i),RED.events.on("sidebar:resize",i),$("#editor-shade").click(function(){if(!n){var t=e[e.length-1];t&&t.primaryButton&&t.primaryButton.click()}})},show:function(t){if(e.length>0&&!t.overlay){var n=e[e.length-1];"inherit"===t.width&&(t.width=n.tray.width()),n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){n.tray.detach(),o(t)},250)}else RED.events.emit("editor:open"),o(t)},close:function(t){if(e.length>0){var n=e.pop();n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){if(n.options.close&&n.options.close(),n.tray.remove(),e.length>0){var o=e[e.length-1];o.options.overlay?(i(),o.options.show&&o.options.show()):(o.tray.appendTo("#editor-stack"),setTimeout(function(){i(),o.tray.css({right:0}),o.options.show&&o.options.show()},0))}t&&t(),0===e.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){var e,t,n,o,i=!1;function a(){var e=$("#clipboard-import"),t=e.val();t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1);try{JSON.parse(t),e.removeClass("input-error"),e.val(t),$("#clipboard-dialog-ok").button("enable")}catch(n){""!==t&&e.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function s(){i||(t.empty(),t.append($(o)),t.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(a),$("#clipboard-import").on("paste",function(){setTimeout(a,10)}),$("#import-tab > a").click(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"))}function r(){if(!i){t.empty(),t.append($(n)),t.i18n();var o=RED.settings.flowFilePretty?"export-format-full":"export-format-mini";$("#export-format-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#clipboard-export").val();if(t.length>0){var n=JSON.parse(t);t="export-format-full"===(o=$(this).attr("id"))?JSON.stringify(n,null,4):JSON.stringify(n),$("#clipboard-export").val(t),$("#clipboard-export").focus()}}}),$("#export-range-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),n="",i=null;if("export-range-selected"===t){var a=RED.view.selection();i=RED.nodes.createExportableNodeSet(a.nodes.filter(function(e){return"subflow"!==e.type}))}else if("export-range-flow"===t){var s=RED.workspaces.active();i=RED.nodes.filterNodes({z:s});var r=RED.nodes.workspace(s)||RED.nodes.subflow(s);i.unshift(r),i=RED.nodes.createExportableNodeSet(i)}else"export-range-full"===t&&(i=RED.nodes.createCompleteNodeSet(!1));null!==i&&(n="export-format-full"===o?JSON.stringify(i,null,4):JSON.stringify(i)),n.length>0?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(n),$("#clipboard-export").focus()}}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide(),RED.view.selection().nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),"export-format-full"===o?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var e=$(this);e.select(),e.mouseup(function(){return e.unbind("mouseup"),!1})}),e.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#clipboard-export").focus(),document.queryCommandSupported("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show())}}function d(){$("#dropTarget").hide(),RED.keyboard.remove("escape")}return{init:function(){e=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported")),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),t=e.children(".dialog-form"),n='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',o='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',$('<input type="text" id="clipboard-hidden">').appendTo("body"),RED.actions.add("core:show-export-dialog",r),RED.actions.add("core:show-import-dialog",s),RED.events.on("editor:open",function(){i=!0}),RED.events.on("editor:close",function(){i=!1}),RED.events.on("search:open",function(){i=!0}),RED.events.on("search:close",function(){i=!1}),RED.events.on("type-search:open",function(){i=!0}),RED.events.on("type-search:close",function(){i=!1}),$("#chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#dropTarget").css({display:"table"}),RED.keyboard.add("*","escape",d))}),$("#dropTarget").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){d()}).on("drop",function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t)}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var n=e.originalEvent.dataTransfer.files;if(1===n.length){var o=n[0],i=new FileReader;i.onload=function(e){RED.view.importNodes(e.target.result)},i.readAsText(o)}}d(),e.preventDefault()})},import:s,export:r,copyText:function(e,t,n){var o=!1;"string"!=typeof e&&(e=JSON.stringify(e,function(e,t){if(null!==t&&"object"==typeof t&&t.__enc__){if(t.hasOwnProperty("data")&&t.hasOwnProperty("length"))return o=t.data.length!==t.length,t.data;if("function"===t.type||"internal"===t.type)return;if("number"===t.type)return null}return t})),o&&(n+="_truncated"),$("#clipboard-hidden").val(e).select();var i=document.execCommand("copy");if(i&&t){var a=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(n)});setTimeout(function(){a.close()},1e3),a.open()}return i}}}(),RED.library=function(){var e,t="node-input-";function n(){$.getJSON("library/flows",function(e){var t,n=function(e,t){var o,i,a,s=document.createElement("ul");if(""===t&&(s.id="menu-item-import-library-submenu"),s.className="dropdown-menu",e.d)for(o in e.d)if(e.d.hasOwnProperty(o)){(i=document.createElement("li")).className="dropdown-submenu pull-left",(a=document.createElement("a")).href="#";var r=o.replace(/^@.*\//,"").replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/," ").replace(/_/," ");a.innerHTML=r,i.appendChild(a),i.appendChild(n(e.d[o],t+(""!==t?"/":"")+o)),s.appendChild(i)}if(e.f)for(o in e.f)e.f.hasOwnProperty(o)&&(i=document.createElement("li"),(a=document.createElement("a")).href="#",a.innerHTML=e.f[o],a.flowName=t+(""!==t?"/":"")+e.f[o],a.onclick=function(){$.get("library/flows/"+this.flowName,function(e){RED.view.importNodes(e)})},i.appendChild(a),s.appendChild(i));return s};e.d&&e.d._examples_&&(t=e.d._examples_,delete e.d._examples_);var o=n(e,"");$("#menu-item-import-examples").remove(),t&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(n(t,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(o)})}function o(){var t=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(t)),e.dialog("open")}return{init:function(){RED.actions.add("core:library-export",o),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-export-library",!1):RED.menu.setDisabled("menu-item-export-library",!0)}),!1!==RED.settings.theme("menu.menu-item-import-library")&&n(),(e=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var e=$("#node-input-library-filename").val();/^\s*$/.test(e)||$.ajax({url:"library/flows/"+e,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}})).children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:function(e){var n=null,o=null;function i(e){var t=document.createElement("li");return t.onmouseover=function(e){$(this).addClass("list-hover")},t.onmouseout=function(e){$(this).removeClass("list-hover")},t}function a(t,s){for(var r,d=document.createElement("ul"),l=0;l<s.length;l++){var c=s[l];"string"==typeof c?((r=i()).onclick=function(){var n=c;return function(o){var i=$('<li class="active"><span class="divider">/</span> <a href="#">'+n+"</a></li>");$("a",i).click(function(o){$(this).parent().nextAll().remove(),$.getJSON("library/"+e.url+t+n,function(e){$("#node-select-library").children().first().replaceWith(a(t+n+"/",e))}),o.stopPropagation()});var s=$("#node-dialog-library-breadcrumbs");$(".active",s).removeClass("active"),s.append(i),$.getJSON("library/"+e.url+t+n,function(e){$("#node-select-library").children().first().replaceWith(a(t+n+"/",e))})}}(),r.innerHTML='<i class="fa fa-folder"></i> '+c+"</i>",d.appendChild(r)):((r=i()).innerHTML=c.name,r.onclick=function(){var i=c;return function(a){$(".list-selected",d).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+e.url+t+i.fn,function(e){n=i,o.setValue(e,-1)})}}(),d.appendChild(r))}return d}function s(n){var o=$("#"+t+"name").val().replace(/(^\s*)|(\s*$)/g,"");""===o&&(o=RED._("library.unnamedType",{type:e.type}));var i=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),a=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""!==i&&/.+\.js$/.test(i)){for(var s=a+(""===a?"":"/")+i,r={},d=0;d<e.fields.length;d++){var l=e.fields[d];"name"==l?r.name=o:r[l]=$("#"+t+l).val()}r.text=e.editor.getValue(),$.ajax({url:"library/"+e.url+"/"+s,type:"POST",data:JSON.stringify(r),contentType:"application/json; charset=utf-8"}).done(function(t,n,o){RED.notify(RED._("library.savedType",{type:e.type}),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}else RED.notify(RED._("library.invalidFilename"),"warning")}t=e.elementPrefix||"node-input-",e.editor.setText&&(e.editor.setValue=function(t,n){e.editor.setText.call(e.editor,t)}),e.editor.getText&&(e.editor.getValue=e.editor.getText),$("#"+t+"name").css("width","calc(100% - 52px)").after('<div class="btn-group" style="margin-left:5px;"><a id="node-input-'+e.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+e.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+e.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+e.type+"-menu-open-library").click(function(t){$("#node-select-library").children().remove(),$("#node-dialog-library-breadcrumbs").children().first().nextAll().remove(),o.setValue("",-1),$.getJSON("library/"+e.url,function(e){$("#node-select-library").append(a("/",e)),$("#node-dialog-library-breadcrumbs a").click(function(t){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(a("/",e)),t.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),t.preventDefault()}),$("#node-input-"+e.type+"-menu-save-library").click(function(n){var o=$("#"+t+"name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var i=o.replace(/[^\w-]/g,"-");""===i&&(i="unnamed-"+e.type),$("#node-dialog-library-save-filename").attr("value",i+".js"),$("#node-dialog-library-save").dialog("open"),n.preventDefault()}),(o=ace.edit("node-select-library-text")).setTheme("ace/theme/tomorrow"),e.mode&&o.getSession().setMode(e.mode),o.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),o.renderer.$cursorLayer.element.style.opacity=0,o.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:e.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(n){for(var i=0;i<e.fields.length;i++){var a=e.fields[i];$("#"+t+a).val(n[a])}e.editor.setValue(o.getValue(),-1)}$(this).dialog("close")}}],open:function(e){var t=$("form",this);t.height(t.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",t).children().height(t.height()-60)},resize:function(e){var t=$("form",this);t.height(t.parent().height()-30),$(".form-row:last-child",t).children().height(t.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){s(),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){s(),$(this).dialog("close")}}]})},loadFlowLibrary:n,export:o}}(),RED.notifications=function(){var e,t={},n=[],o=0;function i(i,a,s,r){var d={};if(null!==a&&"object"==typeof a&&(s=(d=a).fixed,r=d.timeout,a=d.type),d.modal&&$("#full-shade").show(),n.length>4)for(var l=n.length,c=0;l>4&&c<n.length;c+=1){var p=n[c];p.fixed||(window.clearTimeout(p.timeoutid),p.close(),l-=1)}var u,f=document.createElement("div");if(f.id="red-notification-"+o,f.className="notification",f.fixed=s,a&&(f.className="notification notification-"+a),d.width){var h=$("#notifications").width();if(d.width>h){var g=-(d.width-h)/2;$(f).css({width:d.width+"px",marginLeft:g+"px"})}}if(f.style.display="none","string"==typeof i?(/<p>/i.test(i)||(i="<p>"+i+"</p>"),f.innerHTML=i):$(f).append(i),d.buttons){var v=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(f);d.buttons.forEach(function(e){var t=$("<button>").html(e.text).click(e.click).appendTo(v);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}return $("#notifications").append(f),$(f).slideDown(300),f.close=(u=f,function(){u.closed||(u.closed=!0,n.splice(n.indexOf(u),1),d.id&&(delete t[d.id],0===Object.keys(t).length&&e.hide()),$(u).slideUp(300,function(){u.parentNode.removeChild(u)}),d.modal&&$("#full-shade").hide())}),f.hideNotification=function(){var e=f;return function(){e.closed||(e.hidden=!0,$(e).slideUp(300))}}(),f.showNotification=function(){var e=f;return function(){!e.closed&&e.hidden&&(e.hidden=!1,$(e).slideDown(300))}}(),f.update=function(){var e=f;return function(t,n){var o;if("string"==typeof t?(/<p>/i.test(t)||(t="<p>"+t+"</p>"),e.innerHTML=t):$(e).empty().append(t),"number"==typeof n)o=n;else if(void 0!==n&&(o=n.timeout,n.buttons)){var i=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(e);n.buttons.forEach(function(e){var t=$("<button>").text(e.text).click(e.click).appendTo(i);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}void 0!==o&&o>0?(window.clearTimeout(e.timeoutid),e.timeoutid=window.setTimeout(e.close,o)):window.clearTimeout(e.timeoutid),e.hidden&&e.showNotification()}}(),s||($(f).click(function(){var e=f;return function(){e.close(),window.clearTimeout(e.timeoutid)}}()),f.timeoutid=window.setTimeout(f.close,r||5e3)),n.push(f),d.id&&(t[d.id]=f,e.show()),o+=1,f}return RED.notify=i,{init:function(){e=$('<li><a id="btn-notifications" class="button" href="#"><i class="fa fa-warning"></i></a></li>').prependTo(".header-toolbar").hide(),$("#btn-notifications").click(function(){!function(){for(var e in t)t.hasOwnProperty(e)&&t[e].showNotification()}()})},notify:i}}(),RED.search=function(){var e,t,n=!1,o=null,i=-1,a=!1,s={},r=[],d=[];function l(e,t,n){if("string"==typeof n||"number"==typeof n)n=(""+n).toLowerCase(),s[n]=s[n]||{},s[n][e.id]={node:e,label:t};else if(Array.isArray(n))n.forEach(function(n){l(e,t,n)});else if("object"==typeof n)for(var o in n)n.hasOwnProperty(o)&&l(e,t,n[o])}function c(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),s[t]=s[t]||{},s[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var n=["id","type","name","label","info"];e._def&&e._def.defaults&&(n=n.concat(Object.keys(e._def.defaults)));for(var o=0;o<n.length;o++)e.hasOwnProperty(n[o])&&l(e,t,e[n[o]])}function p(){var e=t.find("li.selected");if(1===e.length){var n=t.parent(),o=n.height(),i=(n.scrollTop(),e.position().top),a=e.height();i+a>o?n.animate({scrollTop:"-="+(o-(i+a)-10)},50):i<0&&n.animate({scrollTop:"+="+(i-10)},50)}}function u(){o=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var n=$("<div>",{class:"red-ui-search-container"}).appendTo(o);(e=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(n).searchBox({delay:200,change:function(){!function(e){if(t.editableList("empty"),i=-1,d=[],e.length>0){var n,o;e=e.toLowerCase();var a=[],l={};for(n=0;n<r.length;n++){var c=r[n],p=r[n].indexOf(e);if(p>-1)for(o=0;o<s[c].length;o++){var u=s[c][o];l[u.node.id]=l[u.node.id]=u,l[u.node.id].index=Math.min(l[u.node.id].index||1/0,p)}}for((a=Object.keys(l)).sort(function(e,t){return l[e].index-l[t].index}),n=0;n<a.length;n++)d.push(l[a[n]]);if(d.length>0)for(n=0;n<Math.min(d.length,25);n++)t.editableList("addItem",d[n]);else t.editableList("addItem",{})}}($(this).val())}})).on("keydown",function(e){var n;d.length>0&&(40===e.keyCode?(n=t.children(),i<n.length-1&&(i>-1&&$(n[i]).removeClass("selected"),i++),$(n[i]).addClass("selected"),p(),e.preventDefault()):38===e.keyCode?(n=t.children(),i>0&&(i<n.length&&$(n[i]).removeClass("selected"),i--),$(n[i]).addClass("selected"),p(),e.preventDefault()):13===e.keyCode&&d.length>0&&f(d[Math.max(0,i)].node))}),e.i18n();var a=$("<div>",{class:"red-ui-search-results-container"}).appendTo(o);t=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(a).editableList({addButton:!1,addItem:function(e,t,n){var o=n.node;if(void 0===o)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{var i=o._def,a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),s=$("<div>",{class:"red-ui-search-result-node"}).appendTo(a),r=RED.utils.getNodeColor(o.type,i),d=RED.utils.getNodeIcon(i,o);"tab"===o.type&&(r="#C0DEED"),s.css("backgroundColor",r);var l=$("<div/>",{class:"palette_icon_container"}).appendTo(s);$("<div/>",{class:"palette_icon",style:"background-image: url("+d+")"}).appendTo(l);var c=$("<div>",{class:"red-ui-search-result-description"}).appendTo(a);if(o.z){var p=RED.nodes.workspace(o.z);p=p?"flow:"+p.label:"subflow:"+(p=RED.nodes.subflow(o.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).text(p).appendTo(c)}$("<div>",{class:"red-ui-search-result-node-label"}).text(n.label||o.id).appendTo(c),$("<div>",{class:"red-ui-search-result-node-type"}).text(o.type).appendTo(c),$("<div>",{class:"red-ui-search-result-node-id"}).text(o.id).appendTo(c),a.click(function(e){e.preventDefault(),f(o)})}},scrollOnAdd:!1})}function f(e){g(),RED.view.reveal(e.id)}function h(){n||(a||(RED.keyboard.add("*","escape",function(){g()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),s={},RED.nodes.eachWorkspace(c),RED.nodes.eachSubflow(c),RED.nodes.eachConfig(c),RED.nodes.eachNode(c),(r=Object.keys(s)).sort(),r.forEach(function(e){s[e]=Object.keys(s[e]).map(function(t){return s[e][t]})}),null===o&&u(),o.slideDown(300),RED.events.emit("search:open"),a=!0),e.focus())}function g(){a&&(RED.keyboard.remove("escape"),a=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==o&&o.slideUp(200,function(){e.searchBox("value","")}),RED.events.emit("search:close"))}return{init:function(){RED.actions.add("core:search",h),RED.events.on("editor:open",function(){n=!0}),RED.events.on("editor:close",function(){n=!1}),RED.events.on("type-search:open",function(){n=!0}),RED.events.on("type-search:close",function(){n=!1}),$("#header-shade").on("mousedown",g),$("#editor-shade").on("mousedown",g),$("#palette-shade").on("mousedown",g),$("#sidebar-shade").on("mousedown",g)},show:h,hide:g}}(),RED.typeSearch=function(){var e,t,n,o,i,a=null,s=-1,r=!1,d="",l={};function c(){var e=t.find("li.selected");if(1===e.length){var n=t.parent(),o=n.height(),i=(n.scrollTop(),e.position().top),a=e.height();i+a>o?n.animate({scrollTop:"-="+(o-(i+a)-10)},50):i<0&&n.animate({scrollTop:"+="+(i-10)},50)}}function p(){a=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#main-container");var o=$("<div>",{class:"red-ui-search-container"}).appendTo(a);(e=$('<input type="text">').attr("placeholder",RED._("search.addNode")).appendTo(o).searchBox({delay:50,change:function(){var e;e=$(this).val(),d=e.toLowerCase(),t.editableList("filter"),t.editableList("sort"),setTimeout(function(){s=0,t.children().removeClass("selected"),t.children(":visible:first").addClass("selected")},100)}})).on("keydown",function(e){var n=t.children(":visible");if(n.length>0)if(40===e.keyCode)s<n.length-1&&(s>-1&&$(n[s]).removeClass("selected"),s++),$(n[s]).addClass("selected"),c(),e.preventDefault();else if(38===e.keyCode)s>0&&(s<n.length&&$(n[s]).removeClass("selected"),s--),$(n[s]).addClass("selected"),c(),e.preventDefault();else if(13===e.keyCode){var o=Math.max(0,s);o<n.length&&u($(n[o]).find(".red-ui-editableList-item-content").data("data"))}}),n=$("<div>",{class:"red-ui-search-results-container"}).appendTo(a),t=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(n).editableList({addButton:!1,filter:function(e){return""===d||!e.recent&&!e.common&&(""===d||e.index.indexOf(d)>-1)},sort:function(e,t){if(""===d)return e.i-t.i;var n=e.index.indexOf(d),o=t.index.indexOf(d);return-1===n?1:-1===o?-1:n===o?v(e,t):n-o},addItem:function(e,t,n){var o=n.def;n.index=n.type.toLowerCase(),n.separator&&e.addClass("red-ui-search-result-separator");var i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),a=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),s=RED.utils.getNodeColor(n.type,o),r=RED.utils.getNodeIcon(o);a.css("backgroundColor",s);var d=$("<div/>",{class:"palette_icon_container"}).appendTo(a);$("<div/>",{class:"palette_icon",style:"background-image: url("+r+")"}).appendTo(d),o.inputs>0&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(a),o.outputs>0&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(a);var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(i),c=n.label;n.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).text(c).appendTo(l),i.click(function(e){e.preventDefault(),u(n)})},scrollOnAdd:!1})}function u(e){h(),l[e.type]=Date.now(),o(e.type)}function f(e){if(r){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}h(!0),i&&i()}}function h(t){r&&(RED.keyboard.remove("escape"),r=!1,null!==a&&n.slideUp(t?50:200,function(){a.hide(),e.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"))}function g(e,t){var n=e;if(void 0!==t.paletteLabel)try{n=("function"==typeof t.paletteLabel?t.paletteLabel.call(t):t.paletteLabel)||"",n+=" ("+e+")"}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}return n}function v(e,t){var n=e.label.toLowerCase(),o=t.label.toLowerCase();return n<o?-1:n===o?0:1}return{show:function(d){r?(a.hide(),n.hide()):(RED.keyboard.add("*","escape",function(){h(),i&&i()}),null===a&&p(),r=!0,setTimeout(function(){$(document).on("mousedown.type-search",f),$(document).on("mouseup.type-search",f),$(document).on("click.type-search",f)},200)),function(){var n;t.editableList("empty"),e.searchBox("value",""),s=-1;var o=["inject","debug","function","change","switch"],i=Object.keys(l);i.sort(function(e,t){return l[t]-l[e]}),i=i.filter(function(e){return-1===o.indexOf(e)});var a=[];RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&a.push({type:e,def:t,label:g(e,t)})}),a.sort(v);var r,d=0;for(n=0;n<o.length;n++){var c=RED.nodes.getType(o[n]);c&&((r={type:o[n],common:!0,def:c,i:d++}).label=g(r.type,r.def),n===o.length-1&&(r.separator=!0),t.editableList("addItem",r))}for(n=0;n<Math.min(5,i.length);n++)(r={type:i[n],def:RED.nodes.getType(i[n]),recent:!0,i:d++}).label=g(r.type,r.def),n===i.length-1&&(r.separator=!0),t.editableList("addItem",r);for(n=0;n<a.length;n++)a[n].i=d++,t.editableList("addItem",a[n]);setTimeout(function(){s=0,t.children(":first").addClass("selected")},100)}(),o=d.add,closeCallback=d.close,RED.events.emit("type-search:open"),a.css({left:d.x+"px",top:d.y+"px"}).show(),n.slideDown(300),setTimeout(function(){n.find(".red-ui-editableList-container").scrollTop(0),e.focus()},100)},hide:h}}(),RED.subflow=function(){function e(e,t){var n={x:50,y:30};t||(n.x+=110);for(var o=0;o<e.out.length+e.in.length;o++){var i;(i=o<e.out.length?e.out[o]:e.in[o-e.out.length]).x==n.x&&i.y==n.y&&(n.x+=55,o=0)}return n}function t(){var e=RED.nodes.subflow(RED.workspaces.active());if(0!==e.in.length){var t=e.in[0],n=[];return RED.nodes.eachLink(function(o){"subflow"==o.source.type&&o.source.z==e.id&&o.source.i==t.i?n.push(o):o.target.type=="subflow:"+e.id&&n.push(o)}),n.forEach(function(e){RED.nodes.removeLink(e)}),e.in=[],$("#workspace-subflow-input-add").removeClass("active"),$("#workspace-subflow-input-remove").addClass("active"),e.changed=!0,{subflowInputs:[t],links:n}}}function n(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var n=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var o=e[i];t.out.splice(o.i,1);var a=[],s=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==o.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==o.i?a.push(e):e.sourcePort>o.i&&s.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),s.forEach(function(e){e.sourcePort--}),n=n.concat(a);for(var r=o.i;r<t.out.length;r++)t.out[r].i--,t.out[r].dirty=!0}return t.changed=!0,{subflowOutputs:e,links:n}}}function o(e){var t=RED.nodes.subflow(RED.workspaces.active());a(t);var n=[];if(t)return RED.nodes.filterNodes({type:"subflow:"+t.id}).forEach(function(o){for(n.push({id:o.id,changed:o.changed}),e&&(o.changed=!0),o.inputs=t.in.length,o.outputs=t.out.length;o.outputs<o.ports.length;)o.ports.pop();o.resize=!0,o.dirty=!0,RED.editor.updateNodeProperties(o)}),RED.editor.validateNode(t),{instances:n}}function a(e){e&&($("#workspace-subflow-input-add").toggleClass("active",0!==e.in.length),$("#workspace-subflow-input-remove").toggleClass("active",0===e.in.length),$("#workspace-subflow-output .spinner-value").text(e.out.length))}function s(i){var s=$("#workspace-toolbar");s.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="workspace-subflow-input-remove" class="button active" href="#">0</a><a id="workspace-subflow-input-add" class="button" href="#">1</a></div>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(s),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(s),s.i18n(),$("#workspace-subflow-output-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),a=i.changed,s=n();if(s){var r=o(!0);RED.history.push({t:"delete",links:s.links,subflowOutputs:s.subflowOutputs,changed:a,dirty:t,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(t){t.preventDefault(),function(t){var n=RED.nodes.subflow(RED.workspaces.active()),i=e(n,!1),a={type:"subflow",direction:"out",z:n.id,i:n.out.length,x:i.x,y:i.y,id:RED.nodes.id()},s=n.out.length;n.out.push(a),n.dirty=!0;var r=RED.nodes.dirty(),d=n.changed;n.changed=!0;var l={t:"edit",node:n,dirty:r,changed:d,subflow:{outputCount:s,instances:o(!0).instances}};RED.history.push(l),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").text(n.out.length)}()}),$("#workspace-subflow-input-add").click(function(t){t.preventDefault(),function(){var t=RED.nodes.subflow(RED.workspaces.active());if(1!==t.in.length){var n=e(t,!0),i={type:"subflow",direction:"in",z:t.id,i:t.in.length,x:n.x,y:n.y,id:RED.nodes.id()},a=t.in.length;t.in.push(i),t.dirty=!0;var s=RED.nodes.dirty(),r=t.changed;t.changed=!0;var d={t:"edit",node:t,dirty:s,changed:r,subflow:{inputCount:a,instances:o(!0).instances}};RED.history.push(d),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input-add").addClass("active"),$("#workspace-subflow-input-remove").removeClass("active")}}()}),$("#workspace-subflow-input-remove").click(function(e){e.preventDefault();var n=RED.nodes.dirty(),a=i.changed;i.changed=!0;var s=t();if(s){var r=o(!0);RED.history.push({t:"delete",links:s.links,changed:a,subflowInputs:s.subflowInputs,dirty:n,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#workspace-subflow-delete").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=r(RED.workspaces.active());n.t="delete",n.dirty=t,RED.history.push(n)}),a(i),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function r(e){var t=[],n=[],o=RED.nodes.subflow(e);RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&t.push(e),e.z==o.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==o.id&&t.push(e)});for(var i=[],a=0;a<t.length;a++){var s=RED.nodes.remove(t[a].id);n=n.concat(s.links),i=i.concat(s.nodes)}return t=t.concat(i),RED.nodes.removeSubflow(o),RED.workspaces.remove(o),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:t,links:n,subflow:{subflow:o}}}function d(){var e=0;RED.nodes.eachSubflow(function(t){var n=new RegExp("^Subflow (\\d+)$").exec(t.name);n&&(e=Math.max(e,n[1]))});var t="Subflow "+(e+1),n=RED.nodes.id(),o={type:"subflow",id:n,name:t,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(n),RED.nodes.dirty(!0)}function l(){var e=RED.view.selection();if(e.nodes){var t,n,o={},i=[],a=[],s=[],r=[],d={},l=[e.nodes[0].x,e.nodes[0].y,e.nodes[0].x,e.nodes[0].y];for(t=0;t<e.nodes.length;t++)n=e.nodes[t],o[n.id]={n:n,outputs:{}},l=[Math.min(l[0],n.x),Math.min(l[1],n.y),Math.max(l[2],n.x),Math.max(l[3],n.y)];var c=[(l[2]+l[0])/2,(l[3]+l[1])/2];RED.nodes.eachLink(function(e){o[e.source.id]&&o[e.target.id],o[e.source.id]&&!o[e.target.id]&&(r.push(e),a.push(e)),!o[e.source.id]&&o[e.target.id]&&(s.push(e),d[e.target.id]=e.target,a.push(e))});var p={};if((r=r.filter(function(e){return p[e.source.id+":"+e.sourcePort]?(p[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),p[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),Object.keys(d).length>1)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var u=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(u=Math.max(u,t[1]))});var f="Subflow "+(u+1),h=RED.nodes.id(),g={type:"subflow",id:h,name:f,info:"",in:Object.keys(d).map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:d[e].x-d[e].w/2-80,y:d[e].y,z:h,i:n,id:RED.nodes.id(),wires:[{id:d[e].id}]}}),out:r.map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:e.source.x+e.source.w/2+80,y:e.source.y,z:h,i:n,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})};RED.nodes.addSubflow(g);var v={id:RED.nodes.id(),type:"subflow:"+g.id,x:c[0],y:c[1],z:RED.workspaces.active(),inputs:g.in.length,outputs:g.out.length,h:Math.max(30,15*(g.out.length||0)),changed:!0};for(v._def=RED.nodes.getType(v.type),RED.editor.validateNode(v),RED.nodes.add(v),s.forEach(function(e){var t={source:e.source,sourcePort:e.sourcePort,target:v};i.push(t),RED.nodes.addLink(t)}),r.forEach(function(e,t){e.targets.forEach(function(e){var n={source:v,sourcePort:t,target:e};i.push(n),RED.nodes.addLink(n)})}),g.in.forEach(function(e){e.wires.forEach(function(t){var n={source:e,sourcePort:0,target:RED.nodes.node(t.id)};i.push(n),RED.nodes.addLink(n)})}),g.out.forEach(function(e,t){e.wires.forEach(function(t){var n={source:RED.nodes.node(t.id),sourcePort:t.port,target:e};i.push(n),RED.nodes.addLink(n)})}),t=0;t<a.length;t++)RED.nodes.removeLink(a[t]);for(t=0;t<e.nodes.length;t++)n=e.nodes[t],/^link /.test(n.type)&&(n.links=n.links.filter(function(e){var t=o.hasOwnProperty(e);if(!t){var i=RED.nodes.node(e);if(i&&i.links){var a=i.links.indexOf(n.id);a>-1&&i.links.splice(a,1)}}return t})),n.z=g.id;RED.history.push({t:"createSubflow",nodes:[v.id],links:i,subflow:{subflow:g},activeWorkspace:RED.workspaces.active(),removedLinks:a,dirty:RED.nodes.dirty()}),RED.view.select(null),RED.editor.validateNode(g),RED.nodes.dirty(!0),RED.view.redraw(!0)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?s(t):($("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)}),RED.actions.add("core:create-subflow",d),RED.actions.add("core:convert-to-subflow",l)},createSubflow:d,convertToSubflow:l,removeSubflow:r,refresh:o,removeInput:t,removeOutput:n}}(),RED.userSettings=function(){var e=700,t=!1,n=[];function o(e){n.push(e)}function i(o){if(!t)if(RED.user.hasPermission("settings.write")){t=!0;var i={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(t){e=t.width},open:function(e){var t=e.find(".editor-tray-body"),i=$("<div></div>").appendTo(t),a=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(i);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(a);var s=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),r=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(i);n.forEach(function(e){s.addTab({id:"user-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(r)}),i.i18n(),s.activateTab("user-settings-tab-"+(o||"view")),$("#sidebar-shade").show()},close:function(){t=!1,n.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==e&&(i.width=e),RED.tray.show(i)}else RED.notify(RED._("user.errors.settings"),"error")}var a=[{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],s={};function r(){var e=$('<div id="user-settings-tab-view" class="node-help"></div>'),t=RED.settings.get("editor")||{};return t.view=t.view||{},a.forEach(function(n){$("<h3></h3>").text(RED._(n.title)).appendTo(e),n.options.forEach(function(n){var o=t.view[n.setting],i=$('<div class="user-settings-row"></div>').appendTo(e);n.toggle?$('<label for="user-settings-'+n.setting+'"><input id="user-settings-'+n.setting+'" type="checkbox"> '+RED._(n.label)+"</label>").appendTo(i).find("input").prop("checked",o):($('<label for="user-settings-'+n.setting+'">'+RED._(n.label)+"</label>").appendTo(i),$('<input id="user-settings-'+n.setting+'" type="'+(n.type||"text")+'">').appendTo(i).val(o))})}),e}function d(e,t){var n=s[e],o=RED.settings.get("editor")||{};o.view=o.view||{},o.view[n.setting]=t,RED.settings.set("editor",o);var i=n.onchange;"string"==typeof i&&(i=RED.actions.get(i)),i&&i.call(n,t)}return{init:function(){RED.actions.add("core:show-user-settings",i),RED.actions.add("core:show-help",function(){i("keyboard")}),o({id:"view",title:RED._("menu.label.view.view"),get:r,close:function(){a.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?d(e.setting,t.prop("checked")):d(e.setting,t.val())})})}});var e=RED.settings.get("editor")||{};e.view=e.view||{};var t=!1;a.forEach(function(n){n.options.forEach(function(n){if(n.oldSetting){var o=RED.settings.get(n.oldSetting);null!=o&&(e.view[n.setting]=o,t=!0,RED.settings.remove(n.oldSetting))}if(s[n.setting]=n,n.onchange){var i=e.view[n.setting];null==i&&n.hasOwnProperty("default")&&(i=n.default,e.view[n.setting]=i,t=!0);var a=n.onchange;"string"==typeof a&&(a=RED.actions.get(a)),a&&a.call(n,i)}})}),t&&RED.settings.set("editor",e)},toggle:function(e){var t=s[e],n=RED.settings.get("editor")||{};n.view=n.view||{},d(e,!n.view[t.setting])},show:i,add:o}}(),RED.projects=function(){var e,t,n;function o(e){var t;"git_missing_user"===e.error?t=RED.notify("<p>"+RED._("projects.errors.no-username-email")+"</p>",{fixed:!0,type:"error",buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("projects.config-git"),click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),t=RED.notify("<p>"+RED._("projects.errors.unexpected")+":</p><p>"+e.message+"</p><small>"+RED._("projects.errors.code")+": "+e.error+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:RED._("common.label.close"),click:function(){t.close()}}]}))}var i={};function a(){var t=$('<div class="projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(t),$("<hr>").appendTo(t);var a,r,l,c,p,u,f,h={};i={welcome:{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text(RED._("projects.welcome.hello")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc0")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc1")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc2")).appendTo(o);var i=$('<div style="text-align: center"></div>').appendTo(o),a=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.welcome.create")+"</button>").appendTo(i),r=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.welcome.clone")+"</button>").appendTo(i);return a.click(function(e){e.preventDefault(),h={action:"create"},s("git-config")}),r.click(function(e){e.preventDefault(),h={action:"clone"},s("git-config")}),n},buttons:[{text:RED._("projects.welcome.not-right-now"),click:function(){h={},$(this).dialog("close")}}]},"git-config":{content:function(e){var n=!1,o=RED.settings.get("git");o&&o.user?o=o.user:RED.settings.git&&RED.settings.git.globalUser&&(n=!0,o=RED.settings.git.globalUser);var i=function(){var e=u.val().trim(),t=f.val().trim(),n=e.length>0&&t.length>0;$("#projects-dialog-git-config").prop("disabled",!n).toggleClass("disabled ui-button-disabled ui-state-disabled",!n)},a=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(a);var s=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(a);$("<p>").text(RED._("projects.git-config.setup")).appendTo(s),$("<p>").text(RED._("projects.git-config.desc0")).appendTo(s),$("<p>").text(RED._("projects.git-config.desc1")).appendTo(s),n&&$("<p>").text(RED._("projects.git-config.desc2")).appendTo(s),$("<p>").text(RED._("projects.git-config.desc3")).appendTo(s);var r=$('<div class="form-row"></div>').appendTo(s);return $('<label for="">'+RED._("projects.git-config.username")+"</label>").appendTo(r),(u=$('<input type="text">').val(o&&o.name||"").appendTo(r)).on("change keyup paste",i),r=$('<div class="form-row"></div>').appendTo(s),$('<label for="">'+RED._("projects.git-config.email")+"</label>").appendTo(r),(f=$('<input type="text">').val(o&&o.email||"").appendTo(r)).on("change keyup paste",i),setTimeout(function(){u.focus(),i()},50),a},buttons:[{text:RED._("common.label.back"),click:function(){s("welcome")}},{id:"projects-dialog-git-config",text:RED._("common.label.next"),class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=u.val(),e.user.email=f.val(),RED.settings.set("git",e),"create"===h.action?s("project-details"):"clone"===h.action&&s("clone-project")}}]},"project-details":{content:function(e){var n=null,o=!1;$.getJSON("projects",function(e){n={},e.projects.forEach(function(e){n[e]=!0,o&&(o=!1,s())})});var i=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(i);var a=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(i);$("<p>").text(RED._("projects.project-details.create")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc0")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc1")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc2")).appendTo(a);var s=function(){var e=c.val(),t=!0;if(g){if(null===n)return void(o=!0);f.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||n[e]?(c.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(f),l=!1,t=!1,n[e]?projectNameSublabel.text(RED._("projects.project-details.already-exists")):projectNameSublabel.text(RED._("projects.project-details.must-contain"))):(c.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(f),projectNameSublabel.text(RED._("projects.project-details.must-contain")),l=!0),v=e}t=l,$("#projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},r=$('<div class="form-row"></div>').appendTo(a);$('<label for="projects-dialog-screen-create-project-name">'+RED._("projects.project-details.project-name")+"</label>").appendTo(r);var d=$('<div style="position:relative;"></div>').appendTo(r);c=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').val(h.name||"").appendTo(d);var l,u,f=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(d),g=!1,v="";return c.on("change keyup paste",function(){if(g=c.val()!==v,u)clearTimeout(u);else if(g&&(f.empty(),$('<img src="red/images/spin.svg"/>').appendTo(f),""===c.val()))return void s();u=setTimeout(function(){s(),u=null},300)}),projectNameSublabel=$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.project-details.must-contain")+"</small></label>").appendTo(r).find("small"),r=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(a),$('<label for="projects-dialog-screen-create-project-desc">'+RED._("projects.project-details.desc")+"</label>").appendTo(r),p=$('<input id="projects-dialog-screen-create-project-desc" type="text">').val(h.summary||"").appendTo(r),$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.project-details.opt")+"</small></label>").appendTo(r),setTimeout(function(){c.focus(),c.change()},50),i},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){s("git-config")}},{id:"projects-dialog-create-name",disabled:!0,text:RED._("common.label.next"),class:"primary disabled",click:function(){h.name=c.val(),h.summary=p.val(),s("default-files",e)}}]}},"clone-project":function(){var n,i,a,r,l,c,p,u;return{content:function(e){var o=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(o);var s=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(o);$("<p>").text(RED._("projects.clone-project.clone")).appendTo(s),$("<p>").text(RED._("projects.clone-project.desc0")).appendTo(s);var d=null,f=!1;$.getJSON("projects",function(e){d={},e.projects.forEach(function(e){d[e]=!0,f&&(f=!1,g())})});var h,g=function(){var e=n.val(),t=!0;if(w){if(null===d)return void(f=!0);y.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||d[e]?(n.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(y),b=!1,t=!1,d[e]?c.text(RED._("projects.clone-project.already-exists")):c.text(RED._("projects.clone-project.must-contain"))):(n.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(y),c.text(RED._("projects.clone-project.must-contain")),b=!0),D=e}t=b;var o=a.val(),i=o.length>0&&!/\s/.test(o);/^https?:\/\/[^\/]+@/i.test(o)&&($("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.no-info-in-url")),i=!1),i?a.removeClass("input-error"):(R&&a.addClass("input-error"),t=!1),/^https?:\/\//.test(o)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(o)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide()),$("#projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(s),$('<label for="projects-dialog-screen-create-project-name">'+RED._("projects.clone-project.project-name")+"</label>").appendTo(h);var v=$('<div style="position:relative;"></div>').appendTo(h);n=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(v);var b,m,y=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(v),w=!1,D="",E="";n.on("change keyup paste",function(){if(w=n.val()!==D,m)clearTimeout(m);else if(w&&(y.empty(),$('<img src="red/images/spin.svg"/>').appendTo(y),""===n.val()))return void g();m=setTimeout(function(){g(),m=null},300)}),c=$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.must-contain")+"</small></label>").appendTo(h).find("small"),h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(s),$('<label for="projects-dialog-screen-create-project-repo">'+RED._("projects.clone-project.git-url")+"</label>").appendTo(h),a=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(h),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.protocols")+"</small></label>").appendTo(h);var R=!1,x="";a.on("change keyup paste",function(){R=!0;var e=$(this).val();x!==e&&$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),x=e;var t=/\/([^\/]+?)(?:\.git)?$/.exec(e);if(t){var o=n.val();""!==o&&o!==E||(E=t[1],n.val(E),n.change())}g()});var T=$('<div class="projects-dialog-screen-create-row"></div>').appendTo(s);h=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(T),$('<div><i class="fa fa-warning"></i> '+RED._("projects.clone-project.auth-failed")+"</div>").appendTo(h),h=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(T);v=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(h);$('<label for="projects-dialog-screen-create-project-repo-user">'+RED._("projects.clone-project.username")+"</label>").appendTo(v),r=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(v),v=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(h),$('<label for="projects-dialog-screen-create-project-repo-pass">'+RED._("projects.clone-project.passwd")+"</label>").appendTo(v),l=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(v),h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(T),v=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(h),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.ssh-key")+"</label>").appendTo(v),p=$("<select>",{style:"width: 100%"}).appendTo(v),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){p.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(p.addClass("input-error"),p.attr("disabled",!0),_.show()):(p.removeClass("input-error"),p.attr("disabled",!1),_.hide())}),v=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(h),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.passphrase")+"</label>").appendTo(v),u=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(v),v=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(T);var _=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(v);return $('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.clone-project.ssh-key-desc")+"</div>").appendTo(_),v=$('<div style="text-align: center">').appendTo(_),$('<button class="editor-button">'+RED._("projects.clone-project.ssh-key-add")+"</button>").appendTo(v).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(s),$("<label>"+RED._("projects.clone-project.credential-key")+"</label>").appendTo(h),i=$('<input type="password"></input>').appendTo(h),o},buttons:function(t){return[{text:RED._("common.label.back"),click:function(){s("git-config")}},{id:"projects-dialog-clone-project",disabled:!0,text:RED._("common.label.clone"),class:"primary disabled",click:function(){$(".projects-dialog-screen-create-type.selected").data("type");var t={name:n.val()};t.credentialSecret=i.val();var s=a.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(s)){var c=p.val();if(!c)return void console.log(RED._("projects.clone-project.cant-get-ssh-key"));t.git={remotes:{origin:{url:s,keyFile:c,passphrase:u.val()}}}}else t.git={remotes:{origin:{url:s,username:r.val(),password:l.val()}}};$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),r.removeClass("input-error"),l.removeClass("input-error"),p.removeClass("input-error"),u.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t.name),d({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(t){e.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.clone-project.already-exists2"))},git_error:function(e){console.log(RED._("projects.clone-project.git-error"),e)},git_connection_failed:function(e){a.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.connection-failed"))},git_not_a_repository:function(e){a.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.not-git-repo"))},git_repository_not_found:function(e){a.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.repo-not-found"))},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),r.addClass("input-error"),l.addClass("input-error"),p.addClass("input-error"),u.addClass("input-error")},missing_flow_file:function(t){e.dialog("close")},project_empty:function(t){e.dialog("close")},credentials_load_failed:function(t){e.dialog("close")},"*":function(t){o(t),$(e).dialog("close")}}}},t).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}(),"default-files":{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text(RED._("projects.default-files.create")).appendTo(o),$("<p>").text(RED._("projects.default-files.desc0")).appendTo(o),$("<p>").text(RED._("projects.default-files.desc1")).appendTo(o),!e.existingProject&&RED.settings.files&&$("<p>").text(RED._("projects.default-files.desc2")).appendTo(o);var i=function(){var e=!0,t=r.val();""!==t&&/\.json$/.test(t)?(r.hasClass("input-error")&&(r.removeClass("input-error"),r.next().empty()),l.hasClass("input-error")&&(l.removeClass("input-error"),l.next().empty()),l.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,r.hasClass("input-error")||(r.addClass("input-error"),r.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),l.text(""),l.hasClass("input-error")||(l.addClass("input-error"),l.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},a=$('<div class="form-row"></div>').appendTo(o);$('<label for="projects-dialog-screen-create-project-file">'+RED._("projects.default-files.flow-file")+"</label>").appendTo(a);var s=$('<div style="position:relative;"></div>').appendTo(a),d=h.files&&h.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";r=$('<input id="projects-dialog-screen-create-project-file" type="text">').val(d).on("change keyup paste",i).appendTo(s),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(s),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(a);var c=h.files&&h.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return a=$('<div class="form-row"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-credfile">'+RED._("projects.default-files.credentials-file")+"</label>").appendTo(a),s=$('<div style="position:relative;"></div>').appendTo(a),l=$('<div style="width: 100%" class="uneditable-input" id="projects-dialog-screen-create-project-credentials">').text(c).appendTo(s),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(s),setTimeout(function(){r.focus(),i()},50),n},buttons:function(e){return[{text:RED._(e.existingProject?"common.label.cancel":"common.label.back"),click:function(){e.existingProject?$(this).dialog("close"):s("project-details",e)}},{id:"projects-dialog-create-default-files",text:RED._("common.label.next"),class:"primary",click:function(){h.files={flow:r.val(),credentials:l.text()},e.existingProject||(h.migrateFiles=!0),s("encryption-config",e)}}]}},"encryption-config":{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text(RED._("projects.encryption-config.setup")).appendTo(o),e.existingProject?($("<p>").text(RED._("projects.encryption-config.desc0")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc1")).appendTo(o)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text(RED._("projects.encryption-config.desc2")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc3")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc4")).appendTo(o)):("user"===RED.settings.flowEncryptionType?$("<p>").text(RED._("projects.encryption-config.desc5")).appendTo(o):"system"===RED.settings.flowEncryptionType&&$("<p>").text(RED._("projects.encryption-config.desc6")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc7")).appendTo(o));var i=function(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==a.val()),$("#projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},s=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(o);$("<label>"+RED._("projects.encryption-config.credentials")+"</label>").appendTo(s);var r=$('<div style="width: 550px">').appendTo(s),d=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(r),l=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(r),c=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(l);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(c);var p=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(l);return $('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(p),l.find("input[name=projects-encryption-type]").click(function(e){var t,n;"enabled"===$(this).val()?(t=c,n=p,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&a.focus()):(n=c,t=p,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),n.css({borderColor:"white",borderRightColor:"#ccc"}),i()}),s=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?RED._("projects.encryption-config.disabled"):"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.copy")+"</span></label>").appendTo(s),s=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.use-custom")+"</span></label>").appendTo(s),s=$('<div class="projects-encryption-enabled-row"></div>').appendTo(d),(a=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(s)).on("change keyup paste",i),s=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(d),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.encryption-config.desc8")+"</div>").appendTo(s),d.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();a.attr("disabled","default"===e),"custom"===e&&a.focus(),i()}),setTimeout(function(){l.find("input[name=projects-encryption-type][value=enabled]").click(),"user"!==RED.settings.flowEncryptionType?d.find("input[name=projects-encryption-key][value=custom]").click():d.find("input[name=projects-encryption-key][value=default]").click(),i()},100),n},buttons:function(t){return[{text:RED._("common.label.back"),click:function(){s("default-files",t)}},{id:"projects-dialog-create-encryption",text:RED._(t.existingProject?"projects.encryption-config.create-project-files":"projects.encryption-config.create-project"),class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(h.credentialSecret=a.val()):h.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(h.name);var i="POST",r="projects";t.existingProject&&(h.initialise=!0,i="PUT",r="projects/"+n.name);var l=this;d({url:r,type:i,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){h={},t.existingProject?$(l).dialog("close"):(s("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log(RED._("projects.encryption-config.already-exists"))},git_error:function(e){console.log(RED._("projects.encryption-config.git-error"),e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log(RED._("projects.encryption-config.git-auth-error"),e)},"*":function(t){o(t),$(e).dialog("close")}}}},h).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"create-success":{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);return $("<p>").text(RED._("projects.create-success.success")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc0")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc1")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc2")).appendTo(o),n},buttons:[{text:RED._("common.label.done"),click:function(){$(this).dialog("close")}}]},create:function(){var t,i,a,s,r,l,c,p,u,f,h,g;return{title:RED._("projects.create.projects"),content:function(e){var o=null;g=null;var v=!1;$.getJSON("projects",function(e){o={},e.projects.forEach(function(e){o[e]=!0,v&&(v=!1,y())})});var b,m=$('<div class="projects-dialog-screen-create"></div>'),y=function(){var e=t.val(),n=!0;if(k){if(null===o)return void(v=!0);_.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||o[e]?(t.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(_),x=!1,n=!1,o[e]?u.text(RED._("projects.create.already-exists")):u.text(RED._("projects.create.must-contain"))):(t.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(_),u.text(RED._("projects.create.must-contain")),x=!0),j=e}n=x;var i=$(".projects-dialog-screen-create-type.selected").data("type");if("copy"===i)n=!1;else if("clone"===i){var s=r.val(),d=s.length>0&&!/\s/.test(s);/^https?:\/\/[^\/]+@/i.test(s)&&($("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-info-in-url")),d=!1),d?r.removeClass("input-error"):(I&&r.addClass("input-error"),n=!1),/^https?:\/\//.test(s)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(s)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===i){var c=a.val();if(""!==c&&/\.json$/.test(c)?a.hasClass("input-error")&&(a.removeClass("input-error"),a.next().empty()):(n=!1,a.hasClass("input-error")||(a.addClass("input-error"),a.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val())"custom"===$("input[name=projects-encryption-key]:checked").val()&&(n=n&&""!==l.val())}else"open"===i&&(n=!!g);$("#projects-dialog-create").prop("disabled",!n).toggleClass("disabled ui-button-disabled ui-state-disabled",!n)};b=$('<div class="form-row button-group"></div>').appendTo(m);var w=$('<button data-type="open" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>'+RED._("projects.create.open")+"</button>").appendTo(b),D=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.create.create")+"</button>").appendTo(b),E=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.create.clone")+"</button>").appendTo(b);b.find(".projects-dialog-screen-create-type").click(function(e){switch(e.preventDefault(),m.find(".projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),m.find(".projects-dialog-screen-create-row").hide(),m.find(".projects-dialog-screen-create-row-"+$(this).data("type")).show(),y(),t.focus(),$(this).data("type")){case"open":$("#projects-dialog-create").text(RED._("projects.create.open"));break;case"empty":$("#projects-dialog-create").text(RED._("projects.create.create"));break;case"clone":$("#projects-dialog-create").text(RED._("projects.create.clone"))}}),b=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-open"></div>').hide().appendTo(m),function(e){(e=e||{}).height;var t,o=$("<div></div>",{class:"projects-dialog-project-list-container"}),i="",a=$("<div>",{class:"red-ui-search-container"}).appendTo(o),s=$('<input id="projects-dialog-project-list-search" type="text" placeholder="'+RED._("projects.create-project-list.search")+'">').appendTo(a).searchBox({delay:200,change:function(){i=$(this).val().toLowerCase(),c.editableList("filter"),t&&!t.is(":visible")?(t.children().children().removeClass("selected"),(t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))):((t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))),r()}});s.on("keydown",function(n){if(40===n.keyCode){n.preventDefault();var o=t;if(t){do{o=o.next()}while(0!==o.length&&!o.is(":visible"));if(0===o.length)return;t.children().children().removeClass("selected")}else o=c.children(":visible").first();(t=o).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),r()}else if(38===n.keyCode){n.preventDefault();var i=t;if(t){do{i=i.prev()}while(0!==i.length&&!i.is(":visible"));if(0===i.length)return;t.children().children().removeClass("selected")}else i=c.children(":visible").first();(t=i).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),r()}else 13===n.keyCode&&(n.preventDefault(),t&&e.dblclick&&e.dblclick(t.children().data("data")))}),s.i18n();var r=function(){var e=c.find(".projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=l,n=t.height(),o=(t.scrollTop(),e.position().top),i=e.height();o+i>n?t.animate({scrollTop:"-="+(n-o-i)},50):o<0&&t.animate({scrollTop:"+="+o},50)}},l=$("<div></div>",{class:"projects-dialog-project-list-inner-container"}).appendTo(o),c=$("<ol>",{class:"projects-dialog-project-list"}).appendTo(l).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(o,i,a){var l=$("<div></div>",{class:"projects-dialog-project-list-entry"}).appendTo(o);if($('<span class="projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(l),$('<span class="projects-dialog-project-list-entry-name" style=""></span>').text(a.name).appendTo(l),!n||n.name!==a.name||(l.addClass("projects-list-entry-current"),$('<span class="projects-dialog-project-list-entry-current">'+RED._("projects.create-project-list.current")+"</span>").appendTo(l),!1!==e.canSelectActive)){l.addClass("selectable");var p=$('<div class="projects-dialog-project-list-entry-tools"></div>').appendTo(l);$('<button class="editor-button editor-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(p).click(function(t){t.stopPropagation(),t.preventDefault(),function(e,t,n){var o=$("<div>").css({background:"white",position:"absolute",top:0,right:0,bottom:0,left:"100%",overflow:"hidden",padding:"5px 20px",transition:"left 0.4s",whitespace:"nowrap",width:"1000px"}).click(function(e){e.stopPropagation()}).appendTo(e);$("<span>").css({lineHeight:"40px"}).text(RED._("projects.delete.confirm")).appendTo(o),$('<button style="margin-left:20px" class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(o).click(function(e){e.stopPropagation(),o.remove(),n(!0)}),$('<button style="margin-left:20px" class="editor-button primary">'+RED._("common.label.delete")+"</button>").appendTo(o).click(function(e){e.stopPropagation(),o.remove(),d({url:"projects/"+t,type:"DELETE",responses:{200:function(e){n(!1)},400:{unexpected_error:function(e){o.remove(),n(!0)}}}})}),setTimeout(function(){o.css("left",0)},50)}(o,a.name,function(t){t||o.fadeOut(300,function(){c.editableList("removeItem",a),e.delete&&e.delete(a)})})}),o.click(function(n){$(".projects-dialog-project-list-entry").removeClass("selected"),l.addClass("selected"),t=o.parent(),e.select&&e.select(a),r(),s.focus()}),e.dblclick&&o.dblclick(function(t){t.preventDefault(),e.dblclick(a)})}},filter:function(e){return""===i||-1!==e.name.toLowerCase().indexOf(i)}});return $.getJSON("projects",function(e){e.projects.forEach(function(e){c.editableList("addItem",{name:e})})}),o}({canSelectActive:!1,dblclick:function(e){g=e,$("#projects-dialog-create").click()},select:function(e){g=e,y()},delete:function(e){o&&delete o[e.name],g=null,y()}}).appendTo(b),b=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-name">'+RED._("projects.create.project-name")+"</label>").appendTo(b);var R=$('<div style="position:relative;"></div>').appendTo(b);t=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(R);var x,T,_=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(R),k=!1,j="",C="";t.on("change keyup paste",function(){if(k=t.val()!==j,T)clearTimeout(T);else if(k&&(_.empty(),$('<img src="red/images/spin.svg"/>').appendTo(_),""===t.val()))return void y();T=setTimeout(function(){y(),T=null},300)}),u=$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.create.must-contain")+"</small></label>").appendTo(b).find("small"),b=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-desc">'+RED._("projects.create.desc")+"</label>").appendTo(b),i=$('<input id="projects-dialog-screen-create-project-desc" type="text">').appendTo(b),$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.create.opt")+"</small></label>").appendTo(b),b=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-file">'+RED._("projects.create.flow-file")+"</label>").appendTo(b),R=$('<div style="position:relative;"></div>').appendTo(b),a=$('<input id="projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",y).appendTo(R),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(R),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(b),b=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(m),$("<label>"+RED._("projects.create.credentials")+"</label>").appendTo(b);var S=$('<div style="width: 550px">').appendTo(b),O=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(S),L=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(S),P=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(L);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" checked style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">'+RED._("projects.create.enable-encryption")+"</span></label>").appendTo(P);var N=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(L);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">'+RED._("projects.create.disable-encryption")+"</span></label>").appendTo(N),L.find("input[name=projects-encryption-type]").click(function(e){var t,n;"enabled"===$(this).val()?(t=P,n=N,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&l.focus()):(n=P,t=N,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),n.css({borderColor:"white",borderRightColor:"#ccc"}),y()}),b=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(O),$('<label class="projects-edit-form-inline-label">'+RED._("projects.create.encryption-key")+"</label>").appendTo(b),(l=$('<input type="password"></input>').appendTo(b)).on("change keyup paste",y),$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.create.desc0")+"</small></label>").appendTo(b),b=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(O),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.create.desc1")+"</div>").appendTo(b),O.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();l.attr("disabled","default"===e),"custom"===e&&l.focus(),y()}),b=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-repo">'+RED._("projects.create.git-url")+"</label>").appendTo(b),r=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(b),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>'+RED._("projects.create.protocols")+"</small></label>").appendTo(b);var I=!1,z="";r.on("change keyup paste",function(){I=!0;var e=$(this).val();z!==e&&$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),z=e;var n=/\/([^\/]+?)(?:\.git)?$/.exec(e);if(n){var o=t.val();""!==o&&o!==C||(C=n[1],t.val(C),t.change())}y()});var A=$('<div class="hide projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').hide().appendTo(m);b=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(A),$('<div><i class="fa fa-warning"></i> '+RED._("projects.create.auth-failed")+"</div>").appendTo(b),b=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(A);R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(b);$('<label for="projects-dialog-screen-create-project-repo-user">'+RED._("projects.create.username")+"</label>").appendTo(R),c=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(R),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(b),$('<label for="projects-dialog-screen-create-project-repo-pass">'+RED._("projects.create.password")+"</label>").appendTo(R),p=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(R),b=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(A),R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(b),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.ssh-key")+"</label>").appendTo(R),f=$("<select>",{style:"width: 100%"}).appendTo(R),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){f.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(f.addClass("input-error"),f.attr("disabled",!0),M.show()):(f.removeClass("input-error"),f.attr("disabled",!1),M.hide())}),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(b),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.passphrase")+"</label>").appendTo(R),h=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(R),R=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(A);var M=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(R);switch($('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.create.desc2")+"</div>").appendTo(M),R=$('<div style="text-align: center">').appendTo(M),$('<button class="editor-button">'+RED._("projects.create.add-ssh-key")+"</button>").appendTo(R).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),b=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(m),$("<label>"+RED._("projects.create.credentials-encryption-key")+"</label>").appendTo(b),s=$('<input type="password"></input>').appendTo(b),e.screen||"empty"){case"empty":D.click();break;case"open":w.click();break;case"clone":E.click()}return setTimeout(function(){"open"!==(e.screen||"empty")?t.focus():$("#projects-dialog-project-list-search").focus()},50),m},buttons:function(n){var u;switch(n.screen||"empty"){case"open":u=RED._("projects.create.open");break;case"empty":u=RED._("projects.create.create");break;case"clone":u=RED._("projects.create.clone")}return[{id:"projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"projects-dialog-create",text:u,class:"primary disabled",disabled:!0,click:function(){var n=$(".projects-dialog-screen-create-type.selected").data("type"),u={name:t.val()};if("empty"===n){u.summary=i.val(),u.files={flow:a.val()};var v=$("input[name=projects-encryption-type]:checked").val();u.credentialSecret="enabled"===v&&l.val()}else if("copy"===n)u.copy=(void 0).name;else if("clone"===n){u.credentialSecret=s.val();var b=r.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(b)){var m=f.val();if(!m)return void console.log(RED._("projects.create.cant-get-ssh-key-path"));u.git={remotes:{origin:{url:b,keyFile:m,passphrase:h.val()}}}}else u.git={remotes:{origin:{url:b,username:c.val(),password:p.val()}}}}else if("open"===n)return function(e,t){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e),d({url:"projects/"+e,type:"PUT",requireCleanWorkspace:!0,responses:{200:function(e){t(null,e)},400:{"*":t}}},{active:!0}).then(function(){RED.events.emit("project:change",{name:e})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}(g.name,function(t,n){e.dialog("close"),t&&"credentials_load_failed"!==t.error&&console.log(RED._("projects.create.unexpected_error"),t)});$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),c.removeClass("input-error"),p.removeClass("input-error"),f.removeClass("input-error"),h.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(u.name),d({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(t){e.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.create.already-exists-2"))},git_error:function(e){console.log(RED._("projects.create.git-error"),e)},git_connection_failed:function(e){r.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.con-failed"))},git_not_a_repository:function(e){r.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.not-git"))},git_repository_not_found:function(e){r.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-resource"))},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),c.addClass("input-error"),p.addClass("input-error"),f.addClass("input-error"),h.addClass("input-error")},missing_flow_file:function(t){e.dialog("close")},project_empty:function(t){e.dialog("close")},credentials_load_failed:function(t){e.dialog("close")},"*":function(t){o(t),$(e).dialog("close")}}}},u).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}()}}function s(n,o){e||RED.projects.init();var a=i[n],s=a.content(o||{});t.empty();var r=a.buttons;"function"==typeof r&&(r=r(o||{})),e.dialog("option","buttons",r),t.append(s),e.dialog("option","title",a.title||""),e.dialog("open"),e.dialog({position:{my:"center top",at:"center top+10%",of:window}})}function r(e){if(RED.nodes.dirty())var t=RED._("projects.require-clean.confirm"),n=RED.notify(t,{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.close(),e(!0)}},{text:RED._("common.label.cont"),click:function(){n.close(),e(!1)}}]})}function d(e,t){var o,i;if(e.requireCleanWorkspace&&RED.nodes.dirty())return r(function(n){n?e.cancel&&(e.cancel(),i&&i()):(delete e.requireCleanWorkspace,d(e,t).then(function(){o&&o()}).always(function(){i&&i()}))}),{then:function(e){return o=e,{always:function(e){i=e}}},always:function(e){i=e}};var a,s,l=Date.now();return $(".projects-dialog-spinner").show(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),t&&(e.data=JSON.stringify(t),e.contentType="application/json; charset=utf-8"),$.ajax(e).done(function(t,n,o){e.responses&&e.responses[200]&&(a=e.responses[200],s=t)}).fail(function(o,i,r){if(e.responses&&e.responses[o.status]){var l=e.responses[o.status];if("function"==typeof l)return a=l,void(s={error:l.statusText});if(!1!==e.handleAuthFail&&"git_auth_failed"===o.responseJSON.error){var c=n.git.remotes[o.responseJSON.remote||e.remote||"origin"].fetch,p=$('<div><div class="form-row">'+RED._("projects.send-req.auth-req")+':</div><div class="form-row"><div style="margin-left: 20px;">'+c+"</div></div></div>"),u=!1;if(/^https?:\/\//.test(c))$('<div class="form-row"><label for="projects-user-auth-username">'+RED._("projects.send-req.username")+'</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for=projects-user-auth-password">'+RED._("projects.send-req.password")+'</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(p);else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(c)){u=!0;var f=$('<div class="form-row"></div>').appendTo(p);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(f);var h=$('<select id="projects-user-auth-key">').width("70%").appendTo(f);$.getJSON("settings/user/keys",function(e){e.keys.forEach(function(e){h.append($("<option></option>").val(e.name).text(e.name)),0})}),f=$('<div class="form-row"></div>').appendTo(p),$('<label for="projects-user-auth-passphrase">'+RED._("projects.send-req.passphrase")+"</label>").appendTo(f),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(f)}var g=RED.notify(p,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){g.close()}},{text:'<span><i class="fa fa-refresh"></i> '+RED._("projects.send-req.retry")+"</span>",click:function(){t=t||{};var i={};u?(i.keyFile=$("#projects-user-auth-key").val(),i.passphrase=$("#projects-user-auth-passphrase").val()):(i.username=$("#projects-user-auth-username").val(),i.password=$("#projects-user-auth-password").val());var a=function(n){n?(console.log(RED._("projects.send-req.update-failed")),console.log(n)):(d(e,t),g.close())};d({url:"projects/"+n.name+"/remotes/"+(o.responseJSON.remote||e.remote||"origin"),type:"PUT",responses:{0:function(e){a(e)},200:function(e){a(null)},400:{unexpected_error:function(e){a(e)}}}},{auth:i})}}]});return}if(l[o.responseJSON.error])return a=l[o.responseJSON.error],void(s=o.responseJSON);if(l["*"])return a=l["*"],void(s=o.responseJSON)}console.log(RED._("projects.send-req.unhandled")+":"),console.log(o),console.log(i),console.log(r)}).always(function(){var e=Date.now()-l;e=Math.max(0,500-e),setTimeout(function(){$(".projects-dialog-spinner").hide(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),a&&a(s)},e)})}function l(e){var t,n="",i=[],a="",s=$('<div class="projects-branch-list">').appendTo(e.container),r=$('<input type="text">').attr("placeholder",e.placeholder).appendTo(s).searchBox({delay:200,change:function(){n=$(this).val(),/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(n)?(t.hasClass("input-error")||(t.addClass("input-error"),t.find("i").addClass("fa-warning").removeClass("fa-code-fork")),t.find("span").text(RED._("projects.create-branch-list.invalid")+": "+a+n)):(t.hasClass("input-error")&&(t.removeClass("input-error"),t.find("i").removeClass("fa-warning").addClass("fa-code-fork")),t.find(".sidebar-version-control-branch-list-entry-create-name").text(a+n)),l.editableList("filter")}}),l=$("<ol>",{style:"height: 130px;"}).appendTo(s);return l.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(n,o,i){var a=$('<div class="sidebar-version-control-branch-list-entry">').appendTo(n);i.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(a),$("<span>").text(i.name).appendTo(a),i.current&&(a.addClass("selected"),$('<span class="current"></span>').text(e.currentLabel||RED._("projects.create-branch-list.current")).appendTo(a))):(t=a,$('<i class="fa fa-code-fork"></i>').appendTo(a),$("<span>").text(RED._("projects.create-branch-list.create")+":").appendTo(a),$('<div class="sidebar-version-control-branch-list-entry-create-name" style="margin-left: 10px;">').text(i.name).appendTo(a)),a.click(function(t){if(t.preventDefault(),!$(this).hasClass("input-error")){var n={};i.hasOwnProperty("commit")?($(this).hasClass("selected")&&(n.current=!0),n.name=i.name):(n.name=r.val(),n.create=!0,e.remote&&(n.name=e.remote()+"/"+n.name)),e.onselect&&e.onselect(n)}})},filter:function(e){var t=!e.hasOwnProperty("commit");return t&&""!==n&&-1===i.indexOf(a+n)||!t&&-1!==e.name.indexOf(n)}}),{refresh:function(t){r.searchBox("value",""),l.editableList("empty");var n=Date.now(),p=c(s).addClass("projects-dialog-spinner-contain");a=e.remote?e.remote()+"/":"",d({url:t,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){i=e.branches,e.branches.forEach(function(e){l.editableList("addItem",e)}),l.editableList("addItem",{}),setTimeout(function(){p.remove()},Math.max(300-(Date.now()-n),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){o(e)}}}})},filter:function(){l.editableList("filter")},focus:function(){r.focus()}}}function c(e){return $('<div class="projects-dialog-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function p(){createProjectOptions={},n?s("create",{screen:"empty"}):s("welcome")}return{init:function(){e=$('<div id="projects-dialog" class="hide node-red-dialog projects-edit-form"><form class="form-horizontal"></form><div class="projects-dialog-spinner hide"><img src="red/images/spin.svg"/></div></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),t=e.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var n={sendRequest:d,createBranchList:l,addSpinnerOverlay:c,reportUnexpectedError:o};RED.projects.settings.init(n),RED.projects.userSettings.init(n),RED.sidebar.versionControl.init(n),a()},showStartup:function(){RED.user.hasPermission("projects.write")?s("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?r(function(e){e||p()}):void p();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){RED.user.hasPermission("projects.write")?s("create",{screen:"open"}):RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!n)throw new Error(RED._("projects.create-default-file-set.no-active"));if(!n.empty)throw new Error(RED._("projects.create-default-file-set.no-empty"));RED.user.hasPermission("projects.write")?(createProjectOptions={},s("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(n.name),d({url:"projects/"+n.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log(RED._("projects.create-default-file-set.git-error"),e)},missing_flow_file:function(t){$(e).dialog("close")},"*":function(t){o(t),$(e).dialog("close")}}}},{initialise:!0}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})},refresh:function(e){$.getJSON("projects",function(t){t.active?$.getJSON("projects/"+t.active,function(t){n=t,RED.sidebar.versionControl.refresh(!0),e&&e(n)}):e&&e(null)})},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return n}}}(),RED.projects.settings=function(){var e,t,n=700,o=!1,i=[];function a(e){i.push(e)}function s(e,t){var n,o;t.empty(),n=e.description?marked(e.description):'<span class="node-info-none">No description available</span>',(o=$('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(n)+'">'+n+"</span>"),$(o).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),o).appendTo(t).find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>")}function r(e,t){t.empty(),e?t.text(e).removeClass("node-info-node"):t.text(RED._("sidebar.project.projectSettings.noSummaryAvailable")).addClass("node-info-none")}function d(e){var n=$('<div id="project-settings-tab-main" class="project-settings-tab-pane node-help"></div>');$("<h1>").text(e.name).appendTo(n);var o=$('<div style="position: relative">').appendTo(n),i=$("<div></div>",{style:"color: #999"}).appendTo(o);r(e.summary,i),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">'+RED._("sidebar.project.editDescription")+"</button>").prependTo(o).click(function(n){n.preventDefault(),function e(n,o,i){var a=i.prev();a.hide(),i.empty();var s=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(i),d=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(o||"").appendTo(i);$('<button class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(s).click(function(e){e.preventDefault(),r(n.summary,i),a.show()}),$('<button class="editor-button">'+RED._("common.label.save")+"</button>").appendTo(s).click(function(s){s.preventDefault();var l=d.val();r(l,i);var c=t.addSpinnerOverlay(i),p=function(t,s){if(t)return c.remove(),e(n,o,i);n.summary=l,c.remove(),r(n.summary,i),a.show()};t.sendRequest({url:"projects/"+n.name,type:"PUT",responses:{0:function(e){p(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),p(null)},400:{"*":function(e){t.reportUnexpectedError(e),p(e)}}}},{summary:l})})}(e,e.summary,i)}),$("<hr>").appendTo(n);var a=$('<div class="node-help" style="position: relative"></div>').appendTo(n),d=$("<div>",{style:"min-height: 200px"}).appendTo(a);return s(e,d),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">'+RED._("sidebar.project.editReadme")+"</button>").prependTo(a).click(function(n){n.preventDefault(),function e(n,o){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:n.description,complete:function(i){o.empty();var a=t.addSpinnerOverlay(o),r=function(t,a){if(t)return e(n,o);n.description=i,s(n,o)};t.sendRequest({url:"projects/"+n.name,type:"PUT",responses:{0:function(e){r(e)},200:function(e){r(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){t.reportUnexpectedError(e),r(e)}}}},{description:i}).always(function(){a.remove()})}})}(e,d)}),n}function l(e,t){t.editableList("empty");var n=0;for(var o in v)v.hasOwnProperty(o)&&(t.editableList("addItem",{id:v[o].module,version:v[o].version,count:v[o].count,known:e.dependencies.hasOwnProperty(o),installed:!0}),n++,0===v[o].count&&0,e.dependencies.hasOwnProperty(o)||0);if(e.dependencies)for(var o in e.dependencies)if(e.dependencies.hasOwnProperty(o)&&!v.hasOwnProperty(o)){var i=!!RED.nodes.registry.getModule(o);t.editableList("addItem",{id:o,version:e.dependencies[o],count:0,known:!0,installed:i}),n++,i?0:0}0===n&&t.editableList("addItem",{index:0,label:RED._("sidebar.project.projectSettings.none")})}function c(e,n,o,i){var a=RED.projects.getActiveProject(),s=t.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),r=function(e,t){if(s.remove(),e)return i(e);a.dependencies=o,RED.sidebar.versionControl.refresh(!0),i()};t.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){r(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),r(null)},400:{"*":function(e){r(e)}}}},{dependencies:o})}function p(e){var t=$('<div id="project-settings-tab-deps" class="project-settings-tab-pane node-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="margin-top:10px;float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(t).click(function(o){o.preventDefault(),function e(t,n,o,i){var a=n||JSON.stringify(t.dependencies||{},"",4);"{}"===a&&(a="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:a,requireValid:!0,complete:function(n){try{var a=JSON.parse(n);c(0,o,a,function(s){if(s)return e(t,n,o,i);t.dependencies=a,l(t,i)})}catch(a){e(t,n,o,i)}}})}(e,null,t,n)});var n=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return n.editableList({addButton:!1,addItem:function(t,o,i){var a=$("<div>",{class:"palette-module-header"}).appendTo(t);if(i.label)0===i.index?a.addClass("red-ui-search-empty"):t.parent().addClass("palette-module-section"),a.text(i.label);else{a.addClass("palette-module-header"),i.installed?0===i.count?a.addClass("palette-module-unused"):i.known||a.addClass("palette-module-unknown"):a.addClass("palette-module-not-installed"),i.element=a;var s=$('<div class="palette-module-meta palette-module-name"></div>').appendTo(a),r="fa-cube";i.installed||(r="fa-warning");var d=$('<i class="fa '+r+'"></i>').appendTo(s);i.icon=d,$("<span>").text(i.id).appendTo(s);var l=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(a);$("<span>").text(i.version).appendTo(l);l=$('<div class="palette-module-meta"></div>').appendTo(a);var p=$('<div class="palette-module-button-group"></div>').appendTo(l);RED.user.hasPermission("projects.write")&&(i.installed||!1===RED.settings.theme("palette.editable")?i.known&&0===i.count?$('<a href="#" class="editor-button editor-button-small">'+RED._("sidebar.project.projectSettings.removeFromProject")+"</a>").appendTo(p).click(function(o){o.preventDefault();var a=$.extend(!0,{},e.dependencies);delete a[i.id],c(0,t,a,function(e){e?console.log(e):t.fadeOut(200,function(){n.editableList("removeItem",i)})})}):i.known||$('<a href="#" class="editor-button editor-button-small">'+RED._("sidebar.project.projectSettings.addToProject")+"</a>").appendTo(p).click(function(n){n.preventDefault();var o=$.extend(!0,{},e.dependencies);o[i.id]=v[i.id].version,c(0,t,o,function(e){e?console.log(e):(p.remove(),a.removeClass("palette-module-unknown"))})}):$('<a href="#" class="editor-button editor-button-small">'+RED._("sidebar.project.projectSettings.install")+"</a>").appendTo(p).click(function(e){e.preventDefault(),RED.palette.editor.install(i,t,function(e){if(!e){i.installed=!0;RED.utils.addSpinnerOverlay(t,!0);setTimeout(function(){n.editableList("removeItem",i),v={},RED.nodes.eachNode(g),RED.nodes.eachConfig(g),i.count=v[i.id].count,n.editableList("addItem",i)},500)}})}))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),l(e,n),t}function u(e,n,o,i,a){var s=$('<div class="project-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),r=t.addSpinnerOverlay(s);return $.getJSON("projects/"+n.name+"/files",function(e){var t=Object.keys(e);t=t.filter(function(t){return!e[t].status||!/D/.test(e[t].status)});var n={};t.sort(),t.forEach(function(e){e.split("/").reduce(function(e,t,n,o){if(t)return n<o.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]},n)});var d=function(e,t,n){var o={name:e||"/",path:n+(n?"/":"")+e};return!0===t?(o.type="f",o):(o.type="d",o.children=[],o.path=o.path,Object.keys(t).forEach(function(e){o.children.push(d(e,t[e],o.path))}),o.children.sort(function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)}),o)};n=d("",n,"");!function e(t,n,o,i,a,s){s=s||"";var r=$("<ol>",{class:"projects-dialog-file-list",style:s}).appendTo(t).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,n,s){var r=$("<div></div>",{class:"projects-dialog-file-list-entry"}).appendTo(t);if(s.children){if($('<span class="projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(r),s.children.length>0){var d=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(t);0===o.indexOf(s.path+"/")?r.addClass("expanded"):d.hide(),e(d,s.children,o,i,a),r.addClass("selectable"),r.click(function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),d.slideUp(200)):($(this).addClass("expanded"),d.slideDown(200))})}}else{var l="fa-file-o";/\.json$/i.test(s.name)?l="fa-file-code-o":/\.md$/i.test(s.name)?l="fa-book":/^\.git/i.test(s.name)&&(l="fa-code-fork",r.addClass("projects-dialog-file-list-entry-file-type-git")),$('<span class="projects-dialog-file-list-entry-file"> <i class="fa '+l+'"></i></span>').appendTo(r),i.test(s.name)?(r.addClass("selectable"),s.path===o&&r.addClass("selected"),r.click(function(e){$(".projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),a(s.path)}),r.dblclick(function(e){e.preventDefault(),a(s.path,!0)})):r.addClass("unselectable")}$('<span class="projects-dialog-file-list-entry-name" style=""></span>').text(s.name).appendTo(r)}});s||r.parent().css("overflow-y","");n.forEach(function(e){r.editableList("addItem",e)})}(s,n.children,o,i,a,"height: 175px"),r.remove()}),s}function f(e,n){$("<h3></h3>").text(RED._("sidebar.project.projectSettings.versionControl")).appendTo(n),function(e,n){var o=$('<div class="user-settings-section"></div>').appendTo(n);$("<h4></h4>").text(RED._("sidebar.project.projectSettings.branches")).appendTo(o);var i=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(o),a=$("<ol>").appendTo(i).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(n,o,i){var s=$('<div class="projects-dialog-list-entry">').appendTo(n);if(i.empty)return s.addClass("red-ui-search-empty"),void s.text(RED._("sidebar.project.projectSettings.noBranches"));i.current&&s.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(s);var r=$("<span>").appendTo(s),d=$("<div>").appendTo(r);if($('<span class="entry-name">').text(i.name).appendTo(d),i.commit&&$('<span class="entry-detail">').text(i.commit.sha).appendTo(d),i.remote){var l=$("<div>").appendTo(r);$('<span class="entry-detail entry-remote-name">').text(i.remote||"").appendTo(l),i.status.ahead+i.status.behind>0&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+i.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+i.status.behind+"</span></span>").appendTo(l)}if(!i.current){var c=$('<span class="entry-tools">').appendTo(s);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(c).click(function(o){o.preventDefault();var s=t.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),r=RED.notify(RED._("sidebar.project.projectSettings.deleteConfirm",{name:i.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){s.remove(),r.close()}},{text:"Delete branch",click:function(){r.close();var o={url:"projects/"+e.name+"/branches/"+i.name,type:"DELETE",responses:{200:function(e){n.fadeOut(200,function(){a.editableList("removeItem",i),s.remove()})},400:{git_delete_branch_unmerged:function(e){r=RED.notify(RED._("sidebar.project.projectSettings.unmergedConfirm",{name:i.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){s.remove(),r.close()}},{text:RED._("sidebar.project.projectSettings.deleteUnmergedBranch"),click:function(){o.url+="?force=true",r.close(),t.sendRequest(o)}}]})},"*":function(e){t.reportUnexpectedError(e),s.remove()}}}};t.sendRequest(o)}}]})})}}});$.getJSON("projects/"+e.name+"/branches",function(e){e.branches&&(e.branches.length>0?(e.branches.sort(function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)}),e.branches.forEach(function(e){a.editableList("addItem",e)})):a.editableList("addItem",{empty:!0}))})}(e,n);var o=$('<div class="user-settings-section"></div>').appendTo(n),i=$("<h4></h4>").text(RED._("sidebar.project.projectSettings.gitRemotes")).appendTo(o),a=$('<button class="editor-button editor-button-small" style="float: right; margin-right: 10px;">'+RED._("sidebar.project.projectSettings.addRemote")+"</button>").appendTo(i).click(function(e){a.attr("disabled",!0),l.slideDown(200,function(){l[0].scrollIntoView(),r?(g.val("origin"),v.focus()):g.focus(),u()})}),s={empty:!0},r=!0,d=$('<div class="user-settings-row"></div>').appendTo(o),l=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(d);d=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(o);var c=$("<ol>").appendTo(d);c.editableList({addButton:!1,height:"auto",addItem:function(n,o,i){var a=$('<div class="projects-dialog-list-entry">').appendTo(n);if(i.empty)return a.addClass("red-ui-search-empty"),void a.text(RED._("sidebar.project.projectSettings.noRemotes"));$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(a);var d=$("<span>").appendTo(a);$('<div class="entry-name">').text(i.name).appendTo(d),i.urls.fetch===i.urls.push?$('<div class="entry-detail">').text(i.urls.fetch).appendTo(d):($('<div class="entry-detail">').text("fetch: "+i.urls.fetch).appendTo(d),$('<div class="entry-detail">').text("push: "+i.urls.push).appendTo(d));var l=$('<span class="entry-tools">').appendTo(a);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(l).click(function(o){o.preventDefault();var a=t.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),d=RED.notify(RED._("sidebar.project.projectSettings.deleteRemoteConfrim",{name:i.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.remove(),d.close()}},{text:RED._("sidebar.project.projectSettings.deleteRemote"),click:function(){d.close(),e.git.branches.remote&&0===e.git.branches.remote.indexOf(i.name+"/")&&delete e.git.branches.remote,e.git.branches.remoteAlt&&0===e.git.branches.remoteAlt.indexOf(i.name+"/")&&delete e.git.branches.remoteAlt;var o={url:"projects/"+e.name+"/remotes/"+i.name,type:"DELETE",responses:{200:function(t){n.fadeOut(200,function(){c.editableList("removeItem",i),setTimeout(a.remove,100),0===t.remotes.length?(delete e.git.remotes,r=!0,c.editableList("addItem",s)):(e.git.remotes={},t.remotes.forEach(function(t){var n=t.name;delete t.name,e.git.remotes[n]=t})),delete e.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()})},400:{"*":function(e){t.reportUnexpectedError(e),a.remove()}}}};t.sendRequest(o)}}]})})}});var p,u=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(g.val()),t=v.val(),n=t.length>0&&!/\s/.test(t);/^https?:\/\/[^\/]+@/i.test(t)?(b.text(RED._("sidebar.project.projectSettings.urlRule2")),n=!1):b.text(RED._("sidebar.project.projectSettings.urlRule")),w.attr("disabled",!e||!n),g.toggleClass("input-error",f&&!e),v.toggleClass("input-error",h&&!n),p&&(p.close(),p=null)},f=!1,h=!1;$('<div class="projects-dialog-list-dialog-header">').text(RED._("sidebar.project.projectSettings.addRemote2")).appendTo(l),d=$('<div class="user-settings-row"></div>').appendTo(l),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.remoteName")).appendTo(d);var g=$('<input type="text">').appendTo(d).on("change keyup paste",function(){f=!0,u()});$('<label class="projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.nameRule")+"</small></label>").appendTo(d).find("small"),d=$('<div class="user-settings-row"></div>').appendTo(l),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.url")).appendTo(d);var v=$('<input type="text">').appendTo(d).on("change keyup paste",function(){h=!0,u()}),b=$('<label class="projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.urlRule")+"</small></label>").appendTo(d).find("small"),m=function(){a.attr("disabled",!1),l.hide(),g.val(""),v.val(""),p&&(p.close(),p=null)},y=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(y).click(function(e){e.preventDefault(),m()});var w=$('<button class="editor-button">'+RED._("sidebar.project.projectSettings.addRemote2")+"</button>").appendTo(y).click(function(n){n.preventDefault();var o=t.addSpinnerOverlay(l).addClass("projects-dialog-spinner-contain"),i={name:g.val(),url:v.val()},a=function(e){o.remove(),e||m()};RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+e.name+"/remotes",type:"POST",responses:{0:function(e){a(e)},200:function(t){e.git.remotes={},t.remotes.forEach(function(t){var n=t.name;delete t.name,e.git.remotes[n]=t}),D(),RED.sidebar.versionControl.refresh(),a()},400:{git_remote_already_exists:function(e){p=RED.popover.create({target:g,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),g.addClass("input-error"),a(e)},"*":function(e){t.reportUnexpectedError(e),a(e)}}}},i)}),D=function(){c.editableList("empty");var t=0;if(e.git.hasOwnProperty("remotes"))for(var n in e.git.remotes)e.git.remotes.hasOwnProperty(n)&&(t++,c.editableList("addItem",{name:n,urls:e.git.remotes[n]}));(r=0===t)&&c.editableList("addItem",s)};D()}function h(n){var o=$('<div id="project-settings-tab-settings" class="project-settings-tab-pane node-help"></div>');return function(n,o){var i,a=$("<h3></h3>").text(RED._("sidebar.project.projectSettings.files")).appendTo(o),s=$('<div class="user-settings-section"></div>').appendTo(o);if(RED.user.hasPermission("projects.write"))var r=$('<button class="editor-button editor-button-small" style="float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(a).click(function(e){e.preventDefault(),S.show(),r.hide(),l.hide(),c.show(),p.show(),f.hide(),h.show(),c.focus(),v.addClass("uneditable-input"),$(".user-settings-row-credentials").show(),v.css("height","auto"),w.hide(),b.show()});i=$('<div class="user-settings-row"></div>').appendTo(s),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.flow")).appendTo(i);var d=$('<div class="uneditable-input" style="padding:0">').appendTo(i),l=$('<span style="display:inline-block; padding: 6px">').text(n.files.flow).appendTo(d),c=$('<input id="" type="text" style="margin-bottom: 0;width: 100%; border: none;">').val(n.files.flow).hide().appendTo(d),p=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(d).click(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),d.find(".project-file-listing-container").slideUp(200,function(){$(this).remove(),d.css("height","")}),d.css("color","");else{$(this).addClass("selected"),d.css("color","inherit");var t=u(d,n,c.val(),/.*\.json$/,function(e,t){e&&c.val(e),t&&$(p).click(),g()});d.css("height","auto"),setTimeout(function(){t.slideDown(200)},50)}});i=$('<div class="user-settings-row"></div>').appendTo(s),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.credentials")).appendTo(i);var f=$('<div class="uneditable-input">').text(n.files.credentials).appendTo(i),h=$('<div class="uneditable-input">').text(n.files.credentials).hide().insertAfter(f),g=function(){var e,t=c.val(),n=/^(.+?)(\.[^.]*)?$/.exec(t);n?h.text(n[1]+"_cred"+(n[2]||".json")):""===t&&h.text("");var o=""===t||/\.\./.test(t)||/\/$/.test(t);e=o||""===h.text(),T.is(":visible")&&(T.toggleClass("input-error",""===T.val()),e=e||""===T.val()),k.is(":visible")&&(k.toggleClass("input-error",""===k.val()),e=e||""===k.val()),c.toggleClass("input-error",o),h.toggleClass("input-error",""===h.text()),O.toggleClass("disabled",e),O.prop("disabled",e)};c.on("change keyup paste",g),n.files.flow||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(l),n.files.credentials||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(f),i=$('<div class="user-settings-row"></div>').appendTo(s),$("<label></label>").appendTo(i);var v=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(i),b=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(i);v.css("color","#666"),b.css("vertical-align","top");var m=$('<button class="editor-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(b).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),w.hide()):(k.val(""),x.hide(),_.show(),$(this).addClass("selected"),y.removeClass("selected"),R.show(),j.show(),D.hide(),E.hide(),w.show()),g()}),y=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(b).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),w.hide()):(T.val(""),k.val(""),n.settings.credentialSecretInvalid||!n.settings.credentialsEncrypted?(D.show(),E.hide(),x.hide()):(x.show(),D.hide(),E.show()),_.show(),y.addClass("selected"),m.removeClass("selected"),R.hide(),j.hide(),w.show()),g()});i=$('<div class="user-settings-row user-settings-row-credentials"></div>').hide().appendTo(s);var w=$("<div>",{style:"margin-top:10px"}).hide().appendTo(v),D=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.setTheEncryptionKey")+"</div>").hide().appendTo(w),E=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.changeTheEncryptionKey")+"</div>").hide().appendTo(w),R=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.resetTheEncryptionKey")+"</div>").hide().appendTo(w),x=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(w);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.currentKey")).appendTo(x);var T=$('<input type="password">').appendTo(x).on("change keyup paste",function(){e&&(e.close(),e=null),g()}),_=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(w);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.newKey")).appendTo(_);var k=$('<input type="password">').appendTo(_).on("change keyup paste",g),j=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i>'+RED._("sidebar.project.projectSettings.credentialsAlert")+"</div>").hide().appendTo(w),C=function(){r.show(),S.hide(),l.show(),c.hide(),p.hide(),f.show(),h.hide(),v.removeClass("uneditable-input"),v.css("height",""),p.removeClass("selected"),d.find(".project-file-listing-container").remove(),d.css("height",""),d.css("color",""),$(".user-settings-row-credentials").hide(),w.hide(),b.hide(),m.removeClass("selected"),y.removeClass("selected")},S=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(s);$('<button class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(S).click(function(e){e.preventDefault(),C()});var O=$('<button class="editor-button">'+RED._("common.label.save")+"</button>").appendTo(S).click(function(o){o.preventDefault();var i=t.addSpinnerOverlay(s),a=function(e){i.remove(),e?t.reportUnexpectedError(e):(l.text(c.val()),f.text(h.text()),C())},r={files:{flow:c.val(),credentials:h.text()}};m.hasClass("selected")&&(r.resetCredentialSecret=!0),(m.hasClass("selected")||y.hasClass("selected"))&&(r.credentialSecret=k.val(),T.is(":visible")&&(r.currentCredentialSecret=T.val())),RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+n.name,type:"PUT",responses:{0:function(e){a(e)},200:function(e){n=e,RED.sidebar.versionControl.refresh(!0),L(),a()},400:{credentials_load_failed:function(e){a(e)},missing_current_credential_key:function(t){T.addClass("input-error"),e=RED.popover.create({target:T,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),a(t)},"*":function(e){a(e)}}}},r).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),L=function(){n.settings.credentialSecretInvalid?(v.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),v.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.invalidEncryptionKey"))):n.settings.credentialsEncrypted?(v.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),v.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionEnabled"))):(v.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),v.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionDisabled"))),m.toggleClass("disabled",!n.settings.credentialSecretInvalid&&!n.settings.credentialsEncrypted),m.prop("disabled",!n.settings.credentialSecretInvalid&&!n.settings.credentialsEncrypted)};g(),L()}(n,o),f(n,o),o}function g(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(v.hasOwnProperty(t)||(v[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),v[t].count++)}}var v={};return{init:function(n){t=n,a({id:"main",title:RED._("sidebar.project.name"),get:d,close:function(){}}),a({id:"deps",title:RED._("sidebar.project.dependencies"),get:p,close:function(){}}),a({id:"settings",title:RED._("sidebar.project.settings"),get:h,close:function(){e&&(e.close(),e=null)}}),RED.events.on("nodes:add",g),RED.events.on("nodes:remove",function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&v.hasOwnProperty(t)&&(v[t].count--,0===v[t].count&&(v[t].known||delete v[t]))}})},show:function(e){if(!o)if(RED.user.hasPermission("projects.write")){o=!0;var t={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){n=e.width},open:function(t){var n=RED.projects.getActiveProject(),o=t.find(".editor-tray-body"),a=$("<div></div>").appendTo(o),s=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(a);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(s);var r=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),d=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(a);i.forEach(function(e){r.addTab({id:"project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(n).hide().appendTo(d)}),a.i18n(),r.activateTab("project-settings-tab-"+(e||"main")),$("#sidebar-shade").show()},close:function(){o=!1,i.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==n&&(t.width=n),RED.tray.show(t)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){v={}}}}(),RED.projects.userSettings=function(){var e,t,n;function o(o){var i=$('<div id="user-settings-tab-gitconfig" class="project-settings-tab-pane node-help"></div>');return function(n){var o=RED.settings.get("git")||{};o.user=o.user||{},$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.committerDetail")).appendTo(n);var i=$('<div class="user-settings-section"></div>').appendTo(n);$('<div style="color:#aaa;"></div>').appendTo(i).text(RED._("editor:sidebar.project.userSettings.committerTip"));var a=$('<div class="user-settings-row"></div>').appendTo(i);$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.userName")).appendTo(a),(e=$('<input type="text">').appendTo(a)).val(o.user.name||""),a=$('<div class="user-settings-row"></div>').appendTo(i),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.email")).appendTo(a),(t=$('<input type="text">').appendTo(a)).val(o.user.email||"")}(i),function(e){var o,i=$('<div class="user-settings-section"></div>').appendTo(e),a=($("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.sshKeys")).appendTo(i),$('<div style="color:#aaa;"></div>').appendTo(i).text(RED._("editor:sidebar.project.userSettings.sshKeysTip"))),s=$('<button id="user-settings-gitconfig-add-key" class="editor-button editor-button-small" style="float: right; margin-right: 10px;">'+RED._("editor:sidebar.project.userSettings.add")+"</button>").appendTo(a).click(function(e){s.attr("disabled",!0),m.attr("disabled",!0),l.slideDown(200),u.focus()}),r=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(u.val());u.toggleClass("input-error",p&&!e);var t=h.val(),n=0===t.length||t.length>=8;h.toggleClass("input-error",!n),n?0===t.length?g.text(RED._("editor:sidebar.project.userSettings.optional")):g.text(""):g.text(RED._("editor:sidebar.project.userSettings.passphraseShort")),e=e&&n,m.attr("disabled",!e),o&&(o.close(),o=null)},d=$('<div class="user-settings-row"></div>').appendTo(i),l=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(d);$('<div class="projects-dialog-list-dialog-header">').text(RED._("editor:sidebar.project.userSettings.addSshKey")).appendTo(l);var c=$("<div>").appendTo(l);d=$('<div class="user-settings-row"></div>').appendTo(c),$('<div style="color:#aaa;"></div>').appendTo(d).text(RED._("editor:sidebar.project.userSettings.addSshKeyTip")),d=$('<div class="user-settings-row"></div>').appendTo(c),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.name")).appendTo(d);var p=!1,u=$('<input type="text">').appendTo(d).on("change keyup paste",function(){p=!0,r()});$('<label class="projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.nameRule")+"</small></label>").appendTo(d).find("small");var f=$("<div>").appendTo(c);d=$('<div class="user-settings-row"></div>').appendTo(f),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.passphrase")).appendTo(d);var h=$('<input type="password">').appendTo(d).on("change keyup paste",r),g=$('<label class="projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.optional")+"</small></label>").appendTo(d).find("small"),v=function(){s.attr("disabled",!1),l.hide(),u.val(""),p=!1,h.val(""),o&&(o.close(),o=null)},b=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="editor-button">'+RED._("editor:sidebar.project.userSettings.cancel")+"</button>").appendTo(b).click(function(e){e.preventDefault(),v()});var m=$('<button class="editor-button">'+RED._("editor:sidebar.project.userSettings.generate")+"</button>").appendTo(b).click(function(e){e.preventDefault();var o=n.addSpinnerOverlay(l).addClass("projects-dialog-spinner-contain"),i={name:u.val(),type:"generate"};i.comment=t.val(),i.password=h.val(),i.size=4096;var a=function(e){o.remove(),e||v()};RED.deploy.setDeployInflight(!0),n.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){a(e)},200:function(e){E(i.name),a()},400:{unexpected_error:function(e){console.log(e),a(e)}}}},i)});d=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(i);var y={empty:!0},w=function(e,t){var o=$('<div class="projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),i=$("<pre>",{style:"min-height: 80px"}).appendTo(o),a=n.addSpinnerOverlay(i).addClass("projects-dialog-spinner-contain"),s={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){i.text(e.publickey),a.remove()},400:{unexpected_error:function(e){console.log(e),a.remove()}}}};n.sendRequest(s);var r=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(o);return $('<button class="editor-button editor-button-small">'+RED._("editor:sidebar.project.userSettings.copyPublicKey")+"</button>").appendTo(r).click(function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(i[0]),document.execCommand("copy"),document.getSelection().empty()}catch(e){}}),o},D=$('<ol class="projects-dialog-ssh-key-list">').appendTo(d).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){var i=$('<div class="projects-dialog-list-entry">').appendTo(e);if(o.empty)return i.addClass("red-ui-search-empty"),void i.text(RED._("editor:sidebar.project.userSettings.noSshKeys"));var a=$('<div class="projects-dialog-ssh-key-header">').appendTo(i);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(a),$('<span class="entry-name">').text(o.name).appendTo(a);var s,r=$('<span class="button-row entry-tools">').appendTo(a);a.click(function(e){s?s.slideUp(200,function(){s.remove(),s=null}):s=w(i,o)}),o.system||$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).click(function(t){t.stopPropagation();var i=n.addSpinnerOverlay(e).addClass("projects-dialog-spinner-contain"),a=RED.notify(RED._("editor:sidebar.project.userSettings.deleteConfirm",{name:o.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.remove(),a.close()}},{text:RED._("editor:sidebar.project.userSettings.delete"),click:function(){a.close();var t={url:"settings/user/keys/"+o.name,type:"DELETE",responses:{200:function(t){e.fadeOut(200,function(){D.editableList("removeItem",o),setTimeout(i.remove,100),0===D.editableList("length")&&D.editableList("addItem",y)})},400:{unexpected_error:function(e){console.log(e),i.remove()}}}};n.sendRequest(t)}}]})}),o.expand&&(s=w(i,o))}}),E=function(e){$.getJSON("settings/user/keys",function(t){t.keys&&(t.keys.sort(function(e,t){return e.name.localeCompare(t.name)}),D.editableList("empty"),t.keys.forEach(function(t){t.name===e&&(t.expand=!0),D.editableList("addItem",t)}),0===D.editableList("length")&&D.editableList("addItem",y))})};E()}(i),i}return{init:function(i){n=i,RED.userSettings.add({id:"gitconfig",title:RED._("editor:sidebar.project.userSettings.gitConfig"),get:o,close:function(){var n=RED.settings.get("git")||{};n.user=n.user||{},n.user.name=e.val(),n.user.email=t.val(),RED.settings.set("git",n)}})}}}(),RED.sidebar.versionControl=function(){var e,t,n,o,i,a,s,r,d,l,c,p,u,f,h,g,v,b={};function m(e,t,n,o){e.addClass("sidebar-version-control-change-entry");var i=$("<div>").appendTo(e);if(t.label){if(e.addClass("node-info-none"),i.text(t.label),t.button){i.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var a=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(i);$('<button class="editor-button editor-button-small"></button>').text(t.button.label).appendTo(a).click(t.button.click)}}else{var s,r,d=$('<i class=""></i>').appendTo(i),l=$('<a href="#">').appendTo(i).click(function(e){e.preventDefault(),function(e,t){var n=RED.projects.getActiveProject(),o="staged"===t?"index":"tree";h.sendRequest({url:"projects/"+n.name+"/diff/"+o+"/"+encodeURIComponent(e.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(o){var i;i="unstaged"===t?RED._("sidebar.project.versionControl.unstagedChanges")+" : "+e.file:"staged"===t?RED._("sidebar.project.versionControl.stagedChanges")+" : "+e.file:RED._("sidebar.project.versionControl.resolveConflicts")+" : "+e.file;var a={diff:o.diff,title:i,unmerged:"unmerged"===t,project:n};"unstaged"==t?(a.oldRevTitle=" "===e.indexStatus?RED._("sidebar.project.versionControl.head"):RED._("sidebar.project.versionControl.staged"),a.newRevTitle=RED._("sidebar.project.versionControl.unstaged"),a.oldRev=" "===e.indexStatus?"@":":0",a.newRev="_"):"staged"===t?(a.oldRevTitle=RED._("sidebar.project.versionControl.head"),a.newRevTitle=RED._("sidebar.project.versionControl.staged"),a.oldRev="@",a.newRev=":0"):(a.oldRevTitle=RED._("sidebar.project.versionControl.local"),a.newRevTitle=RED._("sidebar.project.versionControl.remote"),a.commonRev=":1",a.oldRev=":2",a.newRev=":3",a.onresolve=function(t){h.sendRequest({url:"projects/"+n.name+"/resolve/"+encodeURIComponent(e.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:t.resolutions[e.file]})}),RED.diff.showUnifiedDiff(a)},400:{unexpected_error:function(e){console.log(e)}}}})}(t,o)}),c=$("<span>").appendTo(l),p=$('<div class="sidebar-version-control-change-entry-tools">').appendTo(e);"unstaged"===o&&(s=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(p),r=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(s).click(function(e){e.preventDefault();var n=h.addSpinnerOverlay(i).addClass("projects-dialog-spinner-contain"),o=RED.notify(RED._("sidebar.project.versionControl.revert",{file:t.file}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.remove(),o.close()}},{text:RED._("sidebar.project.versionControl.revertChanges"),click:function(){o.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+t.file,type:"DELETE",responses:{200:function(e){n.remove()},400:{unexpected_error:function(e){n.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),h.sendRequest(e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]})})),s=$('<span class="button-group"></span>').appendTo(p),"unmerged"!==o&&$('<button class="editor-button editor-button-small"><i class="fa fa-'+("unstaged"===o?"plus":"minus")+'"></i></button>').appendTo(s).click(function(n){n.preventDefault();var i=RED.projects.getActiveProject();t.spinner=h.addSpinnerOverlay(e).addClass("projects-version-control-spinner-sidebar"),h.sendRequest({url:"projects/"+i.name+"/stage/"+encodeURIComponent(t.file),type:"unstaged"===o?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})}),t["update"+("unstaged"===o?"Unstaged":"Staged")]=function(e,t){i.removeClass();var n="";"A"===t?(i.addClass("node-diff-added"),n="fa-plus-square"):"?"===t?(i.addClass("node-diff-unchanged"),n="fa-question-circle-o"):"D"===t?(i.addClass("node-diff-deleted"),n="fa-minus-square"):"M"===t?(i.addClass("node-diff-changed"),n="fa-square"):"R"===t?(i.addClass("node-diff-changed"),n="fa-toggle-right"):"U"===t?(i.addClass("node-diff-conflicted"),n="fa-exclamation-triangle"):n="fa-exclamation-triangle",c.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(c),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(c),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(c)),d.removeClass(),d.addClass("fa "+n),e.spinner&&(e.spinner.remove(),delete e.spinner),r&&r.toggle("?"!==t),l.toggleClass("disabled","D"===t||"?"===t)},t["update"+("unstaged"===o?"Unstaged":"Staged")](t,n)}}function y(e){var t=Date.now()/1e3-e,n=Math.floor(t/86400);if(n>30)return new Date(1e3*e).toLocaleDateString();if(n>0)return RED._("sidebar.project.versionControl.daysAgo",{count:n});var o=Math.floor(t/3600);if(o>0)return RED._("sidebar.project.versionControl.hoursAgo",{count:o});var i=Math.floor(t/60);return i>0?RED._("sidebar.project.versionControl.minsAgo",{count:i}):RED._("sidebar.project.versionControl.secondsAgo")}function w(e,t){var o=RED.projects.getActiveProject();(s=t?h.addSpinnerOverlay(n.parent()):h.addSpinnerOverlay(i.parent())).addClass("projects-dialog-spinner-sidebar");var a=t?{files:e}:void 0;h.sendRequest({url:"projects/"+o.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},a)}var D=!1;function E(e,t,n,o,i){var a=h.addSpinnerOverlay(n),s=e+"?limit="+(o||20);i&&(s+="&before="+i),h.sendRequest({url:s,type:"GET",responses:{0:function(e){console.log(e)},200:function(n){var i;n.commits.forEach(function(e){t.editableList("addItem",e),i=e.sha}),t.loadMoreItem&&(t.editableList("removeItem",t.loadMoreItem),delete t.loadMoreItem);var s=t.editableList("length");s<n.total&&(t.loadMoreItem={totalKnown:s,total:n.total,url:e,before:i+"~1",limit:o},t.editableList("addItem",t.loadMoreItem)),a.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function R(t){var c=t.files;s&&(s.remove(),s=null),(f=!!t.merging)?(e.addClass("sidebar-version-control-merging"),r.show()):(e.removeClass("sidebar-version-control-merging"),r.hide()),n.editableList("removeItem",g),i.editableList("removeItem",g),d.editableList("removeItem",v);var p=Object.keys(c).filter(function(e){return"f"===c[e].type});p.sort();var u=Date.now()+Math.floor(100*Math.random());p.forEach(function(e){var t=c[e],o=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),b[e]?(b[e].unmerged&&!t.unmerged?(d.editableList("removeItem",b[e]),o=!0):!b[e].unmerged&&t.unmerged&&(n.editableList("removeItem",b[e]),i.editableList("removeItem",b[e])),b[e].status!==t.status&&(" "!==b[e].treeStatus?" "===t.treeStatus?n.editableList("removeItem",b[e]):t.treeStatus!==b[e].treeStatus&&b[e].updateUnstaged(t,t.treeStatus):o=!0," "!==b[e].indexStatus&&"?"!==b[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?i.editableList("removeItem",b[e]):t.indexStatus!==b[e].indexStatus&&b[e].updateStaged(t,t.indexStatus):o=!0),b[e].status=t.status,b[e].indexStatus=t.indexStatus,b[e].treeStatus=t.treeStatus,b[e].oldName=t.oldName,b[e].unmerged=t.unmerged):(o=!0,b[e]=t),b[e].updateIndex=u,o&&(t.unmerged?d.editableList("addItem",b[e]):(" "!==t.treeStatus&&n.editableList("addItem",b[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&i.editableList("addItem",b[e]))))}),Object.keys(b).forEach(function(e){b[e].updateIndex!==u&&(n.editableList("removeItem",b[e]),i.editableList("removeItem",b[e]),delete b[e])});var h=i.editableList("length"),m=n.editableList("length"),y=d.editableList("length");l.attr("disabled",f&&y>0||!f&&0===h),o.attr("disabled",0===m),a.attr("disabled",0===h),0===h&&i.editableList("addItem",g),0===m&&n.editableList("addItem",g),0===y&&d.editableList("addItem",v)}function x(e,t){if(!D&&(e&&(b={},n.editableList("empty"),i.editableList("empty"),d.editableList("empty")),RED.user.hasPermission("projects.write"))){D=!0,function(){p.editableList("empty");var e=RED.projects.getActiveProject();e&&E("projects/"+e.name+"/commits",p,p.parent())}();var o=RED.projects.getActiveProject();if(o){var a="projects/"+o.name+"/status";t&&(a+="?remote=true"),$.getJSON(a,function(e){R(e),$("#sidebar-version-control-local-branch").text(e.branches.local),$("#sidebar-version-control-remote-branch").text(e.branches.remote||RED._("sidebar.project.versionControl.none"));var t=e.commits.ahead||0,n=e.commits.behind||0;o.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#sidebar-version-control-repo-status-auth-issue").show(),$("#sidebar-version-control-repo-status-stats").hide(),$("#sidebar-version-control-repo-branch").attr("disabled",!0),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0),$("#sidebar-version-control-repo-toolbar-message").hide(),$("#sidebar-version-control-repo-toolbar-error-message").show()):($("#sidebar-version-control-repo-toolbar-message").show(),$("#sidebar-version-control-repo-toolbar-error-message").hide(),$("#sidebar-version-control-repo-status-auth-issue").hide(),$("#sidebar-version-control-repo-status-stats").show(),$("#sidebar-version-control-repo-branch").attr("disabled",!1),$("#sidebar-version-control-repo-status-button").show(),e.branches.hasOwnProperty("remote")?T(t,n):($("#sidebar-version-control-commits-ahead").text(""),$("#sidebar-version-control-commits-behind").text(""),$("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.notTracking")),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))):$("#sidebar-version-control-repo-status-button").hide(),D=!1,$(".sidebar-version-control-shade").hide()}).fail(function(){D=!1})}else $(".sidebar-version-control-shade").show(),n.editableList("empty"),i.editableList("empty"),d.editableList("empty")}}function T(e,t){$("#sidebar-version-control-commits-ahead").text(e),$("#sidebar-version-control-commits-behind").text(t),f?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.statusUnmergedChanged")),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0)):e>0&&0===t?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAhead",{count:e})),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1)):0===e&&t>0?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsBehind",{count:t})),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):e>0&&t>0?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAheadAndBehind1",{count:t})+RED._("sidebar.project.versionControl.commitsAheadAndBehind2",{count:e})+RED._("sidebar.project.versionControl.commitsAheadAndBehind3",{count:t})),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):0===e&&0===t&&($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.repositoryUpToDate")),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))}function _(){x(),RED.sidebar.show("version-control")}return{init:function(s){h=s,RED.actions.add("core:show-version-control-tab",_),RED.events.on("deploy",function(){var e=RED.projects.getActiveProject();e&&(b={},n.editableList("empty"),i.editableList("empty"),d.editableList("empty"),$.getJSON("projects/"+e.name+"/status",function(e){R(e)}))}),RED.events.on("login",function(){x(!0)}),e=$("<div>",{class:"sidebar-version-control"});var f=$("<div>",{class:"sidebar-version-control-stack"}).appendTo(e);t=RED.stack.create({container:f,fill:!0,singleExpanded:!0}),(c=t.add({title:RED._("sidebar.project.versionControl.localChanges"),collapsible:!0})).expand(),c.content.css({height:"100%"});var D=$('<div style="float: right"></div>').appendTo(c.header);$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(D).click(function(e){e.preventDefault(),x(!0)}),g={label:RED._("sidebar.project.versionControl.none")},v={label:RED._("sidebar.project.versionControl.conflictResolve")};var k=$('<div class="sidebar-version-control-change-container"></div>').appendTo(c.content),j=$('<div class="sidebar-version-control-change-header">'+RED._("sidebar.project.versionControl.localFiles")+"</div>").appendTo(k);o=$('<button class="editor-button editor-button-small" style="float: right"><i class="fa fa-plus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(j).click(function(e){e.preventDefault(),e.stopPropagation(),w(Object.keys(b).filter(function(e){return" "!==b[e].treeStatus}),!0)}),(n=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(k)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){m(e,n,n.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),r=$('<div class="sidebar-version-control-change-container"></div>').appendTo(c.content),j=$('<div class="sidebar-version-control-change-header">'+RED._("sidebar.project.versionControl.unmergedChanges")+"</div>").appendTo(r),D=$('<div style="float: right"></div>').appendTo(j);var C=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.abortMerge")+"</button>").appendTo(D).click(function(e){e.preventDefault(),e.stopPropagation();var t=h.addSpinnerOverlay(r),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+n.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),x(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})});(d=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(r)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){n===v&&(n.button={label:RED._("sidebar.project.versionControl.commit"),click:function(e){e.preventDefault(),e.stopPropagation(),O()}}),m(e,n,n.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var S=$('<div class="sidebar-version-control-change-container"></div>').appendTo(c.content);j=$('<div class="sidebar-version-control-change-header">'+RED._("sidebar.project.versionControl.changeToCommit")+"</div>").appendTo(S),D=$('<div style="float: right"></div>').appendTo(j);var O=function(){L.val(""),I.attr("disabled",!0),k.css("height","30px"),r.is(":visible")?(r.css("height","30px"),S.css("height","calc(100% - 60px - 175px)")):S.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout(function(){commitBox.css("height","175px")},10),o.attr("disabled",!0),a.attr("disabled",!0),l.attr("disabled",!0),C.attr("disabled",!0),L.focus()};l=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.commit")+"</button>").appendTo(D).click(function(e){e.preventDefault(),e.stopPropagation(),O()}),a=$('<button class="editor-button editor-button-small"><i class="fa fa-minus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(D).click(function(e){e.preventDefault(),e.stopPropagation(),w(Object.keys(b).filter(function(e){return" "!==b[e].indexStatus&&"?"!==b[e].indexStatus}),!1)}),(i=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(S)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){m(e,n,n.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-bottom"></div>').hide().appendTo(c.content);var L=$("<textarea placeholder="+RED._("sidebar.project.versionControl.commitPlaceholder")+"></textarea>").appendTo(commitBox).on("change keyup paste",function(){I.attr("disabled",""===$(this).val().trim())}),P=$('<div class="sidebar-version-control-slide-box-toolbar button-group">').appendTo(commitBox),N=$('<button class="editor-button">'+RED._("sidebar.project.versionControl.cancelCapital")+"</button>").appendTo(P).click(function(e){e.preventDefault(),L.val(""),k.css("height",""),r.css("height",""),S.css("height",""),commitBox.css("height",0),setTimeout(function(){commitBox.hide()},200),o.attr("disabled",!1),a.attr("disabled",!1),l.attr("disabled",!1),C.attr("disabled",!1)}),I=$('<button class="editor-button">'+RED._("sidebar.project.versionControl.commitCapital")+"</button>").appendTo(P).click(function(e){e.preventDefault();var t=h.addSpinnerOverlay(I).addClass("projects-dialog-spinner-sidebar"),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+n.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),N.click(),x(!0)},400:{"*":function(e){h.reportUnexpectedError(e)}}}},{message:L.val()}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),z=t.add({title:RED._("sidebar.project.versionControl.commitHistory"),collapsible:!0});D=$('<div style="float: right"></div>').appendTo(z.header),$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(D).click(function(e){e.preventDefault(),x(!0,!0)});var A=$('<div class="sidebar-version-control-change-header" style="text-align: right;"></div>').appendTo(z.content),M=$('<button class="editor-button editor-button-small"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.branch")+' <span id="sidebar-version-control-local-branch"></span></button>').appendTo(A).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))J();else{G(),u.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();V.refresh("projects/"+t.name+"/branches"),U.show(),setTimeout(function(){U.css("height","215px"),V.focus()},100)}}),B=$('<button class="editor-button editor-button-small" style="margin-left: 10px;" id="sidebar-version-control-repo-status-button"><span id="sidebar-version-control-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="sidebar-version-control-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="sidebar-version-control-commits-behind"></span></span><span id="sidebar-version-control-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(A).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))G();else{J(),u.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),F.show(),setTimeout(function(){F.css("height","265px")},100)}});p=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(z.content),u=$('<div class="component-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(z.content),p.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){if(e.addClass("sidebar-version-control-commit-entry"),n.url)e.addClass("sidebar-version-control-commit-more"),e.text("+ "+(n.total-n.totalKnown)+RED._("sidebar.project.versionControl.moreCommits")),e.click(function(t){t.preventDefault(),E(n.url,p,e,n.limit,n.before)});else{e.click(function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+n.sha,function(e){e.project=t,e.parents=n.parents,e.oldRev=n.sha+"~1",e.newRev=n.sha,e.oldRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+n.sha.substring(0,7)+"~1",e.newRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+n.sha.substring(0,7),e.date=y(parseInt(n.date)),RED.diff.showCommitDiff(e)})});var o=$("<div>").appendTo(e);if($('<div class="sidebar-version-control-commit-subject">').text(n.subject).appendTo(o),n.refs){var i=$('<div class="sidebar-version-control-commit-refs">').appendTo(o);n.refs.forEach(function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="sidebar-version-control-commit-ref">').text(t).appendTo(i)}),e.addClass("sidebar-version-control-commit-head")}$('<div class="sidebar-version-control-commit-sha">').text(n.sha.substring(0,7)).appendTo(o),$('<div class="sidebar-version-control-commit-date">').text(y(parseInt(n.date))).appendTo(o)}}});var J=function(e){M.removeClass("selected"),U.css("height","0"),u.hide(),setTimeout(function(){U.hide(),e&&e()},200)},U=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px;"></div>').hide().appendTo(z.content);$('<div class="sidebar-version-control-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.changeLocalBranch")).appendTo(U);var V=h.createBranchList({placeholder:RED._("sidebar.project.versionControl.createBranchPlaceholder"),container:U,onselect:function(e){if(e.current)return J();var t=h.addSpinnerOverlay(U),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+n.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){J(function(){t.remove()})},400:{git_local_overwrite:function(e){t.remove(),RED.notify(RED._("sidebar.project.versionControl.localOverwrite"),{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}),F=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px"></div>').hide().appendTo(z.content),G=function(){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),B.removeClass("selected"),F.css("height","0"),u.hide(),setTimeout(function(){F.hide(),q()},200)},q=function(e){H.hasClass("selected")&&(H.removeClass("selected"),Y.height(0),F.css("height","265px"),setTimeout(function(){Y.hide(),e&&e()},200))};$('<div class="sidebar-version-control-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.manageRemoteBranch")).appendTo(F);var W=$('<div style="margin-bottom: 5px;"></div>').appendTo(F),H=$('<button id="sidebar-version-control-repo-branch" class="sidebar-version-control-repo-action editor-button"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.remote")+': <span id="sidebar-version-control-remote-branch"></span></button>').appendTo(W).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))q();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();Q.refresh("projects/"+t.name+"/branches/remote"),Y.show(),setTimeout(function(){Y.height(180),F.css("height","445px"),Q.focus()},100)}});$('<div id="sidebar-version-control-repo-toolbar-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').appendTo(F);var K=$('<div id="sidebar-version-control-repo-toolbar-error-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(F);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> '+RED._("sidebar.project.versionControl.unableToAccess")+"</div>").appendTo(K);var X=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(K);$('<button class="editor-button" style="width: 80%;"><i class="fa fa-refresh"></i> '+RED._("sidebar.project.versionControl.retry")+"</button>").appendTo(X).click(function(e){e.preventDefault();var t=RED.projects.getActiveProject(),n=h.addSpinnerOverlay(F).addClass("projects-dialog-spinner-contain");h.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always(function(){n.remove()})}),$('<div class="sidebar-version-control-slide-box-header" style="height: 20px;"><label id="sidebar-version-control-repo-toolbar-set-upstream-row" for="sidebar-version-control-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="sidebar-version-control-repo-toolbar-set-upstream"> '+RED._("sidebar.project.versionControl.setUpstreamBranch")+"</label></div>").appendTo(F);var Y=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(W),Q=h.createBranchList({placeholder:RED._("sidebar.project.versionControl.createRemoteBranchPlaceholder"),currentLabel:RED._("sidebar.project.versionControl.upstream"),remote:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)[0]},container:Y,onselect:function(e){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!1),$("#sidebar-version-control-remote-branch").text(e.name+(e.create?" *":""));var t=RED.projects.getActiveProject();t.git.branches.remote===e.name?delete t.git.branches.remoteAlt:t.git.branches.remoteAlt=e.name,$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),q(function(){if(e.create)t.git.branches.remote?$("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.selectUpstreamBranch")):($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.trackedUpstreamBranch")),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!0),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!0)),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1);else{var n=Date.now(),o=h.addSpinnerOverlay($("#sidebar-version-control-repo-toolbar-message")).addClass("projects-dialog-spinner-contain");$.getJSON("projects/"+t.name+"/branches/remote/"+e.name+"/status",function(e){setTimeout(function(){T(e.commits.ahead,e.commits.behind),o.remove()},Math.max(400-(Date.now()-n),0))})}})}}),Z=$('<div style="margin-bottom: 5px;"></div>').appendTo(F);$('<button id="sidebar-version-control-repo-push" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-up"></i> <span data-i18n="sidebar.project.versionControl.push"></span></button>').appendTo(Z).click(function(e){e.preventDefault();var t=h.addSpinnerOverlay(F).addClass("projects-dialog-spinner-contain"),n=RED.projects.getActiveProject(),o="projects/"+n.name+"/push";n.git.branches.remoteAlt&&(o+="/"+n.git.branches.remoteAlt);var i=$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked");i&&(o+="?u=true"),h.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){i&&n.git.branches.remoteAlt&&(n.git.branches.remote=n.git.branches.remoteAlt,delete n.git.branches.remoteAlt),x(!0),G()},400:{git_push_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.pushFailed"),"error")},unexpected_error:function(e){console.log(e)}}}},{}).always(function(){t.remove()})});var ee=function(e){e=e||{};var t=h.addSpinnerOverlay(F).addClass("projects-dialog-spinner-contain"),n=RED.projects.getActiveProject(),o="projects/"+n.name+"/pull";n.git.branches.remoteAlt&&(o+="/"+n.git.branches.remoteAlt),(e.setUpstream||e.allowUnrelatedHistories)&&(o+="?"),e.setUpstream&&(o+="setUpstream=true",e.allowUnrelatedHistories&&(o+="&")),e.allowUnrelatedHistories&&(o+="allowUnrelatedHistories=true"),h.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(t){e.setUpstream&&n.git.branches.remoteAlt&&(n.git.branches.remote=n.git.branches.remoteAlt,delete n.git.branches.remoteAlt),x(!0),G()},400:{git_local_overwrite:function(e){RED.notify(RED._("sidebar.project.versionControl.unablePull")+'<p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">'+RED._("sidebar.project.versionControl.showUnstagedChanges")+"</a></p>","error",!1,1e7)},git_pull_merge_conflict:function(e){x(!0),G()},git_connection_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.connectionFailed")+e.toString(),"warning")},git_pull_unrelated_history:function(t){var n=RED.notify(RED._("sidebar.project.versionControl.pullUnrelatedHistory"),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.close()}},{text:RED._("sidebar.project.versionControl.pullChanges"),click:function(){n.close(),e.allowUnrelatedHistories=!0,ee(e)}}]})},"*":function(e){h.reportUnexpectedError(e)}}}},{}).always(function(){t.remove()})};$('<button id="sidebar-version-control-repo-pull" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-down"></i> <span data-i18n="sidebar.project.versionControl.pull"></span></button>').appendTo(Z).click(function(e){e.preventDefault(),ee({setUpstream:$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked")})}),$('<div class="component-shade sidebar-version-control-shade">').appendTo(e),RED.sidebar.addTab({id:"version-control",label:RED._("sidebar.project.versionControl.history"),name:"Project History",content:e,enableOnEdit:!1,pinned:!0,iconClass:"fa fa-code-fork",onchange:function(){setTimeout(function(){t.resize()},10)}})},show:_,refresh:x,showLocalChanges:function(){RED.sidebar.show("version-control"),c.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var e=null,t=!1,n=!1,o=null;return{show:function(i,a,s){t=!0;try{$("body").width(),$("body").height();for(var r=(e=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){v(),d3.event.preventDefault()})).append("div").style({position:"absolute",top:a[1]-80+"px",left:a[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),d=[],l=function(e,t,n){n.el=r.append("div").style({position:"absolute",top:t+80-25+"px",left:e+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),n.el.html(n.name),n.disabled&&n.el.style({"border-color":"#ccc",color:"#ccc"}),n.x=e,n.y=t,d.push(n),n.el.on("touchstart",function(){n.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),n.el.on("touchend",function(){v(),n.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},c=s.length,p=Math.max(Math.PI/(c-1),Math.PI/4),u=Math.PI,f=0;f<c;f++){var h=Math.floor(80*Math.cos(u)),g=Math.floor(80*Math.sin(u));s[f].name&&l(h,g,s[f]),u+=p}var v=function(){t=!1,o=null,e.remove(),e=null};i.on("touchend.radial",function(){if(i.on("touchend.radial",null),i.on("touchmenu.radial",null),o){try{o.onselect()}catch(e){RED._debug(e)}v()}else n&&v()}),i.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-a[0],e.pageY-a[1]],i=0;i<d.length;i++){var s=d[i];s.disabled||(t[0]>s.x-30&&t[0]<s.x+30&&t[1]>s.y-30&&t[1]<s.y+30?s!==o&&(s.el.style("background","#999"),o=s):s===o?(s.el.style("background","#fff"),o=null):s.el.style("background","#fff"))}if(!o){var r=Math.abs(t[0]*t[0]+t[1]*t[1]);n=r>6400}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return t}}}();