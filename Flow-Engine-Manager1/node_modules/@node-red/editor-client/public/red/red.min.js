!function(){if(!!window.MSInputMethodContext&&!!document.documentMode&&(window.DOMTokenList.prototype.toggle=function(e,t){1===arguments.length&&(t=!this.contains(e)),this[t?"add":"remove"](e)},"classList"in SVGElement.prototype||Object.defineProperty(SVGElement.prototype,"classList",Object.getOwnPropertyDescriptor(HTMLElement.prototype,"classList")),"children"in SVGElement.prototype||Object.defineProperty(SVGElement.prototype,"children",Object.getOwnPropertyDescriptor(HTMLElement.prototype,"children")),Array.from=function(){if(arguments.length>1)throw new Error("Node-RED's IE11 Array.from polyfill doesn't support multiple arguments");var e=arguments[0],t=[];if(e.forEach)e.forEach((function(e){t.push(e)}));else for(var o=0;o<e.length;o++)t.push(arrayList[o]);return t},0===new Set([0]).size)){var e=Set;Set=function(t){var o=new e;return t&&t.forEach(o.add,o),o},Set.prototype=e.prototype,Set.prototype.constructor=Set}}(),jQuery.propHooks.disabled={set:function(e,t){e.disabled!==t&&(e.disabled=t,t?$(e).trigger("disabled"):$(e).trigger("enabled"))}};var RED=function(){function e(){c.reportProgress(RED._("event.loadPlugins"),10),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"plugins",success:function(e){c.reportProgress(RED._("event.loadPlugins"),13),RED.i18n.loadPluginCatalogs((function(){!function(e){c.reportProgress(RED._("event.loadPlugins",{count:""}),17);var o=localStorage.getItem("editor-language")||RED.i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":o},cache:!1,url:"plugins",success:function(o){var i=o.trim().split(/(?=<!-- --- \[red-plugin:\S+\] --- -->)/),n=(i.length,function(){0===i.length?e():function(e,o){t(e,/<!-- --- \[red-plugin:(\S+)\] --- -->/.exec(e.trim()),"#red-ui-editor-plugin-configs",o)}(i.shift(),n)});n()}})}((function(){c.reportProgress(RED._("event.loadPalette"),20),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(e){RED.nodes.setNodeList(e),c.reportProgress(RED._("event.loadNodeCatalogs"),25),RED.i18n.loadNodeCatalogs((function(){i(n)}))}})}))}))}})}function t(e,t,o,i){var n;i=i||function(){},t?(n=t[1],RED._loadingModule=n):n="unknown";try{var a=!1,r=$("<div>"+e+"</div>"),s=r.find("script"),d=s.length;s.each((function(e,t){var s=$(t).attr("src");if(s&&!/^\s*(https?:|\/|\.)/.test(s)){$(t).remove();var l=document.createElement("script");l.onload=function(){0===--d&&($(o).append(r),delete RED._loadingModule,i())},"module"===$(t).attr("type")&&(l.type="module"),$(o).append(l),l.src=RED.settings.apiRootUrl+s,a=!0}else(/\/ace.js$/.test(s)||/\/ext-language_tools.js$/.test(s))&&(console.warn("Blocked attempt to load",s,"by",n),$(t).remove()),d--})),a||($(o).append(r),delete RED._loadingModule,i())}catch(e){RED.notify(RED._("notification.errors.failedToAppendNode",{module:n,error:e.toString()}),{type:"error",timeout:1e4}),console.log("["+n+"] "+e.toString()),delete RED._loadingModule,i()}}function o(e,o){t(e,/<!-- --- \[red-module:(\S+)\] --- -->/.exec(e.trim()),"#red-ui-editor-node-configs",o)}function i(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"icons",success:function(t){RED.nodes.setIconSets(t),e&&e()}})}function n(){c.reportProgress(RED._("event.loadNodes",{count:""}),30);var e=localStorage.getItem("editor-language")||RED.i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":e},cache:!1,url:"nodes",success:function(e){var t=e.trim().split(/(?=<!-- --- \[red-module:\S+\] --- -->)/),i=t.length,n=function(){(c.reportProgress(RED._("event.loadNodes",{count:i-t.length+"/"+i}),30+(i-t.length)/i*40),0===t.length)?($("#red-ui-editor").i18n(),$("#red-ui-palette > .red-ui-palette-spinner").hide(),$(".red-ui-palette-scroll").removeClass("hide"),$("#red-ui-palette-search").removeClass("hide"),RED.settings.theme("projects.enabled",!1)?RED.projects.refresh((function(e){a((function(){RED.sidebar.info.refresh();var t=!1;e||(RED.menu.setDisabled("menu-item-projects-open",!0),RED.menu.setDisabled("menu-item-projects-settings",!0),!1===e||(t=!0)),r(t)}))})):a((function(){RED.sidebar.info.refresh(),r()}))):o(t.shift(),n)};n()}})}function a(e){c.reportProgress(RED._("event.loadFlows"),80),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){if(t){var o=window.location.hash;RED.nodes.version(t.rev),c.reportProgress(RED._("event.importFlows"),90);try{if(RED.nodes.import(t.flows),RED.nodes.dirty(!1),RED.view.redraw(!0),/^#flow\/.+$/.test(o)&&RED.workspaces.show(o.substring(6),!0),RED.workspaces.count()>0){const e=JSON.parse(RED.settings.getLocal("hiddenTabs")||"{}"),t=RED.nodes.getWorkspaceOrder();if(0===RED.workspaces.active())for(let o=0;o<t.length;o++){const i=t[o];if(!e[i]){RED.workspaces.show(i);break}}0===RED.workspaces.active()&&RED.workspaces.show(t[0])}}catch(e){console.warn(e),RED.notify(RED._("event.importError",{message:e.message}),{fixed:!0,type:"error"})}}e()}})}function r(e){var t={};RED.comms.subscribe("notification/#",(function(e,o){var i=e.split("/")[1];if("runtime-deploy"!==i&&"node"!==i&&"flows-run-state"!==i){if("project-update"===i)return c.start(RED._("event.loadingProject"),0),RED.nodes.clear(),RED.history.clear(),RED.view.redraw(!0),void RED.projects.refresh((function(){a((function(){var e=RED.projects.getActiveProject(),t={"change-branch":RED._("notification.project.change-branch",{project:e.git.branches.local}),"merge-abort":RED._("notification.project.merge-abort"),loaded:RED._("notification.project.loaded",{project:o.project}),updated:RED._("notification.project.updated",{project:o.project}),pull:RED._("notification.project.pull",{project:o.project}),revert:RED._("notification.project.revert",{project:o.project}),"merge-complete":RED._("notification.project.merge-complete")}[o.action];c.end(),RED.notify($("<p>").text(t)),RED.sidebar.info.refresh()}))}));if(o.text){o.default=o.text;var n=RED._(o.text,o),r={type:o.type,fixed:void 0===o.timeout,timeout:o.timeout,id:i};"runtime-state"===i&&("safe-mode"===o.error?r.buttons=[{text:RED._("common.label.close"),click:function(){t[i].hideNotification()}}]:"missing-types"===o.error?(n+="<ul><li>"+o.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.projects.getActiveProject()?r.buttons=[{text:RED._("notification.label.manage-project-dep"),click:function(){t[i].hideNotification(),RED.projects.settings.show("deps")}}]:r.buttons=[{text:RED._("notification.label.unknownNodesButton"),class:"pull-left",click:function(){RED.actions.invoke("core:search","type:unknown ")}},{class:"primary",text:RED._("common.label.close"),click:function(){t[i].hideNotification()}}]):"missing-modules"===o.error?(n+="<ul><li>"+o.modules.map((function(e){return RED.utils.sanitize(e.module)+(e.error?" - <small>"+RED.utils.sanitize(""+e.error)+"</small>":"")})).join("</li><li>")+"</li></ul>",r.buttons=[{text:RED._("common.label.close"),click:function(){t[i].hideNotification()}}]):"credentials_load_failed"===o.error?RED.settings.theme("projects.enabled",!1)?RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.setupCredentials"),click:function(){t[i].hideNotification(),RED.projects.showCredentialsPrompt()}}]):r.buttons=[{text:RED._("common.label.close"),click:function(){t[i].hideNotification()}}]:"missing_flow_file"===o.error||"missing_package_file"===o.error?RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.setupProjectFiles"),click:function(){t[i].hideNotification(),RED.projects.showFilesPrompt()}}]):"project_empty"===o.error?RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.no"),click:function(){t[i].hideNotification()}},{text:RED._("notification.project.createDefault"),click:function(){t[i].hideNotification(),RED.projects.createDefaultFileSet()}}]):"git_merge_conflict"===o.error&&(RED.nodes.clear(),RED.sidebar.versionControl.refresh(!0),RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.mergeConflict"),click:function(){t[i].hideNotification(),RED.sidebar.versionControl.showLocalChanges()}}]))),t.hasOwnProperty(i)?t[i].update(n,r):t[i]=RED.notify(n,r)}else t.hasOwnProperty(i)&&(t[i].close(),delete t[i]);"runtime-state"===i&&RED.events.emit("runtime-state",o)}})),RED.comms.subscribe("status/#",(function(e,t){var o=e.split("/"),i=RED.nodes.node(o[1]);i&&(t.hasOwnProperty("text")&&null!==t.text&&/^[@a-zA-Z]/.test(t.text)&&(t.text=i._(t.text.toString(),{defaultValue:t.text.toString()})),i.status=t,i.dirtyStatus=!0,i.dirty=!0,RED.view.redrawStatus(i))})),RED.comms.subscribe("notification/node/#",(function(e,t){var n,a,r;if("notification/node/added"==e)RED.settings.refreshSettings((function(e,n){var a=[];t.forEach((function(e){var t=e.id;RED.nodes.addNodeSet(e),a=a.concat(e.types),RED.i18n.loadNodeCatalog(t,(function(){var e=localStorage.getItem("editor-language")||RED.i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":e},cache:!1,url:"nodes/"+t,success:function(e){o(e)}})}))})),a.length&&(r="<ul><li>"+a.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:a.length})+r,"success")),i()}));else if("notification/node/removed"==e){for(n=0;n<t.length;n++)a=t[n],RED.nodes.removeNodeSet(a.id).added&&(r="<ul><li>"+a.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:a.types.length})+r,"success"));i()}else"notification/node/enabled"==e?t.types&&RED.settings.refreshSettings((function(e,i){if(RED.nodes.getNodeSet(t.id).added)RED.nodes.enableNodeSet(t.id),r="<ul><li>"+t.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:t.types.length})+r,"success");else{var n=localStorage.getItem("editor-language")||RED.i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":n},cache:!1,url:"nodes/"+t.id,success:function(e){o(e),r="<ul><li>"+t.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:t.types.length})+r,"success")}})}})):"notification/node/disabled"==e?t.types&&(RED.nodes.disableNodeSet(t.id),r="<ul><li>"+t.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:t.types.length})+r,"success")):"notification/node/upgraded"==e&&(RED.notify(RED._("palette.event.nodeUpgraded",{module:t.module,version:t.version}),"success"),RED.nodes.registry.setModulePendingUpdated(t.module,t.version))})),RED.comms.subscribe("event-log/#",(function(e,t){var o=e.substring(9);RED.eventLog.log(o,t)})),$(".red-ui-header-toolbar").show(),RED.sidebar.show(":first",!0),setTimeout((function(){c.end(),function(e){if(!1===RED.settings.theme("tours"))return void e();if(!RED.settings.get("editor.view.view-show-welcome-tours",!0))return void e();RED.actions.invoke("core:show-welcome-tour",RED.settings.get("editor.tours.welcome"),e)}((function(){e&&RED.projects.showStartup()}))}),100)}function s(){var e=[];RED.settings.theme("projects.enabled",!1)&&e.push({id:"menu-item-projects-menu",label:RED._("menu.label.projects"),options:[{id:"menu-item-projects-new",label:RED._("menu.label.projects-new"),disabled:!1,onselect:"core:new-project"},{id:"menu-item-projects-open",label:RED._("menu.label.projects-open"),disabled:!1,onselect:"core:open-project"},{id:"menu-item-projects-settings",label:RED._("menu.label.projects-settings"),disabled:!1,onselect:"core:show-project-settings"}]}),e.push({id:"menu-item-edit-menu",label:RED._("menu.label.edit"),options:[{id:"menu-item-edit-undo",label:RED._("keyboard.undoChange"),disabled:!0,onselect:"core:undo"},{id:"menu-item-edit-redo",label:RED._("keyboard.redoChange"),disabled:!0,onselect:"core:redo"},null,{id:"menu-item-edit-cut",label:RED._("keyboard.cutNode"),onselect:"core:cut-selection-to-internal-clipboard"},{id:"menu-item-edit-copy",label:RED._("keyboard.copyNode"),onselect:"core:copy-selection-to-internal-clipboard"},{id:"menu-item-edit-paste",label:RED._("keyboard.pasteNode"),disabled:!0,onselect:"core:paste-from-internal-clipboard"},null,{id:"menu-item-edit-copy-group-style",label:RED._("keyboard.copyGroupStyle"),onselect:"core:copy-group-style"},{id:"menu-item-edit-paste-group-style",label:RED._("keyboard.pasteGroupStyle"),disabled:!0,onselect:"core:paste-group-style"},null,{id:"menu-item-edit-select-all",label:RED._("keyboard.selectAll"),onselect:"core:select-all-nodes"},{id:"menu-item-edit-select-connected",label:RED._("keyboard.selectAllConnected"),onselect:"core:select-connected-nodes"},{id:"menu-item-edit-select-none",label:RED._("keyboard.selectNone"),onselect:"core:select-none"},null,{id:"menu-item-edit-split-wire-with-links",label:RED._("keyboard.splitWireWithLinks"),onselect:"core:split-wire-with-link-nodes"}]}),e.push({id:"menu-item-view-menu",label:RED._("menu.label.view.view"),options:[{id:"menu-item-palette",label:RED._("menu.label.palette.show"),toggle:!0,onselect:"core:toggle-palette",selected:!0},{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:"core:toggle-sidebar",selected:!0},{id:"menu-item-event-log",label:RED._("eventLog.title"),onselect:"core:show-event-log"},{id:"menu-item-action-list",label:RED._("keyboard.actionList"),onselect:"core:show-action-list"},null]}),e.push({id:"menu-item-arrange-menu",label:RED._("menu.label.arrange"),options:[{id:"menu-item-view-tools-move-to-back",label:RED._("menu.label.moveToBack"),disabled:!0,onselect:"core:move-selection-to-back"},{id:"menu-item-view-tools-move-to-front",label:RED._("menu.label.moveToFront"),disabled:!0,onselect:"core:move-selection-to-front"},{id:"menu-item-view-tools-move-backwards",label:RED._("menu.label.moveBackwards"),disabled:!0,onselect:"core:move-selection-backwards"},{id:"menu-item-view-tools-move-forwards",label:RED._("menu.label.moveForwards"),disabled:!0,onselect:"core:move-selection-forwards"},null,{id:"menu-item-view-tools-align-left",label:RED._("menu.label.alignLeft"),disabled:!0,onselect:"core:align-selection-to-left"},{id:"menu-item-view-tools-align-center",label:RED._("menu.label.alignCenter"),disabled:!0,onselect:"core:align-selection-to-center"},{id:"menu-item-view-tools-align-right",label:RED._("menu.label.alignRight"),disabled:!0,onselect:"core:align-selection-to-right"},null,{id:"menu-item-view-tools-align-top",label:RED._("menu.label.alignTop"),disabled:!0,onselect:"core:align-selection-to-top"},{id:"menu-item-view-tools-align-middle",label:RED._("menu.label.alignMiddle"),disabled:!0,onselect:"core:align-selection-to-middle"},{id:"menu-item-view-tools-align-bottom",label:RED._("menu.label.alignBottom"),disabled:!0,onselect:"core:align-selection-to-bottom"},null,{id:"menu-item-view-tools-distribute-horizontally",label:RED._("menu.label.distributeHorizontally"),disabled:!0,onselect:"core:distribute-selection-horizontally"},{id:"menu-item-view-tools-distribute-veritcally",label:RED._("menu.label.distributeVertically"),disabled:!0,onselect:"core:distribute-selection-vertically"}]}),e.push(null),RED.settings.theme("menu.menu-item-import-library",!0)&&e.push({id:"menu-item-import",label:RED._("menu.label.import"),onselect:"core:show-import-dialog"}),RED.settings.theme("menu.menu-item-export-library",!0)&&e.push({id:"menu-item-export",label:RED._("menu.label.export"),onselect:"core:show-export-dialog"}),e.push(null),e.push({id:"menu-item-search",label:RED._("menu.label.search"),onselect:"core:search"}),e.push(null),e.push({id:"menu-item-config-nodes",label:RED._("menu.label.displayConfig"),onselect:"core:show-config-tab"}),e.push({id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:"core:add-flow"},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:"core:edit-flow"},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:"core:remove-flow"}]}),e.push({id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:"core:create-subflow"},{id:"menu-item-subflow-convert",label:RED._("menu.label.selectionToSubflow"),disabled:!0,onselect:"core:convert-to-subflow"}]}),e.push({id:"menu-item-group",label:RED._("menu.label.groups"),options:[{id:"menu-item-group-group",label:RED._("menu.label.groupSelection"),disabled:!0,onselect:"core:group-selection"},{id:"menu-item-group-ungroup",label:RED._("menu.label.ungroupSelection"),disabled:!0,onselect:"core:ungroup-selection"},null,{id:"menu-item-group-merge",label:RED._("menu.label.groupMergeSelection"),disabled:!0,onselect:"core:merge-selection-to-group"},{id:"menu-item-group-remove",label:RED._("menu.label.groupRemoveSelection"),disabled:!0,onselect:"core:remove-selection-from-group"}]}),e.push(null),!1!==RED.settings.get("externalModules.palette.allowInstall",!0)&&(e.push({id:"menu-item-edit-palette",label:RED._("menu.label.editPalette"),onselect:"core:manage-palette"}),e.push(null)),e.push({id:"menu-item-user-settings",label:RED._("menu.label.settings"),onselect:"core:show-user-settings"}),e.push(null),RED.settings.theme("menu.menu-item-keyboard-shortcuts",!0)&&e.push({id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:"core:show-help"}),e.push({id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label",RED._("menu.label.help")),href:RED.settings.theme("menu.menu-item-help.url","http://nodered.org/docs")}),e.push({id:"menu-item-node-red-version",label:"v"+RED.settings.version,onselect:"core:show-about"}),$('<li><a id="red-ui-header-button-sidemenu" class="button" href="#"><i class="fa fa-bars"></i></a></li>').appendTo(".red-ui-header-toolbar"),RED.menu.init({id:"red-ui-header-button-sidemenu",options:e})}var d=null,l=!1;var c={init:function(){var e=$('<div id="red-ui-loading-progress"></div>').hide(),t=$("<div>").appendTo(e),o=($("<div>",{class:"red-ui-loading-bar-label"}).appendTo(t),$("<div>",{class:"red-ui-loading-bar"}).appendTo(t));$("<span>").appendTo(o);return e},start:function(e,t){e&&c.reportProgress(e,t),$("#red-ui-loading-progress").show()},reportProgress:function(e,t){$(".red-ui-loading-bar-label").text(e),$(".red-ui-loading-bar span").width(t+"%")},end:function(){$("#red-ui-loading-progress").hide(),c.reportProgress("",0)}};return{init:function(t){if(l)throw new Error("RED already initialised");l=!0,window.ace&&window.ace.require("ace/ext/language_tools"),(t=t||{}).apiRootUrl=t.apiRootUrl||"",t.apiRootUrl&&!/\/$/.test(t.apiRootUrl)&&(t.apiRootUrl=t.apiRootUrl+"/"),t.target=$("#red-ui-editor"),t.target.addClass("red-ui-editor"),function(e){var t=$('<div id="red-ui-header"></div>').appendTo(e.target),o=$('<span class="red-ui-header-logo"></span>').appendTo(t);$('<ul class="red-ui-header-toolbar hide"></ul>').appendTo(t),$('<div id="red-ui-header-shade" class="hide"></div>').appendTo(t),$('<div id="red-ui-main-container" class="red-ui-sidebar-closed hide"><div id="red-ui-workspace"></div><div id="red-ui-editor-stack" tabindex="-1"></div><div id="red-ui-palette"></div><div id="red-ui-sidebar"></div><div id="red-ui-sidebar-separator"></div></div>').appendTo(e.target),$('<div id="red-ui-editor-plugin-configs"></div>').appendTo(e.target),$('<div id="red-ui-editor-node-configs"></div>').appendTo(e.target),$('<div id="red-ui-full-shade" class="hide"></div>').appendTo(e.target),c.init().appendTo("#red-ui-main-container"),c.start("...",0),$.getJSON(e.apiRootUrl+"theme",(function(e){e.header&&(e.header.url&&(o=$("<a>",{href:e.header.url}).appendTo(o)),e.header.image&&$("<img>",{src:e.header.image}).appendTo(o),e.header.title&&$("<span>").html(e.header.title).appendTo(o)),e.themes&&(d=e.themes)}))}(t),RED.i18n.init(t,(function(){RED.settings.init(t,(function(){d&&(RED.settings.editorTheme=RED.settings.editorTheme||{},RED.settings.editorTheme.themes=d),RED.workspaces.init(),RED.statusBar.init(),RED.view.init(),RED.userSettings.init(),RED.user.init(),RED.notifications.init(),RED.library.init(),RED.palette.init(),RED.eventLog.init(),!1!==RED.settings.get("externalModules.palette.allowInstall",!0)?RED.palette.editor.init():console.log("Palette editor disabled"),RED.sidebar.init(),RED.settings.theme("projects.enabled",!1)?RED.projects.init():console.log("Projects disabled"),RED.subflow.init(),RED.group.init(),RED.clipboard.init(),RED.search.init(),RED.actionList.init(),RED.editor.init(),RED.diagnostics.init(),RED.diff.init(),RED.deploy.init(RED.settings.theme("deployButton",null)),RED.keyboard.init(s),RED.nodes.init(),RED.runtime.init(),RED.comms.connect(),$("#red-ui-main-container").show(),e()}))}))},loader:c}}();RED.events=function(){var e={};return{on:function(t,o){e[t]=e[t]||[],e[t].push(o)},off:function(t,o){var i=e[t];if(i)for(var n=0;n<i.length;n++)if(i[n]===o)return void i.splice(n,1)},emit:function(){var t=arguments[0],o=Array.prototype.slice.call(arguments,1);if(RED.events.DEBUG&&console.warn(t,o),e[t])for(var i=0;i<e[t].length;i++)try{e[t][i].apply(null,o)}catch(e){console.warn("RED.events.emit error: ["+t+"] "+e.toString()),console.warn(e)}}}}(),RED.hooks=function(){var e={},t={};function o(t,o){var i=o.previousHook,n=o.nextHook;i?i.nextHook=n:e[t]=n,n&&(n.previousHook=i),o.removed=!0,i||n||delete e[t]}return{has:function(o){var i=o.split("."),n=i[0],a=i[1];return a?!(!t[a]||!t[a][n]):!!e[n]},clear:function(){e={},t={}},add:function(o,i){var n=o.split("."),a=n[0],r=n[1];if(r&&t[r]&&t[r][a])throw new Error("Hook "+o+" already registered");var s={cb:i,previousHook:null,nextHook:null},d=e[a];if(void 0===d)e[a]=s;else{for(;null!==d.nextHook;)d=d.nextHook;d.nextHook=s,s.previousHook=d}r&&(t[r]=t[r]||{},t[r][a]=s)},remove:function(e){var i=e.split("."),n=i[0],a=i[1];if(!a)throw new Error("Cannot remove hook without label: "+e);if(t[a])if("*"===n){for(var r=Object.keys(t[a]),s=0;s<r.length;s++)o(r[s],t[a][r[s]]);delete t[a]}else t[a][n]&&(o(n,t[a][n]),delete t[a][n],0===Object.keys(t[a]).length&&delete t[a])},trigger:function(t,o,i){var n=e[t];if(n)return function e(t){if(!n||t)return i&&i(t),t;if(n.removed)return n=n.nextHook,e();var a=n.cb;if(1===a.length)try{let t=a(o);return!1===t?(i&&i(!1),t):(n=n.nextHook,e())}catch(e){return console.warn(e),i&&i(e),e}else try{a(o,(function(t){void 0===t?(n=n.nextHook,e()):i&&i(t)}))}catch(e){return console.warn(e),i&&i(e),e}}();i&&i()}}}(),RED.i18n=function(){var e;function t(){return navigator.language}return{init:function(o,i){e=o.apiRootUrl||"";var n=localStorage.getItem("editor-language")||t(),a={compatibilityJSON:"v3",backend:{loadPath:e+"locales/__ns__?lng=__lng__"},lng:"en-US",preload:["en-US"],ns:["editor","node-red","jsonata","infotips"],defaultNS:"editor",fallbackLng:["en-US"],returnObjects:!0,keySeparator:".",nsSeparator:":",interpolation:{unescapeSuffix:"HTML",escapeValue:!1,prefix:"__",suffix:"__"}};n&&(a.lng=n),i18next.use(i18nextHttpBackend).init(a,(function(){i()})),jqueryI18next.init(i18next,$,{handleName:"i18n"}),RED._=function(){var e=i18next.t.apply(i18next,arguments);return"string"==typeof e?e:arguments[0]}},lang:function(){for(var e=[localStorage.getItem("editor-language")||t()].concat(i18next.languages),o=RED.settings.theme("languages")||["en-US"],i=0;i<e.length;i++)if(o.indexOf(e[i])>-1)return e[i];return"en-US"},loadNodeCatalog:function(o,i){var n=[localStorage.getItem("editor-language")||t()].concat(i18next.languages),a=n.length;n.forEach((function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:e+"nodes/"+o+"/messages?lng="+t,success:function(e){i18next.addResourceBundle(t,o,e),0===--a&&i()}})}))},loadNodeCatalogs:function(o){var i=[localStorage.getItem("editor-language")||t()].concat(i18next.languages),n=i.length;i.forEach((function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:e+"nodes/messages?lng="+t,success:function(e){Object.keys(e).forEach((function(o){i18next.addResourceBundle(t,o,e[o])})),0===--n&&o()}})}))},loadPluginCatalogs:function(o){var i=[localStorage.getItem("editor-language")||t()].concat(i18next.languages),n=i.length;i.forEach((function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:e+"plugins/messages?lng="+t,success:function(e){Object.keys(e).forEach((function(o){i18next.addResourceBundle(t,o,e[o])})),0===--n&&o()}})}))},detectLanguage:t}}(),RED.settings=function(){var e,t={},o={},i=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},n=function(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(o){!function(e){for(var o in t)t.hasOwnProperty(o)&&RED.settings.hasOwnProperty(o)&&delete RED.settings[o];for(o in e)e.hasOwnProperty(o)&&(RED.settings[o]=e[o]);t=e}(o),e(null,o)},error:function(t,o,i){401===t.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&r("access_token"),RED.user.login((function(){n(e)}))):console.log("Unexpected error loading settings:",t.status,o)}})},a=function(e){n((function(t,o){t||(RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+o.version),console.groupCollapsed("Versions"),console.log("jQuery",$().jquery),console.log("jQuery UI",$.ui.version),window.ace&&console.log("ACE",ace.version),window.monaco&&console.log("MONACO",monaco.version||"unknown"),console.log("D3",d3.version),console.groupEnd(),s(e))}))};function r(e){var t=window.location.search.split("?");if(t.length>=2){for(var o=t[1].split(/[&;]/g),i=0;i<o.length;i++)if(o[i].startsWith(e+"=")){o.splice(i,1);break}window.location.search=o.join("&")}}function s(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(t){!function(e){o=e}(t),e()},error:function(e,t,o){console.log("Unexpected error loading user settings:",e.status,t)}})}function d(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout((function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(o),success:function(e){},error:function(e,t,o){console.log("Unexpected error saving user settings:",e.status,t)}})}),300))}return{init:function(e,t){var o=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(o){var i=o[1];RED.settings.set("auth-tokens",{access_token:i}),r("access_token")}RED.settings.apiRootUrl=e.apiRootUrl,$.ajaxSetup({beforeSend:function(t,o){if(!/^\s*(https?:|\/|\.)/.test(o.url)){e.apiRootUrl&&(o.url=e.apiRootUrl+o.url);var i=RED.settings.get("auth-tokens");i&&t.setRequestHeader("Authorization","Bearer "+i.access_token),t.setRequestHeader("Node-RED-API-Version","v2")}}}),a(t)},load:a,loadUserSettings:s,refreshSettings:n,set:function(e,t){i()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(RED.utils.setMessageProperty(o,e,t),d()))},get:function(e,t){if(i()){if("auth-tokens"===e)return JSON.parse(localStorage.getItem(e));var n;try{n=RED.utils.getMessageProperty(o,e)}catch(e){}if(void 0===n)try{n=RED.utils.getMessageProperty(RED.settings,e)}catch(e){}return void 0===n&&(n=t),n}},remove:function(e){i()&&("auth-tokens"===e?localStorage.removeItem(e):(delete o[e],d()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var o=e.split("."),i=RED.settings.editorTheme;try{for(var n=0;n<o.length;n++)i=i[o[n]];return void 0===i?t:i}catch(e){return t}},setLocal:function(e,t){localStorage.setItem(e,t)},getLocal:function(e){return localStorage.getItem(e)},removeLocal:function(e){localStorage.removeItem(e)}}}(),RED.user=function(){function e(){$("#red-ui-header-button-user-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},(function(){RED.settings.load((function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),e(),RED.events.emit("login",RED.settings.user.username)}))}))}}):(RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var t=/^((.+)\.)?read$/,o=/^((.+)\.)?write$/;function i(e,n){if(""===n)return!0;var a;if(Array.isArray(n)){for(a=0;a<n.length;a++)if(!i(e,n[a]))return!1;return!0}if(Array.isArray(e)){if(0===e.length)return!1;for(a=0;a<e.length;a++)if(i(e[a],n))return!0;return!1}return"*"===e||e===n||("read"===e||"*.read"===e?t.test(n):("write"===e||"*.write"===e)&&o.test(n))}return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu")||RED.settings.editorTheme.userMenu)){var t=$('<li><a id="red-ui-header-button-user" class="button hide" href="#"></a></li>').prependTo(".red-ui-header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(t.find("a")):$('<i class="fa fa-user"></i>').appendTo(t.find("a")),RED.menu.init({id:"red-ui-header-button-user",options:[]}),e()}},login:function(t,o){"function"==typeof t&&(o=t,t={});var i=$('<div id="node-dialog-login" class="hide" style="display: flex; align-items: flex-end;"><div style="width: 250px; flex-grow: 0;"><img id="node-dialog-login-image" src=""/></div><div style="flex-grow: 1;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px; margin-left:20px;"></form></div></div>');i.dialog({autoOpen:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},modal:!0,closeOnEscape:!!t.cancelable,width:600,resizable:!1,draggable:!1,close:function(e,t){$("#node-dialog-login").dialog("destroy").remove(),RED.keyboard.enable()}}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(n){var a=0;if("credentials"==n.type){for(;a<n.prompts.length;a++){var r=n.prompts[a],s=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+r.id+'">'+RED._(r.label)+":</label><br/>").appendTo(s);var d=$('<input style="width: 100%" id="node-dialog-login-'+r.id+'" type="'+r.type+'" tabIndex="'+(a+1)+'"/>').appendTo(s);a<n.prompts.length-1&&d.keypress(function(){var e=s;return function(t){13==t.keyCode&&(e.next("div").find("input").trigger("focus"),t.preventDefault())}}()),s.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;color:var(--red-ui-text-color-error);" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(t.cancelable?'<a href="#" id="node-dialog-login-cancel" class="red-ui-button" style="margin-right: 20px;" tabIndex="'+(a+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" class="red-ui-button" style="width: auto;" tabIndex="'+(a+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").on("submit",(function(i){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var a={client_id:"node-red-editor",grant_type:"password",scope:""},r=0;r<n.prompts.length;r++){var s=n.prompts[r];a[s.id]=$("#node-dialog-login-"+s.id).val()}$.ajax({url:"auth/token",type:"POST",data:a}).done((function(i,n,a){RED.settings.set("auth-tokens",i),t.updateMenu&&e(),$("#node-dialog-login").dialog("close"),o()})).fail((function(e,t,o){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()})).always((function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()})),i.preventDefault()}))}else if("strategy"==n.type){var l=/[?&]session_message=(.*?)(?:$|&)/.exec(window.location.search);if(RED.sessionMessages=RED.sessionMessages||[],l)if(RED.sessionMessages.push(decodeURIComponent(l[1])),history.pushState){var c=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.replaceState({path:c},"",c)}else window.location.search="";if(0===RED.sessionMessages.length&&n.autoLogin)return void(document.location=n.loginRedirect);for(a=0;a<n.prompts.length;a++){r=n.prompts[a];if(RED.sessionMessages){var u=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");RED.sessionMessages.forEach((function(e){$("<div>").css("color","var(--red-ui-text-color-error)").text(e).appendTo(u)})),delete RED.sessionMessages}s=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var p=$('<a href="#" class="red-ui-button"></a>',{style:"padding: 10px"}).appendTo(s).on("click",(function(){document.location=r.url}));if(r.image)$("<img>",{src:r.image}).appendTo(p);else if(r.label){var f=$("<span></span>").text(r.label);r.icon&&($("<i></i>",{class:"fa fa-2x "+r.icon,style:"vertical-align: middle"}).appendTo(p),f.css({verticalAlign:"middle",marginLeft:"8px"})),f.appendTo(p)}p.button()}}t.cancelable&&$("#node-dialog-login-cancel").button().on("click",(function(e){$("#node-dialog-login").dialog("close")}));var h=n.image||"red/images/node-red-256.svg";$("#node-dialog-login-image").load((function(){i.dialog("open")})).attr("src",h),RED.keyboard.disable()}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done((function(e,t,o){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)})).fail((function(e,t,o){401===e.status?document.location.reload(!0):console.log(t)}))},hasPermission:function(e){return""===e||(!RED.settings.user||i(RED.settings.user.permissions||"",e))}}}(),RED.comms=function(){var e,t=null,o=null,i=null,n=10,a={},r=!1,s=0,d=!1;return{connect:function l(){var c;if(d=!0,RED.settings.apiRootUrl){var u=/^(https?):\/\/(.*)$/.exec(RED.settings.apiRootUrl);u&&(console.log(u),c="ws"+("https"===u[1]?"s":"")+"://"+u[2]+"comms")}else{var p=location.hostname,f=location.port;0!==f.length&&(p=p+":"+f),p=(p+=document.location.pathname)+("/"==p.slice(-1)?"":"/")+"comms",c="ws"+("https:"==document.location.protocol?"s":"")+"://"+p}var h=RED.settings.get("auth-tokens");function g(){for(var t in a)a.hasOwnProperty(t)&&e.send(JSON.stringify({subscribe:t}))}r=null!=h,(e=new WebSocket(c)).onopen=function(){s=0,t&&(o=setTimeout((function(){t.close(),t=null}),1e3)),r?e.send(JSON.stringify({auth:h.access_token})):g()},e.onmessage=function(e){var t=JSON.parse(e.data);if(t.auth)r&&"ok"===t.auth?(r=!1,g()):"fail"===t.auth&&(d=!1,RED.user.login({updateMenu:!0},(function(){l()})));else for(var o=0;o<t.length;o++){var i=t[o];if(i.topic)for(var n in a){if(a.hasOwnProperty(n))if(new RegExp("^"+n.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(i.topic)){var s=a[n];if(s)for(var c=0;c<s.length;c++)s[c](i.topic,i.data)}}}},e.onclose=function(){d&&(o&&(clearTimeout(o),o=null),++s<10?(setTimeout(l,1e3),s>5&&null==t&&(t=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):s<20?setTimeout(l,2e3):(n=60,i=setInterval((function(){if(0===--n)t.update(RED._("notification.errors.lostConnection")),clearInterval(i),l();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:n})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";t.update(e,{silent:!0}),$(t).find("a").on("click",(function(e){e.preventDefault(),t.update(RED._("notification.errors.lostConnection"),{silent:!0}),clearInterval(i),l()}))}}),1e3)))}},subscribe:function(t,o){null==a[t]&&(a[t]=[]),a[t].push(o),e&&1==e.readyState&&e.send(JSON.stringify({subscribe:t}))},unsubscribe:function(e,t){if(a[e]){for(var o=0;o<a[e].length;o++)if(a[e][o]===t){a[e].splice(o,1);break}0===a[e].length&&delete a[e]}}}}(),RED.runtime=function(){let e="",t={ui:!1,enabled:!1};const o="start";return{init:function(){t=Object.assign({},t,RED.settings.runtimeState),RED.events.on("runtime-state",(function(i){if(i.state){const n=e;e=i.state,$(".red-ui-flow-node-button").toggleClass("red-ui-flow-node-button-stopped",e!==o),!0===t.enabled&&!0===t.ui&&(RED.menu.setVisible("deploymenu-item-runtime-stop",e===o),RED.menu.setVisible("deploymenu-item-runtime-start",e!==o)),""===n||e===n||i.deploy||"safe"===e||RED.notify(RED._("notification.state.flows"+("stop"===e?"Stopped":"Started"),i),"success")}}))},get started(){return e===o}}}(),RED.text={},RED.text.bidi=function(){var e="";function t(e){return e>64&&e<91||e>96&&e<123}function o(o){return"auto"==e?function(e){for(var o,i=e.length,n=0;n<i;n++){if((o=e.charCodeAt(n))>=1488&&o<=1535||o>=1536&&o<=1631||o>=1642&&o<=1775||o>=1786&&o<=2047||o>=64285&&o<=65023||o>=65136&&o<=65276)return!0;if(t(e.charCodeAt(n)))return!1}return!1}(o)?"rtl":"ltr":e}function i(){$(this).attr("dir",o($(this).val()))}return{setTextDirection:function(t){e=t,RED.nodes.eachNode((function(e){e.dirty=!0})),RED.view.redraw(),RED.palette.refresh(),$("#red-ui-workspace").find("span.red-ui-text-bidi-aware").each((function(){$(this).attr("dir",o($(this).html()))})),$("#red-ui-sidebar").find("span.red-ui-text-bidi-aware").each((function(){$(this).attr("dir",o($(this).text()))}))},enforceTextDirectionWithUCC:function(e){if(e){var t=o(e);if("ltr"==t)return"‪"+e+"‬";if("rtl"==t)return"‫"+e+"‬"}return e},resolveBaseTextDir:o,prepareInput:function(e){e.on("keyup",i).on("paste",i).on("cut",i),i.call(e)}}}(),RED.text.format=function(){var e=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},t=function(){function t(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var o=parseInt(e.length,10);return isNaN(o)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function o(e,t){var o={};for(var i in t)t.hasOwnProperty(i)&&(o[i]=t[i]);var n=e.content,a=o.usePos&&o.startPos<n.length;a&&(o.start="",o.loops=!1),o.bStart=a?o.startPos:o.start.length>0?n.indexOf(o.start):0;var r=o.useLength&&o.length>0&&o.bStart+o.length<n.length;return r&&(o.end=""),o.bEnd=r?o.bStart+o.length:o.end.length>0?n.indexOf(o.end,o.bStart+o.start.length)+1:n.length,o.after||(o.start=""),o.before||(o.end=""),o}return{handleSubcontents:function(t,o,i,n,a){if(!i.content||"string"!=typeof i.content||0===i.content.length)return t;var r=!0;void 0!==i.loops&&(r=!!i.loops);for(var s=0;!(s>=t.length);s++)if(!(t[s].isParsed||t.keep||t[s].isSeparator)){var d=t[s].content,l=d.indexOf(i.content);if(!(l<0)){var c,u=0;if(i.continued)do{u++,c=d.indexOf(i.content,l+u*i.content.length)}while(0===c);else u=1;if(c=l+u*i.content.length,t.splice(s,1),l>0&&(t.splice(s,0,new e({content:d.substring(0,l),localGui:o.dir,keep:!0})),s++),t.splice(s,0,new e({content:d.substring(l,c),textDirection:i.subDir,localGui:o.dir})),c<d.length&&t.splice(s+1,0,new e({content:d.substring(c,d.length),localGui:o.dir,keep:!0})),!r)break}}},handleBounds:function(i,n,a,r,s){for(var d=0;d<a.length;d++)if(t(a[d]))for(var l=0;!(l>=i.length);l++)if(!(i[l].isParsed||i[l].inBounds||i.keep||i[l].isSeparator)){var c=o(i[l],a[d]),u=c.bStart,p=c.bEnd;if(!(u<0||p<0)){var f=i[l].content;if(i.splice(l,1),u>0&&(i.splice(l,0,new e({content:f.substring(0,u),localGui:n.dir,keep:!0})),l++),c.start&&(i.splice(l,0,new e({content:c.start,localGui:n.dir,isSeparator:!0})),l++),i.splice(l,0,new e({content:f.substring(u+c.start.length,p-c.end.length),textDirection:c.subDir,localGui:n.dir,inBounds:!0})),c.end&&(l++,i.splice(l,0,new e({content:c.end,localGui:n.dir,isSeparator:!0}))),p+c.end.length<f.length&&i.splice(l+1,0,new e({content:f.substring(p+c.end.length,f.length),localGui:n.dir,keep:!0})),!c.loops)break}}for(d=0;d<i.length;d++)i[d].inBounds=!1;return i},handleCases:function(e,t,o,i,n){if(0===o.length)return e;var a={};for(var r in t)t.hasOwnProperty(r)&&(a[r]=t[r]);for(var s=0;s<o.length;s++)o[s].handler&&"function"==typeof o[s].handler.handle||(o[s].handler=t.commonHandler),o[s].args?(a.cases=o[s].args.cases,a.points=o[s].args.points,a.bounds=o[s].args.bounds,a.subs=o[s].args.subs):(a.cases=[],a.points=[],a.bounds=[],a.subs={}),o[s].handler.handle(i,e,a,n);return e},handlePoints:function(t,o,i,n,a){for(var r=0;r<i.length;r++)for(var s=0;!(s>=t.length);s++)if(!(t[s].isParsed||t[s].keep||t[s].isSeparator)){var d=t[s].content,l=d.indexOf(i[r]);l>=0&&(t.splice(s,1),l>0&&(t.splice(s,0,new e({content:d.substring(0,l),textDirection:o.subDir,localGui:o.dir,inPoints:!0})),s++),t.splice(s,0,new e({content:i[r],localGui:o.dir,isSeparator:!0})),l+i[r].length+1<=d.length&&t.splice(s+1,0,new e({content:d.substring(l+i[r].length),textDirection:o.subDir,localGui:o.dir,inPoints:!0})))}for(r=0;r<t.length;r++)t[r].keep?t[r].keep=!1:t[r].inPoints&&(t[r].isParsed=!0,t[r].inPoints=!1);return t}}}(),o={handle:function(e,o,i,n){var a=[];Array.isArray(i.cases)&&(a=i.cases);var r=[];void 0!==i.points&&(Array.isArray(i.points)?r=i.points:"string"==typeof i.points&&(r=i.points.split("")));var s={};"object"==typeof i.subs&&(s=i.subs);var d=[];return Array.isArray(i.bounds)&&(d=i.bounds),t.handleBounds(o,i,d,e,n),t.handleSubcontents(o,i,s,e,n),t.handleCases(o,i,a,e,n),t.handlePoints(o,i,r,e,n),o}},i={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),function(e){var t=e?e.split("-")[0]:"";return!(!t||t.length<2)&&["iw","he","ar","fa","ur"].some((function(e){return e===t}))}(e=e.toLowerCase())){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,o,i){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;o=/^(rtl|ltr)$/i.test(o)?o:"ltr";var n=i?e.split("").reverse().join(""):e,a=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(n);return a?a[0]<="z"?"ltr":"rtl":o},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var o="",i=0;i<e.length;i++){var n=""+e.charAt(i);switch(n){case"‎":o+="<LRM>";break;case"‏":o+="<RLM>";break;case"‪":o+="<LRE>";break;case"‫":o+="<RLE>";break;case"‭":o+="<LRO>";break;case"‮":o+="<RLO>";break;case"‬":o+="<PDF>";break;default:o+=n}}var a=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return a+o+(""===a?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},n=function(){var t={};function n(e,t){var i=Array.isArray(e)?e[0]:e;return i.guiDir||(i.guiDir="ltr"),i.dir||(i.dir=i.guiDir),t?(void 0===i.points&&(i.points=[]),i.cases||(i.cases=[]),i.bounds||(i.bounds=[]),i.commonHandler=o,i):i}function a(t,i,a){if(!t||!i)return new e({content:""});var r=n(i,!0),s=[new e({content:t,actual:t,localGui:r.dir})],d=o.handle;return r.handler&&"function"==typeof r.handler&&(d=r.handler.handle),d(t,s,r,a),s}function r(e,t,o){var a=n(t,!1);return o?function(e,t,o){for(var n="",a="",r=0;r<e.length;r++)if(e[r].isVisible){var s=e[r].textDirection,d=e[r].localGui;if(""!==d&&""===a?n+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>":""===a||""!==d&&d===a&&!stop||(n+="</bdi>"+(r==e.length-1&&""!==d?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==d&&(n+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>")),"auto"===s&&(s=i.getDirection(e[r].content,s,t.guiDir)),/^(rtl|ltr)$/i.test(s)?(n+="<bdi dir='"+("rtl"===s?"rtl":"ltr")+"'>"+e[r].content+"</bdi>",s):(n+=e[r].content,i.getDirection(e[r].content,s,t.guiDir,!0)),r<e.length-1)n+="<span style='unicode-bidi: embed; direction: "+("rtl"===(d&&e[r+1].localGui?d:t.dir)?"rtl":"ltr")+";'></span>";else""!==a&&(n+="</bdi>");a=d,stop=!1}else stop=!0;var l="auto"===t.dir?i.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;l!==t.guiDir&&(n="<bdi dir='"+("rtl"===l?"rtl":"ltr")+"'>"+n+"</bdi>");return n}(e,a):function(e,t,o){for(var n="",a="",r=!1,s=0;s<e.length;s++)if(e[s].isVisible){var d=e[s].textDirection,l=e[s].localGui;if(""!==l&&""===a?n+="rtl"===l?i.RLE:i.LRE:""===a||""!==l&&l===a&&!r||(n+=i.PDF+(s==e.length-1&&""!==l?"":"rtl"===t.dir?i.RLM:i.LRM),""!==l&&(n+="rtl"===l?i.RLE:i.LRE)),"auto"===d&&(d=i.getDirection(e[s].content,d,t.guiDir)),/^(rtl|ltr)$/i.test(d)?(n+=("rtl"===d?i.RLE:i.LRE)+e[s].content+i.PDF,d):(n+=e[s].content,i.getDirection(e[s].content,d,t.guiDir,!0)),s<e.length-1)n+="rtl"===(l&&e[s+1].localGui?l:t.dir)?i.RLM:i.LRM;else""!==a&&(n+=i.PDF);a=l,r=!1}else r=!0;var c="auto"===t.dir?i.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(n=("rtl"===c?i.RLE:i.LRE)+n+i.PDF);return n}(e,a)}return t.parseAndDisplayStructure=function(e,t,o,i){return e&&t?r(a(e,t,i),t,o):e},t.parseStructure=a,t.displayStructure=r,t.restore=function(e,t){return e},t}(),a={format:function(e,t,o,i,a,r){var s={guiDir:o?"rtl":"ltr",dir:t.dir?t.dir:o?"rtl":"ltr",subs:{content:">",continued:!0,subDir:o?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:o?"ltr":"rtl"}}}]};return r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},r={format:function(e,t,o,i,a,r){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:","};return r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},s=function(){function e(e,t){if("ar"!==i.getLocaleDetails(t).lang)return"ltr";var o=e.indexOf("@");return o>0&&o<e.length-1&&i.hasArabicChar(e.substring(o+1))?"rtl":"ltr"}return{format:function(t,i,a,r,s,d){var l={guiDir:a?"rtl":"ltr",dir:e(t,s),points:"<>.:,;@",cases:[{handler:o,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return d?n.parseStructure(t,l,!!r,s):n.parseAndDisplayStructure(t,l,!!r,s)}}}(),d={format:function(e,t,o,i,a,r){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:"/\\:."};return r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},l={format:function(e,t,o,i,a,r){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},c={format:function(e,t,i,a,r,s){var d={guiDir:i?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:o,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:o,args:{subs:{content:" ",continued:!0}}},{handler:o,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return s?n.parseStructure(e,d,!!a,r):n.parseAndDisplayStructure(e,d,!!a,r)}},u={format:function(e,t,o,i,a,r){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:"_"};return r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},p={format:function(e,t,o,i,a,r){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},f={format:function(e,t,o,i,a,r){var s={guiDir:o?"rtl":"ltr",dir:t.dir?t.dir:o?"rtl":"ltr",points:" ,.!?;:"};return r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},h={format:function(e,t,i,a,r,s){var d={guiDir:i?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:o,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return s?n.parseStructure(e,d,!!a,r):n.parseAndDisplayStructure(e,d,!!a,r)}},g={format:function(e,t,o,i,a,r){var s={},d="",l=Array.isArray(t)?t[0]:t;for(d in l)l.hasOwnProperty(d)&&(s[d]=l[d]);return s.guiDir=o?"rtl":"ltr",s.dir=s.dir?s.dir:s.guiDir,r?n.parseStructure(e,s,!!i,a):n.parseAndDisplayStructure(e,s,!!i,a)}},v=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function o(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function i(e){0===e.msgDir.length&&(e.msgDir=o(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:o(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function m(e){switch(e){case"breadcrumb":return a;case"comma":return r;case"email":return s;case"filepath":return d;case"formula":return l;case"sql":return c;case"underscore":return u;case"url":return p;case"word":return f;case"xpath":return h;default:return g}}function b(e,t,o,n,a){if(!e||1!=e.nodeType)return!1;v||(v=document.createEvent("Event")).initEvent("TF",!0,!0),e.setAttribute("data-tf-type",t);var r="undefined"===o?"{}":JSON.stringify(Array.isArray(o)?o[0]:o);e.setAttribute("data-tf-args",r);var s="ltr";if("undefined"===n&&(e.dir?s=e.dir:e.style&&e.style.direction&&(s=e.style.direction),n="rtl"===s.toLowerCase()),e.setAttribute("data-tf-dir",n),e.setAttribute("data-tf-locale",i.getLocaleDetails(a).lang),function(e){var t=window.navigator.userAgent;if(t.indexOf("MSIE")>=0||t.indexOf("Trident")>=0||t.indexOf("Edge")>=0)return!1;var o=document.createElement(e.tagName);o.contentEditable=!0;var i="oninput"in o;return i||(o.setAttribute("oninput","return;"),i="function"==typeof o.oninput),o=null,i}(e)){e.oninput;e.oninput=function(e){y(e.target)}}else e.onkeyup=function(t){y(t.target),e.dispatchEvent(v)},e.onmouseup=function(t){y(t.target),e.dispatchEvent(v)};return y(e),!0}function y(e){var t=e.textContent||"",o=document.getSelection();if(0===t.length||!o||o.rangeCount<=0)e.dispatchEvent(v);else{var i,n,a=o.getRangeAt(0),r=a.cloneRange();i=a.startContainer,n=a.startOffset;var s=0;3===i.nodeType&&(s+=n),r.setStart(e,0),r.setEndBefore(i);var d=document.createElement("div");d.appendChild(r.cloneContents()),s+=d.textContent.length,e.innerHTML=m(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var l=e,c=e,u=0,p=!1;for(o.removeAllRanges(),a.setStart(e,0),a.setEnd(e,0);c;){if(3===c.nodeType){if(u+c.nodeValue.length>=s){a.setStart(c,s-u);break}u+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(l=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(l===e){p=!0;break}c=l.nextSibling,l=l.parentNode}if(p)break}o.addRange(a),e.dispatchEvent(v)}}return{
/*!
        * Returns the HTML representation of a given structured text
        * @param text - the structured text
        * @param type - could be one of filepath, url, email
        * @param args - pass additional arguments to the handler. generally null.
        * @param isRtl - indicates if the GUI is mirrored
        * @param locale - the browser locale
        */
getHtml:function(e,t,o,i,n){return m(t).format(e,o,i,!0,n)},
/*!
        * Handle Structured text correct display for a given HTML element.
        * @param element - the element  : should be of type div contenteditable=true
        * @param type - could be one of filepath, url, email
        * @param args - pass additional arguments to the handler. generally null.
        * @param isRtl - indicates if the GUI is mirrored
        * @param locale - the browser locale
        */
attach:function(e,t,o,i,n){return b(e,t,o,i,n)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9,PANNING:10,SELECTING_NODE:11,GROUP_DRAGGING:12,GROUP_RESIZE:13,DETACHED_DRAGGING:14,SLICING:15,SLICING_JUNCTION:16},RED.plugins=function(){var e={},t={};return{registerPlugin:function(o,i){e[o]=i,i.type&&(t[i.type]=t[i.type]||[],t[i.type].push(i)),RED._loadingModule?(i.module=RED._loadingModule,i._=function(){var e=Array.prototype.slice.call(arguments),t=e[0];/:/.test(e[0])||(e[0]=i.module+":"+e[0]);var o=RED._.apply(null,e);return o===e[0]?t:o}):i._=RED._,i.onadd&&"function"==typeof i.onadd&&i.onadd(),RED.events.emit("registry:plugin-added",o)},getPlugin:function(t){return e[t]},getPluginsByType:function(e){return t[e]||[]}}}(),RED.nodes=function(){var e,t,o={},a={},r=[],s={},d={},l=[],c={},u=null,p={},f={},h={},g={},v=!1;var m,b,y,w=function(){var e={},t=[],o={},i={},n={},a={};n.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""},env:{value:[]}}};var r={setModulePendingUpdated:function(t,o){e[t].pending_version=o,RED.events.emit("registry:module-updated",{module:t,version:o})},getModule:function(t){return e[t]},getNodeSetForType:function(e){return r.getNodeSet(i[e])},getModuleList:function(){return e},getNodeList:function(){return t},getNodeTypes:function(){return Object.keys(n)},setNodeList:function(e){t=[];for(var o=0;o<e.length;o++){var i=e[o];r.addNodeSet(i)}},addNodeSet:function(n){if(n.types){n.added=!1,o[n.id]=n;for(var a=0;a<n.types.length;a++)i[n.types[a]]=n.id;t.push(n),e[n.module]=e[n.module]||{name:n.module,version:n.version,local:n.local,sets:{}},n.pending_version&&(e[n.module].pending_version=n.pending_version),e[n.module].sets[n.name]=n,RED.events.emit("registry:node-set-added",n)}},removeNodeSet:function(n){for(var a=o[n],r=0;r<a.types.length;r++)delete i[a.types[r]];delete o[n];for(var s=0;s<t.length;s++)if(t[s].id===n){t.splice(s,1);break}return delete e[a.module].sets[a.name],0===Object.keys(e[a.module].sets).length&&delete e[a.module],RED.events.emit("registry:node-set-removed",a),a},getNodeSet:function(e){return o[e]},enableNodeSet:function(e){var t=o[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=o[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){if("subflow:"!=e.substring(0,8)){if(!o[i[e]]){var a="",r=e;return RED._loadingModule&&(r="["+RED._loadingModule+"] "+e,a=o[RED._loadingModule]?o[RED._loadingModule].err||"":"Unknown error"),void RED.notify(RED._("palette.event.unknownNodeRegistered",{type:r,error:a}),"error")}var s;t.set=o[i[e]],o[i[e]].added=!0,o[i[e]].enabled=!0,s="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=s+":"+e[0]);var o=RED._.apply(null,e);return o===e[0]&&(o=t),o}}if(t.type=e,n[e]=t,t.defaults)for(var d in t.defaults)if(t.defaults.hasOwnProperty(d)&&t.defaults[d].type)try{t.defaults[d]._type=R(t.defaults[d].type)}catch(e){console.warn(e)}RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete n[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return n[e]},setIconSets:function(e){(a=e)["font-awesome"]=RED.nodes.fontAwesome.getIconList()},getIconSets:function(){return a}};return r}(),E=(m={},b={},y={addTab:function(e){b[e]=[]},hasTab:function(e){return b.hasOwnProperty(e)},removeTab:function(e){delete b[e]},addNode:function(e){m[e.id]=e,b.hasOwnProperty(e.z)?b[e.z].push(e):(console.warn("Node added to unknown tab/subflow:",e),b._=b._||[],b._.push(e))},removeNode:function(e){if(delete m[e.id],b.hasOwnProperty(e.z)){var t=b[e.z].indexOf(e);t>-1&&b[e.z].splice(t,1)}},hasNode:function(e){return m.hasOwnProperty(e)},getNode:function(e){return m[e]},moveNode:function(e,t){y.removeNode(e),e.z=t,y.addNode(e)},moveNodesForwards:function(e){var t=[];Array.isArray(e)||(e=[e]);for(var o=b[e[0].z],i=new Set(e.filter((function(e){return"group"!==e.type&&"subflow"!==e.type}))),n=new Set,a=o.length-1;a>=0&&0!==i.size;a--){var r=o[a];i.has(r)&&(a<o.length-1&&!n.has(o[a+1])&&(o.splice(a,1),o.splice(a+1,0,r),r._reordered=!0,t.push(r)),i.delete(r),n.add(r))}return t.length>0&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},moveNodesBackwards:function(e){var t=[];Array.isArray(e)||(e=[e]);for(var o=b[e[0].z],i=new Set(e.filter((function(e){return"group"!==e.type&&"subflow"!==e.type}))),n=new Set,a=0;a<o.length&&0!==i.size;a++){var r=o[a];i.has(r)&&(a>0&&!n.has(o[a-1])&&(o.splice(a,1),o.splice(a-1,0,r),r._reordered=!0,t.push(r)),i.delete(r),n.add(r))}return t.length>0&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},moveNodesToFront:function(e){var t=[];Array.isArray(e)||(e=[e]);for(var o=b[e[0].z],i=new Set(e.filter((function(e){return"group"!==e.type&&"subflow"!==e.type}))),n=o.length-1,a=o.length-1;a>=0&&0!==i.size;a--){var r=o[a];i.has(r)&&(a<n&&(o.splice(a,1),o.splice(n,0,r),r._reordered=!0,t.push(r)),n--,i.delete(r))}return t.length>0&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},moveNodesToBack:function(e){var t=[];Array.isArray(e)||(e=[e]);for(var o=b[e[0].z],i=new Set(e.filter((function(e){return"group"!==e.type&&"subflow"!==e.type}))),n=0,a=0;a<o.length&&0!==i.size;a++){var r=o[a];i.has(r)&&(a>n&&(o.splice(a,1),o.splice(n,0,r),r._reordered=!0,t.push(r)),n++,i.delete(r))}return t.length>0&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},getNodes:function(e){return b[e]},clear:function(){m={},b={}},eachNode:function(e){var t,o,i;for(o in c)if(c.hasOwnProperty(o))for(t=b[o],i=0;i<t.length;i++)if(!1===e(t[i]))return;for(o=0;o<l.length;o++)for(t=b[l[o]],i=0;i<t.length;i++)if(!1===e(t[i]))return;if(b._)for(t=b._,i=0;i<t.length;i++)if(!1===e(t[i]))return},filterNodes:function(e){var t=[],o=null,i=!1;e.hasOwnProperty("z")&&(b.hasOwnProperty(e.z)?o=b[e.z]:i=!0);var n=!1;null===o&&(o=Object.keys(m),n=!0);for(var a=0;a<o.length;a++){var r=o[a];n&&(r=m[r]),e.hasOwnProperty("type")&&r.type!==e.type||i&&r.z!==e.z||t.push(r)}return t},getNodeOrder:function(e){return b[e].map((function(e){return e.id}))},setNodeOrder:function(e,t){var o={};t.forEach((function(e,t){o[e]=t})),b[e].sort((function(e,t){return e._reordered=!0,t._reordered=!0,o[e.id]-o[t.id]}))}});function D(){for(var e=[],t=0;t<8;t++)e.push(Math.round(255*Math.random()).toString(16).padStart(2,"0"));return e.join("")}function R(e){var t;e=e.trim();var o=0,i=/\[\]$/.test(e);i&&(e=e.substring(0,e.length-2));for(var n=e.length,a=!1,r=!1,s="",d=[];o<n;){if(t=e[o],r)"|"===t?(d.push(s.trim()),s="",r=!1):")"===t?(d.push(s.trim()),s="",a=!1,r=!1):s+=t;else if("("===t){if(a)throw new Error("Invalid character '"+t+"' at position "+o);a=!0}else" "!==t&&(r=!0,s=t);o++}return(s=s.trim()).length>0&&d.push(s),{types:d,array:i}}function x(e){if(0!==e.type.indexOf("subflow"))e._=e._def._;else{var t=e.type.substring(8),o=RED.nodes.subflow(t);o&&o.instances.push(o),e._=RED._}if("config"==e._def.category)a[e.id]=e;else{if(e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.dirty=!0,V(e),"subflows"==e._def.category&&void 0===e.i){var i=0;RED.nodes.eachNode((function(e){i=Math.max(i,e.i||0)})),e.i=i+1}E.addNode(e),s[e.id]||(s[e.id]={in:[],out:[]})}RED.events.emit("nodes:add",e)}function _(e){if(s[e.source.id]){if(!s[e.source.id].out.every((function(t){return t.sourcePort!==e.sourcePort||t.target.id!==e.target.id})))return}r.push(e),e.source&&(s[e.source.id]||(s[e.source.id]={in:[],out:[]}),s[e.source.id].out.push(e)),e.target&&(s[e.target.id]||(s[e.target.id]={in:[],out:[]}),s[e.target.id].in.push(e)),e.source.z===e.target.z&&o[e.source.z]&&o[e.source.z].push(e),RED.events.emit("links:add",e)}function k(e){return e in a?a[e]:E.getNode(e)}function T(e){var t,o=[],i=[];if(e in a)t=a[e],delete a[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(E.hasNode(e)){t=E.getNode(e),E.removeNode(t),delete s[e],(o=r.filter((function(e){return e.source===t||e.target===t}))).forEach(C);var d=!1;for(var l in t._def.defaults)if(t._def.defaults.hasOwnProperty(l)){var c=t._def.defaults[l];if(c.type){var u=w.getNodeType(c.type);if(u&&"config"==u.category){var p=a[t[l]];if(p)if(d=!0,p._def.exclusive)T(t[l]),i.push(p);else{var f=p.users;f.splice(f.indexOf(t),1),RED.events.emit("nodes:change",p)}}}}if(0===t.type.indexOf("subflow:")){var h=t.type.substring(8),g=RED.nodes.subflow(h);g&&g.instances.splice(g.instances.indexOf(t),1)}d&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:o,nodes:i}}function C(e){var t=r.indexOf(e);if(-1!=t){if(r.splice(t,1),e.source&&s[e.source.id]){var i=s[e.source.id].out.indexOf(e);-1!==i&&s[e.source.id].out.splice(i,1)}if(e.target&&s[e.target.id]){var n=s[e.target.id].in.indexOf(e);-1!==n&&s[e.target.id].in.splice(n,1)}e.source.z===e.target.z&&o[e.source.z]&&-1!==(t=o[e.source.z].indexOf(e))&&o[e.source.z].splice(t,1)}RED.events.emit("links:remove",e)}function j(e,t){d[e.id]=e,E.addTab(e.id),o[e.id]=[],e._def=RED.nodes.getType("tab"),void 0===t?l.push(e.id):l.splice(t,0,e.id),RED.events.emit("flows:add",e),void 0!==t&&RED.events.emit("flows:reorder",l)}function L(e,t){if(t){var i=Object.keys(c).map((function(e){return c[e].name}));i.sort();var n=1,a=e.name;i.forEach((function(t){a==t&&(n++,a=e.name+" ("+n+")")})),e.name=a}c[e.id]=e,E.addTab(e.id),o[e.id]=[],RED.nodes.registerType("subflow:"+e.id,{defaults:{name:{value:""},env:{value:[]}},icon:function(){return e.icon||"subflow.svg"},category:e.category||"subflows",inputs:e.in.length,outputs:e.out.length,color:e.color||"#DDAA99",label:function(){return this.name||RED.nodes.subflow(e.id).name},labelStyle:function(){return this.name?"red-ui-flow-node-label-italic":""},paletteLabel:function(){return RED.nodes.subflow(e.id).name},inputLabels:function(t){return e.inputLabels?e.inputLabels[t]:null},outputLabels:function(t){return e.outputLabels?e.outputLabels[t]:null},oneditprepare:function(){"subflow"!==this.type?RED.subflow.buildEditForm("subflow",this):RED.subflow.buildEditForm("subflow-template",this)},oneditresize:function(e){"subflow"===this.type&&$("#node-input-env-container").editableList("height",e.height-80)},set:{module:"node-red"}}),e.instances=[],e._def=RED.nodes.getType("subflow:"+e.id),RED.events.emit("subflows:add",e)}function S(e){return c[e]}function O(e,t){for(var o=E.getNodes(e),i=0;i<o.length;i++){var n=o[i],a=/^subflow:(.+)$/.exec(n.type);if(a){if(a[1]===t)return!0;if(O(a[1],t))return!0}}return!1}function I(e,t){RED.view.selection();for(var o=new Set,i=[e],n=!0;i.length>0;){var a=i.shift();o.add(a);var r=[];(!n||!t||n&&"up"===t)&&(r=r.concat(s[a.id].in)),(!n||!t||n&&"down"===t)&&(r=r.concat(s[a.id].out)),n=!1,r.forEach((function(e){o.has(e.source)||i.push(e.source),o.has(e.target)||i.push(e.target)}))}return Array.from(o)}function N(e,t){var o=!0;t&&t.hasOwnProperty("credentials")&&(o=t.credentials);var i={};for(var n in i.id=e.id,i.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(i[n]=e[n]);if(o){var a={};if(e.credentials){for(var r in e.credentials)e.credentials.hasOwnProperty(r)&&(!e.credentials._||e.credentials["has_"+r]!=e.credentials._["has_"+r]||e.credentials["has_"+r]&&e.credentials[r])&&(a[r]=e.credentials[r]);Object.keys(a).length>0&&(i.credentials=a)}}return i}function P(e,t){var o=!0,i=!1;if(!1===t?o=!1:"object"==typeof t&&(t.hasOwnProperty("credentials")&&(o=t.credentials),t.hasOwnProperty("dimensions")&&(i=t.dimensions)),"tab"===e.type)return N(e,{credentials:o});var n={};if(n.id=e.id,n.type=e.type,n.z=e.z,0!==n.z&&""!==n.z||delete n.z,!0===e.d&&(n.d=!0),e.g&&(n.g=e.g),"unknown"==n.type)for(var a in e._orig)e._orig.hasOwnProperty(a)&&(n[a]=e._orig[a]);else{for(var s in e._def.defaults)e._def.defaults.hasOwnProperty(s)&&(n[s]=e[s]);if(o){var d={};if((/^subflow:/.test(n.type)||"group"===n.type)&&e.credentials)for(var l in e.credentials)e.credentials.hasOwnProperty(l)&&(!e.credentials._||e.credentials["has_"+l]!=e.credentials._["has_"+l]||e.credentials["has_"+l]&&e.credentials[l])&&(d[l]=e.credentials[l]);else if(e.credentials)for(var c in n.credentials={},e._def.credentials)e._def.credentials.hasOwnProperty(c)&&("password"==e._def.credentials[c].type?(!e.credentials._||e.credentials["has_"+c]!=e.credentials._["has_"+c]||e.credentials["has_"+c]&&e.credentials[c])&&(d[c]=e.credentials[c]):null==e.credentials[c]||e.credentials._&&e.credentials[c]==e.credentials._[c]||(d[c]=e.credentials[c]));Object.keys(d).length>0&&(n.credentials=d)}}if("group"===e.type&&(n.x=e.x,n.y=e.y,n.w=e.w,n.h=e.h,n.nodes=n.nodes.filter((function(e){return!!e})).map((function(e){return e.id}))),"tab"!==e.type&&"group"!==e.type||n.env&&0===n.env.length&&delete n.env,"config"!=e._def.category||"junction"===e.type){if(n.x=e.x,n.y=e.y,i){if(!e.hasOwnProperty("w")){var u=RED.view.calculateNodeDimensions(e);e.w=u[0],e.h=u[1]}n.w=e.w,n.h=e.h}n.wires=[];for(var p=0;p<e.outputs;p++)n.wires.push([]);for(var f=r.filter((function(t){return t.source===e})),h=0;h<f.length;h++){var g=f[h];"subflow"!=g.target.type&&g.sourcePort<n.wires.length&&n.wires[g.sourcePort].push(g.target.id)}if(e.inputs>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(n.inputLabels=e.inputLabels.slice()),e.outputs>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(n.outputLabels=e.outputLabels.slice()),(!e._def.defaults||!e._def.defaults.hasOwnProperty("icon"))&&e.icon){var v=RED.utils.getDefaultNodeIcon(e._def,e);e.icon!==v.module+"/"+v.file&&(n.icon=e.icon)}if((!e._def.defaults||!e._def.defaults.hasOwnProperty("l"))&&e.hasOwnProperty("l"))(!e._def.hasOwnProperty("showLabel")||e._def.showLabel)!=e.l&&(n.l=e.l)}return e.info&&(n.info=e.info),n}function A(e,t){var o=!0;!1===t?o=!1:"object"==typeof t&&(t.hasOwnProperty("credentials")&&(o=t.credentials),t.hasOwnProperty("dimensions")&&t.dimensions);var n={};if(n.id=e.id,n.type=e.type,n.name=e.name,n.info=e.info,n.category=e.category,n.in=[],n.out=[],n.env=e.env,n.meta=e.meta,o){var a={};for(var s in e.credentials)e.credentials.hasOwnProperty(s)&&(!e.credentials._||e.credentials["has_"+s]!=e.credentials._["has_"+s]||e.credentials["has_"+s]&&e.credentials[s])&&(a[s]=e.credentials[s]);Object.keys(a).length>0&&(n.credentials=a)}return n.color=e.color,e.in.forEach((function(e){for(var t={x:e.x,y:e.y,wires:[]},o=r.filter((function(t){return t.source===e})),i=0;i<o.length;i++){var a=o[i];"subflow"!=a.target.type&&t.wires.push({id:a.target.id})}n.in.push(t)})),e.out.forEach((function(t,o){var a={x:t.x,y:t.y,wires:[]},s=r.filter((function(e){return e.target===t}));for(i=0;i<s.length;i++)"subflow"!=s[i].source.type?a.wires.push({id:s[i].source.id,port:s[i].sourcePort}):a.wires.push({id:e.id,port:0});n.out.push(a)})),n.in.length>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(n.inputLabels=e.inputLabels.slice()),n.out.length>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(n.outputLabels=e.outputLabels.slice()),e.icon&&"node-red/subflow.svg"!==e.icon&&(n.icon=e.icon),e.status&&(n.status={x:e.status.x,y:e.status.y,wires:[]},r.forEach((function(t){t.target===e.status&&("subflow"!=t.source.type?n.status.wires.push({id:t.source.id,port:t.sourcePort}):n.status.wires.push({id:e.id,port:0}))}))),n}function M(e,t,o,i){var n=[];t=t||{},e=e.filter((function(e){return!t[e.id]&&(t[e.id]=!0,!0)})),i=i||{},o=o||{};for(var r=0;r<e.length;r++){var s=e[r];if("subflow:"==s.type.substring(0,8)){var d=s.type.substring(8);if(!o[d]){o[d]=!0;var l=S(d),c=E.getNodes(d).slice();c.unshift(l),RED.nodes.eachConfig((function(e){e.z==d&&(c.push(e),i[e.id]=!0)})),n=M(c=(c=c.concat(RED.nodes.junctions(d))).concat(RED.nodes.groups(d)),t,o,i).concat(n)}}if("subflow"!==s.type){var u=RED.nodes.convertNode(s);for(var p in s._def.defaults)if(s._def.defaults[p].type){var f=s[p];Array.isArray(f)||(f=[f]),0===(f=f.filter((function(t){if(t in a){var o=a[t];return!1!==o._def.exportable&&(t in i||(i[t]=!0,e.push(o)),!0)}return!0}))).length?u[p]=Array.isArray(s[p])?[]:"":u[p]=Array.isArray(s[p])?f:f[0]}n.push(u),"group"===s.type&&(n=n.concat(M(s.nodes,t,o,i)))}else{var h=A(s);n.push(h)}}return n}function z(e,t){var o;t=t||[];var i=null;return RED.nodes.eachSubflow((function(n){if(n.name==e.name&&n.info==e.info&&n.in.length==e.in.length&&n.out.length==e.out.length){var a=RED.nodes.filterNodes({z:n.id});if(a.length==t.length){var r=[e].concat(t),s=[n].concat(a),d=JSON.stringify(r),l=JSON.stringify(M(s));for(o=0;o<a.length;o++)d=d.replace(new RegExp('"'+t[o].id+'"',"g"),'"'+a[o].id+'"');if((d=d.replace(new RegExp('"'+e.id+'"',"g"),'"'+n.id+'"'))===l)return i=n,!1}}})),i}function B(e,t,o){if(o&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var i=e._def;for(var n in i.defaults)if(i.defaults.hasOwnProperty(n)){var a=e[n],r=t[n];if(typeof a!=typeof r)return!1;if(null===a||"string"==typeof a||"number"==typeof a){if(a!==r)return!1}else if(JSON.stringify(a)!==JSON.stringify(r))return!1}return!0}function G(e){var t={tabs:{},subflows:{},groups:{},junctions:{},configs:{},nodes:{},all:[],conflicted:{},zMap:{}};return e.forEach((function(e){t.all.push(e),"tab"===e.type?t.tabs[e.id]=e:"subflow"===e.type?t.subflows[e.id]=e:"group"===e.type?t.groups[e.id]=e:"junction"===e.type?t.junctions[e.id]=e:e.hasOwnProperty("x")&&e.hasOwnProperty("y")?t.nodes[e.id]=e:t.configs[e.id]=e;var o=e.z||"__global__";t.zMap[o]=t.zMap[o]||[],t.zMap[o].push(e),(E.hasNode(e.id)||a[e.id]||d[e.id]||c[e.id]||p[e.id]||h[e.id])&&(t.conflicted[e.id]=e)})),t}function F(e){var t={},o={},i={},n=[];e.forEach((function(e){"subflow"===e.type?o[e.id]=e:e.hasOwnProperty("x")||e.hasOwnProperty("y")||(i[e.id]=e),e.z&&(t[e.z]=t[e.z]||[],t[e.z].push(e))}));var a=Object.keys(i);a.forEach((function(e){var t=i[e];o[t.z]&&delete i[e]})),a=Object.keys(i);var r=Object.keys(o);return r.forEach((function(e){var i=o[e];n=n.concat(function(e){var t,o=S(e),i=E.getNodes(o.id);return i?(t=i.slice()).unshift(o):t=[o],M(t)}(e));RED.subflow.removeSubflow(i.id,!0),U([i].concat(t[i.id]));o[e]=S(e)})),RED.nodes.eachNode((function(e){if(/^subflow:/.test(e.type)){var t=e.type.substring(8);o[t]&&(o[t].instances.push(e),e._def=RED.nodes.getType(e.type),e.dirty=!0,e.changed=!0,e._colorChanged=!0)}})),r.forEach((function(e){var t=o[e];RED.events.emit("subflows:change",t)})),RED.utils.clearNodeColorCache(),a.forEach((function(e){n=n.concat(P(k(e))),T(e),U([i[e]])})),{removedNodes:n}}function U(o,i){(i=Object.assign({},{generateIds:!1,addFlow:!1,reimport:!1,importMap:{}},i)).importMap=i.importMap||{};const n=i.generateIds,r=!n&&!!i.reimport,s=i.addFlow;var l,u,f,g={};if("string"==typeof o){if(""===o)return;try{u=JSON.parse(o)}catch(X){var v=new Error(RED._("clipboard.invalidFlow",{message:X.message}));throw v.code="NODE_RED",v}}else u=o;$.isArray(u)||(u=[u]);var m,b={},y=[],R=[];if(u=u.filter((function(e){var t=e.id;if(b[e.id])return!1;if(b[e.id]=!0,!i.generateIds)if(i.importMap[t]){if("replace"===i.importMap[t])return R.push(e),!1}else{var o=E.getNode(t)||a[t]||d[t]||c[t]||p[t]||h[t];o&&y.push({existing:o,imported:e})}return!0})),y.length>0){for(var k=RED._("clipboard.importDuplicate",{count:y.length}),T=$("<ul>"),C=Math.min(5,y.length),I=0;I<C;I++){var N=y[I];$("<li>").text(N.existing.id+" [ "+N.existing.type+(N.imported.type!==N.existing.type?" | "+N.imported.type:"")+" ]").appendTo(T)}C!==y.length&&$("<li>").text(RED._("deploy.confirm.plusNMore",{count:y.length-C})).appendTo(T);var P=$("<p>").append(T),A=new Error(k+P.html());throw A.code="import_conflict",A.importConfig=G(u),A}R.length>0&&(m=F(R).removedNodes);var M=!1;t||(M=!0,t=JSON.parse(JSON.stringify(u)));var U=[];for(I=0;I<u.length;I++){(l=u[I]).id;"workspace"==l.type||"tab"==l.type||"subflow"==l.type||"group"==l.type||"junction"==l.type||w.getNodeType(l.type)||"subflow:"==l.type.substring(0,8)||-1!=U.indexOf(l.type)||U.push(l.type),l.z?(g[l.z]=g[l.z]||[],g[l.z].push(l)):M&&l.hasOwnProperty("x")&&l.hasOwnProperty("y")&&!l.z&&(f||(j(f={id:RED.nodes.id(),type:"tab",disabled:!1,label:RED._("clipboard.recoveredNodes"),info:RED._("clipboard.recoveredNodesInfo"),env:[]}),RED.workspaces.add(f),g[f.id]=[]),l.z=f.id,g[f.id].push(l))}if(!M&&U.length>0){var V=$("<ul>");U.forEach((function(e){$("<li>").text(e).appendTo(V)})),V=V[0].outerHTML,RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:U.length})+"</p>"+V,"error",!1,1e4)}var q=RED.workspaces.active(),K=S(q);for(I=0;I<u.length;I++){var H=/^subflow:(.+)$/.exec(u[I].type);if(H){var X,Y=H[1],Z=S(q);if(Z)if(Y===Z.id&&(X=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),O(Y,Z.id)&&(X=new Error(RED._("notification.errors.cannotAddCircularReference"))),X)throw X.code="NODE_RED",X}}var Q,ee,te,oe,ie=[],ne={},ae=[],re={},se={},de={},le=[],ce=[],ue=[],pe=[],fe=new Set,he=null;for(f&&ie.push(f),I=0;I<u.length;I++)if("workspace"===(l=u[I]).type||"tab"===l.type)"workspace"===l.type&&(l.type="tab"),null==e&&(e=l),0===q&&(q=l.id),n||"copy"===i.importMap[l.id]?(Q=D(),ne[l.id]=Q,l.id=Q):ne[l.id]=l.id,j(l),RED.workspaces.add(l),ie.push(l);else if("subflow"===l.type){var ge;i.importMap[l.id]||(ge=z(l,g[l.id])),ge?se[l.id]=ge:(re[l.id]=l,(n||"copy"===i.importMap[l.id])&&(Q=D(),l.id=Q),l.in.forEach((function(e,t){e.type="subflow",e.direction="in",e.z=l.id,e.i=t,e.id=D()})),l.out.forEach((function(e,t){e.type="subflow",e.direction="out",e.z=l.id,e.i=t,e.id=D()})),l.status&&(l.status.type="subflow",l.status.direction="status",l.status.z=l.id,l.status.id=D()),ae.push(l),L(l,n||"copy"===i.importMap[l.id]))}for(null==e&&(j(e={type:"tab",id:D(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1}),env:[]}),RED.workspaces.add(e),ie.push(e),q=RED.workspaces.active()),I=0;I<u.length;I++)if(l=u[I],(ee=w.getNodeType(l.type))&&"config"==ee.category){var ve=null;if(n||"copy"===i.importMap[l.id]){if(l.z){if(se[l.z])continue;re[l.z]?l.z=re[l.z].id:(l.z=ne[l.z],d[l.z]||(s?(null===he&&(he=RED.workspaces.add(null,!0),ie.push(he)),l.z=he.id):l.z=q))}if("copy"!==i.importMap[l.id]&&(ve=RED.nodes.node(l.id))&&l.z&&ve.z!==l.z)for(var me in ve=null,a)if(a.hasOwnProperty(me)&&a[me].z===l.z&&B(a[me],l,!1)){ve=a[me],de[l.id]=a[me];break}}else{r&&l.z&&RED.workspaces.contains(l.z)||!l.z||ne[l.z]||re[l.z]||(l.z=q)}if(!ve||ve._def.exclusive){for(oe in te={id:l.id,z:l.z,type:l.type,info:l.info,users:[],_config:{}},l.z||delete te.z,l.hasOwnProperty("d")&&(te.d=l.d),ee.defaults)ee.defaults.hasOwnProperty(oe)&&(te[oe]=l[oe],te._config[oe]=JSON.stringify(l[oe]));if(ee.hasOwnProperty("credentials")&&l.hasOwnProperty("credentials"))for(oe in te.credentials={},ee.credentials)ee.credentials.hasOwnProperty(oe)&&l.credentials.hasOwnProperty(oe)&&(te.credentials[oe]=l.credentials[oe]);te.label=ee.label,te._def=ee,(n||"copy"===i.importMap[l.id])&&(te.id=D()),de[l.id]=te,le.push(te)}}for(I=0;I<u.length;I++)if("workspace"!==(l=u[I]).type&&"tab"!==l.type&&"subflow"!==l.type&&(!(ee=w.getNodeType(l.type))||"config"!=ee.category)){var be={x:parseFloat(l.x||0),y:parseFloat(l.y||0),z:l.z,type:0,info:l.info,changed:!1,_config:{}};if("group"!==l.type&&"junction"!==l.type&&(be.wires=l.wires||[],be.inputLabels=l.inputLabels,be.outputLabels=l.outputLabels,be.icon=l.icon),"junction"===l.type&&(be.wires=l.wires||[]),l.hasOwnProperty("l")&&(be.l=l.l),l.hasOwnProperty("d")&&(be.d=l.d),l.hasOwnProperty("g")&&(be.g=l.g),n||"copy"===i.importMap[l.id]){if(se[l.z])continue;re[be.z]?be.z=re[be.z].id:(be.z=ne[be.z],d[be.z]||(s?(null===he&&(he=RED.workspaces.add(null,!0),ie.push(he)),be.z=he.id):be.z=q)),be.id=D()}else{be.id=l.id;r&&be.z&&RED.workspaces.contains(be.z)||null!=be.z&&(ne[be.z]||re[be.z])||(s?(null===he&&(he=RED.workspaces.add(null,!0),ie.push(he)),be.z=he.id):be.z=q)}if(be.type=l.type,be._def=ee,"group"===be.type){for(oe in be._def=RED.group.def,be._def.defaults)be._def.defaults.hasOwnProperty(oe)&&"inputs"!==oe&&"outputs"!==oe&&(be[oe]=l[oe],be._config[oe]=JSON.stringify(l[oe]));be._config.x=be.x,be._config.y=be.y}else if("subflow"===l.type.substring(0,7)){var ye=l.type.split(":")[1],we=se[ye]||re[ye]||S(ye);(n||"copy"===i.importMap[l.id])&&(ye=we.id,be.type="subflow:"+ye,be._def=w.getNodeType(be.type),delete be.i),be.name=l.name,be.outputs=we.out.length,be.inputs=we.in.length,be.env=l.env}else if("junction"===l.type)be._def={defaults:{}},be._config.x=be.x,be._config.y=be.y,be.inputs=1,be.outputs=1,be.w=0,be.h=0;else{if(!be._def){be.x&&be.y?be._def={color:"#fee",defaults:{},label:"unknown: "+l.type,labelStyle:"red-ui-flow-node-label-italic",outputs:l.outputs||l.wires&&l.wires.length||0,set:w.getNodeSet("node-red/unknown")}:(be._def={category:"config",set:w.getNodeSet("node-red/unknown")},be.users=[],delete be.x,delete be.y,delete be.wires,delete be.inputLabels,delete be.outputLabels,l.z||delete be.z);var Ee={};for(var De in l)l.hasOwnProperty(De)&&"x"!=De&&"y"!=De&&"z"!=De&&"id"!=De&&"wires"!=De&&(Ee[De]=l[De]);be._orig=Ee,be.name=l.type,be.type="unknown"}if("config"!=be._def.category){for(oe in l.hasOwnProperty("inputs")?(be.inputs=l.inputs,be._config.inputs=JSON.stringify(l.inputs)):be.inputs=be._def.inputs,l.hasOwnProperty("outputs")?(be.outputs=l.outputs,be._config.outputs=JSON.stringify(l.outputs)):be.outputs=be._def.outputs,be.hasOwnProperty("wires")&&be.wires.length>be.outputs&&(be._def.defaults.hasOwnProperty("outputs")&&isNaN(parseInt(l.outputs))?be.outputs=be.wires.length:(console.log("Warning: node.wires longer than node.outputs - trimming wires:",be.id," wires:",be.wires.length," outputs:",be.outputs),be.wires=be.wires.slice(0,be.outputs))),be._def.defaults)be._def.defaults.hasOwnProperty(oe)&&"inputs"!==oe&&"outputs"!==oe&&(be[oe]=l[oe],be._config[oe]=JSON.stringify(l[oe]));if(be._config.x=be.x,be._config.y=be.y,be._def.hasOwnProperty("credentials")&&l.hasOwnProperty("credentials"))for(oe in be.credentials={},be._def.credentials)be._def.credentials.hasOwnProperty(oe)&&l.credentials.hasOwnProperty(oe)&&(be.credentials[oe]=l.credentials[oe])}}de[l.id]=be,"junction"===be.type?pe.push(be):"unknown"===be.type||"config"!==be._def.category?le.push(be):"group"===be.type&&(ue.push(be),fe.add(be.id))}for(I=0;I<le.length+pe.length;I++){if((l=I<le.length?le[I]:pe[I-le.length]).wires){for(var Re=0;Re<l.wires.length;Re++)for(var xe=Array.isArray(l.wires[Re])?l.wires[Re]:[l.wires[Re]],_e=0;_e<xe.length;_e++)if(de.hasOwnProperty(xe[_e]))if(l.z===de[xe[_e]].z){var $e={source:l,sourcePort:Re,target:de[xe[_e]]};_($e),ce.push($e)}else console.log("Warning: dropping link that crosses tabs:",l.id,"->",de[xe[_e]].id);delete l.wires}for(var ke in l.g&&de[l.g]?l.g=de[l.g].id:delete l.g,l._def.defaults)if(l._def.defaults.hasOwnProperty(ke)&&l._def.defaults[ke].type){T=l[ke];Array.isArray(T)||(T=[T]),T=T.map((function(e){var t=de[e];return t?("config"===t._def.category&&-1===t.users.indexOf(l)&&t.users.push(l),t.id):e})),l[ke]=Array.isArray(l[ke])?T:T[0]}K&&/^link /.test(l.type)&&l.links&&(l.links=l.links.filter((function(e){var t=RED.nodes.node(e);return t&&t.z===q})))}for(I=0;I<ae.length;I++)(l=ae[I]).in.forEach((function(e){e.wires.forEach((function(t){var o={source:e,sourcePort:0,target:de[t.id]};_(o),ce.push(o)})),delete e.wires})),l.out.forEach((function(e){e.wires.forEach((function(t){var o;_(o=re[t.id]&&re[t.id].id==l.id?{source:l.in[t.port],sourcePort:t.port,target:e}:{source:de[t.id]||re[t.id],sourcePort:t.port,target:e}),ce.push(o)})),delete e.wires})),l.status&&(l.status.wires.forEach((function(e){var t;_(t=re[e.id]&&re[e.id].id==l.id?{source:l.in[e.port],sourcePort:e.port,target:l.status}:{source:de[e.id]||re[e.id],sourcePort:e.port,target:l.status}),ce.push(t)})),delete l.status.wires);var Te,Ce={};for(I=0;I<ue.length;I++)(l=ue[I]).g&&!fe.has(l.g)&&delete l.g,l.nodes=l.nodes.map((function(e){return de[e]})),l.nodes=l.nodes.filter((function(e){return e&&e.g!==l.id&&(e.g=l.id),!!e})),l.g||(Ce[l.id]=0);do{for(Te=!1,I=0;I<ue.length;I++)(l=ue[I]).g&&Ce[l.id]!==Ce[l.g]+1&&(Ce[l.id]=Ce[l.g]+1,Te=!0)}while(Te);for(ue.sort((function(e,t){return Ce[e.id]-Ce[t.id]})),I=0;I<ue.length;I++)J(l=ue[I]);for(I=0;I<pe.length;I++){W(pe[I])}for(I=0;I<le.length;I++){x(be=le[I])}for(I=0;I<le.length;I++){be=le[I];RED.editor.validateNode(be)}if(RED.workspaces.refresh(),f)var je=RED.notify(RED._("clipboard.recoveredNodesNotification",{flowName:RED._("clipboard.recoveredNodes")}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){je.close()}}]});return{nodes:le,links:ce,groups:ue,junctions:pe,workspaces:ie,subflows:ae,missingWorkspace:he,removedNodes:m}}function V(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var o=e._def.defaults[t];if(o.type){var i=w.getNodeType(o.type);if(i&&"config"==i.category){var n=a[e[t]];n&&-1===n.users.indexOf(e)&&(n.users.push(e),RED.events.emit("nodes:change",n))}}}}function J(e){f[e.z]=f[e.z]||[],f[e.z].push(e),p[e.id]=e,RED.events.emit("groups:add",e)}function q(e){var t=f[e.z].indexOf(e);if(f[e.z].splice(t,1),0===f[e.z].length&&delete f[e.z],e.g&&p[e.g]){var o=p[e.g].nodes.indexOf(e);p[e.g].nodes.splice(o,1)}RED.group.markDirty(e),delete p[e.id],RED.events.emit("groups:remove",e)}function W(e){g[e.z]=g[e.z]||[],g[e.z].push(e),h[e.id]=e,s[e.id]||(s[e.id]={in:[],out:[]}),RED.events.emit("junctions:add",e)}function K(e){var t=g[e.z].indexOf(e);g[e.z].splice(t,1),0===g[e.z].length&&delete g[e.z],delete h[e.id],delete s[e.id],RED.events.emit("junctions:remove",e);var o=r.filter((function(t){return t.source===e||t.target===e}));return o.forEach(C),{links:o}}return{init:function(){RED.events.on("registry:node-type-added",(function(e){w.getNodeType(e);var t={};RED.nodes.eachNode((function(o){"unknown"===o.type&&o.name===e&&(t[o.id]=o)})),RED.nodes.eachConfig((function(o){"unknown"===o.type&&o.name===e&&(t[o.id]=o)}));var o=Object.keys(t);if(o.length>0){var i=[];o.forEach((function(e){var o=t[e];a.hasOwnProperty(o.id)?delete a[o.id]:E.removeNode(o),i.push(P(o)),RED.events.emit("nodes:remove",o)}));var n=[];RED.nodes.eachLink((function(e){t.hasOwnProperty(e.source.id)&&t.hasOwnProperty(e.target.id)&&n.push(e)})),n.forEach(C),RED.view.redraw(!0,!0);var r=U(i,{generateIds:!1,reimport:!0}),s={};r.nodes.forEach((function(e){s[e.id]=e})),RED.nodes.eachLink((function(e){s.hasOwnProperty(e.source.id)&&(e.source=s[e.source.id]),s.hasOwnProperty(e.target.id)&&(e.target=s[e.target.id])})),RED.view.redraw(!0)}}))},registry:w,setNodeList:w.setNodeList,getNodeSet:w.getNodeSet,addNodeSet:w.addNodeSet,removeNodeSet:w.removeNodeSet,enableNodeSet:w.enableNodeSet,disableNodeSet:w.disableNodeSet,setIconSets:w.setIconSets,getIconSets:w.getIconSets,registerType:w.registerNodeType,getType:w.getNodeType,getNodeHelp:function(e){var t="",o=$("script[data-help-name='"+e+"']");return o&&(t=o.html(),"text/markdown"===o.attr("type")&&(t=RED.utils.renderMarkdown(t))),t},convertNode:P,add:x,remove:T,clear:function(){r=[],o={},s={},a={},l=[],p={},f={},h={},g={},Object.keys(c).forEach((function(e){RED.subflow.removeSubflow(e)})),Object.keys(d).forEach((function(e){RED.workspaces.remove(d[e])})),e=null,t=null,d={},E.clear(),RED.nodes.dirty(!1),RED.view.redraw(!0,!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh(),RED.events.emit("workspace:clear")},detachNodes:function(e){let t=[];if(e.forEach((e=>{if("group"===e.type){let o=RED.group.getNodes(e,!0,!0);t=t.concat(o)}else t.push(e)})),t.length>0){const e=RED.nodes.getNodeIslands(t);let o=[],i=[],n=new Set;return e.forEach((e=>{let t=new Set(e),a=[],r=[];e.forEach((e=>{var o=RED.nodes.getNodeLinks(e,1),i=RED.nodes.getNodeLinks(e,0);o.forEach((e=>{t.has(e.source)||a.push(e)})),i.forEach((e=>{t.has(e.target)||r.push(e)}))})),a.forEach((e=>{let o=e.source,a=new Set,r=new Set,s=[e.target];for(;s.length>0;){let e=s.pop(s);r.add(e),RED.nodes.getNodeLinks(e,0).forEach((e=>{r.has(e.target)||(r.add(e.target),t.has(e.target)?s.push(e.target):a.add(e.target))}))}a.forEach((t=>{let a=`${o.id}[${e.sourcePort}] -> ${t.id}`;if(!n.has(a)){n.add(a);let r={source:o,sourcePort:e.sourcePort,target:t};0===RED.nodes.filterLinks(r).length&&i.push(r)}}))})),a.forEach((e=>{RED.nodes.removeLink(e),o.push(e)})),r.forEach((e=>{RED.nodes.removeLink(e),o.push(e)}))})),i.forEach((e=>RED.nodes.addLink(e))),{newLinks:i,removedLinks:o}}},moveNodesForwards:function(e){return E.moveNodesForwards(e)},moveNodesBackwards:function(e){return E.moveNodesBackwards(e)},moveNodesToFront:function(e){return E.moveNodesToFront(e)},moveNodesToBack:function(e){return E.moveNodesToBack(e)},getNodeOrder:function(e){return E.getNodeOrder(e)},setNodeOrder:function(e,t){E.setNodeOrder(e,t)},moveNodeToTab:function(e,t){if("group"!==e.type)if("junction"!==e.type){var i=e.z;E.moveNode(e,t);var n=s[e.id];n&&(n.in.forEach((function(e){var n=o[i].indexOf(e);-1!=n&&o[i].splice(n,1),e.source.z===t&&o[t]&&o[t].push(e)})),n.out.forEach((function(e){var n=o[i].indexOf(e);-1!=n&&o[i].splice(n,1),e.target.z===t&&o[t]&&o[t].push(e)}))),RED.events.emit("nodes:change",e)}else!function(e,t){var i=g[e.z].indexOf(e);g[e.z].splice(i,1),g[t]=g[t]||[],g[t].push(e);var n=e.z;e.z=t;var a=s[e.id];a&&(a.in.forEach((function(e){var i=o[n].indexOf(e);-1!=i&&o[n].splice(i,1),e.source.z===t&&o[t]&&o[t].push(e)})),a.out.forEach((function(e){var i=o[n].indexOf(e);-1!=i&&o[n].splice(i,1),e.target.z===t&&o[t]&&o[t].push(e)})));RED.events.emit("junctions:change",e)}(e,t);else!function(e,t){var o=f[e.z].indexOf(e);f[e.z].splice(o,1),f[t]=f[t]||[],f[t].push(e),e.z=t,RED.events.emit("groups:change",e)}(e,t)},addLink:_,removeLink:C,getNodeLinks:function(e,t){return"string"!=typeof e&&(e=e.id),s[e]?[].concat(1===t?s[e].in:s[e].out):[]},addWorkspace:j,removeWorkspace:function(e){var t=d[e],i=[],n=[],r=[],s=[];if(t){var c,u;for(c in delete d[e],delete o[e],l.splice(l.indexOf(e),1),E.hasTab(e)&&(i=E.getNodes(e).slice()),a)a.hasOwnProperty(c)&&(u=a[c]).z==e&&i.push(u);for(s=RED.nodes.junctions(e),c=0;c<i.length;c++){var p=T(i[c].id);n=n.concat(p.links)}for(c=0;c<s.length;c++){p=K(s[c]);n=n.concat(p.links)}for(r=(f[e]||[]).filter((function(e){return!e.g})),c=0;c<r.length;c++)r[c].nodes.forEach((function(e){"group"===e.type&&r.push(e)}));for(c=r.length-1;c>=0;c--)q(r[c]);E.removeTab(e),RED.events.emit("flows:remove",t)}return{nodes:i,links:n,groups:r,junctions:s}},getWorkspaceOrder:function(){return l},setWorkspaceOrder:function(e){l=e},workspace:function(e){return d[e]},addSubflow:L,removeSubflow:function(e){c[e.id]&&(delete c[e.id],E.removeTab(e.id),w.removeNodeType("subflow:"+e.id),RED.events.emit("subflows:remove",e))},subflow:S,subflowContains:O,addGroup:J,removeGroup:q,group:function(e){return p[e]},groups:function(e){return f[e]?f[e].slice():[]},addJunction:W,removeJunction:K,junction:function(e){return h[e]},junctions:function(e){return g[e]?g[e].slice():[]},eachNode:function(e){E.eachNode(e)},eachLink:function(e){for(var t=0;t<r.length&&!1!==e(r[t]);t++);},eachConfig:function(e){for(var t in a)if(a.hasOwnProperty(t)&&!1===e(a[t]))break},eachSubflow:function(e){for(var t in c)if(c.hasOwnProperty(t)&&!1===e(c[t]))break},eachWorkspace:function(e){for(var t=0;t<l.length&&!1!==e(d[l[t]]);t++);},node:k,version:function(e){if(void 0===e)return u;u=e},originalFlow:function(e){if(void 0===e)return t;t=e},filterNodes:function(e){return E.filterNodes(e)},filterLinks:function(e){var t,i=[],n=[],a=!1,d=e.source&&e.source.z,l=e.target&&e.target.z;(d||l)&&(t=d===l?d:void 0===d?l:d),t?(n=o[t]||[],a=!0):e.source&&e.source.hasOwnProperty("id")?s[e.source.id]&&(a=!0,n=n.concat(s[e.source.id].out)):e.target&&e.target.hasOwnProperty("id")&&s[e.target.id]&&(a=!0,n=n.concat(s[e.target.id].in)),a||(n=r);for(var c=0;c<n.length;c++){var u=n[c];if(e.source){if(e.source.hasOwnProperty("id")&&u.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&u.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&u.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&u.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&u.sourcePort!==e.sourcePort||i.push(u)}return i},import:U,identifyImportConflicts:G,getAllFlowNodes:I,getAllUpstreamNodes:function(e){return I(e,"up").filter((function(t){return t!==e}))},getAllDownstreamNodes:function(e){return I(e,"down").filter((function(t){return t!==e}))},getNodeIslands:function(e){var t=new Set(e),o=new Map,i=new Map,n=new Set;e.forEach(((e,a)=>{o.set(e,a),i.set(a,[e]);var r=RED.nodes.getNodeLinks(e,1),s=RED.nodes.getNodeLinks(e,0);r.forEach((e=>{t.has(e.source)&&n.add(e)})),s.forEach((e=>{t.has(e.target)&&n.add(e)}))})),n.forEach((e=>{let t=e.source,n=e.target;if(o.get(t)!==o.get(n)){let e=o.get(t),a=o.get(n);i.get(a).forEach((t=>{o.set(t,e),i.get(e).push(t)})),i.delete(a)}}));const a=[];return i.forEach(((e,t)=>{a.push(e)})),a},createExportableNodeSet:M,createCompleteNodeSet:function(e){var t,o=[];for(t=0;t<l.length;t++)"tab"==d[l[t]].type&&o.push(N(d[l[t]],e));for(t in c)c.hasOwnProperty(t)&&o.push(A(c[t],e));for(t in p)p.hasOwnProperty(t)&&o.push(P(p[t],e));for(t in h)h.hasOwnProperty(t)&&o.push(P(h[t],e));for(t in a)a.hasOwnProperty(t)&&o.push(P(a[t],e));return RED.nodes.eachNode((function(t){o.push(P(t,e))})),o},updateConfigNodeUsers:V,id:D,dirty:function(e){if(null==e)return v;!function(e){v=e,RED.events.emit("workspace:dirty",{dirty:v})}(e)}}}(),RED.nodes.fontAwesome=function(){var e={"fa-address-book-o":"","fa-address-book":"","fa-address-card-o":"","fa-address-card":"","fa-adjust":"","fa-align-center":"","fa-align-justify":"","fa-align-left":"","fa-align-right":"","fa-ambulance":"","fa-american-sign-language-interpreting":"","fa-anchor":"","fa-angle-double-down":"","fa-angle-double-left":"","fa-angle-double-right":"","fa-angle-double-up":"","fa-angle-down":"","fa-angle-left":"","fa-angle-right":"","fa-angle-up":"","fa-archive":"","fa-area-chart":"","fa-arrow-circle-down":"","fa-arrow-circle-left":"","fa-arrow-circle-o-down":"","fa-arrow-circle-o-left":"","fa-arrow-circle-o-right":"","fa-arrow-circle-o-up":"","fa-arrow-circle-right":"","fa-arrow-circle-up":"","fa-arrow-down":"","fa-arrow-left":"","fa-arrow-right":"","fa-arrow-up":"","fa-arrows-alt":"","fa-arrows-h":"","fa-arrows-v":"","fa-arrows":"","fa-asl-interpreting":"","fa-assistive-listening-systems":"","fa-asterisk":"","fa-at":"","fa-audio-description":"","fa-automobile":"","fa-backward":"","fa-balance-scale":"","fa-ban":"","fa-bank":"","fa-bar-chart-o":"","fa-bar-chart":"","fa-barcode":"","fa-bars":"","fa-bath":"","fa-bathtub":"","fa-battery-0":"","fa-battery-1":"","fa-battery-2":"","fa-battery-3":"","fa-battery-4":"","fa-battery-empty":"","fa-battery-full":"","fa-battery-half":"","fa-battery-quarter":"","fa-battery-three-quarters":"","fa-battery":"","fa-bed":"","fa-beer":"","fa-bell-o":"","fa-bell-slash-o":"","fa-bell-slash":"","fa-bell":"","fa-bicycle":"","fa-binoculars":"","fa-birthday-cake":"","fa-blind":"","fa-bold":"","fa-bolt":"","fa-bomb":"","fa-book":"","fa-bookmark-o":"","fa-bookmark":"","fa-braille":"","fa-briefcase":"","fa-bug":"","fa-building-o":"","fa-building":"","fa-bullhorn":"","fa-bullseye":"","fa-bus":"","fa-cab":"","fa-calculator":"","fa-calendar-check-o":"","fa-calendar-minus-o":"","fa-calendar-o":"","fa-calendar-plus-o":"","fa-calendar-times-o":"","fa-calendar":"","fa-camera-retro":"","fa-camera":"","fa-car":"","fa-caret-down":"","fa-caret-left":"","fa-caret-right":"","fa-caret-square-o-down":"","fa-caret-square-o-left":"","fa-caret-square-o-right":"","fa-caret-square-o-up":"","fa-caret-up":"","fa-cart-arrow-down":"","fa-cart-plus":"","fa-cc":"","fa-certificate":"","fa-chain-broken":"","fa-chain":"","fa-check-circle-o":"","fa-check-circle":"","fa-check-square-o":"","fa-check-square":"","fa-check":"","fa-chevron-circle-down":"","fa-chevron-circle-left":"","fa-chevron-circle-right":"","fa-chevron-circle-up":"","fa-chevron-down":"","fa-chevron-left":"","fa-chevron-right":"","fa-chevron-up":"","fa-child":"","fa-circle-o-notch":"","fa-circle-o":"","fa-circle-thin":"","fa-circle":"","fa-clipboard":"","fa-clock-o":"","fa-clone":"","fa-close":"","fa-cloud-download":"","fa-cloud-upload":"","fa-cloud":"","fa-cny":"","fa-code-fork":"","fa-code":"","fa-coffee":"","fa-cog":"","fa-cogs":"","fa-columns":"","fa-comment-o":"","fa-comment":"","fa-commenting-o":"","fa-commenting":"","fa-comments-o":"","fa-comments":"","fa-compass":"","fa-compress":"","fa-copy":"","fa-copyright":"","fa-creative-commons":"","fa-credit-card-alt":"","fa-credit-card":"","fa-crop":"","fa-crosshairs":"","fa-cube":"","fa-cubes":"","fa-cut":"","fa-cutlery":"","fa-dashboard":"","fa-database":"","fa-deaf":"","fa-deafness":"","fa-dedent":"","fa-desktop":"","fa-diamond":"","fa-dollar":"","fa-dot-circle-o":"","fa-download":"","fa-drivers-license-o":"","fa-drivers-license":"","fa-edit":"","fa-eject":"","fa-ellipsis-h":"","fa-ellipsis-v":"","fa-envelope-o":"","fa-envelope-open-o":"","fa-envelope-open":"","fa-envelope-square":"","fa-envelope":"","fa-eraser":"","fa-eur":"","fa-euro":"","fa-exchange":"","fa-exclamation-circle":"","fa-exclamation-triangle":"","fa-exclamation":"","fa-expand":"","fa-external-link-square":"","fa-external-link":"","fa-eye-slash":"","fa-eye":"","fa-eyedropper":"","fa-fast-backward":"","fa-fast-forward":"","fa-fax":"","fa-feed":"","fa-female":"","fa-fighter-jet":"","fa-file-archive-o":"","fa-file-audio-o":"","fa-file-code-o":"","fa-file-excel-o":"","fa-file-image-o":"","fa-file-movie-o":"","fa-file-o":"","fa-file-pdf-o":"","fa-file-photo-o":"","fa-file-picture-o":"","fa-file-powerpoint-o":"","fa-file-sound-o":"","fa-file-text-o":"","fa-file-text":"","fa-file-video-o":"","fa-file-word-o":"","fa-file-zip-o":"","fa-file":"","fa-files-o":"","fa-film":"","fa-filter":"","fa-fire-extinguisher":"","fa-fire":"","fa-flag-checkered":"","fa-flag-o":"","fa-flag":"","fa-flash":"","fa-flask":"","fa-floppy-o":"","fa-folder-o":"","fa-folder-open-o":"","fa-folder-open":"","fa-folder":"","fa-font":"","fa-forward":"","fa-frown-o":"","fa-futbol-o":"","fa-gamepad":"","fa-gavel":"","fa-gbp":"","fa-gear":"","fa-gears":"","fa-genderless":"","fa-gift":"","fa-glass":"","fa-globe":"","fa-graduation-cap":"","fa-group":"","fa-h-square":"","fa-hand-grab-o":"","fa-hand-lizard-o":"","fa-hand-o-down":"","fa-hand-o-left":"","fa-hand-o-right":"","fa-hand-o-up":"","fa-hand-paper-o":"","fa-hand-peace-o":"","fa-hand-pointer-o":"","fa-hand-rock-o":"","fa-hand-scissors-o":"","fa-hand-spock-o":"","fa-hand-stop-o":"","fa-handshake-o":"","fa-hard-of-hearing":"","fa-hashtag":"","fa-hdd-o":"","fa-header":"","fa-headphones":"","fa-heart-o":"","fa-heart":"","fa-heartbeat":"","fa-history":"","fa-home":"","fa-hospital-o":"","fa-hotel":"","fa-hourglass-1":"","fa-hourglass-2":"","fa-hourglass-3":"","fa-hourglass-end":"","fa-hourglass-half":"","fa-hourglass-o":"","fa-hourglass-start":"","fa-hourglass":"","fa-i-cursor":"","fa-id-badge":"","fa-id-card-o":"","fa-id-card":"","fa-ils":"","fa-image":"","fa-inbox":"","fa-indent":"","fa-industry":"","fa-info-circle":"","fa-info":"","fa-inr":"","fa-institution":"","fa-intersex":"","fa-italic":"","fa-jpy":"","fa-key":"","fa-keyboard-o":"","fa-krw":"","fa-language":"","fa-laptop":"","fa-leaf":"","fa-legal":"","fa-lemon-o":"","fa-level-down":"","fa-level-up":"","fa-life-bouy":"","fa-life-buoy":"","fa-life-ring":"","fa-life-saver":"","fa-lightbulb-o":"","fa-line-chart":"","fa-link":"","fa-list-alt":"","fa-list-ol":"","fa-list-ul":"","fa-list":"","fa-location-arrow":"","fa-lock":"","fa-long-arrow-down":"","fa-long-arrow-left":"","fa-long-arrow-right":"","fa-long-arrow-up":"","fa-low-vision":"","fa-magic":"","fa-magnet":"","fa-mail-forward":"","fa-mail-reply-all":"","fa-mail-reply":"","fa-male":"","fa-map-marker":"","fa-map-o":"","fa-map-pin":"","fa-map-signs":"","fa-map":"","fa-mars-double":"","fa-mars-stroke-h":"","fa-mars-stroke-v":"","fa-mars-stroke":"","fa-mars":"","fa-medkit":"","fa-meh-o":"","fa-mercury":"","fa-microchip":"","fa-microphone-slash":"","fa-microphone":"","fa-minus-circle":"","fa-minus-square-o":"","fa-minus-square":"","fa-minus":"","fa-mobile-phone":"","fa-mobile":"","fa-money":"","fa-moon-o":"","fa-mortar-board":"","fa-motorcycle":"","fa-mouse-pointer":"","fa-music":"","fa-navicon":"","fa-neuter":"","fa-newspaper-o":"","fa-object-group":"","fa-object-ungroup":"","fa-outdent":"","fa-paint-brush":"","fa-paper-plane-o":"","fa-paper-plane":"","fa-paperclip":"","fa-paragraph":"","fa-paste":"","fa-pause-circle-o":"","fa-pause-circle":"","fa-pause":"","fa-paw":"","fa-pencil-square-o":"","fa-pencil-square":"","fa-pencil":"","fa-percent":"","fa-phone-square":"","fa-phone":"","fa-photo":"","fa-picture-o":"","fa-pie-chart":"","fa-plane":"","fa-play-circle-o":"","fa-play-circle":"","fa-play":"","fa-plug":"","fa-plus-circle":"","fa-plus-square-o":"","fa-plus-square":"","fa-plus":"","fa-podcast":"","fa-power-off":"","fa-print":"","fa-puzzle-piece":"","fa-qrcode":"","fa-question-circle-o":"","fa-question-circle":"","fa-question":"","fa-quote-left":"","fa-quote-right":"","fa-random":"","fa-recycle":"","fa-refresh":"","fa-registered":"","fa-remove":"","fa-reorder":"","fa-repeat":"","fa-reply-all":"","fa-reply":"","fa-retweet":"","fa-rmb":"","fa-road":"","fa-rocket":"","fa-rotate-left":"","fa-rotate-right":"","fa-rouble":"","fa-rss-square":"","fa-rss":"","fa-rub":"","fa-ruble":"","fa-rupee":"","fa-s15":"","fa-save":"","fa-scissors":"","fa-search-minus":"","fa-search-plus":"","fa-search":"","fa-send-o":"","fa-send":"","fa-server":"","fa-share-square-o":"","fa-share-square":"","fa-share":"","fa-shekel":"","fa-sheqel":"","fa-shield":"","fa-ship":"","fa-shopping-bag":"","fa-shopping-basket":"","fa-shopping-cart":"","fa-shower":"","fa-sign-in":"","fa-sign-language":"","fa-sign-out":"","fa-signal":"","fa-signing":"","fa-sitemap":"","fa-sliders":"","fa-smile-o":"","fa-snowflake-o":"","fa-soccer-ball-o":"","fa-sort-alpha-asc":"","fa-sort-alpha-desc":"","fa-sort-amount-asc":"","fa-sort-amount-desc":"","fa-sort-asc":"","fa-sort-desc":"","fa-sort-down":"","fa-sort-numeric-asc":"","fa-sort-numeric-desc":"","fa-sort-up":"","fa-sort":"","fa-space-shuttle":"","fa-spinner":"","fa-spoon":"","fa-square-o":"","fa-square":"","fa-star-half-empty":"","fa-star-half-full":"","fa-star-half-o":"","fa-star-half":"","fa-star-o":"","fa-star":"","fa-step-backward":"","fa-step-forward":"","fa-stethoscope":"","fa-sticky-note-o":"","fa-sticky-note":"","fa-stop-circle-o":"","fa-stop-circle":"","fa-stop":"","fa-street-view":"","fa-strikethrough":"","fa-subscript":"","fa-subway":"","fa-suitcase":"","fa-sun-o":"","fa-superscript":"","fa-support":"","fa-table":"","fa-tablet":"","fa-tachometer":"","fa-tag":"","fa-tags":"","fa-tasks":"","fa-taxi":"","fa-television":"","fa-terminal":"","fa-text-height":"","fa-text-width":"","fa-th-large":"","fa-th-list":"","fa-th":"","fa-thermometer-0":"","fa-thermometer-1":"","fa-thermometer-2":"","fa-thermometer-3":"","fa-thermometer-4":"","fa-thermometer-empty":"","fa-thermometer-full":"","fa-thermometer-half":"","fa-thermometer-quarter":"","fa-thermometer-three-quarters":"","fa-thermometer":"","fa-thumb-tack":"","fa-thumbs-down":"","fa-thumbs-o-down":"","fa-thumbs-o-up":"","fa-thumbs-up":"","fa-ticket":"","fa-times-circle-o":"","fa-times-circle":"","fa-times-rectangle-o":"","fa-times-rectangle":"","fa-times":"","fa-tint":"","fa-toggle-down":"","fa-toggle-left":"","fa-toggle-off":"","fa-toggle-on":"","fa-toggle-right":"","fa-toggle-up":"","fa-trademark":"","fa-train":"","fa-transgender-alt":"","fa-transgender":"","fa-trash-o":"","fa-trash":"","fa-tree":"","fa-trophy":"","fa-truck":"","fa-try":"","fa-tty":"","fa-turkish-lira":"","fa-tv":"","fa-umbrella":"","fa-underline":"","fa-undo":"","fa-universal-access":"","fa-university":"","fa-unlink":"","fa-unlock-alt":"","fa-unlock":"","fa-unsorted":"","fa-upload":"","fa-usd":"","fa-user-circle-o":"","fa-user-circle":"","fa-user-md":"","fa-user-o":"","fa-user-plus":"","fa-user-secret":"","fa-user-times":"","fa-user":"","fa-users":"","fa-vcard-o":"","fa-vcard":"","fa-venus-double":"","fa-venus-mars":"","fa-venus":"","fa-video-camera":"","fa-volume-control-phone":"","fa-volume-down":"","fa-volume-off":"","fa-volume-up":"","fa-warning":"","fa-wheelchair-alt":"","fa-wheelchair":"","fa-wifi":"","fa-window-close-o":"","fa-window-close":"","fa-window-maximize":"","fa-window-minimize":"","fa-window-restore":"","fa-won":"","fa-wrench":"","fa-yen":""},t={"fa-500px":"","fa-adn":"","fa-amazon":"","fa-android":"","fa-angellist":"","fa-apple":"","fa-bandcamp":"","fa-behance-square":"","fa-behance":"","fa-bitbucket-square":"","fa-bitbucket":"","fa-bitcoin":"","fa-black-tie":"","fa-bluetooth-b":"","fa-bluetooth":"","fa-btc":"","fa-buysellads":"","fa-cc-amex":"","fa-cc-diners-club":"","fa-cc-discover":"","fa-cc-jcb":"","fa-cc-mastercard":"","fa-cc-paypal":"","fa-cc-stripe":"","fa-cc-visa":"","fa-chrome":"","fa-codepen":"","fa-codiepie":"","fa-connectdevelop":"","fa-contao":"","fa-css3":"","fa-dashcube":"","fa-delicious":"","fa-deviantart":"","fa-digg":"","fa-dribbble":"","fa-dropbox":"","fa-drupal":"","fa-edge":"","fa-eercast":"","fa-empire":"","fa-envira":"","fa-etsy":"","fa-expeditedssl":"","fa-fa":"","fa-facebook-f":"","fa-facebook-official":"","fa-facebook-square":"","fa-facebook":"","fa-firefox":"","fa-first-order":"","fa-flickr":"","fa-font-awesome":"","fa-fonticons":"","fa-fort-awesome":"","fa-forumbee":"","fa-foursquare":"","fa-free-code-camp":"","fa-ge":"","fa-get-pocket":"","fa-gg-circle":"","fa-gg":"","fa-git-square":"","fa-git":"","fa-github-alt":"","fa-github-square":"","fa-github":"","fa-gitlab":"","fa-gittip":"","fa-glide-g":"","fa-glide":"","fa-google-plus-circle":"","fa-google-plus-official":"","fa-google-plus-square":"","fa-google-plus":"","fa-google-wallet":"","fa-google":"","fa-gratipay":"","fa-grav":"","fa-hacker-news":"","fa-houzz":"","fa-html5":"","fa-imdb":"","fa-instagram":"","fa-internet-explorer":"","fa-ioxhost":"","fa-joomla":"","fa-jsfiddle":"","fa-lastfm-square":"","fa-lastfm":"","fa-leanpub":"","fa-linkedin-square":"","fa-linkedin":"","fa-linode":"","fa-linux":"","fa-maxcdn":"","fa-meanpath":"","fa-medium":"","fa-meetup":"","fa-mixcloud":"","fa-modx":"","fa-odnoklassniki-square":"","fa-odnoklassniki":"","fa-opencart":"","fa-openid":"","fa-opera":"","fa-optin-monster":"","fa-pagelines":"","fa-paypal":"","fa-pied-piper-alt":"","fa-pied-piper-pp":"","fa-pied-piper":"","fa-pinterest-p":"","fa-pinterest-square":"","fa-pinterest":"","fa-product-hunt":"","fa-qq":"","fa-quora":"","fa-ra":"","fa-ravelry":"","fa-rebel":"","fa-reddit-alien":"","fa-reddit-square":"","fa-reddit":"","fa-renren":"","fa-resistance":"","fa-safari":"","fa-scribd":"","fa-sellsy":"","fa-share-alt-square":"","fa-share-alt":"","fa-shirtsinbulk":"","fa-simplybuilt":"","fa-skyatlas":"","fa-skype":"","fa-slack":"","fa-slideshare":"","fa-snapchat-ghost":"","fa-snapchat-square":"","fa-snapchat":"","fa-soundcloud":"","fa-spotify":"","fa-stack-exchange":"","fa-stack-overflow":"","fa-steam-square":"","fa-steam":"","fa-stumbleupon-circle":"","fa-stumbleupon":"","fa-superpowers":"","fa-telegram":"","fa-tencent-weibo":"","fa-themeisle":"","fa-trello":"","fa-tripadvisor":"","fa-tumblr-square":"","fa-tumblr":"","fa-twitch":"","fa-twitter-square":"","fa-twitter":"","fa-usb":"","fa-viacoin":"","fa-viadeo-square":"","fa-viadeo":"","fa-vimeo-square":"","fa-vimeo":"","fa-vine":"","fa-vk":"","fa-wechat":"","fa-weibo":"","fa-weixin":"","fa-whatsapp":"","fa-wikipedia-w":"","fa-windows":"","fa-wordpress":"","fa-wpbeginner":"","fa-wpexplorer":"","fa-wpforms":"","fa-xing-square":"","fa-xing":"","fa-y-combinator-square":"","fa-y-combinator":"","fa-yahoo":"","fa-yc-square":"","fa-yc":"","fa-yelp":"","fa-yoast":"","fa-youtube-play":"","fa-youtube-square":"","fa-youtube":""},o=Object.keys(e);return{getIconUnicode:function(o){return e[o]||t[o]},getIconList:function(){return o}}}(),RED.history=function(){var e=[],t=[];function o(e){var t=RED.nodes.node(e);return t||RED.nodes.junction(e)}function i(e){var t,n,a,r,s={};if(e){if("multi"==e.t)for(r={t:"multi",events:[]},t=e.events.length-1;t>=0;t--){var d=i(e.events[t]);r.events.push(d)}else if("replace"==e.t)if(e.complete){r={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:{},rev:RED.nodes.version()},RED.nodes.clear(),RED.nodes.import(e.config).nodes.forEach((function(t){e.changed[t.id]&&(t.changed=!0,r.changed[t.id]=!0)})),RED.nodes.version(e.rev)}else{var l={};e.config.forEach((function(e){l[e.id]="replace"}));var c=RED.nodes.import(e.config,{importMap:l});r={t:"replace",config:c.removedNodes,dirty:RED.nodes.dirty()}}else if("add"==e.t){if(r={t:"delete",dirty:RED.nodes.dirty()},e.nodes)for(r.nodes=[],t=0;t<e.nodes.length;t++){if((n=RED.nodes.node(e.nodes[t])).z&&(s[n.z]=!0),r.nodes.push(n),RED.nodes.remove(e.nodes[t]),n.g)-1!==(p=(u=RED.nodes.group(n.g)).nodes.indexOf(n))&&(u.nodes.splice(p,1),RED.group.markDirty(u))}if(e.links)for(r.links=[],t=0;t<e.links.length;t++)r.links.push(e.links[t]),RED.nodes.removeLink(e.links[t]);if(e.junctions)for(r.junctions=[],t=0;t<e.junctions.length;t++){var u,p;if(r.junctions.push(e.junctions[t]),RED.nodes.removeJunction(e.junctions[t]),e.junctions[t].g)-1!==(p=(u=RED.nodes.group(e.junctions[t].g)).nodes.indexOf(e.junctions[t]))&&(u.nodes.splice(p,1),RED.group.markDirty(u))}if(e.groups)for(r.groups=[],t=e.groups.length-1;t>=0;t--)s[(u=e.groups[t]).z]=!0,r.groups.unshift(u),RED.nodes.removeGroup(u);if(e.workspaces)for(r.workspaces=[],t=0;t<e.workspaces.length;t++){var f=RED.nodes.getWorkspaceOrder();e.workspaces[t]._index=f.indexOf(e.workspaces[t].id),r.workspaces.push(e.workspaces[t]),RED.nodes.removeWorkspace(e.workspaces[t].id),RED.workspaces.remove(e.workspaces[t])}if(e.subflows)for(r.subflows=[],t=0;t<e.subflows.length;t++)r.subflows.push(e.subflows[t]),RED.nodes.removeSubflow(e.subflows[t]),RED.workspaces.remove(e.subflows[t]);if(e.subflow&&(r.subflow={},e.subflow.instances&&(r.subflow.instances=[],e.subflow.instances.forEach((function(e){r.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}))),e.subflow.hasOwnProperty("changed")&&(a=RED.nodes.subflow(e.subflow.id))&&(a.changed=e.subflow.changed)),e.removedLinks)for(r.createdLinks=[],t=0;t<e.removedLinks.length;t++)r.createdLinks.push(e.removedLinks[t]),RED.nodes.addLink(e.removedLinks[t])}else if("delete"==e.t){if(r={t:"add",dirty:RED.nodes.dirty()},e.workspaces)for(r.workspaces=[],t=0;t<e.workspaces.length;t++)r.workspaces.push(e.workspaces[t]),RED.nodes.addWorkspace(e.workspaces[t],e.workspaces[t]._index),RED.workspaces.add(e.workspaces[t],void 0,e.workspaces[t]._index),delete e.workspaces[t]._index;if(e.subflows)for(r.subflows=[],t=0;t<e.subflows.length;t++)r.subflows.push(e.subflows[t]),RED.nodes.addSubflow(e.subflows[t]);if(e.subflowInputs&&e.subflowInputs.length>0&&((a=RED.nodes.subflow(e.subflowInputs[0].z)).in.push(e.subflowInputs[0]),a.in[0].dirty=!0),e.subflowOutputs&&e.subflowOutputs.length>0)for(a=RED.nodes.subflow(e.subflowOutputs[0].z),e.subflowOutputs.sort((function(e,t){return e.i-t.i})),t=0;t<e.subflowOutputs.length;t++){var h=e.subflowOutputs[t];a.out.splice(h.i,0,h);for(var g=h.i+1;g<a.out.length;g++)a.out[g].i++,a.out[g].dirty=!0;RED.nodes.eachLink((function(e){e.source.type=="subflow:"+a.id&&e.sourcePort>=h.i&&e.sourcePort++}))}if(e.subflow&&(r.subflow={},e.subflow.hasOwnProperty("instances")&&(r.subflow.instances=[],e.subflow.instances.forEach((function(e){r.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}))),e.subflow.hasOwnProperty("status")&&((a=RED.nodes.subflow(e.subflow.id)).status=e.subflow.status)),a&&RED.nodes.filterNodes({type:"subflow:"+a.id}).forEach((function(e){e.inputs=a.in.length,e.outputs=a.out.length,e.resize=!0,e.dirty=!0})),e.groups){r.groups=[];var v={};for(e.groups.forEach((function(e){v[e.id]=e})),t=e.groups.length-1;t>=0;t--)RED.nodes.addGroup(e.groups[t]),s[e.groups[t].z]=!0,r.groups.unshift(e.groups[t]),e.groups[t].g&&(-1===(u=v[e.groups[t].g]?v[e.groups[t].g]:RED.nodes.group(e.groups[t].g)).nodes.indexOf(e.groups[t])&&u.nodes.push(e.groups[t]),RED.group.markDirty(e.groups[t]))}if(e.nodes)for(r.nodes=[],t=0;t<e.nodes.length;t++)RED.nodes.add(e.nodes[t]),s[e.nodes[t].z]=!0,r.nodes.push(e.nodes[t].id),e.nodes[t].g&&(-1===(u=RED.nodes.group(e.nodes[t].g)).nodes.indexOf(e.nodes[t])&&u.nodes.push(e.nodes[t]),RED.group.markDirty(u));if(e.junctions)for(r.junctions=[],t=0;t<e.junctions.length;t++)r.junctions.push(e.junctions[t]),RED.nodes.addJunction(e.junctions[t]),e.junctions[t].g&&(-1===(u=RED.nodes.group(e.junctions[t].g)).nodes.indexOf(e.junctions[t])&&u.nodes.push(e.junctions[t]),RED.group.markDirty(u));if(e.links)for(r.links=[],t=0;t<e.links.length;t++)RED.nodes.addLink(e.links[t]),r.links.push(e.links[t]);if(e.createdLinks)for(r.removedLinks=[],t=0;t<e.createdLinks.length;t++)r.removedLinks.push(e.createdLinks[t]),RED.nodes.removeLink(e.createdLinks[t]);if(e.changes)for(t in e.changes)if(e.changes.hasOwnProperty(t)){if(n=RED.nodes.node(t)){for(var m in e.changes[t])e.changes[t].hasOwnProperty(m)&&(n[m]=e.changes[t][m]);n.dirty=!0}RED.events.emit("nodes:change",n)}a&&RED.events.emit("subflows:change",a)}else if("move"==e.t){for(r={t:"move",nodes:[],dirty:RED.nodes.dirty()},t=0;t<e.nodes.length;t++){var b=e.nodes[t],y={n:b.n,ox:b.n.x,oy:b.n.y,dirty:!0,moved:b.n.moved};r.nodes.push(y),b.n.x=b.ox,b.n.y=b.oy,b.n.dirty=!0,b.n.moved=b.moved}if(e.links)for(r.removedLinks=[],t=0;t<e.links.length;t++)r.removedLinks.push(e.links[t]),RED.nodes.removeLink(e.links[t]);if(e.removedLinks)for(r.links=[],t=0;t<e.removedLinks.length;t++)r.links.push(e.removedLinks[t]),RED.nodes.addLink(e.removedLinks[t]);e.addToGroup?(RED.group.removeFromGroup(e.addToGroup,e.nodes.map((function(e){return e.n})),!1),r.removeFromGroup=e.addToGroup):e.removeFromGroup&&(RED.group.addToGroup(e.removeFromGroup,e.nodes.map((function(e){return e.n}))),r.addToGroup=e.removeFromGroup)}else if("edit"==e.t){for(t in(r={t:"edit",changes:{},changed:e.node.changed,dirty:RED.nodes.dirty()}).node=e.node,e.changes)if(e.changes.hasOwnProperty(t)){if(r.changes[t]=e.node[t],e.node._def.defaults&&e.node._def.defaults[t]&&e.node._def.defaults[t].type){var w=e.node[t];Array.isArray(w)||(w=[w]),w.forEach((function(t){var o=RED.nodes.node(t);o&&"config"===o._def.category&&(o.users.splice(o.users.indexOf(e.node),1),RED.events.emit("nodes:change",o))})),w=e.changes[t],Array.isArray(w)||(w=[w]),w.forEach((function(t){var o=RED.nodes.node(t);o&&"config"===o._def.category&&(o.users.push(e.node),RED.events.emit("nodes:change",o))}))}e.node[t]=e.changes[t]}var E;switch(e.node.type){case"tab":E="flows";break;case"group":E="groups";break;case"subflow":E="subflows";break;default:E="nodes"}if(E+=":change",RED.events.emit(E,e.node),"tab"===e.node.type&&e.changes.hasOwnProperty("disabled")&&($("#red-ui-tab-"+e.node.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!e.node.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!e.node.disabled)),e.subflow)r.subflow={},e.subflow.hasOwnProperty("inputCount")&&(r.subflow.inputCount=e.node.in.length,e.node.in.length>e.subflow.inputCount?(r.subflow.inputs=e.node.in.slice(e.subflow.inputCount),e.node.in.splice(e.subflow.inputCount)):e.subflow.inputs.length>0&&(e.node.in=e.node.in.concat(e.subflow.inputs))),e.subflow.hasOwnProperty("outputCount")&&(r.subflow.outputCount=e.node.out.length,e.node.out.length>e.subflow.outputCount?(r.subflow.outputs=e.node.out.slice(e.subflow.outputCount),e.node.out.splice(e.subflow.outputCount)):e.subflow.outputs.length>0&&(e.node.out=e.node.out.concat(e.subflow.outputs))),e.subflow.hasOwnProperty("instances")&&(r.subflow.instances=[],e.subflow.instances.forEach((function(e){r.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}))),e.subflow.hasOwnProperty("status")&&e.subflow.status&&delete e.node.status,RED.editor.validateNode(e.node),RED.nodes.filterNodes({type:"subflow:"+e.node.id}).forEach((function(t){t.inputs=e.node.in.length,t.outputs=e.node.out.length,RED.editor.updateNodeProperties(t),RED.editor.validateNode(t)}));else{var D;if(e.outputMap)for(var R in D={},r.outputMap={},e.outputMap)e.outputMap.hasOwnProperty(R)&&"-1"!==e.outputMap[R]&&(D[e.outputMap[R]]=R,r.outputMap[e.outputMap[R]]=R);e.node.__outputs=r.changes.outputs,RED.editor.updateNodeProperties(e.node,D),RED.editor.validateNode(e.node)}if(e.links)for(r.createdLinks=[],t=0;t<e.links.length;t++)RED.nodes.addLink(e.links[t]),r.createdLinks.push(e.links[t]);if(e.createdLinks)for(r.links=[],t=0;t<e.createdLinks.length;t++)RED.nodes.removeLink(e.createdLinks[t]),r.links.push(e.createdLinks[t]);e.node.dirty=!0,e.node.changed=e.changed}else if("createSubflow"==e.t){if(r={t:"deleteSubflow",activeWorkspace:e.activeWorkspace,dirty:RED.nodes.dirty()},e.nodes){r.movedNodes=[];var x=e.activeWorkspace,_=RED.nodes.filterNodes({z:e.subflow.subflow.id});for((_=(_=_.concat(RED.nodes.groups(e.subflow.subflow.id))).concat(RED.nodes.junctions(e.subflow.subflow.id))).forEach((function(t){t.x+=e.subflow.offsetX,t.y+=e.subflow.offsetY,t.dirty=!0,r.movedNodes.push(t.id),RED.nodes.moveNodeToTab(t,x)})),r.subflows=[],t=0;t<e.nodes.length;t++)r.subflows.push(o(e.nodes[t])),RED.nodes.remove(e.nodes[t])}if(e.links)for(r.links=[],t=0;t<e.links.length;t++)r.links.push(e.links[t]),RED.nodes.removeLink(e.links[t]);if(r.subflow=e.subflow,RED.nodes.removeSubflow(e.subflow.subflow),RED.workspaces.remove(e.subflow.subflow),e.removedLinks)for(r.createdLinks=[],t=0;t<e.removedLinks.length;t++)r.createdLinks.push(e.removedLinks[t]),RED.nodes.addLink(e.removedLinks[t])}else if("deleteSubflow"==e.t){if(r={t:"createSubflow",activeWorkspace:e.activeWorkspace,dirty:RED.nodes.dirty()},e.subflow&&(RED.nodes.addSubflow(e.subflow.subflow),r.subflow=e.subflow,e.subflow.subflow.g&&RED.group.addToGroup(RED.nodes.group(e.subflow.subflow.g),e.subflow.subflow)),e.subflows)for(r.nodes=[],t=0;t<e.subflows.length;t++)RED.nodes.add(e.subflows[t]),r.nodes.push(e.subflows[t].id);if(e.movedNodes&&e.movedNodes.forEach((function(t){nn=RED.nodes.node(t),nn||(nn=RED.nodes.group(t)),nn.x-=e.subflow.offsetX,nn.y-=e.subflow.offsetY,nn.dirty=!0,RED.nodes.moveNodeToTab(nn,e.subflow.subflow.id)})),e.links)for(r.links=[],t=0;t<e.links.length;t++)r.links.push(e.links[t]),RED.nodes.addLink(e.links[t]);if(e.createdLinks)for(r.removedLinks=[],t=0;t<e.createdLinks.length;t++)r.removedLinks.push(e.createdLinks[t]),RED.nodes.removeLink(e.createdLinks[t])}else if("reorder"==e.t)r={t:"reorder",dirty:RED.nodes.dirty()},e.workspaces&&(r.workspaces={from:e.workspaces.to,to:e.workspaces.from},RED.workspaces.order(e.workspaces.from)),e.nodes&&(r.nodes={z:e.nodes.z,from:e.nodes.to,to:e.nodes.from},RED.nodes.setNodeOrder(e.nodes.z,e.nodes.from));else if("createGroup"==e.t){if(r={t:"ungroup",dirty:RED.nodes.dirty(),groups:[]},e.groups)for(t=0;t<e.groups.length;t++)r.groups.push(e.groups[t]),RED.group.ungroup(e.groups[t])}else if("ungroup"==e.t){if(r={t:"createGroup",dirty:RED.nodes.dirty(),groups:[]},e.groups)for(t=0;t<e.groups.length;t++){r.groups.push(e.groups[t]);var k=e.groups[t].nodes.slice();e.groups[t].nodes=[],RED.nodes.addGroup(e.groups[t]),RED.group.addToGroup(e.groups[t],k)}}else"addToGroup"==e.t?(r={t:"removeFromGroup",dirty:RED.nodes.dirty(),group:e.group,nodes:e.nodes,reparent:e.reparent},e.nodes&&RED.group.removeFromGroup(e.group,e.nodes,!e.hasOwnProperty("reparent")||void 0===e.hasOwnProperty("reparent")||e.reparent)):"removeFromGroup"==e.t&&(r={t:"addToGroup",dirty:RED.nodes.dirty(),group:e.group,nodes:e.nodes,reparent:e.reparent},e.nodes&&RED.group.addToGroup(e.group,e.nodes));return e.callback&&"function"==typeof e.callback&&(r.callback=e.callback,e.callback(e)),Object.keys(s).forEach((function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)})),RED.nodes.dirty(e.dirty),RED.view.updateActive(),RED.view.select(null),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.subflow.refresh(),r}}return{markAllDirty:function(){for(var t=0;t<e.length;t++)e[t].dirty=!0},list:function(){return e},listRedo:function(){return t},depth:function(){return e.length},push:function(o){e.push(o),t=[],RED.menu.setDisabled("menu-item-edit-undo",!1),RED.menu.setDisabled("menu-item-edit-redo",!0)},pop:function(){var o=i(e.pop());o&&t.push(o),RED.menu.setDisabled("menu-item-edit-undo",0===e.length),RED.menu.setDisabled("menu-item-edit-redo",0===t.length)},peek:function(){return e[e.length-1]},replace:function(t){0===e.length?RED.history.push(t):e[e.length-1]=t},clear:function(){e=[],t=[],RED.menu.setDisabled("menu-item-edit-undo",!0),RED.menu.setDisabled("menu-item-edit-redo",!0)},redo:function(){var o=t.pop();if(o){var n=i(o);n&&e.push(n)}RED.menu.setDisabled("menu-item-edit-undo",0===e.length),RED.menu.setDisabled("menu-item-edit-redo",0===t.length)}}}(),RED.validators={number:function(e,t){return function(t,o){return!((!e||""!==t&&void 0!==t)&&(""===t||isNaN(t)))||(o&&o.label?RED._("validator.errors.invalid-num-prop",{prop:o.label}):!!o&&RED._("validator.errors.invalid-num"))}},regex:function(e,t){return function(t,o){return!!e.test(t)||(o&&o.label?RED._("validator.errors.invalid-regex-prop",{prop:o.label}):!!o&&RED._("validator.errors.invalid-regexp"))}},typedInput:function(e,t,o){return function(o,i){var n=$("#node-"+(t?"config-":"")+"input-"+e).val()||this[e];if("json"===n)try{return JSON.parse(o),!0}catch(e){return i&&i.label?RED._("validator.errors.invalid-json-prop",{error:e.message,prop:i.label}):!!i&&RED._("validator.errors.invalid-json",{error:e.message})}else{if("msg"===n||"flow"===n||"global"===n)return!!RED.utils.validatePropertyExpression(o)||(i&&i.label?RED._("validator.errors.invalid-prop-prop",{prop:i.label}):!!i&&RED._("validator.errors.invalid-prop"));if("num"===n)return!!/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(o)||(i&&i.label?RED._("validator.errors.invalid-num-prop",{prop:i.label}):!!i&&RED._("validator.errors.invalid-num"))}return!0}}},RED.utils=function(){window._marked=window.marked,window.marked=function(e){return console.warn("Use of 'marked()' is deprecated. Use RED.utils.renderMarkdown() instead"),i(e)};const e={name:"descriptionList",level:"block",start(e){if(!e)return null;let t=e.match(/:[^:\n]/g);return t&&t.index},tokenizer(e,t){if(!e)return null;const o=/^(?::[^:\n]+:[^:\n]*(?:\n|$))+/.exec(e);return o?{type:"descriptionList",raw:o[0],text:o[0].trim(),tokens:this.lexer.inlineTokens(o[0].trim())}:void 0},renderer(e){return`<dl class="message-properties">${this.parser.parseInline(e.tokens)}\n</dl>`}},t={name:"description",level:"inline",start(e){if(!e)return null;let t=e.match(/:/g);return t&&t.index},tokenizer(e,t){if(!e)return null;const o=/^:([^:\n]+)\(([^:\n]+)\).*?:([^:\n]*)(?:\n|$)/.exec(e);return o?{type:"description",raw:o[0],dt:this.lexer.inlineTokens(o[1].trim()),types:this.lexer.inlineTokens(o[2].trim()),dd:this.lexer.inlineTokens(o[3].trim())}:void 0},renderer(e){return`\n<dt>${this.parser.parseInline(e.dt)}<span class="property-type">${this.parser.parseInline(e.types)}</span></dt><dd>${this.parser.parseInline(e.dd)}</dd>`},childTokens:["dt","dd"],walkTokens(e){"strong"===e.type&&(e.text+=" walked")}},o=new window._marked.Renderer;function i(e){var t=_marked.parse(e);return DOMPurify.sanitize(t,{SAFE_FOR_JQUERY:!0})}function n(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function a(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function r(e){var t;if(Array.isArray(e))t=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]");else if(null===e)t=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-null">null</span>');else if("object"==typeof e)t=e.hasOwnProperty("type")&&"undefined"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-null">undefined</span>'):e.hasOwnProperty("type")&&"Buffer"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("buffer["+e.length+"]"):e.hasOwnProperty("type")&&"array"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]"):e.hasOwnProperty("type")&&"set"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("set["+e.length+"]"):e.hasOwnProperty("type")&&"map"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("map"):e.hasOwnProperty("type")&&"function"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("function"):!e.hasOwnProperty("type")||"number"!==e.type&&"bigint"!==e.type?e.hasOwnProperty("type")&&"regexp"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-string"></span>').text(e.data):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta">object</span>'):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>').text(e.data);else if("string"==typeof e){var o;o=e.length>30?a(e.substring(0,30))+"&hellip;":a(e),t=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-string"></span>').html('"'+n(o)+'"')}else t="number"==typeof e?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>').text(""+e):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-other"></span>').text(""+e);return t}function s(e,t,o,i){e.addClass("red-ui-debug-msg-expandable"),e.prop("toggle",(function(){return function(o){var i=e.parent();if(i.hasClass("collapsed")){if(o)return t&&!i.hasClass("built")&&(t(),i.addClass("built")),i.removeClass("collapsed"),!0}else if(!o)return i.addClass("collapsed"),!0;return!1}})),e.on("click",(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&o&&o(!t),e.preventDefault()})),i&&e.trigger("click")}o.list=function(e,t,o){return/dl.*?class.*?message-properties.*/.test(e)&&t?'<ol class="node-ports">'+e+"</ol>":t?"<ol>"+e+"</ol>":"<ul>"+e+"</ul>"},window._marked.setOptions({renderer:o,gfm:!0,tables:!0,breaks:!1,pedantic:!1,smartLists:!0,smartypants:!1}),window._marked.use({extensions:[e,t]});var d={},l={};function c(e,t,o,i){if(t&&t.length>0){if(""===e&&void 0===o)return!0;for(var n=0;n<t.length;n++){var a=t[n];if(0===a.indexOf(e)&&("."===a[e.length]||"["===a[e.length])){if(void 0===o||"["!==a[e.length])return!0;var r=a.substring(e.length),s=/\[(\d+)\]/.exec(r);if(s){var d=parseInt(s[1]);return o<=d&&d<=i}}}}return!1}function u(e,t,o,i,n,a){var r=l[o]&&l[o][i]&&l[o][i].number||a||"dec";if(n?(r="dec"===r?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===r||"dateS"==r?13===t.toString().length&&t<=2147483647e3?"dateML":10===t.toString().length&&t<=2147483647?"dateL":"hex":"dateML"===r||"dateL"==r?"hex":"dec",l[o]=l[o]||{},l[o][i]=l[o][i]||{},l[o][i].number=r):void 0!==a&&(l[o]=l[o]||{},l[o][i]=l[o][i]||{},l[o][i].number=r),"dec"===r)e.text(""+t);else if("dateMS"===r)e.text(new Date(t).toISOString());else if("dateS"===r)e.text(new Date(1e3*t).toISOString());else if("dateML"===r){var s=new Date(t);e.text(s.toLocaleString()+"  [UTC"+(s.getTimezoneOffset()/-60<=0?"":"+")+s.getTimezoneOffset()/-60+"]")}else if("dateL"===r){var d=new Date(1e3*t);e.text(d.toLocaleString()+"  [UTC"+(d.getTimezoneOffset()/-60<=0?"":"+")+d.getTimezoneOffset()/-60+"]")}else"hex"===r&&e.text("0x"+t.toString(16))}function p(e,t,o,i,n){var a=l[o]&&l[o][i]&&l[o][i].buffer||"raw";n&&(a="raw"===a?"string":"raw",l[o]=l[o]||{},l[o][i]=l[o][i]||{},l[o][i].buffer=a),"raw"===a?(t.text("raw"),e.removeClass("red-ui-debug-msg-buffer-string").addClass("red-ui-debug-msg-buffer-raw")):"string"===a&&(t.text("string"),e.addClass("red-ui-debug-msg-buffer-string").removeClass("red-ui-debug-msg-buffer-raw"))}function f(e,t){var o=new Error(t);return o.code=e,o}function h(e,t){var o=e.length;if(0===o)throw f("INVALID_EXPR","Invalid property expression: zero-length");for(var i,n,a=[],r=0,s=!1,d=!1,l=0;l<o;l++){var c=e[l];if(s){if(c===i){if(l-r==0)throw f("INVALID_EXPR","Invalid property expression: zero-length string at position "+r);if(a.push(e.substring(r,l)),d&&!/\]/.test(e[l+1]))throw f("INVALID_EXPR","Invalid property expression: unexpected array expression at position "+r);if(!d&&l+1!==o&&!/[\[\.]/.test(e[l+1]))throw f("INVALID_EXPR","Invalid property expression: unexpected "+e[l+1]+" expression at position "+(l+1));r=l+1,s=!1}}else if("'"===c||'"'===c){if(l!=r)throw f("INVALID_EXPR","Invalid property expression: unexpected "+c+" at position "+l);s=!0,i=c,r=l+1}else if("."===c){if(0===l)throw f("INVALID_EXPR","Invalid property expression: unexpected . at position 0");if(r!=l&&(n=e.substring(r,l),/^\d+$/.test(n)?a.push(parseInt(n)):a.push(n)),l===o-1)throw f("INVALID_EXPR","Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[l+1]))throw f("INVALID_EXPR","Invalid property expression: unexpected "+e[l+1]+" at position "+(l+1));r=l+1}else if("["===c){if(0===l)throw f("INVALID_EXPR","Invalid property expression: unexpected "+c+" at position "+l);if(r!=l&&a.push(e.substring(r,l)),l===o-1)throw f("INVALID_EXPR","Invalid property expression: unterminated expression");if(/^msg[.\[]/.test(e.substring(l+1))){for(var u,p=1,v=!1,m=l+1;m<o;m++)if(/["']/.test(e[m])&&(v?e[m]===u&&(v=!1):(v=!0,u=e[m])),"["===e[m]?p++:"]"===e[m]&&p--,0===p)try{t?a.push(g(t,e.substring(l+1,m))):a.push(h(e.substring(l+1,m),t)),d=!1,l=m,r=m+1;break}catch(e){throw f("INVALID_EXPR","Invalid expression started at position "+(l+1))}if(p>0)throw f("INVALID_EXPR","Invalid property expression: unmatched '[' at position "+l);continue}if(!/["'\d]/.test(e[l+1]))throw f("INVALID_EXPR","Invalid property expression: unexpected "+e[l+1]+" at position "+(l+1));r=l+1,d=!0}else if("]"===c){if(!d)throw f("INVALID_EXPR","Invalid property expression: unexpected "+c+" at position "+l);if(r!=l){if(n=e.substring(r,l),!/^\d+$/.test(n))throw f("INVALID_EXPR","Invalid property expression: unexpected array expression at position "+r);a.push(parseInt(n))}r=l+1,d=!1}else if(" "===c)throw f("INVALID_EXPR","Invalid property expression: unexpected ' ' at position "+l)}if(d||s)throw new f("INVALID_EXPR","Invalid property expression: unterminated expression");return r<o&&a.push(e.substring(r)),a}function g(e,t){var o,i=null;return"string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),o=h(t)):o=t,o.reduce((function(e,t){return void 0===(i=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(i=void 0!==e.data[t]?e.data[t]:void 0),i}),e),i}function v(e){var t={module:"",file:""};if(e){0===e.indexOf(RED.settings.apiRootUrl+"icons/")&&(e=e.substring((RED.settings.apiRootUrl+"icons/").length));var o=/^((?:@[^/]+\/)?[^/]+)\/(.*)$/.exec(e);o?(t.module=o[1],t.file=o[2]):t.file=e}return t}function m(e,t){var o;if(e=e||{},t&&"subflow"===t.type)o="node-red/subflow.svg";else if("function"==typeof e.icon)try{o=e.icon.call(t)}catch(t){console.log("Definition error: "+e.type+".icon",t),o="arrow-in.svg"}else o=e.icon;var i=v(o);return i.module||(e.set?i.module=e.set.module:i.module="node-red"),i}function b(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}var y={};function w(e){var t,o,i;if(/^#[a-f0-9]{6}$/i.test(e))t=parseInt(e.substring(1,3),16),o=parseInt(e.substring(3,5),16),i=parseInt(e.substring(5,7),16);else{if(!/^#[a-f0-9]{3}$/i.test(e))return e;t=parseInt(e.substring(1,2)+e.substring(1,2),16),o=parseInt(e.substring(2,3)+e.substring(2,3),16),i=parseInt(e.substring(3,4)+e.substring(3,4),16)}var n=(((t=Math.max(0,t-50))<<16)+((o=Math.max(0,o-50))<<8)+(i=Math.max(0,i-50))).toString(16);return"#"+"000000".slice(0,6-n.length)+n}function E(e,t,o){for(var i=0;i<o.length;i++){var n=o[i];if(n.module.test(e))return n}}return{createObjectElement:function e(t,o){var i,l,f,v,m,b,y=(o=o||{}).key,w=o.typeHint,E=o.hideKey,D=o.path,R=o.sourceId,x=o.rootPath,_=o.expandPaths,k=o.ontoggle,T=o.exposeApi,C=o.tools,j={};void 0!==D&&void 0!==x&&(b=D.substring(x.length+("."===D[x.length]?1:0)));var L=$('<span class="red-ui-debug-msg-element"></span>');if(L.collapse=function(){L.find(".red-ui-debug-msg-expandable").parent().addClass("collapsed")},v=$('<span class="red-ui-debug-msg-row"></span>').appendTo(L),R&&function(e,t,o,i,n,a,r){d.hasOwnProperty(t)||(d[t]={});var s=$('<span class="red-ui-debug-msg-tools"></span>').appendTo(e),l=$('<span class="red-ui-debug-msg-tools-copy button-group"></span>').appendTo(s);if(o){var c=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-terminal"></i></button>').appendTo(l).on("click",(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(o,c,"clipboard.copyMessagePath")}));RED.popover.tooltip(c,RED._("node-red:debug.sidebar.copyPath"))}var u=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(l).on("click",(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(i,u,"clipboard.copyMessageValue")}));if(RED.popover.tooltip(u,RED._("node-red:debug.sidebar.copyPayload")),void 0!==a&&""!==a){var p=d[t].hasOwnProperty(a),f=$('<button class="red-ui-button red-ui-button-small red-ui-debug-msg-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(s).on("click",(function(o){if(o.preventDefault(),o.stopPropagation(),d[t].hasOwnProperty(a))delete d[t][a],$(this).removeClass("selected"),e.removeClass("red-ui-debug-msg-row-pinned");else{var i="$"+("["===a[0]?"":".")+a;d[t][a]=h(i),$(this).addClass("selected"),e.addClass("red-ui-debug-msg-row-pinned")}})).toggleClass("selected",p);e.toggleClass("red-ui-debug-msg-row-pinned",p),RED.popover.tooltip(f,RED._("node-red:debug.sidebar.pinPath"))}if(r){var g=r;"function"==typeof g&&(g=g(o,i)),g&&(g.addClass("red-ui-debug-msg-tools-other"),g.appendTo(s))}}(v,R,D,t,0,b,C),y)E||($('<span class="red-ui-debug-msg-object-key"></span>').text(y).appendTo(v),$("<span>: </span>").appendTo(v));else if(L.addClass("red-ui-debug-msg-top-level"),R){var S=d[R];if(_=[],S){for(var O in S)if(S.hasOwnProperty(O))try{void 0!==g({$:t},S[O])&&_.push(O)}catch(e){}_.sort()}L.clearPinned=function(){L.find(".red-ui-debug-msg-row-pinned").removeClass("red-ui-debug-msg-row-pinned"),d[R]={}}}f=$('<span class="red-ui-debug-msg-object-value"></span>').appendTo(v);var I=Array.isArray(t),N=!1;if(t&&"object"==typeof t&&t.hasOwnProperty("type")&&t.hasOwnProperty("data")&&(t.__enc__&&"set"===t.type||t.__enc__&&"array"===t.type||"Buffer"===t.type)&&(I=!0,N=!0),null==t)$('<span class="red-ui-debug-msg-type-null">'+t+"</span>").appendTo(f);else if(t.__enc__&&"undefined"===t.type)$('<span class="red-ui-debug-msg-type-null">undefined</span>').appendTo(f);else if(!t.__enc__||"number"!==t.type&&"bigint"!==t.type)if("regexp"===w||t.__enc__&&"regexp"===t.type)l=$('<span class="red-ui-debug-msg-type-string red-ui-debug-msg-object-header"></span>').text("string"==typeof t?t:t.data).appendTo(f);else if("function"===w||t.__enc__&&"function"===t.type)l=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("function").appendTo(f);else if("internal"===w||t.__enc__&&"internal"===t.type)l=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("[internal]").appendTo(f);else if("string"==typeof t)/[\t\n\r]/.test(t)&&(L.addClass("collapsed"),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(v),s(v,(function(){$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(w||"string").appendTo(v);var e=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(L);$('<pre class="red-ui-debug-msg-type-string"></pre>').text(t).appendTo(e)}),(function(e){k&&k(D,e)}),c(b,_))),l=$('<span class="red-ui-debug-msg-type-string red-ui-debug-msg-object-header"></span>').html('"'+n(a(t))+'"').appendTo(f),/^#[0-9a-f]{6}$/i.test(t)&&$('<span class="red-ui-debug-msg-type-string-swatch"></span>').css("backgroundColor",t).appendTo(l);else if("number"==typeof t)l=$('<span class="red-ui-debug-msg-type-number"></span>').appendTo(f),Number.isInteger(t)&&t>=0&&(l.addClass("red-ui-debug-msg-type-number-toggle"),l.on("click",(function(e){e.preventDefault(),u($(this),t,R,D,!0)}))),u(l,t,R,D,!1,"hex"===w?"hex":void 0);else if(I){L.addClass("collapsed");var P=t.length;if(w){var A=/\[(\d+)\]/.exec(w);A&&(P=parseInt(A[1]))}var M=t,z="array";N?(M=t.data,void 0===P&&(P=M.length),M.__enc__&&(M=M.data),z=t.type.toLowerCase()):/buffer/.test(w)&&(z="buffer");var B=M.length;if(P>0){$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(v);var G=$('<div class="red-ui-debug-msg-array-rows"></div>').appendTo(L);L.addClass("red-ui-debug-msg-buffer-raw")}if(y)m=$('<span class="red-ui-debug-msg-type-meta"></span>').text(w||z+"["+P+"]").appendTo(f);else{m=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(f),$("<span>[ </span>").appendTo(m);var F=Math.min(P,10);for(i=0;i<F;i++)r(M[i]).appendTo(m),i<F-1&&$("<span>, </span>").appendTo(m);P>F&&$("<span> &hellip;</span>").appendTo(m),0===F&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(m),$("<span> ]</span>").appendTo(m)}P>0&&s(v,(function(){if(y||(m=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(w||z+"["+P+"]").appendTo(v)),"buffer"===z){var t=$('<div class="red-ui-debug-msg-string-rows"></div>').appendTo(L),o=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(t),n="";try{n=String.fromCharCode.apply(null,new Uint16Array(M))}catch(e){console.log(e)}$('<pre class="red-ui-debug-msg-type-string"></pre>').text(n).appendTo(o);var a=$('<span class="red-ui-debug-msg-buffer-opts"></span>').appendTo(m),r=$('<a class="red-ui-button red-ui-button-small" href="#"></a>').text("raw").appendTo(a).on("click",(function(e){e.preventDefault(),e.stopPropagation(),p(L,$(this),R,D,!0)}));p(L,r,R,D,!1)}var d;if(B<=10)for(i=0;i<B;i++)d=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(G),j[D+"["+i+"]"]=e(M[i],{key:""+i,typeHint:"buffer"===z&&"hex",hideKey:!1,path:D+"["+i+"]",sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(d);else{for(i=0;i<B;i+=10){var l=i;d=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(G),v=$("<span></span>").appendTo(d),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').appendTo(v),s(v,function(){var t=l,o=Math.min(B-1,l+9),i=d;return function(){for(var n=t;n<=o;n++){var a=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(i);j[D+"["+n+"]"]=e(M[n],{key:""+n,typeHint:"buffer"===z&&"hex",hideKey:!1,path:D+"["+n+"]",sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(a)}}}(),function(){var e=e+"["+i+"]";return function(t){k&&k(e,t)}}(),c(b,_,l,Math.min(B-1,l+9))),$('<span class="red-ui-debug-msg-object-key"></span>').html("["+l+" &hellip; "+Math.min(B-1,l+9)+"]").appendTo(v)}B<P&&$('<div class="red-ui-debug-msg-object-entry collapsed"><span class="red-ui-debug-msg-object-key">['+B+" &hellip; "+P+"]</span></div>").appendTo(G)}}),(function(e){k&&k(D,e)}),c(b,_))}else if("object"==typeof t){L.addClass("collapsed");z="object";(M=t).__enc__&&(M=M.data,z=t.type.toLowerCase());var U=Object.keys(M);if((y||U.length>0)&&($('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(v),s(v,(function(){for(y||$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(z).appendTo(v),i=0;i<U.length;i++){var t=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(L),o=D;void 0!==o&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(U[i])?o+=(o.length>0?".":"")+U[i]:o+='["'+U[i].replace(/"/,'\\"')+'"]'),j[o]=e(M[U[i]],{key:U[i],typeHint:!1,hideKey:!1,path:o,sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(t)}0===U.length&&$('<div class="red-ui-debug-msg-object-entry red-ui-debug-msg-type-meta collapsed"></div>').text("empty").appendTo(L)}),(function(e){k&&k(D,e)}),c(b,_))),y)$('<span class="red-ui-debug-msg-type-meta"></span>').text(z).appendTo(f);else{m=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(f),$("<span>{ </span>").appendTo(m);var V=Math.min(U.length,5);for(i=0;i<V;i++)$('<span class="red-ui-debug-msg-object-key"></span>').text(U[i]).appendTo(m),$("<span>: </span>").appendTo(m),r(M[U[i]]).appendTo(m),i<V-1&&$("<span>, </span>").appendTo(m);U.length>V&&$("<span> &hellip;</span>").appendTo(m),0===V&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(m),$("<span> }</span>").appendTo(m)}}else $('<span class="red-ui-debug-msg-type-other"></span>').text(""+t).appendTo(f);else l=$('<span class="red-ui-debug-msg-type-number red-ui-debug-msg-object-header"></span>').text(t.data).appendTo(f);return T&&L.prop("expand",(function(){return function(e,t){if(D===e)v.prop("toggle")&&v.prop("toggle")(t);else if(j[e]&&j[e].prop("expand"))j[e].prop("expand")(e,t);else for(var o in j)if(j.hasOwnProperty(o)&&0===e.indexOf(o)){j[o].prop("expand")&&j[o].prop("expand")(e,t);break}}})),L},getMessageProperty:g,setMessageProperty:function(e,t,o,i){void 0===i&&(i=void 0!==o),0===t.indexOf("msg.")&&(t=t.substring(4));for(var n,a=h(t),r=a.length,s=e,d=0;d<r-1;d++)if("string"==typeof(n=a[d])||"number"==typeof n&&!Array.isArray(s))if(s.hasOwnProperty(n))s=s[n];else{if(!i)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else if("number"==typeof n)if(void 0===s[n]){if(!i)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else s=s[n];n=a[r-1],void 0===o?"number"==typeof n&&Array.isArray(s)?s.splice(n,1):delete s[n]:s[n]=o},normalisePropertyExpression:h,validatePropertyExpression:function(e){try{h(e);return!0}catch(e){return!1}},separateIconPath:v,getDefaultNodeIcon:m,getNodeIcon:function(e,t){if(e=e||{},t&&"_selection_"===t.type)return"font-awesome/fa-object-ungroup";if(t&&"group"===t.type)return"font-awesome/fa-object-group";if(t&&"junction"===t.type||"junction"===e.type)return"font-awesome/fa-circle-o";if("config"===e.category)return RED.settings.apiRootUrl+"icons/node-red/cog.svg";if(t&&/^_action_:/.test(t.type)||/^_action_:/.test(e.type))return"font-awesome/fa-cogs";if(t&&"tab"===t.type)return"red-ui-icons/red-ui-icons-flow";if(t&&"unknown"===t.type)return RED.settings.apiRootUrl+"icons/node-red/alert.svg";if(t&&t.icon){if(b(o=v(t.icon)))return"font-awesome"===o.module?t.icon:RED.settings.apiRootUrl+"icons/"+t.icon;if("font-awesome"!==o.module&&/.png$/i.test(o.file)&&(o.file=o.file.replace(/.png$/,".svg"),b(o)))return RED.settings.apiRootUrl+"icons/"+t.icon.replace(/.png$/,".svg")}var o;if(b(o=m(e,t)))return"font-awesome"===o.module?o.module+"/"+o.file:RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file;if(/.png$/i.test(o.file)){var i=o.file;if(o.file=o.file.replace(/.png$/,".svg"),b(o))return RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file;o.file=i}return o.module="node-red",b(o)||/.png$/i.test(o.file)&&(o.file=o.file.replace(/.png$/,".svg"),b(o))?RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file:"subflows"===e.category?RED.settings.apiRootUrl+"icons/node-red/subflow.svg":RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"},getNodeLabel:function(e,t){var o;if(t=t||"","tab"===e.type)o=e.label||t;else if("group"===e.type)o=e.name||t;else if("junction"===e.type)o="junction";else{o=e._def.label;try{o=("function"==typeof o?o.call(e):o)||t}catch(i){console.log("Definition error: "+e.type+".label",i),o=t}}return RED.text.bidi.enforceTextDirectionWithUCC(o)},getNodeColor:function(e,t){var o=(t=t||{}).color,i=RED.settings.theme("palette.theme")||[];if(i.length>0){if(!y.hasOwnProperty(e)){y[e]=t.color;for(var n=i.length,a=0;a<n;a++){var r=i[a];if((!r.hasOwnProperty("category")||(r.hasOwnProperty("_category")||(r._category=new RegExp(r.category)),r._category.test(t.category)))&&(!r.hasOwnProperty("type")||(r.hasOwnProperty("_type")||(r._type=new RegExp(r.type)),r._type.test(e)))){y[e]=r.color||t.color;break}}}o=y[e]}return o||"#ddd"},getPaletteLabel:function(e,t){var o=e;if(void 0!==t.paletteLabel)try{o=("function"==typeof t.paletteLabel?t.paletteLabel.call(t):t.paletteLabel)||""}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}return o},clearNodeColorCache:function(){y={}},addSpinnerOverlay:function(e,t){var o=$('<div class="red-ui-component-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&o.addClass("red-ui-component-spinner-contain"),o},decodeObject:function(e,t){if("number"===t&&"NaN"===e)e=Number.NaN;else if("number"===t&&"Infinity"===e)e=1/0;else if("number"===t&&"-Infinity"===e)e=-1/0;else if("Object"===t||/^(array|set|map)/.test(t)||"boolean"===t||"number"===t)e=JSON.parse(e);else if(/error/i.test(t))e=((e=JSON.parse(e)).name?e.name+": ":"")+e.message;else if("null"===t)e=null;else if("undefined"===t)e=void 0;else if(/^buffer/.test(t)){var o=e;e=[];for(var i=0;i<o.length;i+=2)e.push(parseInt(o.substr(i,2),16))}return e},parseContextKey:function(e,t){var o={},i=/^#:\((\S+?)\)::(.*)$/.exec(e);return i?(o.store=i[1],o.key=i[2]):(o.key=e,t?o.store=t:RED.settings.context&&(o.store=RED.settings.context.default)),o},createIconElement:function(e,t,o){var i=t.find(".red-ui-palette-icon");0!==i.length&&i.remove(),0!==(a=t.find("i")).length&&a.remove();var n=v(e);if("font-awesome"===n.module){if(RED.nodes.fontAwesome.getIconUnicode(n.file)){var a,r=o?"fa-lg ":"";return void(a=$("<i/>").appendTo(t)).addClass("red-ui-palette-icon-fa fa fa-fw "+r+n.file)}e=RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"}else if("red-ui-icons"===n.module){return void $("<i/>").appendTo(t).addClass("red-ui-palette-icon red-ui-icons "+n.file)}$("<div/>",{class:"red-ui-palette-icon"}).appendTo(t).css("backgroundImage","url("+e+")")},sanitize:a,renderMarkdown:i,createNodeIcon:function(e,t){var o=$('<span class="red-ui-node-icon-container">'),i=e._def,n=$("<div>",{class:"red-ui-node-icon"});if("_selection_"===e.type)n.addClass("red-ui-palette-icon-selection");else if("group"===e.type)n.addClass("red-ui-palette-icon-group");else if("junction"===e.type)n.addClass("red-ui-palette-icon-junction");else if("tab"===e.type)n.addClass("red-ui-palette-icon-flow");else{var a=RED.utils.getNodeColor(e.type,i);n.css("backgroundColor",a);var r=w(a);r!==a&&n.css("border-color",r)}var s=RED.utils.getNodeIcon(i,e);if(RED.utils.createIconElement(s,n,!0),n.appendTo(o),t){var d=RED.utils.getNodeLabel(e,e.name||e.type+": "+e.id),l=$("<div>",{class:"red-ui-node-label"}).appendTo(o);d?l.text(d):l.html("&nbsp;")}return o},getDarkerColor:w,parseModuleList:function(e){return(e=e||["*"]).map((function(e){var t=/^(.+?)(?:@(.*))?$/.exec(e),o=t[1].indexOf("*");return o=-1===o?1/0:o,{module:new RegExp("^"+t[1].replace(/\*/g,".*")+"$"),version:t[2],wildcardPos:o}}))},checkModuleAllowed:function(e,t,o,i){if(!o&&!i)return!0;if(0===o.length&&0===i.length)return!0;var n=E(e,0,o),a=E(e,0,i);return!(!n||a)||!(!n&&a)&&(!n&&!a||(n.wildcardPos!==a.wildcardPos?n.wildcardPos>a.wildcardPos:n.module.toString().length>a.module.toString().length))},getBrowserInfo:function(){var e={};try{var t=navigator.userAgent;e.ua=t,e.browser=/Edge\/\d+/.test(t)?"ed":/MSIE 9/.test(t)?"ie9":/MSIE 10/.test(t)?"ie10":/MSIE 11/.test(t)?"ie11":/MSIE\s\d/.test(t)?"ie?":/rv\:11/.test(t)?"ie11":/Firefox\W\d/.test(t)?"ff":/Chrom(e|ium)\W\d|CriOS\W\d/.test(t)?"gc":/\bSafari\W\d/.test(t)?"sa":/\bOpera\W\d/.test(t)||/\bOPR\W\d/i.test(t)?"op":"undefined"!=typeof MSPointerEvent?"ie?":"",e.os=/Windows NT 10/.test(t)?"win10":/Windows NT 6\.0/.test(t)?"winvista":/Windows NT 6\.1/.test(t)?"win7":/Windows NT 6\.\d/.test(t)?"win8":/Windows NT 5\.1/.test(t)?"winxp":/Windows NT [1-5]\./.test(t)?"winnt":/Mac/.test(t)?"mac":/Linux/.test(t)?"linux":/X11/.test(t)?"nix":"",e.touch="ontouchstart"in document.documentElement,e.mobile=/IEMobile|Windows Phone|Lumia/i.test(t)?"w":/iPhone|iP[oa]d/.test(t)?"i":/Android/.test(t)?"a":/BlackBerry|PlayBook|BB10/.test(t)?"b":/Mobile Safari/.test(t)?"s":/webOS|Mobile|Tablet|Opera Mini|\bCrMo\/|Opera Mobi/i.test(t)?1:0,e.tablet=/Tablet|iPad/i.test(t),e.ie=/MSIE \d|Trident.*rv:/.test(navigator.userAgent),e.android=/android/i.test(navigator.userAgent)}catch(e){}return e}}}(),function(e){e.widget("nodered.editableList",{_create:function(){var t=this;this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class);var o,i,n=this.options.buttons||[];!1!==this.options.addButton&&("string"==typeof this.options.addButton?o=this.options.addButton:RED&&RED._?(o=RED._("editableList.add"),i=RED._("editableList.addTitle")):(o="add",i="add new item"),n.unshift({label:o,icon:"fa fa-plus",click:function(e){t.addItem({})},title:i}));n.forEach((function(o){var i=e('<button type="button" class="red-ui-button red-ui-button-small red-ui-editableList-addButton" style="margin-top: 4px; margin-right: 5px;"></button>').appendTo(t.topContainer).on("click",(function(e){e.preventDefault(),void 0!==o.click&&o.click(e)}));o.id&&i.attr("id",o.id),o.title&&i.attr("title",o.title),o.icon&&i.append(e("<i></i>").attr("class",o.icon)),o.label&&i.append(e("<span></span>").text(" "+o.label))})),"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach((function(e){var o=t.element.css(e);"auto"!==o&&""!==o&&(t.topContainer.css(e,o),t.uiContainer.css(e,"0"),"top"===e&&t.options.header&&t.uiContainer.css(e,"20px"),t.element.css(e,"auto"))})),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var a=this.element.css("minHeight");"0px"!==a&&(this.uiContainer.css("minHeight",a),this.element.css("minHeight",0));var r=this.element.css("maxHeight");"0px"!==r&&(this.uiContainer.css("maxHeight",r),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","auto"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var s,d=this.element.attr("style");if(null!==(s=/width\s*:\s*(\d+%)/i.exec(d))&&(this.element.width("100%"),this.uiContainer.width(s[1])),this.options.sortable){var l={axis:"y",update:function(e,o){t.options.sortItems&&t.options.sortItems(t.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(l.connectWith=this.options.connectWith),this.element.sortable(l)}this._resize()},_resize:function(){var t=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-t),this.options.resize&&this.options.resize(),this.options.resizeItem){var o=this;this.element.children().each((function(t){o.options.resizeItem(e(this).children(".red-ui-editableList-item-content"),t)}))}},_destroy:function(){if(this.topContainer){var e=this.topContainer;delete this.topContainer,e.remove()}},_refreshFilter:function(){var e=this,t=0;return this.activeFilter?(this.items().each((function(o,i){var n=i.data("data");try{e.activeFilter(n)?(i.parent().show(),t++):i.parent().hide()}catch(e){console.log(e),i.parent().show(),t++}})),t):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var t=this.element.children(),o=this;t.sort((function(t,i){return o.activeSort(e(t).children(".red-ui-editableList-item-content").data("data"),e(i).children(".red-ui-editableList-item-content").data("data"))})),e.each(t,(function(e,t){o.element.append(t)}))}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},getItemAt:function(t){var o=this.items();return t>=0&&t<o.length?e(o[t]).data("data"):void 0},indexOf:function(t){for(var o=this.items(),i=0;i<o.length;i++)if(e(o[i]).data("data")===t)return i;return-1},insertItemAt:function(t,o){var i=this;t=t||{};var n=e("<li>"),a=e("<div/>").addClass("red-ui-editableList-item-content").appendTo(n);if(a.data("data",t),!0===this.options.sortable&&(e('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(n),n.addClass("red-ui-editableList-item-sortable")),this.options.removable){var r=e("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(n);e("<i/>",{class:"fa fa-remove"}).appendTo(r),n.addClass("red-ui-editableList-item-removable"),r.on("click",(function(t){t.preventDefault();var o=a.data("data");n.addClass("red-ui-editableList-item-deleting"),n.fadeOut(300,(function(){e(this).remove(),i.options.removeItem&&i.options.removeItem(o)}))}))}var s=!1;if(this.activeSort){this.items().each((function(e,o){if(!s){var a=o.data("data");i.activeSort(t,a)<0&&(n.insertBefore(o.closest("li")),s=!0)}}))}if(s||(o<=0?n.prependTo(this.element):o>i.element.children().length-1?n.appendTo(this.element):n.insertBefore(this.element.children().eq(o))),this.options.addItem){o=i.element.children().length-1;if(i.options.addItem(a,o,t),i.activeFilter)try{i.activeFilter(t)||n.hide()}catch(e){}!i.activeSort&&i.scrollOnAdd&&setTimeout((function(){i.uiContainer.scrollTop(i.element.height())}),0)}},addItem:function(e){this.insertItemAt(e,this.element.children().length)},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t,o){var i=this.element.children().filter((function(o){return t===e(this).children(".red-ui-editableList-item-content").data("data")}));o?i.detach():i.remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map((function(t){return e(this).children(".red-ui-editableList-item-content")}))},empty:function(){this.element.empty(),this.uiContainer.scrollTop(0)},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length},show:function(t){var o=this.element.children().filter((function(o){return t===e(this).children(".red-ui-editableList-item-content").data("data")}));o.length>0&&this.uiContainer.scrollTop(this.uiContainer.scrollTop()+o.position().top)},getItem:function(e){var t=e.children(".red-ui-editableList-item-content");return t.length?t.data("data"):null}})}(jQuery),function(e){e.widget("nodered.treeList",{_create:function(){var t=this,o=!0;!1===t.options.autoSelect&&(o=!1),this.element.addClass("red-ui-treeList"),this.element.attr("tabIndex",0);var i=e("<div>",{class:"red-ui-treeList-container"}).appendTo(this.element);this.element.on("keydown",(function(e){var i=t._topList.find(".focus").parent().data("data");if(i||40!==e.keyCode&&38!==e.keyCode){var n;switch(e.keyCode){case 32:case 13:if(!t.options.selectable)return;if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;e.preventDefault(),e.stopPropagation(),i.checkbox?i.treeList.checkbox.trigger("click"):i.radio?i.treeList.radio.trigger("click"):i.children?i.treeList.container.hasClass("expanded")?i.treeList.collapse():i.treeList.expand():t._trigger("confirm",null,i);break;case 37:e.preventDefault(),e.stopPropagation(),i.children&&i.treeList.container.hasClass("expanded")?i.treeList.collapse():i.parent&&(n=i.parent);break;case 38:e.preventDefault(),e.stopPropagation(),(n=t._getPreviousSibling(i))&&(n=t._getLastDescendant(n)),!n&&i.parent&&(n=i.parent);break;case 39:e.preventDefault(),e.stopPropagation(),i.children&&(i.treeList.container.hasClass("expanded")||i.treeList.expand());break;case 40:if(e.preventDefault(),e.stopPropagation(),i.children&&Array.isArray(i.children)&&i.children.length>0&&i.treeList.container.hasClass("expanded"))n=i.children[0];else for(n=t._getNextSibling(i);!n&&i.parent;)i=i.parent,n=t._getNextSibling(i)}n&&(o?t.select(n):t._topList.find(".focus").removeClass("focus"),n.treeList.label.addClass("focus"))}else t._data[0]&&(o?t.select(t._data[0]):t._topList.find(".focus").removeClass("focus"),t._data[0].treeList.label.addClass("focus"))})),this._data=[],this._items={},this._selected=new Set,this._topList=e('<ol class="red-ui-treeList-list">').css({position:"absolute",top:0,left:0,right:0,bottom:0}).appendTo(i);var n={addButton:!1,scrollOnAdd:!1,height:"100%",addItem:function(e,o,i){t._addSubtree(t._topList,e,i,0)}};this.options.header&&(n.header=this.options.header),!1!==this.options.rootSortable&&this.options.sortable&&(n.sortable=this.options.sortable,n.connectWith=".red-ui-treeList-sortable",this._topList.addClass("red-ui-treeList-sortable")),this._topList.editableList(n),this.options.data&&this.data(this.options.data)},_getLastDescendant:function(e){return e.children&&e.treeList.container.hasClass("expanded")&&0!==e.children.length?this._getLastDescendant(e.children[e.children.length-1]):e},_getPreviousSibling:function(e){var t,o=(t=e.parent?e.parent.children:this._data).indexOf(e);return 0===o?null:t[o-1]},_getNextSibling:function(e){var t,o=(t=e.parent?e.parent.children:this._data).indexOf(e);return o===t.length-1?null:t[o+1]},_addChildren:function(t,o,i,n,a){var r=this,s=e('<ol class="red-ui-treeList-list">').appendTo(t).editableList({connectWith:".red-ui-treeList-sortable",sortable:r.options.sortable,addButton:!1,scrollOnAdd:!1,height:"auto",addItem:function(e,t,o){r._addSubtree(s,e,o,n+1)},sortItems:function(t){var i=[],n=[];t.each((function(){var t=e(this).data("data");i.push(t);var a=r._fixDepths(o,t);a&&n.push(a)})),Array.isArray(o.children)&&(o.children=i),n.forEach((function(e){r._trigger("changeparent",null,e)})),r._trigger("sort",null,o)},filter:o.treeList.childFilter});r.options.sortable&&s.addClass("red-ui-treeList-sortable");var d=0,l=function(){for(var e=d,t=0;t<30;t++){if((d=e+t)===i.length)return void setTimeout((function(){a&&a()}),10);i[d].parent=o,s.editableList("addItem",i[d])}++d<i.length&&setTimeout((function(){l()}),10)};return l(),s.hide(),s},_fixDepths:function(t,o){var i=this,n=null;if(o.parent!==t){reparented=!0;var a=o.parent;o.parent=t,n={item:o,old:a}}if(o.depth!==t.depth+1){o.depth=t.depth+1;var r=(o.gutter&&!o.gutter.hasClass("red-ui-treeList-gutter-float")?o.gutter.width()+2:0)+20*o.depth;o.treeList.labelPadding.width(r+"px"),o.element&&e(o.element).css({width:"calc(100% - "+(r+20+(o.icon?20:0))+"px)"}),o.children&&Array.isArray(o.children)&&o.children.forEach((function(e){i._fixDepths(o,e)}))}return n},_initItem:function(t,o){if(!t.treeList){var i=this;this._items[t.id]=t,t.treeList={},t.depth=o,t.treeList.remove=function(e){if(t.treeList.parentList&&t.treeList.parentList.editableList("removeItem",t,e),t.parent){var o=t.parent.children.indexOf(t);t.parent.children.splice(o,1),i._trigger("sort",null,t.parent)}if(i._selected.delete(t),delete t.treeList,delete i._items[t.id],0===t.depth){for(var n in i._items)if(i._items.hasOwnProperty(n)){var a=i._items[n];a.parent&&a.parent.id===t.id&&(delete i._items[n].treeList,delete i._items[n])}i._data=i._data.filter((function(e){return e.id!==t.id}))}},t.treeList.insertChildAt=function(e,o,n){e.parent=t,t.children.splice(o,0,e);var a=function(e,t){i._initItem(t,e.depth+1),t.parent=e,t.children&&"function"!=typeof t.children&&t.children.forEach((function(o){a(t,o,e.depth+2)}))};a(t,e),!t.deferBuild&&t.treeList.childList&&(t.treeList.childList.editableList("insertItemAt",e,o),n&&setTimeout((function(){i.select(e)}),100),i._trigger("sort",null,t),i.activeFilter&&i.filter(i.activeFilter))},t.treeList.addChild=function(e,o){t.treeList.insertChildAt(e,t.children.length,o)},t.treeList.expand=function(n){if(t.children){if(!t.treeList.container)return t.expanded=!0,void(n&&n(!1));var a=t.treeList.container;if(a.hasClass("expanded"))n&&n(!1);else{if(a.hasClass("built")||!t.deferBuild&&"function"!=typeof t.children)i._loadingData||t.children.length>20?t.treeList.childList.show():t.treeList.childList.slideDown("fast"),t.expanded=!0,n&&n(!i._loadingData);else{a.addClass("built");var r,s=!1,d=0,l=(Date.now(),function(e){s=!0,t.treeList.childList=i._addChildren(a,t,e,o,(function(){n&&n(!0),i._trigger("childrenloaded",null,t)}));var l=Date.now()-d;l<400?setTimeout((function(){t.treeList.childList.slideDown("fast"),r&&r.remove()}),400-l):(t.treeList.childList.slideDown("fast"),r&&r.remove()),t.expanded=!0});"function"==typeof t.children?t.children(l,t):(delete t.deferBuild,l(t.children)),s||(d=Date.now(),r=e('<div class="red-ui-treeList-spinner">').css({"background-position":35+20*o+"px 50%"}).appendTo(a))}a.addClass("expanded")}}else n&&n(!1)},t.treeList.collapse=function(){!1!==t.collapsible&&t.children&&(t.expanded=!1,t.treeList.container&&(t.children.length<20?t.treeList.childList.slideUp("fast"):t.treeList.childList.hide(),t.treeList.container.removeClass("expanded")))},t.treeList.sortChildren=function(e){t.children&&(t.children.sort(e),t.treeList.childList&&(t.treeList.childList.editableList("sort",e),t.treeList.childList.editableList("sort",null)))},t.treeList.replaceElement=function(o){if(t.element){if(t.treeList.container){e(t.element).remove(),e(o).appendTo(t.treeList.label);var i=(t.gutter?t.gutter[0].offsetWidth+2:0)+20*t.depth;e(o).css({width:"calc(100% - "+(i+20+(t.icon?20:0))+"px)"})}t.element=o}},t.children&&"function"!=typeof t.children&&t.children.forEach((function(e){i._initItem(e,o+1)}))}},_addSubtree:function(t,o,i,n){var a=this;this._initItem(i,n),i.treeList.container=o,i.treeList.parentList=t;var r=e("<div>",{class:"red-ui-treeList-label"});r.appendTo(o),i.treeList.label=r,i.class&&r.addClass(i.class),i.gutter&&i.gutter.css({position:"absolute"}).appendTo(r);var s=(i.gutter&&!i.gutter.hasClass("red-ui-treeList-gutter-float")?i.gutter.width()+2:0)+20*n;i.treeList.labelPadding=e("<span>").css({display:"inline-block","flex-shrink":0,width:s+"px"}).appendTo(r),r.on("mouseover",(function(e){a._trigger("itemmouseover",e,i)})),r.on("mouseout",(function(e){a._trigger("itemmouseout",e,i)})),r.on("mouseenter",(function(e){a._trigger("itemmouseenter",e,i)})),r.on("mouseleave",(function(e){a._trigger("itemmouseleave",e,i)})),i.treeList.makeLeaf=function(e){if(d.children().length){if(e&&i.children){var t=function(e){e.children&&e.children.forEach((function(e){e.element&&e.element.detach(),e.gutter&&e.gutter.detach(),t(e)}))};t(i)}d.empty(),i.deferBuild||(i.treeList.childList.remove(),delete i.treeList.childList),r.off("click.red-ui-treeList-expand"),d.off("click.red-ui-treeList-expand"),delete i.children,o.removeClass("expanded"),delete i.expanded}},i.treeList.makeParent=function(t){d.children().length||(e('<i class="fa fa-angle-right" />').toggleClass("hide",!1===i.collapsible).appendTo(d),d.on("click.red-ui-treeList-expand",(function(e){e.stopPropagation(),e.preventDefault(),o.hasClass("expanded")?i.treeList.collapse():i.treeList.expand()})),r.on("click.red-ui-treeList-expand",(function(e){o.hasClass("expanded")?(i.hasOwnProperty("selected")||r.hasClass("selected"))&&i.treeList.collapse():i.treeList.expand()})),i.children||(i.children=t||[],i.treeList.childList=a._addChildren(o,i,i.children,n)))};var d=e('<span class="red-ui-treeList-icon"></span>').appendTo(r);if(i.children&&i.treeList.makeParent(),i.checkbox){var l=e('<span class="red-ui-treeList-icon"></span>');(c=e('<input class="red-ui-treeList-checkbox" type="checkbox">').prop("checked",i.selected).appendTo(l)).on("click",(function(e){e.stopPropagation()})),c.on("change",(function(e){i.selected=this.checked,i.selected?a._selected.add(i):a._selected.delete(i),r.toggleClass("selected",this.checked),a._trigger("select",e,i)})),i.children||r.on("click",(function(e){e.stopPropagation(),c.trigger("click"),a._topList.find(".focus").removeClass("focus"),r.addClass("focus")})),i.treeList.select=function(e){e!==i.selected&&c.trigger("click")},i.treeList.checkbox=c,l.appendTo(r)}else if(i.radio){var c;l=e('<span class="red-ui-treeList-icon"></span>');(c=e('<input class="red-ui-treeList-radio" type="radio">').prop("name",i.radio).prop("checked",i.selected).appendTo(l)).on("click",(function(e){e.stopPropagation()})),c.on("change",(function(e){i.selected=this.checked,a._selected.forEach((function(e){e.radio===i.radio&&(e.treeList.label.removeClass("selected"),e.selected=!1,a._selected.delete(e))})),i.selected?a._selected.add(i):a._selected.delete(i),r.toggleClass("selected",this.checked),a._trigger("select",e,i)})),i.children||r.on("click",(function(e){e.stopPropagation(),c.trigger("click"),a._topList.find(".focus").removeClass("focus"),r.addClass("focus")})),i.treeList.select=function(e){e!==i.selected&&c.trigger("click")},l.appendTo(r),i.treeList.radio=c}else r.on("click",(function(e){a.options.multi||a.clearSelection(),r.addClass("selected"),a._selected.add(i),a._topList.find(".focus").removeClass("focus"),r.addClass("focus"),a._trigger("select",e,i)})),r.on("dblclick",(function(e){a._topList.find(".focus").removeClass("focus"),r.addClass("focus"),i.children||a._trigger("confirm",e,i)})),i.treeList.select=function(e){a.options.multi||a.clearSelection(),r.toggleClass("selected",e),e?(a._selected.add(i),a._trigger("select",null,i)):a._selected.delete(i),a.reveal(i)};r.toggleClass("selected",!!i.selected),i.selected&&a._selected.add(i),i.icon&&("string"==typeof i.icon?e('<span class="red-ui-treeList-icon"><i class="'+i.icon+'" /></span>').appendTo(r):e('<span class="red-ui-treeList-icon">').appendTo(r).append(i.icon)),i.hasOwnProperty("label")||i.hasOwnProperty("sublabel")?(i.hasOwnProperty("label")&&e('<span class="red-ui-treeList-label-text"></span>').text(i.label).appendTo(r),i.hasOwnProperty("sublabel")&&e('<span class="red-ui-treeList-sublabel-text"></span>').text(i.sublabel).appendTo(r)):i.element&&(e(i.element).appendTo(r),e(i.element).css({width:"calc(100% - "+(s+20+(i.icon?20:0))+"px)"})),i.children&&(Array.isArray(i.children)&&!i.deferBuild&&(i.treeList.childList=a._addChildren(o,i,i.children,n)),i.expanded&&i.treeList.expand())},empty:function(){this._topList.editableList("empty")},data:function(e){var t=this;if(void 0===e)return this._data;this._data=e,this._items={},this._topList.editableList("empty"),this._loadingData=!0;for(var o=0;o<e.length;o++)this._topList.editableList("addItem",e[o]);setTimeout((function(){delete t._loadingData}),200),this._trigger("select")},show:function(e,t){if("string"==typeof e&&(e=this._items[e]),e){for(var o=this,i=[],n=e;n;)i.unshift(n),n=n.parent;var a=!1,r=function(e){a=a||e;var n=i.shift();0===i.length?setTimeout((function(){o.reveal(n),t&&t()}),a?200:0):n.treeList.expand(r)};r()}},reveal:function(e){if("string"==typeof e&&(e=this._items[e]),e){var t=this._topList.offset().top,o=e.treeList.label.offset().top,i=this._topList.parent().scrollTop();o-=t+i;var n=this._topList.parent().height(),a=e.treeList.label.outerHeight();o<a/2?this._topList.parent().scrollTop(i+o-a/2-a):o+a>n&&this._topList.parent().scrollTop(i+(o+2.5*a-n))}},select:function(e,t,o){var i=this;this.options.multi||!1===o||this.clearSelection(),Array.isArray(e)?e.forEach((function(e){i.select(e,t,!1)})):("string"==typeof e&&(e=this._items[e]),e&&(e.selected=!0,this._selected.add(e),e.treeList.label&&e.treeList.label.addClass("selected"),i._topList.find(".focus").removeClass("focus"),!1!==t&&this._trigger("select",null,e)))},clearSelection:function(){this._selected.forEach((function(e){e.selected=!1,e.treeList.checkbox&&e.treeList.checkbox.prop("checked",!1),e.treeList.label&&e.treeList.label.removeClass("selected")})),this._selected.clear()},selected:function(){var e=[];return this._selected.forEach((function(t){e.push(t)})),this.options.multi?e:e.length?e[0]:void 0},filter:function(e){this.activeFilter=e;var t=0,o=function(i){var n=0;e&&e(i)&&(n++,t++);var a=0;return i.children&&"function"!=typeof i.children&&(i.treeList.childList?a=i.treeList.childList.editableList("filter",o):(i.treeList.childFilter=o,e&&i.children.forEach((function(e){o(e)&&a++}))),n+=a,e&&a>0&&setTimeout((function(){i.treeList.expand()}),10)),e?n>0:(t++,!0)};return this._topList.editableList("filter",o),t},get:function(e){return this._items[e]||null}})}(jQuery),function(e){e.widget("nodered.checkboxSet",{_create:function(){var t=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var o=this.element.prop("checked");this.states=[e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],o?this.states[1].show():this.states[0].show(),this.element.on("change",(function(){this.checked?(t.states[0].hide(),t.states[1].show(),t.states[2].hide()):(t.states[1].hide(),t.states[0].show(),t.states[2].hide());var e=this.checked;t.children.forEach((function(t){t.checkboxSet("state",e,!1,!0)}))})),this.uiElement.on("click",(function(e){e.stopPropagation(),t.state(!1===t.state())})),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)},updateChild:function(e){var t=0;this.children.forEach((function(e,o){!0===e.checkboxSet("state")&&t++})),0===t?this.state(!1,!0):t===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,o){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var i=this.partialFlag||e;this.element.prop("checked",i),!0===e?(this.states[0].hide(),this.states[1].show(),this.states[2].hide()):!1===e?(this.states[2].hide(),this.states[1].hide(),this.states[0].show()):null===e&&(this.states[0].hide(),this.states[1].hide(),this.states[2].show()),t||this.element.trigger("change",null),!o&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var e={};let t=0;function o(r){var s,d;if(null!==r&&r.id&&!1===RED.settings.theme("menu."+r.id))return null;if(null===r)s=$('<li class="red-ui-menu-divider"></li>');else{s=$("<li></li>"),r.id||(r.id="red-ui-menu-item-"+t++),r.group&&s.addClass("red-ui-menu-group-"+r.group);var l="<a "+(r.id?'id="'+r.id+'" ':"")+'tabindex="-1" href="#">';r.toggle&&(l+='<i class="fa fa-square'+("right"!==r.direction?" pull-left":"")+'"></i>',l+='<i class="fa fa-check-square'+("right"!==r.direction?" pull-left":"")+'"></i>'),void 0!==r.icon&&(/\.(png|svg)/.test(r.icon)?l+='<img src="'+r.icon+'"/> ':l+='<i class="'+(r.icon?r.icon:'" style="display: inline-block;"')+'"></i> ');let m=r.label;r.label||"string"!=typeof r.onselect||(m=RED.actions.getLabel(r.onselect)),r.sublabel?l+='<span class="red-ui-menu-label-container"><span class="red-ui-menu-label">'+m+'</span><span class="red-ui-menu-sublabel">'+r.sublabel+"</span></span>":l+='<span class="red-ui-menu-label"><span>'+m+"</span></span>",l+="</a>";var c=$(l).appendTo(s);if(r.link=c,"string"==typeof r.onselect){var u=RED.keyboard.getShortcut(r.onselect);u&&u.key&&(r.shortcutSpan=$('<span class="red-ui-popover-key">'+RED.keyboard.formatKey(u.key,!0)+"</span>").appendTo(c.find(".red-ui-menu-label")))}if(e[r.id]=r,r.onselect?(c.on("click",(function(e){e.preventDefault(),$(this).parent().hasClass("disabled")||(r.toggle?!0===r.toggle?a(r.id,!n(r.id)):a(r.id,!0):i(r.id))})),r.toggle&&(d=RED.settings.get("menu-"+r.id),r.setting&&(null!==d?(RED.settings.set(r.setting,d),RED.settings.remove("menu-"+r.id)):d=RED.settings.get(r.setting)),d?(c.addClass("active"),i(r.id,!0)):!1===d?(c.removeClass("active"),i(r.id,!1)):r.hasOwnProperty("selected")&&(r.selected?c.addClass("active"):c.removeClass("active"),i(r.id,r.selected)))):r.href?c.attr("target","_blank").attr("href",r.href):r.options||(s.addClass("disabled"),c.on("click",(function(e){e.preventDefault()}))),r.options){s.addClass("red-ui-menu-dropdown-submenu"+("right"!==r.direction?" pull-left":""));for(var p=$('<ul id="'+r.id+'-submenu" class="red-ui-menu-dropdown"></ul>').appendTo(s),f=!1,h=!1,g=0;g<r.options.length;g++){r.options[g]&&(r.onpreselect&&void 0===r.options[g].onpreselect&&(r.options[g].onpreselect=r.onpreselect),r.onpostselect&&void 0===r.options[g].onpostselect&&(r.options[g].onpostselect=r.onpostselect),r.options[g].direction=r.direction,f=f||r.options[g].icon,h=h||r.options[g].options);var v=o(r.options[g]);v&&v.appendTo(p)}f||p.addClass("red-ui-menu-dropdown-noicons"),h&&p.addClass("red-ui-menu-dropdown-submenus")}r.disabled&&s.addClass("disabled"),!1===r.visible&&s.addClass("hide")}return s}function i(t,o){var i=e[t],n=i.onselect;i.onpreselect&&i.onpreselect.call(i,o),"string"==typeof i.onselect&&(n=RED.actions.get(i.onselect)),n?n.call(i,o):console.log("No callback for",t,i.onselect),i.onpostselect&&i.onpostselect.call(i,o)}function n(e){return $("#"+e).hasClass("active")}function a(t,o){var r=!1;n(t)==o&&(r=!0);var s=e[t];if(o?$("#"+t).addClass("active"):$("#"+t).removeClass("active"),s){if(s.toggle&&"string"==typeof s.toggle&&o)for(var d in e)if(e.hasOwnProperty(d)){var l=e[d];l.id!=s.id&&s.toggle==l.toggle&&a(l.id,!1)}!r&&s.onselect&&i(s.id,o),s.local||r||RED.settings.set(s.setting||"menu-"+s.id,o)}}return{init:function(e){var t=$("<ul/>",{class:"red-ui-menu red-ui-menu-dropdown pull-right"});if(e.direction&&t.addClass("red-ui-menu-dropdown-direction-"+e.direction),e.id){t.attr({id:e.id+"-submenu"});var i=$("#"+e.id);1===i.length&&(t.insertAfter(i),i.on("click",(function(e){e.stopPropagation(),e.preventDefault(),t.is(":visible")?($(document).off("click.red-ui-menu"),t.hide()):($(document).on("click.red-ui-menu",(function(e){$(document).off("click.red-ui-menu"),activeMenu=null,t.hide()})),$(".red-ui-menu.red-ui-menu-dropdown").hide(),t.show())})))}for(var n=!1,a=!1,r=!1,s=0;s<e.options.length;s++){var d=e.options[s];if(d&&(e.onpreselect&&void 0===d.onpreselect&&(d.onpreselect=e.onpreselect),e.onpostselect&&void 0===d.onpostselect&&(d.onpostselect=e.onpostselect),d.direction=e.direction||"left"),null!==d||!n){r=r||d&&d.icon,a=a||d&&d.options;var l=o(d);l&&(l.appendTo(t),n=null===d)}}return r||t.addClass("red-ui-menu-dropdown-noicons"),a&&t.addClass("red-ui-menu-dropdown-submenus"),t},setSelected:a,isSelected:n,toggleSelected:function(e){a(e,!n(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},setVisible:function(e,t){t?$("#"+e).parent().removeClass("hide"):$("#"+e).parent().addClass("hide")},addItem:function(e,t){var i=o(t);if(null!==t&&t.group){var n=$("#"+e+"-submenu").children(".red-ui-menu-group-"+t.group);if(0===n.length)i.appendTo("#"+e+"-submenu");else{for(var a=0;a<n.length;a++){var r=n[a],s=$(r).find(".red-ui-menu-label").html();if(t.label<s){$(r).before(i);break}}a===n.length&&i.appendTo("#"+e+"-submenu")}}else i.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(t,o){var i=e[t];i&&(i.onselect=o)},refreshShortcuts:function(){for(var t in e)if(e.hasOwnProperty(t)){var o=e[t];if("string"==typeof o.onselect&&o.shortcutSpan){o.shortcutSpan.remove(),delete o.shortcutSpan;var i=RED.keyboard.getShortcut(o.onselect);i&&i.key&&(o.shortcutSpan=$('<span class="red-ui-popover-key">'+RED.keyboard.formatKey(i.key,!0)+"</span>").appendTo(o.link.find(".red-ui-menu-label")))}}}}}(),RED.panels={create:function(e){var t=e.container||$("#"+e.id),o=t.children();if(2!==o.length)throw console.log(e.id),new Error("Container must have exactly two children");var i=!e.dir||"vertical"===e.dir;t.addClass("red-ui-panels"),i||t.addClass("red-ui-panels-horizontal"),$(o[0]).addClass("red-ui-panel"),$(o[1]).addClass("red-ui-panel");var n,a=$('<div class="red-ui-panels-separator"></div>').insertAfter(o[0]),r=[],s=!1,d=.5;a.draggable({axis:i?"y":"x",containment:t,scroll:!1,start:function(e,t){n=i?t.position.top:t.position.left,r=[i?$(o[0]).height():$(o[0]).width(),i?$(o[1]).height():$(o[1]).width()]},drag:function(a,s){var l=i?t.height():t.width(),c=(i?s.position.top:s.position.left)-n,u=[r[0]+c,r[1]-c];i?($(o[0]).height(u[0]),s.position.top-=c):($(o[0]).width(u[0]),s.position.left-=c),e.resize&&e.resize(u[0],u[1]),d=u[0]/(l-8)},stop:function(e,t){s=!0}});var l={ratio:function(e){if(void 0===e)return d;d=e,s=!0,0===e||1===e?a.hide():a.show(),i?l.resize(t.height()):l.resize(t.width())},resize:function(n){var a;if(i?(a=[$(o[0]).outerHeight(),$(o[1]).outerHeight()],t.height(n)):(a=[$(o[0]).outerWidth(),$(o[1]).outerWidth()],t.width(n)),s){var r=d*(n-8);a=[r,n-r-8],i?$(o[0]).outerHeight(a[0]):$(o[0]).outerWidth(a[0])}e.resize&&(a=i?[$(o[0]).height(),$(o[1]).height()]:[$(o[0]).width(),$(o[1]).width()],e.resize(a[0],a[1]))}};return l}},RED.popover=function(){var e={default:{x:12,y:12},small:{x:8,y:8}};return{create:function(t){var o=t.target,i=t.direction||"right",n=t.trigger,a=t.content,r=t.delay||{show:750,hide:50},s=t.autoClose,d=t.width||"auto",l=t.maxWidth,c=t.size||"default",u=t.offset||0;if(!e[c])throw new Error("Invalid RED.popover size value:",c);var p,f,h,g,v=null,m=function(e){if(p){var s=o.data("red-ui-popover");if(t.tooltip&&s)return void(p=!1);if(f=$('<div class="red-ui-popover"></div>'),t.class&&f.addClass(t.class),h=$('<div class="red-ui-popover-content">').appendTo(f),"default"!==c&&f.addClass("red-ui-popover-size-"+c),"function"==typeof a){var u=a.call(w);if(null===u)return;"string"==typeof u?h.text(u):h.append(u)}else h.html(a);f.appendTo("body"),b({target:o,direction:i,width:d,maxWidth:l}),s&&s.close(!0),"manual"!==t.trigger&&o.data("red-ui-popover",w),t.tooltip&&f.on("mousedown",(function(e){y(!0)})),"hover"===n&&t.interactive&&(f.on("mouseenter",(function(e){clearTimeout(v),p=!0})),f.on("mouseleave",(function(e){v&&clearTimeout(v),p&&(v=setTimeout((function(){p=!1,y()}),r.hide))}))),e?f.show():f.fadeIn("fast")}},b=function(t){o=t.target||o,i=t.direction||i||"right",u=t.offset||u;var n=t.transition,a=t.width||"auto";f.width(a),t.maxWidth?f.css("max-width",t.maxWidth):f.css("max-width","auto");var r=o[0].getBoundingClientRect(),s=r.height,d=r.width,l=f.outerHeight(),p=f.outerWidth(),h=$(window).scrollTop(),v=$(window).scrollLeft(),m=h+$(window).height(),b=v+$(window).width(),y=0,w=0;"right"===i?(y=r.top+s/2-l/2,w=r.left+d+e[c].x+u):"left"===i?(y=r.top+s/2-l/2,w=r.left-e[c].x-p-u):"bottom"===i?(y=r.top+s+e[c].y+u,(w=r.left+d/2-p/2)<0?(i="right",y=r.top+s/2-l/2,w=r.left+d+e[c].x+u):w+p+10>b?(i="left",y=r.top+s/2-l/2,w=r.left-e[c].x-p-u,y+l+s/2+5>m&&(y-=y+l+s/2-m+5)):y+l>m&&(i="top",y=r.top-e[c].y-l-u,w=r.left+d/2-p/2)):"top"===i?(y=r.top-e[c].y-l-u,w=r.left+d/2-p/2,y<0&&(i="bottom",y=r.top+s+e[c].y+u,w=r.left+d/2-p/2)):/inset/.test(i)&&(y=r.top+s/2-l/2,w=r.left+d/2-p/2,/bottom/.test(i)&&(y=r.top+s-l-u),/top/.test(i)&&(y=r.top+u),/left/.test(i)&&(w=r.left+u),/right/.test(i)&&(w=r.left+d-p-u)),g&&f.removeClass(g),n&&f.css({transition:"0.6s ease","transition-property":"top,left,right,bottom"}),g="red-ui-popover-"+i,f.addClass(g).css({top:y,left:w}),n&&setTimeout((function(){f.css({transition:"none"})}),600)},y=function(e){$(document).off("mousedown.red-ui-popover"),p||f&&(e?f.remove():f.fadeOut("fast",(function(){$(this).remove()})),f=null,o.removeData("red-ui-popover",w))};o.on("remove",(function(e){v&&clearTimeout(v),p&&(p=!1,setTimeout(y,r.hide))})),"hover"===n?(o.on("mouseenter",(function(e){clearTimeout(v),p||(p=!0,v=setTimeout(m,r.show))})),o.on("mouseleave disabled",(function(e){v&&clearTimeout(v),p&&(p=!1,setTimeout(y,r.hide))}))):"click"===n?(o.on("click",(function(e){e.preventDefault(),e.stopPropagation(),(p=!p)?m():y()})),s&&o.on("mouseleave disabled",(function(e){v&&clearTimeout(v),p&&(p=!1,setTimeout(y,s))}))):"modal"===n?$(document).on("mousedown.red-ui-popover",(function(e){for(var t=e.target;"BODY"!==t.nodeName&&t!==f[0];)t=t.parentElement;"BODY"===t.nodeName&&(p=!1,y())})):s&&setTimeout((function(){p=!1,y()}),s);var w={get element(){return f},setContent:function(e){return a=e,w},open:function(e){return p=!0,m(e),w},close:function(e){return p=!1,y(e),w},move:function(e){b(e)}};return w},tooltip:function(e,t,o){var i=RED.popover.create({tooltip:!0,target:e,trigger:"hover",size:"small",direction:"bottom",content:function(){var e=t;if(o){var i=RED.keyboard.getShortcut(o);i&&i.key&&(e=$("<span>"+t+' <span class="red-ui-popover-key">'+RED.keyboard.formatKey(i.key,!0)+"</span></span>"))}return e},delay:{show:750,hide:50}});return i.setContent=function(e){t=e},i.setAction=function(e){o=e},i.delete=function(){i.close(!0),e.off("mouseenter"),e.off("mouseleave")},i},menu:function(e){var t=$('<ul class="red-ui-menu"></ul>');"compact"===e.style&&t.addClass("red-ui-menu-compact");var o,i=e.options||[],n=RED.popover.panel(t);e.width&&n.container.width(e.width),e.class&&n.container.addClass(e.class),e.maxHeight&&n.container.css({"max-height":e.maxHeight,"overflow-y":"auto"});var a={options:function(n){if(void 0===n)return i;i=n||[],t.empty(),i.forEach((function(i){var n=$("<li>").appendTo(t),r=$('<a href="#"></a>').appendTo(n);"string"==typeof i.label?r.text(i.label):i.label&&i.label.appendTo(r),r.on("click",(function(t){t.preventDefault(),i.onselect?i.onselect():e.onselect&&e.onselect(i),a.hide()})),o||(o=r)}))},show:function(o){$(document).on("keydown.red-ui-menu",(function(o){var n=t.find(":focus").parent();40===o.keyCode?(o.preventDefault(),n.length>0?n.index()===i.length-1?t.children().first().children().first().focus():n.next().children().first().focus():t.children().first().children().first().focus()):38===o.keyCode?(o.preventDefault(),n.length>0?0===n.index()?t.children().last().children().first().focus():n.prev().children().first().focus():t.children().last().children().first().focus()):27===o.keyCode?(o.preventDefault(),a.hide(!0)):9===o.keyCode&&e.tabSelect&&(o.preventDefault(),n.find("a").trigger("click")),o.stopPropagation()})),o.onclose=function(){$(document).off("keydown.red-ui-menu"),e.onclose&&e.onclose(!0)},n.show(o)},hide:function(t){$(document).off("keydown.red-ui-menu"),n.hide(e.disposeOnClose),e.onclose&&e.onclose(t)}};return a.options(i),a},panel:function(e){var t=$('<div class="red-ui-editor-dialog red-ui-popover-panel"></div>');function o(e){$(document).off("mousedown.red-ui-popover-panel-close"),$(document).off("keydown.red-ui-popover-panel-close"),t.hide(),t.css({height:"auto"}),!1!==e&&t.remove()}return t.css({display:"none"}),t.appendTo(document.body),e.appendTo(t),{container:t,show:function(e){var i=e.onclose,n=e.closeButton,a=e.target,r=e.align||"right",s=e.offset||[0,0],d=e.x,l=e.y,c=void 0!==d&&void 0!==l,u=c?{left:d,top:l}:a.offset(),p=(c||a.width(),c?0:a.outerHeight()),f=t.height(),h=t.width(),g=p+u.top+s[1];g+f-$(document).scrollTop()>$(window).height()&&(g-=g+f-$(window).height()+5),g<0&&(t.height(f+g),g=0),"right"===r?t.css({top:g+"px",left:u.left+s[0]+"px"}):"left"===r&&t.css({top:g+"px",left:u.left-h+s[0]+"px"}),t.slideDown(100),$(document).on("keydown.red-ui-popover-panel-close",(function(t){27===t.keyCode&&(i&&i(),o(e.dispose))})),$(document).on("mousedown.red-ui-popover-panel-close",(function(a){n&&$(a.target).closest(n).length||$(a.target).closest(t).length||$(a.target).closest(".red-ui-editor-dialog").length||(i&&i(),o(e.dispose))}))},hide:o}}}}(),function(e){e.widget("nodered.searchBox",{_create:function(){var t=this;(this.currentTimeout=null,this.lastSent="",this.element.val(""),this.element.addClass("red-ui-searchBox-input"),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),"compact"===this.options.style&&this.uiContainer.addClass("red-ui-searchBox-compact"),0===this.element.parents("form").length)&&this.element.wrap("<form>").parent().addClass("red-ui-searchBox-form");if(e('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=e('<a class="red-ui-searchBox-clear" href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",(function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.trigger("focus")})),this.options.options){this.uiContainer.addClass("red-ui-searchBox-has-options"),this.optsButton=e('<a class="red-ui-searchBox-opts" href="#"><i class="fa fa-caret-down"></i></a>').appendTo(this.uiContainer);var o=!1;this.optsMenu=RED.popover.menu({style:this.options.style,options:this.options.options.map((function(e){return{label:e.label,onselect:function(){t.element.val(e.value+" "),t._change(e.value,!0)}}})),onclose:function(e){o=!1,t.element.trigger("focus")},disposeOnClose:!1});var i=function(){o=!0,t.optsMenu.show({target:t.optsButton,align:"left",offset:[t.optsButton.width()-2,-1],dispose:!1})};this.optsButton.on("click",(function(e){e.preventDefault(),o?t.optsMenu.hide(!0):i()})),this.optsButton.on("keydown",(function(e){o||40!==e.keyCode||i()})),this.element.on("keydown",(function(t){o||40!==t.keyCode||""!==e(this).val()||i()}))}this.resultCount=e("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",(function(e){27===e.keyCode&&t.element.val(""),13===e.keyCode&&e.preventDefault()})),this.element.on("keyup",(function(o){t._change(e(this).val())})),this.element.on("focus",(function(){e(document).one("mousedown",(function(){t.element.blur()}))}))},_change:function(e,t){var o=!1;""===e?(this.clearButton.hide(),o=!0):(this.clearButton.show(),o=e.length>=(this.options.minimumLength||0));var i=this.element.val();if(o=o&&i!==this.lastSent)if(!t&&this.options.delay>0){clearTimeout(this.currentTimeout);var n=this;this.currentTimeout=setTimeout((function(){n.lastSent=n.element.val(),n._trigger("change")}),this.options.delay)}else this.lastSent=this.element.val(),this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){var e,t="fa fa-lemon-o",o=!1,i=!1;return{create:function(n){var a,r,s,d,l,c={},u=0,p=0,f=n.order,h=n.element||$("#"+n.id),g=h.wrap("<div>").parent(),v=h.wrap("<div>").parent();if(g.addClass("red-ui-tabs"),n.vertical&&g.addClass("red-ui-tabs-vertical"),n.addButton){g.addClass("red-ui-tabs-add");var m=$('<div class="red-ui-tab-button red-ui-tabs-add"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(g);if(m.find("a").on("click",(function(e){e.preventDefault(),"function"==typeof n.addButton?n.addButton():"string"==typeof n.addButton&&RED.actions.invoke(n.addButton)})),"string"==typeof n.addButton){var b=n.addButton;n.addButtonCaption&&(b=n.addButtonCaption),RED.popover.tooltip(m,b,n.addButton)}h.on("dblclick",(function(e){var t=h.children(),o=e.clientX,i=0;t.each((function(e){if($(this).offset().left>o)return!1;i=e+1})),"function"==typeof n.addButton?n.addButton({index:i}):"string"==typeof n.addButton&&RED.actions.invoke(n.addButton,{index:i})}))}if(n.searchButton){g.addClass("red-ui-tabs-search");var y=$('<div class="red-ui-tab-button red-ui-tabs-search"><a href="#"><i class="fa fa-list-ul"></i></a></div>').appendTo(g);if(y.find("a").on("click",(function(e){e.preventDefault(),"function"==typeof n.searchButton?n.searchButton():"string"==typeof n.searchButton&&RED.actions.invoke(n.searchButton)})),"string"==typeof n.searchButton){b=n.searchButton;n.searchButtonCaption&&(b=n.searchButtonCaption),RED.popover.tooltip(y,b,n.searchButton)}}if(n.menu){g.addClass("red-ui-tabs-menu");var w,E=$('<div class="red-ui-tab-button red-ui-tabs-menu"><a href="#"><i class="fa fa-caret-down"></i></a></div>').appendTo(g),D=E.find("a"),R=!1;D.on("click",(function(e){if(e.stopPropagation(),e.preventDefault(),R)return w.remove(),void(R=!1);R=!0;var t=[];"function"==typeof n.searchButton?t=n.menu():Array.isArray(n.menu)?t=n.menu:"function"==typeof n.menu&&(t=n.menu()),(w=RED.menu.init({options:t})).attr("id",n.id+"-menu"),w.css({position:"absolute"}),w.appendTo("body");var o=E.offset();w.css({top:o.top+E.height()-2+"px",left:o.left-w.width()+E.width()+"px"}),$(".red-ui-menu.red-ui-menu-dropdown").hide(),$(document).on("click.red-ui-tabmenu",(function(e){$(document).off("click.red-ui-tabmenu"),R=!1,w.remove()})),w.show()}))}if(n.scrollable&&(g.addClass("red-ui-tabs-scrollable"),v.addClass("red-ui-tabs-scroll-container"),v.on("scroll",(function(e){L()})),v.on("wheel",(function(e){if(0===e.originalEvent.deltaX){e.preventDefault();var t=v.scrollLeft();t-=e.originalEvent.deltaY,v.scrollLeft(t)}})),(d=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(g).find("a")).on("mousedown",(function(e){k(e,e.shiftKey?"-="+v.scrollLeft():"-=150")})).on("click",(function(e){e.preventDefault()})),(l=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(g).find("a")).on("mousedown",(function(e){k(e,e.shiftKey?"+="+(v[0].scrollWidth-v.width()-v.scrollLeft()):"+=150")})).on("click",(function(e){e.preventDefault()}))),n.collapsible){g.addClass("red-ui-tabs-collapsible");var x=$('<div class="red-ui-tab-link-buttons"></div>').appendTo(g);if(!1!==n.menu){var _=$('<a href="#"><i class="fa fa-caret-down"></i></a>').appendTo(x);_.addClass("red-ui-tab-link-button-menu"),_.on("click",(function(e){if(e.stopPropagation(),e.preventDefault(),!r){var o=[];h.children().each((function(e,i){var n=$(i).data("tabId"),a={id:"red-ui-tabs-menu-option-"+n,icon:c[n].iconClass||t,label:c[n].name,onselect:function(){O(n)}};o.push(a)})),o=[].concat(o),(r=RED.menu.init({options:o})).css({position:"absolute"}),r.appendTo("body")}var i=_.offset();r.css({top:i.top+_.height()-2+"px",left:i.left-r.width()+_.width()+"px"}),r.is(":visible")?$(document).off("click.red-ui-tabmenu"):($(".red-ui-menu.red-ui-menu-dropdown").hide(),$(document).on("click.red-ui-tabmenu",(function(e){$(document).off("click.red-ui-tabmenu"),r.hide()}))),r.toggle()}))}}function k(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var o=v.scrollLeft();v.animate({scrollLeft:t},100);var i=setInterval((function(){var e=v.scrollLeft();e!==o?(o=e,v.animate({scrollLeft:t},100)):clearInterval(i)}),100);$(this).one("mouseup",(function(){clearInterval(i)}))}}function T(){var e=h.find("li.red-ui-tab.selected"),t=[];return e.each((function(){t.push(c[$(this).find("a").attr("href").slice(1)])})),t}function C(){n.onselect(T())}function j(t){if(!o)if(t.currentTarget===s){if(s=null,e&&Date.now()-e<400)return e=0,i=!0,S.call(this,t);e=Date.now();var a=h.find("li.red-ui-tab.active"),r=$(this).parent(),d=!1;if(n.onselect)if(t.metaKey||t.ctrlKey){if(r.hasClass("selected")){if(r.removeClass("selected"),r[0]!==a[0])return void C();if(0===(p=h.find("li.red-ui-tab.selected")).length)return void C();r=p.first()}else{if(!a.hasClass("selected")){c[a.find("a").attr("href").slice(1)];a.addClass("selected")}r.addClass("selected")}d=!0}else if(t.shiftKey){var l,u;if(a[0]!==r[0])a.index()<r.index()?(l=a,u=r):(l=r,u=a),h.find("li.red-ui-tab").removeClass("selected"),l.addClass("selected"),u.addClass("selected"),l.nextUntil(u).addClass("selected");d=!0}else{var p;(p=h.find("li.red-ui-tab.selected")).length>0&&(p.removeClass("selected"),d=!0)}var f=r.find("a");n.onclick&&n.onclick(c[f.attr("href").slice(1)]),O(f),d&&C()}else s=null}function L(){if(0!==h.children().length){var e=v.scrollLeft(),t=v.width(),o=h.width();0===e?d.hide():d.show(),e===o-t?l.hide():l.show()}}function S(e){if(e.preventDefault(),!e.metaKey&&!e.shiftKey)return n.ondblclick&&n.ondblclick(c[$(this).attr("href").slice(1)]),!1}function O(e){if("string"==typeof e&&(e=h.find("a[href='#"+e+"']")),0!==e.length&&(e.parent().hasClass("hide-tab")&&(e.parent().removeClass("hide-tab").removeClass("hide"),n.onshow&&n.onshow(c[e.attr("href").slice(1)])),!e.parent().hasClass("active"))){h.children().removeClass("active"),h.children().css({transition:"width 100ms"}),e.parent().addClass("active");var t=e.parent().attr("id");if(g.find(".red-ui-tab-link-button").removeClass("active selected"),$("#"+t+"-link-button").addClass("active selected"),n.scrollable){var o=e.parent().position().left;o-21<0?v.animate({scrollLeft:"+="+(o-50)},300):o+120>v.width()&&v.animate({scrollLeft:"+="+(o+140-v.width())},300)}n.onchange&&n.onchange(c[e.attr("href").slice(1)]),I(),setTimeout((function(){h.children().css({transition:""})}),100)}}function I(){if(!n.vertical){var e=h.find("li.red-ui-tab"),t=e.filter(":not(.hide-tab)"),o=e.filter(".hide-tab"),i=g.width(),r=t.length;if(n.collapsible){var s=x.children().length,d=x.children(":visible").length,l=120;if((u=i-x.width()-10)<=l||u<198&&d>5){var c=x.find("a:last").prev();for(x.children().length;c.is(":not(:visible)");)c=c.prev();(u<=l||d>6)&&c.hide(),u=Math.max(l,i-x.width()-10)}else{d!==s&&(u=d<6?l:198),i-u-x.width()>40&&x.find("a:not(:visible):first").show(),u=i-x.width()-10}t.css({width:u})}else{var u;if(p=(a=100*(u=(i-12-6*r)/r)/i+"%")+"%",n.scrollable){u=Math.max(u,140),a=u+"px",p=0;var f=Math.max(g.width(),12+(u+6)*r);h.width(f),L()}else n.hasOwnProperty("minimumActiveTabWidth")&&(u<n.minimumActiveTabWidth?(r-=1,u=(i-12-n.minimumActiveTabWidth-6*r)/r,a=100*u/i+"%",p=n.minimumActiveTabWidth+"px"):p=0);t.css({width:a}),o.css({width:"0px"}),u<50?(h.find(".red-ui-tab-icon").hide(),h.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,u-38))+"px"})):(h.find(".red-ui-tab-icon").show(),h.find(".red-ui-tab-label").css({paddingLeft:""})),0!==p&&(h.find("li.red-ui-tab.active").css({width:n.minimumActiveTabWidth}),h.find("li.red-ui-tab.active .red-ui-tab-icon").show(),h.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}}function N(e){if(n.onselect){var t=h.find("li.red-ui-tab.selected");t.length>0&&(t.removeClass("selected"),C())}var o=h.find("a[href='#"+e+"']").parent();if(o.hasClass("active")){var i=P(o);0===i.length&&(i=A(o)),i.length>0?O(i.find("a")):n.onchange&&n.onchange(null)}o.remove(),c[e].pinned&&u--,n.onremove&&n.onremove(c[e]),delete c[e],I(),r&&(r.remove(),r=null)}function P(e){e||(e=h.find("li.active"));for(var t=e.prev();t.length>0&&t.hasClass("hide-tab");)t=t.prev();return t}function A(e){e||(e=h.find("li.active"));for(var t=e.next();t.length>0&&t.hasClass("hide-tab");)t=t.next();return t}function M(e){if(c[e]){var t=h.find("a[href='#"+e+"']").parent();if(!t.hasClass("hide-tab")){if(t.hasClass("active")){var o=P(t);0===o.length&&(o=A(t)),o.length>0?O(o.find("a")):n.onchange&&n.onchange(null)}t.removeClass("active"),t.one("transitionend",(function(o){t.addClass("hide"),I(),n.onhide&&n.onhide(c[e]),setTimeout((function(){L()}),200)})),t.addClass("hide-tab"),t.css({width:0})}}}h.children().first().addClass("active"),h.children().addClass("red-ui-tab"),h.find("li.red-ui-tab a").on("mousedown",(function(e){s=e.currentTarget})).on("mouseup",j).on("click",(function(e){e.preventDefault()})).on("dblclick",(function(e){e.stopPropagation(),e.preventDefault()})),setTimeout((function(){I()}),0);var z={addTab:function(e,a){if(n.onselect){var d=h.find("li.red-ui-tab.selected");d.length>0&&(d.removeClass("selected"),C())}c[e.id]=e;var l=$("<li/>",{class:"red-ui-tab"});0===h.children().length&&(a=void 0),0===a?l.prependTo(h):a>0?l.insertAfter(h.find("li:nth-child("+a+")")):l.appendTo(h),l.attr("id","red-ui-tab-"+e.id.replace(".","-")),l.data("tabId",e.id),(n.maximumTabWidth||e.maximumTabWidth)&&l.css("maxWidth",(n.maximumTabWidth||e.maximumTabWidth)+"px");var p,g=$("<a/>",{href:"#"+e.id,class:"red-ui-tab-label"}).appendTo(l);if(e.icon?$("<i>",{class:"red-ui-tab-icon",style:"mask-image: url("+e.icon+"); -webkit-mask-image: url("+e.icon+");"}).appendTo(g):e.iconClass&&$("<i>",{class:"red-ui-tab-icon "+e.iconClass}).appendTo(g),$("<span/>",{class:"red-ui-text-bidi-aware"}).text(e.label).appendTo(g).attr("dir",RED.text.bidi.resolveBaseTextDir(e.label)),n.collapsible){l.addClass("red-ui-tab-pinned");var m=$('<a href="#'+e.id+'" class="red-ui-tab-link-button"></a>');if(e.pinned?0===u?m.prependTo(x):m.insertAfter(x.find("a.red-ui-tab-link-button-pinned:last")):!1!==n.menu?m.insertBefore(x.find("a:last")):m.appendTo(x),m.attr("id",l.attr("id")+"-link-button"),e.iconClass?$("<i>",{class:e.iconClass}).appendTo(m):$("<i>",{class:t}).appendTo(m),m.on("click",(function(t){t.preventDefault(),O(e.id)})),m.data("tabId",e.id),e.pinned&&(m.addClass("red-ui-tab-link-button-pinned"),u++),RED.popover.tooltip($(m),e.name,e.action),n.onreorder){var b,y,w=[];m.draggable({distance:10,axis:"x",containment:".red-ui-tab-link-buttons",start:function(e,t){if(o=!0,$(".red-ui-tab-link-buttons").width($(".red-ui-tab-link-buttons").width()),i)return i=!1,!1;x.children().each((function(e){w[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width(),menu:$(this).hasClass("red-ui-tab-link-button-menu")},$(this).is(m)&&(b=e,y=e)})),x.children().each((function(e){e!==b&&$(this).css({position:"absolute",left:w[e].left+"px",width:w[e].width+2,transition:"left 0.3s"})})),m.hasClass("active")||m.css({zIndex:1})},drag:function(e,t){t.position.left+=w[b].left;for(var o=t.position.left+w[b].width/2,i=0;i<w.length;i++)if(i!==b&&!w[i].menu&&!w[i].el.is(":not(:visible)")&&o>w[i].left&&o<w[i].left+w[i].width){i<b?(w[i].left+=w[b].width+8,w[b].el.detach().insertBefore(w[i].el)):(w[i].left-=w[b].width+8,w[b].el.detach().insertAfter(w[i].el)),w[i].el.css({left:w[i].left+"px"}),w.splice(i,0,w.splice(b,1)[0]),b=i;break}},stop:function(e,t){if(o=!1,x.children().css({position:"relative",left:"",transition:""}),$(".red-ui-tab-link-buttons").width("auto"),m.css({zIndex:""}),I(),y!==b){r&&(r.remove(),r=null);var i=$.makeArray(x.children().map((function(){return $(this).data("tabId")})));z.order(i),n.onreorder(i)}}})}}(g.on("mousedown",(function(e){s=e.currentTarget})),g.on("mouseup",j),g.on("click",(function(e){e.preventDefault()})),g.on("dblclick",(function(e){e.stopPropagation(),e.preventDefault()})),$('<span class="red-ui-tabs-fade"></span>').appendTo(l),e.closeable)&&(l.addClass("red-ui-tabs-closeable"),(p=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(l)).append('<i class="fa fa-times" />'),p.on("click",(function(t){t.preventDefault(),N(e.id)})),RED.popover.tooltip(p,RED._("workspace.hideFlow")));e.hideable&&(l.addClass("red-ui-tabs-closeable"),(p=$("<a/>",{href:"#",class:"red-ui-tab-close red-ui-tab-hide"}).appendTo(l)).append('<i class="fa fa-eye" />'),p.append('<i class="fa fa-eye-slash" />'),p.on("click",(function(t){t.preventDefault(),M(e.id)})),RED.popover.tooltip(p,RED._("workspace.hideFlow")));var E=$('<span class="red-ui-tabs-badges"></span>').appendTo(l);if(n.onselect&&($('<i class="red-ui-tabs-badge-changed fa fa-circle"></i>').appendTo(E),$('<i class="red-ui-tabs-badge-selected fa fa-check-circle"></i>').appendTo(E)),RED.popover.tooltip(g,(function(){return RED.utils.sanitize(e.label)})),n.onadd&&n.onadd(e),1==h.find("li.red-ui-tab").length&&O(g),n.onreorder&&!n.collapsible){var D,R,_,k=[];l.draggable({axis:"x",distance:20,start:function(e,t){if(i)return i=!1,!1;o=!0,D=[],k=[],h.children().each((function(e){k[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(l)&&(R=e,_=e),D.push($(this).data("tabId"))})),h.children().each((function(e){e!==R&&$(this).css({position:"absolute",left:k[e].left+"px",width:k[e].width+2,transition:"left 0.3s"})})),l.hasClass("active")||l.css({zIndex:1})},drag:function(e,t){t.position.left+=k[R].left+v.scrollLeft();for(var o=t.position.left+k[R].width/2-v.scrollLeft(),i=0;i<k.length;i++)if(i!==R&&o>k[i].left&&o<k[i].left+k[i].width){i<R?(k[i].left+=k[R].width+8,k[R].el.detach().insertBefore(k[i].el)):(k[i].left-=k[R].width+8,k[R].el.detach().insertAfter(k[i].el)),k[i].el.css({left:k[i].left+"px"}),k.splice(i,0,k.splice(R,1)[0]),R=i;break}},stop:function(e,t){o=!1,h.children().css({position:"relative",left:"",transition:""}),l.hasClass("active")||l.css({zIndex:""}),I(),_!==R&&n.onreorder(D,$.makeArray(h.children().map((function(){return $(this).data("tabId")})))),O(k[R].el.data("tabId"))}})}setTimeout((function(){I()}),10),r&&(r.remove(),r=null),f&&z.order(f)},removeTab:N,activateTab:O,nextTab:function(){var e=A();e.length>0&&O(e.find("a"))},previousTab:function(){var e=P();e.length>0&&O(e.find("a"))},resize:I,count:function(){return h.find("li.red-ui-tab:not(.hide)").length},activeIndex:function(){return h.find("li.active").index()},contains:function(e){return h.find("a[href='#"+e+"']").length>0},showTab:function(e){if(c[e]){var t=h.find("a[href='#"+e+"']").parent();t.hasClass("hide-tab")&&(t.removeClass("hide-tab").removeClass("hide"),1===h.find("li.red-ui-tab:not(.hide-tab)").length&&O(t.find("a")),I(),n.onshow&&n.onshow(c[e]))}},hideTab:M,renameTab:function(e,t){c[e].label=t,h.find("a[href='#"+e+"']").find("span.red-ui-text-bidi-aware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),I()},listTabs:function(){return $.makeArray(h.children().map((function(){return $(this).data("tabId")})))},selection:T,clearSelection:function(){if(n.onselect){var e=h.find("li.red-ui-tab.selected");e.length>0&&(e.removeClass("selected"),C())}},order:function(e){f=e;var t,o=$.makeArray(h.children().map((function(){return $(this).data("tabId")}))),i=!0;for(t=0;t<e.length;t++)if(e[t]!==o[t]){i=!1;break}if(!i){var a={},r=(h.children().detach().each((function(){a[$(this).data("tabId")]=$(this)})),{});for(n.collapsible&&x.children().detach().each((function(){var e=$(this).data("tabId");e||(e="__menu__"),r[e]=$(this)})),t=0;t<e.length;t++)a[e[t]]&&(a[e[t]].appendTo(h),n.collapsible&&r[e[t]].appendTo(x),delete a[e[t]]);for(t in a)a.hasOwnProperty(t)&&(a[t].appendTo(h),n.collapsible&&r[t].appendTo(x));n.collapsible&&(r.__menu__.appendTo(x),I())}}};return z}}}(),RED.stack={create:function(e){var t=e.container;t.addClass("red-ui-stack");var o=0,i=[],n=!0,a=function(){if(i.length>0){var e=0;i.forEach((function(t){e+=t.header.outerHeight()}));var n=t.innerHeight();o=n-e-(i.length-1),i.forEach((function(e){e.contentWrap.height(o)}))}};return e.fill&&e.singleExpanded&&($(window).on("resize",a),$(window).on("focus",a)),{add:function(r){i.push(r),r.container=$('<div class="red-ui-palette-category">').appendTo(t),n||r.container.hide();var s=$('<div class="red-ui-palette-header"></div>').appendTo(r.container);if(r.header=s,r.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(r.container),e.fill&&r.contentWrap.css("height",o),r.content=$("<div></div>").appendTo(r.contentWrap),!1!==r.collapsible){s.on("click",(function(){if(e.singleExpanded)if(r.isExpanded())2===i.length&&(i[0]===r?(i[0].collapse(),i[1].expand()):(i[1].collapse(),i[0].expand()));else{for(var t=0;t<i.length;t++)i[t].isExpanded()&&i[t].collapse();r.expand()}else r.toggle()}));var d=$('<i class="fa fa-angle-down"></i>').appendTo(s);r.expanded?(r.container.addClass("expanded"),d.addClass("expanded")):r.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(s),s.css("cursor","default");return r.title=$("<span></span>").html(r.title).appendTo(s),r.toggle=function(){return r.isExpanded()?(r.collapse(),!1):(r.expand(),!0)},r.expand=function(){if(!r.isExpanded())return r.onexpand&&r.onexpand.call(r),e.singleExpanded&&i.forEach((function(e){e!==r&&e.collapse()})),d.addClass("expanded"),r.container.addClass("expanded"),r.contentWrap.slideDown(200),!0},r.collapse=function(){if(r.isExpanded())return d.removeClass("expanded"),r.container.removeClass("expanded"),r.contentWrap.slideUp(200),!0},r.isExpanded=function(){return r.container.hasClass("expanded")},e.fill&&e.singleExpanded&&a(),r},hide:function(){return n=!1,i.forEach((function(e){e.container.hide()})),this},show:function(){return n=!0,i.forEach((function(e){e.container.show()})),this},resize:function(){a&&a()}}}},function(e){var t=function(e,t){var o=RED.utils.parseContextKey(e,t&&t.value);return{option:o.store,value:o.key}},o=function(e,t){if(!t)return e;var o="string"==typeof t?t:t.value;return o!==RED.settings.context.default?"#:("+o+")::"+e:e},i=function(t,o){t.css("pointer-events","none"),t.css("flex-grow",0),t.css("position","relative"),t.css("overflow","visible"),e("<div></div>").text(o).css({position:"absolute",bottom:"-2px",right:"5px","font-size":"0.7em",opacity:.3}).appendTo(t),this.elementDiv.show()},n={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression,autoComplete:function(t){function o(e,t){const o=e.toLowerCase().indexOf(t.toLowerCase()),i=o>-1?t.length:0;return{index:o,found:o>-1,pre:e.substring(0,o),match:e.substring(o,o+i),post:e.substring(o+i)}}function i(t){const o=[];return t.pre&&o.push(e("<span/>").text(t.pre)),t.match&&o.push(e("<span/>",{style:"font-weight: bold; color: var(--red-ui-text-color-link);"}).text(t.match)),t.post&&o.push(e("<span/>").text(t.post)),o}return function(n){var a=[];return t.forEach((t=>{const r=t.value,s=(t.source||[]).join(","),d=o(r,n),l=o(s,n);if(d.found||l.found){const t=e("<div>",{style:"display: flex"}),o=e("<div/>",{style:"font-family: var(--red-ui-monospace-font); white-space:nowrap; overflow: hidden; flex-grow:1"});if(o.append(i(d)),o.appendTo(t),s){const o=e("<div>").css({"font-size":"0.8em"});o.append(i(l)),o.appendTo(t)}a.push({value:r,label:t,i:d.found?d.index:l.index})}})),a.sort((function(e,t){return e.i-t.i})),a}}([{value:"payload"},{value:"topic",source:["mqtt","inject","rbe"]},{value:"action",source:["mqtt"]},{value:"complete",source:["join"]},{value:"contentType",source:["mqtt"]},{value:"cookies",source:["http request","http response"]},{value:"correlationData",source:["mqtt"]},{value:"delay",source:["delay","trigger"]},{value:"encoding",source:["file"]},{value:"error",source:["catch"]},{value:"error.message",source:["catch"]},{value:"error.source",source:["catch"]},{value:"error.source.id",source:["catch"]},{value:"error.source.type",source:["catch"]},{value:"error.source.name",source:["catch"]},{value:"filename",source:["file","file in"]},{value:"flush",source:["delay"]},{value:"followRedirects",source:["http request"]},{value:"headers",source:["http response","http request"]},{value:"host",source:["tcp request","http request"]},{value:"ip",source:["udp out"]},{value:"kill",source:["exec"]},{value:"messageExpiryInterval",source:["mqtt"]},{value:"method",source:["http request"]},{value:"options",source:["xml"]},{value:"parts",source:["split","join","batch","sort"]},{value:"pid",source:["exec"]},{value:"port",source:["tcp request"," udp out"]},{value:"qos",source:["mqtt"]},{value:"rate",source:["delay"]},{value:"rejectUnauthorized",source:["http request"]},{value:"req",source:["http in"]},{value:"req.body",source:["http in"]},{value:"req.headers",source:["http in"]},{value:"req.query",source:["http in"]},{value:"req.params",source:["http in"]},{value:"req.cookies",source:["http in"]},{value:"req.files",source:["http in"]},{value:"requestTimeout",source:["http request"]},{value:"reset",source:["delay","trigger","join","rbe"]},{value:"responseCookies",source:["http request"]},{value:"responseTopic",source:["mqtt"]},{value:"responseURL",source:["http request"]},{value:"restartTimeout",source:["join"]},{value:"retain",source:["mqtt"]},{value:"schema",source:["json"]},{value:"select",source:["html"]},{value:"statusCode",source:["http response","http request"]},{value:"status",source:["status"]},{value:"status.text",source:["status"]},{value:"status.source",source:["status"]},{value:"status.source.type",source:["status"]},{value:"status.source.id",source:["status"]},{value:"status.source.name",source:["status"]},{value:"target",source:["link call"]},{value:"template",source:["template"]},{value:"toFront",source:["delay"]},{value:"url",source:["http request"]},{value:"userProperties",source:["mqtt"]},{value:"_session",source:["websocket out","tcp out"]}])},flow:{value:"flow",label:"flow.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:t,export:o,valueLabel:i},global:{value:"global",label:"global.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:t,export:o,valueLabel:i},str:{value:"str",label:"string",icon:"red/images/typedInput/az.svg"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.svg",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.svg",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.svg",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var e=this,t=this.value();try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}RED.editor.editJSON({value:t,stateId:RED.editor.generateViewStateId("typedInput",e,"json"),focus:!0,complete:function(t){var o=t;try{o=JSON.stringify(JSON.parse(t))}catch(e){}e.value(o)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.svg"},date:{value:"date",label:"timestamp",icon:"fa fa-clock-o",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.svg",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var e=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),stateId:RED.editor.generateViewStateId("typedInput",e,"jsonata"),focus:!0,complete:function(t){e.value(t.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.svg",expand:function(){var e=this;RED.editor.editBuffer({value:this.value(),stateId:RED.editor.generateViewStateId("typedInput",e,"bin"),focus:!0,complete:function(t){e.value(t)}})}},env:{value:"env",label:"env variable",icon:"red/images/typedInput/env.svg"},node:{value:"node",label:"node",icon:"red/images/typedInput/target.svg",valueLabel:function(t,o){var i=RED.nodes.node(o),n=e("<div>",{class:"red-ui-search-result-node"}).css({"margin-top":"2px","margin-left":"3px"}).appendTo(t),a=e("<span>").css({"line-height":"32px","margin-left":"6px"}).appendTo(t);if(i){var r=RED.utils.getNodeColor(i.type,i._def),s=RED.utils.getNodeIcon(i._def,i);"tab"===i.type&&(r="#C0DEED"),n.css("backgroundColor",r);var d=e("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(n);RED.utils.createIconElement(s,d,!0);var l=RED.utils.getNodeLabel(i,i.id);a.text(l)}else n.css({backgroundColor:"#eee","border-style":"dashed"})},expand:function(){var e=this;RED.tray.hide(),RED.view.selectNodes({single:!0,selected:[e.value()],onselect:function(t){e.value(t.id),RED.tray.show()},oncancel:function(){RED.tray.show()}})}},cred:{value:"cred",label:"credential",icon:"fa fa-lock",inputType:"password",valueLabel:function(t,o){var i=this;t.css("pointer-events","none"),t.css("flex-grow",0),this.elementDiv.hide();var n=e("<div>").css({position:"absolute",right:"6px",top:"6px","pointer-events":"all"}).appendTo(t),a=e('<button type="button" class="red-ui-button red-ui-button-small"></button>').css({width:"20px"}).appendTo(n).on("click",(function(e){e.preventDefault();var t=i.input[0].selectionStart;"text"===i.input.attr("type")?(i.input.attr("type","password"),r.removeClass("fa-eye-slash").addClass("fa-eye"),setTimeout((function(){i.input.focus(),i.input[0].setSelectionRange(t,t)}),50)):(i.input.attr("type","text"),r.removeClass("fa-eye").addClass("fa-eye-slash"),setTimeout((function(){i.input.focus(),i.input[0].setSelectionRange(t,t)}),50))})).hide(),r=e('<i class="fa fa-eye"></i>').css("margin-left","-2px").appendTo(a);if("__PWRD__"===o)var s=e('<div><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i></div>').css({padding:"6px 6px",borderRadius:"4px"}).addClass("red-ui-typedInput-value-label-inactive").appendTo(t),d=e('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-pencil"></i></button>').appendTo(n).on("click",(function(e){e.preventDefault(),s.hide(),t.css("background","none"),t.css("pointer-events","none"),i.input.val(""),i.element.val(""),i.elementDiv.show(),d.hide(),l.show(),a.show(),setTimeout((function(){i.input.focus()}),50)})),l=e('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-times"></i></button>').css("margin-left","3px").appendTo(n).on("click",(function(e){e.preventDefault(),s.show(),t.css("background",""),i.input.val("__PWRD__"),i.element.val("__PWRD__"),i.elementDiv.hide(),d.show(),l.hide(),a.hide(),i.input.attr("type","password"),r.removeClass("fa-eye-slash").addClass("fa-eye")})).hide();else t.css("background","none"),t.css("pointer-events","none"),this.elementDiv.show(),a.show()}}};function a(t,o){if(t.multiple){var i={},n=[];o.split(",").forEach((function(e){e&&(i[e]=!0)}));for(r=0;r<t.options.length;r++){op=t.options[r];var a="string"==typeof op?op:op.value;i.hasOwnProperty(a)&&(delete i[a],n.push("string"==typeof op?{value:op}:op.value))}return e.isEmptyObject(i)?n:null}for(var r=0;r<t.options.length;r++){if(op=t.options[r],"string"==typeof op&&op===o)return{value:o};if(op.value===o)return op}}var r=!1;e.widget("nodered.typedInput",{_create:function(){try{if(!r&&RED&&RED._){for(var t in n)n.hasOwnProperty(t)&&(n[t].label=RED._("typedInput.type."+t,{defaultValue:n[t].label}));var o=RED.settings.context.stores.map((function(e){return{value:e,label:e,icon:'<i class="red-ui-typedInput-icon fa fa-database"></i>'}})).sort((function(e,t){return e.value===RED.settings.context.default?-1:t.value===RED.settings.context.default?1:e.value.localeCompare(t.value)}));o.length<2?(n.flow.options=[],n.global.options=[]):(n.flow.options=o,n.global.options=o)}r=!0;var i=this;this.identifier=this.element.attr("id")||"TypedInput-"+Math.floor(100*Math.random()),this.options.debug&&console.log(this.identifier,"Create",{defaultType:this.options.default,value:this.element.val()}),this.disarmClick=!1,this.input=e('<input class="red-ui-typedInput-input" type="text"></input>'),this.input.insertAfter(this.element),this.input.val(this.element.val()),this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.input.wrap("<div>").parent().addClass("red-ui-typedInput-input-wrap"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var a,s=this.element.attr("style");if(null!==(a=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(s))?(this.input.css("width","100%"),this.uiSelect.width(a[1]),this.uiWidth=null):0!==this.uiWidth&&this.uiSelect.width(this.uiWidth),["Right","Left"].forEach((function(e){var t=i.element.css("margin"+e);i.uiSelect.css("margin"+e,t),i.input.css("margin"+e,0)})),["type","placeholder","autocomplete","data-i18n"].forEach((function(e){var t=i.element.attr(e);i.input.attr(e,t)})),this.defaultInputType=this.input.attr("type"),this.oldValues={},this.uiSelect.addClass("red-ui-typedInput-container"),this.element.attr("type","hidden"),!this.options.types&&this.options.type?this.options.types=[this.options.type]:this.options.types=this.options.types||Object.keys(n),this.selectTrigger=e('<button type="button" class="red-ui-typedInput-type-select" tabindex="0"></button>').prependTo(this.uiSelect),e('<i class="red-ui-typedInput-icon fa fa-caret-down"></i>').toggle(this.options.types.length>1).appendTo(this.selectTrigger),this.selectLabel=e('<span class="red-ui-typedInput-type-label"></span>').appendTo(this.selectTrigger),this.valueLabelContainer=e('<div class="red-ui-typedInput-value-label">').appendTo(this.uiSelect),this.types(this.options.types),this.options.typeField){this.typeField=e(this.options.typeField).hide();var d=this.typeField.val();d&&this.typeMap[d]&&(this.options.default=d)}else this.typeField=e("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.input.on("focus",(function(){i.uiSelect.addClass("red-ui-typedInput-focus")})),this.input.on("blur",(function(){i.uiSelect.removeClass("red-ui-typedInput-focus")})),this.input.on("change",(function(){i.validate(),i.element.val(i.value()),i.element.trigger("change",[i.propertyType,i.value()])})),this.input.on("keyup",(function(e){i.validate(),i.element.val(i.value()),i.element.trigger("keyup",e)})),this.input.on("paste",(function(e){i.validate(),i.element.val(i.value()),i.element.trigger("paste",e)})),this.input.on("keydown",(function(e){i.typeMap[i.propertyType].autoComplete||e.keyCode>=37&&e.keyCode<=40&&e.stopPropagation()})),this.selectTrigger.on("click",(function(e){e.preventDefault(),e.stopPropagation(),i._showTypeMenu()})),this.selectTrigger.on("keydown",(function(e){40===e.keyCode&&i._showTypeMenu(),e.stopPropagation()})).on("focus",(function(){i.uiSelect.addClass("red-ui-typedInput-focus")})).on("blur",(function(){!1===i.typeMap[i.propertyType].hasValue&&i.uiSelect.removeClass("red-ui-typedInput-focus")})),this.optionSelectTrigger=e('<button type="button" tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-caret-down"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=e('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),this.optionSelectTrigger.on("click",(function(e){e.preventDefault(),e.stopPropagation(),i._showOptionSelectMenu()})).on("keydown",(function(e){40===e.keyCode&&i._showOptionSelectMenu(),e.stopPropagation()})).on("blur",(function(){i.uiSelect.removeClass("red-ui-typedInput-focus")})).on("focus",(function(){i.uiSelect.addClass("red-ui-typedInput-focus")})),this.optionExpandButton=e('<button type="button" tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"></button>').appendTo(this.uiSelect),this.optionExpandButtonIcon=e('<i class="red-ui-typedInput-icon fa fa-ellipsis-h"></i>').appendTo(this.optionExpandButton),this.type(this.typeField.val()||this.options.default||this.typeList[0].value),this.typeChanged=!!this.options.default}catch(e){console.log(e.stack)}},_showTypeMenu:function(){if(this.typeList.length>1){this._showMenu(this.menu,this.selectTrigger);var e=this.menu.find("[value='"+this.propertyType+"']");setTimeout((function(){e.trigger("focus")}),120)}else this.input.trigger("focus")},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectTrigger);var e=this.optionValue;null!==this.optionValue&&void 0!==this.optionValue||(e=this.value());var t=this.optionMenu.find("[value='"+e+"']");0===t.length&&(t=this.optionMenu.children(":first")),t.trigger("focus")}},_hideMenu:function(t){if(e(document).off("mousedown.red-ui-typedInput-close-property-select"),t.hide(),t.css({height:"auto"}),t.opts.multiple){var o=[];t.find('input[type="checkbox"]').each((function(){e(this).prop("checked")&&o.push(e(this).data("value"))})),t.callback(o)}this.elementDiv.is(":visible")?this.input.trigger("focus"):this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.trigger("focus"):this.selectTrigger.trigger("focus")},_createMenu:function(t,o,i){var n=this,a=e("<div>").addClass("red-ui-typedInput-options red-ui-editor-dialog");return a.opts=o,a.callback=i,t.forEach((function(t){"string"==typeof t&&(t={value:t,label:t});var r,s=e('<a href="#"></a>').attr("value",t.value).appendTo(a);t.label&&s.text(t.label),t.title&&s.prop("title",t.title),t.icon?0===t.icon.indexOf("<")?e(t.icon).prependTo(s):-1!==t.icon.indexOf("/")?e("<i>",{class:"red-ui-typedInput-icon",style:"mask-image: url("+t.icon+"); -webkit-mask-image: url("+t.icon+");"}).prependTo(s):e("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(s):s.css({paddingLeft:"18px"}),t.icon||t.label||s.text(t.value),o.multiple&&(r=e('<input type="checkbox">').css("pointer-events","none").data("value",t.value).prependTo(s).on("mousedown",(function(e){e.preventDefault()}))),s.on("click",(function(e){e.preventDefault(),e.stopPropagation(),o.multiple?r.prop("checked",!r.prop("checked")):(i(t.value),n._hideMenu(a))}))})),a.css({display:"none"}),a.appendTo(document.body),a.on("keydown",(function(t){40===t.keyCode?(t.preventDefault(),e(this).children(":focus").next().trigger("focus")):38===t.keyCode?(t.preventDefault(),e(this).children(":focus").prev().trigger("focus")):27===t.keyCode&&(t.preventDefault(),n._hideMenu(a)),t.stopPropagation()})),a},_showMenu:function(t,o){if(this.disarmClick)this.disarmClick=!1;else{if(t.opts.multiple){var i={};this.value().split(",").forEach((function(e){i[e]=!0})),t.find('input[type="checkbox"]').each((function(){e(this).prop("checked",i[e(this).data("value")])}))}var n=this,a=o.offset(),r=o.height(),s=t.height(),d=r+a.top;d+s-e(document).scrollTop()>e(window).height()&&(d-=d+s-e(window).height()+5),d<0&&(t.height(s+d),d=0),t.css({top:d+"px",left:a.left+"px"}),t.slideDown(100),this._delay((function(){n.uiSelect.addClass("red-ui-typedInput-focus"),e(document).on("mousedown.red-ui-typedInput-close-property-select",(function(i){e(i.target).closest(t).length||n._hideMenu(t),e(i.target).closest(o).length&&(n.disarmClick=!0,i.preventDefault())}))}))}},_getLabelWidth:function(t,o){var i=t.outerWidth();if(0===i){var n=e('<div class="red-ui-editor"></div>').css({position:"absolute","white-space":"nowrap",top:-2e3}).appendTo(document.body),a=e('<div class="red-ui-typedInput-container"></div>').appendTo(n),r=t.clone().appendTo(a);setTimeout((function(){i=r.outerWidth(),n.remove(),o(i)}),50)}else o(i)},_updateOptionSelectLabel:function(t){var o,i=this.typeMap[this.propertyType];this.optionSelectLabel.empty(),i.hasValue?(this.valueLabelContainer.empty(),this.valueLabelContainer.show()):this.valueLabelContainer.hide(),this.typeMap[this.propertyType].valueLabel&&(i.multiple?this.typeMap[this.propertyType].valueLabel.call(this,i.hasValue?this.valueLabelContainer:this.optionSelectLabel,t):this.typeMap[this.propertyType].valueLabel.call(this,i.hasValue?this.valueLabelContainer:this.optionSelectLabel,t.value)),this.typeMap[this.propertyType].valueLabel&&!i.hasValue||(i.multiple?this.optionSelectLabel.text(t.length+" selected"):(t.icon?0===t.icon.indexOf("<")?e(t.icon).prependTo(this.optionSelectLabel):-1!==t.icon.indexOf("/")?e("<img>",{src:(o=t.icon,/^red\/images\/typedInput\/.+\.png$/.test(o)&&(o=o.replace(/.png$/,".svg")),o),style:"height: 18px;"}).prependTo(this.optionSelectLabel):e("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(this.optionSelectLabel):t.label?this.optionSelectLabel.text(t.label):this.optionSelectLabel.text(t.value),i.hasValue&&(this.optionValue=t.value,this.input.trigger("change",[this.propertyType,this.value()]))))},_destroy:function(){this.optionMenu&&this.optionMenu.remove(),this.menu.remove(),this.uiSelect.remove()},types:function(e){var t=this,o=this.type();this.typeMap={};var i=void 0===this.typeList;this.typeList=e.map((function(e){var o;return o="string"==typeof e?n[e]:e,t.typeMap[o.value]=o,o})),this.typeList.length<2?(this.selectTrigger.attr("tabindex",-1),this.selectTrigger.on("mousedown.red-ui-typedInput-focus-block",(function(e){e.preventDefault()}))):(this.selectTrigger.attr("tabindex",0),this.selectTrigger.off("mousedown.red-ui-typedInput-focus-block")),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.selectTrigger.find(".fa-caret-down").toggle(this.typeList.length>1),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,{},(function(e){t.type(e)})),o&&!this.typeMap.hasOwnProperty(o)?i||this.type(this.typeList[0].value):(this.propertyType=null,i||this.type(o)),1!==this.typeList.length||this.typeList[0].icon||this.typeList[0].label&&!1!==this.typeList[0].showLabel?this.selectTrigger.show():this.selectTrigger.hide()},width:function(e){this.uiWidth=e,null!==this.uiWidth&&this.uiSelect.width(this.uiWidth)},value:function(e){var t=this,o=this.typeMap[this.propertyType]||{};if(!arguments.length){var i=this.input.val();return o.export&&(i=o.export(i,this.optionValue)),i}this.options.debug&&console.log(this.identifier,"----- SET VALUE ------",e);var n=[],a=e;if(o.options){if(o.hasValue&&o.parse){var r=o.parse(e);this.options.debug&&console.log(this.identifier,"new parse",r),e=r.value,a=r.option||r.value}var s=[a];o.multiple&&(n=[],s=a.split(",")),s.forEach((function(e){for(var i=0;i<o.options.length;i++){var a=o.options[i];if("string"==typeof a){if(a===e||a===""+e){n.push(t.activeOptions[a]);break}}else if(a.value===e){n.push(a);break}}})),this.options.debug&&console.log(this.identifier,"set value to",e),this.input.val(e),o.multiple?this._updateOptionSelectLabel(n):(0===n.length&&(n=[{value:""}]),this._updateOptionSelectLabel(n[0]))}else this.input.val(e),o.valueLabel&&(this.valueLabelContainer.empty(),o.valueLabel.call(this,this.valueLabelContainer,e));this.input.trigger("change",[this.type(),e])},type:function(t){if(!arguments.length)return this.propertyType;var o=this;this.options.debug&&console.log(this.identifier,"----- SET TYPE -----",t);var i=null,n=this.typeMap[t];if(n&&this.propertyType!==t){var r=this.typeMap[this.propertyType];if(i=this.input.val(),r&&this.typeChanged){if(this.options.debug&&console.log(this.identifier,"typeChanged",{previousType:r,previousValue:i}),r.options&&!0!==n.hasValue||!1===r.hasValue?this.oldValues[r.value]=i:this.oldValues._=i,n.options&&!0!==n.hasValue||!1===n.hasValue)if(this.oldValues.hasOwnProperty(n.value))this.options.debug&&console.log(this.identifier,"restored previous (1)",this.oldValues[n.value]),this.input.val(this.oldValues[n.value]);else if(n.options){var s=a(n,i);this.options.debug&&console.log(this.identifier,{previousValue:i,opt:n,validOptions:s}),(i||""===i)&&s?(this.options.debug&&console.log(this.identifier,"restored previous (2)"),this.input.val(i)):"string"==typeof n.default?(this.options.debug&&console.log(this.identifier,"restored previous (3)",n.default),this.input.val(n.default)):Array.isArray(n.default)?(this.options.debug&&console.log(this.identifier,"restored previous (4)",n.default.join(",")),this.input.val(n.default.join(","))):(this.options.debug&&console.log(this.identifier,"restored previous (5)"),this.input.val(""))}else this.options.debug&&console.log(this.identifier,"restored default/blank",n.default||""),this.input.val(n.default||"");else this.options.debug&&console.log(this.identifier,"restored old/default/blank"),this.input.val(this.oldValues.hasOwnProperty("_")?this.oldValues._:n.default||"");r.autoComplete&&this.input.autoComplete("destroy")}if(this.propertyType=t,this.typeChanged=!0,this.typeField&&this.typeField.val(t),this.selectLabel.empty(),n.icon&&!1!==n.showLabel&&(0===n.icon.indexOf("<")?e(n.icon).prependTo(this.selectLabel):-1!==n.icon.indexOf("/")?e("<i>",{class:"red-ui-typedInput-icon",style:"mask-image: url("+n.icon+"); -webkit-mask-image: url("+n.icon+"); margin-right: 4px;height: 18px;width:13px"}).prependTo(this.selectLabel):e("<i>",{class:"red-ui-typedInput-icon "+n.icon,style:"min-width: 13px; margin-right: 4px;"}).prependTo(this.selectLabel)),(!1===n.hasValue||!1!==n.showLabel&&!n.icon)&&this.selectLabel.text(n.label),n.label?this.selectTrigger.attr("title",n.label):this.selectTrigger.attr("title",""),!1===n.hasValue?this.selectTrigger.addClass("red-ui-typedInput-full-width"):this.selectTrigger.removeClass("red-ui-typedInput-full-width"),this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),n.options){if(this.optionExpandButton&&(this.optionExpandButton.hide(),this.optionExpandButton.shown=!1),this.optionSelectTrigger){var d;if(this.optionSelectTrigger.css({display:"inline-flex"}),n.hasValue?(this.optionSelectTrigger.css({"flex-grow":0}),this.elementDiv.show(),this.valueLabelContainer.hide()):(this.optionSelectTrigger.css({"flex-grow":1}),this.elementDiv.hide(),this.valueLabelContainer.hide()),this.activeOptions={},n.options.forEach((function(e){"string"==typeof e?o.activeOptions[e]={label:e,value:e}:o.activeOptions[e.value]=e})),o.activeOptions.hasOwnProperty(o.optionValue)||(o.optionValue=null),n.hasValue){var l=this.optionValue||n.options[0];if(n.parse){var c="string"==typeof l?{value:l}:l,u=n.parse(this.input.val(),c);u.option&&(l=u.option,this.activeOptions.hasOwnProperty(l)||(u.option=Object.keys(this.activeOptions)[0],l=u.option)),this.input.val(u.value),n.export&&this.element.val(n.export(u.value,u.option||l))}"string"==typeof l?(this.optionValue=l,this.activeOptions.hasOwnProperty(l)||(l=Object.keys(this.activeOptions)[0]),l?this._updateOptionSelectLabel(this.activeOptions[l]):this.optionSelectTrigger.hide()):l?(this.options.debug&&console.log(this.identifier,"HERE",{optionValue:l.value}),this.optionValue=l.value,this._updateOptionSelectLabel(l)):this.optionSelectTrigger.hide()}else{var p=a(n,this.input.val());n.multiple?(p||(p=(n.default||[]).map((function(e){return"string"==typeof e?e:e.value})),this.value(p.join(","))),o._updateOptionSelectLabel(p)):p?o._updateOptionSelectLabel(p):"string"==typeof(d=n.options[0])?(this.value(d),o._updateOptionSelectLabel({value:d})):(this.value(d.value),o._updateOptionSelectLabel(d))}this.optionMenu=this._createMenu(n.options,n,(function(e){n.multiple?(o._updateOptionSelectLabel(e),n.hasValue||o.value(e.join(","))):(o._updateOptionSelectLabel(o.activeOptions[e]),n.hasValue||o.value(o.activeOptions[e].value))}))}this._trigger("typechange",null,this.propertyType),this.input.trigger("change",[this.propertyType,this.value()])}else this.optionSelectTrigger&&this.optionSelectTrigger.hide(),n.inputType?this.input.attr("type",n.inputType):this.input.attr("type",this.defaultInputType),!1===n.hasValue?(this.elementDiv.hide(),this.valueLabelContainer.hide()):n.valueLabel?(this.valueLabelContainer.css("pointer-events",""),this.valueLabelContainer.css("flex-grow",1),this.valueLabelContainer.css("overflow","hidden"),this.valueLabelContainer.show(),this.valueLabelContainer.empty(),this.elementDiv.hide(),n.valueLabel.call(this,this.valueLabelContainer,this.input.val())):(this.valueLabelContainer.hide(),this.elementDiv.show(),n.autoComplete&&this.input.autoComplete({search:n.autoComplete,minLength:0})),this.optionExpandButton&&(n.expand?(n.expand.icon?this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa "+n.expand.icon):this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa fa-ellipsis-h"),this.optionExpandButton.shown=!0,this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",(function(t){if(t.preventDefault(),"function"==typeof n.expand)n.expand.call(o);else{var i=e("<div>"),a=n.expand.content.call(o,i),r=RED.popover.panel(i);r.container.css({width:o.valueLabelContainer.width()}),n.expand.minWidth&&r.container.css({minWidth:n.expand.minWidth+"px"}),r.show({target:o.optionExpandButton,onclose:a.onclose,align:"left"})}}))):(this.optionExpandButton.shown=!1,this.optionExpandButton.hide())),this._trigger("typechange",null,this.propertyType),this.input.trigger("change",[this.propertyType,this.value()])}},validate:function(){var e,t=this.value(),o=this.type();if(this.typeMap[o]&&this.typeMap[o].validate){var i=this.typeMap[o].validate;e="function"==typeof i?i(t):i.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show()},hide:function(){this.uiSelect.hide()},disable:function(e){void 0===e||e?this.uiSelect.attr("disabled","disabled"):this.uiSelect.attr("disabled",null)},enable:function(){this.uiSelect.attr("disabled",null)},disabled:function(){return"disabled"===this.uiSelect.attr("disabled")},focus:function(){this.input.focus()}})}(jQuery),function(e){e.widget("nodered.toggleButton",{_create:function(){var t=this,o=!1;this.options.hasOwnProperty("invertState")&&(o=this.options.invertState);var i=this.options.baseClass||"red-ui-button",n=this.options.hasOwnProperty("enabledIcon")?this.options.enabledIcon:"fa-check-square-o",a=this.options.hasOwnProperty("disabledIcon")?this.options.disabledIcon:"fa-square-o",r=this.options.hasOwnProperty("enabledLabel")?this.options.enabledLabel:RED._("editor:workspace.enabled"),s=this.options.hasOwnProperty("disabledLabel")?this.options.disabledLabel:RED._("editor:workspace.disabled");this.element.css("display","none"),this.element.on("focus",(function(){t.button.focus()})),this.button=e('<button type="button" class="red-ui-toggleButton '+i+' toggle single"></button>'),(r||s)&&(this.buttonLabel=e("<span>").appendTo(this.button).css("margin-left","5px")),this.options.class&&this.button.addClass(this.options.class),this.element.after(this.button),n&&a&&(this.buttonIcon=e('<i class="fa"></i>').prependTo(this.button)),this.button.addClass("selected"),this.buttonIcon&&this.buttonIcon.addClass(n),this.buttonLabel&&this.buttonLabel.text(r);var d=this.button.width();this.button.removeClass("selected"),this.buttonIcon&&(this.buttonIcon.removeClass(n),t.buttonIcon.addClass(a)),this.buttonLabel&&t.buttonLabel.text(s),d=Math.max(d,this.button.width()),this.buttonIcon&&this.buttonIcon.removeClass(a),d>0&&this.button.width(Math.ceil(d)),this.button.on("click",(function(e){e.stopPropagation(),t.state?t.element.prop("checked",o):t.element.prop("checked",!o),t.element.trigger("change")})),this.element.on("change",(function(i){e(this).prop("checked")!==o?(t.button.addClass("selected"),t.state=!0,t.buttonIcon&&(t.buttonIcon.addClass(n),t.buttonIcon.removeClass(a)),t.buttonLabel&&t.buttonLabel.text(r)):(t.button.removeClass("selected"),t.state=!1,t.buttonIcon&&(t.buttonIcon.addClass(a),t.buttonIcon.removeClass(n)),t.buttonLabel&&t.buttonLabel.text(s))})),this.element.trigger("change")}})}(jQuery),jQuery.widget("nodered.autoComplete",{_create:function(){const e=this;this.completionMenuShown=!1,this.options.minLength=function(e,t,o,i){if(null==e)return t||0;o=null==o?Number.NEGATIVE_INFINITY:o,i=null==i?Number.POSITIVE_INFINITY:i;let n=parseInt(e);return(isNaN(n)||n<o||n>i)&&(n=t||0),n}(this.options.minLength,1,0),this.options.search=this.options.search||function(){return[]},this.element.addClass("red-ui-autoComplete"),this.element.on("keydown.red-ui-autoComplete",(function(t){if((13===t.keyCode||9===t.keyCode)&&e.completionMenuShown){var o=e.menu.options();e.element.val(o[0].value),e.menu.hide(),t.preventDefault()}})),this.element.on("keyup.red-ui-autoComplete",(function(t){13!==t.keyCode&&9!==t.keyCode&&27!==t.keyCode&&(8!==t.keyCode&&46!==t.keyCode||e.completionMenuShown)&&e._updateCompletions(this.value)}))},_showCompletionMenu:function(e){this.completionMenuShown||(this.menu=RED.popover.menu({tabSelect:!0,width:300,maxHeight:200,class:"red-ui-autoComplete-container",options:e,onselect:e=>{this.element.val(e.value),this.element.focus(),this.element.trigger("change")},onclose:()=>{this.completionMenuShown=!1,delete this.menu,this.element.focus()}}),this.menu.show({target:this.element}),this.completionMenuShown=!0)},_updateCompletions:function(e){const t=this;if(e.trim().length<this.options.minLength)this.completionMenuShown&&this.menu.hide();else if(2===this.options.search.length){const t=1+Math.floor(1e4*Math.random());this.pendingRequest=t,this.options.search(e,(function(e){o(e,t)}))}else o(this.options.search(e));function o(e,o){o&&o!==t.pendingRequest||(e&&0!==e.length?t.completionMenuShown?t.menu.options(e):t._showCompletionMenu(e):t.completionMenuShown&&t.menu.hide())}},_destroy:function(){this.element.removeClass("red-ui-autoComplete"),this.element.off("keydown.red-ui-autoComplete"),this.element.off("keyup.red-ui-autoComplete"),this.completionMenuShown&&this.menu.hide()}}),RED.actions=function(){var e={};function t(t){let o=e[t];if(!o)return"";if(!o.label){var i=o.options,n=i?i.label:void 0;n||(n="action-list."+t.replace(/^.*:/,""));var a=RED._(n);a===n&&(a=t.replace(/(^.+:([a-z]))|(-([a-z]))/g,(function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}))),o.label=a}return o.label}return{add:function(t,o,i){if("function"!=typeof o)throw new Error("Action handler not a function");if(e[t])throw new Error("Cannot override existing action");e[t]={handler:o,options:i}},remove:function(t){delete e[t]},get:function(t){return e[t].handler},getLabel:t,invoke:function(){var t=Array.prototype.slice.call(arguments),o=t.shift();if(e.hasOwnProperty(o)){var i=e[o].handler;i.apply(null,t)}},list:function(){var o=[];return Object.keys(e).forEach((function(i){var n=e[i],a=RED.keyboard.getShortcut(i),r=!1;r=a?a.user:!!RED.keyboard.getUserShortcut(i),n.label||(n.label=t(i)),o.push({id:i,scope:a?a.scope:void 0,key:a?a.key:void 0,user:r,label:n.label,options:n.options})})),o}}}(),RED.deploy=function(){var e={full:{img:"red/images/deploy-full-o.svg"},nodes:{img:"red/images/deploy-nodes-o.svg"},flows:{img:"red/images/deploy-flows-o.svg"}},t=!1,o=!1,i="full",n=!1,a=null;function r(t){i=t,$("#red-ui-header-button-deploy-icon").attr("src",e[t].img)}function s(e){var t="";if(e.z){var o=RED.nodes.workspace(e.z);t=o?o.label:(o=RED.nodes.subflow(e.z)).name}var i=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:i}}function d(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function l(e,t){var o=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(o);var i=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(o),n=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(o),r=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(o);o.i18n(),a=null;var s=[{text:RED._("common.label.cancel"),click:function(){d.close()}},{id:"red-ui-deploy-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),d.close())}},{id:"red-ui-deploy-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(a),d.close())}}];t&&s.push({id:"red-ui-deploy-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){b(!0,t),d.close()}});var d=RED.notify(o,{modal:!0,fixed:!0,width:600,buttons:s}),l=Date.now();RED.diff.getRemoteDiff((function(e){var t=Math.max(1e3-(Date.now()-l),0);a=e,setTimeout((function(){i.hide(),0===Object.keys(e.conflicts).length?(n.show(),$("#red-ui-deploy-dialog-confirm-deploy-merge").removeClass("disabled")):r.show(),$("#red-ui-deploy-dialog-confirm-deploy-review").removeClass("disabled")}),t)}))}function c(e){if(e.length>5){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function u(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function p(){$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show()}function f(){$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide()}function h(){$(".red-ui-deploy-button-content").css("opacity",0),$(".red-ui-deploy-button-spinner").show(),$("#red-ui-header-button-deploy").addClass("disabled")}function g(){$(".red-ui-deploy-button-content").css("opacity",1),$(".red-ui-deploy-button-spinner").hide()}function v(e){const t=Date.now(),o=!$("#red-ui-header-button-deploy").hasClass("disabled");n=!0,h(),p(),$.ajax({url:"flows/state",type:"POST",data:{state:e}}).done((function(e,t,i){o&&$("#red-ui-header-button-deploy").removeClass("disabled")})).fail((function(e,t,i){if(o&&$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status)RED.notify(RED._("notification.error",{message:RED._("user.notAuthorized")}),"error");else if(e.responseText){const t={message:i?i+"":""};try{t.message=JSON.parse(e.responseText).message}finally{t.message=t.message||e.responseText}RED.notify(RED._("notification.error",t),"error")}else RED.notify(RED._("notification.error",{message:RED._("deploy.errors.noResponse")}),"error")})).always((function(){const e=Math.max(0,300-(Date.now()-t));setTimeout((function(){g(),f(),n=!1}),e)}))}function m(){var e=Date.now(),t=!$("#red-ui-header-button-deploy").hasClass("disabled");n=!0,h(),$.ajax({url:"flows",type:"POST",headers:{"Node-RED-Deployment-Type":"reload"}}).done((function(e,o,i){t&&$("#red-ui-header-button-deploy").removeClass("disabled"),RED.notify("<p>"+RED._("deploy.successfulRestart")+"</p>","success")})).fail((function(e,o,i){t&&$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?l(nns,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")})).always((function(){var t=Math.max(0,300-(Date.now()-e));setTimeout((function(){g(),n=!1}),t)}))}function b(e,a){if($("#red-ui-header-button-deploy").hasClass("disabled"))return;if($("#red-ui-header-shade").is(":visible"))return;if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");let r=!1;if(!e){let e=!1,i=!1;const n=[],a=[];RED.nodes.eachConfig((function(e){void 0===e.valid&&RED.editor.validateNode(e),e.valid||e.d||a.push(s(e)),"unknown"===e.type&&-1==n.indexOf(e.name)&&n.push(e.name)})),RED.nodes.eachNode((function(e){e.valid||e.d||a.push(s(e)),"unknown"===e.type&&-1==n.indexOf(e.name)&&n.push(e.name)})),e=n.length>0,i=a.length>0;const l=[];RED.nodes.eachConfig((function(e){!1!==e._def.hasUsers&&0===e.users.length&&(l.push(s(e)),r=!0)}));let p,f,h=!1,g=[];if(e&&!t?(h=!0,p="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+c(n).map((function(e){return u(e)})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",g=[{text:RED._("deploy.unknownNodesButton"),class:"pull-left",click:function(){f.close(),RED.actions.invoke("core:search","type:unknown ")}},{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){b(!0),f.close()}}]):i&&!o&&(h=!0,a.sort(d),p="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+c(a.map((function(e){return u((e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")")}))).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",g=[{text:RED._("deploy.invalidNodesButton"),class:"pull-left",click:function(){f.close(),RED.actions.invoke("core:search","is:invalid ")}},{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){b(!0),f.close()}}]),h)return g.unshift({text:RED._("common.label.cancel"),click:function(){f.close()}}),void(f=RED.notify(p,{modal:!0,fixed:!0,buttons:g}))}const v=RED.nodes.createCompleteNodeSet(),m=Date.now();h();const y={flows:v};a||(y.rev=RED.nodes.version()),n=!0,p(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(y),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":i}}).done((function(e,t,o){if(RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(v),r){let e;const t={type:"success",fixed:!1,timeout:6e3,buttons:[{text:RED._("deploy.unusedConfigNodesButton"),class:"pull-left",click:function(){e.close(),RED.actions.invoke("core:search","is:config is:unused ")}},{text:RED._("common.label.close"),class:"primary",click:function(){b(!0),e.close()}}]};e=RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+"</p>",t)}else RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success");RED.nodes.eachNode((function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials})),RED.nodes.eachConfig((function(e){e.changed=!1,e.credentials&&delete e.credentials})),RED.nodes.eachSubflow((function(e){e.changed=!1})),RED.nodes.eachWorkspace((function(e){e.changed=!1})),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")})).fail((function(e,t,o){RED.nodes.dirty(!0),$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?l(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")})).always((function(){const e=Math.max(0,300-(Date.now()-m));setTimeout((function(){n=!1,g(),f()}),e)}))}return{init:function(e){var t,o=(e=e||{}).type||"default";if("default"==o){$('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content"><img id="red-ui-header-button-deploy-icon" src="red/images/deploy-full-o.svg"> <span>'+RED._("deploy.deploy")+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="red-ui-header-button-deploy-options" class="red-ui-deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".red-ui-header-toolbar");const e=[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.svg",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&r("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.svg",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&r("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.svg",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&r("nodes")}},null];RED.settings.runtimeState&&!0===RED.settings.runtimeState.ui&&(e.push({id:"deploymenu-item-runtime-start",icon:"red/images/start.svg",label:RED._("deploy.startFlows"),sublabel:RED._("deploy.startFlowsDesc"),onselect:"core:start-flows",visible:!1}),e.push({id:"deploymenu-item-runtime-stop",icon:"red/images/stop.svg",label:RED._("deploy.stopFlows"),sublabel:RED._("deploy.stopFlowsDesc"),onselect:"core:stop-flows",visible:!1})),e.push({id:"deploymenu-item-reload",icon:"red/images/deploy-reload.svg",label:RED._("deploy.restartFlows"),sublabel:RED._("deploy.restartFlowsDesc"),onselect:"core:restart-flows"}),RED.menu.init({id:"red-ui-header-button-deploy-options",options:e})}else if("simple"==o){var i=e.label||RED._("deploy.deploy"),a="red/images/deploy-full-o.svg";e.hasOwnProperty("icon")&&(a=e.icon),$('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content">'+(a?'<img id="red-ui-header-button-deploy-icon" src="'+a+'"> ':"")+"<span>"+i+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".red-ui-header-toolbar")}$("#red-ui-header-button-deploy").on("click",(function(e){e.preventDefault(),b()})),RED.actions.add("core:deploy-flows",b),"default"===o&&(RED.settings.runtimeState&&!0===RED.settings.runtimeState.ui&&(RED.actions.add("core:stop-flows",(function(){v("stop")})),RED.actions.add("core:start-flows",(function(){v("start")}))),RED.actions.add("core:restart-flows",m),RED.actions.add("core:set-deploy-type-to-full",(function(){RED.menu.setSelected("deploymenu-item-full",!0)})),RED.actions.add("core:set-deploy-type-to-modified-flows",(function(){RED.menu.setSelected("deploymenu-item-flow",!0)})),RED.actions.add("core:set-deploy-type-to-modified-nodes",(function(){RED.menu.setSelected("deploymenu-item-node",!0)}))),RED.events.on("workspace:dirty",(function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#red-ui-header-button-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#red-ui-header-button-deploy").addClass("disabled"))})),RED.comms.subscribe("notification/runtime-deploy",(function(e,o){if(!t){var i=RED.nodes.version();if(null===i||n||i===o.revision)return;var a=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));t=RED.notify(a,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){t.close(),t=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){t.close(),l(RED.nodes.createCompleteNodeSet(),!1),t=null}}]})}}))},setDeployInflight:function(e){n=e}}}(),RED.diagnostics={init:function(){!1!==RED.settings.get("diagnostics.ui",!0)&&RED.actions.add("core:show-system-info",(function(){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"diagnostics",success:function(e){var t=JSON.stringify(e||{},"",4);"{}"===t&&(t="{\n\n}"),RED.editor.editJSON({title:RED._("diagnostics.title"),value:t,requireValid:!0,readOnly:!0,toolbarButtons:[{text:RED._("clipboard.export.copy"),icon:"fa fa-copy",click:function(){RED.clipboard.copyText(t,$(this),RED._("clipboard.copyMessageValue"))}},{text:RED._("clipboard.download"),icon:"fa fa-download",click:function(){var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download","system-info.json"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}}]})},error:function(e,t,o){console.log("Unexpected error loading system info:",e.status,t,o)}})}))}},RED.diff=function(){var e=!1;function t(e,t,o){var n=$('<div class="red-ui-diff-panel"></div>').appendTo(e),d=$('<div class="red-ui-diff-panel-headers"></div>').appendTo(n);"merge"===o.mode&&n.addClass("red-ui-diff-panel-merge");var l=function(e,t){var o=$('<ol class="red-ui-diff-list"></ol>').appendTo(e);return o.editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,o,n){var d=n.diff,l=n.remoteDiff,c=n.tab.n,u=n.def,p=t.conflicts,f=$("<div>",{class:"red-ui-diff-list-flow"}).appendTo(e);f.addClass("collapsed");var h,g,v=$("<div>",{class:"red-ui-diff-list-flow-title"}).appendTo(f),m=$("<div>").appendTo(f),b=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(v),y=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(v);l&&(h=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(v)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(b),i(c,u).appendTo(b);var w=(n.newTab||n.tab).n,E=$("<span>",{class:"red-ui-diff-list-flow-title-meta"}).appendTo(b);"tab"===w.type?E.text(w.label||w.id):"subflow"===c.type?E.text(w.name||w.id):E.text(RED._("diff.globalNodes"));var D={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(n.newTab||n.remoteTab){var R,x={node:d.newConfig.all[c.id],all:d.newConfig.all,diff:d};if(l&&(R={node:l.newConfig.all[c.id]||null,all:l.newConfig.all,diff:l}),void 0!==c.type){var _,k=$("<div>",{class:"red-ui-diff-list-node red-ui-diff-list-node-props collapsed"}).appendTo(m),T=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(k),C=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(T),j=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(T);d.newConfig.all[c.id]?d.added[c.id]?(j.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(j)):d.changed[c.id]?(j.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(j)):(j.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(j)):j.addClass("red-ui-diff-empty"),l&&(_=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(T),l.newConfig.all[c.id]?l.added[c.id]?(_.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(_)):l.changed[c.id]?(_.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(_)):(_.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(_)):(_.addClass("red-ui-diff-empty"),l.deleted[c.id])),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(C),$("<span>").text(RED._("diff.flowProperties")).appendTo(C),T.on("click",(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")})),r(u,c,x,R).appendTo(k),g="",p[c.id]?(D.conflicts++,j.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(j),_.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(_),k.addClass("red-ui-diff-list-node-conflict")):g=t.resolutions[c.id],s(c,k,j,_,!0,!p[c.id],g,t)}}var L=0,S=0,O={};if(n.tab.nodes.forEach((function(e){O[e.id]=!0,a(e,D,t).appendTo(m)})),n.newTab&&(L=n.newTab.nodes.length,n.newTab.nodes.forEach((function(e){O[e.id]||(O[e.id]=!0,a(e,D,t).appendTo(m))}))),n.remoteTab&&(S=n.remoteTab.nodes.length,n.remoteTab.nodes.forEach((function(e){O[e.id]||a(e,D,t).appendTo(m)}))),v.on("click",(function(e){v.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".red-ui-diff-list-node").addClass("collapsed"),$(this).parent().find(".red-ui-debug-msg-element").addClass("collapsed"))})),d.deleted[c.id])$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(y);else if(n.newTab)if(d.added[c.id])$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(y);else{c.id&&(d.changed[c.id]?D.local.changedCount++:D.local.unchangedCount++);var I=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(y);$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:L})).appendTo(I),D.conflicts+D.local.addedCount+D.local.changedCount+D.local.deletedCount>0&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(I),D.conflicts>0&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+D.conflicts+"</span></span>").appendTo(I),D.local.addedCount>0&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+D.local.addedCount+"</span></span>").appendTo(I),D.local.changedCount>0&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+D.local.changedCount+"</span></span>").appendTo(I),D.local.deletedCount>0&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+D.local.deletedCount+"</span></span>").appendTo(I),$('<span class="red-ui-diff-status"> ] </span>').appendTo(I))}else y.addClass("red-ui-diff-empty");if(l){if(l.deleted[c.id])$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(n.remoteTab)if(l.added[c.id])$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{c.id&&(l.changed[c.id]?D.remote.changedCount++:D.remote.unchangedCount++);var N=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(h);$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:S})).appendTo(N),D.conflicts+D.remote.addedCount+D.remote.changedCount+D.remote.deletedCount>0&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(N),D.conflicts>0&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+D.conflicts+"</span></span>").appendTo(N),D.remote.addedCount>0&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+D.remote.addedCount+"</span></span>").appendTo(N),D.remote.changedCount>0&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+D.remote.changedCount+"</span></span>").appendTo(N),D.remote.deletedCount>0&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+D.remote.deletedCount+"</span></span>").appendTo(N),$('<span class="red-ui-diff-status"> ] </span>').appendTo(N))}else h.addClass("red-ui-diff-empty");if(g="",D.conflicts>0?v.addClass("red-ui-diff-list-node-conflict"):g=t.resolutions[c.id],c.id){var P=!(D.conflicts>0&&(d.deleted[c.id]||l.deleted[c.id]));s(c,v,y,h,!1,P,g,t)}}0===f.find(".red-ui-diff-list-node").length&&f.addClass("red-ui-diff-list-flow-empty"),e.i18n()}}),o}(n,t),c=t.localDiff,u=t.remoteDiff,p=(t.conflicts,c.currentConfig),f=c.newConfig;if(void 0!==u){n.addClass("red-ui-diff-three-way");var h=o.oldRevTitle||RED._("diff.local"),g=o.newRevTitle||RED._("diff.remote");$("<div></div>").text(h).appendTo(d),$("<div></div>").text(g).appendTo(d)}else n.removeClass("red-ui-diff-three-way");return{list:l,finish:function(){var e={diff:c,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:p.globals},newTab:{n:{},nodes:f.globals}};void 0!==u&&(e.remoteTab={n:{},nodes:u.newConfig.globals},e.remoteDiff=u),l.editableList("addItem",e);var t,o={};for(t in p.tabOrder.forEach((function(e){var t=p.tabs[e],i={diff:c,def:RED.nodes.getType("tab"),tab:t};f.tabs.hasOwnProperty(e)&&(i.newTab=f.tabs[e]),void 0!==u&&(i.remoteTab=u.newConfig.tabs[e],i.remoteDiff=u),o[e]=!0,l.editableList("addItem",i)})),f.tabOrder.forEach((function(e){if(!o[e]){o[e]=!0;var t=f.tabs[e],i={diff:c,def:RED.nodes.getType("tab"),tab:t,newTab:t};void 0!==u&&(i.remoteDiff=u),l.editableList("addItem",i)}})),void 0!==u&&u.newConfig.tabOrder.forEach((function(e){if(!o[e]){var t=u.newConfig.tabs[e],i={diff:c,remoteDiff:u,def:RED.nodes.getType("tab"),tab:t,remoteTab:t};l.editableList("addItem",i)}})),p.subflows)p.subflows.hasOwnProperty(t)&&(o[t]=!0,e={diff:c,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:p.subflows[t]},f.subflows.hasOwnProperty(t)&&(e.newTab=f.subflows[t]),void 0!==u&&(e.remoteTab=u.newConfig.subflows[t],e.remoteDiff=u),l.editableList("addItem",e));for(t in f.subflows)f.subflows.hasOwnProperty(t)&&!o[t]&&(o[t]=!0,e={diff:c,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:f.subflows[t],newTab:f.subflows[t]},void 0!==u&&(e.remoteDiff=u),l.editableList("addItem",e));if(void 0!==u)for(t in u.newConfig.subflows)u.newConfig.subflows.hasOwnProperty(t)&&!o[t]&&(e={diff:c,remoteDiff:u,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:u.newConfig.subflows[t],remoteTab:u.newConfig.subflows[t]},l.editableList("addItem",e))}}}function o(e,t){var o=$("<div>",{class:"red-ui-diff-list-wires"}),i=$("<ol></ol>"),a=0;return e.forEach((function(e,o){var r=$("<li>").appendTo(i);if(e&&e.length>0){$("<span>").text(o+1).appendTo(r);var s=$("<ul>").appendTo(r);e.forEach((function(e){a++;var o=$("<li>").appendTo(s),i=t[e];i?n(i,RED.nodes.getType(i.type)||{}).appendTo(o):o.text(e)}))}else r.text("none")})),0===a?o.text("none"):i.appendTo(o),o}function i(e,t){var o=$("<div>",{class:"red-ui-diff-list-node-icon"}),i=RED.utils.getNodeColor(e.type,t),n=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(i="#C0DEED"),o.css("backgroundColor",i);var a=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(o);return RED.utils.createIconElement(n,a,!1),o}function n(e,t){var o=$("<div>",{class:"red-ui-diff-list-node-title"});i(e,t).appendTo(o);var n=e.label||e.name||e.id;return $("<div>",{class:"red-ui-diff-list-node-description"}).text(n).appendTo(o),o}function a(e,t,o){var i=o.localDiff,a=o.remoteDiff,d=o.conflicts[e.id],l=!0;i.added[e.id]&&(t.local.addedCount++,l=!1),a&&a.added[e.id]&&(t.remote.addedCount++,l=!1),i.deleted[e.id]&&(t.local.deletedCount++,l=!1),a&&a.deleted[e.id]&&(t.remote.deletedCount++,l=!1),i.changed[e.id]&&(t.local.changedCount++,!0,l=!1),a&&a.changed[e.id]&&(t.remote.changedCount++,!0,l=!1);var c=RED.nodes.getType(e.type);void 0===c&&(c=/^subflow:/.test(e.type)?{icon:"subflow.svg",category:"subflows",color:"#DDAA99",defaults:{name:{value:""}}}:"group"===e.type?RED.group.def:{});var u,p=$("<div>",{class:"red-ui-diff-list-node collapsed"}),f=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(p),h=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(f),g=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(f);if(a&&(u=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(f)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(h),l)t.local.unchangedCount++,n(e,c).appendTo(h),g.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g),a&&(t.remote.unchangedCount++,u.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u)),p.addClass("red-ui-diff-status-unchanged");else if(i.added[e.id])g.addClass("red-ui-diff-status-added"),u&&u.addClass("red-ui-diff-empty"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(g),n(e,c).appendTo(h);else if(a&&a.added[e.id])g.addClass("red-ui-diff-empty"),u.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(u),n(e,c).appendTo(h);else{if(n(e,c).appendTo(h),i.moved[e.id]){var v=i.newConfig.all[e.id];if(i.deleted[e.z]||e.z===v.z||""===e.z||i.newConfig.all[e.z]){g.addClass("red-ui-diff-status-moved");var m="";m=e.z===v.z?RED._("diff.type.movedFrom",{id:i.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:v.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+m+"</span>").appendTo(g)}else g.addClass("red-ui-diff-empty");!0}else i.deleted[e.z]?(g.addClass("red-ui-diff-empty"),!0):i.deleted[e.id]?(g.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(g),!0):i.changed[e.id]?i.newConfig.all[e.id].z!==e.z?g.addClass("red-ui-diff-empty"):(g.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(g),!0):i.newConfig.all[e.id].z!==e.z?g.addClass("red-ui-diff-empty"):(t.local.unchangedCount++,g.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g));if(a)if(a.moved[e.id]){var b=a.newConfig.all[e.id];if(a.deleted[e.z]||e.z===b.z||""===e.z||a.newConfig.all[e.z]){u.addClass("red-ui-diff-status-moved");var y="";y=e.z===b.z?RED._("diff.type.movedFrom",{id:a.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:b.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+y+"</span>").appendTo(u)}else u.addClass("red-ui-diff-empty")}else a.deleted[e.z]?u.addClass("red-ui-diff-empty"):a.deleted[e.id]?(u.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(u)):a.changed[e.id]?a.newConfig.all[e.id].z!==e.z?u.addClass("red-ui-diff-empty"):(u.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(u)):a.newConfig.all[e.id].z!==e.z?u.addClass("red-ui-diff-empty"):(t.remote.unchangedCount++,u.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u))}var w,E={node:i.newConfig.all[e.id],all:i.newConfig.all,diff:i};a&&(w={node:a.newConfig.all[e.id]||null,all:a.newConfig.all,diff:a});var D="";return d?(t.conflicts++,g.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(g),u.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(u),p.addClass("red-ui-diff-list-node-conflict")):D=o.resolutions[e.id],s(e,p,g,u,!1,!d,D,o),f.on("click",(function(t){$(this).parent().toggleClass("collapsed"),0===$(this).siblings(".red-ui-diff-list-node-properties").length&&r(c,e,E,w).appendTo(p)})),p}function r(e,t,i,n){var a,r={},s=i.node;n&&(a=n.node);var d=$("<div>",{class:"red-ui-diff-list-node-properties"}),l=$("<table>").appendTo(d),c=$("<colgroup><col/><col/></colgroup>").appendTo(l);void 0!==a&&$("<col/>").appendTo(c);var u,p,f,h,g,m,b,y=$("<tbody>").appendTo(l),w=!1,E=!1,D=!1;if(u=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("id").appendTo(u),p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),s?(p.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"></span>').appendTo(p),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(p),r["local.id"]=RED.utils.createObjectElement(s.id).appendTo(h)):p.addClass("red-ui-diff-empty"),void 0!==a&&((f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u)).addClass("red-ui-diff-status-unchanged"),a?($('<span class="red-ui-diff-status"></span>').appendTo(f),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(f),r["remote.id"]=RED.utils.createObjectElement(a.id).appendTo(h)):f.addClass("red-ui-diff-empty")),t.hasOwnProperty("x")){if(s&&(s.x===t.x&&s.y===t.y&&s.w===t.w&&s.h===t.h||(w=!0)),a&&(a.x===t.x&&a.y===t.y&&a.w===t.w&&a.h===t.h||(E=!0)),(E&&w&&(s.x!==a.x||s.y!==a.y)||!w&&E&&i.diff.deleted[t.id]||w&&!E&&n.diff.deleted[t.id])&&(D=!0),u=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("position").appendTo(u),p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),s){p.addClass("red-ui-diff-status-"+(w?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(p);var R={x:s.x,y:s.y};s.hasOwnProperty("w")&&(R.w=s.w,R.h=s.h),r["local.position"]=RED.utils.createObjectElement(R,{path:"position",exposeApi:!0,ontoggle:function(e,t){r["remote."+e]&&r["remote."+e].prop("expand")(e,t)}}).appendTo(h)}else p.addClass("red-ui-diff-empty");if(void 0!==a)if((f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u)).addClass("red-ui-diff-status-"+(E?"changed":"unchanged")),a){$('<span class="red-ui-diff-status">'+(E?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(f);var x={x:a.x,y:a.y};a.hasOwnProperty("w")&&(x.w=a.w,x.h=a.h),r["remote.position"]=RED.utils.createObjectElement(x,{path:"position",exposeApi:!0,ontoggle:function(e,t){r["local."+e]&&r["local."+e].prop("expand")(e,t)}}).appendTo(h)}else f.addClass("red-ui-diff-empty")}w=E=D=!1,t.hasOwnProperty("wires")&&(g=JSON.stringify(t.wires),s&&(m=JSON.stringify(s.wires),g!==m&&(w=!0)),a&&(b=JSON.stringify(a.wires),g!==b&&(E=!0)),(E&&w&&m!==b||!w&&E&&i.diff.deleted[t.id]||w&&!E&&n.diff.deleted[t.id])&&(D=!0),u=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("wires").appendTo(u),p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),s?(D?(p.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("red-ui-diff-status-"+(w?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),o(s.wires,i.all).appendTo(p)):p.addClass("red-ui-diff-empty"),void 0!==a&&(f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u),a?(D?(f.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("red-ui-diff-status-"+(E?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(E?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),o(a.wires,n.all).appendTo(f)):f.addClass("red-ui-diff-empty")));var _=Object.keys(t).filter((function(t){return!("inputLabels"==t||"outputLabels"==t||"z"==t||"wires"==t||"x"===t||"y"===t||"w"===t||"h"===t||"id"===t||"type"===t||e.defaults&&e.defaults.hasOwnProperty(t))}));return e.defaults&&(_=_.concat(Object.keys(e.defaults))),"tab"!==t.type&&"group"!==t.type&&(_=_.concat(["inputLabels","outputLabels"])),(s&&s.hasOwnProperty("icon")||a&&a.hasOwnProperty("icon"))&&-1===_.indexOf("icon")&&_.unshift("icon"),_.forEach((function(e){w=!1,E=!1,D=!1,g=JSON.stringify(t[e]),s&&(m=JSON.stringify(s[e]),g!==m&&(w=!0)),a&&(b=JSON.stringify(a[e]),g!==b&&(E=!0)),(E&&w&&m!==b||!w&&E&&i.diff.deleted[t.id]||w&&!E&&n.diff.deleted[t.id])&&(D=!0),u=$("<tr>").appendTo(y);var o=$("<td>",{class:"red-ui-diff-list-cell-label"}).text(e).appendTo(u);p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),s?(D?(p.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("red-ui-diff-status-"+(w?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(p),r["local."+e]=RED.utils.createObjectElement(s[e],{path:e,exposeApi:!0,ontoggle:function(t,o){r["remote."+e]&&r["remote."+e].prop("expand")(t,o)}}).appendTo(h)):p.addClass("red-ui-diff-empty"),void 0!==a&&(f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u),a?(D?(f.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("red-ui-diff-status-"+(E?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(E?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(f),r["remote."+e]=RED.utils.createObjectElement(a[e],{path:e,exposeApi:!0,ontoggle:function(t,o){r["local."+e]&&r["local."+e].prop("expand")(t,o)}}).appendTo(h)):f.addClass("red-ui-diff-empty")),s&&a&&"string"==typeof s[e]&&(/\n/.test(s[e])||/\n/.test(a[e]))&&$('<button class="red-ui-button red-ui-button-small red-ui-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').on("click",(function(){v(s[e],a[e])})).appendTo(o)})),d}function s(e,t,o,i,n,a,r,s){var l="red-ui-diff-selectbox-"+e.id.replace(/\./g,"-")+(n?"-props":""),c="";(e.z||n)&&(c="red-ui-diff-selectbox-tab-"+(n?e.id:e.z).replace(/\./g,"-"));var u=!n&&("tab"===e.type||"subflow"===e.type),p=function(o){var i;if(void 0===e.type);else if(u)i="red-ui-diff-selectbox-tab-"+e.id.replace(/\./g,"-"),$("."+i+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+i+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-local"),$("."+i+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-remote")):($("."+i+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-local"),$("."+i+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-remote"));else{var a="red-ui-diff-selectbox-"+(n?e.id:e.z).replace(/\./g,"-");$("#"+a+"-local").prop("checked",!1),$("#"+a+"-remote").prop("checked",!1);var r=$("#"+a+"-local").closest(".red-ui-diff-list-flow").find(".red-ui-diff-list-flow-title");r.removeClass("red-ui-diff-select-local"),r.removeClass("red-ui-diff-select-remote")}"local"===this.value?(t.removeClass("red-ui-diff-select-remote"),t.addClass("red-ui-diff-select-local")):"remote"===this.value&&(t.addClass("red-ui-diff-select-remote"),t.removeClass("red-ui-diff-select-local")),d(s)},f=$("<label>",{class:"red-ui-diff-selectbox",for:l+"-local"}).on("click",(function(e){e.stopPropagation()})).appendTo(o),h=$("<input>",{class:"red-ui-diff-selectbox-input "+c+"-local",id:l+"-local",type:"radio",value:"local",name:l}).data("node-id",e.id).on("change",p).appendTo(f),g=$("<label>",{class:"red-ui-diff-selectbox",for:l+"-remote"}).on("click",(function(e){e.stopPropagation()})).appendTo(i),v=$("<input>",{class:"red-ui-diff-selectbox-input "+c+"-remote",id:l+"-remote",type:"radio",value:"remote",name:l}).data("node-id",e.id).on("change",p).appendTo(g);"local"===r?h.prop("checked",!0):"remote"===r&&v.prop("checked",!0),(a||o.hasClass("red-ui-diff-empty")||i.hasClass("red-ui-diff-empty"))&&(f.hide(),g.hide())}function d(e){var t=0;$(".red-ui-diff-selectbox>input:checked").each((function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()}));var o=Object.keys(e.conflicts).length;o-t==0?$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:o-t})):$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:o-t})),o===t&&($("#red-ui-diff-view-diff-merge").removeClass("disabled"),$("#red-ui-diff-view-resolve-diff").removeClass("disabled"))}function l(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){var o=RED.nodes.createCompleteNodeSet(),i=RED.nodes.originalFlow(),n=t.flows,a=p(i,o),r=p(i,n);r.rev=t.rev,e(f(a,r))}})}function c(o){void 0===o?l(c):function(o,i){if(e)return;(i=i||{}).mode,o.localDiff;var n=o.remoteDiff,a=o.conflicts,r={title:i.title||RED._("diff.reviewChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("merge"===i.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var r=e.find(".red-ui-tray-body"),s=($('<div class="red-ui-diff-dialog-toolbar"><span><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span> </div>').prependTo(r),t($('<div class="red-ui-diff-container"></div>').appendTo(r),o,i));s.list.hide(),n?($("#red-ui-diff-view-diff-merge").show(),0===Object.keys(a).length?$("#red-ui-diff-view-diff-merge").removeClass("disabled"):$("#red-ui-diff-view-diff-merge").addClass("disabled")):$("#red-ui-diff-view-diff-merge").hide(),d(o),setTimeout((function(){s.finish(),s.list.show()}),300),$("#red-ui-sidebar-shade").show()},close:function(){e=!1,$("#red-ui-sidebar-shade").hide()},show:function(){}};"merge"===i.mode&&r.buttons.push({id:"red-ui-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-diff-view-diff-merge").hasClass("disabled")||(d(o),g(o),RED.tray.close())}});RED.tray.show(r)}(o,{mode:"merge"})}function u(e){var t=[],o={},i={},n=[],a={};return e.forEach((function(e){a[e.id]=e,"tab"===e.type?(t.push(e.id),o[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(i[e.id]={n:e,nodes:[]})})),e.forEach((function(e){"tab"!==e.type&&"subflow"!==e.type&&(o[e.z]?o[e.z].nodes.push(e):i[e.z]?i[e.z].nodes.push(e):n.push(e))})),{all:a,tabOrder:t,tabs:o,subflows:i,globals:n}}function p(e,t){var o=u(e),i=u(t),n={},a={},r={},s={};return Object.keys(o.all).forEach((function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);i.all.hasOwnProperty(e)?JSON.stringify(o.all[e])!==JSON.stringify(i.all[e])&&(r[e]=!0,o.all[e].z!==i.all[e].z&&(s[e]=!0)):a[e]=!0})),Object.keys(i.all).forEach((function(e){o.all.hasOwnProperty(e)||(n[e]=!0)})),{currentConfig:o,newConfig:i,added:n,deleted:a,changed:r,moved:s}}function f(e,t){var o,i,n={},a={},r={localDiff:e,remoteDiff:t,conflicts:n,resolutions:a},s={};for(o in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(o)){s[o]=!0;var d=e.newConfig.all[o];if(e.changed[o]&&t.deleted[o])n[o]=!0;else if(e.deleted[o]&&t.changed[o])n[o]=!0;else if(e.changed[o]&&t.changed[o]){var l=t.newConfig.all[o];JSON.stringify(d)!==JSON.stringify(l)&&(n[o]=!0)}n[o]||(t.added[o]||t.changed[o]||t.deleted[o]?a[o]="remote":a[o]="local")}for(o in e.added)e.added.hasOwnProperty(o)&&(i=e.newConfig.all[o],t.deleted[i.z]?n[o]=!0:a[o]="local");for(o in t.added)t.added.hasOwnProperty(o)&&(i=t.newConfig.all[o],e.deleted[i.z]?n[o]=!0:a[o]="remote");return r}function h(e){e.localDiff.currentConfig;var t,o=e.localDiff,i=e.remoteDiff,n=e.conflicts,a=e.resolutions;for(t in n)if(n.hasOwnProperty(t)&&!a.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var r,s=[],d={},l={};for(t in o.newConfig.all)o.newConfig.all.hasOwnProperty(t)&&(r=RED.nodes.node(t),"local"===a[t]?(r&&(d[t]=r.changed),s.push(o.newConfig.all[t])):"remote"===a[t]?!i.deleted[t]&&i.newConfig.all.hasOwnProperty(t)&&(r&&(d[t]=r.changed),l[t]=1,s.push(i.newConfig.all[t])):console.log("Unresolved",t));for(t in i.added)i.added.hasOwnProperty(t)&&((r=RED.nodes.node(t))&&(d[t]=r.changed),o.added.hasOwnProperty(t)||(l[t]=2,s.push(i.newConfig.all[t])));return{config:s,nodeChangedStates:d,localChangedStates:l}}function g(e){var t=RED.workspaces.active(),o=h(e),i=o.config,n=o.nodeChangedStates,a=o.localChangedStates,r=RED.nodes.dirty(),s={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:n,dirty:r,rev:RED.nodes.version()};RED.history.push(s);var d=RED.nodes.originalFlow();for(var l in e.remoteDiff.added)e.remoteDiff.added.hasOwnProperty(l)&&e.remoteDiff.newConfig.all.hasOwnProperty(l)&&d.push(JSON.parse(JSON.stringify(e.remoteDiff.newConfig.all[l])));RED.nodes.clear();var c=RED.nodes.import(i);RED.nodes.originalFlow(d),c.nodes.forEach((function(e){(n[e.id]||a[e.id])&&(e.changed=!0)})),RED.nodes.version(e.remoteDiff.rev),r&&RED.nodes.dirty(!0),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.workspaces.show(t,!0),RED.sidebar.config.refresh()}function v(t,o){var i={title:RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var i=e.find(".red-ui-tray-body"),n=$('<div class="red-ui-diff-text"></div>').appendTo(i),a=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(n);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(a);for(var r,s=$("<tbody>").appendTo(a),d=function(e,t,o){var i,n,a=e.split(/\r?\n/),r=t.split(/\r?\n/),s=a.length,d=r.length,l={a:[],b:[]},c=[];for(i=0;i<s+1;i++)for(c[i]=[],n=0;n<d+1;n++)c[i][n]=0;for(i=s-1;i>=0;i--)for(n=d-1;n>=0;n--)1!==y(a[i],r[n],o)?c[i][n]=c[i+1][n+1]+1:c[i][n]=Math.max(c[i+1][n],c[i][n+1]);i=0,n=0;for(;i<s&&n<d;){var u=y(a[i],r[n],o);if(1!==u){var p=0;0===u?p=0:2==u&&(p=3),l.a.push({i:i+1,j:n+1,line:a[i],type:p}),l.b.push({i:n+1,j:i+1,line:r[n],type:p}),i++,n++}else c[i+1][n]>=c[i][n+1]?(l.a.push({i:i+1,line:a[i],type:1}),i++):(l.b.push({i:n+1,line:r[n],type:4}),n++)}for(;i<s||n<d;)i==s?(l.b.push({i:n+1,line:r[n],type:4}),n++):n==d&&(l.a.push({i:i+1,line:a[i],type:1}),i++);return l}(t||"",o||""),l=0,c=0,u=Math.max(d.a.length,d.b.length),p=[],f=[],h=0,g=0,v=0;v<u;v++){d[v];var w=l<d.a.length?d.a[l]:{type:2,line:""},E=c<d.b.length?d.b[c]:{type:2,line:""};0===w.type&&0!==E.type?(w={type:2,line:""},c++):0===E.type&&0!==w.type?(E={type:2,line:""},l++):(l++,c++),p.push({a:w,b:E}),void 0===r?(r={start:v,end:v},h=0,g=0===w.type&&0===E.type?0:1):0===w.type&&0===E.type?0===g?(r.end=v,h++):1===g?(r.end=v,g=2,h=0):2===g&&(r.end=v,8===++h&&(r.end-=5,f.push(r),r={start:v-5,end:v-5},g=0,h=0)):(r.end=v,h++,0===g?(r.end>3&&(r.end-=3,r.empty=!0,f.push(r),r={start:v-3,end:v-3}),g=1):2===g&&(g=1))}0===g&&(r.empty=!0),r.end=u,f.push(r),console.table(f);for(var D=0;D<f.length;D++)if((r=f[D]).empty)m(r.start,r.end,p).appendTo(s);else for(v=r.start;v<r.end;v++){var R=b(p[v]).appendTo(s);v===r.start?R.addClass("start-block"):v===r.end-1&&R.addClass("end-block")}},close:function(){e=!1},show:function(){}};RED.tray.show(i)}function m(e,t,o){diffRow=$('<tr class="red-ui-diff-text-header red-ui-diff-text-expand">');var i=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),n=$("<span></span>").appendTo(i);return t<o.length-1&&n.text("@@ -"+(o[t-1].a.i+1)+" +"+(o[t-1].b.i+1)),diffRow.on("click",(function(i){if(t-e>20){var a=$(this).offset();if(e>0){for(var r=e;r<e+10;r++)b(o[r]).addClass("unchanged").insertBefore($(this));e+=10}if(t<o.length-1){for(r=t-1;r>t-11;r--)b(o[r]).addClass("unchanged").insertAfter($(this));t-=10}t<o.length-1&&n.text("@@ -"+(o[t-1].a.i+1)+" +"+(o[t-1].b.i+1));var s=$(this).offset().top-a.top;$(".red-ui-diff-text").scrollTop($(".red-ui-diff-text").scrollTop()+s)}else{for(r=e;r<t;r++)b(o[r]).addClass("unchanged").insertBefore($(this));$(this).remove()}})),diffRow}function b(e){var t=$("<tr>"),o=e.a,i=e.b,n=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),a=$('<td class="linetext">').text(o.line).appendTo(t);return 2===o.type?(n.addClass("blank"),a.addClass("blank")):4===o.type?(n.addClass("added"),a.addClass("added")):1===o.type&&(n.addClass("removed"),a.addClass("removed")),n=$('<td class="lineno">').text(2===i.type?"":i.i).appendTo(t),a=$('<td class="linetext">').text(i.line).appendTo(t),2===i.type?(n.addClass("blank"),a.addClass("blank")):4===i.type?(n.addClass("added"),a.addClass("added")):1===i.type&&(n.addClass("removed"),a.addClass("removed")),t}function y(e,t,o){return o?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function w(e,o){var i=$("<div></div>");return e.forEach((function(e){var n=e.hunks,a=e.binary,r=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(i);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(r);var s=$("<tbody>").appendTo(r),l=$('<tr class="red-ui-diff-text-file-header">').appendTo(s),c=$('<td colspan="3"></td>').appendTo(l);$('<i class="red-ui-diff-list-chevron fa fa-angle-down"></i>').appendTo(c);l.on("click",(function(e){l.toggleClass("collapsed");var t=l.hasClass("collapsed");l.nextUntil(".red-ui-diff-text-file-header").toggle(!t)}));$('<span class="filename"></span>').text(e.file).appendTo(c);var u,h=0,g=0,v={};if(o.project.files&&o.project.files.flow===e.file){o.unmerged&&$('<span style="float: right;"><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span>').appendTo(c);var m=$('<tr class="red-ui-diff-text-header">').appendTo(s),b=$('<td class="red-ui-diff-flow-diff" colspan="3"></td>').appendTo(m),y=o.project.name,w=o.project.files.flow,E="projects/"+y+"/files/"+o.commonRev+"/"+w,D="projects/"+y+"/files/"+o.oldRev+"/"+w,R="projects/"+y+"/files/"+o.newRev+"/"+w,x=[$.Deferred(),$.Deferred(),$.Deferred()];if(o.commonRev){E="projects/"+y+"/files/"+o.commonRev+"/"+w;$.ajax({dataType:"json",url:E}).then((function(e){x[0].resolve(e)})).fail((function(){x[0].resolve(null)}))}else x[0].resolve(null);$.ajax({dataType:"json",url:D}).then((function(e){x[1].resolve(e)})).fail((function(){x[1].resolve({content:"[]"})})),$.ajax({dataType:"json",url:R}).then((function(e){x[2].resolve(e)})).fail((function(){x[2].resolve({content:"[]"})})),$.when.apply($,x).always((function(e,i,n){var a,r,s;if(e)try{a=JSON.parse(e.content||"[]")}catch(e){return console.log(RED._("diff.commonVersionError"),E),void console.log(e)}try{r=JSON.parse(i.content||"[]")}catch(e){return console.log(RED._("diff.oldVersionError"),D),void console.log(e)}a||(a=r);try{s=JSON.parse(n.content||"[]")}catch(e){return console.log(RED._("diff.newVersionError"),s),void console.log(e)}var l=p(a,r),c=p(a,s);o.currentDiff=f(l,c);var u=t(b,o.currentDiff,{title:w,mode:o.commonRev?"merge":"view",oldRevTitle:o.oldRevTitle,newRevTitle:o.newRevTitle});u.list.hide(),d(o.currentDiff),setTimeout((function(){u.finish(),u.list.show()}),300)}))}else if(a){var _=$('<tr class="red-ui-diff-text-header">').appendTo(s),k=$('<td colspan="3"></td>').appendTo(_);$("<span></span>").text(RED._("diff.noBinaryFileShowed")).appendTo(k)}else o.unmerged&&(u=$('<span style="float: right;">'+RED._("diff.conflictHeader",{resolved:g,unresolved:h})+"</span>").appendTo(c)),n.forEach((function(t){var i=$('<tr class="red-ui-diff-text-header">').appendTo(s),n=$('<td colspan="3"></td>').appendTo(i),a=($("<span></span>").text(t.header).appendTo(n),t.conflict),r=t.localStartLine,d=t.remoteStartLine;a&&h++,t.lines.forEach((function(i,n){var l,c=t.diffStart+n,p=a&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(i),f=$("<tr>").appendTo(s),m=$('<td class="lineno">').appendTo(f);p?m.attr("colspan",2):l=$('<td class="lineno">').appendTo(f);var b=$('<td class="linetext">').appendTo(f),y=1;if(a&&(y=2),p){if(f.addClass("mergeHeader"),/^\+\+=======$/.test(i))t.changeSeparator=c,f.addClass("mergeHeader-separator");else{var w=/^..<<<<<<</.test(i);w?($("<span>").text("<<<<<<< Local Changes").appendTo(b),t.localChangeStart=c):(t.remoteChangeEnd=c,$("<span>").text(">>>>>>> Remote Changes").appendTo(b)),f.addClass("mergeHeader-"+(w?"ours":"theirs")),$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(w?"down":"up")+'"></i> use '+(w?"local":"remote")+" changes</button>").appendTo(b).on("click",(function(i){var n,a;i.preventDefault(),g++,w?((a=(n=f.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),a.next().remove()):((a=(n=f.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),a.prev().remove()),a.remove(),f.remove(),n.find(".linetext").addClass("added"),u.empty(),$("<span>"+RED._("diff.conflictHeader",{resolved:g,unresolved:h})+"</span>").appendTo(u),v[e.file]=v[e.file]||{},v[e.file][t.localChangeStart]={changeStart:t.localChangeStart,separator:t.changeSeparator,changeEnd:t.remoteChangeEnd,selection:w?"A":"B"},o.resolveConflict&&o.resolveConflict({conflicts:h,resolved:g,resolutions:v})}))}}else{var E=i[0];a&&!o.unmerged&&" "===E&&(E=i[1]),$('<span class="prefix">').text(E).appendTo(b);var D=!1;a&&o.unmerged?($('<span class="prefix">').text(i[1]).appendTo(b),"+"===i[0]&&(m.text(r++),D=!0),"+"===i[1]&&(l.text(d++),D=!0)):"+"===i[0]||a&&"+"===i[1]?(m.addClass("added"),l.addClass("added"),b.addClass("added"),l.text(d++),D=!0):("-"===i[0]||a&&"-"===i[1])&&(m.addClass("removed"),l.addClass("removed"),b.addClass("removed"),m.text(r++),D=!0),D||(b.addClass("unchanged"),r>0&&"\\"!==i[0]&&""!==i&&m.text(r++),d>0&&"\\"!==i[0]&&""!==i&&l.text(d++)),$("<span>").text(i.substring(y)).appendTo(b)}}))}))})),i}function E(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var o,i,n=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,a=/^\+\+\+ b\/(.*)\t?/,r=/^Binary files /,s=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,d=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,l=[],c=0;c<t.length;c++){var u=t[c],p=n.exec(u);if(p)i&&(o.hunks.push(i),l.push(o)),i=null,o={file:p[1]||p[3],hunks:[]};else if(r.test(u))o&&(o.binary=!0);else{var f=a.exec(u);if(f)o.file=f[1];else{var h=s.exec(u);if(h){i&&o.hunks.push(i),i={header:u,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=d.exec(u)){i&&o.hunks.push(i),i={header:u,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}i&&i.lines.push(u)}}}return i&&o.hunks.push(i),l.push(o),l}return{init:function(){RED.actions.add("core:show-remote-diff",c)},getRemoteDiff:l,showRemoteDiff:c,showUnifiedDiff:function(t){var o,i=t.diff,n=t.title,a=E(i);t.unmerged&&(t.resolveConflict=function(e){o=e,e.conflicts===e.resolved&&$("#red-ui-diff-view-resolve-diff").removeClass("disabled")});var r={title:n||RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._(t.unmerged?"common.label.cancel":"common.label.close"),click:function(){t.oncancel&&t.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){var o=e.find(".red-ui-tray-body"),i=$('<div class="red-ui-diff-text"></div>').appendTo(o);w(a,t).appendTo(i)},close:function(){e=!1},show:function(){}};t.unmerged&&r.buttons.push({id:"red-ui-diff-view-resolve-diff",text:RED._("diff.saveConflict"),class:"primary disabled",click:function(){if(!$("#red-ui-diff-view-resolve-diff").hasClass("disabled")){if(t.currentDiff){var e=h(t.currentDiff);(o={resolutions:{}}).resolutions[t.project.files.flow]=JSON.stringify(e.config,"",4)}t.onresolve&&t.onresolve(o),RED.tray.close()}}}),RED.tray.show(r)},showCommitDiff:function(t){var o=function(e){for(var t={},o=e.split("\n"),i=[],n=0;n<o.length;n++)if(/^commit /.test(o[n]))t.sha=o[n].substring(7);else if(/^Author: /.test(o[n])){t.author=o[n].substring(8);var a=/^(.*) <(.*)>$/.exec(t.author);a&&(t.authorName=a[1],t.authorEmail=a[2])}else if(/^Date: /.test(o[n]))t.date=o[n].substring(8);else if(/^    /.test(o[n]))t.title?(4!==o[n].length||i.length>0)&&i.push(o[n].substring(4)):t.title=o[n].substring(4);else if(/^diff /.test(o[n])){t.files=E(o.slice(n));break}return t.comment=i.join("\n"),t}(t.commit),i={title:RED._("diff.viewCommitDiff"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var i=e.find(".red-ui-tray-body"),n=$('<div class="red-ui-diff-text"></div>').appendTo(i),a=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(n);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(a);var r=$("<tbody>").appendTo(a),s=$('<tr class="red-ui-diff-text-commit-header">').appendTo(r),d=$('<td colspan="3"></td>').appendTo(s);$("<h3>").text(o.title).appendTo(d),$('<div class="commit-body"></div>').text(o.comment).appendTo(d);var l=$('<div class="commit-summary"></div>').appendTo(d);$('<div style="float: right">').text("Commit "+o.sha).appendTo(l),$("<div>").text((o.authorName||o.author)+" - "+t.date).appendTo(l),o.files&&w(o.files,t).appendTo(n)},close:function(){e=!1},show:function(){}};RED.tray.show(i)},mergeDiff:g}}(),RED.keyboard=function(){var e,t,o=/Mac/i.test(window.navigator.platform),n=!0,a={},r={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,"+":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191,"[":219,"]":221,"{":219,"}":221},s={16:!0,17:!0,18:!0,91:!0,93:!0},d={},l={},c={59:186,61:187,173:189};function u(e){return RED.settings.get("editor.keymap",{})[e]}function p(e){for(var t,o=e.toLowerCase().split("-"),i={},n=0;n<o.length;n++)switch(o[n]){case"ctrl":case"cmd":i.ctrl=!0,i.meta=!0;break;case"alt":i.alt=!0;break;case"shift":i.shift=!0;break;case"":t=r["-"];break;default:if(r.hasOwnProperty(o[n]))t=r[o[n]];else{if(o[n].length>1)return null;t=o[n].toUpperCase().charCodeAt(0)}}return[t,i]}function f(e,t){for(var o=e.target,i=0;"BODY"!==o.nodeName&&o.id!==t.scope;)o=o.parentElement,i++;return"BODY"===o.nodeName&&"*"!==t.scope&&(i=-1),i}function h(e){var o=t||a;(e.ctrlKey||e.metaKey)&&e.ctrlKey!==e.metaKey&&(o=o.ctrl),o&&e.shiftKey&&(o=o.shift),o&&e.altKey&&(o=o.alt);var i=c[e.keyCode]||e.keyCode;if(o&&o[i]){var n=o[i];if(!n.handlers){if(t)return t=null,h(e);if(Object.keys(n).length>0)for(let o in n)if(f(e,n[o])>-1){t=n,e.preventDefault();break}return null}var r,s=1/0,d=0,l=n.handlers.length;for(d=0;d<l;d++){var u=f(e,n.handlers[d]);u>-1&&u<s&&(s=u,r=n.handlers[d])}return t=null,n=r}if(t)return t=null,h(e)}function g(e,t,o,i){var n=o,r=i;"function"!=typeof o&&"string"!=typeof o||(n={},r=o);var s=[],c=0;if("string"==typeof t){if("string"==typeof r){if(i||l.hasOwnProperty(r)||(l[r]={scope:e,key:t,user:!1}),!i)if(u(r))return;d[r]={scope:e,key:t},"boolean"==typeof i&&(d[r].user=i)}var f=t.split(" ");for(c=0;c<f.length;c++){var h=p(f[c]);if(!h)return;s.push(h)}}else s.push([t,n]);var g=a;for(c=0;c<s.length;c++)t=s[c][0],(n=s[c][1]).ctrl&&(g.ctrl=g.ctrl||{},g=g.ctrl),n.shift&&(g.shift=g.shift||{},g=g.shift),n.alt&&(g.alt=g.alt||{},g=g.alt),g[t]=g[t]||{},g=g[t];g.handlers=g.handlers||[],g.handlers.push({scope:e,ondown:r}),g.scope=e,g.ondown=r}function v(e,t){var o=t||{},i=[],n=0;if("string"==typeof e){var r=e.split(" ");for(n=0;n<r.length;n++){var s=p(r[n]);if(!s)return void console.log("Unrecognised key specifier:",e);i.push(s)}}else i.push([e,o]);var l=a;for(n=0;n<i.length;n++){if(e=i[n][0],(o=i[n][1]).ctrl&&(l=l.ctrl),l&&o.shift&&(l=l.shift),l&&o.alt&&(l=l.alt),!l[e])return;l=l[e]}"string"==typeof l.ondown&&("boolean"==typeof t&&t?d[l.ondown]={user:t}:delete d[l.ondown]),delete l.scope,delete l.ondown,delete l.handlers}d3.select(window).on("keydown",(function(){if(n&&!s[d3.event.keyCode]){var e=h(d3.event);e&&e.ondown&&("string"==typeof e.ondown?RED.actions.invoke(e.ondown):e.ondown(),d3.event.preventDefault())}}));function m(t){t.preventDefault();var o=$(this),i=o.data("data");if(!o.hasClass("keyboard-shortcut-entry-expanded")){b();var n=o.find(".keyboard-shortcut-entry-key"),a=o.find(".keyboard-shortcut-entry-scope");o.addClass("keyboard-shortcut-entry-expanded");var r=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(i.key||"").appendTo(n);r.on("change paste keyup",(function(t){if(13===t.keyCode&&!$(this).hasClass("input-error"))return b();if(27===t.keyCode)return b(!0);var o=$(this).val(),i=""===(o=o.trim())||RED.keyboard.validateKey(o);i&&""!==o&&(i=!e.has(s.val()+":"+o.toLowerCase())),$(this).toggleClass("input-error",!i),l.attr("disabled",!i)}));var s=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="red-ui-workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(a);s.i18n(),"workspace"===i.scope&&(i.scope="red-ui-workspace"),s.val(i.scope||"*"),s.on("change",(function(){r.trigger("change")}));var d=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(a),l=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-check"></i></button>').appendTo(d),c=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(d);l.on("click",(function(e){e.stopPropagation(),b()})),c.on("click",(function(e){e.stopPropagation(),o.empty(),o.removeClass("keyboard-shortcut-entry-expanded");var t=RED.settings.get("editor.keymap",{});t[i.id]=null,RED.settings.set("editor.keymap",t),RED.keyboard.revertToDefault(i.id);var n=RED.keyboard.getShortcut(i.id),a={id:i.id,scope:n?n.scope:void 0,key:n?n.key:void 0,user:n?n.user:void 0,label:i.label,options:i.options};y(o,a)})),r.trigger("focus")}}function b(t){var o=$(".keyboard-shortcut-entry-expanded");if(1===o.length){var i=o.data("data"),n=o.find(".keyboard-shortcut-entry-key input"),a=o.find(".keyboard-shortcut-entry-scope select");if(!t){var r=n.val().trim(),s=a.val();if(""===r||RED.keyboard.validateKey(r)){var d=RED.keyboard.getShortcut(i.id);if(!d&&r||d&&(d.scope!==s||d.key!==r)){var l=o.find(".keyboard-shortcut-entry-key"),c=o.find(".keyboard-shortcut-entry-scope");l.empty(),c.empty(),i.key&&(e.delete(i.scope+":"+i.key),RED.keyboard.remove(i.key,!0)),o.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===r?(l.parent().addClass("keyboard-shortcut-entry-unassigned"),l.append($("<span>").text(RED._("keyboard.unassigned"))),delete i.key,delete i.scope):(l.parent().removeClass("keyboard-shortcut-entry-unassigned"),l.append(RED.keyboard.formatKey(r)),$("<span>").text(s).appendTo(c),i.key=r,i.scope=s,e.add(i.scope+":"+i.key),RED.keyboard.add(i.scope,i.key,i.id,!0));var u=RED.settings.get("editor.keymap",{}),p=RED.keyboard.getShortcut(i.id);u[i.id]={scope:p.scope,key:p.key},RED.settings.set("editor.keymap",u)}}}n.remove(),a.remove(),$(".keyboard-shortcut-edit").remove(),o.removeClass("keyboard-shortcut-entry-expanded")}}function y(e,t){var o=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var i=t.label,n=$("<div>").addClass("keyboard-shortcut-entry-text").text(i).appendTo(o),a=$('<i class="fa fa-user"></i>').prependTo(n);t.user||a.css("opacity",0);var r=$('<div class="keyboard-shortcut-entry-key">').appendTo(o);t.key?r.append(RED.keyboard.formatKey(t.key)):(o.addClass("keyboard-shortcut-entry-unassigned"),r.append($("<span>").text(RED._("keyboard.unassigned"))));var s=$('<div class="keyboard-shortcut-entry-scope">').appendTo(o);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(s),e.on("click",m)}function w(){var t=$('<div id="red-ui-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input autocomplete="off" name="keyboard-filter" id="red-ui-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(t),t.find("#red-ui-settings-tab-keyboard-filter").searchBox({delay:100,change:function(){var e=$(this).val().trim().toLowerCase();""===e?o.editableList("filter",null):(e=e.replace(/\s/g,""),o.editableList("filter",(function(t){return t.label.toLowerCase().indexOf(e)>-1})))}});var o=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(t).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){y(e,o)}}),i=RED.actions.list();return i.sort((function(e,t){var o=e.label,i=t.label;return o.localeCompare(i)})),e=new Set,i.forEach((function(t){t.key&&e.add(t.scope+":"+t.key),o.editableList("addItem",t)})),t}return{init:function(e){!function(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");null!==e&&(localStorage.removeItem("keymap"),RED.settings.set("editor.keymap",JSON.parse(e)))}}();var t=RED.settings.get("editor.keymap",{});$.getJSON("red/keymap.json",(function(o){var i=function(e,t){var o={};for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];for(var a in n)n.hasOwnProperty(a)&&(o[n[a]]?o[n[a]].push({scope:i,key:a,user:!1}):o[n[a]]=[{scope:i,key:a,user:!1}])}for(var r in t)t.hasOwnProperty(r)&&(t[r].key?(o[r]=[{scope:t[r].scope||"*",key:t[r].key,user:!1}],"workspace"===o[r][0].scope&&(o[r][0].scope="red-ui-workspace")):delete o[r]);return o}(o,RED.settings.theme("keymap",{}));for(n in i)i.hasOwnProperty(n)&&(t.hasOwnProperty(n)||i[n].forEach((function(e){g(e.scope,e.key,n,!1)})),l[n]=i[n][0]);for(var n in t)if(t.hasOwnProperty(n)&&t[n]){var a=t[n];if(a.hasOwnProperty("key")){var r=a.scope;"workspace"===r&&(r="red-ui-workspace"),g(r,a.key,n,!0)}}e()})),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:w,focus:function(){setTimeout((function(){$("#red-ui-settings-tab-keyboard-filter").trigger("focus")}),200)},close:function(){RED.menu.refreshShortcuts()}})},add:g,remove:v,getShortcut:function(e){return d[e]},getUserShortcut:u,revertToDefault:function(e){var t=d[e];if(t&&v(t.key),l.hasOwnProperty(e)){var o=l[e];g(o.scope,o.key,e,!1)}},formatKey:function(e,t){var i=o?e.replace(/ctrl-?/,"&#8984;"):e;return i=(i=(i=(i=(i=(i=o?i.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;"),t?i:'<span class="help-key-block"><span class="help-key">'+i.split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++){if(!p(t[i]))return!1}return!0},disable:function(){n=!1},enable:function(){n=!0}}}(),RED.workspaces=function(){var e=0,t=0,o=[],i=[],n=0;let a,r;function s(e){n!==o.length&&o.splice(n),o.push(e),n=o.length}function d(e){i=i.filter((function(t){if(t===e)return!1;if(Array.isArray(t)){var o=t.indexOf(e);return o>-1&&t.splice(o,1),0!==t.length}return!0}))}function l(e,o,i){if(e){e.closeable||(e.hideable=!0),p.addTab(e,i),JSON.parse(RED.settings.getLocal("hiddenTabs")||"{}")[e.id]&&p.hideTab(e.id),p.resize()}else{var n=RED.nodes.id();do{t+=1}while(0!==$("#red-ui-workspace-tabs li[flowname='"+RED._("workspace.defaultName",{number:t})+"']").size());e={type:"tab",id:n,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:t}),env:[],hideable:!0},RED.nodes.addWorkspace(e,i),p.addTab(e,i),p.activateTab(n),o||(RED.history.push({t:"add",workspaces:[e],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return $("#red-ui-tab-"+e.id.replace(".","-")).attr("flowname",e.label),RED.view.focus(),e}function c(e){if(1!==f){var t=RED.nodes.getWorkspaceOrder();e._index=t.indexOf(e.id),w(e);var o=RED.nodes.removeWorkspace(e.id);o.t="delete",o.dirty=RED.nodes.dirty(),o.workspaces=[e],RED.history.push(o),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function u(e){var t=RED.nodes.workspace(e);if(t)RED.editor.editFlow(t);else{var o=RED.nodes.subflow(e);o&&RED.editor.editSubflow(o)}}var p,f=0;function h(){p=RED.tabs.create({id:"red-ui-workspace-tabs",onchange:function(t){var o={old:e};t?($("#red-ui-workspace-chart").show(),e=t.id,window.location.hash="flow/"+t.id,$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!t.disabled)):($("#red-ui-workspace-chart").hide(),e=0,window.location.hash=""),o.workspace=e,RED.events.emit("workspace:change",o),RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(t){t.id!==e&&s(e),RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?u(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(t){"tab"===t.type&&f++,$('<span class="red-ui-workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+t.id.replace(".","-")+" .red-ui-tab-label"),t.disabled&&$("#red-ui-tab-"+t.id.replace(".","-")).addClass("red-ui-workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",0===e||f<=1),1===f&&($("#red-ui-workspace .red-ui-tabs").show(),$("#red-ui-workspace-chart").show(),$("#red-ui-workspace-footer").children().show())},onremove:function(t){"tab"===t.type?f--:i.push(t.id),RED.menu.setDisabled("menu-item-workspace-delete",0===e||f<=1),0===f&&g()},onreorder:function(e,t){RED.history.push({t:"reorder",workspaces:{from:e,to:t},dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),E(t)},onselect:function(e){RED.view.select(!1),0===e.length?($("#red-ui-workspace-chart svg").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-palette-container").css({"pointer-events":"auto",filter:"none"}),$(".red-ui-sidebar-shade").hide()):(RED.view.select(!1),$("#red-ui-workspace-chart svg").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-palette-container").css({"pointer-events":"none",filter:"opacity(60%)"}),$(".red-ui-sidebar-shade").show())},onhide:function(e){i.push(e.id);var t=JSON.parse(RED.settings.getLocal("hiddenTabs")||"{}");t[e.id]=!0,RED.settings.setLocal("hiddenTabs",JSON.stringify(t)),RED.events.emit("workspace:hide",{workspace:e.id})},onshow:function(e){d(e.id);var t=JSON.parse(RED.settings.getLocal("hiddenTabs")||"{}");delete t[e.id],RED.settings.setLocal("hiddenTabs",JSON.stringify(t)),RED.events.emit("workspace:show",{workspace:e.id})},minimumActiveTabWidth:150,scrollable:!0,addButton:"core:add-flow",addButtonCaption:RED._("workspace.addFlow"),menu:function(){var e=[{id:"red-ui-tabs-menu-option-search-flows",label:RED._("workspace.listFlows"),onselect:"core:list-flows"},{id:"red-ui-tabs-menu-option-search-subflows",label:RED._("workspace.listSubflows"),onselect:"core:list-subflows"},null,{id:"red-ui-tabs-menu-option-add-flow",label:RED._("workspace.addFlow"),onselect:"core:add-flow"},{id:"red-ui-tabs-menu-option-add-flow-right",label:RED._("workspace.addFlowToRight"),onselect:"core:add-flow-to-right"},null,{id:"red-ui-tabs-menu-option-add-hide-flows",label:RED._("workspace.hideFlow"),onselect:"core:hide-flow"},{id:"red-ui-tabs-menu-option-add-hide-other-flows",label:RED._("workspace.hideOtherFlows"),onselect:"core:hide-other-flows"},{id:"red-ui-tabs-menu-option-add-show-all-flows",label:RED._("workspace.showAllFlows"),onselect:"core:show-all-flows"},{id:"red-ui-tabs-menu-option-add-hide-all-flows",label:RED._("workspace.hideAllFlows"),onselect:"core:hide-all-flows"},{id:"red-ui-tabs-menu-option-add-show-last-flow",label:RED._("workspace.showLastHiddenFlow"),onselect:"core:show-last-hidden-flow"}];let t=new Set;for(let e=0;e<i.length;e++){let o=i[e];Array.isArray(o)||(o=[o]),o.forEach((e=>{RED.nodes.workspace(e)&&t.add(e)}))}const o=t.size;return o>0&&e.unshift({label:RED._("workspace.hiddenFlows",{count:o}),onselect:"core:list-hidden-flows"}),e}}),f=0}function g(){$("#red-ui-workspace .red-ui-tabs").hide(),$("#red-ui-workspace-chart").hide(),$("#red-ui-workspace-footer").children().hide()}function v(t){u(t||e)}function m(e){y(e,!1)}function b(e){y(e,!0)}function y(t,o){var i=RED.nodes.workspace(t||e);if(i&&i.disabled!==o){var n={disabled:i.disabled};i.disabled=o,$("#red-ui-tab-"+i.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!i.disabled),t&&t!==e||$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!i.disabled);var a={t:"edit",changes:n,node:i,dirty:RED.nodes.dirty()};i.changed=!0,RED.history.push(a),RED.events.emit("flows:change",i),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var r=RED.view.selection();r.nodes||r.links||i.id!==e||RED.sidebar.info.refresh(i),n.hasOwnProperty("disabled")&&(RED.nodes.eachNode((function(e){e.z===i.id&&(e.dirty=!0)})),RED.view.redraw())}}function w(t){t?(p.contains(t.id)&&p.removeTab(t.id),t.id===e&&(e=0)):c(RED.nodes.workspace(e))}function E(e){var t=e.filter((function(e){return void 0!==RED.nodes.workspace(e)})),o=RED.nodes.getWorkspaceOrder();JSON.stringify(t)!==JSON.stringify(o)&&(RED.nodes.setWorkspaceOrder(t),RED.events.emit("flows:reorder",t)),p.order(e)}return{init:function(){$('<ul id="red-ui-workspace-tabs"></ul>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-tabs-shade" class="hide"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-chart" tabindex="1"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-toolbar"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-editor-shade" class="hide"></div>').appendTo("#red-ui-workspace"),h(),RED.events.on("sidebar:resize",p.resize),RED.actions.add("core:show-next-tab",(function(){var t=e;p.nextTab(),t!==e&&s(t)})),RED.actions.add("core:show-previous-tab",(function(){var t=e;p.previousTab(),t!==e&&s(t)})),RED.menu.setAction("menu-item-workspace-delete",(function(){c(RED.nodes.workspace(e))})),$(window).on("resize",(function(){p.resize()})),RED.actions.add("core:add-flow",(function(e){l(void 0,void 0,e?e.index:void 0)})),RED.actions.add("core:add-flow-to-right",(function(e){l(void 0,void 0,p.activeIndex()+1)})),RED.actions.add("core:edit-flow",v),RED.actions.add("core:remove-flow",w),RED.actions.add("core:enable-flow",m),RED.actions.add("core:disable-flow",b),RED.actions.add("core:hide-flow",(function(){var t=p.selection();0===t.length&&(t=[{id:e}]);var o=[];t.forEach((function(e){RED.workspaces.hide(e.id),i.pop(),o.push(e.id)})),o.length>0&&i.push(o),p.clearSelection()})),RED.actions.add("core:hide-other-flows",(function(){var t=p.selection();0===t.length&&(t=[{id:e}]);var o=new Set(t.map((function(e){return e.id}))),n=p.listTabs(),a=[];n.forEach((function(e){o.has(e)||(RED.workspaces.hide(e),i.pop(),a.push(e))})),a.length>0&&i.push(a)})),RED.actions.add("core:hide-all-flows",(function(){var e=p.listTabs();e.forEach((function(e){RED.workspaces.hide(e),i.pop()})),e.length>0&&i.push(e),p.clearSelection()})),RED.actions.add("core:show-all-flows",(function(){p.listTabs().forEach((function(e){RED.workspaces.show(e,null,!0)}))})),RED.actions.add("core:show-last-hidden-flow",(function(){var e=i.pop();if(e)if("string"==typeof e)RED.workspaces.show(e);else{var t=e.pop();e.forEach((function(e){RED.workspaces.show(e,null,!0)})),setTimeout((function(){RED.workspaces.show(t)}),150)}})),RED.actions.add("core:list-modified-nodes",(function(){RED.actions.invoke("core:search","is:modified ")})),RED.actions.add("core:list-hidden-flows",(function(){RED.actions.invoke("core:search","is:hidden ")})),RED.actions.add("core:list-flows",(function(){RED.actions.invoke("core:search","type:tab ")})),RED.actions.add("core:list-subflows",(function(){RED.actions.invoke("core:search","type:subflow ")})),RED.actions.add("core:go-to-previous-location",(function(){n>0&&(n===o.length&&o.push(e),RED.workspaces.show(o[--n],!0))})),RED.actions.add("core:go-to-next-location",(function(){n<o.length-1&&RED.workspaces.show(o[++n],!0)})),g()},add:l,remove:w,delete:c,order:E,edit:v,contains:function(e){return p.contains(e)},count:function(){return f},active:function(){return e},selection:function(){return p.selection()},hide:function(t){t||(t=e),p.contains(t)&&p.hideTab(t)},isHidden:function(e){return i.includes(e)},show:function(t,o,i,n){if(!p.contains(t)){var c=RED.nodes.subflow(t);if(!c)return;l({type:"subflow",id:t,icon:"red/images/subflow_tab.svg",label:c.name,closeable:!0},null,p.activeIndex()+1),d(t)}i?p.showTab(t):(o||e===t||s(e),p.activateTab(t)),n&&function(e){a&&a.length&&(clearInterval(r),r=null,a.removeClass("highlighted"),a=null);let t=$("#red-ui-tab-"+e);t&&t.length&&(r=setInterval((function(e){if(e>=Date.now()){const e=t.hasClass("highlighted");t.toggleClass("highlighted",!e)}else clearInterval(r),r=null,a=null,t.removeClass("highlighted")}),100,Date.now()+2200),a=t,t.addClass("highlighted"))}(t.replace(".","-"))},refresh:function(){RED.nodes.eachWorkspace((function(e){p.renameTab(e.id,e.label),$("#red-ui-tab-"+e.id.replace(".","-")).attr("flowname",e.label)})),RED.nodes.eachSubflow((function(e){p.contains(e.id)&&p.renameTab(e.id,e.name)})),RED.sidebar.config.refresh()},resize:function(){p.resize()},enable:m,disable:b}}(),
/*!
 RED.statusBar.add({
     id: "widget-identifier",
     align: "left|right",
     element: widgetElement
 })
*/
RED.statusBar=function(){var e,t,o={};return{init:function(){e=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-left">').appendTo("#red-ui-workspace-footer"),t=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-right">').appendTo("#red-ui-workspace-footer")},add:function(i){o[i.id]=i;var n=$('<span class="red-ui-statusbar-widget"></span>');n.prop("id",i.id),i.element.appendTo(n),"left"===i.align?e.append(n):"right"===i.align&&t.prepend(n)}}}(),RED.view=function(){var e,t,o,n,a=5e3,r=5e3,s=1,d=100,l=30,c=650,u=1e3,p=0,f=[],h=0,g={},v=20,m=!1,b=!1,y=null,w=[],E=[],D=[],R=[],x={},_=null,k=null,T=[],C={},j=null,L=null,S=null,O=null,I=0,N=null,P=[0,0],A=null,M=0,z=null,B=null,G=null,F=null,U=!1,V=null,J=null,q=0,W=0,K=[],H=null,X=-1,Y=!1,Z=[];let Q;var ee="";let te;var oe,ie,ne,ae,re,se,de,le,ce,ue,pe,fe,he,ge,ve,me={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3",gray:"#d3d3d3"},be=(fe=new Set,he=[],ge={add:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)ge.add(e[t]);else if(!fe.has(e.id)){he.push({n:e}),fe.add(e.id);for(var o=RED.nodes.getNodeLinks(e.id,1).concat(RED.nodes.getNodeLinks(e.id,0)),i=(t=0,o.length);t<i;t++){var n=o[t];(n.source===e&&fe.has(n.target.id)||n.target===e&&fe.has(n.source.id))&&ye.add(n)}}},remove:function(e,t){if(fe.has(e.id)){if(fe.delete(e.id),void 0!==t&&he[t].n===e)he.splice(t,1);else for(var o=0;o<he.length;o++)if(he[o].n===e){he.splice(o,1);break}for(var i=RED.nodes.getNodeLinks(e.id,1).concat(RED.nodes.getNodeLinks(e.id,0)),n=(o=0,i.length);o<n;o++)ye.remove(i[o])}},clear:function(){fe.clear(),he=[]},length:function(){return he.length},get:function(e){return he[e]},forEach:function(e){he.forEach(e)},nodes:function(){return he.map((function(e){return e.n}))},has:function(e){return fe.has(e.id)}},ge),ye=(ve=new Set,{add:function(e){ve.add(e),e.selected=!0},remove:function(e){ve.delete(e),e.selected=!1},clear:function(){ve.forEach((function(e){e.selected=!1})),ve.clear()},length:function(){return ve.size},forEach:function(e){ve.forEach(e)},has:function(e){return ve.has(e)},toArray:function(){return Array.from(ve)}});function we(){for(var e=[],t=0;t<a;t+=+v)e.push(t);ae.selectAll("line.red-ui-workspace-chart-grid-h").remove(),ae.selectAll("line.red-ui-workspace-chart-grid-h").data(e).enter().append("line").attr({class:"red-ui-workspace-chart-grid-h",x1:0,x2:a,y1:function(e){return e},y2:function(e){return e}}),ae.selectAll("line.red-ui-workspace-chart-grid-v").remove(),ae.selectAll("line.red-ui-workspace-chart-grid-v").data(e).enter().append("line").attr({class:"red-ui-workspace-chart-grid-v",y1:0,y2:a,x1:function(e){return e},x2:function(e){return e}})}function Ee(e){X=-1;for(var t=0;t<e.length;t++){var o=e[t];o.el=de.append("svg:path").attr("class","red-ui-flow-drag-line"),("link out"===o.node.type&&0===o.portType||"link in"===o.node.type&&1===o.portType)&&(o.el.attr("class","red-ui-flow-link-link red-ui-flow-drag-line"),o.virtualLink=!0,X=0===o.portType?1:0),pe.push(o)}-1!==X&&w.forEach((function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)}))}function De(){for(-1!==X&&w.forEach((function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)})),X=-1;pe.length;){var e=pe.pop();e.el&&e.el.remove()}}function Re(){var e=RED.workspaces.active();0!==e?((w=RED.nodes.filterNodes({z:e})).forEach((function(e,t){e._index=t})),E=RED.nodes.filterLinks({source:{z:e},target:{z:e}}),D=RED.nodes.junctions(e)||[],(T=RED.nodes.groups(e)||[]).forEach((function(e,t){e._index=t,e.g?(e._root=e.g,e._depth=1):(e._root=e.id,e._depth=0)}))):(w=[],E=[],D=[],T=[]);var t=!1;do{t=!1,T.forEach((function(e){if(e.g){var o=RED.nodes.group(e.g);if(o){var i=o._depth;e._depth!==i+1&&(e._depth=i+1,t=!0),e._root!==o._root&&(e._root=o._root,t=!0)}}}))}while(t);T.sort((function(e,t){return e._root===t._root?e._depth-t._depth:e._index-t._index})),ue.selectAll(".red-ui-flow-group").data(T,(function(e){return e.id})).sort((function(e,t){return e._root===t._root?e._depth-t._depth:e._index-t._index}))}function xe(e,t,o,i,n){var a=i-t,r=o-e,s=Math.sqrt(a*a+r*r),c=.75;if(r*n>0?s<d&&(c=.75-(d-s)/d*.75):c=.4-.2*Math.max(0,(d-Math.min(Math.abs(r),Math.abs(a)))/d),r*n>0)return"M "+e+" "+t+" C "+(e+n*(d*c))+" "+(t+0)+" "+(o-n*c*d)+" "+(i-0)+" "+o+" "+i;var u=Math.floor(o-r/2),p=Math.floor(i-a/2);0===a&&(p=i+l);var f=15,h=(i+p)/2,g=e+n*d*c,v=a>0?Math.min(h-a/2,t+f):Math.max(h-a/2,t-f),m=o-n*d*c,b=a>0?Math.max(h,i-f):Math.min(h,i+f),y=(e+g)/2,w=a>0?1:-1,E=[[y,t],[g,a>0?Math.max(t,v-f):Math.min(t,v+f)],[y,a>0?Math.min(p,v+f):Math.max(p,v-f)],[m,a>0?Math.max(p,b-f):Math.min(p,b+f)],[(o+m)/2,i]];return E[2][1]===v+w*f&&(Math.abs(a)<150&&(E[1][1]=v-w*f/2,E[3][1]=b-w*f/2),E[2][0]=g),"M "+e+" "+t+" C "+E[0][0]+" "+E[0][1]+" "+E[1][0]+" "+E[1][1]+" "+g+" "+v+" S "+E[2][0]+" "+E[2][1]+" "+u+" "+p+" S "+E[3][0]+" "+E[3][1]+" "+m+" "+b+" S "+E[4][0]+" "+E[4][1]+" "+o+" "+i}function _e(){if(RED.view.DEBUG&&console.warn("canvasMouseDown",{mouse_mode:M,point:d3.mouse(this),event:d3.event}),RED.contextMenu.hide(),M!==RED.state.SELECTING_NODE){if(1===d3.event.button)return M=RED.state.PANNING,A=[d3.event.pageX,d3.event.pageY],void(K=[oe.scrollLeft(),oe.scrollTop()]);if(2!==d3.event.button&&(L||j||S||d3.event.shiftKey||(ye.clear(),Ge()),0===M&&z&&(z.remove(),z=null),d3.event.touches||0===d3.event.button))if(0!==M&&M!==RED.state.QUICK_JOINING||!d3.event.metaKey&&!d3.event.ctrlKey||d3.event.altKey||d3.event.shiftKey){if(0===M&&!d3.event.metaKey&&!d3.event.ctrlKey)if(d3.event.altKey){if(d3.event.altKey){ze(),M=d3.event.shiftKey?RED.state.SLICING_JUNCTION:RED.state.SLICING;const e=d3.mouse(this);B=ne.append("path").attr("class","nr-ui-view-slice").attr("d",`M${e[0]} ${e[1]}`),G=e,RED.view.redraw()}}else if(!h){const e=d3.mouse(this);z=ne.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","nr-ui-view-lasso"),d3.event.preventDefault()}}else{d3.event.stopPropagation(),ze();const t=d3.mouse(this);var e=Lt(t[0],t[1]);pe.length>0&&(e=e||RED.nodes.group(pe[0].node.g)),$e({position:t,group:e})}}else d3.event.stopPropagation()}function $e(e){var t=(e=e||{}).position||Z,o=e.splice,i=e.spliceMultiple,n=e.group,a=e.touchTrigger;n&&!n.active&&(kt(n,!1),Tt(n),RED.view.redraw());var r=t[0],c=t[1];const u=$("#red-ui-workspace-chart").offset();var p=r*s+u.left-$("#red-ui-workspace-chart").scrollLeft(),f=c*s+u.top-$("#red-ui-workspace-chart").scrollTop();RED.settings.get("editor").view["view-snap-grid"]&&(t[0]=Math.round(t[0]/v)*v,t[1]=Math.round(t[1]/v)*v);var h,g=$("#red-ui-main-container").position();M!==RED.state.QUICK_JOINING&&(M=RED.state.QUICK_JOINING,$(window).on("keyup",Ye)),!0,F&&F.remove(),(F=ne.append("g").attr("transform","translate("+(t[0]-50)+","+(t[1]-15)+")")).append("rect").attr("class","red-ui-flow-node-placeholder").attr("rx",5).attr("ry",5).attr("width",d).attr("height",l).attr("fill","none"),pe.length>0&&(h=pe[0].virtualLink?{type:"link in"===pe[0].node.type?"link out":"link in"}:0===pe[0].portType?{input:!0}:{output:!0},H={node:pe[0].node,port:pe[0].port,portType:pe[0].portType},pe[0].virtualLink&&(H.virtualLink=!0),De()),(o||i)&&(h={input:!0,output:!0,spliceMultiple:i});var m,b,y=function(){if(H){H.el||(H.el=de.append("svg:path").attr("class","red-ui-flow-drag-line"));var e=-((0===H.portType&&H.node.outputs||1)-1)/2*13+13*H.port,o=0===H.portType?1:-1;H.el.attr("d",xe(H.node.x+o*H.node.w/2,H.node.y+e,t[0]-o*d/2,t[1],o))}};H&&y(),RED.typeSearch.show({x:p-g.left-50-(r-t[0]),y:f-g.top+15+5-(c-t[1]),disableFocus:a,filter:h,move:function(e,o){if(F){var i=d3.transform(F.attr("transform")).translate;F.attr("transform","translate("+(i[0]+e)+","+(i[1]+o)+")"),t[0]+=e,t[1]+=o,y()}},cancel:function(){H&&(H.el&&H.el.remove(),H=null),!1,F&&F.remove(),Xe(),Ge(),De(),At()},add:function(e,i){var r,s;if(a&&(i=!1,Xe()),/^_action_:/.test(e)){const t=e.substring(9);return!1,F.remove(),void RED.actions.invoke(t)}if("junction"===e)s={t:"add",junctions:[r={_def:{defaults:{}},type:"junction",z:RED.workspaces.active(),id:RED.nodes.id(),x:0,y:0,w:0,h:0,outputs:1,inputs:1,dirty:!0}]};else{var d=Ut(e);if(!d)return;r=d.node,s=d.historyEvent}i&&(M=RED.state.QUICK_JOINING),r.x=t[0],r.y=t[1];var l=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");if(void 0===l||r._def.hasOwnProperty("showLabel")&&!r._def.showLabel||r._def.defaults.hasOwnProperty("l")||(r.l=l),H){var c,u,p=H,f=null;if(0===p.portType&&(r.inputs>0||p.virtualLink)?(f=p.node,u=p.port,c=r):1===p.portType&&(r.outputs>0||p.virtualLink)&&(f=r,c=p.node,u=0),null!==f){if(p.virtualLink){s={t:"multi",events:[s]};var h=$.extend(!0,{},{v:f.links}).v,g=$.extend(!0,{},{v:c.links}).v;f.links.push(c.id),c.links.push(f.id),f.dirty=!0,c.dirty=!0,s.events.push({t:"edit",node:f,dirty:RED.nodes.dirty(),changed:f.changed,changes:{links:h}}),s.events.push({t:"edit",node:c,dirty:RED.nodes.dirty(),changed:c.changed,changes:{links:g}}),f.changed=!0,c.changed=!0}else{var w={source:f,sourcePort:u,target:c};RED.nodes.addLink(w),s.links=[w]}i?(H.node=r,H.port=0):(H.el.remove(),H=null,M===RED.state.QUICK_JOINING&&(0===p.portType&&r.outputs>0?Ee([{node:r,port:0,portType:0}]):!H&&1===p.portType&&r.inputs>0?Ee([{node:r,port:0,portType:1}]):Xe()))}else De(),Xe()}else i?r.outputs>0?H={node:r,port:0,portType:0}:r.inputs>0?H={node:r,port:0,portType:1}:Xe():M===RED.state.QUICK_JOINING&&(r.outputs>0?Ee([{node:r,port:0,portType:0}]):r.inputs>0?Ee([{node:r,port:0,portType:1}]):Xe());if("junction"===r.type?RED.nodes.addJunction(r):RED.nodes.add(r),RED.editor.validateNode(r),n&&(RED.group.addToGroup(n,r),"multi"!==s.t&&(s={t:"multi",events:[s]}),s.events.push({t:"addToGroup",group:n,nodes:r})),o){Xe(),RED.nodes.removeLink(o);var E={source:o.source,sourcePort:o.sourcePort,target:r},D={source:r,sourcePort:0,target:o.target};RED.nodes.addLink(E),RED.nodes.addLink(D),s.links=(s.links||[]).concat([E,D]),s.removedLinks=[o]}if(RED.history.push(s),RED.nodes.dirty(!0),ze(),r.selected=!0,n&&(kt(n,!1),Tt(n)),be.add(r),Re(),Ge(),At(),void 0!==m){var R=m+b/2,x=r.x-r.w/2-R;x!=2*v&&(r.x=r.x+2*v-x,r.dirty=!0,r.x=Math.ceil(r.x/v)*v,At())}i?(void 0===m&&setTimeout((function(){RED.typeSearch.refresh({filter:{input:!0}})}),100),m=r.x,b=r.w,t[0]=r.x+r.w/2+50+2*v,F.attr("transform","translate("+(t[0]-50)+","+(t[1]-15)+")"),y()):(!1,F.remove())}}),Re(),Ge(),At()}function ke(){var i;if(M===RED.state.PANNING){var n=[d3.event.pageX,d3.event.pageY];if(d3.event.touches){var d=d3.event.touches.item(0);n=[d.pageX,d.pageY]}var l=[A[0]-n[0],A[1]-n[1]];return oe.scrollLeft(K[0]+l[0]),void oe.scrollTop(K[1]+l[1])}if(A=d3.touches(this)[0]||d3.mouse(this),z){var c,u,p=parseInt(z.attr("ox")),f=parseInt(z.attr("oy")),h=parseInt(z.attr("x")),g=parseInt(z.attr("y"));return c=A[0]<p?p-(h=A[0]):A[0]-h,u=A[1]<f?f-(g=A[1]):A[1]-g,void z.attr("x",h).attr("y",g).attr("width",c).attr("height",u)}if(M!==RED.state.SLICING&&M!==RED.state.SLICING_JUNCTION)if(M!==RED.state.SELECTING_NODE){if(M==RED.state.QUICK_JOINING||M==RED.state.IMPORT_DRAGGING||M==RED.state.DETACHED_DRAGGING||L||S||0!==ye.length()){var y;if(M==RED.state.JOINING||M===RED.state.QUICK_JOINING){if(0===pe.length&&null!==O){if(d3.event.shiftKey){var w,E=[],D=[];if(ye.length()>0)ye.forEach((function(e){(0===O&&e.source===L&&e.sourcePort===I||1===O&&e.target===L)&&D.push(e)}));else w=0===O?{source:L,sourcePort:I}:{target:L},D=RED.nodes.filterLinks(w);for(X=0;X<D.length;X++){var R=D[X];RED.nodes.removeLink(R),E.push({link:R,node:0===O?R.target:R.source,port:0===O?0:R.sourcePort,portType:0===O?1:0})}0===E.length?(Xe(),At()):(Ee(E),M=0,Re(),At(),M=RED.state.JOINING)}else L&&!H&&Ee([{node:L,port:I,portType:O}]);ye.clear()}for(y=A,X=0;X<pe.length;X++){var x=pe[X],_=-((0===x.portType&&x.node.outputs||1)-1)/2*13+13*x.port,$=0===x.portType?1:-1;x.el.attr("d",xe(x.node.x+$*x.node.w/2,x.node.y+_,y[0],y[1],$))}d3.event.preventDefault()}else if(M==RED.state.MOVING){y=d3.mouse(document.body),isNaN(y[0])&&(y=d3.touches(document.body)[0]);var C=(P[0]-y[0])*(P[0]-y[0])+(P[1]-y[1])*(P[1]-y[1]);(C>3&&!J||J&&C>10)&&(M=RED.state.MOVING_ACTIVE,W=0,b=!1,1===be.length()&&(i=be.get(0),b=i.n.hasOwnProperty("_def")&&(i.n.hasOwnProperty("inputs")&&i.n.inputs>0||!i.n.hasOwnProperty("inputs")&&i.n._def.inputs>0)&&(i.n.hasOwnProperty("outputs")&&i.n.outputs>0||!i.n.hasOwnProperty("outputs")&&i.n._def.outputs>0)&&0===RED.nodes.filterLinks({source:i.n}).length&&0===RED.nodes.filterLinks({target:i.n}).length))}else if(M==RED.state.MOVING_ACTIVE||M==RED.state.IMPORT_DRAGGING||M==RED.state.DETACHED_DRAGGING){y=A;for(var j=0,N=0,F=a,U=r,V=0;V<be.length();V++)i=be.get(V),d3.event.shiftKey&&(i.n.ox=i.n.x,i.n.oy=i.n.y),i.n.x=y[0]+i.dx,i.n.y=y[1]+i.dy,i.n.dirty=!0,"group"===i.n.type?(!1!==i.n.groupMoved&&(i.n.groupMoved=!0),RED.group.markDirty(i.n),j=Math.min(i.n.x-5,j),N=Math.min(i.n.y-5,N),F=Math.max(i.n.x+i.n.w+5,F),U=Math.max(i.n.y+i.n.h+5,U)):(j=Math.min(i.n.x-i.n.w/2-5,j),N=Math.min(i.n.y-i.n.h/2-5,N),F=Math.max(i.n.x+i.n.w/2+5,F),U=Math.max(i.n.y+i.n.h/2+5,U));if(0!==j||0!==N)for(X=0;X<be.length();X++)(i=be.get(X)).n.x-=j,i.n.y-=N;if(F!==a||U!==r)for(X=0;X<be.length();X++)(i=be.get(X)).n.x-=F-a,i.n.y-=U-r;var q=[0,0];if(m!=d3.event.shiftKey&&be.length()>0){var X=0;do{i=be.get(X++)}while(X<be.length()&&"group"===i.n.type);if("group"===i.n.type)q[0]=i.n.x-v*Math.floor(i.n.x/v)-v/2,q[1]=i.n.y-v*Math.floor(i.n.y/v)-v/2;else{const e=RED.view.tools.calculateGridSnapOffsets(i.n);q[0]=e.x,q[1]=e.y}if(0!==q[0]||0!==q[1])for(X=0;X<be.length();X++)(i=be.get(X)).n.x-=q[0],i.n.y-=q[1],i.n.x==i.n.ox&&i.n.y==i.n.oy&&(i.dirty=!1)}1===be.length()&&"group"!==be.get(0).n.type&&(i=be.get(0),b&&(t||(t=setTimeout((function(){var o=[],n=1/0,a=null,r=i.n.x,d=i.n.y;if(ie[0][0].getIntersectionList){var l=ie[0][0].createSVGRect();l.x=r*s,l.y=d*s,l.width=1,l.height=1,o=ie[0][0].getIntersectionList(l,ie[0][0])}else o=RED.view.getLinksAtPoint(r*s,d*s);for(var c=0;c<o.length;c++)if(d3.select(o[c]).classed("red-ui-flow-link-background"))for(var u=o[c].getTotalLength(),p=0;p<u;p+=10){var f=o[c].getPointAtLength(p),h=(f.x-r)*(f.x-r)+(f.y-d)*(f.y-d);h<200&&h<n&&(n=h,a=o[c])}e&&e!==a&&d3.select(e.parentNode).classed("red-ui-flow-link-splice",!1),a?d3.select(a.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),e=a,t=null}),100))),"subflow"!==i.n.type&&!i.n.g&&T&&(o||(o=setTimeout((function(){k=Lt(i.n.x,i.n.y);for(var e=0;e<T.length;e++){var t=T[e];t===k?(t.hovered=!0,t.dirty=!0):t.hovered&&(t.hovered=!1,t.dirty=!0)}o=null}),50))))}0!==M&&At()}}else d3.event.stopPropagation();else if(B&&Math.max(1,Math.abs(G[0]-A[0]))*Math.max(1,Math.abs(G[1]-A[1]))>20){var Y=B.attr("d");Y+=" L"+A[0]+" "+A[1],B.attr("d",Y),G=A}}function Te(){0!==M&&0!==d3.event.buttons&&d3.select(document).on("mouseup.red-ui-workspace-tracker",(function(){d3.select(document).on("mouseup.red-ui-workspace-tracker",null),Ce.call(this)}))}function Ce(){var t;if(Z=[d3.event.offsetX/s,d3.event.offsetY/s],RED.view.DEBUG&&console.warn("canvasMouseUp",{mouse_mode:M,point:d3.mouse(this),event:d3.event}),2!==d3.event.button)if(M!==RED.state.PANNING)if(M!==RED.state.SELECTING_NODE){if(M!==RED.state.QUICK_JOINING){if(L&&M==RED.state.JOINING){var o=[];for(t=0;t<pe.length;t++)pe[t].link&&o.push(pe[t].link);o.length>0&&(m={t:"delete",links:o,dirty:RED.nodes.dirty()},RED.history.push(m),RED.nodes.dirty(!0)),De()}if(z){var i=parseInt(z.attr("x")),n=parseInt(z.attr("y")),a=i+parseInt(z.attr("width")),r=n+parseInt(z.attr("height")),d=_;d3.event.shiftKey||(ze(),d&&i<d.x+d.w&&a>d.x&&n<d.y+d.h&&r>d.y&&(Tt(d),_.selected=!0)),T.forEach((function(e){if(!e.selected&&e.x>i&&e.x+e.w<a&&e.y>n&&e.y+e.h<r&&(!_||RED.group.contains(_,e))){for(;e.g&&(!_||e.g!==_.id);)e=RED.nodes.group(e.g);e.selected||kt(e,!0)}})),w.forEach((function(e){if(!e.selected&&e.x>i&&e.x<a&&e.y>n&&e.y<r&&(!_||RED.group.contains(_,e)))if(!e.g||_&&e.g===_.id)e.selected=!0,e.dirty=!0,be.add(e);else{for(var t=RED.nodes.group(e.g);t.g&&(!_||t.g!==_.id);)t=RED.nodes.group(t.g);t.selected||kt(t,!0)}})),D.forEach((function(e){e.selected||e.x>i&&e.x<a&&e.y>n&&e.y<r&&(e.selected=!0,e.dirty=!0,be.add(e))})),E.forEach((function(e){if(!e.selected){var t=e.source.y,o=e.target.y,s=e.source.x+e.source.w/2+10,d=e.target.x-e.target.w/2-10;s>i&&s<a&&t>n&&t<r&&d>i&&d<a&&o>n&&o<r&&ye.add(e)}})),y&&(y.in.forEach((function(e){e.selected=e.x>i&&e.x<a&&e.y>n&&e.y<r,e.selected&&(e.dirty=!0,be.add(e))})),y.out.forEach((function(e){e.selected=e.x>i&&e.x<a&&e.y>n&&e.y<r,e.selected&&(e.dirty=!0,be.add(e))})),y.status&&(y.status.selected=y.status.x>i&&y.status.x<a&&y.status.y>n&&y.status.y<r,y.status.selected&&(y.status.dirty=!0,be.add(y.status)))),Ge(),z.remove(),z=null}else M!=RED.state.DEFAULT||null!=j||d3.event.ctrlKey||d3.event.metaKey?M==RED.state.SLICING?(Ue(),B.remove(),B=null,RED.view.redraw(!0)):M==RED.state.SLICING_JUNCTION&&(RED.actions.invoke("core:split-wires-with-junctions"),B.remove(),B=null):(ze(),Ge());if(M==RED.state.MOVING_ACTIVE&&be.length()>0){var l=null;if(k){for(var c=0;c<be.length();c++){var u=be.get(c);RED.group.addToGroup(k,u.n)}l=k,k.hovered=!1,Tt(k),_.selected=!0,k=null}var p=[];for(c=0;c<be.length();c++){(u=be.get(c)).ox===u.n.x&&u.oy===u.n.y||(p.push({n:u.n,ox:u.ox,oy:u.oy,moved:u.n.moved}),u.n.dirty=!0,u.n.moved=!0)}if(p.length>0&&M==RED.state.MOVING_ACTIVE){if(m={t:"move",nodes:p,dirty:RED.nodes.dirty()},e){var f=d3.select(e).data()[0];RED.nodes.removeLink(f);var h={source:f.source,sourcePort:f.sourcePort,target:be.get(0).n},g={source:be.get(0).n,sourcePort:0,target:f.target};RED.nodes.addLink(h),RED.nodes.addLink(g),m.links=[h,g],m.removedLinks=[f],Re()}l&&(m.addToGroup=l),RED.nodes.dirty(!0),RED.history.push(m)}}if(M==RED.state.MOVING||M==RED.state.MOVING_ACTIVE||M==RED.state.DETACHED_DRAGGING){if(M===RED.state.DETACHED_DRAGGING){for(p=[],c=0;c<be.length();c++){(u=be.get(c)).ox===u.n.x&&u.oy===u.n.y||(p.push({n:u.n,ox:u.ox,oy:u.oy,moved:u.n.moved}),u.n.dirty=!0,u.n.moved=!0)}var v=RED.history.peek(),m={t:"move",nodes:p,dirty:RED.nodes.dirty()};"multi"===v.t?v.events.push(m):RED.history.push(m)}for(t=0;t<be.length();t++){var b=be.get(t);delete b.ox,delete b.oy}}M==RED.state.IMPORT_DRAGGING&&("cut"===te&&(te="copy"),Re(),RED.nodes.dirty(!0)),Xe(),At()}}else d3.event.stopPropagation();else Xe()}function je(){s<2&&Pe(s+.1)}function Le(){s>.3&&Pe(s-.1)}function Se(){Pe(1)}function Oe(){RED.actions.invoke("core:search",$(this).data("term"))}function Ie(){RED.actions.invoke("core:search-previous")}function Ne(){RED.actions.invoke("core:search-next")}function Pe(e){var t=[oe.width(),oe.height()],o=[oe.scrollLeft(),oe.scrollTop()],i=[(o[0]+t[0]/2)/s,(o[1]+t[1]/2)/s],n=[(o[0]+t[0]/2)/(s=e),(o[1]+t[1]/2)/s],a=[(n[0]-i[0])*s,(n[1]-i[1])*s];oe.scrollLeft(o[0]-a[0]),oe.scrollTop(o[1]-a[1]),RED.view.navigator.resize(),At(),RED.settings.get("editor.view.view-store-zoom")&&RED.settings.setLocal("zoom-level",e.toFixed(1))}function Ae(){if(M!==RED.state.MOVING&&M!==RED.state.MOVING_ACTIVE){if(M===RED.state.DETACHED_DRAGGING){for(var e=0;e<be.length();e++){var t=be.get(e);t.n.x=t.ox,t.n.y=t.oy}ze(),RED.history.pop(),M=0}else M===RED.state.IMPORT_DRAGGING?(ze(),RED.history.pop(),M=0):M===RED.state.SLICING||M===RED.state.SLICING_JUNCTION?(B&&(B.remove(),B=null,Xe()),ze()):z?(z.remove(),z=null):_?Ct():ze();At()}}function Me(){if(M!==RED.state.SELECTING_NODE||!n.single){if(ye.clear(),_){var e=_;ze(),Tt(e),RED.group.getNodes(e,!1).forEach((function(e){"group"===e.type?kt(e,!0,!0):(be.add(e),e.selected=!0,e.dirty=!0)})),_.selected=!0}else ze(),Ct(),T.forEach((function(e){e.g?(e.selected=!1,e.dirty=!0):(kt(e,!0),e.selected||(e.selected=!0,e.dirty=!0))})),w.forEach((function(e){M===RED.state.SELECTING_NODE&&n.filter&&!n.filter(e)||e.g||e.selected||(e.selected=!0,e.dirty=!0,be.add(e))})),D.forEach((function(e){e.selected||(e.selected=!0,e.dirty=!0,be.add(e))})),M!==RED.state.SELECTING_NODE&&y&&(y.in.forEach((function(e){e.selected||(e.selected=!0,e.dirty=!0,be.add(e))})),y.out.forEach((function(e){e.selected||(e.selected=!0,e.dirty=!0,be.add(e))})),y.status&&(y.status.selected||(y.status.selected=!0,y.status.dirty=!0,be.add(y.status))));M!==RED.state.SELECTING_NODE&&Ge(),At()}}function ze(){RED.view.DEBUG&&console.warn("clearSelection",M,"movingSet.length():",be.length());for(var e=0;e<be.length();e++){var t=be.get(e);t.n.dirty=!0,t.n.selected=!1}be.clear(),ye.clear(),_&&(_.active=!1,_.dirty=!0,_=null),T.forEach((function(e){e.selected=!1,e.dirty=!0}))}var Be=null;function Ge(){var e={},t=RED.workspaces.active(),o=RED.workspaces.selection();if(0!==t)if(0===o.length){e=Ft(),E=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var i={};R=[],Object.keys(x).forEach((function(e){x[e].dirty=!0})),x={};for(var n=0;n<be.length();n++){var a=be.get(n);if(("link out"===a.n.type&&"return"!==a.n.mode||"link in"===a.n.type)&&a.n.z===t){var r=a.n;x[r.id]=r;var s={};r.links.forEach((function(e){var t=RED.nodes.node(e);t&&("link out"===r.type?t.z===r.z?i[r.id+":"+t.id]||(E.push({source:r,sourcePort:0,target:t,link:!0}),i[r.id+":"+t.id]=!0,x[t.id]=t,t.dirty=!0):(s[t.z]=s[t.z]||[],s[t.z].push(t)):t.z===r.z?i[t.id+":"+r.id]||(E.push({source:t,sourcePort:0,target:r,link:!0}),i[t.id+":"+r.id]=!0,x[t.id]=t,t.dirty=!0):(s[t.z]=s[t.z]||[],s[t.z].push(t)))})),Object.keys(s).length>0&&R.push({refresh:Math.floor(1e4*Math.random()),node:r,links:s})}}0===R.length&&ye.length()>0&&ye.forEach((function(e){e.link&&(E.push(e),x[e.source.id]=e.source,e.source.dirty=!0,x[e.target.id]=e.target,e.target.dirty=!0)}))}else e.flows=o;var d=t+":"+JSON.stringify(e,(function(e,t){return"nodes"===e||"flows"===e?t.map((function(e){return e.id})):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:"links"===e?t.map((function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id})):t}));d!==Be&&(Be=d,RED.events.emit("view:selection-changed",e))}function Fe(){if(be.length()>0){var e=be.get(0).n;"subflow"===e.type?RED.editor.editSubflow(y):"group"===e.type?RED.editor.editGroup(e):RED.editor.edit(e)}}function Ue(e){if(M!==RED.state.SELECTING_NODE){ot&&(ot.remove(),ot=null);var t=RED.workspaces.selection();if(t.length>0){var o=0;if(t.forEach((function(e){"tab"===e.type&&o++})),o===RED.workspaces.count())return;for(var i={t:"delete",dirty:RED.nodes.dirty(),nodes:[],links:[],groups:[],junctions:[],workspaces:[],subflows:[]},n=RED.nodes.getWorkspaceOrder().slice(0),a=0;a<t.length;a++){var r,s=t[a];s._index=n.indexOf(s.id),RED.workspaces.remove(s),"tab"===s.type?(i.workspaces.push(s),r=RED.nodes.removeWorkspace(s.id)):(r=RED.subflow.removeSubflow(s.id),i.subflows=i.subflows.concat(r.subflows)),i.nodes=i.nodes.concat(r.nodes),i.links=i.links.concat(r.links),i.groups=i.groups.concat(r.groups),i.junctions=i.junctions.concat(r.junctions)}RED.history.push(i),RED.nodes.dirty(!0),Re(),Ge(),At()}else if(be.length()>0||ye.length()>0){var d,l,c=[],u=[],p=[],f=[],h=[],g=[],v=[],m=[],b=function(e){e&&(Array.isArray(e)?e:[e]).forEach((function(e){u.push(e),ye.remove(e)}))};if(e){var w=RED.nodes.detachNodes(be.nodes()),E=w.newLinks;E.length>0&&m.push({t:"add",links:E}),b(w.removedLinks)}var D=RED.nodes.dirty(),R=[];if(be.length()>0){for(a=0;a<be.length();a++)"group"===(d=be.get(a).n).type&&R.push(d);for(a=0;a<R.length;a++)R[a].nodes.forEach((function(e){"group"===e.type&&-1===R.indexOf(e)&&R.push(e)}));for(a=0;a<be.length();a++)if((d=be.get(a).n).selected=!1,"group"!==d.type&&"subflow"!==d.type&&"junction"!==d.type){d.x<0&&(d.x=25);var x=RED.nodes.remove(d.id);if(c.push(d),c=c.concat(x.nodes),b(x.links),d.g){var _=RED.nodes.group(d.g);if(-1===R.indexOf(_)){var k=_.nodes.indexOf(d);_.nodes.splice(k,1),RED.group.markDirty(_)}}}else if("junction"===d.type){var T=RED.nodes.removeJunction(d);f.push(d),u=u.concat(T.links)}else"out"===d.direction?h.push(d):"in"===d.direction?g.push(d):"status"===d.direction&&(l=d),d.dirty=!0;for(a=R.length-1;a>=0;a--){var C=R[a];p.push(C),RED.nodes.removeGroup(C)}h.length>0&&(T=RED.subflow.removeOutput(h))&&b(T.links),1==g.length&&(T=RED.subflow.removeInput())&&b(T.links),l&&(T=RED.subflow.removeStatus())&&b(T.links);var j=RED.subflow.refresh(!0);j&&(v=j.instances),be.clear(),(c.length>0||h.length>0||g.length>0||l||p.length>0||f.length>0)&&RED.nodes.dirty(!0)}ye.length()>0&&ye.forEach((function(e){if(e.link){var t=e.source.id,o=e.target.id,i=e.target.links.indexOf(t),n=e.source.links.indexOf(o);m.push({t:"edit",node:e.source,changed:e.source.changed,changes:{links:$.extend(!0,{},{v:e.source.links}).v}}),m.push({t:"edit",node:e.target,changed:e.target.changed,changes:{links:$.extend(!0,{},{v:e.target.links}).v}}),e.source.changed=!0,e.target.changed=!0,e.target.links.splice(i,1),e.source.links.splice(n,1),e.source.dirty=!0,e.target.dirty=!0}else RED.nodes.removeLink(e),u.push(e)})),RED.nodes.dirty(!0);i={t:"delete",nodes:c,links:u,groups:p,junctions:f,subflowOutputs:h,subflowInputs:g,subflow:{id:y?y.id:void 0,instances:v},dirty:D};l&&(i.subflow.status=l),m.length>0?(m.unshift(i),RED.history.push({t:"multi",events:m})):RED.history.push(i),ye.clear(),Re(),Ge(),At()}}}function Ve(e){if(M!==RED.state.SELECTING_NODE){var t=[],o=RED.workspaces.selection();if(o.length>0?(t=[],o.forEach((function(e){"tab"===e.type&&(t.push(e),t=(t=t.concat(RED.nodes.groups(e.id))).concat(RED.nodes.filterNodes({z:e.id})))}))):(o=RED.view.selection()).nodes&&o.nodes.forEach((function(e){t.push(e),"group"===e.type&&(t=t.concat(RED.group.getNodes(e,!0)))})),t.length>0){for(var i=[],n=0,a=0,r={},s=0;s<t.length;s++){var d=t[s];if(!r[d.id]&&(r[d.id]=!0,"subflow"!=d.type)){for(var l in"group"===d.type?a++:"junction"===d.type?0:n++,d._def.defaults)if(d._def.defaults.hasOwnProperty(l)&&d._def.defaults[l].type){var c=RED.nodes.node(d[l]);c&&c._def.exclusive&&i.push(RED.nodes.convertNode(c))}i.push(RED.nodes.convertNode(d))}}ee=JSON.stringify(i),te=e?"cut":"copy",RED.menu.setDisabled("menu-item-edit-paste",!1),n>0?RED.notify(RED._("clipboard.nodeCopied",{count:n}),{id:"clipboard"}):a>0&&RED.notify(RED._("clipboard.groupCopied",{count:a}),{id:"clipboard"})}}}function Je(e,t){for(var o=He(e),i=0,n=0;n<o.length;n++){var a=Ke(o[n],t)[0];i<a&&(i=a)}return{lines:o,width:i}}var qe={},We={};function Ke(e,t){var o="!"+e;if(qe[t]){if(We[t][o])return We[t][o]}else qe[t]=document.createElement("span"),qe[t].className=t,qe[t].style.position="absolute",qe[t].style.top="-1000px",document.getElementById("red-ui-editor").appendChild(qe[t]),We[t]={};qe[t].textContent=e||"";var i=qe[t].offsetWidth,n=qe[t].offsetHeight;return We[t][o]=[i,n],We[t][o]}function He(e){var t=[],o=e.split(/\\n /);if(o.length>1){var i=0;for(i=0;i<o.length-1;i++)/\\$/.test(o[i])?(t.push(o[i]+"\\n "+o[i+1]),i++):t.push(o[i]);i===o.length-1&&t.push(o[o.length-1])}else t=o;return t=t.map((function(e){return e.replace(/\\\\n /g,"\\n ").trim()}))}function Xe(){L=null,S=null,null,N=null,j=null,M=0,O=null,e=null,b=!1,k&&(k.hovered=!1,k=null),d3.selectAll(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),t&&(clearTimeout(t),t=null),o&&(clearTimeout(o),o=null)}function Ye(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(Xe(),De(),At(),$(window).off("keyup",Ye))}function Ze(e,t,o,i){RED.view.DEBUG&&console.warn("portMouseDown",M,e,t,o),RED.contextMenu.hide(),1!==(i=i||d3.event)&&(M!==RED.state.SELECTING_NODE?(L=e,O=t,I=o||0,M!==RED.state.QUICK_JOINING&&(M=RED.state.JOINING,document.body.style.cursor="crosshair",(i.ctrlKey||i.metaKey)&&(M=RED.state.QUICK_JOINING,Ee([{node:L,port:I,portType:O}]),$(window).on("keyup",Ye))),i.stopPropagation(),i.preventDefault()):i.stopPropagation())}function Qe(e,t,o,i){if(RED.view.DEBUG&&console.warn("portMouseUp",M,e,t,o),i=i||d3.event,M!==RED.state.SELECTING_NODE){if(M===RED.state.QUICK_JOINING&&pe.length>0){if(pe[0].node===e)return;if(pe[0].virtualLink&&("link in"===pe[0].node.type&&"link out"!==e.type||"link out"===pe[0].node.type&&"link in"!==e.type))return}if(document.body.style.cursor="",M==RED.state.JOINING||M==RED.state.QUICK_JOINING){if("undefined"!=typeof TouchEvent&&i instanceof TouchEvent){var n=!1;if(RED.nodes.eachNode((function(e){if(e.z==RED.workspaces.active()){var i=e.w/2,a=e.h/2;e.x-i<A[0]&&e.x+i>A[0]&&e.y-a<A[1]&&e.y+a>A[1]&&(n=!0,t=(N=e).inputs>0?1:0,o=0)}})),!n&&y){var a=[];y.status&&a.push(y.status),y.in&&(a=a.concat(y.in)),y.out&&(a=a.concat(y.out));for(var r=0;r<a.length;r++){var s=a[r],d=s.w/2,l=s.h/2;if(s.x-d<A[0]&&s.x+d>A[0]&&s.y-l<A[1]&&s.y+l>A[1]){n=!0,t="in"===(N=s).direction?0:1,o=0;break}}}}else N=e;var c=[],u=[],p=[],f=null;for(r=0;r<pe.length;r++)pe[r].link&&u.push(pe[r].link);var h=[];for(r=0;r<pe.length;r++)if(t!=pe[r].portType&&N!==pe[r].node){var g,v,m,b=pe[r];0===b.portType?(g=b.node,m=b.port,v=N):1===b.portType&&(g=N,v=b.node,m=o||0);var w={source:g,sourcePort:m,target:v};if(b.virtualLink){if(/^link (in|out)$/.test(g.type)&&/^link (in|out)$/.test(v.type)&&g.type!==v.type&&-1===g.links.indexOf(v.id)&&-1===v.links.indexOf(g.id)){var D=$.extend(!0,{},{v:g.links}).v,R=$.extend(!0,{},{v:v.links}).v;g.links.push(v.id),v.links.push(g.id),g.dirty=!0,v.dirty=!0,p.push(g),p.push(v),w.link=!0,E.push(w),x[g.id]=g,x[v.id]=v,f=w,h.push({t:"edit",node:g,dirty:RED.nodes.dirty(),changed:g.changed,changes:{links:D}}),h.push({t:"edit",node:v,dirty:RED.nodes.dirty(),changed:v.changed,changes:{links:R}}),g.changed=!0,v.changed=!0}}else if(!("link out"===e.type&&0===t||"link in"===e.type&&1===t||0===t&&"subflow"!==N.type&&0===N.outputs||1===t&&"subflow"!==N.type&&0===N.inputs||1===b.portType&&"subflow"===N.type&&("status"===N.direction||"out"===N.direction)||0===b.portType&&"subflow"===N.type&&"in"===N.direction))0!==RED.nodes.filterLinks({source:g,target:v,sourcePort:m}).length||(RED.nodes.addLink(w),c.push(w))}if(c.length>0||u.length>0||p.length>0){var _;if(_=p.length>0?{t:"multi",events:h,dirty:RED.nodes.dirty()}:{t:"add",links:c,removedLinks:u,dirty:RED.nodes.dirty()},y){var k=RED.subflow.refresh(!0);k&&(_.subflow={id:y.id,changed:y.changed,instances:k.instances})}RED.history.push(_),Re(),RED.nodes.dirty(!0)}if(M===RED.state.QUICK_JOINING)return(c.length>0||p.length>0)&&(De(),1===t&&e.outputs>0?Ee([{node:e,port:0,portType:0}]):0===t&&e.inputs>0?Ee([{node:e,port:0,portType:1}]):Xe(),j=f,f?(ye.clear(),ye.add(f),Ge()):ye.clear()),void At();Xe(),De(),f&&(ye.clear(),ye.add(f)),j=f,f&&Ge(),At()}}else i.stopPropagation()}var et,tt=null,ot=null;function it(e){var t=d3.select(e);if("red-ui-workspace-chart-event-layer"===t.attr("class"))return[0,0];var o=[0,0];if("g"===e.nodeName.toLowerCase()){var i=t.attr("transform");i&&(o=d3.transform(i).translate)}else o=[t.attr("x")||0,t.attr("y")||0];var n=it(e.parentNode);return[o[0]+n[0],o[1]+n[1]]}function nt(e,t,o){var i,n=1===t?e.inputLabels:e.outputLabels;if(n&&n[o])return n[o];var a=1===t?e._def.inputLabels:e._def.outputLabels;if("string"==typeof a)i=a;else if("function"==typeof a)try{i=a.call(e,o)}catch(o){console.log("Definition error: "+e.type+"."+(1===t?"inputLabels":"outputLabels"),o),i=null}else $.isArray(a)&&(i=a[o]);return i}function at(e,t,o,i){var n=ne.append("g").attr("transform","translate("+e+","+t+")").attr("class","red-ui-flow-port-tooltip"),a=o.indexOf("\\n ");a>-1&&"\\"!==o[a-1]&&(o=o.substring(0,a)+"...");var r=o.split("\n"),s=6,d=12,l=[],c=0;r.forEach((function(e,t){var o=Ke(e||"&nbsp;","red-ui-flow-port-tooltip-label");s=Math.max(s,o[0]+14),l.push(o[1]),0===t&&(c=o[1]),d+=o[1]}));var u,p,f,h=s/2-5-2,g=d/2-5-2,v=d-4,m=-d/2;return"left"===i?(u="M0 0 l -5 -5 v -"+g+" q 0 -2 -2 -2 h -"+s+" q -2 0 -2 2 v "+v+" q 0 2 2 2 h "+s+" q 2 0 2 -2 v -"+g+" l 5 -5",p=-14,f="end"):"right"===i?(u="M0 0 l 5 -5 v -"+g+" q 0 -2 2 -2 h "+s+" q 2 0 2 2 v "+v+" q 0 2 -2 2 h -"+s+" q -2 0 -2 -2 v -"+g+" l -5 -5",p=14,f="start"):"top"===i&&(u="M0 0 l 5 -5 h "+h+" q 2 0 2 -2 v -"+d+" q 0 -2 -2 -2 h -"+(s-4)+" q -2 0 -2 2 v "+d+" q 0 2 2 2 h "+h+" l 5 5",p=-s/2+6,m=-d-c+12,f="start"),n.append("path").attr("d",u),r.forEach((function(e,t){m+=l[t],n.append("svg:text").attr("class","red-ui-flow-port-tooltip-label").attr("x",p).attr("y",m).attr("text-anchor",f).text(e||" ")})),n}function rt(e,t,o,i){if(M!==RED.state.SELECTING_NODE){clearTimeout(tt);var n=M!=RED.state.JOINING&&M!=RED.state.QUICK_JOINING||pe.length>0&&pe[0].portType!==o&&(!pe[0].virtualLink||"link in"===pe[0].node.type&&"link out"===t.type||"link out"===pe[0].node.type&&"link in"===t.type);n&&(1===o&&(t._def&&t._def.inputLabels||t.inputLabels)||0===o&&(t._def&&t._def.outputLabels||t.outputLabels))&&(tt=setTimeout((function(){const n=e&&e.node();n&&n.__data__&&n.__data__.id;if(n&&n.parentNode&&RED.nodes.node(n.__data__.id)){var a=nt(t,o,i);if(a){var r=it(n);tt=null,ot=at(r[0]+(1===o?-2:12),r[1]+5,a,1===o?"left":"right")}}}),500)),e.classed("red-ui-flow-port-hovered",n)}else d3.event.stopPropagation()}function st(e,t,o,i){M!==RED.state.SELECTING_NODE?(clearTimeout(tt),ot&&(ot.remove(),ot=null),e.classed("red-ui-flow-port-hovered",!1)):d3.event.stopPropagation()}function dt(e){for(M=RED.state.MOVING,i=0;i<be.length();i++){var t=be.get(i);t.ox=t.n.x,t.oy=t.n.y,t.dx=t.n.x-e[0],t.dy=t.n.y-e[1]}try{P=d3.mouse(document.body),isNaN(P[0])&&(P=d3.touches(document.body)[0])}catch(e){P=[0,0]}}function lt(e){if(RED.view.DEBUG&&console.warn("nodeMouseUp",M,e),M!==RED.state.SELECTING_NODE){if(J&&L==e&&W>0&&W<c)return M=RED.state.DEFAULT,"subflow"!=e.type?/^subflow:/.test(e.type)&&(d3.event.ctrlKey||d3.event.metaKey)?RED.workspaces.show(e.type.substring(8)):RED.editor.edit(e):RED.editor.editSubflow(y),W=0,void d3.event.stopPropagation();if(M===RED.state.MOVING&&!Y&&!e.selected&&e.g&&RED.nodes.group(e.g).selected){ze(),kt(RED.nodes.group(e.g),!1),Tt(RED.nodes.group(e.g)),L.selected=!0,be.add(L);var t=d3.touches(this)[0]||d3.mouse(this);return t[0]+=e.x-e.w/2,t[1]+=e.y-e.h/2,dt(t),void Ge()}Y=!1;var o=e._def?e.inputs>0?1:0:"in"==e.direction?0:1,i=!1;M!==RED.state.JOINING&&M!==RED.state.QUICK_JOINING||(i=!0,pe.length>0&&(pe[0].virtualLink?"link in"===e.type?o=1:"link out"===e.type&&(o=0):o=1===pe[0].portType?0:1)),Qe(e,o,0),i&&d3.selectAll(".red-ui-flow-port-hovered").classed("red-ui-flow-port-hovered",!1)}else d3.event.stopPropagation()}function ct(t){if(RED.view.DEBUG&&console.warn("nodeMouseDown",M,t),zt(),RED.contextMenu.hide(),1!==d3.event.button){if(M==RED.state.IMPORT_DRAGGING||M==RED.state.DETACHED_DRAGGING){var o=RED.history.peek();if(e){var i=d3.select(e).data()[0];RED.nodes.removeLink(i);var a={source:i.source,sourcePort:i.sourcePort,target:be.get(0).n},r={source:be.get(0).n,sourcePort:0,target:i.target};RED.nodes.addLink(a),RED.nodes.addLink(r),o.links=[a,r],o.removedLinks=[i],Re()}if(k){for(var d=0;d<be.length();d++){var l=be.get(d);RED.group.addToGroup(k,l.n)}o.addedToGroup=k,k.hovered=!1,Tt(k),_.selected=!0,k=null}if(M==RED.state.DETACHED_DRAGGING){var u=[];for(d=0;d<be.length();d++){(l=be.get(d)).ox===l.n.x&&l.oy===l.n.y||(u.push({n:l.n,ox:l.ox,oy:l.oy,moved:l.n.moved}),l.n.dirty=!0,l.n.moved=!0)}RED.history.replace({t:"multi",events:[o,{t:"move",nodes:u}],dirty:o.dirty})}return Ge(),RED.nodes.dirty(!0),At(),"cut"===te&&(te="copy"),Xe(),void d3.event.stopPropagation()}if(M!=RED.state.QUICK_JOINING){if(M===RED.state.SELECTING_NODE){if(d3.event.stopPropagation(),"junction"===t.type)return;return n.single?void n.done(t):(t.selected?(t.selected=!1,be.remove(t)):n.filter&&!n.filter(t)||(t.selected=!0,be.add(t)),t.dirty=!0,void At())}L=t;var p=Date.now();if(W=p-q,q=p,J=V==L&&(d3.event.touches||0===d3.event.button)&&!d3.event.shiftKey&&!d3.event.altKey&&W<c&&"junction"!==t.type,V=L,!t.selected&&t.g){var f=RED.nodes.group(t.g);if(f!==_&&(d3.event.ctrlKey||d3.event.metaKey))_&&f.g===_.id?(Y=!0,f.selected?jt(f):kt(f,!0)):(Ct(),Y=!0,f.selected?jt(f):kt(f,!0));else if(f===_)if(d3.event.shiftKey){if(!d3.event.ctrlKey&&!d3.event.metaKey){var h=_;ze(),Tt(h),_.selected=!0}var g=RED.nodes.getAllFlowNodes(L);for(l=0;l<g.length;l++)g[l].selected||(g[l].selected=!0,g[l].dirty=!0,be.add(g[l]))}else{if(!d3.event.ctrlKey&&!d3.event.metaKey){h=_;ze(),jt(f),kt(f,!1,!1),h&&(Tt(h),_.selected=!0)}L.selected=!0,be.add(L)}else{Y=!f.selected;h=_;f.selected||ze(),h?h!==f&&h.id!==f.g?(h.active=!1,h.dirty=!0):(_=h).active=!0:J=!1,kt(f,!(_&&_===f),!!Y),_&&_===f&&(L.selected=!0,be.add(L))}if(2!=d3.event.button)(m=d3.touches(this)[0]||d3.mouse(this))[0]+=t.x-t.w/2,m[1]+=t.y-t.h/2,dt(m)}else if(t.selected&&(d3.event.ctrlKey||d3.event.metaKey))L.selected=!1,be.remove(L);else{if(d3.event.shiftKey){d3.event.ctrlKey||d3.event.metaKey||ze();var v=d3.event.offsetX/s-L.x;g=(L.w||10)/2-Math.abs(v)<(L.w>30?25:L.w>0?8:3)?[L].concat(v<0?RED.nodes.getAllUpstreamNodes(L):RED.nodes.getAllDownstreamNodes(L)):RED.nodes.getAllFlowNodes(L);for(l=0;l<g.length;l++)g[l].selected=!0,g[l].dirty=!0,be.add(g[l])}else t.selected||(d3.event.ctrlKey||d3.event.metaKey?Ct():ze(),L.selected=!0,be.add(L));var m;if(2!=d3.event.button)M=RED.state.MOVING,(m=d3.touches(this)[0]||d3.mouse(this))[0]+=t.x-t.w/2,m[1]+=t.y-t.h/2,dt(m)}t.dirty=!0,Ge(),At(),d3.event.stopPropagation()}else d3.event.stopPropagation()}}function ut(e){RED.view.DEBUG&&console.warn("nodeTouchStart",M,e);var t=d3.select(this),o=d3.event.touches.item(0),i=[o.pageX,o.pageY];f=[o.pageX,o.pageY],p=0,h=setTimeout((function(){It(t,i)}),u),ct.call(this,e),d3.event.preventDefault()}function pt(e){RED.view.DEBUG&&console.warn("nodeTouchEnd",M,e),d3.event.preventDefault(),clearTimeout(h),h=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():lt.call(this,e)}function ft(e){if(RED.view.DEBUG&&console.warn("nodeMouseOver",M,e),0===M||M===RED.state.SELECTING_NODE){if(M===RED.state.SELECTING_NODE&&n&&n.filter?n.filter(e)&&this.parentNode.classList.add("red-ui-flow-node-hovered"):this.parentNode.classList.add("red-ui-flow-node-hovered"),clearTimeout(tt),e.hasOwnProperty("l")?!e.l:"link in"===e.type||"link out"===e.type){var t=this.parentNode;tt=setTimeout((function(){if(t&&t.parentNode&&RED.nodes.node(t.id)){var o;if(e._def.label){o=e._def.label;try{o=("function"==typeof o?o.call(e):o)||""}catch(t){console.log("Definition error: "+e.type+".label",t),o=e.type}}if(""!==o){var i=it(t);tt=null,ot=at(i[0]+e.w/2,i[1]-1,o,"top")}}}),500)}}else if(M===RED.state.JOINING||M===RED.state.QUICK_JOINING){var o,i;if(pe.length>0)pe[0].virtualLink&&1===pe[0].portType||0===pe[0].portType?(o=".red-ui-flow-port-input .red-ui-flow-port",i=1):(o=".red-ui-flow-port-output .red-ui-flow-port",i=0),rt(d3.select(this.parentNode).selectAll(o),e,i,0)}}function ht(e){var t;(RED.view.DEBUG&&console.warn("nodeMouseOut",M,e),this.parentNode.classList.remove("red-ui-flow-node-hovered"),clearTimeout(tt),ot&&(ot.remove(),ot=null),M===RED.state.JOINING||M===RED.state.QUICK_JOINING)&&(pe.length>0&&(pe[0].virtualLink&&1===pe[0].portType||0===pe[0].portType?t=".red-ui-flow-port-input .red-ui-flow-port":t=".red-ui-flow-port-output .red-ui-flow-port",st(d3.select(this.parentNode).selectAll(t))))}function gt(e){Ze(this.__data__,this.__portType__,this.__portIndex__,e)}function vt(e){Ze(this.__data__,this.__portType__,this.__portIndex__,e),e.preventDefault()}function mt(e){Qe(this.__data__,this.__portType__,this.__portIndex__,e)}function bt(e){Qe(this.__data__,this.__portType__,this.__portIndex__,e),e.preventDefault()}function yt(e){rt(d3.select(this),this.__data__,this.__portType__,this.__portIndex__)}function wt(e){st(d3.select(this),this.__data__,this.__portType__,this.__portIndex__)}function Et(e){var t,o,i;t=d3.select(this),this.__data__,o=this.__portType__,i=void 0===o||M!==RED.state.JOINING&&M!==RED.state.QUICK_JOINING||pe.length>0&&pe[0].portType!==o&&!pe[0].virtualLink,t.classed("red-ui-flow-junction-hovered",i)}function Dt(e){var t;t=d3.select(this),this.__data__,t.classed("red-ui-flow-junction-hovered",!1)}function Rt(e){if(RED.view.DEBUG&&console.warn("linkMouseDown",{mouse_mode:M,point:d3.mouse(this),event:d3.event}),RED.contextMenu.hide(),M!==RED.state.SELECTING_NODE){if(2!==d3.event.button&&(j=e,d3.event.metaKey||d3.event.ctrlKey||ze(),(d3.event.metaKey||d3.event.ctrlKey)&&ye.has(j)?1!==ye.length()&&ye.remove(j):ye.add(j),Ge(),At(),zt(),d3.event.stopPropagation(),!j.link&&0===be.length()&&(d3.event.touches||0===d3.event.button)&&1===ye.length()&&ye.has(j)&&(d3.event.metaKey||d3.event.ctrlKey))){d3.select(this).classed("red-ui-flow-link-splice",!0);var t=d3.mouse(this),o=Lt(t[0],t[1]);$e({position:t,splice:j,group:o})}}else d3.event.stopPropagation()}function xt(e){if(M!==RED.state.SELECTING_NODE){j=e,ze(),ye.clear(),ye.add(j),Ge(),At(),zt(),d3.event.stopPropagation();var t=d3.select(document.body),o=d3.event.touches.item(0),i=[o.pageX,o.pageY];h=setTimeout((function(){h=null,It(t,i)}),u),d3.event.preventDefault()}else d3.event.stopPropagation()}function _t(e){if(RED.view.DEBUG&&console.warn("groupMouseUp",{mouse_mode:M,event:d3.event}),J&&S==e&&W>0&&W<c)return M=RED.state.DEFAULT,RED.editor.editGroup(e),void d3.event.stopPropagation()}function $t(e){var t=d3.touches(this.parentNode)[0]||d3.mouse(this.parentNode);if(RED.view.DEBUG&&console.warn("groupMouseDown",{mouse_mode:M,point:t,event:d3.event}),RED.contextMenu.hide(),zt(),1!==d3.event.button)if(M!=RED.state.QUICK_JOINING)if(M!==RED.state.SELECTING_NODE){S=e;var o=Date.now();if(W=o-q,q=o,J=V==e&&(d3.event.touches||0===d3.event.button)&&!d3.event.shiftKey&&!d3.event.metaKey&&!d3.event.altKey&&!d3.event.ctrlKey&&W<c,V=e,e.selected&&(d3.event.ctrlKey||d3.event.metaKey))e===_&&Ct(),jt(e),d3.event.stopPropagation();else{if(e.selected)_&&e.g!==_.id&&Ct();else{if(!d3.event.ctrlKey&&!d3.event.metaKey){var i=_;ze(),i&&e.g===i.id&&(Tt(i),_.selected=!0)}_&&(RED.group.contains(_,e)||Ct()),kt(e,!0)}if(2!=d3.event.button){e.nodes[0];dt(t),S.dx=S.x-t[0],S.dy=S.y-t[1]}}Ge(),At(),d3.event.stopPropagation()}else d3.event.stopPropagation();else d3.event.stopPropagation()}function kt(e,t,o){if(e.selected||(e.selected=!0,e.dirty=!0),!1!==o&&be.add(e),t){var i=new Set(be.nodes());RED.group.getNodes(e,!0).forEach((function(e){i.has(e)||be.add(e),e.dirty=!0}))}}function Tt(e){_&&Ct(),e.active=!0,e.dirty=!0,_=e,be.remove(e)}function Ct(){_&&(_.active=!1,_.dirty=!0,jt(_),kt(_,!0),_=null)}function jt(e){e.selected&&(e.selected=!1,e.dirty=!0);var t=new Set(e.nodes);t.add(e);for(var o=be.length()-1;o>=0;o-=1){var i=be.get(o);(t.has(i.n)||i.n===e)&&(i.n.selected=!1,i.n.dirty=!0,be.remove(i.n,o))}}function Lt(e,t){for(var o={},i=0;i<T.length;i++){var n=T[i];e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h&&(o[n.id]=n)}var a=Object.keys(o);return a.length>1&&(a.forEach((function(e){o[e]&&o[e].g&&delete o[o[e].g]})),a=Object.keys(o)),0===a.length?null:o[a[a.length-1]]}function St(e){var t=!0,o=RED.nodes.workspace(RED.workspaces.active());return!o||o.disabled||e.d?t=!1:e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function Ot(e){if(M!==RED.state.SELECTING_NODE){var t=RED.workspaces.active(),o=RED.nodes.workspace(t);if(!o||o.disabled||e.d)y?RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabledSubflow")}),"warning"):RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(e._def.button.toggle&&(e[e._def.button.toggle]=!e[e._def.button.toggle],e.dirty=!0),e._def.button.onclick)try{e._def.button.onclick.call(e)}catch(t){console.log("Definition error: "+e.type+".onclick",t)}e.dirty&&At()}d3.event&&d3.event.preventDefault()}else d3.event&&d3.event.stopPropagation()}function It(e,t){var o=L,i=[];i.push({name:"delete",disabled:0===be.length()&&0===ye.length(),onselect:function(){Ue()}}),i.push({name:"cut",disabled:0===be.length(),onselect:function(){Ve(!0),Ue()}}),i.push({name:"copy",disabled:0===be.length(),onselect:function(){Ve()}}),i.push({name:"paste",disabled:0===ee.length,onselect:function(){Bt(ee,{generateIds:!0,touchImport:!0})}}),i.push({name:"edit",disabled:1!=be.length(),onselect:function(){RED.editor.edit(o)}}),i.push({name:"select",onselect:function(){Me()}}),i.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),i.push({name:"add",onselect:function(){chartPos=oe.offset(),$e({position:[t[0]-chartPos.left+oe.scrollLeft(),t[1]-chartPos.top+oe.scrollTop()],touchTrigger:!0})}}),RED.touch.radialMenu.show(e,t,i),Xe()}function Nt(e,t,o){var i=null;if(0===e.indexOf("font-awesome/")){var n=e.substr(13);if(!(i=RED.nodes.fontAwesome.getIconUnicode(n))){var a=RED.utils.getDefaultNodeIcon(o._def,o);e=RED.settings.apiRootUrl+"icons/"+a.module+"/"+a.file}}if(i)t.append("text").attr("xlink:href",e).attr("class","fa-lg").attr("x",15).text(i);else{var r=t.append("image").style("display","none").attr("xlink:href",e).attr("class","red-ui-flow-node-icon").attr("x",0).attr("width","30").attr("height","30"),s=new Image;s.src=e,s.onload=function(){if(!e.match(/\.svg$/)){var t=Math.max(s.width,s.height),o=1;t>30&&(o=30/t);var i=s.width*o,n=s.height*o;r.attr("width",i),r.attr("height",n),r.attr("x",15-i/2)}r.attr("xlink:href",e),r.style("display",null)}}}function Pt(e,t){if(e.z===RED.workspaces.active()&&(t||(t=document.getElementById(e.id)),t)){if(U&&e.status&&!0!==e.d){t.__statusGroup__.style.display="inline";var o=me[e.status.fill];if(null==e.status.shape&&null==o)t.__statusShape__.style.display="none",t.__statusGroup__.setAttribute("transform","translate(-14,"+(e.h+3)+")");else{t.__statusGroup__.setAttribute("transform","translate(3,"+(e.h+3)+")");var i="red-ui-flow-node-status-"+(e.status.shape||"dot")+"-"+e.status.fill;t.__statusShape__.style.display="inline",t.__statusShape__.setAttribute("class","red-ui-flow-node-status "+i)}e.status.hasOwnProperty("text")?t.__statusLabel__.textContent=e.status.text:t.__statusLabel__.textContent=""}else t.__statusGroup__.style.display="none";delete e.dirtyStatus}}function At(){RED.view.DEBUG_SYNC_REDRAW?Mt():(et&&cancelAnimationFrame(et),et=requestAnimationFrame(Mt))}function Mt(){if(ne.attr("transform","scale("+s+")"),ie.attr("width",a*s).attr("height",r*s),-1!==X||M!=RED.state.JOINING){var e={};if(y){var t=ce.selectAll(".red-ui-flow-subflow-port-output").data(y.out,(function(e,t){return e.id}));t.exit().remove(),t.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-output").each((function(e,t){var o=d3.select(this),i=document.createDocumentFragment();e.h=40,e.resize=!0,e.dirty=!0;var n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.__data__=e,n.setAttribute("class","red-ui-flow-subflow-port"),n.setAttribute("rx",8),n.setAttribute("ry",8),n.setAttribute("width",40),n.setAttribute("height",40),o[0][0].__mainRect__=n,d3.select(n).on("mouseup",lt).on("mousedown",ct).on("touchstart",ut).on("touchend",pt),i.appendChild(n);var a=document.createElementNS("http://www.w3.org/2000/svg","g");a.setAttribute("x",0),a.setAttribute("y",0),o[0][0].__outputLabelGroup__=a;var r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("class","red-ui-flow-port-label"),r.style["font-size"]="10px",r.textContent="output",a.appendChild(r),o[0][0].__outputOutput__=r;var s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("class","red-ui-flow-port-label red-ui-flow-port-index"),s.setAttribute("x",0),s.setAttribute("y",0),s.textContent=e.i+1,a.appendChild(s),o[0][0].__outputNumber__=s;var d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d","M 40 1 l 0 38"),d.setAttribute("class","red-ui-flow-node-icon-shade-border"),a.appendChild(d),o[0][0].__outputBorder__=d,i.appendChild(a);var l=document.createElementNS("http://www.w3.org/2000/svg","g");l.setAttribute("class","red-ui-flow-port-label"),l.setAttribute("transform","translate(38,0)"),l.setAttribute("style","fill : #888"),o[0][0].__textGroup__=l,i.append(l);var c=document.createElementNS("http://www.w3.org/2000/svg","g");c.setAttribute("transform","translate(-5,15)");var u=document.createElementNS("http://www.w3.org/2000/svg","rect");u.setAttribute("class","red-ui-flow-port"),u.setAttribute("rx",3),u.setAttribute("ry",3),u.setAttribute("width",10),u.setAttribute("height",10),c.appendChild(u),u.__data__=e,d3.select(u).on("mousedown",(function(e,t){Ze(e,1,0)})).on("touchstart",(function(e,t){Ze(e,1,0),d3.event.preventDefault()})).on("mouseup",(function(e,t){Qe(e,1,0)})).on("touchend",(function(e,t){Qe(e,1,0),d3.event.preventDefault()})).on("mouseover",(function(e){rt(d3.select(this),e,1,0)})).on("mouseout",(function(e){st(d3.select(this))})),o[0][0].__port__=c,i.appendChild(c),o[0][0].appendChild(i)}));var o=ce.selectAll(".red-ui-flow-subflow-port-input").data(y.in,(function(e,t){return e.id}));o.exit().remove();var i=o.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-input").attr("transform",(function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"}));i.each((function(e,t){e.w=40,e.h=40})),i.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",lt).on("mousedown",ct).on("touchstart",ut).on("touchend",pt),i.append("g").attr("transform","translate(35,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(function(e,t){Ze(e,0,t)})).on("touchstart",(function(e,t){Ze(e,0,t),d3.event.preventDefault()})).on("mouseup",(function(e,t){Qe(e,0,t)})).on("touchend",(function(e,t){Qe(e,0,t),d3.event.preventDefault()})).on("mouseover",(function(e){rt(d3.select(this),e,0,0)})).on("mouseout",(function(e){st(d3.select(this))})),i.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",18).attr("y",20).style("font-size","10px").text("input");var n=ce.selectAll(".red-ui-flow-subflow-port-status").data(y.status?[y.status]:[],(function(e,t){return e.id}));n.exit().remove();var c=n.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-status").attr("transform",(function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"}));c.each((function(e,t){e.w=40,e.h=40})),c.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",lt).on("mousedown",ct).on("touchstart",ut).on("touchend",pt),c.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(function(e,t){Ze(e,1,0)})).on("touchstart",(function(e,t){Ze(e,1,0),d3.event.preventDefault()})).on("mouseup",(function(e,t){Qe(e,1,0)})).on("touchend",(function(e,t){Qe(e,1,0),d3.event.preventDefault()})).on("mouseover",(function(e){rt(d3.select(this),e,1,0)})).on("mouseout",(function(e){st(d3.select(this))})),c.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",22).attr("y",20).style("font-size","10px").text("status"),t.each((function(t,o){if(t.dirty){d3.select(this);e[t.id]=t;var i,n=nt(y,0,t.i)||"",a=n.length<1;if((t.resize||this.__hideLabel__!==a||this.__label__!==n)&&((i=Je(n,"red-ui-flow-node-label")).lines.length===this.__labelLineCount__&&this.__label__===n||(t.resize=!0),this.__label__=n,this.__labelLineCount__=i.lines.length,t.h=a?Math.max(40,15*(t.outputs||0)):Math.max(6+24*i.lines.length,15*(t.outputs||0),40),this.__hideLabel__=a),t.resize){var r=t.w;t.w=a?40:Math.max(40,20*Math.ceil((i.width+50+7)/20)),void 0!==r&&(t.x+=(t.w-r)/2),t.resize=!1}if(this.setAttribute("transform","translate("+(t.x-t.w/2)+","+(t.y-t.h/2)+")"),this.classList.toggle("red-ui-flow-node-selected",!!t.selected),M!=RED.state.MOVING_ACTIVE){if(this.classList.toggle("red-ui-flow-node-disabled",!0===t.d),this.__mainRect__.setAttribute("width",t.w),this.__mainRect__.setAttribute("height",t.h),this.__mainRect__.classList.toggle("red-ui-flow-node-highlighted",!!t.highlighted),i){for(var s=i.lines,d=i.lines.length,l=this.__textGroup__.childNodes;l.length>d;)l[l.length-1].remove();for(o=0;o<d;o++){if(o===l.length){var c=document.createElementNS("http://www.w3.org/2000/svg","text");c.setAttribute("class","red-ui-flow-node-label-text"),c.setAttribute("x",0),c.setAttribute("y",24*o),this.__textGroup__.appendChild(c)}l[o].textContent=s[o]}}var u="red-ui-flow-node-label"+(a?" hide":"");this.__textGroup__.setAttribute("class",u);var p=t.h/2-this.__labelLineCount__/2*24+13;this.__textGroup__.setAttribute("transform","translate(48,"+p+")"),this.__outputBorder__.setAttribute("d","M 40 1 l 0 "+(a?0:t.h-2)),this.__port__.setAttribute("transform","translate(-5,"+(t.h/2-5)+")"),this.__outputOutput__.setAttribute("transform","translate(20,"+(t.h/2-8)+")"),this.__outputNumber__.setAttribute("transform","translate(20,"+(t.h/2+7)+")")}t.dirty=!1}})),o.each((function(t,o){if(t.dirty){var i=d3.select(this);i.classed("red-ui-flow-node-selected",(function(e){return e.selected})),i.attr("transform",(function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"})),e[t.id]=t,t.dirty=!1}})),n.each((function(t,o){if(t.dirty){var i=d3.select(this);i.classed("red-ui-flow-node-selected",(function(e){return e.selected})),i.selectAll(".red-ui-flow-port-index").text((function(e){return e.i+1})),i.attr("transform",(function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"})),e[t.id]=t,t.dirty=!1}}))}else ce.selectAll(".red-ui-flow-subflow-port-output").remove(),ce.selectAll(".red-ui-flow-subflow-port-input").remove(),ce.selectAll(".red-ui-flow-subflow-port-status").remove();var u=ce.selectAll(".red-ui-flow-node-group").data(w,(function(e){return e.id}));u.exit().each((function(e,t){RED.hooks.trigger("viewRemoveNode",{node:e,el:this})})).remove(),u.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-node-group").classed("red-ui-flow-subflow",null!=y).each((function(e,t){this.__outputs__=[],this.__inputs__=[];var o=d3.select(this),i=document.createDocumentFragment(),n="link in"===e.type||"link out"===e.type,a=e.hasOwnProperty("l")?!e.l:n;if(o.attr("id",e.id),e.h=l,e.resize=!0,e._def.button){var r=document.createElementNS("http://www.w3.org/2000/svg","g");r.__data__=e,r.setAttribute("transform","translate("+("right"==e._def.align?94:-25)+",2)"),r.setAttribute("class","red-ui-flow-node-button"),o[0][0].__buttonGroup__=r;var s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.__data__=e,s.setAttribute("class","red-ui-flow-node-button-background"),s.setAttribute("rx",5),s.setAttribute("ry",5),s.setAttribute("width",32),s.setAttribute("height",26),r.appendChild(s),o[0][0].__buttonGroupBackground__=s;var d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.__data__=e,d.setAttribute("class","red-ui-flow-node-button-button"),d.setAttribute("x","right"==e._def.align?11:5),d.setAttribute("y",4),d.setAttribute("rx",4),d.setAttribute("ry",4),d.setAttribute("width",16),d.setAttribute("height",18),d.setAttribute("fill",RED.utils.getNodeColor(e.type,e._def)),d3.select(d).on("mousedown",(function(e){!z&&St(e)&&(zt(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())})).on("mouseup",(function(e){!z&&St(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())})).on("mouseover",(function(e){!z&&St(e)&&d3.select(this).attr("fill-opacity",.4)})).on("mouseout",(function(e){if(!z&&St(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}})).on("click",Ot).on("touchstart",(function(e){Ot.call(this,e),d3.event.preventDefault()})),r.appendChild(d),o[0][0].__buttonGroupButton__=d,i.appendChild(r)}var c=document.createElementNS("http://www.w3.org/2000/svg","rect");if(c.__data__=e,c.setAttribute("class","red-ui-flow-node "+("unknown"==e.type?"red-ui-flow-node-unknown":"")),c.setAttribute("rx",5),c.setAttribute("ry",5),c.setAttribute("fill",RED.utils.getNodeColor(e.type,e._def)),o[0][0].__mainRect__=c,d3.select(c).on("mouseup",lt).on("mousedown",ct).on("touchstart",ut).on("touchend",pt).on("mouseover",ft).on("mouseout",ht),i.appendChild(c),e._def.icon){var u=RED.utils.getNodeIcon(e._def,e),p=document.createElementNS("http://www.w3.org/2000/svg","g");p.__data__=e,p.setAttribute("class","red-ui-flow-node-icon-group"+("right"==e._def.align?" red-ui-flow-node-icon-group-right":"")),p.setAttribute("x",0),p.setAttribute("y",0),p.style["pointer-events"]="none",o[0][0].__iconGroup__=p;var f=document.createElementNS("http://www.w3.org/2000/svg","path");f.setAttribute("x",0),f.setAttribute("y",0),f.setAttribute("class","red-ui-flow-node-icon-shade"),p.appendChild(f),o[0][0].__iconShade__=f,Nt(u,d3.select(p),e);var h=document.createElementNS("http://www.w3.org/2000/svg","path");h.setAttribute("d","right"!=e._def.align?"M 30 1 l 0 "+(e.h-2):"M 0 1 l 0 "+(e.h-2)),h.setAttribute("class","red-ui-flow-node-icon-shade-border"),p.appendChild(h),o[0][0].__iconShadeBorder__=h,i.appendChild(p)}var g=document.createElementNS("http://www.w3.org/2000/svg","g");g.setAttribute("class","red-ui-flow-node-label"+(a?" hide":"")+(e._def.align?" red-ui-flow-node-label-"+e._def.align:"")),g.setAttribute("transform","translate(38,0)"),i.appendChild(g),o[0][0].__textGroup__=g;var v=document.createElementNS("http://www.w3.org/2000/svg","g");v.setAttribute("class","red-ui-flow-node-status-group"),v.style.display="none",o[0][0].__statusGroup__=v;var m=document.createElementNS("http://www.w3.org/2000/svg","rect");m.setAttribute("class","red-ui-flow-node-status"),m.setAttribute("x",6),m.setAttribute("y",1),m.setAttribute("width",9),m.setAttribute("height",9),m.setAttribute("rx",2),m.setAttribute("ry",2),m.setAttribute("stroke-width","3"),v.appendChild(m),o[0][0].__statusShape__=m;var b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("class","red-ui-flow-node-status-label"),b.setAttribute("x",20),b.setAttribute("y",10),v.appendChild(b),o[0][0].__statusLabel__=b,i.appendChild(v),o[0][0].appendChild(i),RED.hooks.trigger("viewAddNode",{node:e,el:this})}));var p=!1;u.each((function(t,o){if(t._reordered&&(p=!0,delete t._reordered),t.dirty){var i=this,n=d3.select(this),a="link in"===t.type||"link out"===t.type,r=t.hasOwnProperty("l")?!t.l:a;e[t.id]=t;var s,c=RED.utils.getNodeLabel(t,t.type);if((t.resize||this.__hideLabel__!==r||this.__label__!==c||this.__outputs__.length!==t.outputs)&&((s=Je(c,"red-ui-flow-node-label")).lines.length===this.__labelLineCount__&&this.__label__===c||(t.resize=!0),this.__label__=c,this.__labelLineCount__=s.lines.length,t.h=r?Math.max(l,15*(t.outputs||0)):Math.max(6+24*s.lines.length,15*(t.outputs||0),30),this.__hideLabel__=r),t.resize){var u=t.w;t.w=r?l:Math.max(d,20*Math.ceil((s.width+50+(t._def.inputs>0?7:0))/20)),void 0!==u&&(t.x+=(t.w-u)/2),t.resize=!1}if(t._colorChanged){var f=RED.utils.getNodeColor(t.type,t._def);this.__mainRect__.setAttribute("fill",f),this.__buttonGroupButton__&&this.__buttonGroupButton__.settAttribute("fill",f),delete t._colorChanged}if(this.setAttribute("transform","translate("+(t.x-t.w/2)+","+(t.y-t.h/2)+")"),this.classList.toggle("red-ui-flow-node-selected",!!t.selected),M!=RED.state.MOVING_ACTIVE){if(this.classList.toggle("red-ui-flow-node-disabled",!0===t.d),this.__mainRect__.setAttribute("width",t.w),this.__mainRect__.setAttribute("height",t.h),this.__mainRect__.classList.toggle("red-ui-flow-node-highlighted",!!t.highlighted),s){for(var h=s.lines,g=s.lines.length,v=this.__textGroup__.childNodes;v.length>g;)v[v.length-1].remove();for(o=0;o<g;o++){if(o===v.length){var m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("class","red-ui-flow-node-label-text"),m.setAttribute("x",0),m.setAttribute("y",24*o),this.__textGroup__.appendChild(m)}v[o].textContent=h[o]}}var b="";if(t._def.labelStyle){b=t._def.labelStyle;try{b=("function"==typeof b?b.call(t):b)||""}catch(e){console.log("Definition error: "+t.type+".labelStyle",e),b=""}b=" "+b}b="red-ui-flow-node-label"+(t._def.align?" red-ui-flow-node-label-"+t._def.align:"")+b+(r?" hide":""),this.__textGroup__.setAttribute("class",b);var y=t.h/2-this.__labelLineCount__/2*24+13;!t._def.align&&0!==t.inputs&&0===t.outputs||"right"===t._def.align?(this.__iconGroup__&&(this.__iconGroup__.classList.add("red-ui-flow-node-icon-group-right"),this.__iconGroup__.setAttribute("transform","translate("+(t.w-30)+",0)")),this.__textGroup__.classList.add("red-ui-flow-node-label-right"),this.__textGroup__.setAttribute("transform","translate("+(t.w-38)+","+y+")")):(this.__iconGroup__&&(this.__iconGroup__.classList.remove("red-ui-flow-node-icon-group-right"),this.__iconGroup__.setAttribute("transform","")),this.__textGroup__.classList.remove("red-ui-flow-node-label-right"),this.__textGroup__.setAttribute("transform","translate(38,"+y+")"));var w=n.selectAll(".red-ui-flow-port-input");if(a&&(-1!==X||x[t.id])||0!==t.inputs||w.empty()){if((a&&(1===X||x[t.id])||1===t.inputs)&&w.empty()){var E,D=n.append("g").attr("class","red-ui-flow-port-input");E="link in"===t.type?D.append("circle").attr("cx",-1).attr("cy",5).attr("r",5).attr("class","red-ui-flow-port red-ui-flow-link-port"):D.append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10),D[0][0].__port__=E[0][0],E[0][0].__data__=this.__data__,E[0][0].__portType__=1,E[0][0].__portIndex__=0,E.on("mousedown",(function(e){Ze(e,1,0)})).on("touchstart",(function(e){Ze(e,1,0),d3.event.preventDefault()})).on("mouseup",(function(e){Qe(e,1,0)})).on("touchend",(function(e){Qe(e,1,0),d3.event.preventDefault()})).on("mouseover",(function(e){rt(d3.select(this),e,1,0)})).on("mouseout",(function(e){st(d3.select(this))})),RED.hooks.trigger("viewAddPort",{node:t,el:this,port:D[0][0],portType:"input",portIndex:0})}}else w.each((function(e,t){RED.hooks.trigger("viewRemovePort",{node:e,el:i,port:d3.select(this)[0][0],portType:"input",portIndex:0})})).remove();var R=t.outputs;a&&"link out"===t.type&&(R="return"===t.mode||0!==X&&!x[t.id]?0:1);for(var _=t.h/2-(R-1)/2*13;this.__outputs__.length>R;){var $=this.__outputs__.pop();RED.hooks.trigger("viewRemovePort",{node:t,el:this,port:$,portType:"output",portIndex:this.__outputs__.length}),$.remove()}for(var k=0;k<R;k++){var T,j;if(k===this.__outputs__.length)(T=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("class","red-ui-flow-port-output"),"link out"===t.type?((j=document.createElementNS("http://www.w3.org/2000/svg","circle")).setAttribute("cx",11),j.setAttribute("cy",5),j.setAttribute("r",5),j.setAttribute("class","red-ui-flow-port red-ui-flow-link-port")):((j=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("rx",3),j.setAttribute("ry",3),j.setAttribute("width",10),j.setAttribute("height",10),j.setAttribute("class","red-ui-flow-port")),T.appendChild(j),T.__port__=j,j.__data__=this.__data__,j.__portType__=0,j.__portIndex__=k,j.addEventListener("mousedown",gt),j.addEventListener("touchstart",vt),j.addEventListener("mouseup",mt),j.addEventListener("touchend",bt),j.addEventListener("mouseover",yt),j.addEventListener("mouseout",wt),this.appendChild(T),this.__outputs__.push(T),RED.hooks.trigger("viewAddPort",{node:t,el:this,port:T,portType:"output",portIndex:k});else T=this.__outputs__[k];var L=t.w-5;_=t.h/2-(R-1)/2*13;T.setAttribute("transform","translate("+L+","+(_+13*k-5)+")")}if(t._def.icon){var S,O=n.select(".red-ui-flow-node-icon"),I=n.select(".fa-lg");S=O.empty()?I.attr("xlink:href"):O.attr("xlink:href");var N=RED.utils.getNodeIcon(t._def,t);if(N!==S)O.empty()?I.remove():O.remove(),Nt(N,n.select(".red-ui-flow-node-icon-group"),t),O=n.select(".red-ui-flow-node-icon"),I=n.select(".fa-lg");O.attr("y",(function(){return(t.h-d3.select(this).attr("height"))/2}));const e=t.h,o=30;this.__iconShade__.setAttribute("d",r?`M5 0 h${o-10} a 5 5 0 0 1 5 5 v${e-10} a 5 5 0 0 1 -5 5 h-${o-10} a 5 5 0 0 1 -5 -5  v-${e-10} a 5 5 0 0 1 5 -5`:"right"===t._def.align?`M 0 0 h${o-5} a 5 5 0 0 1 5 5 v${e-10} a 5 5 0 0 1 -5 5 h-${o-5} v-${e}`:`M5 0 h${o-5} v${e} h-${o-5} a 5 5 0 0 1 -5 -5  v-${e-10} a 5 5 0 0 1 5 -5`),this.__iconShadeBorder__.style.display=r?"none":"",this.__iconShadeBorder__.setAttribute("d","M "+(!t._def.align&&0!==t.inputs&&0===t.outputs||"right"===t._def.align?.5:29.5)+" "+(t.selected?1:.5)+" l 0 "+(t.h-(t.selected?2:1))),I.attr("y",(t.h+13)/2)}if(n.selectAll(".red-ui-flow-port-input").each((function(e,t){d3.select(this).attr("transform",(function(e){return"translate(-5,"+(e.h/2-5)+")"}))})),t._def.button){var P=St(t);this.__buttonGroup__.classList.toggle("red-ui-flow-node-button-disabled",!P),RED.runtime&&void 0!==RED.runtime.started&&this.__buttonGroup__.classList.toggle("red-ui-flow-node-button-stopped",!RED.runtime.started);L="right"==t._def.align?t.w-6:-25;t._def.button.toggle&&!t[t._def.button.toggle]&&(L-="right"==t._def.align?8:-8),this.__buttonGroup__.setAttribute("transform","translate("+L+",2)"),t._def.button.toggle&&(this.__buttonGroupButton__.setAttribute("fill-opacity",t[t._def.button.toggle]?1:.2),this.__buttonGroupBackground__.setAttribute("fill-opacity",t[t._def.button.toggle]?1:.2)),"function"==typeof t._def.button.visible&&(!1===t._def.button.visible.call(t)?this.__buttonGroup__.style.display="none":this.__buttonGroup__.style.display="inherit")}}if(t.dirtyStatus&&Pt(t,this),t.dirty=!1,t.g&&!C[t.g])for(var A=t.g;A&&!C[A];)C[A]=RED.nodes.group(A),A=C[A].g}RED.hooks.trigger("viewRedrawNode",{node:t,el:this})})),p&&u.sort((function(e,t){return e._index-t._index}));var f=se.selectAll(".red-ui-flow-junction").data(D,(e=>e.id));f.enter().insert("svg:g").attr("class","red-ui-flow-junction").each((function(e,t){var o=d3.select(this),i=document.createDocumentFragment(),n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("class","red-ui-flow-junction-background"),n.setAttribute("x",-5),n.setAttribute("y",-5),n.setAttribute("width",10),n.setAttribute("height",10),n.setAttribute("rx",3),n.setAttribute("ry",3),n.__data__=e,this.__junctionBack__=n,i.appendChild(n);var a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("class","red-ui-flow-junction-port red-ui-flow-junction-port-input"),a.setAttribute("x",-5),a.setAttribute("y",-5),a.setAttribute("width",10),a.setAttribute("height",10),a.setAttribute("rx",3),a.setAttribute("ry",3),a.__data__=e,a.__portType__=1,a.__portIndex__=0,this.__junctionInput__=r,i.appendChild(a),a.addEventListener("mouseup",mt),a.addEventListener("mousedown",gt),this.__junctionInput__=a,i.appendChild(a);var r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("class","red-ui-flow-junction-port red-ui-flow-junction-port-output"),r.setAttribute("x",-5),r.setAttribute("y",-5),r.setAttribute("width",10),r.setAttribute("height",10),r.setAttribute("rx",3),r.setAttribute("ry",3),r.__data__=e,r.__portType__=0,r.__portIndex__=0,this.__junctionOutput__=r,i.appendChild(r),r.addEventListener("mouseup",mt),r.addEventListener("mousedown",gt),r.addEventListener("mouseover",Et),r.addEventListener("mouseout",Dt),a.addEventListener("mouseover",Et),a.addEventListener("mouseout",Dt),n.addEventListener("mouseover",Et),n.addEventListener("mouseout",Dt),d3.select(n).on("mousedown",ct).on("mouseup",lt),o[0][0].appendChild(i)})),f.exit().remove(),f.each((function(t){var o=d3.select(this);if(this.setAttribute("transform","translate("+t.x+","+t.y+")"),t.dirty&&(o.classed("red-ui-flow-junction-dragging",M===RED.state.MOVING_ACTIVE&&be.has(t)),o.classed("selected",!!t.selected),e[t.id]=t,t.g&&!C[t.g]))for(var i=t.g;i&&!C[i];)C[i]=RED.nodes.group(i),i=C[i].g}));var h=re.selectAll(".red-ui-flow-link").data(E,(function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}));h.enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link").each((function(e,t){var o=d3.select(this),i=document.createDocumentFragment();e.added=!0;var n=document.createElementNS("http://www.w3.org/2000/svg","path");n.__data__=e,n.setAttribute("class","red-ui-flow-link-background red-ui-flow-link-path"+(e.link?" red-ui-flow-link-link":"")),this.__pathBack__=n,i.appendChild(n),d3.select(n).on("mousedown",Rt).on("touchstart",xt).on("mousemove",(function(e){if(M===RED.state.SLICING)ye.add(e),o.classed("red-ui-flow-link-splice",!0),At();else if(M===RED.state.SLICING_JUNCTION&&!e.link&&!o.classed("red-ui-flow-link-splice")){for(var t,i=r.getTotalLength(),n=1/0,a=0;a<i;a++){var s=r.getPointAtLength(a),d=Math.abs(s.x-d3.event.offsetX),l=Math.abs(s.y-d3.event.offsetY),c=d*d+l*l;c<n&&(t=s,n=c)}e._sliceLocation=t,ye.add(e),o.classed("red-ui-flow-link-splice",!0),At()}}));var a=document.createElementNS("http://www.w3.org/2000/svg","path");a.__data__=e,a.setAttribute("class","red-ui-flow-link-outline red-ui-flow-link-path"),this.__pathOutline__=a,i.appendChild(a);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.__data__=e,r.setAttribute("class","red-ui-flow-link-line red-ui-flow-link-path"+(e.link?" red-ui-flow-link-link":y?" red-ui-flow-subflow-link":"")),this.__pathLine__=r,i.appendChild(r),o[0][0].appendChild(i)})),h.exit().remove(),h.each((function(t){d3.select(this);if(t.added||t.selected||e[t.source.id]||e[t.target.id]){var o=-((t.source.outputs||1)-1)/2*13+13*(t.sourcePort||0);t.x1=t.source.x+(t.source.w/2||0),t.y1=t.source.y+o,t.x2=t.target.x-(t.target.w/2||0),t.y2=t.target.y;var i=xe(t.x1,t.y1,t.x2,t.y2,1);/NaN/.test(i)&&(i=""),this.__pathBack__.setAttribute("d",i),this.__pathOutline__.setAttribute("d",i),this.__pathLine__.setAttribute("d",i),this.__pathLine__.classList.toggle("red-ui-flow-node-disabled",!(!t.source.d&&!t.target.d)),this.__pathLine__.classList.toggle("red-ui-flow-subflow-link",!t.link&&y)}this.classList.toggle("red-ui-flow-link-selected",!!t.selected);"unknown"!=t.target.type&&t.source.type;this.classList.toggle("red-ui-flow-link-unknown",!("unknown"!=t.target.type&&"unknown"!=t.source.type)),delete t.added}));var g=re.selectAll(".red-ui-flow-link-off-flow").data(R,(function(e){return e.node.id+":"+e.refresh}));g.enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link-off-flow").each((function(e,t){var o=d3.select(this),i=1,n="start";"link in"===e.node.type&&(i=-1,n="end");var a=30*i,r=20*i,s=(o.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M 0 0 h "+a),e.links),l=Object.keys(s),c=RED.nodes.getWorkspaceOrder();l.sort((function(e,t){return c.indexOf(e)-c.indexOf(t)}));var u=10,p=30*-(l.length-1)/2,f=o.selectAll(".red-ui-flow-link-group").data(l);f.enter().append("g").attr("class","red-ui-flow-link-group").on("mouseover",(function(){0===M&&d3.select(this).classed("red-ui-flow-link-group-active",!0)})).on("mouseout",(function(){0===M&&d3.select(this).classed("red-ui-flow-link-group-active",!1)})).on("mousedown",(function(){d3.event.preventDefault(),d3.event.stopPropagation()})).on("mouseup",(function(t){if(0===M){d3.event.stopPropagation();var o=e.links[t];RED.workspaces.show(t),o.forEach((function(e){e.selected=!0,e.dirty=!0,be.add(e),1===o.length&&RED.view.reveal(e.id)})),Ge(),At()}})).each((function(e){var t=d3.select(this);t.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M "+a+" 0 C "+(a+1.7*r)+" 0 "+(a+.1*r)+" "+p+" "+(a+1.5*r)+" "+p+" "),t.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(a+1.5*r+17*i)+" "+(p-12)+" h "+-i*u+" a 3 3 45 0 "+(1===i?"0":"1")+" "+-3*i+" 3 v 18 a 3 3 45 0 "+(1===i?"0":"1")+" "+3*i+" 3 h "+i*u),t.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(a+1.5*r+20*i)+" "+(p-12)+" h "+30*i+" M "+(a+1.5*r+20*i)+" "+(p+12)+" h "+30*i).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","red-ui-flow-port red-ui-flow-link-port").attr("x",a+1.5*r-4+4*i).attr("y",p-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",a+1.5*r-(-1===i?d:0)).attr("y",p-12).attr("width",d).attr("height",24).style("stroke","none").style("fill","transparent");var o,s=RED.nodes.workspace(e);s&&(o=s.label||s.id),t.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",a+1.5*r+15*i).attr("y",p+1).style("font-size","10px").style("text-anchor",n).text(o),p+=30})),f.exit().remove()})),g.exit().remove(),(g=re.selectAll(".red-ui-flow-link-off-flow")).each((function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",(function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"}))}));var v=ue.selectAll(".red-ui-flow-group").data(T,(function(e){return e.id}));v.exit().each((function(e,t){document.getElementById("group_select_"+e.id).remove()})).remove();var m=v.enter().insert("svg:g").attr("class","red-ui-flow-group"),b=!1;m.each((function(e,t){b=!0;var o=d3.select(this);o.attr("id",e.id);var i=le.append("g").attr("class","red-ui-flow-group").attr("id","group_select_"+e.id);i.append("rect").classed("red-ui-flow-group-outline-select",!0).classed("red-ui-flow-group-outline-select-background",!0).attr("rx",4).attr("ry",4).attr("x",-4).attr("y",-4),i.append("rect").classed("red-ui-flow-group-outline-select",!0).attr("rx",4).attr("ry",4).attr("x",-4).attr("y",-4),i.on("mousedown",(function(){$t.call(o[0][0],e)})),i.on("mouseup",(function(){_t.call(o[0][0],e)})),i.on("touchstart",(function(){$t.call(o[0][0],e),d3.event.preventDefault()})),i.on("touchend",(function(){_t.call(o[0][0],e),d3.event.preventDefault()})),o.append("rect").classed("red-ui-flow-group-outline",!0).attr("rx",.5).attr("ry",.5),o.append("rect").classed("red-ui-flow-group-body",!0).attr("rx",4).attr("ry",4).style({fill:e.fill||"none",stroke:e.stroke||"none"}),o.on("mousedown",$t).on("mouseup",_t),o.on("touchstart",(function(){$t.call(o[0][0],e),d3.event.preventDefault()})),o.on("touchend",(function(){_t.call(o[0][0],e),d3.event.preventDefault()})),o.append("svg:text").attr("class","red-ui-flow-group-label"),e.dirty=!0})),b&&v.sort((function(e,t){return e._root===t._root?e._depth-t._depth:e._index-t._index})),v[0].reverse();v.each((function(e,t){if(e.resize&&(e.minWidth=0,delete e.resize),e.dirty||C[e.id]){var o=d3.select(this),i=!1;if(e.nodes.length>0)if(e.groupMoved)delete e.groupMoved;else{var n=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,r=0,s=0,d=26;e.nodes.forEach((function(e){"group"!==e.type?(n=Math.min(n,e.x-e.w/2-d-(e._def.button&&"right"!==e._def.align?20:0)),a=Math.min(a,e.y-e.h/2-d),r=Math.max(r,e.x+e.w/2+d+(e._def.button&&"right"==e._def.align?20:0)),s=Math.max(s,e.y+e.h/2+d)):(n=Math.min(n,e.x-d),a=Math.min(a,e.y-d),r=Math.max(r,e.x+e.w+d),s=Math.max(s,e.y+e.h+d))})),e.x=n,e.y=a,e.w=r-n,e.h=s-a,i=!0,!1===e.groupMoved&&delete e.groupMoved}else e.w=40,e.h=40,i=!0;if(i){if(!e.minWidth)if(e.style.label&&e.name){var l=Je(e.name||"","red-ui-flow-group-label");e.minWidth=l.width+8,e.labels=l.lines}else e.minWidth=40,e.labels=[];if(e.w=Math.max(e.minWidth,e.w),e.style.label&&e.labels.length>0){var c=e.style["label-position"]||"nw",u=16*(e.labels.length-1);"s"===c[0]&&(u+=8),e.h+=u,"n"===c[0]&&e.nodes.length>0&&(e.y-=u)}}o.attr("transform","translate("+e.x+","+e.y+")"),o.selectAll(".red-ui-flow-group-outline").attr("width",e.w).attr("height",e.h);var p=document.getElementById("group_select_"+e.id);p.setAttribute("transform","translate("+e.x+","+e.y+")"),e.hovered?p.classList.add("red-ui-flow-group-hovered"):p.classList.remove("red-ui-flow-group-hovered");var f=p.children[0];f.setAttribute("width",e.w+8),f.setAttribute("height",e.h+8),f.style.strokeOpacity=e.active||e.selected||e.highlighted?.8:0,f.style.strokeDasharray=e.active?"10 4":"",(f=p.children[1]).setAttribute("width",e.w+8),f.setAttribute("height",e.h+8),f.style.strokeOpacity=e.active||e.selected||e.highlighted?.8:0,f.style.strokeDasharray=e.active?"10 4":"",e.highlighted?p.classList.add("red-ui-flow-node-highlighted"):p.classList.remove("red-ui-flow-node-highlighted"),o.selectAll(".red-ui-flow-group-body").attr("width",e.w).attr("height",e.h).style("stroke",e.style.stroke||"").style("stroke-opacity",e.style.hasOwnProperty("stroke-opacity")?e.style["stroke-opacity"]:"").style("fill",e.style.fill||"").style("fill-opacity",e.style.hasOwnProperty("fill-opacity")?e.style["fill-opacity"]:"");var h=o.selectAll(".red-ui-flow-group-label");if(h.classed("hide",!e.style.label),e.style.label){var g=0,v=0;if(v="n"===(c=e.style["label-position"]||"nw")[0]?15:e.h-5-16*(e.labels.length-1),"w"===c[1]?(g=5,labelAnchor="start"):"e"===c[1]?(g=e.w-5,labelAnchor="end"):(g=e.w/2,labelAnchor="middle"),e.style.hasOwnProperty("color")?h.style("fill",e.style.color):h.style("fill",null),h.attr("transform","translate("+g+","+v+")").attr("text-anchor",labelAnchor),e.labels){var m=0;o.selectAll(".red-ui-flow-group-label-text").remove(),e.labels.forEach((function(e){h.append("tspan").classed("red-ui-flow-group-label-text",!0).text(e).attr("x",0).attr("y",m),m+=16}))}else o.selectAll(".red-ui-flow-group-label-text").remove()}delete C[e.id],delete e.dirty}}))}else re.selectAll(".red-ui-flow-link-selected").data(E,(function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i})).classed("red-ui-flow-link-selected",!1);RED.view.navigator.refresh(),d3.event&&d3.event.preventDefault()}function zt(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;oe.trigger("focus"),window.parent.window.scrollTo(e,t)}catch(e){oe.trigger("focus")}}function Bt(e,t){var o=(t=t||{addFlow:!1,touchImport:!1,generateIds:!1,generateDefaultNames:!1}).addFlow,i=t.touchImport;if(M!==RED.state.SELECTING_NODE){var n;if("string"==typeof e){if(""===e)return;try{n=JSON.parse(e)}catch(e){var a=new Error(RED._("clipboard.invalidFlow",{message:e.message}));throw a.code="NODE_RED",a}}else n=e;$.isArray(n)||(n=[n]),t.generateDefaultNames&&RED.actions.invoke("core:generate-node-names",n,{renameBlank:!1,renameClash:!0,generateHistory:!1});try{var r;y&&(r=y.changed);var s=RED.nodes.import(n,{generateIds:t.generateIds,addFlow:o,importMap:t.importMap});if(s){var c=s.nodes,u=s.links,p=s.groups,f=s.junctions,h=s.workspaces,g=s.subflows,v=s.removedNodes,m=s.missingWorkspace;o&&m&&RED.workspaces.show(m.id);var w=c.filter((function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}));w=(w=w.concat(p.filter((function(e){return e.z===RED.workspaces.active()})))).concat(f.filter((function(e){return e.z===RED.workspaces.active()})));var E=c.map((function(e){return e.changed=!0,e.id}));if(ze(),be.clear(),be.add(w),be.length()>0){null==A&&(A=[0,0]);var D=A[0],R=A[1];if(be.length()>0){var x=be.get(0).n;D=x.x,R=x.y}var _,k,T=0,C=0,j=be.length();for(_=0;_<j;_++)(k=be.get(_)).n.selected=!0,k.n.changed=!0,k.n.moved=!0,k.n.x-=D-A[0],k.n.y-=R-A[1],"junction"!==k.n.type&&(k.n.w=d,k.n.h=l,k.n.resize=!0),k.dx=k.n.x-A[0],k.dy=k.n.y-A[1],"group"===k.n.type?(k.n.groupMoved=!1,T=Math.min(k.n.x-5,T),C=Math.min(k.n.y-5,C)):(T=Math.min(k.n.x-50-5,T),C=Math.min(k.n.y-15-5,C));for(_=0;_<j;_++)if((k=be.get(_)).n.x-=T,k.n.y-=C,k.dx-=T,k.dy-=C,k.n._def.onadd)try{k.n._def.onadd.call(k.n)}catch(e){console.log("Definition error: "+k.n.type+".onadd:",e)}i||(M=RED.state.IMPORT_DRAGGING,b=!1,1===be.length()&&(k=be.get(0),b=k.n.hasOwnProperty("_def")&&(k.n.hasOwnProperty("inputs")&&k.n.inputs>0||!k.n.hasOwnProperty("inputs")&&k.n._def.inputs>0)&&(k.n.hasOwnProperty("outputs")&&k.n.outputs>0||!k.n.hasOwnProperty("outputs")&&k.n._def.outputs>0)))}var L={t:"add",nodes:E,links:u,groups:p,junctions:f,workspaces:h,subflows:g,dirty:RED.nodes.dirty()};if(0===be.length()&&RED.nodes.dirty(!0),y){var S=RED.subflow.refresh(!0);S&&(L.subflow={id:y.id,changed:r,instances:S.instances})}if(v)L={t:"multi",events:[{t:"replace",config:v},L]};RED.history.push(L),Re(),At();var O=[],I=0,N=0;c.forEach((function(e){e.hasOwnProperty("x")&&e.hasOwnProperty("y")?I++:N++}));var P=p.length;f.length;if(h.length>0&&O.push(RED._("clipboard.flow",{count:h.length})),I>0&&O.push(RED._("clipboard.node",{count:I})),P>0&&O.push(RED._("clipboard.group",{count:P})),N>0&&O.push(RED._("clipboard.configNode",{count:N})),g.length>0&&O.push(RED._("clipboard.subflow",{count:g.length})),v&&v.length>0&&O.push(RED._("clipboard.replacedNodes",{count:v.length})),O.length>0){var z="<ul><li>"+O.join("</li><li>")+"</li></ul>";RED.notify("<p>"+RED._("clipboard.nodesImported")+"</p>"+z,{id:"clipboard"})}}}catch(e){if("import_conflict"===e.code)throw e;"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}}function Gt(e){if(M!==RED.state.SELECTING_NODE){if(RED.workspaces.selection().length>0);else if(be.length()>0){for(var t=[],o=0;o<be.length();o++){var i=be.get(o).n;"group"!==i.type&&"subflow"!==i.type&&e!=i.d&&(t.push({t:"edit",node:i,changed:i.changed,changes:{d:i.d}}),e?i.d=!0:delete i.d,i.dirty=!0,i.dirtyStatus=!0,i.changed=!0,"junction"===i.type?RED.events.emit("junctions:change",i):RED.events.emit("nodes:change",i))}t.length>0&&(RED.history.push({t:"multi",events:t,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}RED.view.redraw()}}function Ft(){var e={},t=new Set;be.length()>0&&be.forEach((function(e){"group"!==e.n.type&&t.add(e.n)}));var o=T.filter((function(e){return e.selected&&!e.active}));return o.length>0&&(1===o.length&&o[0].active||o.forEach((function(e){RED.group.getNodes(e,!0).forEach((function(e){t.delete(e)})),t.add(e)}))),t.size>0&&(e.nodes=Array.from(t)),ye.length()>0&&(e.links=ye.toArray(),e.link=e.links[0]),e}function Ut(e,t,o,i){const n=RED.nodes.dirty();var a=/^subflow:(.+)$/.exec(e),r=i?RED.nodes.subflow(i):null;if(r&&a){if(a[1]===r.id)throw new Error(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}));if(RED.nodes.subflowContains(a[1],r.id))throw new Error(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}))}var s={id:RED.nodes.id(),z:i||RED.workspaces.active()};if(s.type=e,s._def=RED.nodes.getType(s.type),a){var d=RED.nodes.subflow(a[1]);s.name="",s.inputs=d.in.length,s.outputs=d.out.length}else{for(var l in s.inputs=s._def.inputs||0,s.outputs=s._def.outputs,s._def.defaults)s._def.defaults.hasOwnProperty(l)&&void 0!==s._def.defaults[l].value&&(s[l]=JSON.parse(JSON.stringify(s._def.defaults[l].value)));if(s._def.onadd)try{s._def.onadd.call(s)}catch(e){console.log("Definition error: "+s.type+".onadd:",e)}}s.changed=!0,s.moved=!0,s.w=RED.view.node_width,s.h=Math.max(RED.view.node_height,15*(s.outputs||0)),s.resize=!0,null!=t&&"number"==typeof t&&t>=0&&(s.x=t),null!=o&&"number"==typeof o&&o>=0&&(s.y=o);var c={t:"add",nodes:[s.id],dirty:n};if(r){var u=RED.subflow.refresh(!0);u&&(c.subflow={id:r.id,changed:r.changed,instances:u.instances})}return{node:s,historyEvent:c}}return{init:function(){if((oe=$("#red-ui-workspace-chart")).on("contextmenu",(function(e){return e.preventDefault(),e.stopPropagation(),RED.contextMenu.show({x:e.clientX-5,y:e.clientY-5}),!1})),ie=d3.select("#red-ui-workspace-chart").append("svg:svg").attr("width",a).attr("height",r).attr("pointer-events","all").style("cursor","crosshair").style("touch-action","none").on("mousedown",(function(){zt()})).on("contextmenu",(function(){d3.event.preventDefault()})),(ne=ie.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","red-ui-workspace-chart-event-layer").on("mousemove",ke).on("mousedown",_e).on("mouseup",Ce).on("mouseenter",(function(){d3.select(document).on("mouseup.red-ui-workspace-tracker",null),z?1!==d3.event.buttons&&(z.remove(),z=null):M===RED.state.PANNING&&4!==d3.event.buttons?Xe():B&&2!==d3.event.buttons&&(B.remove(),B=null,Xe())})).on("mouseleave",Te).on("touchend",(function(){d3.event.preventDefault(),clearTimeout(h),h=null,RED.touch.radialMenu.active()||Ce.call(this)})).on("touchcancel",(function(){RED.view.DEBUG&&console.warn("eventLayer.touchcancel",M),d3.event.preventDefault(),Ce.call(this)})).on("touchstart",(function(){var e;if(RED.view.DEBUG&&console.warn("eventLayer.touchstart",M),d3.event.touches.length>1){clearTimeout(h),h=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),o=e.pageY-t.pageY,i=e.pageX-t.pageX,n=oe.offset(),a=[oe.scrollLeft(),oe.scrollTop()];f=[(t.pageX+i/2-n.left+a[0])/s,(t.pageY+o/2-n.top+a[1])/s],[t.pageX+i/2,t.pageY+o/2],p=Math.sqrt(o*o+i*i)}else{var r=d3.select(document.body),d=[(e=d3.event.touches.item(0)).pageX,e.pageY];f=[e.pageX,e.pageY],p=0;d3.touches(this)[0];h=setTimeout((function(){h=null,It(r,d)}),u)}d3.event.preventDefault()})).on("touchmove",(function(){if(RED.touch.radialMenu.active())d3.event.preventDefault();else{var e;if(RED.view.DEBUG&&console.warn("eventLayer.touchmove",M,L),d3.event.touches.length<2){if(h){var t=(e=d3.event.touches.item(0)).pageX-f[0],o=e.pageY-f[1];Math.abs(t*t+o*o)>64&&(clearTimeout(h),h=null,L||S||(M=RED.state.PANNING,A=[e.pageX,e.pageY],K=[oe.scrollLeft(),oe.scrollTop()]))}else z&&d3.event.preventDefault();ke.call(this)}else{e=d3.event.touches.item(0);var i=d3.event.touches.item(1),n=e.pageY-i.pageY,a=e.pageX-i.pageX,r=(oe.offset(),[oe.scrollLeft(),oe.scrollTop()]),d=Math.sqrt(n*n+a*a),l=[i.pageX+a/2,i.pageY+n/2];if(!isNaN(d)){oldScaleFactor=s,s=Math.min(2,Math.max(.3,s+Math.floor(100*d-100*p)/1e4));var c=[f[0]*(s-oldScaleFactor),f[1]*(s-oldScaleFactor)];p=d,l,oe.scrollLeft(r[0]+c[0]),oe.scrollTop(r[1]+c[1]),At()}}d3.event.preventDefault()}}))).append("svg:rect").attr("class","red-ui-workspace-chart-background").attr("width",a).attr("height",r),ae=ne.append("g").attr("class","red-ui-workspace-chart-grid"),we(),ue=ne.append("g"),le=ne.append("g"),re=ne.append("g"),de=ne.append("g"),se=ne.append("g"),ce=ne.append("g"),pe=[],RED.events.on("workspace:change",(function(e){M=0,0!==e.old&&(g[e.old]={left:oe.scrollLeft(),top:oe.scrollTop()});var t=oe.scrollLeft(),o=oe.scrollTop();y=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",y||0===e.workspace),RED.menu.setDisabled("menu-item-workspace-delete",0===e.workspace||1==RED.workspaces.count()||y),g[e.workspace]?(oe.scrollLeft(g[e.workspace].left),oe.scrollTop(g[e.workspace].top)):(oe.scrollLeft(0),oe.scrollTop(0));var i=oe.scrollLeft()-t,n=oe.scrollTop()-o;null!=A&&(A[0]+=i,A[1]+=n),0===RED.workspaces.selection().length&&ze(),RED.nodes.eachNode((function(e){e.dirty=!0,e.dirtyStatus=!0})),Ge(),Re(),At()})),RED.statusBar.add({id:"view-zoom-controls",align:"right",element:$('<span class="button-group"><button class="red-ui-footer-button" id="red-ui-view-zoom-out"><i class="fa fa-minus"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-zero"><i class="fa fa-circle-o"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-in"><i class="fa fa-plus"></i></button></span>')}),$("#red-ui-view-zoom-out").on("click",Le),RED.popover.tooltip($("#red-ui-view-zoom-out"),RED._("actions.zoom-out"),"core:zoom-out"),$("#red-ui-view-zoom-zero").on("click",Se),RED.popover.tooltip($("#red-ui-view-zoom-zero"),RED._("actions.zoom-reset"),"core:zoom-reset"),$("#red-ui-view-zoom-in").on("click",je),RED.popover.tooltip($("#red-ui-view-zoom-in"),RED._("actions.zoom-in"),"core:zoom-in"),oe.on("DOMMouseScroll mousewheel",(function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?Le():je())})),RED.statusBar.add({id:"view-search-tools",align:"left",hidden:!1,element:$('<span class="button-group"><button class="red-ui-footer-button" id="red-ui-view-searchtools-search"><i class="fa fa-search"></i></button></span><span class="button-group search-counter"><span class="red-ui-footer-button" id="red-ui-view-searchtools-counter">? of ?</span></span><span class="button-group"><button class="red-ui-footer-button" id="red-ui-view-searchtools-prev"><i class="fa fa-chevron-left"></i></button><button class="red-ui-footer-button" id="red-ui-view-searchtools-next"><i class="fa fa-chevron-right"></i></button></span><span class="button-group"><button class="red-ui-footer-button" id="red-ui-view-searchtools-close"><i class="fa fa-close"></i></button></span>')}),$("#red-ui-view-searchtools-search").on("click",Oe),RED.popover.tooltip($("#red-ui-view-searchtools-search"),RED._("actions.search-flows"),"core:search"),$("#red-ui-view-searchtools-prev").on("click",Ie),RED.popover.tooltip($("#red-ui-view-searchtools-prev"),RED._("actions.search-prev"),"core:search-previous"),$("#red-ui-view-searchtools-next").on("click",Ne),RED.popover.tooltip($("#red-ui-view-searchtools-next"),RED._("actions.search-next"),"core:search-next"),RED.popover.tooltip($("#red-ui-view-searchtools-close"),RED._("common.label.close")),oe.droppable({accept:".red-ui-palette-node",drop:function(e,t){d3.event=e;var o=Ut($(t.draggable[0]).attr("data-palette-type"));if(o){var i=o.historyEvent,n=o.node;RED.nodes.add(n);var c=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");void 0===c||n._def.hasOwnProperty("showLabel")&&!n._def.showLabel||n._def.defaults.hasOwnProperty("l")||(n.l=c);var u=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),p=t.helper.width(),f=t.helper.height(),h=d3.touches(this)[0]||d3.mouse(this);try{var g="link in"===n.type||"link out"===n.type,v=n.hasOwnProperty("l")?!n.l:g,b=Je(RED.utils.getNodeLabel(n,n.type),"red-ui-flow-node-label");v?(n.w=l,n.h=Math.max(l,15*(n.outputs||0))):(n.w=Math.max(d,20*Math.ceil((b.width+50+(n._def.inputs>0?7:0))/20)),n.h=Math.max(6+24*b.lines.length,15*(n.outputs||0),30))}catch(e){}h[1]+=this.scrollTop+(f/2-u[1]),h[0]+=this.scrollLeft+(p/2-u[0]),h[1]/=s,h[0]/=s,n.x=h[0],n.y=h[1];var y=n.w/2-5;n.x<y&&(n.x=y);var w=n.h/2-5;n.y<w&&(n.y=w);var E=a-n.w/2+5;n.x>E&&(n.x=E);var D=r-n.h+5;if(n.y>D&&(n.y=D),m){var R=RED.view.tools.calculateGridSnapOffsets(n);n.x-=R.x,n.y-=R.y}var x=$(t.helper).data("splice");if(x){RED.nodes.removeLink(x);var k={source:x.source,sourcePort:x.sourcePort,target:n},T={source:n,sourcePort:0,target:x.target};RED.nodes.addLink(k),RED.nodes.addLink(T),i.links=[k,T],i.removedLinks=[x]}var C=$(t.helper).data("group");C&&(RED.group.addToGroup(C,n),(i={t:"multi",events:[i]}).events.push({t:"addToGroup",group:C,nodes:n})),RED.history.push(i),RED.editor.validateNode(n),RED.nodes.dirty(!0),Ct(),ze(),n.selected=!0,be.add(n),C&&(kt(C,!1),Tt(C),_=C),Re(),Ge(),At(),n._def.autoedit&&RED.editor.edit(n)}}}),oe.on("focus",(function(){$("#red-ui-workspace-tabs").addClass("red-ui-workspace-focussed")})),oe.on("blur",(function(){$("#red-ui-workspace-tabs").removeClass("red-ui-workspace-focussed")})),RED.actions.add("core:copy-selection-to-internal-clipboard",Ve),RED.actions.add("core:cut-selection-to-internal-clipboard",(function(){Ve(!0),Ue()})),RED.actions.add("core:paste-from-internal-clipboard",(function(){Bt(ee,{generateIds:"copy"===te,generateDefaultNames:"copy"===te})})),RED.actions.add("core:detach-selected-nodes",(function(){!function(){var e=RED.view.selection();if(e.nodes){const{newLinks:t,removedLinks:o}=RED.nodes.detachNodes(e.nodes);(o.length||t.length)&&(RED.history.push({t:"multi",events:[{t:"delete",links:o},{t:"add",links:t}],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)),dt([e.nodes[0].x,e.nodes[0].y]),M=RED.state.DETACHED_DRAGGING,RED.view.redraw(!0)}}()})),RED.events.on("view:selection-changed",(function(e){var t=e.nodes&&e.nodes.length>0,o=t&&e.nodes.length>1;RED.menu.setDisabled("menu-item-edit-cut",!t),RED.menu.setDisabled("menu-item-edit-copy",!t),RED.menu.setDisabled("menu-item-edit-select-connected",!t),RED.menu.setDisabled("menu-item-view-tools-move-to-back",!t),RED.menu.setDisabled("menu-item-view-tools-move-to-front",!t),RED.menu.setDisabled("menu-item-view-tools-move-backwards",!t),RED.menu.setDisabled("menu-item-view-tools-move-forwards",!t),RED.menu.setDisabled("menu-item-view-tools-align-left",!o),RED.menu.setDisabled("menu-item-view-tools-align-center",!o),RED.menu.setDisabled("menu-item-view-tools-align-right",!o),RED.menu.setDisabled("menu-item-view-tools-align-top",!o),RED.menu.setDisabled("menu-item-view-tools-align-middle",!o),RED.menu.setDisabled("menu-item-view-tools-align-bottom",!o),RED.menu.setDisabled("menu-item-view-tools-distribute-horizontally",!o),RED.menu.setDisabled("menu-item-view-tools-distribute-veritcally",!o)})),RED.actions.add("core:delete-selection",Ue),RED.actions.add("core:delete-selection-and-reconnect",(function(){Ue(!0)})),RED.actions.add("core:edit-selected-node",Fe),RED.actions.add("core:go-to-selection",(function(){if(be.length()>0){var e=be.get(0).n;/^subflow:/.test(e.type)?RED.workspaces.show(e.type.substring(8)):"group"===e.type&&(Tt(e),At())}})),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:redo",RED.history.redo),RED.actions.add("core:select-all-nodes",Me),RED.actions.add("core:select-none",Ae),RED.actions.add("core:zoom-in",je),RED.actions.add("core:zoom-out",Le),RED.actions.add("core:zoom-reset",Se),RED.actions.add("core:enable-selected-nodes",(function(){Gt(!1)})),RED.actions.add("core:disable-selected-nodes",(function(){Gt(!0)})),RED.actions.add("core:toggle-show-grid",(function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):function(e){e?ae.style("visibility","visible"):ae.style("visibility","hidden")}(e)})),RED.actions.add("core:toggle-snap-grid",(function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):function(e){m=e,At()}(e)})),RED.actions.add("core:toggle-status",(function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(U=e,RED.nodes.eachNode((function(e){e.dirtyStatus=!0,e.dirty=!0})),At())})),RED.view.annotations.init(),RED.view.navigator.init(),RED.view.tools.init(),RED.view.annotations.register("red-ui-flow-node-changed",{type:"badge",class:"red-ui-flow-node-changed",element:function(){var e=document.createElementNS("http://www.w3.org/2000/svg","circle");return e.setAttribute("cx",5),e.setAttribute("cy",5),e.setAttribute("r",5),e},show:function(e){return e.changed||e.moved}}),RED.view.annotations.register("red-ui-flow-node-error",{type:"badge",class:"red-ui-flow-node-error",element:function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d","M 0,9 l 10,0 -5,-8 z"),t},tooltip:function(e){if(e.validationErrors&&e.validationErrors.length>0)return RED._("editor.errors.invalidProperties")+"\n  - "+e.validationErrors.join("\n  - ")},show:function(e){return!e.valid}}),RED.settings.get("editor.view.view-store-zoom")){var e=parseFloat(RED.settings.getLocal("zoom-level"));isNaN(e)||(s=e)}var t=null;function o(){g[RED.workspaces.active()]={left:oe.scrollLeft(),top:oe.scrollTop()},RED.settings.setLocal("scroll-positions",JSON.stringify(g))}if(oe.on("scroll",(function(){RED.settings.get("editor.view.view-store-position")&&(t&&clearTimeout(t),t=setTimeout(o,200))})),RED.settings.get("editor.view.view-store-position")){var i=RED.settings.getLocal("scroll-positions");if(i)try{g=JSON.parse(i)}catch(e){}}},state:function(e){if(null==e)return M;M=e},updateActive:Re,redraw:function(e,t){e&&(Re(),Ge()),t?Mt():At()},focus:zt,importNodes:Bt,calculateTextWidth:function(e,t){for(var o=He(e),i=0,n=0;n<o.length;n++){var a=Ke(o[n],t)[0];i<a&&(i=a)}return i},select:function(e){if(void 0!==e)if(ze(),"string"==typeof e){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,be.clear(),be.add(t))}else e&&e.nodes&&(Re(),be.clear(),e.nodes.forEach((function(e){"group"!==e.type?(e.selected=!0,e.dirty=!0,be.add(e)):kt(e,!0)})));Ge(),At()},selection:Ft,clearSelection:ze,createNode:Ut,get node_width(){return d},get node_height(){return l},get snapGrid(){return m},scale:function(){return s},getLinksAtPoint:function(e,t){for(var o=[],i=ie.selectAll(".red-ui-flow-link-background")[0],n=0;n<i.length;n++){var a=i[n].getBBox();e>=a.x&&t>=a.y&&e<=a.x+a.width&&t<=a.y+a.height&&o.push(i[n])}return o},getGroupAtPoint:Lt,getActiveGroup:function(){return _},reveal:function(e,t){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e,null,null,!0);else{var o=RED.nodes.node(e)||RED.nodes.group(e);if(o)if(!o.z||"group"!==o.type&&"config"===o._def.category)"config"===o._def.category&&RED.sidebar.config.show(e);else{o.dirty=!0,RED.workspaces.show(o.z);var i=[oe[0].clientWidth/s,oe[0].clientHeight/s],n=[oe.scrollLeft()/s,oe.scrollTop()/s],a=o.x,r=o.y;if("group"===o.type&&(a+=o.w/2,r+=o.h/2),a<n[0]||r<n[1]||a>i[0]+n[0]||r>i[1]+n[1]){var d="-="+(n[0]-a+i[0]/2)*s,l="-="+(n[1]-r+i[1]/2)*s;oe.animate({scrollLeft:d,scrollTop:l},200)}!1!==t&&function(e){let t=e;if("string"==typeof t&&(t=RED.nodes.node(e)),!t)return;const o=Q&&RED.nodes.node(Q);o&&(clearInterval(o.__flashTimer),delete o.__flashTimer,o.dirty=!0,o.highlighted=!1),t.__flashTimer=setInterval((function(e,t){t.dirty=!0,e>=Date.now()?t.highlighted=!t.highlighted:(clearInterval(t.__flashTimer),delete t.__flashTimer,Q=null,t.highlighted=!1),RED.view.redraw()}),100,Date.now()+2200,t),Q=t.id,t.highlighted=!0,RED.view.redraw()}(o)}}},gridSize:function(e){if(void 0===e)return v;v=Math.max(5,e),we()},getActiveNodes:function(){return w},getSubflowPorts:function(){var e=[];y&&(ce.selectAll(".red-ui-flow-subflow-port-output").data(y.out,(function(e,t){return e.id})).each((function(t,o){e.push(t)})),ce.selectAll(".red-ui-flow-subflow-port-input").data(y.in,(function(e,t){return e.id})).each((function(t,o){e.push(t)})),ce.selectAll(".red-ui-flow-subflow-port-status").data(y.status?[y.status]:[],(function(e,t){return e.id})).each((function(t,o){e.push(t)})));return e},selectNodes:function(e){$("#red-ui-workspace-tabs-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-header-shade").show(),$("#red-ui-workspace").addClass("red-ui-workspace-select-mode"),M=RED.state.SELECTING_NODE,ze(),e.selected&&e.selected.forEach((function(e){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,be.add(t))})),At();var t=function(){ze(),$("#red-ui-workspace-tabs-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-workspace").removeClass("red-ui-workspace-select-mode"),Xe(),i.close()};(n=e||{}).done=function(e){t(),n.onselect&&n.onselect(e)};var o=[{text:RED._("common.label.cancel"),click:function(e){t(),n.oncancel&&n.oncancel()}}];n.single||o.push({text:RED._("common.label.done"),class:"primary",click:function(e){var t=be.nodes();n.done(t)}});var i=RED.notify(n.prompt||RED._("workspace.selectNodes"),{modal:!1,fixed:!0,type:"compact",buttons:o})},scroll:function(e,t){oe.scrollLeft(oe.scrollLeft()+e),oe.scrollTop(oe.scrollTop()+t)},clickNodeButton:function(e){e._def.button&&Ot(e)},clipboard:function(){return ee},redrawStatus:Pt,showQuickAddDialog:$e,calculateNodeDimensions:function(e){var t=[d,l];try{var o="link in"===e.type||"link out"===e.type,i=e.hasOwnProperty("l")?!e.l:o,n=Je(RED.utils.getNodeLabel(e,e.type),"red-ui-flow-node-label");t[1]=i?Math.max(l,15*(e.outputs||0)):Math.max(6+24*n.lines.length,15*(e.outputs||0),30),t[0]=i?l:Math.max(d,20*Math.ceil((n.width+50+(e._def.inputs>0?7:0))/20))}catch(t){console.log("Error",e)}return t},getElementPosition:it,showTooltip:at,dimensions:function(){return{width:a,height:r}}}}(),RED.view.annotations=function(){var e,t,o={};function i(i,a){var r=o[i];a.el.__annotations__=a.el.__annotations__||[];var s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("class",r.class||""),a.el.__annotations__.push({id:i,element:s});var d=r.element(a.node);r.tooltip&&(d.addEventListener("mouseenter",function(o,i,n){return function(){var a="function"==typeof n?n(i):n;a&&(clearTimeout(e),e=setTimeout((function(){var i=RED.view.getElementPosition(o),n=o.getBoundingClientRect();e=null,t=RED.view.showTooltip(i[0]+n.width/2,i[1],a,"top")}),500))}}(d,a.node,r.tooltip)),d.addEventListener("mouseleave",n)),s.appendChild(d),a.el.appendChild(s)}function n(){clearTimeout(e),t&&(t.remove(),t=null)}return{init:function(){RED.hooks.add("viewRedrawNode.annotations",(function(e){try{e.node.__pendingAnnotation__&&(i(e.node.__pendingAnnotation__,e),delete e.node.__pendingAnnotation__);for(var t=0,n=0,a=0,r=e.el.__annotations__.length;a<r;a++){var s=e.el.__annotations__[a];if(o.hasOwnProperty(s.id)){var d=o[s.id],l=!0,c="badge"===d.type;if(void 0!==d.show&&(l="string"==typeof d.show?!!e.node[d.show]:"function"==typeof d.show?d.show(e.node):!!d.show,s.element.classList.toggle("hide",!l)),c){if(l)t+=(u=s.element.getBoundingClientRect()).width,s.element.setAttribute("transform","translate("+(e.node.w-3-t)+", -8)"),t+=4}else if(l){var u=s.element.getBoundingClientRect();s.element.setAttribute("transform","translate("+(3+n)+", -12)"),n+=u.width+4}}else s.element.parentNode.removeChild(s.element),e.el.__annotations__.splice(a,1),a--,r--}}catch(e){console.log(e)}}))},register:function(e,t){if("badge"!==t.type)throw new Error("Unsupported annotation type: "+t.type);o[e]=t,RED.hooks.add("viewAddNode.annotation-"+e,(function(o){t.filter&&!t.filter(o.node)||i(e,o)})),RED.view.getActiveNodes().forEach((function(t){t.__pendingAnnotation__=e})),RED.view.redraw()},unregister:function(e){delete o[e],RED.hooks.remove("*.annotation-"+e),RED.view.redraw()}}}(),RED.view.navigator=function(){var e,t,o,i,n,a,r,s,d,l=25,c=200,u=200,p=!1;function f(){if(p){var e=i.selectAll(".red-ui-navigator-node").data(RED.view.getActiveNodes(),(function(e){return e.id}));e.exit().remove(),e.enter().insert("rect").attr("class","red-ui-navigator-node").attr("pointer-events","none"),e.each((function(e){d3.select(this).attr("x",(function(e){return(e.x-e.w/2)/l})).attr("y",(function(e){return(e.y-e.h/2)/l})).attr("width",(function(e){return Math.max(9,e.w/l)})).attr("height",(function(e){return Math.max(3,e.h/l)})).attr("fill",(function(e){return RED.utils.getNodeColor(e.type,e._def)}))}))}}function h(){d||g()}function g(){o&&(a=RED.view.scale(),r=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],n=[$("#red-ui-workspace-chart").scrollLeft(),$("#red-ui-workspace-chart").scrollTop()],o.attr("x",n[0]/l).attr("y",n[1]/l).attr("width",r[0]/l/a).attr("height",r[1]/l/a))}function v(){p?(p=!1,e.fadeOut(100),$("#red-ui-workspace-chart").off("scroll",h),$("#red-ui-view-navigate").removeClass("selected")):(p=!0,$("#red-ui-view-navigate").addClass("selected"),g(),f(),$("#red-ui-workspace-chart").on("scroll",h),e.fadeIn(200))}return{init:function(){$(window).on("resize",g),RED.events.on("sidebar:resize",g),RED.actions.add("core:toggle-navigator",v),e=$("<div>").css({position:"absolute",bottom:$("#red-ui-workspace-footer").height(),right:0,zIndex:1}).appendTo("#red-ui-workspace").hide(),(t=d3.select(e[0]).append("svg:svg").attr("width",c).attr("height",u).attr("pointer-events","all").attr("id","red-ui-navigator-canvas")).append("rect").attr("x",0).attr("y",0).attr("width",c).attr("height",u).style({fill:"none",stroke:"none",pointerEvents:"all"}).on("mousedown",(function(){a=RED.view.scale(),r=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],s=[r[0]/l/a,r[1]/l/a];var e=Math.max(0,Math.min(d3.event.offsetX+s[0]/2,c)-s[0]),t=Math.max(0,Math.min(d3.event.offsetY+s[1]/2,u)-s[1]);o.attr("x",e).attr("y",t),d=!0,$("#red-ui-workspace-chart").scrollLeft(e*l*a),$("#red-ui-workspace-chart").scrollTop(t*l*a)})).on("mousemove",(function(){if(d)if(0!==d3.event.buttons){var e=Math.max(0,Math.min(d3.event.offsetX+s[0]/2,c)-s[0]),t=Math.max(0,Math.min(d3.event.offsetY+s[1]/2,u)-s[1]);o.attr("x",e).attr("y",t),$("#red-ui-workspace-chart").scrollLeft(e*l*a),$("#red-ui-workspace-chart").scrollTop(t*l*a)}else d=!1})).on("mouseup",(function(){d=!1})),o=t.append("rect").attr("class","red-ui-navigator-border"),i=t.append("svg:g"),RED.statusBar.add({id:"view-navigator",align:"right",element:$('<button class="red-ui-footer-button-toggle single" id="red-ui-view-navigate"><i class="fa fa-map-o"></i></button>')}),$("#red-ui-view-navigate").on("click",(function(e){e.preventDefault(),v()})),RED.popover.tooltip($("#red-ui-view-navigate"),RED._("actions.toggle-navigator"),"core:toggle-navigator")},refresh:f,resize:g,toggle:v}}(),RED.view.tools=function(){function e(e){var t=RED.view.selection(),o=new Set;t.nodes&&t.nodes.length>0&&(t.nodes.forEach((function(t){var i;o.has(t)||("all"===e?i=RED.nodes.getAllFlowNodes(t):"up"===e?i=[t].concat(RED.nodes.getAllUpstreamNodes(t)):"down"===e&&(i=[t].concat(RED.nodes.getAllDownstreamNodes(t))),i.forEach((function(e){o.add(e)})))})),RED.view.select({nodes:Array.from(o)}))}function t(){var e=RED.view.selection();if(e.nodes){var t=[];e.nodes.forEach((function(e){var o=e.w/2+Math.round((e.x-e.w/2)/RED.view.gridSize())*RED.view.gridSize(),i=Math.round(e.y/RED.view.gridSize())*RED.view.gridSize();e.x===o&&e.y===i||(t.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=o,e.y=i,e.dirty=!0,e.moved=!0)})),t.length>0&&(RED.history.push({t:"move",nodes:t,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}var o=null,i=!1;function n(){if(i=!1,o.length>0){for(var e=[],t=0;t<o.length;t++)e.push({n:o[t].n,ox:o[t].ox,oy:o[t].oy,moved:o[t].moved}),o[t].n.moved=!0,o[t].n.dirty=!0,delete o[t].ox,delete o[t].oy;RED.view.redraw(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),o=null}}function a(e,t){if(null===o){o=[];var a=RED.view.selection();if(a.nodes)for(;a.nodes.length>0;){var r=a.nodes.shift();o.push({n:r}),"group"===r.type&&(a.nodes=a.nodes.concat(r.nodes))}}if(o&&o.length>0){i||($(document).one("keyup",n),i=!0);for(var s,d=RED.view.dimensions(),l=d.width,c=d.height,u=0,p=0,f=0;f<o.length;f++)null==(s=o[f]).ox&&null==s.oy&&(s.ox=s.n.x,s.oy=s.n.y,s.moved=s.n.moved),s.n.moved=!0,s.n.dirty=!0,s.n.x+=e,s.n.y+=t,s.n.x+s.n.w/2>=l&&(s.n.x=l-s.n.w/2),s.n.y+s.n.h/2>=c&&(s.n.y=c-s.n.h/2),s.n.dirty=!0,"group"===s.n.type?(RED.group.markDirty(s.n),u=Math.min(s.n.x-5,u),p=Math.min(s.n.y-5,p)):(u=Math.min(s.n.x-s.n.w/2-5,u),p=Math.min(s.n.y-s.n.h/2-5,p));if(0!==u||0!==p)for(r=0;r<o.length;r++)(s=o[r]).n.x-=u,s.n.y-=p;RED.view.redraw()}else RED.view.scroll(10*e,10*t)}function r(e){var t=RED.view.selection(),o=[],i=[];t.nodes&&t.nodes.forEach((function(e){"subflow"!==e.type&&"group"!==e.type?i.push(e):"group"===e.type&&(i=i.concat(RED.group.getNodes(e,!0)))})),i.forEach((function(t){var i=!1,n=void 0===t.l||t.l,a=!t._def.hasOwnProperty("showLabel")||t._def.showLabel;e?!1!==t.l&&(a||t.hasOwnProperty("l"))||(t.l=!0,i=!0):(a&&(!t.hasOwnProperty("l")||!0===t.l)||!a&&!0===t.l)&&(t.l=!1,i=!0),i&&(o.push({t:"edit",node:t,changed:t.changed,changes:{l:n}}),t.changed=!0,t.dirty=!0,t.resize=!0)})),o.length>0&&(RED.history.push({t:"multi",events:o,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)),RED.view.redraw()}function s(){var e={x:0,y:0},t=RED.view.getActiveGroup();t?(candidates=RED.group.getNodes(t,!1),e=t):candidates=RED.view.getActiveNodes();var o=[];if(candidates.forEach((function(t){var i=t.x-e.x,n=t.y-e.x,a=n*n+i*i;o.push({node:t,delta:a})})),o.length>0){o.sort((function(e,t){return e.delta-t.delta}));var i=o[0].node;i&&(RED.view.select({nodes:[i]}),RED.view.reveal(i.id,!1))}}function d(e){return RED.nodes.filterLinks({source:e}).map((function(e){return e.target}))}function l(e){return RED.nodes.filterLinks({target:e}).map((function(e){return e.source}))}function c(e){var t=new Set;return l(e).forEach((function(e){d(e).forEach((function(e){t.add(e)}))})),d(e).forEach((function(e){l(e).forEach((function(e){t.add(e)}))})),t.delete(e),Array.from(t)}function u(e){var t=RED.view.selection();if(t.nodes&&1===t.nodes.length){var o=t.nodes[0];a=(a=RED.nodes.filterNodes({z:o.z})).concat(RED.view.getSubflowPorts());var i=[];if(a.forEach((function(t){if(t!==o){var n,a=t.x-o.x,r=t.y-o.y,s=r*r+a*a,d=180/Math.PI*Math.atan2(r,a);switch(d<0&&(d+=360),d>360&&(d-=360),e){case"up":if(d<210||d>330)return;n=Math.max(Math.abs(270-d)/60,.2);break;case"down":if(d<30||d>150)return;n=Math.max(Math.abs(90-d)/60,.2);break;case"left":if(d<140||d>220)return;n=Math.max(Math.abs(180-d)/40,.1);break;case"right":if(d>40&&d<320)return;n=Math.max(Math.abs(d)/40,.1)}n=Math.max(n,.1),i.push({node:t,d:s,w:n,delta:s*n})}})),i.length>0)i.sort((function(e,t){return e.delta-t.delta})),(n=i[0].node)&&(RED.view.select({nodes:[n]}),RED.view.reveal(n.id,!1))}else if(0===RED.workspaces.selection().length){var n,a=RED.view.getActiveNodes();i=[];if(a.forEach((function(e){var t=e.x,o=e.y,n=o*o+t*t;i.push({node:e,delta:n})})),i.length>0)i.sort((function(e,t){return e.delta-t.delta})),(n=i[0].node)&&(RED.view.select({nodes:[n]}),RED.view.reveal(n.id,!1))}}function p(e){var t=RED.view.selection();if(t.nodes&&t.nodes.length>1){var o=[],i={minX:Number.MAX_SAFE_INTEGER,minY:Number.MAX_SAFE_INTEGER,maxX:Number.MIN_SAFE_INTEGER,maxY:Number.MIN_SAFE_INTEGER};t.nodes.forEach((function(e){"group"===e.type?(i.minX=Math.min(i.minX,e.x),i.minY=Math.min(i.minY,e.y),i.maxX=Math.max(i.maxX,e.x+e.w),i.maxY=Math.max(i.maxY,e.y+e.h)):(i.minX=Math.min(i.minX,e.x-e.w/2),i.minY=Math.min(i.minY,e.y-e.h/2),i.maxX=Math.max(i.maxX,e.x+e.w/2),i.maxY=Math.max(i.maxY,e.y+e.h/2))})),i.midX=i.minX+(i.maxX-i.minX)/2,i.midY=i.minY+(i.maxY-i.minY)/2,t.nodes.forEach((function(t){var n,a,r="group"===t.type;switch(e){case"top":n=t.x,a=i.minY+(r?0:t.h/2);break;case"bottom":n=t.x,a=i.maxY-(r?t.h:t.h/2);break;case"left":n=i.minX+(r?0:t.w/2),a=t.y;break;case"right":n=i.maxX-(r?t.w:t.w/2),a=t.y;break;case"middle":n=t.x,a=i.midY-(r?t.h/2:0);break;case"center":n=i.midX-(r?t.w/2:0),a=t.y}if(t.x!==n||t.y!==a)if(r){var s=RED.group.getNodes(t,!0),d=t.x-n,l=t.y-a;s.forEach((function(e){"group"!==e.type&&(o.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=e.x-d,e.y=e.y-l,e.dirty=!0,e.moved=!0)}))}else o.push({n:t,ox:t.x,oy:t.y,moved:t.moved}),t.x=n,t.y=a,t.dirty=!0,t.moved=!0})),o.length>0&&(RED.history.push({t:"move",nodes:o,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}function f(e){var t=RED.view.selection();if(t.nodes&&t.nodes.length>2){var o=[],i={minX:Number.MAX_SAFE_INTEGER,minY:Number.MAX_SAFE_INTEGER,maxX:Number.MIN_SAFE_INTEGER,maxY:Number.MIN_SAFE_INTEGER},n=[],a=[];t.nodes.forEach((function(t){var o,r;"group"===t.type?(o=t.x+t.w/2,r=t.y+t.h/2):(o=t.x,r=t.y),"h"===e?(o<i.minX&&(n=[],i.minX=o),o===i.minX&&n.push(t),o>i.maxX&&(a=[],i.maxX=o),o===i.maxX&&a.push(t)):(r<i.minY&&(n=[],i.minY=r),r===i.minY&&n.push(t),r>i.maxY&&(a=[],i.maxY=r),r===i.maxY&&a.push(t))}));var r=n[0],s=a[0],d=0,l=t.nodes.filter((function(t){return t.id!==r.id&&t.id!==s.id&&(d+="h"===e?t.w:t.h,!0)})).sort((function(t,o){return"h"===e?t.x-o.x:t.y-o.y})),c=r.x+r.w/2,u=r.y+r.h/2;"group"===r.type&&(c=r.x+r.w,u=r.y+r.h);var p=s.x,f=s.y;"group"!==s.type&&(p-=s.w/2,f-=s.h/2);for(var h=("h"===e?p-c-d:f-u-d)/(l.length+1),g=c,v=u;l.length>0;){"h"===e?g+=h:v+=h;var m=l.shift(),b="group"===m.type,y=m.x,w=m.y;if(b||(g+=m.w/2,v+=m.h/2),"h"===e&&y!==g||"v"===e&&w!==v)if(b){var E=RED.group.getNodes(m,!0),D="h"===e?y-g:0,R="v"===e?w-v:0;E.forEach((function(e){"group"!==e.type&&(o.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=e.x-D,e.y=e.y-R,e.dirty=!0,e.moved=!0)}))}else o.push({n:m,ox:m.x,oy:m.y,moved:m.moved}),"h"===e?m.x=g:m.y=v,m.dirty=!0,m.moved=!0;b?(g+=m.w,v+=m.h):(g+=m.w/2,v+=m.h/2)}o.length>0&&(RED.history.push({t:"move",nodes:o,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}function h(e){var t=RED.view.selection();if(t.nodes){var o=[];if(t.nodes.forEach((function(e){"group"===e.type?o=o.concat(RED.group.getNodes(e,!0).filter((function(e){return"group"!==e.type}))):"subflow"!==e.type&&o.push(e)})),o.length>0){var i,n=o[0].z,a=RED.nodes.getNodeOrder(n);if("forwards"===e?i=RED.nodes.moveNodesForwards(o):"backwards"===e?i=RED.nodes.moveNodesBackwards(o):"front"===e?i=RED.nodes.moveNodesToFront(o):"back"===e&&(i=RED.nodes.moveNodesToBack(o)),i.length>0){var r=RED.nodes.getNodeOrder(n);RED.history.push({t:"reorder",nodes:{z:n,from:a,to:r},dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0)}}}}function g(e,t){t=Object.assign({renameBlank:!0,renameClash:!0,generateHistory:!0},t);let o=e;if(e?Array.isArray(e)||(o=[e]):o=RED.view.selection().nodes,o&&o.length>0){const i=t.generateHistory&&(!e||!!RED.nodes.node(e.id)),n=[],a={};let r=!1;o.forEach((e=>{const o=e._def||RED.nodes.getType(e.type);if(o&&o.defaults&&o.defaults.name){const s=RED.utils.getPaletteLabel(e.type,o),d=new RegExp("^"+s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+" (\\d+)$");if(!a.hasOwnProperty(e.type)){const t=RED.nodes.filterNodes({type:e.type});let o=0;t.forEach((e=>{let t=d.exec(e.name);if(t){let e=parseInt(t[1]);e>o&&(o=e)}})),a[e.type]=o+1}(t.renameBlank&&""===e.name||t.renameClash&&d.test(e.name))&&(i&&n.push({t:"edit",node:e,changes:{name:e.name},dirty:RED.nodes.dirty(),changed:e.changed}),e.name=s+" "+a[e.type],e.dirty=!0,a[e.type]++,r=!0)}})),r&&(n.length>0&&RED.history.push({t:"multi",events:n}),RED.nodes.dirty(!0),RED.view.redraw())}}return{init:function(){RED.actions.add("core:show-selected-node-labels",(function(){r(!0)})),RED.actions.add("core:hide-selected-node-labels",(function(){r(!1)})),RED.actions.add("core:scroll-view-up",(function(){RED.view.scroll(0,-RED.view.gridSize())})),RED.actions.add("core:scroll-view-right",(function(){RED.view.scroll(RED.view.gridSize(),0)})),RED.actions.add("core:scroll-view-down",(function(){RED.view.scroll(0,RED.view.gridSize())})),RED.actions.add("core:scroll-view-left",(function(){RED.view.scroll(-RED.view.gridSize(),0)})),RED.actions.add("core:step-view-up",(function(){RED.view.scroll(0,-5*RED.view.gridSize())})),RED.actions.add("core:step-view-right",(function(){RED.view.scroll(5*RED.view.gridSize(),0)})),RED.actions.add("core:step-view-down",(function(){RED.view.scroll(0,5*RED.view.gridSize())})),RED.actions.add("core:step-view-left",(function(){RED.view.scroll(-5*RED.view.gridSize(),0)})),RED.actions.add("core:move-selection-up",(function(){a(0,-1)})),RED.actions.add("core:move-selection-right",(function(){a(1,0)})),RED.actions.add("core:move-selection-down",(function(){a(0,1)})),RED.actions.add("core:move-selection-left",(function(){a(-1,0)})),RED.actions.add("core:move-selection-forwards",(function(){h("forwards")})),RED.actions.add("core:move-selection-backwards",(function(){h("backwards")})),RED.actions.add("core:move-selection-to-front",(function(){h("front")})),RED.actions.add("core:move-selection-to-back",(function(){h("back")})),RED.actions.add("core:step-selection-up",(function(){a(0,-RED.view.gridSize())})),RED.actions.add("core:step-selection-right",(function(){a(RED.view.gridSize(),0)})),RED.actions.add("core:step-selection-down",(function(){a(0,RED.view.gridSize())})),RED.actions.add("core:step-selection-left",(function(){a(-RED.view.gridSize(),0)})),RED.actions.add("core:select-connected-nodes",(function(){e("all")})),RED.actions.add("core:select-downstream-nodes",(function(){e("down")})),RED.actions.add("core:select-upstream-nodes",(function(){e("up")})),RED.actions.add("core:go-to-next-node",(function(){!function(){var e=RED.view.selection();if(e.nodes&&1===e.nodes.length){var t=e.nodes[0],o=RED.nodes.filterLinks({source:t});if(o.length>0){o.sort((function(e,o){return Math.abs(e.target.y-t.y)-Math.abs(o.target.y-t.y)}));var i=o[0].target;i&&(RED.view.select({nodes:[i]}),RED.view.reveal(i.id,!1))}}else 0===RED.workspaces.selection().length&&s()}()})),RED.actions.add("core:go-to-previous-node",(function(){!function(){var e=RED.view.selection();if(e.nodes&&1===e.nodes.length){var t=e.nodes[0],o=RED.nodes.filterLinks({target:t});if(o.length>0){o.sort((function(e,o){return Math.abs(e.source.y-t.y)-Math.abs(o.source.y-t.y)}));var i=o[0].source;i&&(RED.view.select({nodes:[i]}),RED.view.reveal(i.id,!1))}}else 0===RED.workspaces.selection().length&&s()}()})),RED.actions.add("core:go-to-next-sibling",(function(){!function(){var e=RED.view.selection();if(e.nodes&&1===e.nodes.length){var t=e.nodes[0],o=c(t);if(o.length>0){(o=o.filter((function(e){return e.y>t.y}))).sort((function(e,o){return Math.abs(e.y-t.y)-Math.abs(o.y-t.y)}));var i=o[0];i&&(RED.view.select({nodes:[i]}),RED.view.reveal(i.id,!1))}}else 0===RED.workspaces.selection().length&&s()}()})),RED.actions.add("core:go-to-previous-sibling",(function(){!function(){var e=RED.view.selection();if(e.nodes&&1===e.nodes.length){var t=e.nodes[0],o=c(t);if(o.length>0){(o=o.filter((function(e){return e.y<t.y}))).sort((function(e,o){return Math.abs(e.y-t.y)-Math.abs(o.y-t.y)}));var i=o[0];i&&(RED.view.select({nodes:[i]}),RED.view.reveal(i.id,!1))}}else 0===RED.workspaces.selection().length&&s()}()})),RED.actions.add("core:go-to-nearest-node-on-left",(function(){u("left")})),RED.actions.add("core:go-to-nearest-node-on-right",(function(){u("right")})),RED.actions.add("core:go-to-nearest-node-above",(function(){u("up")})),RED.actions.add("core:go-to-nearest-node-below",(function(){u("down")})),RED.actions.add("core:align-selection-to-grid",t),RED.actions.add("core:align-selection-to-left",(function(){p("left")})),RED.actions.add("core:align-selection-to-right",(function(){p("right")})),RED.actions.add("core:align-selection-to-top",(function(){p("top")})),RED.actions.add("core:align-selection-to-bottom",(function(){p("bottom")})),RED.actions.add("core:align-selection-to-middle",(function(){p("middle")})),RED.actions.add("core:align-selection-to-center",(function(){p("center")})),RED.actions.add("core:distribute-selection-horizontally",(function(){f("h")})),RED.actions.add("core:distribute-selection-vertically",(function(){f("v")})),RED.actions.add("core:wire-series-of-nodes",(function(){!function(){var e=RED.view.selection();if(e.nodes&&e.nodes.length>1){for(var t=0,o=[];t<e.nodes.length-1;){var i=e.nodes[t],n=e.nodes[t+1];if(i.outputs>0&&n.inputs>0&&0===RED.nodes.filterLinks({source:i,target:n,sourcePort:0}).length){var a={source:i,target:n,sourcePort:0};RED.nodes.addLink(a),o.push(a)}t++}o.length>0&&(RED.history.push({t:"add",links:o,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}()})),RED.actions.add("core:wire-node-to-multiple",(function(){!function(){var e=RED.view.selection();if(e.nodes&&e.nodes.length>1){var t=e.nodes[0];if(0===t.outputs)return;for(var o=1,i=[];o<e.nodes.length;){var n=e.nodes[o];if(n.inputs>0&&0===RED.nodes.filterLinks({source:t,target:n,sourcePort:Math.min(t.outputs-1,o-1)}).length){var a={source:t,target:n,sourcePort:Math.min(t.outputs-1,o-1)};RED.nodes.addLink(a),i.push(a)}o++}i.length>0&&(RED.history.push({t:"add",links:i,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}()})),RED.actions.add("core:split-wire-with-link-nodes",(function(){!function(t){let o=t||RED.view.selection().links&&RED.view.selection().links.filter((e=>!e.link));if(!o)return;if(Array.isArray(o)||(o=[o]),o.length<1)return;const i={t:"multi",events:[],dirty:RED.nodes.dirty()},n={},a={},r=RED.view.gridSize();for(let e=0;e<o.length;e++){const t=o[e],d=t.source,l=t.target;var s=function(e,t,o,i,n){const a=RED.view.calculateNodeDimensions(t);t.w=a[0],t.h=a[1];const s={x:e.x||0,y:e.y||0,w:e.w||RED.view.node_width,h:e.h||RED.view.node_height},d=s.x-s.w/2;if(s.x=o?d-r-t.w/2:d+s.w+r+t.w/2,t.x=s.x,t.y=s.y,!1!==i){const e=RED.view.tools.calculateGridSnapOffsets(t);t.x-=e.x,t.y-=e.y}t.y+=n||0};const c=t.sourcePort||0;let u=d.id+":"+c,p=n[u];if(!p){const e=RED.view.createNode("link out");p=e.node,n[u]=p;let o=0;if(d.outputs>1){const e=(d.outputs-1)/2+1,t=Math.abs(e-(c+1));o=2*r*t,c+1<e&&(o=-o),s(d,p,!1,!1,o)}else s(d,p,!1,RED.view.snapGrid,o);RED.nodes.add(p),RED.editor.validateNode(p),i.events.push(e.historyEvent);const a={source:d,sourcePort:t.sourcePort||0,target:p};RED.nodes.addLink(a),i.events.push({t:"add",links:[a]})}let f=a[l.id];if(!f){const e=RED.view.createNode("link in");f=e.node,a[l.id]=f,s(l,f,!0,RED.view.snapGrid,0),RED.nodes.add(f),RED.editor.validateNode(f),i.events.push(e.historyEvent);const t={source:f,sourcePort:0,target:l};RED.nodes.addLink(t),i.events.push({t:"add",links:[t]})}-1==f.links.indexOf(p.id)&&f.links.push(p.id),-1==p.links.indexOf(f.id)&&p.links.push(f.id),RED.nodes.removeLink(t),i.events.push({t:"delete",links:[t]})}RED.history.push(i),RED.view.clearSelection(),RED.view.select({nodes:Object.values(a)}),e("down"),RED.nodes.dirty(!0),RED.view.redraw(!0)}()})),RED.actions.add("core:split-wires-with-junctions",(function(){!function(e){let t=e||RED.view.selection().links&&RED.view.selection().links.filter((e=>!e.link));if(!t)return;if(Array.isArray(t)||(t=[t]),0===t.length)return;var o=new Set,i=[],n=[],a={};t.forEach((function(e){var t=e.source.id+":"+e.sourcePort;a[t]=a[t]||[],a[t].push(e),a[e.target.id]=a[e.target.id]||[],a[e.target.id].push(e)}));var r=Object.keys(a);r.sort((function(e,t){return a[t].length-a[e].length}));const s=RED.nodes.dirty();r.forEach((function(e){var t=a[e],r={_def:{defaults:{}},type:"junction",z:RED.workspaces.active(),id:RED.nodes.id(),x:0,y:0,w:0,h:0,outputs:1,inputs:1,dirty:!0};if(0===(t=t.filter((function(e){return!o.has(e)}))).length)return;let s=0;if(t.forEach((function(e){e._sliceLocation?(r.x+=e._sliceLocation.x,r.y+=e._sliceLocation.y,delete e._sliceLocation,s++):(r.x+=e.source.x+e.source.w/2+e.target.x-e.target.w/2,r.y+=e.source.y+e.target.y,s+=2)})),r.x=Math.round(r.x/s),r.y=Math.round(r.y/s),RED.view.snapGrid){let e=RED.view.gridSize();r.x=e*Math.round(r.x/e),r.y=e*Math.round(r.y/e)}var d=new Set;let l;if(RED.nodes.addJunction(r),n.push(r),l=e===t[0].source.id+":"+t[0].sourcePort?{source:t[0].source,sourcePort:t[0].sourcePort,target:r}:{source:r,sourcePort:0,target:t[0].target},i.push(l),RED.nodes.addLink(l),t.forEach((function(t){let n;o.add(t),RED.nodes.removeLink(t),n=e===t.target.id?{source:t.source,sourcePort:t.sourcePort,target:r}:{source:r,sourcePort:0,target:t.target},i.push(n),RED.nodes.addLink(n),d.add(t.source.g||"__NONE__"),d.add(t.target.g||"__NONE__")})),1===d.size){var c=d.values().next().value;"__NONE__"!==c&&RED.group.addToGroup(RED.nodes.group(c),r)}})),n.length>0&&(RED.history.push({dirty:s,t:"add",links:i,junctions:n,removedLinks:Array.from(o)}),RED.nodes.dirty(!0),RED.view.select({nodes:n})),RED.view.redraw(!0)}()})),RED.actions.add("core:generate-node-names",g)},alignSelectionToGrid:t,moveSelection:a,calculateGridSnapOffsets:function(e,t){t=t||{align:"nearest"};const o={x:0,y:0},i=RED.view.gridSize(),n=e.x-(i*Math.round((e.x-e.w/2)/i)+e.w/2),a=e.x-(i*Math.round((e.x+e.w/2)/i)-e.w/2);return o.x=a,"right"===t.align||("left"===t.align||Math.abs(n)<Math.abs(a))&&(o.x=n),o.y=e.y-i*Math.round(e.y/i),o}}}(),RED.sidebar=function(){var e,t={},o=null;var i={};function n(t){t?($("#red-ui-main-container").removeClass("red-ui-sidebar-closed"),e.resize()):$("#red-ui-main-container").addClass("red-ui-sidebar-closed"),RED.events.emit("sidebar:resize")}function a(i,n){":first"===i&&(i=o||RED.settings.get("editor.sidebar.order",["info","help","version-control","debug"])[0]),i&&(!r(i)&&t[i]&&e.addTab(t[i]),e.activateTab(i),n||RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function r(t){return e.contains(t)}return i.dragging=!1,{init:function(){!function(){$("#red-ui-sidebar-separator").draggable({axis:"x",start:function(e,t){i.closing=!1,i.opening=!1;var o=$("#red-ui-editor").width();i.start=t.position.left,i.chartWidth=$("#red-ui-workspace").width(),i.chartRight=o-$("#red-ui-workspace").width()-$("#red-ui-workspace").offset().left-2,i.dragging=!0,RED.menu.isSelected("menu-item-sidebar")||(i.opening=!0,$("#red-ui-sidebar").addClass("closing"),$("#red-ui-workspace").css("right",7),$("#red-ui-editor-stack").css("right",8),$("#red-ui-sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")),i.width=$("#red-ui-sidebar").width()},drag:function(t,o){var n=o.position.left-i.start,a=i.width-n;i.opening&&(a-=3),a>150&&i.chartWidth+n<200&&(o.position.left=200+i.start-i.chartWidth,n=o.position.left-i.start,a=i.width-n),a<150?(i.closing||($("#red-ui-sidebar").addClass("closing"),i.closing=!0),i.opening||(a=150,o.position.left=i.width-(150-i.start),n=o.position.left-i.start)):a>150&&(i.closing||i.opening)&&(i.closing=!1,$("#red-ui-sidebar").removeClass("closing"));var r=i.chartRight-n;$("#red-ui-workspace").css("right",r),$("#red-ui-editor-stack").css("right",r+1),$("#red-ui-sidebar").width(a),e.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){i.dragging=!1,i.closing&&($("#red-ui-sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#red-ui-sidebar").width()<180&&($("#red-ui-sidebar").width(180),$("#red-ui-workspace").css("right",187),$("#red-ui-editor-stack").css("right",188))),$("#red-ui-sidebar-separator").css("left","auto"),$("#red-ui-sidebar-separator").css("right",$("#red-ui-sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}});var t=$('<div class="red-ui-sidebar-control-right"><i class="fa fa-chevron-right"</div>').appendTo($("#red-ui-sidebar-separator"));t.on("click",(function(){t.hide(),RED.menu.toggleSelected("menu-item-sidebar")})),$("#red-ui-sidebar-separator").on("mouseenter",(function(){i.dragging||(RED.menu.isSelected("menu-item-sidebar")?t.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"):t.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left"),t.toggle("slide",{direction:"right"},200))})),$("#red-ui-sidebar-separator").on("mouseleave",(function(){i.dragging||(t.stop(!1,!0),t.hide())}))}(),e=RED.tabs.create({element:$('<ul id="red-ui-sidebar-tabs"></ul>').appendTo("#red-ui-sidebar"),onchange:function(e){$("#red-ui-sidebar-content").children().hide(),$("#red-ui-sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show(),RED.settings.setLocal("last-sidebar-tab",e.id)},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},collapsible:!0,onreorder:function(e){RED.settings.set("editor.sidebar.order",e)},order:RED.settings.get("editor.sidebar.order",["info","help","version-control","debug"])}),$('<div id="red-ui-sidebar-content"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-shade" class="hide"></div>').appendTo("#red-ui-sidebar"),RED.actions.add("core:toggle-sidebar",(function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):n(e)})),RED.popover.tooltip($("#red-ui-sidebar-separator").find(".red-ui-sidebar-control-right"),RED._("keyboard.toggleSidebar"),"core:toggle-sidebar"),o=RED.settings.getLocal("last-sidebar-tab"),RED.sidebar.info.init(),RED.sidebar.help.init(),RED.sidebar.config.init(),RED.sidebar.context.init(),$("#red-ui-editor").width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(o,i,n,r){var s;"string"==typeof o?s={id:i.id,label:o,name:o,content:i,closeable:n,visible:r}:"object"==typeof o&&(s=o),delete s.closeable,s.wrapper=$("<div>",{style:"height:100%"}).appendTo("#red-ui-sidebar-content"),s.wrapper.append(s.content),s.wrapper.hide(),s.enableOnEdit||(s.shade=$("<div>",{class:"red-ui-sidebar-shade hide"}).appendTo(s.wrapper)),s.toolbar&&($("#red-ui-sidebar-footer").append(s.toolbar),$(s.toolbar).hide()),s.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+s.id,label:s.name,onselect:function(){a(s.id)},group:"sidebar-tabs"}),s.iconClass=s.iconClass||"fa fa-square-o",t[s.id]=s,!1!==s.visible&&e.addTab(t[s.id])},removeTab:function(o){e.removeTab(o),$(t[o].wrapper).remove(),t[o].footer&&t[o].footer.remove(),delete t[o],RED.menu.removeItem("menu-item-view-menu-"+o)},show:a,containsTab:r,toggleSidebar:n}}(),RED.palette=function(){var e,t=["config","unknown","deprecated"],o=["subflows","common","function","network","input","output","sequence","parser","storage","analysis","social","advanced"],i={};function n(e,t,o,i){0===$("#red-ui-palette-base-category-"+t).length&&a(e,t,i+":palette.label."+t),$("#red-ui-palette-container-"+t).show(),0===$("#red-ui-palette-"+o).length&&$("#red-ui-palette-base-category-"+t).append('<div id="red-ui-palette-'+o+'"></div>')}function a(e,t,o){var n=RED._(o,{defaultValue:t});n=(n||t).replace(/_/g," ");var a=$('<div id="red-ui-palette-container-'+t+'" class="red-ui-palette-category hide"><div id="red-ui-palette-header-'+t+'" class="red-ui-palette-header"><i class="expanded fa fa-angle-down"></i><span>'+n+'</span></div><div class="red-ui-palette-content" id="red-ui-palette-base-category-'+t+'"><div id="red-ui-palette-'+t+'"></div><div id="red-ui-palette-'+t+'-input"></div><div id="red-ui-palette-'+t+'-output"></div><div id="red-ui-palette-'+t+'-function"></div></div></div>').appendTo("#red-ui-palette-container");a.data("category",e),a.data("label",n),i[t]={container:a,close:function(){a.removeClass("red-ui-palette-open"),a.addClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideUp(),$("#red-ui-palette-header-"+t+" i").removeClass("expanded")},open:function(){a.addClass("red-ui-palette-open"),a.removeClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideDown(),$("#red-ui-palette-header-"+t+" i").addClass("expanded")},toggle:function(){a.hasClass("red-ui-palette-open")?i[t].close():i[t].open()}},$("#red-ui-palette-header-"+t).on("click",(function(e){i[t].toggle()}))}function r(e,t,o,i){t.attr("data-palette-label",o);for(var n=(o=RED.utils.sanitize(o)).split(/([ -]|\\n )/),a=[],r="",s=0;s<n.length;s++){var d=n[s];if("\\n "!==d){var l=0==s?"":" ";if(RED.view.calculateTextWidth(r+l+d,"red-ui-palette-label")<82)r+=l+d;else for(s>0&&a.push(r);;){if(!(RED.view.calculateTextWidth(d,"red-ui-palette-label")>=82)){r=d;break}for(var c=d.length;c>0;c--){var u=d.substring(0,c);if(RED.view.calculateTextWidth(u,"red-ui-palette-label")<82){a.push(u),d=d.substring(c);break}}}}else a.push(r),r=""}a.push(r);var p,f=a.join("<br/>"),h=8+20*a.length;t.css({height:h+"px"}),t.find(".red-ui-palette-label").html(f).attr("dir",RED.text.bidi.resolveBaseTextDir(f)),t.find(".red-ui-palette-port").css({top:h/2-5+"px"});try{var g="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(o)+"</b></p>";(p=$("<div></div>").append($(g+(i||(RED.nodes.getNodeHelp(e)||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter((function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&this.textContent.trim().length>0})).slice(0,2))).find("a").each((function(){var e=$(this).text();$(this).before(e),$(this).remove()}));var v=RED.nodes.getType(e);if(v){var m="";v&&!/^subflow:/.test(e)&&(m=v.set.module+" : "),m+=e,/^subflow:/.test(e)&&$('<button type="button" onclick="RED.workspaces.show(\''+e.substring(8).replace(/'/g,"\\'")+'\'); return false;" class="red-ui-button red-ui-button-small" style="float: right; margin-left: 5px;"><i class="fa fa-pencil"></i></button>').appendTo(p);var b=e.replace(/'/g,"\\'");$('<button type="button" onclick="RED.search.show(\'type:'+b+'\'); return false;" class="red-ui-button red-ui-button-small" style="float: right; margin-left: 5px;"><i class="fa fa-search"></i></button>').appendTo(p),$('<button type="button" onclick="RED.sidebar.help.show(\''+b+'\'); return false;" class="red-ui-button red-ui-button-small" style="float: right; margin-left: 5px;"><i class="fa fa-book"></i></button>').appendTo(p),$("<p>",{style:"font-size: 0.8em"}).text(m).appendTo(p)}}catch(t){console.log("Error generating pop-over label for ",e),console.log(t.toString()),p="<p><b>"+o+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}t.data("popover").setContent(p)}function s(e){return $(".red-ui-palette-node[data-palette-type='"+e+"']")}function d(e){return e.replace(/[\x00-\x2c\x2e-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]/g,"_")}function l(e,a){if(!s(e).length){var l=a.category;if(-1===t.indexOf(l)){var c=d(l),u=c.split("-")[0],p=$("<div>",{class:"red-ui-palette-node"}).attr("data-palette-type",e).data("category",u),f=RED.utils.getPaletteLabel(e,a);if($("<div/>",{class:"red-ui-palette-label"+(!a.align&&0!==a.inputs&&0===a.outputs||"right"===a.align?" red-ui-palette-label-right":"")}).appendTo(p),a.icon){var h=RED.utils.getNodeIcon(a),g=$("<div/>",{class:"red-ui-palette-icon-container"+(!a.align&&0!==a.inputs&&0===a.outputs||"right"===a.align?" red-ui-palette-icon-container-right":"")}).appendTo(p);g.attr("data-palette-icon",h),RED.utils.createIconElement(h,g,!0)}if(p.css("backgroundColor",RED.utils.getNodeColor(e,a)),a.outputs>0){var v=document.createElement("div");v.className="red-ui-palette-port red-ui-palette-port-output",p.append(v)}if(a.inputs>0){var m=document.createElement("div");m.className="red-ui-palette-port red-ui-palette-port-input",p.append(m)}n(l,u,c,-1!==o.indexOf(u)?"node-red":a.set.id),$("#red-ui-palette-"+c).append(p),p.on("mousedown",(function(e){e.preventDefault()}));var b=RED.popover.create({target:p,trigger:"hover",interactive:!0,width:"300px",content:"hi",delay:{show:750,hide:50}});p.data("popover",b);var y,w,E,D,R,x,_,k,T,C=$("#red-ui-workspace-chart"),j=$("#red-ui-workspace-chart>svg").get(0);$(p).draggable({helper:"clone",appendTo:"#red-ui-editor",revert:"invalid",revertDuration:200,containment:"#red-ui-main-container",start:function(){k=$("#red-ui-palette").width(),T=$("#red-ui-palette").parent().position().top+$("#red-ui-palette-container").position().top,_=null,(x=RED.view.getActiveGroup())&&document.getElementById("group_select_"+x.id).classList.add("red-ui-flow-group-active-hovered"),RED.view.focus()},stop:function(){d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),_&&document.getElementById("group_select_"+_.id).classList.remove("red-ui-flow-group-hovered"),x&&document.getElementById("group_select_"+x.id).classList.remove("red-ui-flow-group-active-hovered"),D&&(clearTimeout(D),D=null),R&&(clearTimeout(R),R=null)},drag:function(t,o){var i=s(e);o.originalPosition.left=i.offset().left,w=o.position.left-k+o.helper.width()/2+C.scrollLeft(),E=o.position.top-T+o.helper.height()/2+C.scrollTop()+10,R||(R=setTimeout((function(){var e=w/RED.view.scale(),t=E/RED.view.scale(),i=RED.view.getGroupAtPoint(e,t);i!==_&&(_&&document.getElementById("group_select_"+_.id).classList.remove("red-ui-flow-group-hovered"),i&&document.getElementById("group_select_"+i.id).classList.add("red-ui-flow-group-hovered"),(_=i)?$(o.helper).data("group",_):$(o.helper).removeData("group")),R=null}),200)),a.inputs>0&&a.outputs>0&&(D||(D=setTimeout((function(){var e=[],t=1/0,i=null;if(j.getIntersectionList){var n=j.createSVGRect();n.x=w,n.y=E,n.width=1,n.height=1,e=j.getIntersectionList(n,j)}else e=RED.view.getLinksAtPoint(w,E);for(var a=w/RED.view.scale(),r=E/RED.view.scale(),s=0;s<e.length;s++){var d=d3.select(e[s]);if(d.classed("red-ui-flow-link-background")&&!d.classed("red-ui-flow-link-link"))for(var l=e[s].getTotalLength(),c=0;c<l;c+=10){var u=e[s].getPointAtLength(c),p=(u.x-a)*(u.x-a)+(u.y-r)*(u.y-r);p<200&&p<t&&(t=p,i=e[s])}}y&&y!==i&&d3.select(y.parentNode).classed("red-ui-flow-link-splice",!1),i?d3.select(i.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),y!==i&&(i?$(o.helper).data("splice",d3.select(i).data()[0]):$(o.helper).removeData("splice")),y=i,D=null}),200)))}});var L=null;if(0===e.indexOf("subflow:")){p.on("dblclick",(function(t){RED.workspaces.show(e.substring(8)),t.preventDefault()}));var S=RED.nodes.subflow(e.substring(8));L=RED.utils.renderMarkdown(S.info||"")}r(e,p,f,L),1===$("#red-ui-palette-container-"+u).find(".red-ui-palette-node").length&&i[u].open()}}}function c(e){var t=s(e),o=t.closest(".red-ui-palette-category");t.remove(),0===o.find(".red-ui-palette-node").length&&o.find("i").hasClass("expanded")&&(o.find(".red-ui-palette-content").slideToggle(),o.find("i").toggleClass("expanded"))}function u(e){var t=s(e);t.hide();for(var o=t.closest(".red-ui-palette-category"),i=o.find(".red-ui-palette-node"),n=0,a=0;a<i.length;a++)"none"===$(i[a]).css("display")&&(n+=1);n===i.length&&o.hide()}function p(e){var t=s(e);t.closest(".red-ui-palette-category").show(),t.show()}function f(e){var t=s("subflow:"+e.id),o=t.find(".red-ui-palette-port-input"),a=t.find(".red-ui-palette-port-output");if(t.find(".red-ui-palette-label").attr("class","red-ui-palette-label"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-label-right":"")),t.find(".red-ui-palette-icon-container").attr("class","red-ui-palette-icon-container"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-icon-container-right":"")),0===o.length&&e.in.length>0){var l=document.createElement("div");l.className="red-ui-palette-port red-ui-palette-port-input",t.append(l)}else 0!==o.length&&0===e.in.length&&o.remove();if(0===a.length&&e.out.length>0){var c=document.createElement("div");c.className="red-ui-palette-port red-ui-palette-port-output",t.append(c)}else 0!==a.length&&0===e.out.length&&a.remove();var u=t.attr("data-palette-label"),p=t.attr("data-palette-info");u===e.name&&p===e.info||(t.attr("data-palette-info",e.info),r(e.type+":"+e.id,t,e.name,RED.utils.renderMarkdown(e.info||""))),function(e,t){var o=RED.utils.getNodeIcon(t._def),i=e.find(".red-ui-palette-icon-container");i.attr("data-palette-icon")!==o&&(i.attr("data-palette-icon",o),RED.utils.createIconElement(o,i,!0))}(t,e);var f=t.data("category"),h=e.category||"subflows";if(f!==h){var g=d(h);n(h,g,g,"node-red");var v=t.closest(".red-ui-palette-category"),m=$("#red-ui-palette-"+g);m.append(t),1===m.find(".red-ui-palette-node").length&&i[g].open(),t.data("category",h),0===v.find(".red-ui-palette-node").length&&v.find("i").hasClass("expanded")&&(v.find(".red-ui-palette-content").slideToggle(),v.find("i").toggleClass("expanded"))}t.css("backgroundColor",e.color)}return{init:function(){$('<img src="red/images/spin.svg" class="red-ui-palette-spinner hide"/>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-search" class="red-ui-palette-search hide"><input type="text" data-i18n="[placeholder]palette.filter"></input></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-container" class="red-ui-palette-scroll hide"></div>').appendTo("#red-ui-palette"),$('<div class="red-ui-component-footer"></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-shade" class="hide"></div>').appendTo("#red-ui-palette"),$("#red-ui-palette > .red-ui-palette-spinner").show(),RED.events.on("registry:node-type-added",(function(e){var t=RED.nodes.getType(e);l(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)})),RED.events.on("registry:node-type-removed",(function(e){c(e)})),RED.events.on("registry:node-set-enabled",(function(e){for(var t=0;t<e.types.length;t++){p(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteadd&&"function"==typeof o.onpaletteadd&&o.onpaletteadd.call(o)}})),RED.events.on("registry:node-set-disabled",(function(e){for(var t=0;t<e.types.length;t++){u(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteremove&&"function"==typeof o.onpaletteremove&&o.onpaletteremove.call(o)}})),RED.events.on("registry:node-set-removed",(function(e){if(e.added)for(var t=0;t<e.types.length;t++){c(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteremove&&"function"==typeof o.onpaletteremove&&o.onpaletteremove.call(o)}})),RED.events.on("subflows:change",f),$("#red-ui-palette-search input").searchBox({delay:100,change:function(){!function(e){var t=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(var o in $("#red-ui-palette-container .red-ui-palette-node").each((function(o,i){var n=$(i).attr("data-palette-label"),a=$(i).attr("data-palette-type");""===e||t.test(a)||t.test(n)?$(this).show():$(this).hide()})),i)i.hasOwnProperty(o)&&(0===i[o].container.find(".red-ui-palette-node").filter((function(){return"none"!==$(this).css("display")})).length?(i[o].close(),i[o].container.slideUp()):(i[o].open(),i[o].container.show()))}($(this).val())}}),e=$('<div class="red-ui-sidebar-control-left"><i class="fa fa-chevron-left"></i></div>').appendTo($("#red-ui-palette")),RED.popover.tooltip(e,RED._("keyboard.togglePalette"),"core:toggle-palette"),e.on("click",(function(){RED.menu.toggleSelected("menu-item-palette")})),$("#red-ui-palette").on("mouseenter",(function(){e.toggle("slide",{direction:"left"},200)})),$("#red-ui-palette").on("mouseleave",(function(){e.stop(!1,!0),e.hide()}));var t=[];RED.settings.paletteCategories?t=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(t=RED.settings.theme("palette.categories")),Array.isArray(t)||(t=[]);var n={};t.forEach((function(e){n[e]=!0,a(e,d(e),"palette.label."+d(e))})),o.forEach((function(e){n[e]||a(e,d(e),"palette.label."+d(e))}));var r=$('<span class="button-group"></span>').appendTo("#red-ui-palette .red-ui-component-footer"),s=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-up"></i></button>').appendTo(r);s.on("click",(function(e){for(var t in e.preventDefault(),i)i.hasOwnProperty(t)&&i[t].close()})),RED.popover.tooltip(s,RED._("palette.actions.collapse-all"));var h=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-down"></i></button>').appendTo(r);h.on("click",(function(e){for(var t in e.preventDefault(),i)i.hasOwnProperty(t)&&i[t].open()})),RED.popover.tooltip(h,RED._("palette.actions.expand-all")),RED.actions.add("core:toggle-palette",(function(t){void 0===t?RED.menu.toggleSelected("menu-item-palette"):function(t){t?($("#red-ui-main-container").removeClass("red-ui-palette-closed"),e.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left")):($("#red-ui-main-container").addClass("red-ui-palette-closed"),e.hide(),e.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"));setTimeout((function(){$(window).trigger("resize")}),200)}(t)}))},add:l,remove:c,hide:u,show:p,refresh:function(){RED.nodes.eachSubflow(f)},getCategories:function(){var e=[];return $("#red-ui-palette-container .red-ui-palette-category").each((function(t,o){e.push({id:$(o).data("category"),label:$(o).data("label")})})),e}}}(),RED.sidebar.info=function(){var e,t,o,i,n,a,r,s,d,l,c,u={property:!1};function p(){if(t){var o=$(e).parent().height()-l.outerHeight();t.resize(o)}}function f(){RED.sidebar.show("info")}function h(e){if(void 0!==e){var t;$(o).empty();var i,l,c=$('<table class="red-ui-info-table"></table>').appendTo(o),p=$("<tbody>").appendTo(c);if(null===e)return RED.sidebar.info.outliner.select(null),n.empty(),a.text(""),r.hide(),void s.hide();if(Array.isArray(e)){RED.sidebar.info.outliner.select(e),n.empty(),RED.utils.createNodeIcon({type:"_selection_"}).appendTo(n),a.text("Selection"),r.hide(),s.hide(),d=null;var f={nodes:0,flows:0,subflows:0,groups:0};e.forEach((function(e){"tab"===e.type?(f.flows++,f.nodes+=RED.nodes.filterNodes({z:e.id}).length):"subflow"===e.type?f.subflows++:"group"===e.type?f.groups++:f.nodes++})),t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(p);var h=$("<div>").appendTo($(t.children()[1]));f.flows>0&&$("<div>").text(RED._("clipboard.flow",{count:f.flows})).appendTo(h),f.subflows>0&&$("<div>").text(RED._("clipboard.subflow",{count:f.subflows})).appendTo(h),f.nodes>0&&$("<div>").text(RED._("clipboard.node",{count:f.nodes})).appendTo(h),f.groups>0&&$("<div>").text(RED._("clipboard.group",{count:f.groups})).appendTo(h)}else{RED.sidebar.info.outliner.select(e);var g=/^subflow(:(.+))?$/.exec(e.type);if(g){(i=g[2]?RED.nodes.subflow(g[2]):e).id;l=i.instances.length}n.empty(),RED.utils.createNodeIcon(e).appendTo(n);var m=RED.utils.getNodeLabel(e,e.type+": "+e.id),b=m.indexOf("\\n");b>-1&&(m=m.substring(0,b)+"..."),a.text(m),r.show(),d=e,t=$('<tr class="red-ui-help-info-row"><td></td><td></td></tr>').appendTo(p);var y="node";if("subflow"===e.type||g?y="subflow":"tab"===e.type?y="flow":"group"===e.type&&(y="group"),$(t.children()[0]).text(RED._("sidebar.info."+y)),RED.utils.createObjectElement(e.id,{sourceId:e.id}).appendTo(t.children()[1]),"tab"===e.type||"subflow"===e.type)s.hide();else if("group"===e.type){s.hide(),t=$('<tr class="red-ui-help-info-row"><td>&nbsp;</td><td></td></tr>').appendTo(p);var w={nodes:0,groups:0};RED.group.getNodes(e,!0).forEach((function(e){"group"===e.type?w.groups++:w.nodes++}));h=$("<div>").appendTo($(t.children()[1]));w.nodes>0&&$("<div>").text(RED._("clipboard.node",{count:w.nodes})).appendTo(h),w.groups>0&&$("<div>").text(RED._("clipboard.group",{count:w.groups})).appendTo(h)}else if("junction"===e.type)s.hide();else{s.show(),g||(t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.type")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text("unknown"===e.type?e._orig.type:e.type),"unknown"===e.type&&$('<span style="float: right; font-size: 0.8em"><i class="fa fa-warning"></i></span>').prependTo($(t.children()[1])));var E=0;if(!g&&"subflow"!=e.type&&"group"!=e.type){var D,R=$('<tr class="red-ui-help-property-expand blank"><td colspan="2"></td></tr>').appendTo(p);if("unknown"===e.type?(D={},Object.keys(e._orig).forEach((function(e){"type"!==e&&(D[e]={})}))):e._def&&(D=e._def.defaults,t=$('<tr class="red-ui-help-info-property-row'+(u.property?"":" hide")+'"><td>'+RED._("sidebar.info.module")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text(RED.nodes.getType(e.type).set.module),E++),D)for(var x in D)if("name"!=x&&"info"!=x&&D.hasOwnProperty(x)){var _=e[x];if(E++,t=$('<tr class="red-ui-help-info-property-row'+(u.property?"":" hide")+'"><td></td><td></td></tr>').appendTo(p),$(t.children()[0]).text(x),D[x].type&&!D[x]._type.array){var k=RED.nodes.node(_);if(k){var T=RED.utils.getNodeLabel(k,_),C=t.children()[1],j=$("<span>",{class:""}).appendTo(C),L=$("<div>",{class:"red-ui-palette-node red-ui-palette-node-small"}).appendTo(j),S=RED.utils.getNodeColor(k.type,k._def),O=RED.utils.getNodeIcon(k._def);L.css({backgroundColor:S,cursor:"pointer"});var I=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(L);$("<div/>",{class:"red-ui-palette-icon",style:"background-image: url("+O+")"}).appendTo(I);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).text(T).appendTo(C);L.on("dblclick",(function(){RED.editor.editConfig("",k.type,k.id)}))}else RED.utils.createObjectElement(void 0).appendTo(t.children()[1])}else RED.utils.createObjectElement(_,{sourceId:e.id}).appendTo(t.children()[1])}E>0&&$('<a href="#" class="node-info-property-header'+(u.property?" expanded":"")+'"><span class="red-ui-help-property-more">'+RED._("sidebar.info.showMore")+'</span><span class="red-ui-help-property-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a>').appendTo(R.children()[0])}"tab"!==e.type&&g&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(p),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(i.name)+'">'+RED.utils.sanitize(i.name)+"</span></td></tr>").appendTo(p))}if(g){t=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.category")+"</td><td></td></tr>").appendTo(p);var N=i.category||"subflows";$(t.children()[1]).text(RED._("palette.label."+N,{defaultValue:N})),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+l+"</td></tr>").appendTo(p),i.meta&&(t=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.module")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text(i.meta.module||""),t=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.version")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text(i.meta.version||""))}var P="";if(e._def&&e._def.info){var A=e._def.info,M="function"==typeof A?A.call(e):A;P+=RED.utils.renderMarkdown(M)}e.info&&(P+=RED.utils.renderMarkdown(e.info||"")),!function(e,t){var o=(i=$('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>"),$(i).find("a").each((function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")})),i).appendTo(t);var i;o.find(".red-ui-text-bidi-aware").contents().filter((function(){return 3===this.nodeType&&""!==this.textContent.trim()})).wrap("<span></span>");var n="H3";o.find(n).wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),o=$(this).parent().next();1===o.length&&o[0].nodeName!==n;)o.toggle(!t),o=o.next();$(this).toggleClass("expanded",!t)}))}(P,$("<div>").css("padding","0 6px 6px").appendTo(o)),$(".red-ui-sidebar-info-stack").scrollTop(0),$(".node-info-property-header").on("click",(function(e){e.preventDefault(),u.property=!u.property,$(this).toggleClass("expanded",u.property),$(".red-ui-help-info-property-row").toggle(u.property)}))}}else v()}var g=function(){var e,t,o=!0,i=-1;function n(){for(var o,n=Math.floor(Math.random()*i),r=RED._("infotips:info.tip"+n);o=/({{(.*?)}})/.exec(r);){var s=RED.keyboard.getShortcut(o[2]);if(!s)return;r=r.replace(o[1],RED.keyboard.formatKey(s.key))}for(;o=/(\[([a-z]*?)\])/.exec(r);)r=r.replace(o[1],RED.keyboard.formatKey(o[2]));c.html(r).fadeIn(200),e&&(e=null,t=setInterval(a,15e3))}function a(){c.fadeOut(300,(function(){n()}))}function r(){if($(".red-ui-sidebar-info").addClass("show-tips"),p(),o&&!e&&!t){if(-1===i)do{i++}while(RED._("infotips:info.tip"+i)!=="info.tip"+i);e=setTimeout(n,1e3)}}function s(){$(".red-ui-sidebar-info").removeClass("show-tips"),p(),clearInterval(t),clearTimeout(e),t=null,e=null}return RED.actions.add("core:toggle-show-tips",(function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(o=e)?r():s()})),{start:r,stop:s,next:function(){clearInterval(t),e=!0,n()},enabled:function(){return o}}}();function v(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?h(RED.nodes.subflow(t.z)):h(t)}else h(e.nodes);else if(e.flows||e.subflows)h(e.flows);else{var o=RED.workspaces.active(),i=RED.nodes.workspace(o)||RED.nodes.subflow(o);if(i)h(i);else{var n=RED.nodes.workspace(RED.workspaces.active());n&&n.info?h(n):h(null)}}}return RED.events.on("view:selection-changed",v),{init:function(){(e=document.createElement("div")).className="red-ui-sidebar-info",RED.actions.add("core:show-info-tab",f);var u=$("<div>",{class:"red-ui-sidebar-info-stack"}).appendTo(e),h=$("<div>").css({overflow:"hidden",height:"calc(70%)"}).appendTo(u),v=$("<div>").css({overflow:"hidden",height:"100%",display:"flex","flex-direction":"column"}).appendTo(u);i=$("<div>",{class:"red-ui-palette-header red-ui-info-header"}).css({flex:"0 0 auto"}).appendTo(v),n=$("<span>").appendTo(i),a=$("<span>").appendTo(i),s=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-book"></button>').css({position:"absolute",top:"12px",right:"32px"}).on("click",(function(e){e.preventDefault(),e.stopPropagation(),d&&RED.sidebar.help.show(d.type)})).appendTo(i),RED.popover.tooltip(s,RED._("sidebar.help.showHelp")),r=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-search"></button>').css({position:"absolute",top:"12px",right:"8px"}).on("click",(function(e){e.preventDefault(),e.stopPropagation(),d&&(RED.sidebar.info.outliner.reveal(d),RED.view.reveal(d.id))})).appendTo(i),RED.popover.tooltip(r,RED._("sidebar.help.showInOutline")),o=$("<div>").css({flex:"1 1 auto","overflow-y":"auto"}).appendTo(v),(t=RED.panels.create({container:u})).ratio(.6),RED.sidebar.info.outliner.build().appendTo(h),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),iconClass:"fa fa-info",action:"core:show-info-tab",content:e,pinned:!0,enableOnEdit:!0}),RED.events.on("sidebar:resize",p),$(window).on("resize",p),$(window).on("focus",p),l=$('<div class="red-ui-help-tips"></div>').appendTo(e),c=$('<div class="red-ui-help-tip"></div>').appendTo(l);var m=$('<div class="red-ui-help-tips-buttons"></div>').appendTo(l);$('<a href="#" class="red-ui-footer-button"><i class="fa fa-refresh"></a>').appendTo(m).on("click",(function(e){e.preventDefault(),g.next()})),$('<a href="#" class="red-ui-footer-button"><i class="fa fa-times"></a>').appendTo(m).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))})),g.enabled()?g.start():g.stop()},show:f,refresh:h,clear:function(){h(null)},set:function(e,t){console.warn("Deprecated use of RED.sidebar.info.set - use RED.sidebar.help.set instead"),RED.sidebar.help.set(e,t)}}}(),RED.sidebar.info.outliner=function(){var e,t,o,i,n,a,r,s,d={},l={};function c(){var e=[{label:RED._("menu.label.flows"),expanded:!0,children:[]},{id:"__subflow__",label:RED._("menu.label.subflows"),children:[f("__subflow__")]},{id:"__global__",flow:"__global__",label:RED._("sidebar.info.globalConfig"),types:{},children:[f("__global__")]}];return a=e[0],r=e[1],s={__global__:e[2]},e}var u,p={};function f(e){var t={empty:!0,element:$('<div class="red-ui-info-outline-item red-ui-info-outline-item-empty">').text(RED._("sidebar.info.empty"))};return p[e]=t,t}function h(e){var t=$("<div>",{class:"red-ui-node-list-item red-ui-info-outline-item"});return RED.utils.createNodeIcon(e,!0).appendTo(t),t.find(".red-ui-node-label").addClass("red-ui-info-outline-item-label"),v(e,t),t}function g(e){var t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"}),o=$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t),i="string"==typeof e?e:e.label,n=i.indexOf("\\n");return n>-1&&(i=i.substring(0,n)+"..."),o.text(i),v(e,t),t}function v(e,t){var o=$("<div>",{class:"red-ui-info-outline-item-controls red-ui-info-outline-item-hover-controls"}).appendTo(t);if("subflow"===e.type)$('<button type="button" class="red-ui-info-outline-item-control-users red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').text(e.instances.length).appendTo(o).on("click",(function(t){t.preventDefault(),t.stopPropagation(),RED.search.show("type:subflow:"+e.id)}));if("config"===e._def.category&&"group"!==e.type){var i=$('<button type="button" class="red-ui-info-outline-item-control-users red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').text(e.users.length).appendTo(o).on("click",(function(t){t.preventDefault(),t.stopPropagation(),RED.search.show("uses:"+e.id)}));RED.popover.tooltip(i,(function(){return RED._("editor.nodesUse",{count:e.users.length})}))}if(e._def.button){var n=$('<button type="button" class="red-ui-info-outline-item-control-action red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').appendTo(o).on("click",(function(t){t.preventDefault(),t.stopPropagation(),RED.view.clickNodeButton(e)}));RED.popover.tooltip(n,RED._("sidebar.info.triggerAction"))}if("tab"===e.type)$('<button type="button" class="red-ui-info-outline-item-control-hide red-ui-button red-ui-button-small"><i class="fa fa-eye"></i><i class="fa fa-eye-slash"></i></button>').appendTo(o).on("click",(function(o){o.preventDefault(),o.stopPropagation();var i=!t.hasClass("red-ui-info-outline-item-hidden");t.toggleClass("red-ui-info-outline-item-hidden",i),i?RED.workspaces.hide(e.id):RED.workspaces.show(e.id,null,!0)}));if("subflow"!==e.type){var a=$('<button type="button" class="red-ui-info-outline-item-control-disable red-ui-button red-ui-button-small"><i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i></button>').appendTo(o).on("click",(function(t){if(t.preventDefault(),t.stopPropagation(),"tab"===e.type)e.disabled?RED.workspaces.enable(e.id):RED.workspaces.disable(e.id);else if("group"===e.type){var o,i=RED.group.getNodes(e,!0),n={t:"multi",events:[],dirty:RED.nodes.dirty()};i.forEach((function(e){if("group"!==e.type&&(void 0===o&&(o=!e.d),!!e.d!==o)){var t={t:"edit",node:e,changed:e.changed,changes:{d:e.d}};e.d?delete e.d:e.d=!0,e.dirty=!0,e.dirtyStatus=!0,e.changed=!0,RED.events.emit("nodes:change",e),n.events.push(t)}n.events.length>0&&(RED.history.push(n),RED.nodes.dirty(!0),RED.view.redraw())}))}else{var a={t:"edit",node:e,changed:e.changed,changes:{d:e.d},dirty:RED.nodes.dirty()};e.d?delete e.d:e.d=!0,e.dirty=!0,e.dirtyStatus=!0,e.changed=!0,RED.events.emit("nodes:change",e),RED.history.push(a),RED.nodes.dirty(!0),RED.view.redraw()}}));RED.popover.tooltip(a,(function(){return"group"===e.type?RED._("common.label.enable")+" / "+RED._("common.label.disable"):RED._("common.label."+("tab"===e.type&&e.disabled||"tab"!==e.type&&e.d?"enable":"disable"))}))}else $('<div class="red-ui-info-outline-item-control-spacer">').appendTo(o);o.find("button").on("dblclick",(function(e){e.preventDefault(),e.stopPropagation()}))}function m(t){d={};var o=c();n.empty(),function(e){var t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"});t.css("width","calc(100% - 40px)"),$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t).text(e.name);var o=$("<div>",{class:"red-ui-info-outline-item-controls"}).appendTo(t),i=$('<button class="red-ui-button red-ui-button-small" style="position:absolute;right:5px;top: 3px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(o).on("click",(function(e){e.preventDefault(),RED.projects.editProject()}));return RED.popover.tooltip(i,RED._("sidebar.project.showProjectSettings")),t}(t).appendTo(n),i.show(),e.treeList("data",o)}function b(){e.treeList("data",c())}function y(e){var t=d[e.workspace];t&&t.element.removeClass("red-ui-info-outline-item-hidden")}function w(e){var t=d[e.workspace];t&&t.element.addClass("red-ui-info-outline-item-hidden")}function E(e){d[e.id]={id:e.id,element:g(e),children:[],deferBuild:!0,icon:"red-ui-icons red-ui-icons-flow",gutter:C(e)},l[e.id]?(d[e.id].children=l[e.id],delete l[e.id]):d[e.id].children.push(f(e.id)),a.treeList.addChild(d[e.id]),d[e.id].element.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),d[e.id].treeList.container.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),S()}function D(e){var t=d[e.id],o=e.label||e.id,i=o.indexOf("\\n");i>-1&&(o=o.substring(0,i)+"..."),t.element.find(".red-ui-info-outline-item-label").text(o),t.element.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),t.treeList.container.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),S()}function R(e){var t={};e.forEach((function(e,o){t[e]=o})),a.treeList.sortChildren((function(e,o){return"__global__"===e.id?-1:"__global__"===o.id?1:t[e.id]-t[o.id]}))}function x(e){d[e.id]={id:e.id,element:h(e),children:[],deferBuild:!0,gutter:C(e)},l[e.id]?(d[e.id].children=l[e.id],delete l[e.id]):d[e.id].children.push(f(e.id)),p.__subflow__&&(p.__subflow__.treeList.remove(),delete p.__subflow__),r.treeList.addChild(d[e.id]),S()}function _(e){d[e.id].treeList.replaceElement(h(e)),RED.nodes.eachNode((function(t){t.type=="subflow:"+e.id&&d[t.id].treeList.replaceElement(h(t))})),S()}function k(e){var t=d[e.id],o=e.g||e.z||"__global__",i=RED.utils.getNodeLabel(e,e.name||e.type+": "+e.id);i?t.element.find(".red-ui-info-outline-item-label").text(i):t.element.find(".red-ui-info-outline-item-label").html("&nbsp;");var n=t.parent.id;if(n||(n=t.parent.parent.flow),o!==n){var a=t.parent;t.treeList.remove(!0),0===a.children.length&&(a.config?(a.treeList.remove(),delete s[a.parent.id||a.parent.parent.id].types[e.type],0===a.parent.children.length&&("__global__"===a.parent.id?a.parent.treeList.addChild(f(a.parent.id)):(delete s[a.parent.parent.id],a.parent.treeList.remove(),0===a.parent.parent.children.length&&a.parent.parent.treeList.addChild(f(a.parent.parent.id))))):a.treeList.addChild(f(a.id))),"config"===e._def.category&&"group"!==e.type?(j(o,e.type),s[o].types[e.type].treeList.addChild(d[e.id])):(p[o]&&(p[o].treeList.remove(),delete p[o]),d[o].treeList.addChild(t))}t.element.toggleClass("red-ui-info-outline-item-disabled",!!e.d),"config"===e._def.category&&"group"!==e.type&&t.element.find(".red-ui-info-outline-item-control-users").text(e.users.length),S()}function T(e){var t=d[e.id];if(t.treeList.remove(),delete d[e.id],/^subflow:/.test(e.type)){var o=e.type.substring(8);d[o]&&d[o].element.find(".red-ui-info-outline-item-control-users").text(RED.nodes.subflow(o).instances.length)}p[e.id]&&delete p[e.id];var i=t.parent;0===i.children.length&&(i.config?(i.treeList.remove(),delete s[i.parent.id||e.z].types[e.type],0===i.parent.children.length&&("__global__"===i.parent.id?i.parent.treeList.addChild(f(i.parent.id)):(delete s[e.z],i.parent.treeList.remove(),0===i.parent.parent.children.length&&i.parent.parent.treeList.addChild(f(i.parent.parent.id))))):i.treeList.addChild(f(i.id)))}function C(e){var t=$("<span>",{class:"red-ui-info-outline-gutter red-ui-treeList-gutter-float"}),o=$('<button type="button" class="red-ui-info-outline-item-control-reveal red-ui-button red-ui-button-small"><i class="fa fa-search"></i></button>').appendTo(t).on("click",(function(t){t.preventDefault(),t.stopPropagation(),RED.view.reveal(e.id)}));return RED.popover.tooltip(o,RED._("sidebar.info.find")),t}function j(e,t){p[e]&&(p[e].treeList.remove(),delete p[e]),s[e]||(s[e]={config:!0,flow:e,types:{},label:RED._("menu.label.displayConfig"),children:[]},d[e].treeList.insertChildAt(s[e],0)),s[e].types[t]||(s[e].types[t]={config:!0,label:t,children:[]},s[e].treeList.addChild(s[e].types[t]))}function L(e){d[e.id]={id:e.id,element:h(e),gutter:C(e)},"group"===e.type&&(d[e.id].children=[],d[e.id].deferBuild=!0,l[e.id]&&(d[e.id].children=l[e.id],delete l[e.id]));var t=e.g||e.z||"__global__";if("config"!==e._def.category||"group"===e.type?d[t]?(p[t]&&(p[t].treeList.remove(),delete p[t]),d[t].treeList?d[t].treeList.addChild(d[e.id]):d[t].children.push(d[e.id])):(l[t]=l[t]||[],l[t].push(d[e.id])):(j(t,e.type),s[t].types[e.type].treeList.addChild(d[e.id])),d[e.id].element.toggleClass("red-ui-info-outline-item-disabled",!!e.d),/^subflow:/.test(e.type)){var o=e.type.substring(8);d[o]&&d[o].element.find(".red-ui-info-outline-item-control-users").text(RED.nodes.subflow(o).instances.length)}S()}function S(){u&&clearTimeout(u),o&&(u=setTimeout((function(){t.searchBox("change")}),100))}return{build:function(){var a=$("<div>",{class:"red-ui-info-outline"}).css({height:"100%"}),r=$("<div>",{class:"red-ui-sidebar-header red-ui-info-toolbar"}).appendTo(a);return t=$('<input type="text" data-i18n="[placeholder]menu.label.search">').appendTo(r).searchBox({style:"compact",delay:500,change:function(){var t=$(this).val(),i=RED.search.search(t);if(t){o=t;for(var n={},a=0,r=i.length;a<r;a++)n[i[a].node.id]=!0;e.treeList("filter",(function(e){return 0===e.depth||e.id&&d[e.id]&&n[e.id]}),!0)}else{o=null,e.treeList("filter",null);var s=e.treeList("selected");s.id&&e.treeList("show",s.id)}},options:RED.search.getSearchOptions()}),i=$('<div class="red-ui-treeList-label red-ui-info-outline-project"><span class="red-ui-treeList-icon"><i class="fa fa-archive"></i></span></div>').hide().appendTo(a),n=$("<span>").appendTo(i),(e=$("<div>").css({width:"100%"}).appendTo(a).treeList({data:c()})).on("treelistselect",(function(e,t){var o=RED.nodes.node(t.id)||RED.nodes.group(t.id)||RED.nodes.workspace(t.id)||RED.nodes.subflow(t.id);o?RED.sidebar.info.refresh(o):RED.sidebar.info.refresh(null)})),e.on("treelistconfirm",(function(e,t){var o=RED.nodes.node(t.id);o&&("config"===o._def.category?RED.editor.editConfig("",o.type,o.id):RED.editor.edit(o))})),RED.events.on("projects:load",m),RED.events.on("flows:add",E),RED.events.on("flows:remove",T),RED.events.on("flows:change",D),RED.events.on("flows:reorder",R),RED.events.on("subflows:add",x),RED.events.on("subflows:remove",T),RED.events.on("subflows:change",_),RED.events.on("nodes:add",L),RED.events.on("nodes:remove",T),RED.events.on("nodes:change",k),RED.events.on("groups:add",L),RED.events.on("groups:remove",T),RED.events.on("groups:change",k),RED.events.on("workspace:show",y),RED.events.on("workspace:hide",w),RED.events.on("workspace:clear",b),a},search:function(e){t.searchBox("value",e)},select:function(t){t?Array.isArray(t)?e.treeList("select",t.map((function(e){return d[e.id]})),!1):e.treeList("select",d[t.id],!1):e.treeList("clearSelection")},reveal:function(t){e.treeList("show",d[t.id])}}}(),RED.sidebar.help=function(){var e,t,o,i,n,a,r,s;function d(){var o=$(e).parent().height()-t.outerHeight();i.resize(o)}function l(){s||(s=setTimeout((function(){s=null,function(){var e=RED.nodes.registry.getModuleList(),t=Object.keys(e);t.sort();var o={label:RED._("sidebar.help.nodeHelp"),children:[],expanded:!0},i=RED.tourGuide.list().map((function(e){return{icon:"fa fa-play-circle-o",label:e.label,tour:e.path}})),n=[{label:"Node-RED",children:[{id:"changelog",label:RED._("sidebar.help.changeLog"),content:b},{label:RED._("tourGuide.welcomeTours"),children:i}]},o],r=RED.nodes.registry.getNodeTypes().filter((function(e){return/subflow/.test(e)}));r.length>0&&(o.children.push({label:RED._("menu.label.subflows"),children:[]}),r.forEach((function(e){var t=RED.nodes.getType(e);o.children[0].children.push({id:"node-type:"+e,nodeType:e,subflowLabel:t.label().toLowerCase(),element:h({_def:t,type:t.label()})})})));t.forEach((function(t){const i=e[t],n=[],a=i.sets;Object.keys(a).forEach((function(e){a[e].types.forEach((function(e){if($("script[data-help-name='"+e+"']").length){const t={_def:RED.nodes.getType(e),type:e};t.name=f(t),n.push({id:"node-type:"+e,nodeType:e,palleteLabel:t.name,element:h(t)})}}))})),n.length>0&&(n.sort((function(e,t){return e.nodeType.localeCompare(t.nodeType)})),o.children.push({id:t,icon:"fa fa-cube",label:t,children:n}))})),a.treeList("data",n)}()}),500))}function c(e){var t=a.treeList("get","node-type:subflow:"+e.id);t.subflowLabel=e._def.label().toLowerCase(),t.treeList.replaceElement(h({_def:e._def,type:e._def.label()}))}function u(){var e=$("#red-ui-sidebar-help-show-toc");e.hasClass("selected")&&(e.removeClass("selected"),n=i.ratio(),r.css({transition:"height 0.2s"}),i.ratio(0),setTimeout((function(){r.css({transition:""})}),250))}function p(){var e=$("#red-ui-sidebar-help-show-toc");e.hasClass("selected")||(e.addClass("selected"),r.css({transition:"height 0.2s"}),i.ratio(Math.max(.3,Math.min(n,.7))),setTimeout((function(){r.css({transition:""});var e=a.treeList("selected");e.id&&a.treeList("show",e)}),250))}function f(e){let t=e.name;if(!t&&e._def&&e._def.paletteLabel)try{t=("function"==typeof e._def.paletteLabel?e._def.paletteLabel.call(e._def):e._def.paletteLabel)||""}catch(e){}return t||e.type}function h(e){const t=$("<div>",{class:"red-ui-node-list-item"}),o=RED.utils.createNodeIcon(e).appendTo(t);return $("<div>",{class:"red-ui-node-label"}).text(f(e)).appendTo(o),t}function g(e){var t,n;o.empty();var r=/^subflow(:(.+))?$/.exec(e);if(r&&r[2]){var s=RED.nodes.subflow(r[2]);t=RED.utils.renderMarkdown(s.info||"")||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>",n=s.name||e}else{t=RED.nodes.getNodeHelp(e)||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>";var d=RED.nodes.registry.getNodeType(e);if("function"==typeof(n=d&&d.paletteLabel?d.paletteLabel:e))try{n=d.paletteLabel.call(d)}catch(t){n=e}}m(n,t),i.ratio()>.7&&i.ratio(.7),a.treeList("show","node-type:"+e),a.treeList("select","node-type:"+e,!1)}function v(e,t){!1!==t&&RED.sidebar.show("help"),e&&g(e),d()}function m(e,t){o.empty(),e&&$("<h1>",{class:"red-ui-help-title"}).text(e).appendTo(o);var i,n=(i=$('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(t)+'">'+t+"</span></div>"),$(i).find("a").each((function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")})),i).appendTo(o);n.find(".red-ui-text-bidi-aware").contents().filter((function(){return 3===this.nodeType&&""!==this.textContent.trim()})).wrap("<span></span>");n.find("H3").wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),o=$(this).parent().next();1===o.length&&"H3"!==o[0].nodeName;)o.toggle(!t),o=o.next();$(this).toggleClass("expanded",!t)})),o.parent().scrollTop(0)}function b(e){$.get("red/about",(function(t){t=RED.utils.sanitize(t),RED.tourGuide.load("./tours/welcome.js",(function(o,i){var n='<div><img width="50px" src="red/images/node-red-icon.svg" /></div>';if(i){var a=RED.settings.version.split("."),r=i.version.split(".");r[0]===a[0]&&r[1]===a[1]&&(n='<div><button type="button" onclick="RED.actions.invoke(\'core:show-welcome-tour\')" class="red-ui-button">'+RED._("tourGuide.takeATour")+"</button></div>")}e('<div style="text-align:center;">'+n+"</div>"+RED.utils.renderMarkdown(t))}))}))}return RED.events.on("view:selection-changed",(function(e){if(void 0===e&&(e=RED.view.selection()),e.nodes&&1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction||"group"!==t.type&&"junction"!==t.type&&g(t.type)}})),RED.actions.add("core:show-about",(function(){a.treeList("show","changelog"),a.treeList("select","changelog"),v()})),RED.actions.add("core:show-welcome-tour",(function(e,t){t=t||function(){},RED.tourGuide.load("./tours/welcome.js",(function(o,i){if(o)return console.warn("Failed to load welcome tour",o),void t();var n=RED.settings.version.split("."),a=i.version.split(".");if(a[0]===n[0]&&a[1]===n[1]){if(e){if(e===RED.settings.version)return void t();var r=e.split(".");if(n[0]<r[0]||n[0]===r[0]&&n[1]<r[1])return void t();if(n[0]===r[0]&&n[1]===r[1]){if(3===r.length&&3===n.length)return void t();if(4===n.length&&(3===r.length||n[3]<r[3]))return void t()}}RED.tourGuide.run("./tours/welcome.js",(function(e){RED.settings.set("editor.tours.welcome",RED.settings.version),t()}))}else t()}))})),{init:function(){(e=document.createElement("div")).className="red-ui-sidebar-info",t=$("<div>",{class:"red-ui-sidebar-header red-ui-info-toolbar"}).appendTo(e),$('<span class="button-group"><a id="red-ui-sidebar-help-show-toc" class="red-ui-button red-ui-button-small selected" href="#"><i class="fa fa-list-ul"></i></a></span>').appendTo(t);var n=t.find("#red-ui-sidebar-help-show-toc");RED.popover.tooltip(n,RED._("sidebar.help.showTopics")),n.on("click",(function(e){e.preventDefault(),$(this).hasClass("selected")?u():p()}));var s=$("<div>",{class:"red-ui-sidebar-help-stack"}).appendTo(e);r=$("<div>",{class:"red-ui-sidebar-help-toc"}).appendTo(s);var f,h=$("<div>").css({"overflow-y":"auto"}).appendTo(s);(i=RED.panels.create({container:s})).ratio(.3),helpSearch=$('<input type="text" data-i18n="[placeholder]sidebar.help.search">').appendTo(t).searchBox({style:"compact",delay:100,change:function(){const e=$(this).val().toLowerCase();if(e)p(),a.treeList("filter",(function(t){if(0===t.depth)return!0;let o=t.nodeType&&t.nodeType.toLowerCase().indexOf(e)>-1;return o=o||t.subflowLabel&&t.subflowLabel.toLowerCase().indexOf(e)>-1,o=o||t.palleteLabel&&t.palleteLabel.toLowerCase().indexOf(e)>-1,o}),!0);else{a.treeList("filter",null);var t=a.treeList("selected");t.id&&a.treeList("show",t.id)}}}),o=$("<div>",{class:"red-ui-help"}).css({padding:"6px"}).appendTo(h),$('<span class="red-ui-help-info-none">'+RED._("sidebar.help.noHelp")+"</span>").appendTo(o),(a=$("<div>").css({width:"100%"}).appendTo(r).treeList({data:[]})).on("treelistselect",(function(e,t){f=t,t.tour?RED.tourGuide.run(t.tour):t.nodeType?g(t.nodeType):t.content&&(o.empty(),"string"==typeof t.content?m(t.label,t.content):"function"==typeof t.content&&(0===t.content.length?m(t.label,t.content()):(m(t.label,'<div class="red-ui-component-spinner red-ui-component-spinner-contain"><img src="red/images/spin.svg" /></div>'),t.content((function(e){f===t&&(o.empty(),m(t.label,e))})))))})),RED.sidebar.addTab({id:"help",label:RED._("sidebar.help.label"),name:RED._("sidebar.help.name"),iconClass:"fa fa-book",action:"core:show-help-tab",content:e,pinned:!0,enableOnEdit:!0,onchange:function(){d()}}),$(window).on("resize",d),$(window).on("focus",d),RED.events.on("registry:node-type-added",l),RED.events.on("registry:node-type-removed",l),RED.events.on("subflows:change",c),RED.actions.add("core:show-help-tab",v)},show:v,set:function(e,t){$(o).empty(),m(t,e),u(),v()}}}(),RED.sidebar.config=function(){let e,t;var o=document.createElement("div");o.className="red-ui-sidebar-node-config",o.id="red-ui-sidebar-node-config",o.tabIndex=0,$('<div class="red-ui-sidebar-header"><span class="button-group"><a class="red-ui-sidebar-header-button-toggle selected" id="red-ui-sidebar-config-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="red-ui-sidebar-header-button-toggle" id="red-ui-sidebar-config-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </span></div>').appendTo(o);var i=$('<div><a class="red-ui-footer-button" id="red-ui-sidebar-config-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="red-ui-footer-button" id="red-ui-sidebar-config-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),n=$("<div>").appendTo(o),a=$("<div>").appendTo(o),r=$("<div>").appendTo(o),s=!1,d={};function l(e,t,i){if(e=e.replace(/\./i,"-"),d[e])d[e].label!==i&&(d[e].list.parent().find(".red-ui-palette-node-config-label").text(i),d[e].label=i);else{var n=$('<div class="red-ui-palette-category red-ui-sidebar-config-category" id="red-ui-sidebar-config-category-'+e+'"></div>').appendTo(t),a=$('<div class="red-ui-sidebar-config-tray-header red-ui-palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(n);i?$('<span class="red-ui-palette-node-config-label"/>').text(i).appendTo(a):$('<span class="red-ui-palette-node-config-label" data-i18n="sidebar.config.'+e+'">').appendTo(a),$('<span class="red-ui-sidebar-node-config-filter-info"></span>').appendTo(a),category=$('<ul class="red-ui-palette-content red-ui-sidebar-node-config-list"></ul>').appendTo(n),category.on("click",(function(e){$(o).find(".red-ui-palette-node").removeClass("selected")})),n.i18n();var r=a.find("i"),s={label:i,list:category,size:function(){return s.list.find("li:not(.red-ui-palette-node-config-none)").length},open:function(e){r.hasClass("expanded")||(r.addClass("expanded"),e?s.list.show():s.list.slideDown())},close:function(e){r.hasClass("expanded")&&(r.removeClass("expanded"),e?s.list.hide():s.list.slideUp())},isOpen:function(){return r.hasClass("expanded")}};a.on("click",(function(e){s.isOpen()?s.close():s.open()})),d[e]=s}return d[e]}function c(e,t){var i=l(e.replace(/\./i,"-")),n=i.list;if(t.sort((function(e,t){return e.type<t.type?-1:e.type>t.type?1:0})),s){var a=t.length;(a-=(t=t.filter((function(e){return!1!==e._def.hasUsers&&0===e.users.length}))).length)>0?n.parent().find(".red-ui-sidebar-node-config-filter-info").text(RED._("sidebar.config.filtered",{count:a})).show():n.parent().find(".red-ui-sidebar-node-config-filter-info").hide()}else n.parent().find(".red-ui-sidebar-node-config-filter-info").hide();if(n.empty(),0===t.length)$('<li class="red-ui-palette-node-config-none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(n),i.close(!0);else{var r="";t.forEach((function(e){var t=RED.utils.getNodeLabel(e,e.id);e.type!=r&&($('<li class="red-ui-palette-node-config-type">'+e.type+"</li>").appendTo(n),r=e.type);var i=$('<li class="red-ui-palette-node_id_'+e.id.replace(/\./g,"-")+'"></li>').appendTo(n),a=$('<div class="red-ui-palette-node-config red-ui-palette-node"></div>').appendTo(i);i.data("node",e.id),a.data("node",e.id);t=$('<div class="red-ui-palette-label"></div>').text(t).appendTo(a);if(e.d&&(a.addClass("red-ui-palette-node-config-disabled"),$('<i class="fa fa-ban"></i>').prependTo(t)),!1!==e._def.hasUsers){var s=$("<div/>",{class:"red-ui-palette-icon-container red-ui-palette-icon-container-right"}).appendTo(a);0===e.users.length?s.text(0):$('<a href="#"/>').on("click",(function(t){t.stopPropagation(),t.preventDefault(),RED.search.show(e.id)})).text(e.users.length).appendTo(s),RED.popover.tooltip(s,RED._("editor.nodesUse",{count:e.users.length})),0===e.users.length&&a.addClass("red-ui-palette-node-config-unused")}a.on("click",(function(t){t.stopPropagation(),RED.view.select(!1),t.metaKey?$(this).toggleClass("selected"):($(o).find(".red-ui-palette-node").removeClass("selected"),$(this).addClass("selected")),RED.sidebar.info.refresh(e)})),a.on("dblclick",(function(t){t.stopPropagation(),RED.editor.editConfig("",e.type,e.id)}));var d=e.users.map((function(e){return e.id}));a.on("mouseover",(function(e){RED.nodes.eachNode((function(e){-1!=d.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)})),RED.view.redraw()})),a.on("mouseout",(function(e){RED.nodes.eachNode((function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)})),RED.view.redraw()}))})),i.open(!0)}}function u(){var e={global:!0};l("global",n),RED.nodes.eachWorkspace((function(t){e[t.id.replace(/\./g,"-")]=!0,l(t.id,a,t.label)})),RED.nodes.eachSubflow((function(t){e[t.id.replace(/\./g,"-")]=!0,l(t.id,r,t.name)})),$(".red-ui-sidebar-config-category").each((function(){var t=$(this).attr("id").substring("red-ui-sidebar-config-category-".length);e[t]||($(this).remove(),delete d[t])}));var t=[],o={};for(var i in RED.nodes.eachConfig((function(e){e.z?(o[e.z.replace(/\./g,"-")]=o[e.z.replace(/\./g,"-")]||[],o[e.z.replace(/\./g,"-")].push(e)):e.z||t.push(e)})),e)e.hasOwnProperty(i)&&c(i,o[i]||[]);c("global",t)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:o,toolbar:i,iconClass:"fa fa-cog",action:"core:show-config-tab",onchange:function(){u()}}),RED.actions.add("core:show-config-tab",(function(){RED.sidebar.show("config")})),RED.actions.add("core:select-all-config-nodes",(function(){$(o).find(".red-ui-palette-node").addClass("selected")})),RED.actions.add("core:delete-config-selection",(function(){var e=[];if($(o).find(".red-ui-palette-node.selected").each((function(){e.push($(this).parent().data("node"))})),e.length>0){var t={t:"delete",nodes:[],changes:{},dirty:RED.nodes.dirty()};e.forEach((function(e){var o=RED.nodes.node(e);try{o._def.oneditdelete&&o._def.oneditdelete.call(o)}catch(e){console.log("oneditdelete",o.id,o.type,e.toString())}t.nodes.push(o);for(var i=0;i<o.users.length;i++){var n=o.users[i];for(var a in t.changes[n.id]={changed:n.changed,valid:n.valid},n._def.defaults)n._def.defaults.hasOwnProperty(a)&&n[a]==e&&(t.changes[n.id][a]=e,n[a]="",n.changed=!0,n.dirty=!0);RED.editor.validateNode(n)}RED.nodes.remove(e)})),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(t)}})),RED.events.on("view:selection-changed",(function(){$(o).find(".red-ui-palette-node").removeClass("selected")})),$("#red-ui-sidebar-config-collapse-all").on("click",(function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&d[t].close()})),$("#red-ui-sidebar-config-expand-all").on("click",(function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&d[t].size()>0&&d[t].open()})),$("#red-ui-sidebar-config-filter-all").on("click",(function(e){e.preventDefault(),s&&($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-unused").removeClass("selected"),s=!s,u())})),$("#red-ui-sidebar-config-filter-unused").on("click",(function(e){e.preventDefault(),s||($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-all").removeClass("selected"),s=!s,u())})),RED.popover.tooltip($("#red-ui-sidebar-config-filter-all"),RED._("sidebar.config.showAllConfigNodes")),RED.popover.tooltip($("#red-ui-sidebar-config-filter-unused"),RED._("sidebar.config.showAllUnusedConfigNodes"))},show:function(o){"boolean"==typeof o&&(o?$("#red-ui-sidebar-config-filter-unused").trigger("click"):$("#red-ui-sidebar-config-filter-all").trigger("click")),u(),"string"==typeof o&&($("#red-ui-sidebar-config-filter-all").trigger("click"),o=o.replace(/\./g,"-"),setTimeout((function(){var i,n=$(".red-ui-palette-node_id_"+o),a=n.position().top,r=n.height(),s=$(".red-ui-sidebar-node-config"),d=s.height();a+r>d?s.animate({scrollTop:"-="+(d-(a+r)-30)},150):a<0&&s.animate({scrollTop:"+="+(a-10)},150),i=n,e&&e.length&&(clearInterval(t),t=null,e.children("div").removeClass("highlighted"),e=null),i&&i.children("div").length&&(t=setInterval((function(o){if(o>=Date.now()){const e=i.children("div").hasClass("highlighted");i.children("div").toggleClass("highlighted",!e)}else clearInterval(t),t=null,e=null,i.children("div").removeClass("highlighted")}),100,Date.now()+2200),e=i,i.children("div").addClass("highlighted"))}),100)),RED.sidebar.show("config")},refresh:u}}(),RED.sidebar.context=function(){var e,t,o,i,n,a,r,s,d;function l(e,t){s=e,t||i.prop("checked")?e?u(n,"context/node/"+e.id,e.id):u(n):($(n.table).empty(),e?$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(n.table).i18n():$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(n.table).i18n(),n.timestamp.html("&nbsp;"))}function c(e,t){d=e,t||o.prop("checked")?e?u(a,"context/flow/"+e.id,e.id):u(a):($(a.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(a.table).i18n(),a.timestamp.html("&nbsp;"))}function u(e,t,o){var i=e.table;o?function(e,t,o){var i=RED.settings.context.stores,n=e.table;$.getJSON(t,(function(a){$(n).empty();var r={};for(var s in a)if(a.hasOwnProperty(s))for(var d in a[s])a[s].hasOwnProperty(d)&&(r.hasOwnProperty(d)||(r[d]=[]),a[s][d].store=s,r[d].push(a[s][d]));var l=Object.keys(r);l.sort();for(var c=l.length,u=0;u<c;u++)r[l[u]].forEach((function(e){var a=l[u],s=(r[a].length,$('<tr class="red-ui-help-info-row"><td class="red-ui-sidebar-context-property"></td><td></td></tr>').appendTo(n));$(s.children()[0]).text(a);var d=$('<span class="button-group"></span>'),c=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(d).on("click",(function(i){i.preventDefault(),i.stopPropagation(),$.getJSON(t+"/"+a+"?store="+e.store,(function(e){e.msg===f&&e.format===h||(f=e.msg,h=e.format,d.detach(),$(s.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(f,h),{typeHint:e.format,sourceId:o+"."+a,tools:d,path:""}).appendTo(s.children()[1]))}))}));RED.popover.tooltip(c,RED._("sidebar.context.refrsh"));var p=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(d).on("click",(function(i){i.preventDefault(),i.stopPropagation();var r=RED.popover.create({trigger:"modal",target:s,direction:"left",content:function(){var i=$("<div>");$('<p data-i18n="sidebar.context.deleteConfirm"></p>').appendTo(i);var l=$("<p>").appendTo(i),c=$('<span class="button-group"></span>').appendTo(l);return $('<button class="red-ui-button" data-i18n="common.label.cancel"></button>').appendTo(c).on("click",(function(e){e.preventDefault(),r.close()})),c=$('<span class="button-group"></span>').appendTo(l),$('<button class="red-ui-button primary" data-i18n="common.label.delete"></button>').appendTo(c).on("click",(function(i){i.preventDefault(),r.close(),$.ajax({url:t+"/"+a+"?store="+e.store,type:"DELETE"}).done((function(i,r,l){$.getJSON(t+"/"+a+"?store="+e.store,(function(e){"undefined"===e.format?(s.remove(),0===n.children().length&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(n).i18n()):(f=e.msg,h=e.format,d.detach(),$(s.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(f,h),{typeHint:e.format,sourceId:o+"."+a,tools:d,path:""}).appendTo(s.children()[1]))}))})).fail((function(e,t,o){}))})),i.i18n()}});r.open()}));RED.popover.tooltip(p,RED._("sidebar.context.delete"));var f=e.msg,h=e.format;RED.utils.createObjectElement(RED.utils.decodeObject(f,h),{typeHint:e.format,sourceId:o+"."+a,tools:d,path:""}).appendTo(s.children()[1]),i.length>1&&$("<span>",{class:"red-ui-sidebar-context-property-storename"}).text(e.store).appendTo($(s.children()[0]))}));0===c&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(n).i18n(),$(e.timestamp).text((new Date).toLocaleString())}))}(e,t,o):($(i).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(i).i18n())}function p(){RED.sidebar.show("context")}return{init:function(){(e=$("<div>").css({position:"relative",height:"100%"})).className="red-ui-sidebar-context";var f=$("<div></div>"),h=$("<div>",{class:"red-ui-sidebar-context-stack"}).appendTo(e);t=RED.stack.create({container:h}),(n=t.add({title:RED._("sidebar.context.node"),collapsible:!0})).expand(),n.content.css({height:"100%"}),n.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(n.content);var g=$('<table class="red-ui-info-table"></table>').appendTo(n.content);n.table=$("<tbody>").appendTo(g);var v=$('<div style="float: right"></div>').appendTo(n.header),m=RED.settings.get("editor.context.nodeRefresh",!1);i=$('<input type="checkbox">').prop("checked",m).appendTo(v).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",(function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)})),RED.popover.tooltip(i.next(),RED._("sidebar.context.autoRefresh"));var b=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(v).on("click",(function(e){e.stopPropagation(),e.preventDefault(),l(s,!0)}));RED.popover.tooltip(b,RED._("sidebar.context.refrsh")),(a=t.add({title:RED._("sidebar.context.flow"),collapsible:!0})).expand(),a.content.css({height:"100%"}),a.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(a.content),g=$('<table class="red-ui-info-table"></table>').appendTo(a.content),a.table=$("<tbody>").appendTo(g),v=$('<div style="float: right"></div>').appendTo(a.header);var y=RED.settings.get("editor.context.flowRefresh",!1);o=$('<input type="checkbox">').prop("checked",y).appendTo(v).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",(function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)})),RED.popover.tooltip(o.next(),RED._("sidebar.context.autoRefresh"));var w=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(v).on("click",(function(e){e.stopPropagation(),e.preventDefault(),c(d,!0)}));RED.popover.tooltip(w,RED._("sidebar.context.refrsh")),(r=t.add({title:RED._("sidebar.context.global"),collapsible:!0})).expand(),r.content.css({height:"100%"}),r.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(r.content),g=$('<table class="red-ui-info-table"></table>').appendTo(r.content),r.table=$("<tbody>").appendTo(g),v=$('<div style="float: right"></div>').appendTo(r.header),$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(v).on("click",(function(e){e.stopPropagation(),e.preventDefault(),u(r,"context/global","global")})),RED.popover.tooltip(v,RED._("sidebar.context.refrsh")),RED.actions.add("core:show-context-tab",p),RED.sidebar.addTab({id:"context",label:RED._("sidebar.context.label"),name:RED._("sidebar.context.name"),iconClass:"fa fa-database",content:e,toolbar:f,enableOnEdit:!0,action:"core:show-context-tab"}),RED.events.on("view:selection-changed",(function(e){l(e.nodes&&1===e.nodes.length&&e.nodes[0])})),RED.events.on("workspace:change",(function(e){c(RED.nodes.workspace(e.workspace))})),$(r.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(r.table).i18n(),r.timestamp.html("&nbsp;")}}}(),RED.palette.editor=function(){var e,t,o,i,n,a,r=[],s=[],d={},l={},c={},u={},p="",f=/^(\d+)(\.(\d+))?(\.(\d+))?(-([0-9A-Za-z-]+))?(\.([0-9A-Za-z-.]+))?$/,h=/^\d+$/;function g(e){this.number=0,this.text=e,h.test(e)?(this.number=parseInt(e),this.type="N"):this.type=null==e||e.length<1?"E":"T"}function v(e){var t=e.match(f);this.parts=[new g(t[1]),new g(t[3]),new g(t[5]),new g(t[7]),new g(t[9])]}function m(e,t){var o=Date.now()-e;o=o<300?300:0,setTimeout((function(){t()}),o)}function b(e,t,o,i){o.show();var n=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done((function(e,t,a){m(n,(function(){o.hide(),i()}))})).fail((function(e,t,a){m(n,(function(){o.hide(),i(e)}))}))}function y(e,t,o,i){var n={module:e};t&&(n.version=t),o&&(n.url=o),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"}).done((function(e,t,o){i()})).fail((function(e,t,o){i(e)}))}function w(e){u.hasOwnProperty(e)||(u[e]=setTimeout((function(){delete u[e],D(e)}),100))}function E(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var o=parseInt(t[1]),i=parseInt(t[2]),n=parseInt(t[3]);if((299*o+587*i+114*n)/1e3>160)return"rgb("+(o=Math.floor(.8*o))+","+(i=Math.floor(.8*i))+","+(n=Math.floor(.8*n))+")"}return e}function D(e){if(c.hasOwnProperty(e)){var t=c[e].info,o=c[e].elements;if(o){var n=0,a=0,r=0;for(var s in o.errorList.empty(),c[e].totalUseCount=0,c[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(s)){var u=0,p=t.sets[s],f=o.sets[s];if(p.err){r++;var h=p.err;p.err.message?h=p.err.message:p.err.code&&(h=p.err.code),$("<li>").text(h).appendTo(o.errorList)}p.enabled&&(n+=p.types.length),a+=p.types.length;for(var g=0;g<t.sets[s].types.length;g++){var m=t.sets[s].types[g];u+=l[m]||0;var b=f.swatches[m];if(p.enabled){var y=RED.nodes.getType(m);y&&y.color&&(b.css({background:RED.utils.getNodeColor(m,y)}),b.css({border:"1px solid "+E(b.css("backgroundColor"))}))}}c[e].setUseCount[s]=u,c[e].totalUseCount+=u,u>0?(f.enableButton.text(RED._("palette.editor.inuse")),f.enableButton.addClass("disabled")):(f.enableButton.removeClass("disabled"),p.enabled?f.enableButton.text(RED._("palette.editor.disable")):f.enableButton.text(RED._("palette.editor.enable"))),f.setRow.toggleClass("red-ui-palette-module-set-disabled",!p.enabled)}0===r?o.errorRow.hide():o.errorRow.show();var w=n===a?a:n+" / "+a;o.setCount.text(RED._("palette.editor.nodeCount",{count:a,label:w})),c[e].totalUseCount>0?(o.enableButton.text(RED._("palette.editor.inuse")),o.enableButton.addClass("disabled"),o.removeButton.hide()):(o.enableButton.removeClass("disabled"),t.local&&o.removeButton.css("display","inline-block"),0===n?o.enableButton.text(RED._("palette.editor.enableall")):o.enableButton.text(RED._("palette.editor.disableall")),o.container.toggleClass("disabled",0===n))}t.pending_version?(o.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(o.metaRow),o.updateButton.text(RED._("palette.editor.updated")).addClass("disabled").css("display","inline-block")):d.hasOwnProperty(e)&&A&&(x=d[e].version,_=t.version,k=new v(x),T=new v(_),k.compare(T)>0)&&RED.utils.checkModuleAllowed(e,null,M,z)?(o.updateButton.show(),o.updateButton.text(RED._("palette.editor.update",{version:d[e].version}))):o.updateButton.hide()}else{c[e]={info:RED.nodes.registry.getModule(e)};var D=[e];for(var R in c[e].info.sets)c[e].info.sets.hasOwnProperty(R)&&(D.push(R),D=D.concat(c[e].info.sets[R].types));c[e].index=D.join(",").toLowerCase(),i.editableList("addItem",c[e])}var x,_,k,T}g.prototype.compare=function(e){switch(this.type+e.type){case"EE":return 0;case"NT":case"TE":case"EN":return-1;case"NN":return this.number-e.number;case"TT":return this.text.localeCompare(e.text);case"ET":case"TN":case"NE":return 1}},v.prototype.compare=function(e){for(var t=0,o=0,i=this.parts.length;0==t&&o<i;o++)t=this.parts[o].compare(e.parts[o]);return t};var R,x=[],_=!1,k=L;function T(e,t,i,n){if(x.push(e||n),e)_=!0;else{if(n.modules){n.modules=n.modules.filter((function(e){return!!RED.utils.checkModuleAllowed(e.id,e.version,N,P)&&(d[e.id]=e,e.index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.types&&(e.index=e.index.concat(e.types)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase(),!0)})),r=r.concat(n.modules)}o.searchBox("count",r.length)}if(a>1&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+x.length+"/"+a),x.length===a){_&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var s=250-(Date.now()-R);setTimeout((function(){$("#red-ui-palette-module-install-shade").hide()}),Math.max(s,0))}}function C(){if(0===r.length){r=[],d={},n.editableList("empty"),$(".red-ui-palette-module-shade-status").text(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];x=[],_=!1,a=e.length,e.length>1&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#red-ui-palette-module-install-shade").show(),R=Date.now();var t=0;e.forEach((function(e,i){$.getJSON(e,{_:(new Date).getTime()},(function(t){T(null,e,0,t),function(){for(var e in c)c.hasOwnProperty(e)&&D(e)}()})).fail((function(t,o,i){console.warn("Error loading catalog",e,":",i),T(t,e)})).always((function(){++t===a&&o.searchBox("change")}))}))}}function j(){if(n.editableList("empty"),""!==o.searchBox("value").trim()){s.sort(k);for(var e=0;e<Math.min(10,s.length);e++)n.editableList("addItem",s[e]);0===s.length&&n.editableList("addItem",{}),s.length>10&&n.editableList("addItem",{start:10,more:s.length-10})}else n.editableList("addItem",{count:r.length})}function L(e,t){var i=o.searchBox("value").trim();if(""===i)return S(e,t);var n=e.info.index.indexOf(i)-t.info.index.indexOf(i);return 0===n?S(e,t):n}function S(e,t){return e.info.id.localeCompare(t.info.id)}function O(e,t){return-1*(e.info.timestamp-t.info.timestamp)}var I,N=["*"],P=[],A=!0,M=["*"],z=[];function B(){return C(),e.activateTab("nodes"),I}function G(e,t,o){if(!1!==RED.settings.get("externalModules.palette.allowInstall",!0)){var i=[{text:RED._("common.label.cancel"),click:function(){n.close()}}];e.url&&i.push({text:RED._("palette.editor.confirm.button.review"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var t=e.url||"";window.open(t)}}),i.push({text:RED._("palette.editor.confirm.button.install"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var i=RED.utils.addSpinnerOverlay(t,!0),a=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(i);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(a).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+e.id+" "+e.version),y(e.id,e.version,e.pkg_url,(function(t){if(i.remove(),t&&t.responseJSON)var n=RED.notify(RED._("palette.editor.errors.installFailed",{module:e.id,message:t.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){n.close()}},{text:RED._("eventLog.view"),click:function(){n.close(),RED.actions.invoke("core:show-event-log")}}]});o(t)})),n.close()}});var n=RED.notify(RED._("palette.editor.confirm.install.body",{module:e.id}),{modal:!0,fixed:!0,buttons:i})}else o(new Error("Palette not editable"))}return{init:function(){if(!1!==RED.settings.get("externalModules.palette.allowInstall",!0)){var a=RED.settings.get("externalModules.palette.allowList"),u=RED.settings.get("externalModules.palette.denyList");(a||u)&&(N=a,P=u),N=RED.utils.parseModuleList(N),P=RED.utils.parseModuleList(P);var f=RED.settings.get("externalModules.palette.allowUpdateList"),h=RED.settings.get("externalModules.palette.denyUpdateList");(f||h)&&(M=f,z=h),M=RED.utils.parseModuleList(M),z=RED.utils.parseModuleList(z),A=RED.settings.get("externalModules.palette.allowUpdate",!0),function(){I=$('<div id="red-ui-settings-tab-palette"></div>');var a=$('<div id="red-ui-palette-editor"><ul id="red-ui-palette-editor-tabs"></ul></div>').appendTo(I);e=RED.tabs.create({element:I.find("#red-ui-palette-editor-tabs"),onchange:function(e){a.find(".red-ui-palette-editor-tab").hide(),e.content.show(),t&&t.searchBox("value",""),o&&o.searchBox("value",""),"install"===e.id?o&&o.trigger("focus"):t&&t.trigger("focus")},minimumActiveTabWidth:110}),function(o){var n=$("<div>",{class:"red-ui-palette-editor-tab"}).appendTo(o);e.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:n});var a=$("<div>",{class:"red-ui-palette-search"}).appendTo(n);t=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(a).searchBox({delay:200,change:function(){!function(e){p=e.toLowerCase();var o=i.editableList("filter"),n=i.editableList("length");""===e?t.searchBox("count"):t.searchBox("count",o+" / "+n)}($(this).val())}}),i=$("<ol>",{id:"red-ui-palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(n).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===p||(""===p||e.index.indexOf(p)>-1)},addItem:function(e,t,o){var i=o.info;if(i){var n=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(e),a=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(n);$("<span>").text(i.name).appendTo(a);var r=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(n),s=$("<span>").text(i.version).appendTo(r),l=$('<div class="red-ui-palette-module-meta red-ui-palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(n),c=$('<ul class="red-ui-palette-module-error-list"></ul>').appendTo(l),u=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(n),p=$('<a href="#" class="red-ui-button red-ui-button-small red-ui-palette-module-set-button"><i class="fa fa-angle-right red-ui-palette-module-node-chevron"></i> </a>').appendTo(u),f=$("<span>").appendTo(p),h=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(u),g=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.update")).appendTo(h);g.attr("id","up_"+Math.floor(1e9*Math.random())),g.on("click",(function(t){t.preventDefault(),$(this).hasClass("disabled")||function(e,t,o,i,n){if(!1===RED.settings.get("externalModules.palette.allowInstall",!0))return void n(new Error("Palette not editable"));var a=RED.notify(RED._("palette.editor.confirm.update.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary red-ui-palette-module-install-confirm-button-update",click:function(){var r=RED.utils.addSpinnerOverlay(i,!0),s=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(r);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(s).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+e.name+" "+t),y(e.name,t,o,(function(t){if(r.remove(),t&&t.responseJSON)var o=RED.notify(RED._("palette.editor.errors.updateFailed",{module:e.name,message:t.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){o.close()}},{text:RED._("eventLog.view"),click:function(){o.close(),RED.actions.invoke("core:show-event-log")}}]});n(t)})),a.close()}}]})}(i,d[i.name].version,d[i.name].pkg_url,e,(function(e){}))}));var v=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.remove")).appendTo(h);v.attr("id","up_"+Math.floor(1e9*Math.random())),v.on("click",(function(t){t.preventDefault(),function(e,t,o){if(!1===RED.settings.get("externalModules.palette.allowInstall",!0))return void o(new Error("Palette not editable"));var i=RED.notify(RED._("palette.editor.confirm.remove.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary red-ui-palette-module-install-confirm-button-remove",click:function(){var o=RED.utils.addSpinnerOverlay(t,!0),n=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(n).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.remove")+" : "+e.name),function(e,t){$.ajax({url:"nodes/"+e,type:"DELETE"}).done((function(e,o,i){t()})).fail((function(e,o,i){t(e)}))}(e.name,(function(t){if(o.remove(),t&&t.responseJSON)var i=RED.notify(RED._("palette.editor.errors.removeFailed",{module:e.name,message:t.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){i.close()}},{text:RED._("eventLog.view"),click:function(){i.close(),RED.actions.invoke("core:show-event-log")}}]})})),i.close()}}]})}(i,e,(function(e){}))})),i.local||v.hide();var m=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.disableall")).appendTo(h),E=$("<div>",{class:"red-ui-palette-module-content"}).appendTo(e),D=$('<div class="red-ui-palette-module-shade hide"><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(e);o.elements={updateButton:g,removeButton:v,enableButton:m,errorRow:l,errorList:c,setCount:f,container:e,shade:D,versionSpan:s,sets:{}},p.on("click",(function(t){t.preventDefault(),e.hasClass("expanded")?(e.removeClass("expanded"),E.slideUp()):(e.addClass("expanded"),E.slideDown())}));var R=Object.keys(i.sets);R.sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})),R.forEach((function(e){var t=i.sets[e],n=$("<div>",{class:"red-ui-palette-module-set"}).appendTo(E),a=$("<div>",{class:"red-ui-palette-module-set-button-group"}).appendTo(n),r={};t.types.forEach((function(e){var t=$("<div>",{class:"red-ui-palette-module-type"}).appendTo(n);r[e]=$("<span>",{class:"red-ui-palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"red-ui-palette-module-type-node"}).text(e).appendTo(t)}));var s=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').appendTo(a);s.on("click",(function(i){if(i.preventDefault(),0===o.setUseCount[e]){var n=RED.nodes.registry.getNodeSet(t.id);D.show();var a=!n.enabled;b(t.id,a,D,(function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(a?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))}))}})),o.elements.sets[t.name]={setRow:n,enableButton:s,swatches:r}})),m.on("click",(function(t){t.preventDefault(),0===o.totalUseCount&&b(i.name,e.hasClass("disabled"),D,(function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))}))})),w(i.name)}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}})}(a),function(t){var i=$("<div>",{class:"red-ui-palette-editor-tab hide"}).appendTo(t);e.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:i});var a=$("<div>",{class:"red-ui-palette-editor-toolbar"}).appendTo(i),l=$("<div>",{class:"red-ui-palette-search"}).appendTo(i);o=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(l).searchBox({delay:300,change:function(){var e=$(this).val().trim().toLowerCase();e.length>0?(s=r.filter((function(t){return t.index.indexOf(e)>-1})).map((function(e){return{info:e}})),j(),o.searchBox("count",s.length+" / "+r.length)):(o.searchBox("count",r.length),n.editableList("empty"),n.editableList("addItem",{count:r.length}))}}),$("<span>").text(RED._("palette.editor.sort")+" ").appendTo(a);var u=$('<span class="button-group"></span>').appendTo(a),p=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle selected"><i class="fa fa-sort-amount-desc"></i></a>').appendTo(u),f=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortAZ"></a>').appendTo(u),h=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(u);[{button:p,func:L},{button:f,func:S},{button:h,func:O}].forEach((function(e){e.button.on("click",(function(t){t.preventDefault(),$(this).hasClass("selected")||($(".red-ui-palette-editor-install-sort-option").removeClass("selected"),$(this).addClass("selected"),k=e.func,j())}))}));var g=$("<span>").appendTo(a),v=$('<a href="#" class="red-ui-sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(g);if(v.on("click",(function(e){e.preventDefault(),r=[],d={},C()})),RED.popover.tooltip(v,RED._("palette.editor.refresh")),n=$("<ol>",{style:"position: absolute;top: 79px;bottom: 0;left: 0;right: 0px;"}).appendTo(i).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){if(o.count)$("<div>",{class:"red-ui-search-empty"}).text(RED._("palette.editor.moduleCount",{count:o.count})).appendTo(e);else if(o.more){e.addClass("red-ui-palette-module-more");var i=$("<div>",{class:"red-ui-palette-module-header palette-module"}).appendTo(e);$('<a href="#"></a>').text(RED._("palette.editor.more",{count:o.more})).appendTo(i).on("click",(function(e){e.preventDefault(),n.editableList("removeItem",o);for(var t=o.start;t<Math.min(o.start+10,o.start+o.more);t++)n.editableList("addItem",s[t]);o.more>10&&n.editableList("addItem",{start:o.start+10,more:o.more-10})}))}else if(o.info){var a=o.info,r=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(e),d=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(r);$("<span>").text(a.name||a.id).appendTo(d),$('<a target="_blank" class="red-ui-palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",a.url).appendTo(d);var l=$('<div class="red-ui-palette-module-meta"></div>').appendTo(r);$("<div>",{class:"red-ui-palette-module-description"}).text(a.description).appendTo(l);var u=$('<div class="red-ui-palette-module-meta"></div>').appendTo(r);$('<span class="red-ui-palette-module-version"><i class="fa fa-tag"></i> '+a.version+"</span>").appendTo(u),$('<span class="red-ui-palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var o=Math.floor(t/7);if(o<4)return RED._("palette.editor.times.weeksV",{count:o});var i=Math.floor(o/4);if(o%=4,i<12)return RED._("palette.editor.times.monthsV",{count:i});var n=Math.floor(i/12);return 0==(i%=12)?RED._("palette.editor.times.yearsV",{count:n}):RED._("palette.editor.times.year"+(n>1?"s":"")+"MonthsV",{y:n,count:i})}(a.updated_at)+"</span>").appendTo(u);var p=!1;if(a.types&&a.types.length>0)for(t=0;t<a.types.length;t++){var f=RED.nodes.registry.getNodeSetForType(a.types[t]);if(f){p=f.module;break}}var h=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(r),g=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(h),v=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.install")).appendTo(g);v.on("click",(function(t){t.preventDefault(),$(this).hasClass("disabled")||G(a,e,(function(e){}))})),c.hasOwnProperty(a.id)?(v.addClass("disabled"),v.text(RED._("palette.editor.installed"))):p&&(v.addClass("disabled"),v.text(RED._("palette.editor.conflict")),RED.popover.create({target:v,content:RED._("palette.editor.conflictTip",{module:p}),trigger:"hover",direction:"bottom",delay:{show:750,hide:50}})),o.elements={installButton:v}}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}}),!1!==RED.settings.get("externalModules.palette.allowUpload",!0)){var m=$('<span class="button-group">').prependTo(a),b=$('<button type="button" class="red-ui-sidebar-header-button red-ui-palette-editor-upload-button"><label><i class="fa fa-upload"></i><form id="red-ui-palette-editor-upload-form" enctype="multipart/form-data"><input name="tarball" type="file" accept=".tgz"></label></button>').appendTo(m),y=b.find('input[type="file"]');y.on("change",(function(e){this.files.length>0&&(R.text(this.files[0].name),w.slideDown(200))}));var w=$('<div class="red-ui-palette-editor-upload"></div>').appendTo(i),E=$("<div>").appendTo(w),D=$('<div class="placeholder-input"><i class="fa fa-upload"></i> </div>').appendTo(E),R=$("<span></span>").appendTo(D),x=$('<div class="red-ui-palette-editor-upload-buttons"></div>').appendTo(E);$('<button class="editor-button"></button>').text(RED._("common.label.cancel")).appendTo(x).on("click",(function(e){e.preventDefault(),w.slideUp(200),y.val("")})),$('<button class="editor-button primary"></button>').text(RED._("common.label.upload")).appendTo(x).on("click",(function(e){e.preventDefault();var t=RED.utils.addSpinnerOverlay(w,!0),o=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(t);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(o).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+y[0].files[0].name);var i=new FormData;i.append("tarball",y[0].files[0]);var n=y[0].files[0].name;$.ajax({url:"nodes",data:i,cache:!1,contentType:!1,processData:!1,method:"POST"}).always((function(e,o,i){t.remove(),y.val(""),w.slideUp(200)})).fail((function(e,t,o){var i=t;e.responseJSON&&(i=e.responseJSON.message);var a=RED.notify(RED._("palette.editor.errors.installFailed",{module:n,message:i}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){a.close()}},{text:RED._("eventLog.view"),click:function(){a.close(),RED.actions.invoke("core:show-event-log")}}]});y.val(""),w.slideUp(200)}))})),RED.popover.tooltip(b,RED._("palette.editor.upload"))}$('<div id="red-ui-palette-module-install-shade" class="red-ui-palette-module-shade hide"><div class="red-ui-palette-module-shade-status"></div><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(i)}(a)}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:B,close:function(){I.detach()},focus:function(){e.resize(),setTimeout((function(){t.trigger("focus")}),200)}}),RED.actions.add("core:manage-palette",(function(){RED.userSettings.show("palette")})),RED.events.on("registry:module-updated",(function(e){w(e.module)})),RED.events.on("registry:node-set-enabled",(function(e){w(e.module)})),RED.events.on("registry:node-set-disabled",(function(e){w(e.module)})),RED.events.on("registry:node-type-added",(function(e){/^subflow:/.test(e)||w(RED.nodes.registry.getNodeSetForType(e).module)})),RED.events.on("registry:node-type-removed",(function(e){/^subflow:/.test(e)||w(RED.nodes.registry.getNodeSetForType(e).module)})),RED.events.on("registry:node-set-added",(function(e){w(e.module);for(var t=0;t<s.length;t++)if(s[t].info.id===e.module){var o=s[t].elements.installButton;o.addClass("disabled"),o.text(RED._("palette.editor.installed"));break}})),RED.events.on("registry:node-set-removed",(function(e){if(!RED.nodes.registry.getModule(e.module)){var t=c[e.module];if(t){i.editableList("removeItem",t),delete c[e.module];for(var o=0;o<s.length;o++)if(s[o].info.id===e.module){var n=s[o].elements.installButton;n.removeClass("disabled"),n.text(RED._("palette.editor.install"));break}}}})),RED.events.on("nodes:add",(function(e){/^subflow:/.test(e.type)||(l[e.type]=(l[e.type]||0)+1,1===l[e.type]&&w(RED.nodes.registry.getNodeSetForType(e.type).module))})),RED.events.on("nodes:remove",(function(e){l.hasOwnProperty(e.type)&&(l[e.type]--,0===l[e.type]&&(delete l[e.type],w(RED.nodes.registry.getNodeSetForType(e.type).module)))}))}},install:G}}(),RED.editor=function(){var e=[],t=!1,o={},i={},n={},a={};function r(e){var t,o,i,n,a=e.valid,d=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))o=(t=RED.nodes.subflow(e.type.substring(8))).valid,n=t.changed,void 0===o&&(o=r(t),n=t.changed),i=s(e,e._def.defaults,e),e.valid=o&&0===i.length,e.changed=e.changed||n,e.validationErrors=i;else if(e._def)i=s(e,e._def.defaults,e),e._def._creds&&(i=i.concat(s(e,e._def.credentials,e._def._creds))),e.valid=0===i.length,e.validationErrors=i;else if("subflow"==e.type){for(var l=RED.nodes.filterNodes({z:e.id}),c=0;c<l.length;c++)o=l[c].valid,n=l[c].changed,void 0===o&&(o=r(l[c]),n=l[c].changed),e.valid=e.valid&&o,e.changed=e.changed||n;var u=RED.nodes.filterNodes({type:"subflow:"+e.id}),p={};for(c=0;c<u.length;c++)u[c].valid=e.valid,u[c].changed=u[c].changed||e.changed,u[c].dirty=!0,p[u[c].z]=!0;Object.keys(p).forEach((function(e){var t=RED.nodes.subflow(e);t&&r(t)}))}return a===e.valid&&d===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&r(t)),e.valid}function s(e,t,o){var i=[];for(var n in t)if(t.hasOwnProperty(n)){var a=d(e,t,n,o[n]);"string"==typeof a?i.push(a):a||i.push(n)}return i}function d(e,t,o,i){var n=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(i))return!0;if(/^\$\{[a-zA-Z_][a-zA-Z0-9_]*\}$/.test(i))return!0;var a=null;if("label"in t[o]&&"string"==typeof t[o].label&&(a=t[o].label),"required"in t[o]&&t[o].required&&!(n=""!==i)&&a)return RED._("validator.errors.missing-required-prop",{prop:a});if(n&&"validate"in t[o])try{var r={};if(a&&(r.label=a),n=t[o].validate.call(e,i,r),2===t[o].validate.length&&"string"==typeof n)return n;n=!!n}catch(t){return console.log("Validation error:",e.type,e.id,"property: "+o,"value:",i,t),RED._("validator.errors.validation-error",{prop:o,node:e.type,id:e.id,error:t.message})}if(n&&t[o].type&&RED.nodes.getType(t[o].type)&&!("validate"in t[o])){if(i&&"_ADD_"!=i){var s=RED.nodes.node(i);if(s){if(null==s.valid||s.valid)return!0;if(a)return RED._("validator.errors.invalid-config",{prop:a})}else if(a)return RED._("validator.errors.missing-config",{prop:a});return!1}if(!(n=t[o].hasOwnProperty("required")&&!t[o].required)&&a)return RED._("validator.errors.missing-required-prop",{prop:a})}return n}function l(e,t){for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&c(e,e._def.defaults,o,t);if(e._def.credentials)for(o in e._def.credentials)e._def.credentials.hasOwnProperty(o)&&c(e,e._def.credentials,o,t)}function c(e,t,o,i){var n=$("#"+i+"-"+o);if(n.length>0){var a=n.val();t[o].hasOwnProperty("format")&&""!==t[o].format&&"DIV"===n[0].nodeName&&(a=n.text());var r,s=d(e,t,o,a);if("string"!=typeof s&&s)n.removeClass("input-error"),(r=n.data("tooltip"))&&(n.data("tooltip",null),r.delete());else if(n.addClass("input-error"),"string"==typeof s)(r=n.data("tooltip"))?r.setContent(s):(r=RED.popover.tooltip(n,s),n.data("tooltip",r))}}function u(e,t){e.resize=!0,e.dirty=!0,e.dirtyStatus=!0;var o=[];t&&RED.nodes.eachLink((function(i){i.source===e&&t.hasOwnProperty(i.sourcePort)&&("-1"===t[i.sourcePort]?o.push(i):i.sourcePort=t[i.sourcePort])})),e.hasOwnProperty("__outputs")&&(e.outputs<e.__outputs&&RED.nodes.eachLink((function(t){t.source===e&&t.sourcePort>=e.outputs&&-1===o.indexOf(t)&&o.push(t)})),delete e.__outputs),e.inputs=Math.min(1,Math.max(0,parseInt(e.inputs))),isNaN(e.inputs)&&(e.inputs=0),0===e.inputs&&(o=o.concat(RED.nodes.filterLinks({target:e})));for(var i=0;i<o.length;i++)RED.nodes.removeLink(o[i]);return o}function p(e,t,o,i,n){var a=$("#"+i+"-"+t);if(0!==a.length){var r,s=a.width(),d=a.attr("style");s=null!==(r=/(^|\s|;)width\s*:\s*([^;]+)/i.exec(d))?r[2].trim():"70%";var l=$("<div></div>").css({width:s,display:"inline-flex"}),c=$('<select id="'+i+"-"+t+'"></select>').appendTo(l);a.replaceWith(l),c.css({"flex-grow":1}),E(t,o,e[t],i,n),$('<a id="'+i+"-lookup-"+t+'" class="red-ui-button"><i class="fa fa-pencil"></i></a>').css({"margin-left":"10px"}).appendTo(l),$("#"+i+"-lookup-"+t).on("click",(function(n){D(t,o,c.find(":selected").val(),i,e),n.preventDefault()}));var u="",p=RED.nodes.node(e[t]);RED.nodes.getType(o);p&&(u=RED.utils.getNodeLabel(p,p.id)),a.val(u)}}function f(e,t,o,i){var n=$("#"+i+"-"+t);n.val(e[t]),n.attr("type","hidden");var a=$("<a>",{id:i+"-edit-"+t,class:"red-ui-button"});n.after(a),e[t]?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),a.on("click",(function(a){D(t,o,n.val()||"_ADD_",i,e),a.preventDefault()}))}function h(e,t,o,i){var n=$("#"+o+"-"+t);if(0!==n.length)if("checkbox"===n.attr("type"))n.prop("checked",e[t]);else{var a=e[t];null==a&&(a=""),void 0!==i&&i[t].hasOwnProperty("format")&&""!==i[t].format&&"DIV"===n[0].nodeName?(n.html(RED.text.format.getHtml(a,i[t].format,{},!1,"en")),RED.text.format.attach(n[0],i[t].format,{},!1,"en")):(n.val(a),"INPUT"!==n[0].nodeName&&"TEXTAREA"!==n[0].nodeName||RED.text.bidi.prepareInput(n))}}function g(e,t,o,i){$("#"+i+"-"+o).on("change keyup paste",(function(t){$(this).attr("skipValidation")||l(e,i)}))}function v(e,t,o,i){var n;for(n in t)t.hasOwnProperty(n)&&("password"==t[n].type?o[n]?$("#"+i+"-"+n).val(o[n]):o["has_"+n]?$("#"+i+"-"+n).val("__PWRD__"):$("#"+i+"-"+n).val(""):h(o,n,i,t),g(e,0,n,i))}function m(e,t,o,a,r,s,d){var c=!1,u=function(){var u=$("<ul></ul>").appendTo(e),m=$("<div></div>").appendTo(e),b=RED.tabs.create({element:u,onchange:function(e){m.children().hide(),e.content.show(),e.onchange&&e.onchange.call(e),c&&RED.tray.resize()},collapsible:!0,menu:!1}),y=[];for(var w in t=t.slice(),n)n.hasOwnProperty(w)&&n[w](o)&&t.push(w);for(var E in t.forEach((function(e){try{var t=i[e];if(t){"function"==typeof t&&(t=t.call(t,o));var n=$("<div>",{class:"red-ui-tray-content"}).appendTo(m).hide();t.create.call(t,n);var a={id:e,label:t.label,name:t.name,iconClass:t.iconClass,content:n,onchange:function(){t.show&&t.show.call(t)}};b.addTab(a),y.push(t)}else console.warn("Unregisted edit pane:",e)}catch(t){console.log(e,t)}})),a.defaults)if(a.defaults.hasOwnProperty(E)){if(a.defaults[E].type){if(!a.defaults[E]._type.array){var D=RED.nodes.getType(a.defaults[E].type);D&&"config"===D.category?D.exclusive?f(o,E,a.defaults[E].type,r):p(o,E,a.defaults[E].type,r,a.defaults[E].filter):(console.log("Unknown type:",a.defaults[E].type),h(o,E,r,a.defaults))}}else h(o,E,r,a.defaults);g(o,a.defaults,E,r)}if(/^subflow:/.test(a.type)||v(o,a.credentials,o.credentials,r),a.oneditprepare)try{a.oneditprepare.call(o)}catch(e){console.log("oneditprepare",o.id,o.type,e.toString()),console.log(e.stack)}for(var E in a.defaults){if(a.defaults.hasOwnProperty(E))(R=$("#"+r+"-"+E)).attr("skipValidation",!0),void 0!==R.data("noderedTypedInput")?R.trigger("change",[R.typedInput("type"),R.typedInput("value")]):R.trigger("change"),R.removeAttr("skipValidation")}if(a.credentials)for(E in a.credentials){var R;if(a.credentials.hasOwnProperty(E))(R=$("#"+r+"-"+E)).attr("skipValidation",!0),void 0!==R.data("noderedTypedInput")?R.trigger("change",[R.typedInput("type"),R.typedInput("value")]):R.trigger("change"),R.removeAttr("skipValidation")}l(o,r),c=!0,s&&b.activateTab(s),d&&d(y)};if(a.credentials||/^subflow:/.test(a.type)||"group"===o.type||"tab"===o.type)if(o.credentials)v(o,a.credentials,o.credentials,r),u();else{var m=o.type;/^subflow:/.test(m)&&(m="subflow"),function(e,t,o){var i,n=setTimeout((function(){i=RED.notify($('<p data-i18n="[prepend]editor.loadCredentials">  <img src="red/images/spin.svg"/></p>').i18n(),{fixed:!0})}),800),a="credentials/"+e.replace(/\s+/g,"-")+"/"+t;$.ajax({url:a,dataType:"json",success:function(e){i&&(i.close(),i=null),clearTimeout(n),o(e)},error:function(e,t,a){i&&(i.close(),i=null),clearTimeout(n),RED.notify(RED._("editor.errors.credentialLoadFailed"),"error"),o(null)},timeout:3e4})}(m,o.id,(function(e){e&&(o.credentials=e,o.credentials._=$.extend(!0,{},e)),u()}))}else u()}function b(){for(var t,o=e.length-1;o<e.length;o++){var i=e[o];if(t=i.type,"group"===i.type)t=RED._("group.editGroup",{name:RED.utils.sanitize(i.name||i.id)});else if("_expression"===i.type)t=RED._("expressionEditor.title");else if("_js"===i.type)t=RED._("jsEditor.title");else if("_text"===i.type)t=RED._("textEditor.title");else if("_json"===i.type)t=RED._("jsonEditor.title");else if("_markdown"===i.type)t=RED._("markdownEditor.title");else if("_buffer"===i.type)t=RED._("bufferEditor.title");else if("subflow"===i.type)t=RED._("subflow.editSubflow",{name:RED.utils.sanitize(i.name)});else if(0===i.type.indexOf("subflow:")){var n=RED.nodes.subflow(i.type.substring(8));t=RED._("subflow.editSubflowInstance",{name:RED.utils.sanitize(n.name)})}else if(void 0!==i._def){if(void 0!==i._def.paletteLabel)try{t=RED.utils.sanitize(("function"==typeof i._def.paletteLabel?i._def.paletteLabel.call(i._def):i._def.paletteLabel)||"")}catch(e){console.log("Definition error: "+i.type+".paletteLabel",e)}o===e.length-1&&(t=RED.nodes.node(i.id)?RED._("editor.editNode",{type:RED.utils.sanitize(t)}):RED._("editor.addNewConfig",{type:RED.utils.sanitize(t)}))}}return t}function y(e,t){var o;if(e._def.oneditsave){var i={};for(o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&("string"==typeof e[o]||"number"==typeof e[o]?i[o]=e[o]:i[o]=$.extend(!0,{},{v:e[o]}).v);try{!0===e._def.oneditsave.call(e)&&(t.changed=!0)}catch(t){console.warn("oneditsave",e.id,e.type,t.toString())}for(o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&(null===i[o]||"string"==typeof i[o]||"number"==typeof i[o]?i[o]!==e[o]&&(t.changes[o]=i[o],t.changed=!0):"group"===e.type&&"nodes"===o||JSON.stringify(i[o])!==JSON.stringify(e[o])&&(t.changes[o]=i[o],t.changed=!0))}}function w(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function E(e,t,o,i,n){if(i){var a=$("#"+i+"-edit-"+e);if(a.length)o?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),$("#"+i+"-"+e).val(o);else{var r=$("#"+i+"-"+e),s=RED.nodes.getType(t);r.children().remove();var d=RED.nodes.workspace(RED.workspaces.active());d||(d=RED.nodes.subflow(RED.workspaces.active()));var l=[];"function"!=typeof n&&(n=null),RED.nodes.eachConfig((function(e){if(e.type==t&&(!e.z||e.z===d.id)&&(!n||n.call(null,e))){var o=RED.utils.getNodeLabel(e,e.id);e.__label__=o+(e.d?" ["+RED._("workspace.disabled")+"]":""),l.push(e)}}));var c=w;"function"==typeof s.sort&&(c=s.sort);try{l.sort(c)}catch(e){console.log("Definition error: "+s.type+".sort",e)}l.forEach((function(e){$('<option value="'+e.id+'"'+(o==e.id?" selected":"")+"></option>").text(RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)).appendTo(r),delete e.__label__}));var u=t;if(void 0!==s.paletteLabel)try{u=RED.utils.sanitize(("function"==typeof s.paletteLabel?s.paletteLabel.call(s):s.paletteLabel)||t)}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}r.append('<option value="_ADD_"'+(""===o?" selected":"")+">"+RED._("editor.addNewType",{type:u})+"</option>"),window.setTimeout((function(){r.trigger("change")}),50)}}}function D(o,i,n,a,s){if(!t){t=!0;var d="_ADD_"==n,l=RED.nodes.getType(i),c=RED.nodes.node(n),u=[],p="",f=RED.nodes.subflow(RED.workspaces.active());if(f&&(p=f.id),null==c){for(var h in c={id:RED.nodes.id(),_def:l,type:i,z:p,users:[]},l.defaults)l.defaults[h].value&&(c[h]=JSON.parse(JSON.stringify(l.defaults[h].value)));c._=l._}e.push(c),RED.view.state(RED.state.EDITING);var g={title:b(),resize:function(e){$(".red-ui-tray-content").height(e.height-50);var t=$("#node-config-dialog-edit-form"),o={width:t.width(),height:t.height()};u.forEach((function(e){e.resize&&e.resize.call(e,o)}))},open:function(e,o){e.find(".red-ui-tray-header");var i=e.find(".red-ui-tray-body"),n=e.find(".red-ui-tray-footer"),a=$('<div class="red-ui-tray-footer-left"></div>').appendTo(n);$('<input id="node-config-input-node-disabled" type="checkbox">').prop("checked",!!c.d).appendTo(a).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0}),!1!==l.hasUsers&&$('<span><i class="fa fa-info-circle"></i> <span id="red-ui-editor-config-user-count"></span></span>').css("margin-left","10px").appendTo(a),n.append('<span class="red-ui-tray-footer-right"><span id="red-ui-editor-config-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="red-ui-editor-config-scope"></select></span>');var r=["editor-tab-properties"];c._def.defaults&&c._def.defaults.hasOwnProperty("info")||r.push("editor-tab-description"),m(i,r,c,l,"node-config-input",null,(function(e){u=e,c._def.exclusive?$("#red-ui-editor-config-scope").hide():$("#red-ui-editor-config-scope").show(),$("#red-ui-editor-config-scope-warning").hide();var a={};c.users.forEach((function(e){a[e.z]=!0}));var r=Object.keys(a).length,s=$("#red-ui-editor-config-scope").empty();s.off("change"),s.append('<option value=""'+(c.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),s.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace((function(e){var t=e.label;a[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==c.z?" selected":"")+"></option>").text(t).appendTo(s)})),s.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow((function(e){var t=e.name;a[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==c.z?" selected":"")+"></option>").text(t).appendTo(s)})),r>0&&s.on("change",(function(){var e=$(this).val();""===e?$("#red-ui-editor-config-scope-warning").hide():!a[e]||r>1?$("#red-ui-editor-config-scope-warning").show():$("#red-ui-editor-config-scope-warning").hide()})),!1!==l.hasUsers&&$("#red-ui-editor-config-user-count").text(RED._("editor.nodesUse",{count:c.users.length})).parent().show(),i.i18n(),n.i18n(),t=!1,o()}))},close:function(){RED.workspaces.refresh(),u.forEach((function(e){e.close&&e.close.call(e)})),e.pop()},show:function(){c&&(RED.sidebar.info.refresh(c),RED.sidebar.help.show(i,!1))}};g.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var e=i,t=c.id,o=RED.nodes.getType(e);if(o.oneditcancel&&o.oneditcancel){var n=RED.nodes.node(t);if(n)try{o.oneditcancel.call(n,!1)}catch(e){console.log("oneditcancel",n.id,n.type,e.toString())}else try{o.oneditcancel.call({id:t},!0)}catch(o){console.log("oneditcancel",t,e,o.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:d?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,t,n={changes:{},changed:!1,outputMap:null},l=o,p=(c.id,i),f=d,h=RED.nodes.getType(p);if(h.oneditsave)try{h.oneditsave.call(c)}catch(e){console.warn("oneditsave",c.id,c.type,e.toString())}for(e in h.defaults){var g;if(h.defaults.hasOwnProperty(e))if(null!=(g="checkbox"===(t=$("#node-config-input-"+e)).attr("type")?t.prop("checked"):"format"in h.defaults[e]&&""!==h.defaults[e].format&&"DIV"===t[0].nodeName?t.text():t.val())&&g!==c[e]){if(c._def.defaults[e].type){"_ADD_"==g&&(g="");var v=RED.nodes.node(c[e]);if(v){var m=v.users;m.splice(m.indexOf(c),1),RED.events.emit("nodes:change",v)}(v=RED.nodes.node(g))&&(v.users.push(c),RED.events.emit("nodes:change",v))}c[e]=g}}u.forEach((function(e){e.apply&&e.apply.call(e,n)})),c.label=h.label;var b=$("#red-ui-editor-config-scope").val();c.z=b,$("#node-config-input-node-disabled").prop("checked")?!0!==c.d&&(c.d=!0):!0===c.d&&delete c.d,b&&(c.users=c.users.filter((function(e){var t=!0;for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&e._def.defaults[o].type===c.type&&e[o]===c.id&&e.z!==b&&(t=!1,e[o]=null,e.dirty=!0,e.changed=!0,r(e));return t}))),f&&RED.nodes.add(c),r(c);var y={};y[c.id]=!0;for(var w=c.users.slice();w.length>0;){var D=w.pop();y[D.id]||(y[D.id]=!0,D.users&&(w=w.concat(D.users)),r(D))}RED.nodes.dirty(!0),RED.view.redraw(!0),f||(RED.events.emit("editor:save",c),RED.events.emit("nodes:change",c)),RED.tray.close((function(){var e=null;s&&"function"==typeof s._def.defaults[l].filter&&(e=function(e){return s._def.defaults[l].filter.call(s,e)}),E(l,p,c.id,a,e)}))}}],d||g.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=o,t=c.id,n=i,d=RED.nodes.getType(n);try{d.ondelete&&(console.log("Deprecated API warning: config node type ",n," has an ondelete function - should be oneditdelete"),d.ondelete.call(c)),d.oneditdelete&&d.oneditdelete.call(c)}catch(e){console.log("oneditdelete",c.id,c.type,e.toString())}for(var l={t:"delete",nodes:[c],changes:{},dirty:RED.nodes.dirty()},u=0;u<c.users.length;u++){var p=c.users[u];for(var f in l.changes[p.id]={changed:p.changed,valid:p.valid},p._def.defaults)p._def.defaults.hasOwnProperty(f)&&p[f]==t&&(l.changes[p.id][f]=t,p[f]="",p.changed=!0,p.dirty=!0);r(p)}RED.nodes.remove(t),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(l),RED.tray.close((function(){var t=null;s&&"function"==typeof s._def.defaults[e].filter&&(t=function(t){return s._def.defaults[e].filter.call(s,t)}),E(e,n,"",a,t)}))}}),RED.tray.show(g)}}function R(t,i){o.hasOwnProperty(t)?(e.length>0&&(i.parent=e[e.length-1].id),e.push({type:t}),i.title=i.title||b(),i.onclose=function(){e.pop()},o[t].show(i)):console.log("Unknown type editor:",t)}return{init:function(){window.ace&&window.ace.config.set("basePath","vendor/ace"),RED.tray.init(),RED.actions.add("core:confirm-edit-tray",(function(){$(document.activeElement).blur(),$("#node-dialog-ok").trigger("click"),$("#node-config-dialog-ok").trigger("click")})),RED.actions.add("core:cancel-edit-tray",(function(){$(document.activeElement).blur(),$("#node-dialog-cancel").trigger("click"),$("#node-config-dialog-cancel").trigger("click")})),RED.editor.codeEditor.init()},generateViewStateId:function(e,t,o){try{const i="object"==typeof(t=t||{}).options?t.options:{};let n;if((t.hasOwnProperty("stateId")||i.hasOwnProperty("stateId"))&&(n=t.stateId),!1===n)return!1;if(!n){let a;const r=RED.view.selection();if("node"===e&&t.id)a=t.id;else{if(!r.nodes||!r.nodes.length)return!1;a=r.nodes[0].id}const s=[a],d=$(t.element||i.element);d.length&&(s.push(d.closest(".form-row").index()),s.push(d.index())),"typedInput"==e&&(s.push(d.closest("li").index()),!o&&t.propertyType&&(o=t.propertyType)),n=s.join("/")}return n&&o&&(n+="/"+o),n}catch(e){return!1}},edit:function(o,i){if(!t){t=!0;var n=o,s=!1,d=!1,l=[];e.push(o),RED.view.state(RED.state.EDITING);var c=o.type;"subflow:"==o.type.substring(0,8)&&(c="subflow");var p={title:b(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],o=[],i=RED.nodes.remove(n.id);t.push(n);var a={t:"delete",nodes:t=t.concat(i.nodes),links:o=o.concat(i.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(n._def){if(n._def.oneditcancel)try{n._def.oneditcancel.call(n)}catch(e){console.log("oneditcancel",n.id,n.type,e.toString())}for(var e in n._def.defaults)if(n._def.defaults.hasOwnProperty(e)){var t=n._def.defaults[e];if(t.type){var o=RED.nodes.getType(t.type);if(o&&o.exclusive){var i=$("#node-input-"+e).val()||"";""===i||n[e]||RED.nodes.remove(i)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e={changes:{},changed:!1,outputMap:null},t=RED.nodes.dirty();y(n,e),l.forEach((function(t){t.apply&&t.apply.call(t,e)}));var i=u(n,e.outputMap);if($("#node-input-node-disabled").prop("checked")?!0!==o.d&&(e.changes.d=o.d,e.changed=!0,o.d=!0):!0===o.d&&(e.changes.d=o.d,e.changed=!0,delete o.d),o.resize=!0,e.changed){var a=n.changed;n.changed=!0,RED.nodes.dirty(!0);var s=RED.nodes.subflow(RED.workspaces.active()),d=null;s&&(d=[],RED.nodes.eachNode((function(e){e.type=="subflow:"+RED.workspaces.active()&&(d.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,u(e))})));var c={t:"edit",node:n,changes:e.changes,links:i,dirty:t,changed:a};e.outputMap&&(c.outputMap=e.outputMap),d&&(c.subflow={instances:d}),RED.history.push(c)}n.dirty=!0,r(n),RED.events.emit("editor:save",n),RED.events.emit("nodes:change",n),RED.tray.close()}}],resize:function(e){a[c]=e.width,$(".red-ui-tray-content").height(e.height-50);var t=$(".red-ui-tray-content form").height(e.height-50-40),o={width:t.width(),height:t.height()};l.forEach((function(e){e.resize&&e.resize.call(e,o)}))},open:function(e,a){n.hasOwnProperty("outputs")&&(n.__outputs=n.outputs);var r=e.find(".red-ui-tray-footer"),d=e.find(".red-ui-tray-body");d.parent().css("overflow","hidden");var c=$('<div class="red-ui-tray-footer-left"></div>').appendTo(r);$('<input id="node-input-node-disabled" type="checkbox">').prop("checked",!!o.d).appendTo(c).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0});var u=["editor-tab-properties"];/^subflow:/.test(o.type)&&u.push("editor-tab-envProperties"),o._def.defaults&&o._def.defaults.hasOwnProperty("info")||(u.push("editor-tab-description"),s=!0,o.infoEditor&&(o.infoEditor__orig=o.infoEditor,delete o.infoEditor,s=!1)),u.push("editor-tab-appearance"),m(d,u,o,o._def,"node-input",i,(function(e){l=e,d.i18n(),r.i18n(),t=!1,a()}))},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),n&&(n.infoEditor__orig&&(n.infoEditor=n.infoEditor__orig,delete n.infoEditor__orig),s&&delete n.infoEditor,d||RED.sidebar.info.refresh(n)),RED.workspaces.refresh(),l.forEach((function(e){e.close&&e.close.call(e)})),RED.view.redraw(!0),e.pop()},show:function(){n&&(RED.sidebar.info.refresh(n),RED.sidebar.help.show(n.type,!1),"BODY"===document.activeElement.tagName&&$("#red-ui-editor-stack").trigger("focus"))}};if(a.hasOwnProperty(c)&&(p.width=a[c]),"subflow"===c){var f=n.type.substring(8);p.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(f),d=!0,$("#node-dialog-ok").trigger("click")}})}RED.tray.show(p)}},editConfig:D,editFlow:function(e,o){if(!t){t=!0;var i=[];RED.view.state(RED.state.EDITING);var n={title:RED._("workspace.editFlow",{name:RED.utils.sanitize(e.label)}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===RED.workspaces.count()?" disabled":""),text:RED._("common.label.delete"),click:function(){RED.workspaces.delete(e),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var t={changes:{},changed:!1,outputMap:null},o=RED.nodes.dirty();i.forEach((function(e){e.apply&&e.apply.call(e,t)}));var n=$("#node-input-disabled").prop("checked");if(e.disabled!==n&&(t.changes.disabled=e.disabled,t.changed=!0,e.disabled=n,$("#red-ui-tab-"+e.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!e.disabled),e.id===RED.workspaces.active()&&$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!e.disabled)),t.changed){var a={t:"edit",changes:t.changes,node:e,dirty:o};e.changed=!0,RED.history.push(a),RED.nodes.dirty(!0),t.changes.hasOwnProperty("disabled")&&(RED.nodes.eachNode((function(t){t.z===e.id&&(t.dirty=!0)})),RED.view.redraw()),RED.workspaces.refresh(),RED.events.emit("flows:change",e)}RED.tray.close()}}],resize:function(e){$(".red-ui-tray-content").height(e.height-50);var t=$(".red-ui-tray-content form").height(e.height-50-40),o={width:t.width(),height:t.height()};i.forEach((function(e){e.resize&&e.resize.call(e,o)}))},open:function(n,a){var r=n.find(".red-ui-tray-footer"),s=n.find(".red-ui-tray-body");s.parent().css("overflow","hidden");var d=$('<div class="red-ui-tray-footer-left"></div>').appendTo(r);e.hasOwnProperty("disabled")||(e.disabled=!1),$('<input id="node-input-disabled" type="checkbox">').prop("checked",e.disabled).appendTo(d).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0}),m(s,["editor-tab-flow-properties","editor-tab-envProperties"],e,{},"node-input",o,(function(e){i=e,s.i18n(),r.i18n(),t=!1,a()}))},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),i.forEach((function(e){e.close&&e.close.call(e)}));var t=RED.view.selection();t.nodes||t.links||e.id!==RED.workspaces.active()||RED.sidebar.info.refresh(e)}};RED.tray.show(n)}},editSubflow:function(o,i){if(!t){t=!0;var n=o,a=[];e.push(o),RED.view.state(RED.state.EDITING);var s={title:b(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={changes:{},changed:!1,outputMap:null},t=RED.nodes.dirty();a.forEach((function(t){t.apply&&t.apply.call(t,e)}));var o=$("#subflow-input-name").val();o!=n.name&&(e.changes.name=n.name,n.name=o,e.changed=!0);var i,s,d=n.env,l=RED.subflow.exportSubflowTemplateEnv($("#node-input-env-container").editableList("items"));if(l&&l.length>0&&l.forEach((function(t){"cred"===t.type&&(n.credentials=n.credentials||{_:{}},n.credentials[t.name]=t.value,n.credentials["has_"+t.name]=""!==t.value,"__PWRD__"!==t.value&&(e.changed=!0),delete t.value)})),i=d,s=l,JSON.stringify(i)!==JSON.stringify(s)&&(n.env=l,e.changes.env=n.env,e.changed=!0),e.changed){var c=n.changed;n.changed=!0,r(n);var p=[];RED.nodes.eachNode((function(e){e.type=="subflow:"+n.id&&(p.push({id:e.id,changed:e.changed}),e._def.color=n.color,e.changed=!0,e.dirty=!0,u(e),r(e))})),RED.events.emit("subflows:change",n),RED.nodes.dirty(!0);var f={t:"edit",node:n,changes:e.changes,dirty:t,changed:c,subflow:{instances:p}};RED.history.push(f)}n.dirty=!0,RED.tray.close()}}],resize:function(e){$(".red-ui-tray-content").height(e.height-50);var t=$(".red-ui-tray-content form").height(e.height-50-40),o={width:t.width(),height:t.height()};a.forEach((function(e){e.resize&&e.resize.call(e,o)}))},open:function(e,r){var s=e.find(".red-ui-tray-footer"),d=$("<div/>",{class:"red-ui-tray-footer-left"}).appendTo(s),l=e.find(".red-ui-tray-body");l.parent().css("overflow","hidden"),$('<span style="margin-left: 10px"><i class="fa fa-info-circle"></i> <i id="red-ui-editor-subflow-user-count"></i></span>').appendTo(d),n&&RED.sidebar.info.refresh(n);m(l,["editor-tab-properties","editor-tab-subflow-module","editor-tab-description","editor-tab-appearance"],o,o._def,"node-input",i,(function(e){a=e,$("#subflow-input-name").val(o.name),RED.text.bidi.prepareInput($("#subflow-input-name")),l.i18n(),s.i18n(),t=!1,r()}))},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(n),RED.workspaces.refresh(),a.forEach((function(e){e.close&&e.close.call(e)})),e.pop(),n=null},show:function(){}};RED.tray.show(s)}},editGroup:function(o,i){if(!t){t=!0;var n=o;e.push(o),RED.view.state(RED.state.EDITING);var r=[],s={title:b(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={changes:{},changed:!1,outputMap:null},t=RED.nodes.dirty();if(y(n,e),r.forEach((function(t){t.apply&&t.apply.call(t,e)})),e.changed){var o=n.changed;n.changed=!0,RED.nodes.dirty(!0);var i={t:"edit",node:n,changes:e.changes,dirty:t,changed:o};RED.history.push(i),RED.events.emit("groups:change",n)}n.dirty=!0,RED.tray.close(),RED.view.redraw(!0)}}],resize:function(e){a.group=e.width,$(".red-ui-tray-content").height(e.height-50);var t=$(".red-ui-tray-content form").height(e.height-50-40),o={width:t.width(),height:t.height()};r.forEach((function(e){e.resize&&e.resize.call(e,o)}))},open:function(e,n){var a=e.find(".red-ui-tray-footer"),s=($("<div/>",{class:"red-ui-tray-footer-left"}).appendTo(a),e.find(".red-ui-tray-body"));s.parent().css("overflow","hidden");m(s,["editor-tab-properties","editor-tab-envProperties","editor-tab-description"],o,o._def,"node-input",i,(function(e){r=e,s.i18n(),t=!1,n()}))},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(n),r.forEach((function(e){e.close&&e.close.call(e)})),e.pop(),n=null},show:function(){}};a.hasOwnProperty("group")&&(s.width=a.group),RED.tray.show(s)}},editJavaScript:function(e){R("_js",e)},editExpression:function(e){R("_expression",e)},editJSON:function(e){R("_json",e)},editMarkdown:function(e){R("_markdown",e)},editText:function(e){"markdown"==e.mode?R("_markdown",e):R("_text",e)},editBuffer:function(e){R("_buffer",e)},buildEditForm:function(e,t,o,i,n){var a=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return a.html($("script[data-template-name='"+o+"']").html()),i=i||"node-red",a.find("[data-i18n]").each((function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var o=e[t];if(-1===o.indexOf(":")){var n="";if(0===o.indexOf("[")){var a=o.split("]");n=a[0]+"]",o=a[1]}e[t]=n+i+":"+o}}$(this).attr("data-i18n",e.join(";"))})),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-password" type="password"/></span>').prependTo(a),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-username"  type="text"/></span>').prependTo(a),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-user"  type="text"/></span>').prependTo(a),a.on("submit",(function(e){e.preventDefault()})),a.find("input").attr("autocomplete","off"),a},validateNode:r,updateNodeProperties:u,showIconPicker:function(){RED.editor.iconPicker.show.apply(null,arguments)},showTypeEditor:R,registerTypeEditor:function(e,t){o[e]=t},createEditor:function(e){return RED.editor.codeEditor.create(e)},get customEditTypes(){return o},registerEditPane:function(e,t,o){o&&(n[e]=o),i[e]=t}}}(),function(){function e(e,t,o,i){var n=$("<div>",{class:"red-ui-editor-node-label-form-row"});if(void 0===e)$("<span>").text(RED._("editor.noDefaultLabel")).appendTo(n),n.addClass("red-ui-editor-node-label-form-none");else{n.addClass("");var a="red-ui-editor-node-label-form-"+e+"-"+t;$("<label>",{for:a}).text(t+1+".").appendTo(n);var r=$("<input>",{type:"text",id:a,placeholder:i}).val(o).appendTo(n);$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-times"></i></button>').appendTo(n).on("click",(function(e){e.preventDefault(),r.val("")}))}return n}RED.editor.registerEditPane("editor-tab-appearance",(function(t){return{label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),iconClass:"fa fa-object-group",create:function(o){if(this.content=o,function(t,o){var i,n=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(t);if("subflow"===o.type){var a=$("<div/>",{class:"form-row"}).appendTo(n);$("<label/>",{for:"subflow-appearance-input-category","data-i18n":"editor:subflow.category"}).appendTo(a);var r=$("<select/>",{id:"subflow-appearance-input-category"}).css({width:"250px"}).appendTo(a);$("<input/>",{type:"text",id:"subflow-appearance-input-custom-category"}).css({display:"none","margin-left":"10px",width:"calc(100% - 250px)"}).appendTo(a);var s=RED.palette.getCategories();s.sort((function(e,t){return e.label.localeCompare(t.label)})),s.forEach((function(e){r.append($("<option/>").val(e.id).text(e.label))})),r.append($("<option/>").attr("disabled",!0).text("---")),r.append($("<option/>").val("_custom_").text(RED._("palette.addCategory"))),$("#subflow-appearance-input-category").on("change",(function(){"_custom_"===$(this).val()?($("#subflow-appearance-input-category").width(120),$("#subflow-appearance-input-custom-category").show()):($("#subflow-appearance-input-category").width(250),$("#subflow-appearance-input-custom-category").hide())})),$("#subflow-appearance-input-category").val(o.category||"subflows");o.id;$("#red-ui-editor-subflow-user-count").text(RED._("subflow.subflowInstances",{count:o.instances.length})).show()}$('<div class="form-row"><label for="node-input-show-label-btn" data-i18n="editor.label"></label><span style="margin-right: 2px;"/><input type="checkbox" id="node-input-show-label"/></div>').appendTo(n),$("#node-input-show-label").toggleButton({enabledLabel:RED._("editor.show"),disabledLabel:RED._("editor.hide")}),o.hasOwnProperty("l")||(o.l=!o._def.hasOwnProperty("showLabel")||o._def.showLabel);if($("#node-input-show-label").prop("checked",o.l).trigger("change"),"subflow"===o.type){var d=o.color?o.color:"#DDAA99",l=$("<div/>",{class:"form-row"}).appendTo(n);$("<label/>").text(RED._("editor.color")).appendTo(l);var c=["#DDAA99","#3FADB5","#87A980","#A6BBCF","#AAAA66","#C0C0C0","#C0DEED","#C7E9C0","#D7D7A0","#D8BFD8","#DAC4B4","#DEB887","#DEBD5C","#E2D96E","#E6E0F8","#E7E7AE","#E9967A","#F3B567","#FDD0A2","#FDF0C2","#FFAAAA","#FFCC66","#FFF0F0","#FFFFFF"];RED.editor.colorPicker.create({id:"red-ui-editor-node-color",value:d,defaultValue:"#DDAA99",palette:c,sortPalette:function(e,t){return e.l-t.l}}).appendTo(l),$("#red-ui-editor-node-color").on("change",(function(e){var t=$(this).val();f.css("backgroundColor",t);var o=RED.utils.getDarkerColor(t);o!==t&&f.css("border-color",o)}))}if(!o._def.defaults||!o._def.defaults.hasOwnProperty("icon")){var u=$('<div class="form-row"></div>').appendTo(n);$('<label data-i18n="editor.settingIcon">').appendTo(u);var p=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(u);$('<i class="fa fa-caret-down"></i>').appendTo(p);var f=$("<div>",{class:"red-ui-search-result-node"}).appendTo(p),h=RED.utils.getNodeColor(o.type,o._def),g=RED.utils.getNodeIcon(o._def,o);f.css("backgroundColor",h);var v=RED.utils.getDarkerColor(h);v!==h&&f.css("border-color",v);var m=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(f);RED.utils.createIconElement(g,m,!0),p.on("click",(function(e){var t;e.preventDefault();var i=$("#red-ui-editor-node-icon").val()||"";t=i?RED.utils.separateIconPath(i):RED.utils.getDefaultNodeIcon(o._def,o);var n=RED.utils.getNodeColor(o.type,o._def);"subflow"===o.type&&(n=$("#red-ui-editor-node-color").val()),RED.editor.iconPicker.show(p,n,t,!1,(function(e){$("#red-ui-editor-node-icon").val(e||"");var t=RED.utils.getNodeIcon(o._def,{type:o.type,icon:e});RED.utils.createIconElement(t,m,!0)}))})),RED.popover.tooltip(p,(function(){return $("#red-ui-editor-node-icon").val()||RED._("editor.default")})),$('<input type="hidden" id="red-ui-editor-node-icon">').val(o.icon).appendTo(u)}$('<div class="form-row"><span data-i18n="editor.portLabels"></span></div>').appendTo(n);var b=o.inputs||o._def.inputs||0,y=o.outputs||o._def.outputs||0;"subflow"===o.type&&(b=o.in.length,y=o.out.length);var w=o.inputLabels||[],E=o.outputLabels||[],D=o._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),R=o._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelInputs"></span><div id="red-ui-editor-node-label-form-inputs"></div></div>').appendTo(n);var x=$("#red-ui-editor-node-label-form-inputs");if(b>0)for(i=0;i<b;i++)e("input",i,w[i],D).appendTo(x);else e().appendTo(x);$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelOutputs"></span><div id="red-ui-editor-node-label-form-outputs"></div></div>').appendTo(n);var _=$("#red-ui-editor-node-label-form-outputs");if(y>0)for(i=0;i<y;i++)e("output",i,E[i],R).appendTo(_);else e().appendTo(_)}(this.content,t),"subflow"===t.type)this.defaultIcon="node-red/subflow.svg";else{var i=RED.utils.getDefaultNodeIcon(t._def,t);this.defaultIcon=i.module+"/"+i.file,t.icon&&t.icon!==this.defaultIcon?this.isDefaultIcon=!1:this.isDefaultIcon=!0}},resize:function(e){},close:function(){},show:function(){!function(t,o){var i,n=o._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),a=o._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),r=$("#red-ui-editor-node-label-form-inputs"),s=$("#red-ui-editor-node-label-form-outputs"),d=$("#node-input-inputs").val();void 0===d?i="subflow"===o.type?o.in.length:o.inputs||o._def.inputs||0:(i=Math.min(1,Math.max(0,parseInt(d))),isNaN(i)&&(i=0));var l,c,u=r.children(),p=u.length;1===p&&$(u[0]).hasClass("red-ui-editor-node-label-form-none")&&p--;if(p<i)for(0===p&&$(u[0]).remove(),c=p;c<i;c++)e("input",c,"",n).appendTo(r);else if(p>i){for(c=i;c<p;c++)$(u[c]).remove();0===i&&e().appendTo(r)}var f=$("#node-input-outputs").val();if(void 0===f)"subflow"===o.type?l=o.out.length:i=o.outputs||o._def.outputs||0;else if(isNaN(f)){var h=JSON.parse(f),g=Object.keys(h);u=s.children(),1===(p=u.length)&&$(u[0]).hasClass("red-ui-editor-node-label-form-none")&&p--,l=0;var v=[];g.forEach((function(t){var o=$("#red-ui-editor-node-label-form-output-"+t).parent();0===o.length&&-1!==h[t]?(0===p&&($(u[0]).remove(),p=-1),o=e("output",t,"",a)):o.detach(),-1!==h[t]&&(l++,v.push({i:parseInt(h[t]),r:o}))})),v.sort((function(e,t){return e.i-t.i})),v.forEach((function(e,t){e.r.find("label").text(t+1+"."),e.r.appendTo(s)})),0===v.length&&e("output",c,"").appendTo(s)}else l=Math.max(0,parseInt(f));u=s.children(),1===(p=u.length)&&$(u[0]).hasClass("red-ui-editor-node-label-form-none")&&p--;if(p<l)for(0===p&&$(u[0]).remove(),c=p;c<l;c++)e("output",c,"").appendTo(s);else if(p>l){for(c=l;c<p;c++)$(u[c]).remove();0===l&&e().appendTo(s)}}(this.content,t)},apply:function(e){if(function(e,t,o){var i=$("#red-ui-editor-node-label-form-inputs").children().find("input"),n=$("#red-ui-editor-node-label-form-outputs").children().find("input"),a=!1,r=!1,s=i.map((function(){var e=$(this).val();return a=a||""!==e,e})).toArray().slice(0,e.inputs);(void 0===e.inputLabels&&a||void 0!==e.inputLabels&&JSON.stringify(s)!==JSON.stringify(e.inputLabels))&&(t.inputLabels=e.inputLabels,e.inputLabels=s,r=!0);a=!1,s=new Array(e.outputs),n.each((function(){var t=$(this).attr("id").substring("red-ui-editor-node-label-form-output-".length);if(!o||!o.hasOwnProperty(t)||-1!==(t=parseInt(o[t]))){var i=$(this).val();a=a||""!==i,"subflow"!==e.type||e.outputLabels&&e.outputLabels[t]===i||(e.out[t].dirty=!0),s[t]=i}})),(void 0===e.outputLabels&&a||void 0!==e.outputLabels&&JSON.stringify(s)!==JSON.stringify(e.outputLabels))&&(t.outputLabels=e.outputLabels,e.outputLabels=s,r=!0,"subflow"===e.type&&RED.view.redraw());return r}(t,e.changes,e.outputMap)&&(e.changed=!0),!t._def.defaults||!t._def.defaults.hasOwnProperty("icon")){var o=$("#red-ui-editor-node-icon").val()||"";if(this.isDefaultIcon)if(""!==o&&o!==this.defaultIcon)e.changes.icon=t.icon,t.icon=o,e.changed=!0;else{var i=RED.utils.getDefaultNodeIcon(t._def,t),n=i.module+"/"+i.file;this.defaultIcon!==n&&(e.changes.icon=t.icon,t.icon=n,e.changed=!0)}else(t.icon&&o!==t.icon||!t.icon&&""!==o)&&(e.changes.icon=t.icon,t.icon=o,e.changed=!0)}if("subflow"===t.type){var a=$("#subflow-appearance-input-category").val().trim();"_custom_"===a&&""===(a=$("#subflow-appearance-input-custom-category").val().trim())&&(a=t.category),"subflows"===a&&(a=""),a!=t.category&&(e.changes.category=t.category,t.category=a,e.changed=!0);var r=t.color,s=$("#red-ui-editor-node-color").val();if(r!==s)if(e.changes.color=t.color,t.color=s,e.changed=!0,RED.utils.clearNodeColorCache(),"subflow"===t.type)RED.nodes.getType("subflow:"+t.id).color=s}var d=!t._def.hasOwnProperty("showLabel")||t._def.showLabel;$("#node-input-show-label").prop("checked")?d?(t.hasOwnProperty("l")&&!t.l&&(e.changes.l=t.l,e.changed=!0),delete t.l):(t.l||(e.changes.l=t.l,e.changed=!0),t.l=!0):d?(!1!==t.l&&(e.changes.l=t.l,e.changed=!0),t.l=!1):(t.hasOwnProperty("l")&&t.l&&(e.changes.l=t.l,e.changed=!0),delete t.l)}}}))}(),RED.editor.registerEditPane("editor-tab-description",(function(e){return{label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),iconClass:"fa fa-file-text-o",create:function(t){this.editor=function(e,t){var o=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),i=($("<div></div>").appendTo(o),$('<div class="form-row node-text-editor-row" style="position:relative; padding-top: 4px; height: 100%"></div>').appendTo(o)),n="node-info-input-info-editor-"+Math.floor(1e3*Math.random());$('<div style="height: 100%" class="node-text-editor" id="'+n+'" ></div>').appendTo(i);var a=RED.editor.createEditor({id:n,mode:"ace/mode/markdown",stateId:RED.editor.generateViewStateId("node",t,"nodeinfo"),value:t.info||""});return t.infoEditor=a,a}(t,e)},resize:function(e){this.editor.resize()},close:function(){this.editor.destroy(),this.editor=null},show:function(){this.editor.focus()},apply:function(t){var o=e.info,i=this.editor.getValue();o?""===i.trim()?(t.changed=!0,t.changes.info=o,delete e.info):i!==o&&(t.changed=!0,t.changes.info=o,e.info=i):""!==i.trim()&&(t.changed=!0,t.changes.info=void 0,e.info=i)}}})),RED.editor.registerEditPane("editor-tab-envProperties",(function(e){return{label:RED._("editor-tab.envProperties"),name:RED._("editor-tab.envProperties"),iconClass:"fa fa-list",create:function(t){var o=$('<form class="dialog-form form-horizontal"></form>').appendTo(t),i=$('<div class="form-row node-input-env-container-row"></div>').appendTo(o);this.list=$("<ol></ol>").appendTo(i),RED.editor.envVarList.create(this.list,e)},resize:function(e){this.list.editableList("height",e.height)},close:function(){},apply:function(t){var o,i,n=e.env,a=[];/^subflow:/.test(e.type)&&(a=RED.subflow.exportSubflowInstanceEnv(e)),this.list.editableList("items").each((function(e,t){var o,i=t.data("data");i.nameField&&i.valueField&&""!==(o={name:i.nameField.val(),value:i.valueField.typedInput("value"),type:i.valueField.typedInput("type")}).name.trim()&&a.push(o)})),a&&a.length>0&&a.forEach((function(o){"cred"===o.type&&(e.credentials=e.credentials||{_:{}},e.credentials[o.name]=o.value,e.credentials["has_"+o.name]=""!==o.value,"__PWRD__"!==o.value&&(t.changed=!0),delete o.value)})),n||0!==a.length?(o=n,i=a,JSON.stringify(o)!==JSON.stringify(i)&&(t.changes.env=e.env,0===a.length?delete e.env:e.env=a,t.changed=!0)):delete e.env}}})),RED.editor.registerEditPane("editor-tab-flow-properties",(function(e){return{label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),iconClass:"fa fa-cog",create:function(t){var o=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>').appendTo(o),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="min-height:150px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(o),this.tabflowEditor=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<input type="text" style="display: none;" />').prependTo(o),o.on("submit",(function(e){e.preventDefault()})),$("#node-input-name").val(e.label),RED.text.bidi.prepareInput($("#node-input-name")),this.tabflowEditor.getSession().setValue(e.info||"",-1)},resize:function(e){$("#node-input-info").css("height",e.height-70+"px"),this.tabflowEditor.resize()},close:function(){this.tabflowEditor.destroy()},apply:function(t){var o=$("#node-input-name").val();e.label!=o&&(t.changes.label=e.label,t.changed=!0,e.label=o);var i=this.tabflowEditor.getValue();e.info!==i&&(t.changes.info=e.info,t.changed=!0,e.info=i),$("#red-ui-tab-"+e.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!e.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!e.disabled)}}})),function(){function e(e,t){try{return e==t||JSON.stringify(e)===JSON.stringify(t)}catch(e){return!1}}RED.editor.registerEditPane("editor-tab-properties",(function(t){return{label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),iconClass:"fa fa-cog",create:function(e){var o,i=t.type;"subflow"===t.type?i="subflow-template":"subflow:"==t.type.substring(0,8)&&(i="subflow"),o="node-red"===t._def.set.module?"node-red":t._def.set.id;var n="dialog-form";this.inputClass="node-input","config"===t._def.category&&"group"!==i&&(this.inputClass="node-config-input",n="node-config-dialog-edit-form"),RED.editor.buildEditForm(e,n,i,o,t)},resize:function(e){if(t&&t._def.oneditresize)try{t._def.oneditresize.call(t,e)}catch(e){console.log("oneditresize",t.id,t.type,e.toString())}},close:function(){},apply:function(o){var i,n;if(t._def.defaults)for(n in t._def.defaults)if(t._def.defaults.hasOwnProperty(n)){var a=$("#"+this.inputClass+"-"+n);if("checkbox"===a.attr("type")?i=a.prop("checked"):"select"===a.prop("nodeName")&&"multiple"===a.attr("multiple")?null==(i=a.val())&&(i=[]):i="format"in t._def.defaults[n]&&""!==t._def.defaults[n].format&&"DIV"===a[0].nodeName?a.text():a.val(),null!=i){if("outputs"===n){if(""===i.trim())continue;if(isNaN(i)){o.outputMap=JSON.parse(i);var r=0,s=!1;Object.keys(o.outputMap).forEach((function(e){isNaN(e)?(r++,delete o.outputMap[e]):(o.outputMap[e]=o.outputMap[e]+"","-1"!==o.outputMap[e]?(r++,o.outputMap[e]!==e?s=!0:delete o.outputMap[e]):s=!0)})),i=r,s&&(o.changed=!0)}else i=parseInt(i)}if(t._def.defaults[n].type&&"_ADD_"==i&&(i=""),!e(t[n],i)){if(t._def.defaults[n].type){var d=RED.nodes.node(t[n]);if(d){var l=d.users;l.splice(l.indexOf(t),1),RED.events.emit("nodes:change",d)}(d=RED.nodes.node(i))&&(d.users.push(t),RED.events.emit("nodes:change",d))}o.changes[n]=t[n],t[n]=i,o.changed=!0}}}if(t._def.credentials){var c=t._def.credentials,u=function(e,t,o){var i=!1;e.credentials?e.credentials._||(e.credentials._={}):e.credentials={_:{}};for(var n in t)if(t.hasOwnProperty(n)){var a=$("#"+o+"-"+n);if(a.length>0){var r=a.val();if("password"==t[n].type){if(e.credentials["has_"+n]=""!==r,"__PWRD__"==r)continue;i=!0}e.credentials[n]=r,r!=e.credentials._[n]&&(i=!0)}}return i}(t,c,this.inputClass);o.changed=o.changed||u}}}}))}(),function(){var e='<form class="dialog-form form-horizontal" autocomplete="off"><div class="form-row"><label for="subflow-input-module-module" data-i18n="[append]editor:subflow.module"><i class="fa fa-cube"></i> </label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-module" data-i18n="[placeholder]common.label.name"></div><div class="form-row"><label for="subflow-input-module-type" data-i18n="[append]editor:subflow.type"> </label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-type"></div><div class="form-row"><label for="subflow-input-module-version" data-i18n="[append]editor:subflow.version"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-version" data-i18n="[placeholder]editor:subflow.versionPlaceholder"></div><div class="form-row"><label for="subflow-input-module-desc" data-i18n="[append]editor:subflow.desc"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-desc"></div><div class="form-row"><label for="subflow-input-module-license" data-i18n="[append]editor:subflow.license"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-license"></div><div class="form-row"><label for="subflow-input-module-author" data-i18n="[append]editor:subflow.author"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-author" data-i18n="[placeholder]editor:subflow.authorPlaceholder"></div><div class="form-row"><label for="subflow-input-module-keywords" data-i18n="[append]editor:subflow.keys"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-keywords" data-i18n="[placeholder]editor:subflow.keysPlaceholder"></div></form>';function t(e,t){var o;e.on("change keyup paste",(function(){o||(o=setTimeout((function(){var i=t(e.val());e.toggleClass("input-error",!!i),o=null})))}))}RED.editor.registerEditPane("editor-tab-subflow-module",(function(o){return{label:RED._("editor-tab.module"),name:RED._("editor-tab.module"),iconClass:"fa fa-cube",create:function(i){!function(o,i){$(e).appendTo(o);var n=i.meta||{};["module","type","version","author","desc","keywords","license"].forEach((function(e){$("#subflow-input-module-"+e).val(n[e]||"")})),$("#subflow-input-module-type").attr("placeholder",i.id),t($("#subflow-input-module-module"),(function(e){var t=(e=e.trim()).length<215;if(t=(t=t&&!/^[._]/.test(e))&&!/[A-Z]/.test(e),e!==encodeURIComponent(e)){var o=/^@([^\/]+)\/([^\/]+)$/.exec(e);t=!!o&&(t&&o[1]===encodeURIComponent(o[1])&&o[2]===encodeURIComponent(o[2]))}return t?"":"Invalid module name"})),t($("#subflow-input-module-version"),(function(e){return""===(e=e.trim())||/^(\d|[1-9]\d*)\.(\d|[1-9]\d*)\.(\d|[1-9]\d*)(-(0|[1-9A-Za-z-][0-9A-Za-z-]*|[0-9]*[A-Za-z-][0-9A-Za-z-]*)(\.(0|[1-9A-Za-z-][0-9A-Za-z-]*|[0-9]*[A-Za-z-][0-9A-Za-z-]*))*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$/.test(e)?"":"Invalid version number"}));var a=["none","Apache-2.0","BSD-3-Clause","BSD-2-Clause","GPL-2.0","GPL-3.0","MIT","MPL-2.0","CDDL-1.0","EPL-2.0"],r={types:a.map((function(e){return{value:e,label:"none"===e?RED._("editor:subflow.licenseNone"):e,hasValue:!1}}))};r.types.push({value:"_custom_",label:RED._("editor:subflow.licenseOther"),icon:"red/images/typedInput/az.svg"}),n.license?a.indexOf(n.license)>-1?r.default=n.license:r.default="_custom_":r.default="none";$("#subflow-input-module-license").typedInput(r)}(i,o)},resize:function(e){},close:function(){},apply:function(e){var t,i,n=function(e){var t,o={};["module","type","version","author","desc","keywords"].forEach((function(e){(t=$("#subflow-input-module-"+e).val().trim())&&(o[e]=t)}));var i=$("#subflow-input-module-license").typedInput("type");"_custom_"===i?(t=$("#subflow-input-module-license").val())&&(o.license=t):"none"!==i&&(o.license=i);return o}();t=o.meta,i=n,JSON.stringify(t)!==JSON.stringify(i)&&(e.changes.meta=o.meta,o.meta=n,e.changed=!0)}}}))}(),function(){var e={show:function(e){var t=e.value,o=e.cancel,i=e.complete,n="_buffer";0===$("script[data-template-name='_buffer']").length&&$('<script type="text/x-red" data-template-name="_buffer"><div id="red-ui-editor-type-buffer-panels"><div id="red-ui-editor-type-buffer-panel-str" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-buffer-type red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span id="red-ui-editor-type-buffer-type-string" data-i18n="bufferEditor.modeString"></span><span id="red-ui-editor-type-buffer-type-array" data-i18n="bufferEditor.modeArray"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-buffer-str"></div></div></div><div id="red-ui-editor-type-buffer-panel-bin" class="red-ui-panel"><div class="form-row node-text-editor-row" style="margin-top: 10px; margin-bottom:0;"><div class="node-text-editor" id="red-ui-editor-type-buffer-bin"></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var a,r,s=[],d={title:e.title,focusElement:e.focusElement,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){o&&o(),RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){s.saveView(),i&&i(JSON.stringify(a),null,s),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();r&&r.resize(t)},open:function(o){var i,d=RED.editor.buildEditForm(o.find(".red-ui-tray-body"),"dialog-form",n,"editor");s=RED.editor.createEditor({id:"red-ui-editor-type-buffer-str",value:t||"",stateId:RED.editor.generateViewStateId("buffer",e,""),focus:!0,mode:"ace/mode/text"}),bufferBinEditor=RED.editor.createEditor({id:"red-ui-editor-type-buffer-bin",value:"",stateId:!1,focus:!1,mode:"ace/mode/text",readOnly:!0});var l=function(e){var t=!0,o="string"==typeof e,i=[];a=o?function(e){var t=[],o=0,i=e.length;for(o=0;o<i;o++){var n=e.charCodeAt(o);n<128?t.push(n):n<2048?(t.push(192|n>>6),t.push(128|63&n)):n<55296||n>=57344?(t.push(224|n>>12),t.push(128|n>>6&63),t.push(128|63&n)):(o++,n=65536+((1023&n)<<10|1023&e.charAt(o)),t.push(240|n>>18),t.push(128|n>>12&63),t.push(128|n>>6&63),t.push(128|63&n))}return t}(e):e;var n=0,r=a.length;for(n=0;n<r;n++){var s=parseInt(a[n]);if(!o&&(isNaN(s)||s<0||s>255)){t=!1;break}n>0&&(n%8==0?n%16==0?i.push("\n"):i.push("  "):i.push(" ")),i.push((s<16?"0":"")+s.toString(16).toUpperCase())}return t&&($("#red-ui-editor-type-buffer-type-string").toggle(o),$("#red-ui-editor-type-buffer-type-array").toggle(!o),bufferBinEditor.setValue(i.join(""),1)),t},c=function(){var e=s.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var o=JSON.parse(e);t=l(o)}catch(e){t=!1}}t||l(e)};s.getSession().on("change",(function(){clearTimeout(i),i=setTimeout(c,200)})),c(),d.i18n(),r=RED.panels.create({id:"red-ui-editor-type-buffer-panels",resize:function(e,t){var o=$("#red-ui-editor-type-buffer-panel-str");e-=$(o.children()[0]).outerHeight(!0);var i=$(o.children()[1]);e-=parseInt(i.css("marginTop"))+parseInt(i.css("marginBottom")),$("#red-ui-editor-type-buffer-str").css("height",e-5+"px"),s.resize();var n=$("#red-ui-editor-type-buffer-panel-bin");i=$(n.children()[0]),t-=parseInt(i.css("marginTop"))+parseInt(i.css("marginBottom")),$("#red-ui-editor-type-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".red-ui-editor-type-buffer-type").on("click",(function(e){e.preventDefault(),RED.sidebar.help.set(RED._("bufferEditor.modeDesc"))}))},close:function(){e.onclose&&e.onclose(),s.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(d)}};RED.editor.registerTypeEditor("_buffer",e)}(),RED.editor.codeEditor=function(){const e="monaco",t=e,o={lib:t,options:{}};var i=null,n=!1;return{init:function(){var t=RED.editor.codeEditor.settings.lib===e?e:"ace";try{var o=RED.utils.getBrowserInfo();(i=RED.editor.codeEditor[t])&&(t!==e||!o.ie&&window.monaco)||(i=RED.editor.codeEditor.monaco),n=i.init()}catch(e){i=null,console.warn("Problem initialising '"+t+"' code editor",e)}n||(i=RED.editor.codeEditor.monaco,n=i.init())},get settings(){return RED.settings.get("codeEditor")||o},get editor(){return i},create:function(t){return t||(console.warn("createEditor() options are missing"),t={}),this.editor.type===e?(t.element||t.id||(t.id="node-backwards-compatability-dummy-editor"),t.element=t.element||$("#"+t.id)[0],t.element||(console.warn("createEditor() options.element or options.id is not valid",t),$("#dialog-form").append('<div id="'+t.id+'" style="display: none;" />')),this.editor.create(t)):this.editor.create(t)}}}(),RED.editor.colorPicker=RED.colorPicker={create:function(e){var t=e.value,o=e.id,i=e.palette||[],n=e.cellWidth||30,a=e.cellHeight||30,r=e.cellMargin||2,s=e.cellPerRow||6,d=$("<div>",{style:"display:inline-block"}),l=$("<input/>",{id:o,type:"hidden",value:t}).appendTo(d),c=$("<input/>",{id:o+"-opacity",type:"hidden",value:e.hasOwnProperty("opacity")?e.opacity:"1"}).appendTo(d),u=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(d);$('<i class="fa fa-caret-down"></i>').appendTo(u);var p=$("<div>",{class:"red-ui-search-result-node"}).appendTo(u);$("<div>",{class:"red-ui-color-picker-cell-none"}).appendTo(p);var f=$("<div>",{class:"red-ui-color-picker-swatch"}).appendTo(p),h=function(t){if("none"===t)f.addClass("red-ui-color-picker-cell-none").css({"background-color":"",opacity:1}),p.css({"border-color":""});else{var o=parseFloat(c.val());f.removeClass("red-ui-color-picker-cell-none").css({"background-color":t,opacity:o});var i=RED.utils.getDarkerColor(t);"#"===i[0]?i+=Math.round(255*Math.floor(100*o)/100).toString(16):i="",p.css({"border-color":i})}e.hasOwnProperty("opacity")&&$(".red-ui-color-picker-opacity-slider-overlay").css({"background-image":"linear-gradient(90deg, transparent 0%, "+t+" 100%)"})};return u.on("click",(function(t){var o=i.length,d=$("<div/>",{class:"red-ui-color-picker"}).css({width:(n+r+r)*s+"px",height:Math.ceil(o/s)*(a+r+r)+"+px"}),p=0,f=null;f=$("<div/>").appendTo(d);var g=$("<input>",{type:"text",value:l.val()}).appendTo(f),v=g;if(g.on("change",(function(t){var o=g.val();e.defaultValue&&!o.match(/^([a-z]+|#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3})$/)&&(o=e.defaultValue),l.val(o).trigger("change"),h(o)})),e.none&&(f=$("<div/>").appendTo(d),$("<button/>",{class:"red-ui-color-picker-cell red-ui-color-picker-cell-none"}).css({width:n+"px",height:a+"px",margin:r+"px"}).appendTo(f).on("click",(function(e){e.preventDefault(),g.val("none"),g.trigger("change")}))),i.forEach((function(e){p%s==0&&(f=$("<div/>").appendTo(d)),$("<button/>",{class:"red-ui-color-picker-cell"}).css({width:n+"px",height:a+"px",margin:r+"px",backgroundColor:e,"border-color":RED.utils.getDarkerColor(e)}).appendTo(f).on("click",(function(t){t.preventDefault(),g.val(e),g.trigger("change")})),p++})),(e.none||e.hasOwnProperty("opacity"))&&(f=$("<div/>").appendTo(d),e.hasOwnProperty("opacity"))){var m=$("<div>",{class:"red-ui-color-picker-opacity-slider"}).appendTo(f);m.on("mousedown",(function(e){if(e.target!==b[0]){var t=e.offsetX/m.width();b.css({left:t*(m.width()-b.outerWidth())+"px"}),t=Math.floor(100*t),c.val(t/100),y.text(t+"%"),h(l.val())}})),$("<div>",{class:"red-ui-color-picker-opacity-slider-overlay"}).appendTo(m);var b=$("<div>",{class:"red-ui-color-picker-opacity-slider-handle red-ui-button red-ui-button-small"}).appendTo(m).draggable({containment:"parent",axis:"x",drag:function(e,t){var o=Math.max(0,t.position.left/($(this).parent().width()-$(this).outerWidth()));99===(o=Math.floor(100*o))&&(o=100),c.val(o/100),y.text(o+"%"),h(l.val())}}),y=$("<small></small>").appendTo(f);setTimeout((function(){b.css({left:parseFloat(c.val())*(m.width()-b.outerWidth())+"px"}),y.text(Math.floor(100*c.val())+"%")}),50)}var w=RED.popover.panel(d);setTimeout((function(){h(l.val())}),50),w.show({target:u,onclose:function(){u.focus()}}),v&&v.focus()})),setTimeout((function(){h(l.val())}),50),d}},RED.editor.envVarList=function(){var e="en-US",t=["str","num","bool","json","bin","env"],o=["str","num","bool","json","bin","env","cred"];function i(e,t,o){if(e){if(e[o])return e[o];if(o){var i=o.substring(0,2);if(e[i])return e[i]}}return t}return{create:function(n,a){var r="subflow"===a.type;n.css({"min-height":"150px","min-width":"450px"}).editableList({header:r?$('<div><div><div></div><div data-i18n="common.label.name"></div><div data-i18n="editor-tab.defaultValue"></div><div></div></div></div>'):void 0,addItem:function(s,d,l){r&&s.addClass("red-ui-editor-subflow-env-editable");var c=$("<div/>").appendTo(s),u=null,p=null;u=$("<input/>",{class:"node-input-env-name",type:"text",placeholder:RED._("common.label.name")}).attr("autocomplete","disable").appendTo(c).val(l.name),p=$("<input/>",{style:"width:100%",class:"node-input-env-value",type:"text"}).attr("autocomplete","disable").appendTo(c);var f=l.ui&&l.ui.opts&&l.ui.opts.types;f||(f=r?t:o),p.typedInput({default:"str",types:f}),p.typedInput("type",l.type),"cred"===l.type?l.value?p.typedInput("value",l.value):a.credentials&&a.credentials[l.name]?p.typedInput("value",a.credentials[l.name]):a.credentials&&a.credentials["has_"+l.name]?p.typedInput("value","__PWRD__"):p.typedInput("value",""):p.typedInput("value",l.value),l.nameField=u,l.valueField=p;var h=$("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(c);$("<i/>",{class:"fa "+(l.parent?"fa-reply":"fa-remove")}).appendTo(h);var g=RED.popover.tooltip(h,RED._("subflow.env.remove"));if(h.on("click",(function(e){e.preventDefault(),g.close(),s.parent().addClass("red-ui-editableList-item-deleting"),s.fadeOut(300,(function(){n.editableList("removeItem",l)}))})),r){"cred"===l.type?(l.ui=l.ui||{icon:"",type:"cred"},l.ui.type="cred"):l.ui=l.ui||{icon:"",type:"input",opts:{types:t}},l.ui.label=l.ui.label||{},l.ui.type=l.ui.type||"input","cred"===l.ui.type&&l.ui.opts&&l.ui.opts.types&&(l.ui.type="input");var v=$("<div/>").appendTo(s).hide();$('<a href="#"><i class="fa fa-angle-right"></a>').prependTo(c).on("click",(function(e){e.preventDefault(),$(this).hasClass("expanded")?(v.slideUp(),$(this).removeClass("expanded")):(v.slideDown(),$(this).addClass("expanded"))})),function(o,n,a,r){o.addClass("red-ui-editor-subflow-env-ui-row");var s=$("<div></div>").appendTo(o);$("<div></div>").appendTo(s),$("<div>").text(RED._("editor.icon")).appendTo(s),$("<div>").text(RED._("editor.label")).appendTo(s),$("<div>").text(RED._("editor.inputType")).appendTo(s);var d=$("<div></div>").appendTo(o);$('<div><i class="red-ui-editableList-item-handle fa fa-bars"></i></div>').appendTo(d);var l={input:{types:t},select:{opts:[]},spinner:{},cred:{}};n.opts?l[n.type]=n.opts:n.opts=l[n.type];var c=$("<div></div>").appendTo(d),u=$('<a href="#"></a>').appendTo(c);if(u.on("click",(function(e){e.preventDefault();var t=n.icon||"",o=t?RED.utils.separateIconPath(t):{};RED.editor.iconPicker.show(u,null,o,!0,(function(e){u.empty();var t=e||"",o=RED.utils.separateIconPath(t);o&&$('<i class="fa"></i>').addClass(o.file).appendTo(u),n.icon=t}))})),n.icon){var p=RED.utils.separateIconPath(n.icon);$('<i class="fa '+p.file+'"></i>').appendTo(u)}var f=$("<div></div>").appendTo(d),h=n.label&&n.label[e]||"",g=$('<input type="text">').val(h).appendTo(f);n.labelField=g,g.on("change",(function(t){n.label=n.label||{};var o=$(this).val().trim();""===o?delete n.label[e]:n.label[e]=o}));var v=$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(f);RED.popover.tooltip(v,(function(){var t=Object.keys(n.label),o=$("<div>");return-1===t.indexOf(e)&&(t.push(e),t.sort()),t.forEach((function(t){var i=$("<div>").appendTo(o);$("<span>").css({display:"inline-block",width:"120px"}).text(RED._("languages."+t)+(t===e?"*":"")).appendTo(i),$("<span>").text(n.label[t]||"").appendTo(i)})),o})),a.on("change",(function(e){g.attr("placeholder",$(this).val())}));var m,b,y=$("<div></div>").appendTo(d),w=$('<input type="text">').css("width","100%").appendTo(y);"input"===n.type&&w.val(n.opts.types.join(","));w.typedInput({types:[{value:"input",label:RED._("editor.inputs.input"),icon:"fa fa-i-cursor",showLabel:!1,multiple:!0,options:[{value:"str",label:RED._("editor.types.str"),icon:"red/images/typedInput/az.svg"},{value:"num",label:RED._("editor.types.num"),icon:"red/images/typedInput/09.svg"},{value:"bool",label:RED._("editor.types.bool"),icon:"red/images/typedInput/bool.svg"},{value:"json",label:RED._("editor.types.json"),icon:"red/images/typedInput/json.svg"},{value:"bin",label:RED._("editor.types.bin"),icon:"red/images/typedInput/bin.svg"},{value:"env",label:RED._("editor.types.env"),icon:"red/images/typedInput/env.svg"},{value:"cred",label:RED._("editor.types.cred"),icon:"fa fa-lock"}],default:t,valueLabel:function(e,t){e.css("padding",0);var o=$('<div class="red-ui-editor-subflow-env-input-type"></div>').appendTo(e),i=$('<div class="placeholder-input">').appendTo(o);$('<span><i class="fa fa-i-cursor"></i></span>').appendTo(i),t.length?t.forEach((function(e){if(/^fa /.test(e.icon)){var t=$("<span>",{style:"max-width:14px; padding: 0 3px; margin-top:-4px; margin-left: 1px"}).appendTo(i);$("<i>",{class:e.icon}).appendTo(t)}else $("<img>",{src:e.icon,style:"max-width:14px; padding: 0 3px; margin-top:-4px; margin-left: 1px"}).appendTo(i)})):$('<span class="red-ui-editor-subflow-env-input-type-placeholder"></span>').text(RED._("editor.selectType")).appendTo(i)}},{value:"cred",label:RED._("typedInput.type.cred"),icon:"fa fa-lock",showLabel:!1,valueLabel:function(e,t){e.css("padding",0);var o=$('<div class="red-ui-editor-subflow-env-input-type">').css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"}).appendTo(e);$('<div class="placeholder-input">').html("&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;").appendTo(o)}},{value:"select",label:RED._("editor.inputs.select"),icon:"fa fa-tasks",showLabel:!1,valueLabel:function(t,o){t.css("padding","0"),b=$("<select></select>").appendTo(t),n.opts&&Array.isArray(n.opts.opts)&&n.opts.opts.forEach((function(t){var o=i(t.l,t.l["en-US"]||t.v,e);$("<option>").val(t.v).text(o).appendTo(b)})),b.on("change",(function(e){var t=b.val();r.typedInput("value",t)})),b.val(r.typedInput("value"))},expand:{icon:"fa-caret-down",minWidth:400,content:function(t){var o=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(t),a=$("<ol>").appendTo(o).editableList({header:$("<div><div>"+RED._("editor.select.label")+"</div><div>"+RED._("editor.select.value")+"</div></div>"),addItem:function(t,o,n){var r=$("<div>").appendTo(t),s=i(n.l,"",e);n.label=$('<input type="text">').val(s).appendTo(r),n.label.on("keydown",(function(e){13===e.keyCode&&(n.input.focus(),e.preventDefault())}));var d=$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(r);RED.popover.tooltip(d,(function(){return e})),n.input=$('<input type="text">').val(n.v).appendTo(t),n.input.on("keydown",(function(e){if(13===e.keyCode){var t=a.editableList("indexOf",n);if(t+1===a.editableList("length")){var o={};a.editableList("addItem",o),setTimeout((function(){o.label&&o.label.focus()}),100)}else{var i=a.editableList("getItemAt",t+1);i.label&&i.label.focus()}e.preventDefault()}}))},sortable:!0,removable:!0,height:160});return n.opts.opts.length>0?n.opts.opts.forEach((function(e){a.editableList("addItem",$.extend(!0,{},e))})):a.editableList("addItem",{}),{onclose:function(){var t=a.editableList("items"),o=[];t.each((function(t,i){var n=i.data("data"),a=n.label.val().trim(),r=n.input.val();if(a.length>0&&(n.l=n.l||{},n.l[e]=a),n.v=r,a.length>0||r.length>0){var s={l:n.l,v:n.v};o.push(s)}})),n.opts.opts=o,w.typedInput("value",Date.now())}}}}},{value:"checkbox",label:RED._("editor.inputs.checkbox"),icon:"fa fa-check-square-o",showLabel:!1,valueLabel:function(e,t){e.css("padding",0),(m=$('<input type="checkbox">').appendTo(e)).on("change",(function(e){r.typedInput("value",$(this).prop("checked")?"true":"false")})),m.prop("checked","true"===r.typedInput("value"))}},{value:"spinner",label:RED._("editor.inputs.spinner"),icon:"fa fa-sort-numeric-asc",showLabel:!1,valueLabel:function(e,t){e.css("padding",0);var o=$('<div class="red-ui-editor-subflow-env-input-type"></div>').appendTo(e),i=$('<div class="placeholder-input">').appendTo(o);$('<span><i class="fa fa-sort-numeric-asc"></i></span>').appendTo(i);var a=n.opts&&n.opts.min,r=n.opts&&n.opts.max,s="";void 0!==a&&void 0!==r?s=Math.min(a,r)+" - "+Math.max(a,r):void 0!==a?s="> "+a:void 0!==r&&(s="< "+r),$("<span>").css("margin-left","15px").text(s).appendTo(i)},expand:{icon:"fa-caret-down",content:function(e){var t=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(e);t.css("padding","8px 5px");var o=n.opts.min,i=n.opts.max,a=$('<input type="number" style="margin-bottom:0; width:60px">');a.val(o);var r=$('<input type="number" style="margin-bottom:0; width:60px">');return r.val(i),$('<div class="form-row" style="margin-bottom:3px"><label>'+RED._("editor.spinner.min")+"</label></div>").append(a).appendTo(t),$('<div class="form-row" style="margin-bottom:0"><label>'+RED._("editor.spinner.max")+"</label></div>").append(r).appendTo(t),{onclose:function(){var e=a.val().trim(),t=r.val().trim();""!==e?n.opts.min=parseInt(e):delete n.opts.min,""!==t?n.opts.max=parseInt(t):delete n.opts.max,w.typedInput("value",Date.now())}}}}},{value:"none",label:RED._("editor.inputs.none"),icon:"fa fa-times",hasValue:!1},{value:"hide",label:RED._("editor.inputs.hidden"),icon:"fa fa-ban",hasValue:!1}],default:"none"}).on("typedinputtypechange",(function(e,o){switch(n.type=$(this).typedInput("type"),n.opts=l[n.type],"input"===n.type?w.typedInput("value",n.opts.types.join(",")):w.typedInput("value",Date.now()),n.type){case"input":r.typedInput("types",n.opts.types);break;case"select":r.typedInput("types",["str"]);break;case"checkbox":r.typedInput("types",["bool"]);break;case"spinner":r.typedInput("types",["num"]);break;case"cred":r.typedInput("types",["cred"]);break;default:r.typedInput("types",t)}"checkbox"===n.type?r.typedInput("type","bool"):"spinner"===n.type&&r.typedInput("type","num"),"checkbox"!==n.type&&(m=null)})).on("change",(function(e,t){if("input"===n.type){var o=w.typedInput("value");n.opts.types=""===o?["str"]:o.split(","),r.typedInput("types",n.opts.types)}})),r.on("change",(function(e){m&&m.prop("checked","true"===$(this).typedInput("value"))})),w.typedInput("type",n.type)}(v,l.ui,u,p),u.trigger("change")}},sortable:".red-ui-editableList-item-handle",removable:!1});var s={},d=[];if(/^subflow:/.test(a.type)){var l=RED.nodes.subflow(a.type.substring(8));l.env&&l.env.forEach((function(e){var t={name:e.name,parent:{type:e.type,value:e.value,ui:e.ui}};d.push(t),s[e.name]=t}))}if(a.env)for(var c=0;c<a.env.length;c++){var u=a.env[c];s.hasOwnProperty(u.name)?(s[u.name].type=u.type,s[u.name].value=u.value):d.push({name:u.name,type:u.type,value:u.value,ui:u.ui})}d.forEach((function(e){e.parent&&e.parent.ui&&"hide"===e.parent.ui.type||!r&&e.parent||n.editableList("addItem",JSON.parse(JSON.stringify(e)))}))},setLocale:function(t,o){e=t,o&&o.editableList("items").each((function(t,o){var n=$(this).data("data"),a=n.ui.labelField;a.val(i(n.ui.label,"",e)),a.timeout&&(clearTimeout(a.timeout),delete a.timeout),a.addClass("input-updated"),a.timeout=setTimeout((function(){delete a.timeout,a.removeClass("input-updated")}),3e3)}))},lookupLabel:i,DEFAULT_ENV_TYPE_LIST:t,DEFAULT_ENV_TYPE_LIST_INC_CRED:o}}(),function(){var e={},t={show:function(t){var o,i,n,a,r=t.parent||"_",s=t.value,d=t.cancel,l=t.complete;0===$("script[data-template-name='_expression']").length&&$('<script type="text/x-red" data-template-name="_expression"><div id="red-ui-editor-type-expression-panels"><div id="red-ui-editor-type-expression-panel-expr" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-expression-legacy red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span data-i18n="expressionEditor.compatMode"></span></button><button id="red-ui-editor-type-expression-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="expressionEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-expression"></div></div></div><div id="red-ui-editor-type-expression-panel-info" class="red-ui-panel"><div class="form-row"><ul id="red-ui-editor-type-expression-tabs"></ul><div id="red-ui-editor-type-expression-tab-help" class="red-ui-editor-type-expression-tab-content hide"><div><select id="red-ui-editor-type-expression-func"></select><button id="red-ui-editor-type-expression-func-insert" class="red-ui-button" data-i18n="expressionEditor.insert"></button></div><div id="red-ui-editor-type-expression-help"></div></div><div id="red-ui-editor-type-expression-tab-test" class="red-ui-editor-type-expression-tab-content hide"><div><span style="display: inline-block; width: calc(50% - 5px);"><span data-i18n="expressionEditor.data"></span><button style="float: right; margin-right: 5px;" id="node-input-example-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button></span><span style="display: inline-block; margin-left: 10px; width: calc(50% - 5px);" data-i18n="expressionEditor.result"></span></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-data"></div><div style="display: inline-block; margin-left: 10px;  width:calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-result"></div></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var c={title:t.title,focusElement:t.focusElement,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){d&&d(),RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#red-ui-editor-type-expression-help").text(""),o.saveView(),l&&l(o.getValue(),o.getCursorPosition(),o),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();a&&a.resize(t)},open:function(d){d.find(".red-ui-tray-body").addClass("red-ui-editor-type-expression");var l=RED.editor.buildEditForm(d.find(".red-ui-tray-body"),"dialog-form","_expression","editor"),u=$("#red-ui-editor-type-expression-func");Object.keys(jsonata.functions).forEach((function(e){u.append($("<option></option>").val(e).text(e))})),u.on("change",(function(e){var t=$(this).val(),o="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",i=RED.utils.renderMarkdown(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#red-ui-editor-type-expression-help").html(o+"<p>"+i+"</p>")})),o=RED.editor.createEditor({id:"red-ui-editor-type-expression",value:"",mode:"ace/mode/jsonata",stateId:t.stateId,focus:!0,options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}});var p=null,f=-1;o.getSession().setValue(s||"",-1),"ace"==o.type&&o.on("changeSelection",(function(){var e=o.getCursorPosition(),t=o.getSession().getTokenAt(e.row,e.column);if(t!==p||t&&/paren/.test(t.type)&&e.column!==f){var i,n;p=t;var a=null;if(t&&"keyword"===t.type)i=e.row,a=t;else{var r=0,s=!1;for(t?("paren.rparen"===t.type&&(f=e.column,r=e.column-(t.start+t.value.length)),i=e.row,n=t.index):(i=e.row-1,n=-1);null===a&&i>-1;){var d=o.getSession().getTokens(i);for(-1===n&&(n=d.length-1);n>-1;){var l=d[n].type;if(s){if("keyword"===l){a=d[n];break}s=!1}"paren.lparen"===l?r-=d[n].value.length:"paren.rparen"===l&&(r+=d[n].value.length),r<0&&(s=!0,r=0),n--}a||i--}}o.session.removeMarker(null),a&&u.val(a.value).trigger("change")}})),l.i18n(),$("#red-ui-editor-type-expression-func-insert").on("click",(function(e){e.preventDefault();o.getCursorPosition();var t=u.val(),i=jsonata.getFunctionSnippet(t);o.insertSnippet(i),o.focus()})),$("#red-ui-editor-type-expression-reformat").on("click",(function(e){e.preventDefault();var t=o.getValue()||"";try{t=jsonata.format(t)}catch(e){}o.getSession().setValue(t||"",-1)})),u.change();var h,g=RED.tabs.create({element:$("#red-ui-editor-type-expression-tabs"),onchange:function(e){$(".red-ui-editor-type-expression-tab-content").hide(),e.content.show(),c.resize()}});g.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#red-ui-editor-type-expression-tab-help")}),g.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#red-ui-editor-type-expression-tab-test")}),i=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-data",value:e[r]||'{\n    "payload": "hello world"\n}',stateId:!1,focus:!1,mode:"ace/mode/json",lineNumbers:!1}),$(".red-ui-editor-type-expression-legacy").on("click",(function(e){e.preventDefault(),RED.sidebar.help.set(RED._("expressionEditor.compatModeDesc"))}));var v=function(){var e,t,a=i.getValue(),r=o.getValue(),s=!1,d=/(^|[^a-zA-Z0-9_'".])msg([^a-zA-Z0-9_'"]|$)/.test(r);$(".red-ui-editor-type-expression-legacy").toggle(d);try{(t=jsonata(r)).assign("flowContext",(function(e){return s=!0,null})),t.assign("globalContext",(function(e){return s=!0,null}))}catch(e){return void n.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(a)}catch(e){return void n.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var l,c=t.evaluate(d?{msg:e}:e);if(s)return void n.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);l=void 0!==c?JSON.stringify(c,null,4):RED._("expressionEditor.noMatch"),n.setValue(l,-1)}catch(e){n.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};i.getSession().on("change",(function(){clearTimeout(h),h=setTimeout(v,200),e[r]=i.getValue()})),o.getSession().on("change",(function(){clearTimeout(h),h=setTimeout(v,200)})),n=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-result",value:"",stateId:!1,focus:!1,mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),a=RED.panels.create({id:"red-ui-editor-type-expression-panels",resize:function(e,t){var a=$("#red-ui-editor-type-expression-panel-expr");e-=$(a.children()[0]).outerHeight(!0);var r=$(a.children()[1]);e-=parseInt(r.css("marginTop"))+parseInt(r.css("marginBottom")),$("#red-ui-editor-type-expression").css("height",e-5+"px"),o.resize(),t-=$("#red-ui-editor-type-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".red-ui-editor-type-expression-tab-content").height(t),$("#red-ui-editor-type-expression-test-data").css("height",t-25+"px"),i.resize(),$("#red-ui-editor-type-expression-test-result").css("height",t-25+"px"),n.resize()}}),$("#node-input-example-reformat").on("click",(function(e){e.preventDefault();var t=i.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}i.getSession().setValue(t||"",-1)})),v()},close:function(){t.onclose&&t.onclose(),o.destroy(),i.destroy(),n.destroy()},show:function(){}};RED.tray.show(c)}};RED.editor.registerTypeEditor("_expression",t)}(),RED.editor.iconPicker={show:function(e,t,o,i,n){var a=$('<div class="red-ui-icon-picker">'),r=$("<div>",{class:"red-ui-search-container"}).appendTo(a);searchInput=$('<input type="text">').attr("placeholder",RED._("editor.searchIcons")).appendTo(r).searchBox({delay:50,change:function(){var e=$(this).val().trim();""===e?(s.find(".red-ui-icon-list-module").show(),s.find(".red-ui-icon-list-icon").show()):(s.find(".red-ui-icon-list-module").hide(),s.find(".red-ui-icon-list-icon").each((function(t,o){-1===$(o).data("icon").indexOf(e)?$(o).hide():$(o).show()})))}}),$("<div>").appendTo(a);var s=$('<div class="red-ui-icon-list">').appendTo(a),d=$('<div class="red-ui-icon-meta"></div>').appendTo(a),l=$("<span>").appendTo(d);$('<button type="button" class="red-ui-button red-ui-button-small">'+RED._("editor.useDefault")+"</button>").appendTo(d).on("click",(function(e){e.preventDefault(),u.hide(),n(null)})),!t&&i&&s.addClass("red-ui-icon-list-dark"),setTimeout((function(){var e=RED.nodes.getIconSets();Object.keys(e).forEach((function(a){if(!i||"font-awesome"===a){var r=e[a];if(r.length>0){var d=$('<div class="red-ui-icon-list-module"></div>').text(a).appendTo(s);$('<i class="fa fa-cube"></i>').prependTo(d),r.forEach((function(e){var i=$("<div>",{class:"red-ui-icon-list-icon"}).appendTo(s),r=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),d=RED.settings.apiRootUrl+"icons/"+a+"/"+e;if(i.data("icon",d),t){r.css({backgroundColor:t});var c=RED.utils.getDarkerColor(t);c!==t&&r.css("border-color",c)}var p=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(r);RED.utils.createIconElement(d,p,!0),o.module===a&&o.file===e&&i.addClass("selected"),i.on("mouseover",(function(){l.text(e)})),i.on("mouseout",(function(){l.html("&nbsp;")})),i.on("click",(function(){u.hide(),n(a+"/"+e)}))}))}}})),setTimeout((function(){c.remove()}),50)}),300);var c=RED.utils.addSpinnerOverlay(s,!0),u=RED.popover.panel(a);u.show({target:e}),a.slideDown(100),searchInput.trigger("focus")}},function(){var e={show:function(e){var t,o=e.value,i=e.cancel,n=e.complete;0===$("script[data-template-name='_js']").length&&$('<script type="text/x-red" data-template-name="_js"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-js"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var a={title:e.title,focusElement:e.focusElement,width:e.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){i&&i(),RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){t.saveView(),n&&n(t.getValue(),t.getCursorPosition(),t),RED.tray.close()}}],resize:function(e){for(var o=$("#dialog-form>div:not(.node-text-editor-row)"),i=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<o.size();n++)i-=$(o[n]).outerHeight(!0);$(".node-text-editor").css("height",i+"px"),t.resize()},open:function(i){var n=RED.editor.buildEditForm(i.find(".red-ui-tray-body"),"dialog-form","_js","editor");t=RED.editor.createEditor({id:"node-input-js",mode:e.mode||"ace/mode/javascript",stateId:e.stateId,focus:!0,value:o,globals:{msg:!0,context:!0,RED:!0,util:!0,flow:!0,global:!0,console:!0,Buffer:!0,setTimeout:!0,clearTimeout:!0,setInterval:!0,clearInterval:!0},extraLibs:e.extraLibs}),e.cursor&&!t._initState&&t.gotoLine(e.cursor.row+1,e.cursor.column,!1),n.i18n()},close:function(){e.onclose&&e.onclose(),t.destroy()},show:function(){}};RED.tray.show(a)}};RED.editor.registerTypeEditor("_js",e)}(),function(){var e;function t(e,t,i,n){var a,r="";if(e.children.length>0)switch(e.children[Math.max(0,Math.min(e.children.length-1,i))].type){case"string":r="";break;case"number":r=0;break;case"boolean":r=!0;break;case"null":r=null;break;case"object":r={};break;case"array":r=[]}if("array"===e.type)a=e.children.length;else{var s={};e.children.forEach((function(e){s[e.key]=!0}));var d="item",l=2;for(a=d;s[a];)a="item-"+l++}var c=o(a,r,e.depth+1,e,n);e.treeList.insertChildAt(c,t,!0),e.treeList.expand()}function o(e,n,a,r,s){var d,l={depth:a,type:typeof n},c=$('<span class="red-ui-editor-type-json-editor-label">');if(null!=e){var u;l.key=e,u="string"==typeof e?'"'+e+'"':e;var p=$('<span class="red-ui-debug-msg-object-key red-ui-editor-type-json-editor-label-key">').text(u).appendTo(c);p.addClass("red-ui-debug-msg-type-"+typeof e),r&&"array"===r.type&&p.addClass("red-ui-editor-type-json-editor-label-array-key"),s&&p.addClass("readonly"),p.on("click",(function(e){if("array"!==l.parent.type&&!s){e.preventDefault(),e.stopPropagation();var t=Math.max(150,p.width()),o=$('<input type="text" class="red-ui-editor-type-json-editor-key">').css({width:t+"px"}).val(""+l.key).insertAfter(p).typedInput({types:["str"]});$(document).on("mousedown.nr-ui-json-editor",(function(e){for(var t=o.next(".red-ui-typedInput-container")[0],i=e.target;"BODY"!==i.nodeName&&i!==t&&!$(i).hasClass("red-ui-typedInput-options");)i=i.parentElement;if("BODY"===i.nodeName){var n,a=o.typedInput("value");l.key=a,n="string"==typeof a?'"'+a+'"':a,p.text(n),o.remove(),p.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor")}})),$(document).on("keydown.nr-ui-json-editor",(function(e){27===e.keyCode&&(o.remove(),p.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))})),p.hide()}})),$("<span>").text(" : ").appendTo(c)}Array.isArray(n)?(l.expanded=a<2,l.type="array",l.deferBuild=a>=2,l.children=function(e,t,i,n){for(var a=[],r=e.length,s=0;s<r;s++)a.push(o(s,e[s],t,i,n));return a}(n,a+1,l,s)):null!==n&&"object"===l.type?(l.expanded=a<2,l.children=function(e,t,i,n){var a=[];for(var r in e)e.hasOwnProperty(r)&&a.push(o(r,e[r],t,i,n));return a}(n,a+1,l,s),l.deferBuild=a>=2):(l.value=n,null===n&&(l.type="null"));var f,h,g="";switch(l.type){case"string":d="str",g='"'+l.value+'"',f="red-ui-debug-msg-type-string";break;case"number":d="num",g=l.value,f="red-ui-debug-msg-type-number";break;case"boolean":d="bool",g=l.value,f="red-ui-debug-msg-type-other";break;case"null":d=l.type,g=l.type,f="red-ui-debug-msg-type-null";break;case"object":d=l.type,g=l.type,f="red-ui-debug-msg-type-meta";break;case"array":d=l.type,g=l.type+"["+l.children.length+"]",f="red-ui-debug-msg-type-meta"}var v=$('<span class="red-ui-editor-type-json-editor-label-value">').addClass(f).text(g).appendTo(c);return s&&v.addClass("readonly"),v.on("click",(function(e){if(!s){e.preventDefault(),e.stopPropagation(),"str"===d?g=g.substring(1,g.length-1):("array"===d||"object"===d)&&(g="");var t=Math.max(150,v.width()),o=$('<input type="text" class="red-ui-editor-type-json-editor-value">').css({width:t+"px"}).val(""+g).insertAfter(v).typedInput({types:["str","num","bool",{value:"null",label:RED._("common.type.null"),hasValue:!1},{value:"array",label:RED._("common.type.array"),hasValue:!1,icon:"red/images/typedInput/json.svg"},{value:"object",label:RED._("common.type.object"),hasValue:!1,icon:"red/images/typedInput/json.svg"}],default:d});$(document).on("mousedown.nr-ui-json-editor",(function(e){for(var t=o.next(".red-ui-typedInput-container")[0],i=e.target;"BODY"!==i.nodeName&&i!==t&&!$(i).hasClass("red-ui-typedInput-options");)i=i.parentElement;if("BODY"===i.nodeName){var n;switch(d=o.typedInput("type"),g=o.typedInput("value"),"num"===d&&(g=g.trim(),isNaN(g)?d="str":""===g&&(g=0)),l.value=g,d){case"str":l.children&&(h=l.children),l.treeList.makeLeaf(!0),l.type="string",n="red-ui-debug-msg-type-string",g='"'+g+'"';break;case"num":l.children&&(h=l.children),l.treeList.makeLeaf(!0),l.type="number",n="red-ui-debug-msg-type-number";break;case"bool":l.children&&(h=l.children),l.treeList.makeLeaf(!0),l.type="boolean",n="red-ui-debug-msg-type-other",l.value="true"===g;break;case"null":l.children&&(h=l.children),l.treeList.makeLeaf(!0),l.type="null",n="red-ui-debug-msg-type-null",l.value=g="null";break;case"object":l.treeList.makeParent(h),l.type="object",n="red-ui-debug-msg-type-meta",l.value=g="object",l.children.forEach((function(e,t){if(e.hasOwnProperty("_key")){var o;e.key=e._key,delete e._key;var i=e.element.find(".red-ui-editor-type-json-editor-label-key");i.removeClass("red-ui-editor-type-json-editor-label-array-key"),"string"==typeof e.key?(o='"'+e.key+'"',i.addClass("red-ui-debug-msg-type-string"),i.removeClass("red-ui-debug-msg-type-number")):(o=e.key,i.removeClass("red-ui-debug-msg-type-string"),i.addClass("red-ui-debug-msg-type-number")),i.text(o)}}));break;case"array":l.treeList.makeParent(h),l.type="array",n="red-ui-debug-msg-type-meta",l.value=g="array["+l.children.length+"]",l.children.forEach((function(e,t){e._key=e.key,e.key=t,e.element.find(".red-ui-editor-type-json-editor-label-key").addClass("red-ui-editor-type-json-editor-label-array-key").text(""+e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")}))}v.text(g).removeClass().addClass("red-ui-editor-type-json-editor-label-value "+n),o.remove(),v.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor")}})),$(document).on("keydown.nr-ui-json-editor",(function(e){27===e.keyCode&&(o.remove(),v.show(),"str"===d&&(g='"'+g+'"'),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))})),v.hide()}})),l.gutter=$('<span class="red-ui-editor-type-json-editor-item-gutter"></span>'),s||(r?$('<span class="red-ui-editor-type-json-editor-item-handle"><i class="fa fa-bars"></span>').appendTo(l.gutter):$("<span></span>").appendTo(l.gutter),$('<button type="button" class="editor-button editor-button-small"><i class="fa fa-caret-down"></button>').appendTo(l.gutter).on("click",(function(e){e.preventDefault(),e.stopPropagation(),function(e,n,a){var r=e.offset(),s=[];n.parent&&(s.push({id:"red-ui-editor-type-json-menu-insert-above",icon:"fa fa-toggle-up",label:RED._("jsonEditor.insertAbove"),onselect:function(){var e=n.parent.children.indexOf(n);t(n.parent,e,e,a)}}),s.push({id:"red-ui-editor-type-json-menu-insert-below",icon:"fa fa-toggle-down",label:RED._("jsonEditor.insertBelow"),onselect:function(){var e=n.parent.children.indexOf(n)+1;t(n.parent,e,e-1,a)}})),"array"!==n.type&&"object"!==n.type||s.push({id:"red-ui-editor-type-json-menu-add-child",icon:"fa fa-plus",label:RED._("jsonEditor.addItem"),onselect:function(){t(n,n.children.length,n.children.length-1,a)}}),n.parent&&(s.push({id:"red-ui-editor-type-json-menu-copy-path",icon:"fa fa-terminal",label:RED._("jsonEditor.copyPath"),onselect:function(){for(var e=n,t="";e.parent;)t=("array"===e.parent.type?"["+e.key+"]":/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(e.key)?e.key:'["'+e.key.replace(/"/,'\\"')+'"]')+(t.length>0&&"["!==t[0]?".":"")+t,e=e.parent;RED.clipboard.copyText(t,n.element,"clipboard.copyMessagePath")}}),s.push({id:"red-ui-editor-type-json-menu-duplicate",icon:"fa fa-copy",label:RED._("jsonEditor.duplicate"),onselect:function(){var e=n.key;if("array"===n.parent.type)e=n.parent.children.length;else{var t=/^(.*?)(-(\d+))?$/.exec(e),r={};n.parent.children.forEach((function(e){r[e.key]=!0}));var s=t[1],d=2;for(void 0!==t[3]&&(d=parseInt(t[3])),e=s;r[e];)e=s+"-"+d++}var l=o(e,i(n),n.parent.depth+1,n.parent,a),c=n.parent.children.indexOf(n)+1;n.parent.treeList.insertChildAt(l,c,!0),n.parent.treeList.expand()}}),s.push({id:"red-ui-editor-type-json-menu-delete",icon:"fa fa-times",label:RED._("common.label.delete"),onselect:function(){n.treeList.remove()}})),"array"!==n.type&&"object"!==n.type||(s.push(null),s.push({id:"red-ui-editor-type-json-menu-expand-children",icon:"fa fa-angle-double-down",label:RED._("jsonEditor.expandItems"),onselect:function(){n.treeList.expand(),n.children.forEach((function(e){e.treeList.expand()}))}}),s.push({id:"red-ui-editor-type-json-menu-collapse-children",icon:"fa fa-angle-double-up",label:RED._("jsonEditor.collapseItems"),onselect:function(){n.treeList.collapse(),n.children.forEach((function(e){e.treeList.collapse()}))}}));var d=RED.menu.init({id:"red-ui-editor-type-json-menu",options:s});d.css({position:"absolute"}),d.on("mouseleave",(function(){$(this).hide()})),d.on("mouseup",(function(){$(this).hide()})),d.appendTo("body");var l=r.top,c=d.height(),u=$(window).height();l+c>u&&(l-=l+c-u+20),d.css({top:l+"px",left:r.left+"px"}),d.show()}($(this),l,s)}))),l.element=c,l}function i(e){var t;switch(e.type){case"string":case"boolean":t=e.value;break;case"number":t=Number(e.value);break;case"null":t=null;break;case"object":t={},e.children.forEach((function(e){t[e.key]=i(e)}));break;case"array":t=e.children.map((function(e){return i(e)}))}return t}var n={show:function(t){var n,a,r=t.value,s=t.cancel,d=t.complete,l="_json";0===$("script[data-template-name='_json']").length&&$('<script type="text/x-red" data-template-name="_json"><ul id="red-ui-editor-type-json-tabs"></ul><div id="red-ui-editor-type-json-tab-raw" class="red-ui-editor-type-json-tab-content hide"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><span class="button-group"><button id="node-input-json-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button><span class="button-group"></div><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-json"></div></div></div><div id="red-ui-editor-type-json-tab-ui" class="red-ui-editor-type-json-tab-content hide"><div id="red-ui-editor-type-json-tab-ui-container"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var c,u=function(){var e=n.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}},p={title:t.title,focusElement:t.focusElement,width:t.width||700,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){s&&s(),RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var o;t.requireValid&&!u()||("json-ui"===e?o=c?JSON.stringify(i(c),null,4):n.getValue():"json-raw"===e&&(o=n.getValue()),n.saveView(),d&&d(o,null,n),RED.tray.close())}}],resize:function(e){var t=$(".red-ui-editor-type-json-tab-content").height();$(".node-text-editor").css("height",t-45+"px"),n.resize()},open:function(s){s.find(".red-ui-tray-body");var d=RED.editor.buildEditForm(s.find(".red-ui-tray-body"),"dialog-form",l,"editor"),f=t.toolbarButtons||[];f.length&&f.forEach((function(e){var t=$('<button type="button" class="red-ui-button red-ui-button-small"> </button>').insertBefore("#node-input-json-reformat").on("click",(function(o){o.preventDefault(),void 0!==e.click&&e.click.call(t,o)}));e.id&&t.attr("id",e.id),e.title&&t.attr("title",e.title),e.icon&&t.append($("<i></i>").attr("class",e.icon)),(e.label||e.text)&&t.append($("<span></span>").text(" "+(e.label||e.text)))}));var h=$("#red-ui-editor-type-json-tab-ui-container").css({height:"100%"}),g=$('<div class="red-ui-debug-msg-payload red-ui-editor-type-json-editor">').appendTo(h).treeList({selectable:!1,rootSortable:!1,sortable:".red-ui-editor-type-json-editor-item-handle"}).on("treelistchangeparent",(function(e,t){"array"===t.old.type&&t.old.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.old.children.length+"]"),"array"===t.item.parent.type&&t.item.parent.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.item.parent.children.length+"]")})).on("treelistsort",(function(e,t){t.children.forEach((function(e,o){"array"===t.type?(e.key=o,e.element.find(".red-ui-editor-type-json-editor-label-key").text(e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")):e.element.find(".red-ui-editor-type-json-editor-label-key").text('"'+e.key+'"').removeClass("red-ui-debug-msg-type-number").addClass("red-ui-debug-msg-type-string")}))}));n=RED.editor.createEditor({id:"node-input-json",value:r||"",mode:"ace/mode/json",readOnly:!!t.readOnly,stateId:t.stateId,focus:!0}),t.requireValid&&(n.getSession().on("change",(function(){clearTimeout(a),a=setTimeout(u,200)})),u()),$("#node-input-json-reformat").on("click",(function(e){e.preventDefault();var t=n.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}n.getSession().setValue(t||"",-1)})),d.i18n();var v=!1,m=RED.tabs.create({element:$("#red-ui-editor-type-json-tabs"),onchange:function(a){if(e=a.id,$(".red-ui-editor-type-json-tab-content").hide(),v)if("json-raw"===a.id){if(c){var r=JSON.stringify(i(c),null,4);n.getSession().setValue(r||"",-1)}}else if("json-ui"===a.id){var s=n.getValue().trim()||"{}";try{var d=JSON.parse(s);(c=o(null,d,0,null,t.readOnly)).class="red-ui-editor-type-json-root-node",g.treeList("data",[c])}catch(e){c=null,g.treeList("data",[{label:RED._("jsonEditor.error.invalidJSON")+e.toString()}])}}a.content.show(),p.resize()}});m.addTab({id:"json-raw",label:t.readOnly?RED._("jsonEditor.rawMode-readonly"):RED._("jsonEditor.rawMode"),content:$("#red-ui-editor-type-json-tab-raw")}),m.addTab({id:"json-ui",label:t.readOnly?RED._("jsonEditor.uiMode-readonly"):RED._("jsonEditor.uiMode"),content:$("#red-ui-editor-type-json-tab-ui")}),v=!0},close:function(){t.onclose&&t.onclose(),n.destroy()},show:function(){}};RED.tray.show(p)}};RED.editor.registerTypeEditor("_json",n)}(),function(){var e,t={show:function(t){var o,i=t.value,n=t.cancel,a=t.complete,r="_markdown";0===$("script[data-template-name='"+r+"']").length&&$('<script type="text/x-red" data-template-name="_markdown"><div id="red-ui-editor-type-markdown-panels"><div id="red-ui-editor-type-markdown-panel-editor" class="red-ui-panel"><div style="height: 100%; margin: auto;"><div id="red-ui-editor-type-markdown-toolbar"></div><div class="node-text-editor" style="height: 100%" id="red-ui-editor-type-markdown"></div></div></div><div class="red-ui-panel"><div class="red-ui-editor-type-markdown-panel-preview red-ui-help"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var s={title:t.title,focusElement:t.focusElement,width:t.width||1/0,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){n&&n(),RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){o.saveView(),a&&a(o.getValue(),o.getCursorPosition(),o),RED.tray.close()}}],resize:function(t){var o=$("#dialog-form").width();e&&e.resize(o)},open:function(n){n.find(".red-ui-tray-body").addClass("red-ui-editor-type-markdown-editor");var a,s=RED.editor.buildEditForm(n.find(".red-ui-tray-body"),"dialog-form",r,"editor");(o=RED.editor.createEditor({id:"red-ui-editor-type-markdown",value:i,stateId:t.stateId,focus:!0,mode:"ace/mode/markdown",expandable:!1})).getSession().on("change",(function(){clearTimeout(a),a=setTimeout((function(){var e=$(".red-ui-editor-type-markdown-panel-preview").scrollTop();$(".red-ui-editor-type-markdown-panel-preview").html(RED.utils.renderMarkdown(o.getValue())),$(".red-ui-editor-type-markdown-panel-preview").scrollTop(e)}),200)})),t.header&&t.header.appendTo(n.find("#red-ui-editor-type-markdown-title")),i&&$(".red-ui-editor-type-markdown-panel-preview").html(RED.utils.renderMarkdown(o.getValue())),(e=RED.panels.create({id:"red-ui-editor-type-markdown-panels",dir:"horizontal",resize:function(e,t){o.resize()}})).ratio(1),$('<span class="button-group" style="float:right"><button type="button" id="node-btn-markdown-preview" class="red-ui-button toggle single"><i class="fa fa-eye"></i></button></span>').appendTo(o.toolbar),$("#node-btn-markdown-preview").on("click",(function(t){t.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),e.ratio(1)):($(this).addClass("selected"),e.ratio(.5))})),RED.popover.tooltip($("#node-btn-markdown-preview"),RED._("markdownEditor.toggle-preview")),t.cursor&&!o._initState&&o.gotoLine(t.cursor.row+1,t.cursor.column,!1),s.i18n()},close:function(){t.onclose&&t.onclose(),o.destroy()},show:function(){}};RED.tray.show(s)},buildToolbar:function(e,t){var o={h1:{newline:!0,before:"# ",tooltip:RED._("markdownEditor.heading1")},h2:{newline:!0,before:"## ",tooltip:RED._("markdownEditor.heading2")},h3:{newline:!0,before:"### ",tooltip:RED._("markdownEditor.heading3")},b:{before:"**",after:"**",tooltip:RED._("markdownEditor.bold")},i:{before:"_",after:"_",tooltip:RED._("markdownEditor.italic")},code:{before:"`",after:"`",tooltip:RED._("markdownEditor.code")},ol:{before:" 1. ",newline:!0,tooltip:RED._("markdownEditor.ordered-list")},ul:{before:" - ",newline:!0,tooltip:RED._("markdownEditor.unordered-list")},bq:{before:"> ",newline:!0,tooltip:RED._("markdownEditor.quote")},link:{before:"[",after:"]()",tooltip:RED._("markdownEditor.link")},hr:{before:"\n---\n\n",tooltip:RED._("markdownEditor.horizontal-rule")}},i=$('<div style="margin-bottom: 5px"><span class="button-group"><button type="button" class="red-ui-button" data-style="h1" style="font-size:1.1em; font-weight: bold">h1</button><button type="button" class="red-ui-button" data-style="h2" style="font-size:1.0em; font-weight: bold">h2</button><button type="button" class="red-ui-button" data-style="h3" style="font-size:0.9em; font-weight: bold">h3</button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="b"><i class="fa fa-bold"></i></button><button type="button" class="red-ui-button" data-style="i"><i class="fa fa-italic"></i></button><button type="button" class="red-ui-button" data-style="code"><i class="fa fa-code"></i></button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="ol"><i class="fa fa-list-ol"></i></button><button type="button" class="red-ui-button" data-style="ul"><i class="fa fa-list-ul"></i></button><button type="button" class="red-ui-button" data-style="bq"><i class="fa fa-quote-left"></i></button><button type="button" class="red-ui-button" data-style="hr"><i class="fa fa-minus"></i></button><button type="button" class="red-ui-button" data-style="link"><i class="fa fa-link"></i></button></span></div>').appendTo(e);return i.find("button[data-style]").each((function(e){var i=o[$(this).data("style")];$(this).on("click",(function(e){e.preventDefault();var o=t.getSelectedText(),n=t.selection.getRange();if(i.newline)for(var a=0,r=((i.before||"").match(/\n/g)||[]).length,s=((i.after||"").match(/\n/g)||[]).length,d=n.start.row;d<=n.end.row+a;d++)i.before&&(t.session.insert({row:d,column:0},i.before),a+=r,d+=r),i.after&&(t.session.insert({row:d,column:1/0},i.after),a+=s,d+=s);else t.session.replace(t.selection.getRange(),(i.before||"")+o+(i.after||"")),""===o&&t.gotoLine(n.start.row+1,n.start.column+(i.before||"").length,!1);t.focus()})),i.tooltip&&RED.popover.tooltip($(this),i.tooltip)})),i}};RED.editor.registerTypeEditor("_markdown",t)}(),function(){var e={show:function(e){var t,o=e.value,i=e.cancel,n=e.complete,a="_text";0===$("script[data-template-name='_text']").length&&$('<script type="text/x-red" data-template-name="_text"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-text"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var r={title:e.title,focusElement:e.focusElement,width:e.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){i&&i(),RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){t.saveView(),n&&n(t.getValue(),t.getCursorPosition(),t),RED.tray.close()}}],resize:function(e){$("#dialog-form>div:not(.node-text-editor-row)"),$("#dialog-form>div.node-text-editor-row");var o=$("#dialog-form").height();$(".node-text-editor").css("height",o+"px"),t.resize()},open:function(i){RED.editor.buildEditForm(i.find(".red-ui-tray-body"),"dialog-form",a,"editor");t=RED.editor.createEditor({id:"node-input-text",value:o||"",stateId:e.stateId,mode:"ace/mode/"+(e.mode||"text"),focus:!0}),e.cursor&&!t._initState&&t.gotoLine(e.cursor.row+1,e.cursor.column,!1)},close:function(){e.onclose&&e.onclose(),t.destroy()},show:function(){}};RED.tray.show(r)}};RED.editor.registerTypeEditor("_text",e)}(),RED.editor.codeEditor.ace=function(){var e=!1,t={};return{get type(){return"ace"},get initialised(){return e},init:function(o){return t=o||{},e=!0},create:function(e){var o=RED.editor.codeEditor.settings||{},i=e.element||$("#"+e.id)[0],n=$("<div>").appendTo(i);i=$("<div>").appendTo(i).addClass("red-ui-editor-text-container")[0];var a=window.ace.edit(i);a.setTheme(o.theme||t.theme||"ace/theme/tomorrow");var r=a.getSession();if(r.on("changeAnnotation",(function(){for(var e=r.getAnnotations()||[],t=e.length,o=e.length;t--;)(/doctype first\. Expected/.test(e[t].text)||/Unexpected End of file\. Expected/.test(e[t].text))&&e.splice(t,1);o>e.length&&r.setAnnotations(e)})),e.mode&&r.setMode(e.mode),e.foldStyle?r.setFoldStyle(e.foldStyle):r.setFoldStyle("markbeginend"),e.options?a.setOptions(e.options):a.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,tooltipFollowsMouse:!1}),e.readOnly&&(a.setOption("readOnly",e.readOnly),a.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&a.renderer.setOption("showGutter",e.lineNumbers),a.$blockScrolling=1/0,e.value&&r.setValue(e.value,-1),e.globals&&setTimeout((function(){r.$worker&&r.$worker.send("setOptions",[{globals:e.globals,maxerr:1e3}])}),100),e.stateId||!1===e.stateId||(e.stateId=RED.editor.generateViewStateId("ace",e,(e.mode||e.title).split("/").pop())),"ace/mode/markdown"===e.mode){if($(i).addClass("red-ui-editor-text-container-toolbar"),a.toolbar=RED.editor.customEditTypes._markdown.buildToolbar(n,a),!1!==e.expandable){var s=$('<button type="button" class="red-ui-button" style="float: right;"><i class="fa fa-expand"></i></button>').appendTo(a.toolbar);RED.popover.tooltip(s,RED._("markdownEditor.expand")),s.on("click",(function(t){t.preventDefault();var o=a.getValue();RED.editor.editMarkdown({value:o,width:"Infinity",stateId:e.stateId,focus:!0,cancel:function(){a.focus()},complete:function(e,t){a.setValue(e,-1),setTimeout((function(){a.restoreView(),a.focus()}),300)}})}))}var d=$('<button type="button" class="red-ui-editor-text-help red-ui-button red-ui-button-small"><i class="fa fa-question"></i></button>').appendTo($(i).parent());RED.popover.create({target:d,trigger:"click",size:"small",direction:"left",content:RED._("markdownEditor.format"),autoClose:50}),r.setUseWrapMode(!0)}return a._destroy=a.destroy,a.destroy=function(){try{a.saveView(),a._initState=null,this._destroy()}catch(e){}$(i).remove(),$(n).remove()},a.on("blur",(function(){a.focusMemory=!1,a.saveView()})),a.on("focus",(function(){a._initState&&(a.restoreView(a._initState),a._initState=null)})),a.getView=function(){var e=a.getSession();return{selection:e.selection.toJSON(),scrollTop:e.getScrollTop(),scrollLeft:e.getScrollLeft(),options:e.getOptions()}},a.saveView=function(){if(e.stateId){window._editorStateAce=window._editorStateAce||{};var t=a.getView();return window._editorStateAce[e.stateId]=t,t}},a.restoreView=function(t){if(e.stateId){window._editorStateAce=window._editorStateAce||{};var o=t||window._editorStateAce[e.stateId];if(o)try{var i=a.getSession();i.setOptions(o.options),i.selection.fromJSON(o.selection),i.setScrollTop(o.scrollTop),i.setScrollLeft(o.scrollLeft),a._initState=o}catch(t){delete window._editorStateMonaco[e.stateId]}}},a.restoreView(),a.type="ace",a}}}(),RED.editor.codeEditor.monaco=function(){var e=!1;const t="monaco",o=["vs","vs-dark","hc-black"];let i;const n={assert:{package:"node",module:"assert",path:"node/assert.d.ts"},async_hooks:{package:"node",module:"async_hooks",path:"node/async_hooks.d.ts"},buffer:{package:"node",module:"buffer",path:"node/buffer.d.ts"},child_process:{package:"node",module:"child_process",path:"node/child_process.d.ts"},cluster:{package:"node",module:"cluster",path:"node/cluster.d.ts"},console:{package:"node",module:"console",path:"node/console.d.ts"},constants:{package:"node",module:"constants",path:"node/constants.d.ts"},crypto:{package:"node",module:"crypto",path:"node/crypto.d.ts"},dgram:{package:"node",module:"dgram",path:"node/dgram.d.ts"},dns:{package:"node",module:"dns",path:"node/dns.d.ts"},domain:{package:"node",module:"domain",path:"node/domain.d.ts"},events:{package:"node",module:"events",path:"node/events.d.ts"},fs:{package:"node",module:"fs",path:"node/fs.d.ts"},globals:{package:"node",module:"globals",path:"node/globals.d.ts"},http:{package:"node",module:"http",path:"node/http.d.ts"},http2:{package:"node",module:"http2",path:"node/http2.d.ts"},https:{package:"node",module:"https",path:"node/https.d.ts"},module:{package:"node",module:"module",path:"node/module.d.ts"},net:{package:"node",module:"net",path:"node/net.d.ts"},os:{package:"node",module:"os",path:"node/os.d.ts"},path:{package:"node",module:"path",path:"node/path.d.ts"},perf_hooks:{package:"node",module:"perf_hooks",path:"node/perf_hooks.d.ts"},process:{package:"node",module:"process",path:"node/process.d.ts"},querystring:{package:"node",module:"querystring",path:"node/querystring.d.ts"},readline:{package:"node",module:"readline",path:"node/readline.d.ts"},stream:{package:"node",module:"stream",path:"node/stream.d.ts"},string_decoder:{package:"node",module:"string_decoder",path:"node/string_decoder.d.ts"},timers:{package:"node",module:"timers",path:"node/timers.d.ts"},tls:{package:"node",module:"tls",path:"node/tls.d.ts"},trace_events:{package:"node",module:"trace_events",path:"node/trace_events.d.ts"},tty:{package:"node",module:"tty",path:"node/tty.d.ts"},url:{package:"node",module:"url",path:"node/url.d.ts"},util:{package:"node",module:"util",path:"node/util.d.ts"},v8:{package:"node",module:"v8",path:"node/v8.d.ts"},vm:{package:"node",module:"vm",path:"node/vm.d.ts"},wasi:{package:"node",module:"wasi",path:"node/wasi.d.ts"},worker_threads:{package:"node",module:"worker_threads",path:"node/worker_threads.d.ts"},zlib:{package:"node",module:"zlib",path:"node/zlib.d.ts"},"node-red":{package:"node-red",module:"node-red",path:"node-red/index.d.ts"},"node-red-util":{package:"node-red",module:"util",path:"node-red/util.d.ts"},"node-red-func":{package:"node-red",module:"func",path:"node-red/func.d.ts"}},a=[n["node-red-util"],n["node-red-func"],n.globals,n.console,n.buffer],r={};function s(e,t,o,i){var a;if(a="object"==typeof e?e:n[e]){const e=a.package,n=a.module,d=a.path,l=r[d];if(l)t||(o.JS[n]=monaco.languages.typescript.javascriptDefaults.addExtraLib(l,"file://types/"+e+"/"+n+"/index.d.ts")),i&&setTimeout((function(){i(null,a)}),5);else{var s="types/"+d;$.get(s).done((function(s){r[d]=s,t||(o.JS[n]=monaco.languages.typescript.javascriptDefaults.addExtraLib(s,"file://types/"+e+"/"+n+"/index.d.ts")),i&&i(null,a)})).fail((function(e){var t="Failed to load '"+s+"'";r[d]="/* "+t+" */\n",i&&i(e,a),console.warn(t)}))}}}function d(e){return!(!e.offsetHeight&&!e.offsetWidth)&&"hidden"!==getComputedStyle(e).visibility}return{get type(){return t},get initialised(){return e},init:function(t){RED.events.on("editor:close",(function(){let e=window.monaco?monaco.editor.getModels():null;if(e&&e.length){console.warn("Cleaning up monaco models left behind. Any node that calls createEditor() should call .destroy().");for(let t=0;t<e.length;t++){const o=e[t];o.isDisposed()||o.dispose()}}})),t=t||{},window.MonacoEnvironment=window.MonacoEnvironment||{},window.MonacoEnvironment.getWorkerUrl=window.MonacoEnvironment.getWorkerUrl||function(e,t){return"json"===t?"./vendor/monaco/dist/json.worker.js":"css"===t||"scss"===t?"./vendor/monaco/dist/css.worker.js":"html"===t||"handlebars"===t?"./vendor/monaco/dist/html.worker.js":"typescript"===t||"javascript"===t?"./vendor/monaco/dist/ts.worker.js":"./vendor/monaco/dist/editor.worker.js"};var n,r=(RED.editor.codeEditor.settings||{}).options||{};try{const e=function(e,t){(t.rules&&Array.isArray(t.rules)||t.colors)&&(o.push(e),monaco.editor.defineTheme(e,t),monaco.editor.setTheme(e),i=e)};if(r.theme)if("object"==typeof r.theme&&RED.settings.editorTheme.theme){let t=r.theme.name||RED.settings.editorTheme.theme;e(t,r.theme)}else if("string"==typeof r.theme){let t=r.theme;o.includes(t)||$.get("vendor/monaco/dist/theme/"+t+".json",(function(o){e(t,o)}))}}catch(e){console.warn(e)}function d(e,t,o,i,n){return Array.isArray(o)&&(o=o.join("\n")),{label:e,kind:null==n?monaco.languages.CompletionItemKind.Snippet:n,documentation:{value:o},insertText:t,insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,range:i}}return function(e){var t=function(e){return[d("dowhile","do {\n\t${2}\n} while (${1:condition});","Do-While Statement (JavaScript Language Basics)",e),d("while","while (${1:condition}) {\n\t${2}\n}","While Statement (JavaScript Language Basics)",e),d("switch",'switch (${1:msg.topic}) {\n\tcase ${2:"value"}:\n\t\t${3}\n\t\tbreak;\n\tdefault:\n\t\t\n}',"Switch Statement (JavaScript Language Basics)",e),d("trycatch","try {\n\t${2}\n} catch (${1:error}) {\n\t\n};","Try-Catch Statement (JavaScript Language Basics)",e),d("for (for loop)","for (let ${1:index} = 0; ${1:index} < ${2:array}.length; ${1:index}++) {\n\tconst element = ${2:array}[${1:index}];\n\t${3}\n}","for loop",e),d("foreach","${1:array}.forEach(function(${2:element}) {\n\t${3}\n});","forEach(callbackfn: (value: T, index: number, array: readonly T[]) => void, thisArg?: any): void\n\nA function that accepts up to three arguments. forEach calls the callbackfn function one time for each element in the array.",e),d("forin","for (${1:prop} in ${2:obj}) {\n\tif (${2:obj}.hasOwnProperty(${1:prop})) {\n\t\t${3}\n\t}\n}","for in",e),d("forof","for (const ${1:iterator} of ${2:object}) {\n\t${3}\n}","for of",e),d("function","function ${1:methodName}(${2:arguments}) {\n\t${3}\n}","Function Declaration",e),d("func (anonymous function)","var ${1:fn} = function(${2:arguments}) {\n\t${3}\n}","Function Expression",e),d("pt (prototype)","${1:ClassName}.prototype.${2:methodName} = function(${3:arguments}) {\n\t${4}\n}","prototype",e),d("iife","(function(${1:arg}) {\n\t${1}\n})(${1:arg});","immediately-invoked function expression",e),d("call (function call)","${1:methodName}.call(${2:context}, ${3:arguments})","function call",e),d("apply (function apply)","${1:methodName}.apply(${2:context}, [${3:arguments}])","function apply",e),d("jsonparse","JSON.parse(${1:json});","JSON.parse",e),d("jsonstringify","JSON.stringify(${1:obj});","JSON.stringify",e),d("setinterval","setInterval(function() {\n\t${2}\n}, ${1:delay});","setInterval",e),d("settimeout","setTimeout(function() {\n\t${2}\n}, ${1:delay});","setTimeout",e),d("node.log",'node.log(${1:"info"});',"Write an info message to the console (not sent to sidebar)",e),d("node.warn",'node.warn(${1:"my warning"});',"Write a warning to the console and debug sidebar",e),d("node.error",'node.error(${1:"my error message"}, ${2:msg});',"Send an error to the console and debug sidebar. To trigger a Catch node on the same tab, the function should call `node.error` with the original message as a second argument",e),d("node.send","node.send(${1:msg});","async send a msg to the next node",e),d("node.send (multiple)","var ${1:msg1} = {payload:${2:1}};\nvar ${3:msg2} = {payload:${4:2}};\nnode.send([[${1:msg1}, ${3:msg2}]]);","send 1 or more messages out of 1 output",e),d("node.send (multiple outputs)","var ${1:msg1} = {payload:${2:1}};\nvar ${3:msg2} = {payload:${4:2}};\nnode.send([${1:msg1}, ${3:msg2}]);","send more than 1 message out of multiple outputs",e),d("node.status",'node.status({fill:"${1|red,green,yellow,blue,grey|}",shape:"${2|ring,dot|}",text:"${3:message}"});',"Set the status icon and text underneath the function node",e),d("get (node context)",'context.get("${1:name}");',"Get a value from node context",e),d("set (node context)",'context.set("${1:name}", ${1:value});',"Set a value in node context",e),d("get (flow context)",'flow.get("${1:name}");',"Get a value from flow context",e),d("set (flow context)",'flow.set("${1:name}", ${1:value});',"Set a value in flow context",e),d("get (global context)",'global.get("${1:name}");',"Get a value from global context",e),d("set (global context)",'global.set("${1:name}", ${1:value});',"Set a value in global context",e),d("get (env)",'env.get("${1|NR_NODE_ID,NR_NODE_NAME,NR_NODE_PATH,NR_GROUP_ID,NR_GROUP_NAME,NR_FLOW_ID,NR_FLOW_NAME|}");',"Get env variable value",e),d("cloneMessage (RED.util)","RED.util.cloneMessage(${1:msg});",["```typescript","RED.util.cloneMessage<T extends registry.NodeMessage>(msg: T): T","```","Safely clones a message object. This handles msg.req/msg.res objects that must not be cloned\n","*@param* `msg` — the msg object\n"],e),d("getObjectProperty (RED.util)","RED.util.getObjectProperty(${1:msg},${2:prop});",["```typescript","RED.util.getObjectProperty(msg: object, expr: string): any;","```","Gets a property of an object\n","*@param* `msg` — the msg object\n","*@param* `prop` — the msg object"],e),d("setObjectProperty (RED.util)","RED.util.setObjectProperty(${1:msg},${2:prop},${3:value},${4:createMissing});",["```typescript","RED.util.setObjectProperty(msg: object, prop: string, value: any, createMissing?: boolean): boolean","```","Sets a property of an object\n","`msg` — the object\n","`prop` — the property expression\n","`value` — the value to set\n","`createMissing` — whether to create missing parent properties"],e),d("getMessageProperty (RED.util)","RED.util.getMessageProperty(${1:msg},${2:prop});",["```typescript","RED.util.getMessageProperty(msg: object, expr: string): any;","```","Gets a property of an object\n","*@param* `msg` — the msg object\n","*@param* `prop` — the msg object"],e),d("setMessageProperty (RED.util)","RED.util.setMessageProperty(${1:msg},${2:prop},${3:value},${4:createMissing});",["```typescript","RED.util.setMessageProperty(msg: object, prop: string, value: any, createMissing?: boolean): boolean","```","Sets a property of an object\n","`msg` — the object\n","`prop` — the property expression\n","`value` — the value to set\n","`createMissing` — whether to create missing parent properties"],e)]};e.languages.registerCompletionItemProvider("javascript",{provideCompletionItems:function(e,o){var i=e.getWordUntilPosition(o),n={startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:i.startColumn,endColumn:i.endColumn};return{suggestions:t(n)}}});try{var o={allowJs:!0,checkJs:!0,allowNonTsExtensions:!0,target:monaco.languages.typescript.ScriptTarget.ESNext,strictNullChecks:!1,strictPropertyInitialization:!0,strictFunctionTypes:!0,strictBindCallApply:!0,useDefineForClassFields:!0,moduleResolution:monaco.languages.typescript.ModuleResolutionKind.NodeJs,module:monaco.languages.typescript.ModuleKind.CommonJS,typeRoots:["types"],lib:["esnext"]},i=RED.settings.get("codeEditor.monaco.languages.typescript.javascriptDefaults.compilerOptions")||{};o=Object.assign({},o,i),e.languages.typescript.javascriptDefaults.setCompilerOptions(o);var n={noSemanticValidation:!1,noSyntaxValidation:!1,diagnosticCodesToIgnore:[1108,1375,1378,2307,2322,2339,2345,7043,80001,80004]},a=RED.settings.get("codeEditor.monaco.languages.typescript.javascriptDefaults.diagnosticsOptions")||{};n=Object.assign({},n,a),e.languages.typescript.javascriptDefaults.setDiagnosticsOptions(n)}catch(e){console.warn("monaco - Error setting javascriptDefaults",e)}}(monaco),(n=monaco).languages.register({id:"jsonata"}),n.languages.setMonarchTokensProvider("jsonata",{defaultToken:"invalid",tokenPostfix:".js",keywords:["function","true","true","null","Infinity","NaN","undefined"].concat(Object.keys(jsonata.functions)),operatorsKeywords:["and","or","in"],operators:["<=",">=","!=","==","!=","=>","+","-","*","/","%",":=","~>","?",":","..","@","#","|","^","*","**"],symbols:/[=><!~?:&|+\-*\/\^%@#]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,regexpctl:/[(){}\[\]\$\^|\-*+?\.]/,regexpesc:/\\(?:[bBdDfnrstvwWn0\\\/]|@regexpctl|c[A-Z]|x[0-9a-fA-F]{2}|u[0-9a-fA-F]{4})/,tokenizer:{root:[[/[{}]/,"delimiter.bracket"],{include:"common"}],common:[[/([a-zA-Z][\w$]*)|([$][\w$]*)/,{cases:{"@keywords":"keyword","@operatorsKeywords":"keyword",$2:"variable","@default":"identifier"}}],[/[$][\w\$]*/,"variable"],{include:"@whitespace"},[/\/(?=([^\\\/]|\\.)+\/([gimsuy]*)(\s*)(\.|;|\/|,|\)|\]|\}|$))/,{token:"regexp",bracket:"@open",next:"@regexp"}],[/[()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/(@symbols)|(\.\.)/,{cases:{"@operators":"operator","@default":""}}],[/(@digits)[eE]([\-+]?(@digits))?/,"number.float"],[/(@digits)\.(@digits)([eE][\-+]?(@digits))?/,"number.float"],[/0[xX](@hexdigits)/,"number.hex"],[/0[oO]?(@octaldigits)/,"number.octal"],[/0[bB](@binarydigits)/,"number.binary"],[/(@digits)/,"number"],[/[?:;,.]/,"delimiter"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],[/`/,"string","@string_backtick"]],whitespace:[[/[ \t\r\n]+/,""],[/\/\*\*(?!\/)/,"comment.doc","@jsdoc"],[/\/\*/,"comment","@comment"],[/\/\/.*$/,"comment"]],comment:[[/[^\/*]+/,"comment"],[/\*\//,"comment","@pop"],[/[\/*]/,"comment"]],jsdoc:[[/[^\/*]+/,"comment.doc"],[/\*\//,"comment.doc","@pop"],[/[\/*]/,"comment.doc"]],regexp:[[/(\{)(\d+(?:,\d*)?)(\})/,["regexp.escape.control","regexp.escape.control","regexp.escape.control"]],[/(\[)(\^?)(?=(?:[^\]\\\/]|\\.)+)/,["regexp.escape.control",{token:"regexp.escape.control",next:"@regexrange"}]],[/(\()(\?:|\?=|\?!)/,["regexp.escape.control","regexp.escape.control"]],[/[()]/,"regexp.escape.control"],[/@regexpctl/,"regexp.escape.control"],[/[^\\\/]/,"regexp"],[/@regexpesc/,"regexp.escape"],[/\\\./,"regexp.invalid"],[/(\/)([gimsuy]*)/,[{token:"regexp",bracket:"@close",next:"@pop"},"keyword.other"]]],regexrange:[[/-/,"regexp.escape.control"],[/\^/,"regexp.invalid"],[/@regexpesc/,"regexp.escape"],[/[^\]]/,"regexp"],[/\]/,{token:"regexp.escape.control",next:"@pop",bracket:"@close"}]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],string_backtick:[[/\$\{/,{token:"delimiter.bracket",next:"@bracketCounting"}],[/[^\\`$]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/`/,"string","@pop"]],bracketCounting:[[/\{/,"delimiter.bracket","@bracketCounting"],[/\}/,"delimiter.bracket","@pop"],{include:"common"}]}}),n.languages.setLanguageConfiguration("jsonata",{comments:{lineComment:"//",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:"'",close:"'",notIn:["string","comment"]},{open:'"',close:'"',notIn:["string"]}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"},{open:"<",close:">"}],folding:{markers:{start:new RegExp("^\\s*//\\s*(?:(?:#?region\\b)|(?:<editor-fold\\b))"),end:new RegExp("^\\s*//\\s*(?:(?:#?endregion\\b)|(?:</editor-fold>))")}}}),n.languages.registerCompletionItemProvider("jsonata",{provideCompletionItems:function(e,t){var o=e.getWordUntilPosition(t);if(o){var i=o.startColumn;"$"!==o.word[0]&&t.column>1&&i--;var n={startLineNumber:t.lineNumber,endLineNumber:t.lineNumber,startColumn:i,endColumn:o.endColumn},a=Object.keys(jsonata.functions),r=a.map((function(e){var t=e+"("+RED._("jsonata:"+e+".args",{defaultValue:""})+")",o=RED._("jsonata:"+e+".desc",{defaultValue:""});return d(e,(jsonata.getFunctionSnippet(e)+"").trim(),{value:"`"+t+"`\n\n"+o},n,monaco.languages.CompletionItemKind.Function)}));return a.sort((function(e,t){return t.length-e.length})),r.unshift(d("randominteger","(\n\t\\$minimum := ${1:1};\n\t\\$maximum := ${2:10};\n\t\\$round((\\$random() * (\\$maximum-\\$minimum)) + \\$minimum, 0)\n)","Random integer between 2 numbers",n)),{suggestions:r}}}}),n.languages.registerHoverProvider("jsonata",{provideHover:function(e,t){var o=e.getWordAtPosition(t),i=o&&o.word;if(i&&"$"!==i[0]&&t.column>1){i="$"+i;var n=RED._("jsonata:"+i+".args",{defaultValue:""});if(n){var a=i+"("+n+")",r=RED._("jsonata:"+i+".desc",{defaultValue:""});return{range:new monaco.Range(t.lineNumber,t.column,t.lineNumber,t.column+o.word.length),contents:[{value:"**`"+a+"`**"},{value:r}]}}}}}),function(e){try{var t=RED.settings.get("codeEditor.monaco.languages.json.jsonDefaults.diagnosticOptions"),o=RED.settings.get("codeEditor.monaco.languages.json.jsonDefaults.modeConfiguration");t=Object.assign({},{validate:!0},t||{}),e.languages.json.jsonDefaults.setDiagnosticsOptions(t),o&&e.languages.json.jsonDefaults.setModeConfiguration(o)}catch(e){console.warn("monaco - Error setting up json options",err)}}(monaco),function(e){try{var t=RED.settings.get("codeEditor.monaco.languages.css.cssDefaults.diagnosticsOptions"),o=RED.settings.get("codeEditor.monaco.languages.css.lessDefaults.diagnosticsOption"),i=RED.settings.get("codeEditor.monaco.languages.css.scssDefaults.diagnosticsOption"),n=RED.settings.get("codeEditor.monaco.languages.css.cssDefaults.modeConfiguration"),a=RED.settings.get("codeEditor.monaco.languages.css.lessDefaults.modeConfiguration"),r=RED.settings.get("codeEditor.monaco.languages.css.scssDefaults.modeConfiguration");t&&e.languages.css.cssDefaults.setDiagnosticsOptions(t),o&&e.languages.css.cssDefaults.setDiagnosticsOptions(o),i&&e.languages.css.cssDefaults.setDiagnosticsOptions(i),n&&e.languages.css.cssDefaults.setDiagnosticsOptions(n),a&&e.languages.css.cssDefaults.setDiagnosticsOptions(a),r&&e.languages.css.cssDefaults.setDiagnosticsOptions(r)}catch(e){console.warn("monaco - Error setting up CSS/SCSS/LESS options",err)}}(monaco),function(e){try{var t=RED.settings.get("codeEditor.monaco.languages.html.htmlDefaults.options"),o=RED.settings.get("codeEditor.monaco.languages.html.handlebarDefaults.options");t&&e.languages.html.htmlDefaults.setOptions(t),o&&e.languages.html.handlebarDefaults.setOptions(o)}catch(e){console.warn("monaco - Error setting up html options",err)}}(monaco),a.forEach((function(e){s(e,!0)})),e=!0},create:function(e){var r,l=RED.editor.codeEditor.settings||{},c={JS:{},TS:{}},u=function(e,t){return{id:"set-theme-"+e,label:RED._("monaco.setTheme")+" "+e,precondition:null,keybindingContext:t||null,run:function(t){return t.setTheme(e),null}}},p=function(e){switch("object"==typeof e&&e.path&&(e=e.path),e=e?e.replace("ace/mode/",""):"text"){case"nrjavascript":case"mjs":e="javascript";break;case"vue":e="html";break;case"appcache":case"sh":case"bash":e="shell";break;case"batchfile":e="bat";break;case"protobuf":e="proto"}return e};e.stateId||!1===e.stateId||(e.stateId=RED.editor.generateViewStateId("monaco",e,(e.mode||e.title||"").split("/").pop()));var f=e.element||$("#"+e.id)[0],h=$("<div>").appendTo(f);f=$("<div>").appendTo(f).addClass("red-ui-editor-text-container")[0];var g=$.extend({},l.options,e);if(g.language=p(e.mode),i&&(g.theme=i),"javascript"==g.language&&(g._language=g.language,g.language="text"),g.minimap||(g.minimap={enabled:!0,maxColumn:50,scale:1,showSlider:"mouseover",renderCharacters:!0}),!1===e.enableBasicAutocompletion&&(g.showSnippets=!1,g.quickSuggestions=!1,g.parameterHints={enabled:!1},g.suggestOnTriggerCharacters=!1,g.acceptSuggestionOnEnter="off",g.tabCompletion="off",g.wordBasedSuggestions=!1),!1===e.enableSnippets&&(g.showSnippets=!1),null==g.mouseWheelZoom&&(g.mouseWheelZoom=!0),null==g.suggestFontSize&&(g.suggestFontSize=12),null==g.formatOnPaste&&(g.formatOnPaste=!0),null==g.foldingHighlight&&(g.foldingHighlight=!0),null==g.foldStyle&&(g.foldStyle=!0),null!=g.readOnly&&(g.readOnly=g.readOnly),!1===g.lineNumbers&&(g.lineNumbers=!1),null==g.theme&&(g.theme=o[0]),null==g.mode&&(g.mode=p(e.mode)),null==g.automaticLayout&&(g.automaticLayout=!0),e.foldStyle)if("none"===e.foldStyle)g.foldStyle=!1,g.foldingHighlight=!1;else g.foldStyle=!0,g.foldingHighlight=!0;else g.foldStyle=!0,g.foldingHighlight=!0;g.roundedSelection=!1!==g.roundedSelection,g.contextmenu=!1!==g.contextmenu,g.snippetSuggestions=!1!==g.enableSnippets,g.value=e.value||"",g.wordSeparators||"jsonata"!=g.language&&"json"!=g.language&&"javascript"!=g.language||(g.wordSeparators="`~!@#%^&*()-=+[{]}|;:'\",.<>/?"),g.fixedOverflowWidgets=!1!==g.fixedOverflowWidgets;var v=RED.utils.getBrowserInfo();(v.mobile||v.tablet)&&(g.minimap={enabled:!1},g.formatOnType=!1,g.formatOnPaste=!1,g.disableMonospaceOptimizations=!0,g.columnSelection=!1,g.matchBrackets="never",g.maxTokenizationLineLength=1e4,g.stopRenderingLineAfter=2e3,g.roundedSelection=!1,g.trimAutoWhitespace=!1,g.parameterHints={enabled:!1},g.suggestOnTriggerCharacters=!1,g.wordBasedSuggestions=!1,g.suggest={maxVisibleSuggestions:6},!g.accessibilitySupport&&v.android&&(g.accessibilitySupport="off"));var m=!1;null==e.clientSideSuggestions&&((e.mode+"").indexOf("nrjavascript")>=0||e.globals&&(e.globals.RED||e.globals.Buffer))&&(m=!0);var b=monaco.languages.typescript.javascriptDefaults.getCompilerOptions();function y(e){var t=[],o=[];const i="extraModuleLibs/index.d.ts",a="file://types/extraModuleLibs/index.d.ts";if(e&&0!=e.length){var r=[];Array.prototype.push.apply(r,e);var d={};for(let i=0;i<e.length;i++){const a=e[i],r=a.var,s=a.module;r&&s&&(o.push("import "+r+"_import = require('"+s+"');\n"),t.push("var "+r+": typeof "+r+"_import;\n"));var l=n[s];d[s]=l||{package:"other",module:s,path:"other/"+s+".d.ts"}}Object.values(d).forEach((function(e){s(e,!1,c,(function(e,n){if(0==(r=r.filter((function(e){return e.module!=n.module}))).length){var s=o.join("")+("\ndeclare global {\n"+t.join("")+"\n}");setTimeout((function(){c.JS[i]=monaco.languages.typescript.javascriptDefaults.addExtraLib(s,a)}),500)}}))}))}else c.JS[i]=monaco.languages.typescript.javascriptDefaults.addExtraLib(" ",a)}m?(b.lib=["esnext"],a.forEach((function(e){s(e,!1,c)}))):b.lib=["esnext","dom"],monaco.languages.typescript.javascriptDefaults.setCompilerOptions(b),y(g.extraLibs);var w=monaco.editor.create(f,g);try{w._standaloneKeybindingService.addDynamicKeybinding("-editor.action.insertLineAfter",null,(()=>{}))}catch(e){}w.nodered={refreshModuleLibs:y};for(var E=0;E<o.length;E++){var D=o[E];w.addAction(u(D))}function R(e,t,o){e.getOption(monaco.editor.EditorOptions.readOnly.id)?e.getModel().pushEditOperations(e.getSelections(),t,(function(){return o||null})):e.executeEdits("editor",t)}function x(e,t,o){t=t||50,e?(w.focusMemory&&setTimeout((function(){o.parentElement&&w.focus()}),300),w._initState&&setTimeout((function(){o.parentElement&&(w.restoreViewState(w._initState),w._initState=null)}),t),"javascript"==w._mode&&"text"==w._tempMode&&(w._tempMode="",setTimeout((function(){o.parentElement&&w.setMode("javascript",void 0,!1)}),t))):"javascript"==w._mode&&"text"!=w._tempMode&&o.parentElement&&(w.setMode("text",void 0,!1),w._tempMode="text")}if(w.selection={},w.session=w,w.renderer={},w.setMode=function(e,t,o){null==o&&(o=!0),e=p(e);var i,n=w.getModel(),a=w.getValue();if(n){var r=w.getScrollTop(),s=w.getScrollLeft(),d=w.getSelections(),l=w.getPosition();a=n.getValue()||"";try{n.isDisposed()||n.dispose()}catch(e){}w.setModel(null),i=monaco.editor.createModel(a||"",e),w.setModel(i),w.setScrollTop(r,1),w.setScrollLeft(s,1),w.setPosition(l),w.setSelections(d)}else i=monaco.editor.createModel(a||"",e),w.setModel(i);t&&"function"==typeof t&&t(),o&&this.resize()},w.getRange=function(){var e=w.getSelection();return e.start={row:e.selectionStartLineNumber-1,column:e.selectionStartColumn-1},e.end={row:e.endLineNumber-1,column:e.endColumn-1},e},w.selection.getRange=w.getRange,w.session.insert=function(e,t){R(this,[{range:new monaco.Range(e.row+1,e.column+1,e.row+1,e.column+1),text:t,forceMoveMarkers:!0}])},w.setReadOnly=function(e){w.updateOptions({readOnly:e})},w.session.replace=function(e,t){R(this,[{range:e,text:t,forceMoveMarkers:!0}])},w.selectAll=function(){const e=w.getModel().getFullModelRange();w.setSelection(e)},w.clearSelection=function(){w.setPosition({column:1,lineNumber:1})},w.getSelectedText=function(){return w.getModel().getValueInRange(w.getSelection())},w.insertSnippet=function(e){w.getContribution("snippetController2").insert(e)},w.destroy=function(){r&&clearInterval(r);try{if(Object.keys(c.JS).length){let e=Object.entries(c.JS);for(let t=0;t<e.length;t++)try{let o=e[t][0];c.JS[o].dispose(),c.JS[o]=null,delete c.JS[o]}catch(e){}}if(Object.keys(c.TS).length){let e=Object.entries(c.TS);for(let t=0;t<e.length;t++)try{let o=e[t][0];c.TS[o].dispose(),c.TS[o]=null,delete c.TS[o]}catch(e){}}}catch(e){}try{var e=this.getModel();e&&!e.isDisposed()&&(w._initState=null,e.dispose()),this.setModel(null)}catch(e){}$(f).remove(),$(h).remove()},w.resize=function(){w.layout()},w.renderer.updateFull=w.resize.bind(w),w.getSession=function(){return w},w.getLength=function(){var e=w.getModel();return null!==e?e.getLineCount():0},w.scrollToLine=function(e,t){w.revealLine(e,t)},w.moveCursorTo=function(e,t){w.setPosition({lineNumber:e,column:t})},w.getAnnotations=function(){var e=[];try{var t=w.getModel();if(null!==t){var o=t._languageId,i=t._associatedResource.authority,n=t._associatedResource.path,a=t._associatedResource.scheme;e=(monaco.editor.getModelMarkers(t)||[]).filter((function(e){var t=e.resource.authority,r=e.resource.path,s=e.resource.scheme;return e.owner==o&&t===i&&r===n&&s===a})).map((function(e){return{row:e.startLineNumber,column:e.startColumn,endColumn:e.endColumn,endRow:e.endLineNumber,text:e.message,type:monaco.MarkerSeverity[e.severity]?monaco.MarkerSeverity[e.severity].toLowerCase():e.severity}}))}}catch(e){console.log("Failed to get editor Annotations",e)}return e||[]},w.gotoLine=function(e,t){w.setPosition({lineNumber:e+1,column:t+1})},w.getCursorPosition=function(){var e=w.getPosition();return{row:e.lineNumber-1,column:e.column-1}},w.setTheme=function(e){monaco.editor.setTheme(e),i=e},w.on=function(e,t){switch(e){case"change":case"input":e="onDidChangeModelContent";break;case"focus":e="onDidFocusEditorWidget";break;case"blur":e="onDidBlurEditorWidget";break;case"paste":e="onDidPaste"}var o;if(w[e])o=w[e];else{if(!monaco.editor[e])return void console.warn("monaco - unknown event: "+e);o=monaco.editor[e]}o(t)},w.getUndoManager=function(){var e={};return e.isClean=function(){try{return!1===w.getModel().canUndo()}catch(e){return!1}}.bind(w),e},w.setFontSize=function(e){w.updateOptions({fontSize:e})},w.focusMemory=e.focus,w._mode=g.language,g._language&&(w._mode=g._language,w._tempMode=g.language),w.onDidBlurEditorWidget((function(){w.focusMemory=!1,w.saveView(),0==d(f)&&x(!1,0,f)})),w.onDidFocusEditorWidget((function(){x(!0,10,f)})),function(e,t){try{var o={root:$(e).closest("div.red-ui-tray-content")[0]||document,attributes:!0,childList:!0};new IntersectionObserver((function(e,o){e.forEach((function(e){t(e.intersectionRatio>0,5,e.target)}))}),o).observe(e)}catch(o){try{let o=d(f);r=setInterval((function(){let i=d(f);i!=o&&t(i,5,e),o=i}),100)}catch(e){}}}(f,x),"markdown"===g.language){if($(f).addClass("red-ui-editor-text-container-toolbar"),w.toolbar=RED.editor.customEditTypes._markdown.buildToolbar(h,w),!1!==e.expandable){var _=$('<button type="button" class="red-ui-button" style="float: right;"><i class="fa fa-expand"></i></button>').appendTo(w.toolbar);RED.popover.tooltip(_,RED._("markdownEditor.expand")),_.on("click",(function(t){t.preventDefault();var o=w.getValue();w.saveView(),RED.editor.editMarkdown({value:o,width:"Infinity",stateId:e.stateId,cancel:function(){w.focus()},complete:function(e,t){w.setValue(e,-1),setTimeout((function(){w.focus(),w.restoreView()}),300)}})}))}var k=$('<button type="button" class="red-ui-editor-text-help red-ui-button red-ui-button-small"><i class="fa fa-question"></i></button>').appendTo($(f).parent());RED.popover.create({target:k,trigger:"click",size:"small",direction:"left",content:RED._("markdownEditor.format"),autoClose:50})}if(w.getView=function(){return w.saveViewState()},w.saveView=function(t){if(e.stateId){window._editorStateMonaco=window._editorStateMonaco||{};var o=w.getView();return window._editorStateMonaco[e.stateId]=o,o}},w.restoreView=function(t){if(e.stateId){window._editorStateMonaco=window._editorStateMonaco||{};var o=t||window._editorStateMonaco[e.stateId];if(o)try{w.type?w.restoreViewState(o):w._initState=o}catch(t){delete window._editorStateMonaco[e.stateId]}}},w.restoreView(),e.cursor&&!w._initState){var T=e.cursor.row||e.cursor.lineNumber,C=e.cursor.column||e.cursor.col;w.gotoLine(T,C)}return w.type=t,w}}}(),RED.eventLog=function(){var e,t=[],o=!1;return{init:function(){$('<script type="text/x-red" data-template-name="_eventLog"><div class="form-row node-text-editor-row"><div style="height: 100%;min-height: 150px;" class="node-text-editor" id="red-ui-event-log-editor"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.actions.add("core:show-event-log",RED.eventLog.show)},show:function(){if(!o){o=!0;var i={title:RED._("eventLog.title"),width:1/0,buttons:[{id:"node-dialog-close",text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(t){for(var o=$("#dialog-form>div:not(.node-text-editor-row)"),i=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<o.size();n++)i-=$(o[n]).outerHeight(!0);i-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",i+"px"),e.resize()},open:function(o){o.find(".red-ui-tray-body");var i=RED.editor.buildEditForm(o.find(".red-ui-tray-body"),"dialog-form","_eventLog","editor");e=RED.editor.createEditor({mode:"ace/mode/shell",id:"red-ui-event-log-editor",value:t.join("\n"),lineNumbers:!1,readOnly:!0,options:{showPrintMargin:!1}}),setTimeout((function(){e.scrollToLine(e.getSession().getLength())}),200),i.i18n()},close:function(){e.destroy(),e=null,o=!1},show:function(){}};RED.tray.show(i)}},log:function(o,i){var n=new Date(i.ts).toISOString()+" ";if(i.type&&(n+="["+i.type+"] "),i.data){var a=i.data;a.endsWith("\n")&&(a=a.substring(0,a.length-1)),a.split(/\n/).forEach((function(o){!function(o){t.push(o),t.length>500&&(t=t.slice(-500)),e&&(e.getSession().insert({row:e.getSession().getLength(),column:0},"\n"+o),e.scrollToLine(e.getSession().getLength()))}(n+o)}))}},startEvent:function(e){t.push(""),t.push("-----------------------------------------------------------"),t.push((new Date).toISOString()+" "+e),t.push("")}}}(),RED.tray=function(){var e,t=[],o=!1,i=!1;function n(i){var n=$('<div class="red-ui-tray"></div>'),s=$('<div class="red-ui-tray-header editor-tray-header"></div>').appendTo(n),d=$('<div class="red-ui-tray-body-wrapper"></div>').appendTo(n),l=$('<div class="red-ui-tray-body editor-tray-body"></div>').appendTo(d),c=$('<div class="red-ui-tray-footer"></div>').appendTo(n),u=$('<div class="red-ui-tray-resize-handle"></div>').appendTo(n);if(i.title){var p=t.map((function(e){return e.options.title}));p.push(i.title);var f='<ul class="red-ui-tray-breadcrumbs"><li>'+p.join("</li><li>")+"</li></ul>";$('<div class="red-ui-tray-titlebar">'+f+"</div>").appendTo(s)}i.width===1/0&&(i.maximized=!0,u.addClass("red-ui-tray-resize-maximised"));var h,g=$('<div class="red-ui-tray-toolbar"></div>').appendTo(s);if(i.buttons)for(var v=0;v<i.buttons.length;v++){var m=i.buttons[v],b=$("<button>").button().appendTo(g);m.id&&b.attr("id",m.id),m.text&&b.text(m.text),m.click&&b.on("click",function(e){return function(t){$(this).hasClass("disabled")||e(t)}}(m.click)),m.class&&(b.addClass(m.class),"primary"===m.class&&(h=m))}n.appendTo(e);var y={tray:n,header:s,body:l,footer:c,options:i,primaryButton:h};function w(){$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),y.preferredWidth=Math.max(n.width(),500),i.maximized||l.css({minWidth:y.preferredWidth-40}),i.width?(i.width>$("#red-ui-editor-stack").position().left-8&&(i.width=$("#red-ui-editor-stack").position().left-8),n.width(i.width)):n.width(y.preferredWidth),y.width=n.width(),y.width>$("#red-ui-editor-stack").position().left-8&&(y.width=Math.max(0,$("#red-ui-editor-stack").position().left-8),n.width(y.width)),$("#red-ui-main-container").scrollLeft(0),n.css({right:-(n.width()+10)+"px",transition:"right 0.25s ease"}),a(),o=!0,setTimeout((function(){setTimeout((function(){i.width||n.width(Math.min(y.preferredWidth,$("#red-ui-editor-stack").position().left-8)),i.resize&&i.resize({width:n.width()}),i.show&&i.show(),setTimeout((function(){o=!1,r(),a()}),200),i.hasOwnProperty("focusElement")?!1!==i.focusElement&&$(i.focusElement).trigger("focus"):l.find(":focusable:first").trigger("focus")}),150),n.css({right:0})}),0)}t.push(y),i.maximized||n.draggable({handle:u,axis:"x",start:function(e,t){n.width("auto")},drag:function(t,o){var i=e.position().left+o.position.left;i<7?o.position.left+=7-i:o.position.left>-y.preferredWidth-1&&(o.position.left=-Math.min(e.position().left-7,y.preferredWidth-1)),y.options.resize&&setTimeout((function(){y.options.resize({width:-o.position.left})}),0),y.width=-o.position.left},stop:function(e,t){n.width(-t.position.left),n.css({left:""}),y.options.resize&&y.options.resize({width:-t.position.left}),y.width=-t.position.left}}),i.open?1===i.open.length?(i.open(n),w()):i.open(n,w):w()}function a(){if(t.length>0){var e=t[t.length-1];e.options.maximized||e.width>$("#red-ui-editor-stack").position().left-8?(e.width=$("#red-ui-editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#red-ui-editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width));var o=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight();e.body.height(o),e.options.resize&&e.options.resize({width:e.width,height:o})}}function r(){setTimeout((function(){$("#red-ui-editor-stack").css("zIndex","13")}),300)}function s(){$("#red-ui-editor-stack").css("zIndex","9")}return{init:function(){e=$("#red-ui-editor-stack"),$(window).on("resize",a),RED.events.on("sidebar:resize",a),$("#red-ui-editor-shade").on("click",(function(){if(!o){var e=t[t.length-1];e&&e.primaryButton&&e.primaryButton.click()}}))},show:function(e){if(s(),e){if(i)throw new Error("Cannot add to stack whilst hidden");if(t.length>0&&!e.overlay){var o=t[t.length-1];"inherit"===e.width&&(e.width=o.tray.width()),o.tray.css({right:-(o.tray.width()+10)+"px"}),setTimeout((function(){o.tray.detach(),n(e)}),250)}else t.length>0&&t[t.length-1].tray.css("z-index",0),RED.events.emit("editor:open"),n(e)}else{if(t.length>0)t[t.length-1].tray.css({right:0}),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),i=!1}},hide:function(){if(s(),t.length>0){var e=t[t.length-1];e.tray.css({right:-(e.tray.width()+10)+"px"}),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),i=!0}},resize:a,close:function(e){if(s(),t.length>0){var o=t.pop();o.tray.css({right:-(o.tray.width()+10)+"px"}),setTimeout((function(){try{o.options.close&&o.options.close()}catch(e){}if(o.tray.remove(),t.length>0){var i=t[t.length-1];i.options.overlay?(a(),i.options.show&&i.options.show()):(i.tray.appendTo("#red-ui-editor-stack"),setTimeout((function(){a(),i.tray.css({right:0}),i.options.show&&(r(),a(),i.options.show())}),0))}e&&e(),0===t.length?($("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus()):t[t.length-1].tray.css("z-index","auto")}),250)}}}}(),RED.clipboard=function(){var e,t,o,i,n,a,r,s,d,l,c=!1,u={};function p(){e=$('<div id="red-ui-clipboard-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:700,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{id:"red-ui-clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close"),RED.view.focus()}},{id:"red-ui-clipboard-dialog-download",class:"primary",text:RED._("clipboard.download"),click:function(){!function(e,t){if(window.navigator.msSaveBlob){var o=new Blob([t],{type:"data:text/plain;charset=utf-8"});navigator.msSaveBlob(o,e)}else{var i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),i.setAttribute("download",e),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}("flows.json",$("#red-ui-clipboard-dialog-export-text").val()),$(this).dialog("close"),RED.view.focus()}},{id:"red-ui-clipboard-dialog-export",class:"primary",text:RED._("clipboard.export.copy"),click:function(){if("red-ui-clipboard-dialog-export-tab-clipboard"===r){var t=$("#red-ui-clipboard-dialog-export-text").val();$(this).dialog("close"),w(t),RED.notify(RED._("clipboard.nodesExported"),{id:"clipboard"}),RED.view.focus()}else{var o=$("#red-ui-clipboard-dialog-export-text").val(),i=u[r].getSelected();i.children||(i=i.parent);var n=$("#red-ui-clipboard-dialog-tab-library-name").val().trim(),a=function(){$.ajax({url:"library/"+i.library+"/"+i.type+"/"+i.path+n,type:"POST",data:o,contentType:"application/json; charset=utf-8"}).done((function(){$(e).dialog("close"),RED.view.focus(),RED.notify(RED._("library.exportedToLibrary"),"success")})).fail((function(e,t,o){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}))};if(i.children){var s=!1;if(i.children.forEach((function(e){e.label===n&&(s=!0)})),s){e.dialog("close");var d=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(n)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){d.hideNotification(),e.dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){d.hideNotification(),a()}}]})}else a()}else a()}}},{id:"red-ui-clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){var e="red-ui-clipboard-dialog-import-opt-new"===$("#red-ui-clipboard-dialog-import-opt > a.selected").attr("id");if("red-ui-clipboard-dialog-import-tab-clipboard"===r)E($("#red-ui-clipboard-dialog-import-text").val(),e);else{var t=u[r].getSelected();t.path&&$.get("library/"+t.library+"/"+t.type+"/"+t.path,(function(t){E(t,e)}))}$(this).dialog("close"),RED.view.focus()}},{id:"red-ui-clipboard-dialog-import-conflict",class:"primary",text:RED._("clipboard.import.importSelected"),click:function(){var e={};$('#red-ui-clipboard-dialog-import-conflicts-list input[type="checkbox"]').each((function(){e[$(this).attr("data-node-id")]=this.checked?"import":"skip"})),$('.red-ui-clipboard-dialog-import-conflicts-controls input[type="checkbox"]').each((function(){$(this).attr("disabled")||(e[$(this).attr("data-node-id")]=this.checked?"replace":"copy")})),s.importOptions.importMap=e;var t=s.importNodes.filter((function(t){return e[t.id]&&!e[t.z]||(e[t.id]=e[t.z]),"skip"!==e[t.id]}));RED.view.importNodes(t,s.importOptions),$(this).dialog("close"),RED.view.focus()}}],open:function(e,t){RED.keyboard.disable()},close:function(e){RED.keyboard.enable(),n&&(n.close(!0),a=null)}}),t=e.children(".dialog-form"),o='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="common.label.export"></label><span id="red-ui-clipboard-dialog-export-rng-group" class="button-group"><a id="red-ui-clipboard-dialog-export-rng-selected" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="red-ui-clipboard-dialog-export-rng-flow" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-export-rng-full" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="red-ui-clipboard-dialog-box"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-export-tabs"></ul></div><div id="red-ui-clipboard-dialog-export-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-export-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div id="red-ui-clipboard-dialog-export-tab-clipboard-tab-bar"><ul id="red-ui-clipboard-dialog-export-tab-clipboard-tabs"></ul></div><div class="red-ui-clipboard-dialog-export-tab-clipboard-tab" id="red-ui-clipboard-dialog-export-tab-clipboard-preview"><div id="red-ui-clipboard-dialog-export-tab-clipboard-preview-list"></div></div><div class="red-ui-clipboard-dialog-export-tab-clipboard-tab" id="red-ui-clipboard-dialog-export-tab-clipboard-json"><div class="form-row" style="height:calc(100% - 40px)"><textarea readonly id="red-ui-clipboard-dialog-export-text"></textarea></div><div class="form-row" style="text-align: right;"><span id="red-ui-clipboard-dialog-export-fmt-group" class="button-group"><a id="red-ui-clipboard-dialog-export-fmt-mini" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="red-ui-clipboard-dialog-export-fmt-full" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div></div></div><div class="form-row" id="red-ui-clipboard-dialog-export-tab-library-filename"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-clipboard-dialog-tab-library-name" type="text"></div></div></div>',i='<div class="red-ui-clipboard-dialog-box" style="margin-bottom: 12px"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-import-tabs"></ul></div><div id="red-ui-clipboard-dialog-import-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-import-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div class="form-row"><span data-i18n="clipboard.pasteNodes"></span> <a class="red-ui-button" id="red-ui-clipboard-dialog-import-file-upload-btn"><i class="fa fa-upload"></i> <span data-i18n="clipboard.selectFile"></span></a><input type="file" id="red-ui-clipboard-dialog-import-file-upload" accept=".json" style="display:none"></div><div class="form-row" style="height:calc(100% - 47px)"><textarea id="red-ui-clipboard-dialog-import-text"></textarea></div></div></div></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="red-ui-clipboard-dialog-import-opt" class="button-group"><a id="red-ui-clipboard-dialog-import-opt-current" class="red-ui-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-import-opt-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',importConflictsDialog='<div class="form-row"><div class="form-row"><p data-i18n="clipboard.import.conflictNotification1"></p><p data-i18n="clipboard.import.conflictNotification2"></p></div><div class="red-ui-clipboard-dialog-import-conflicts-list-container"><div id="red-ui-clipboard-dialog-import-conflicts-list"></div></div></div>'}function f(){d&&clearTimeout(d),d=setTimeout((function(){var e=$("#red-ui-clipboard-dialog-tab-library-name"),t=e.val().trim();t.length>0&&!/[\/\\]/.test(t)?(e.removeClass("input-error"),$("#red-ui-clipboard-dialog-export").button("enable")):(e.addClass("input-error"),$("#red-ui-clipboard-dialog-export").button("disable"))}),100)}function h(){if("red-ui-clipboard-dialog-import-tab-clipboard"===r)l&&clearTimeout(l),l=setTimeout((function(){var e=$("#red-ui-clipboard-dialog-import-text"),t=e.val().trim();if(""===t)return n.close(!0),a=null,e.removeClass("input-error"),void $("#red-ui-clipboard-dialog-ok").button("disable");try{if(!/^\[[\s\S]*\]$/m.test(t))throw new Error(RED._("clipboard.import.errors.notArray"));for(var o=JSON.parse(t),i=0;i<o.length;i++){if("object"!=typeof o[i])throw new Error(RED._("clipboard.import.errors.itemNotObject",{index:i}));if(!o[i].hasOwnProperty("id"))throw new Error(RED._("clipboard.import.errors.missingId",{index:i}));if(!o[i].hasOwnProperty("type"))throw new Error(RED._("clipboard.import.errors.missingType",{index:i}))}a=null,n.close(!0),e.removeClass("input-error"),e.val(t),$("#red-ui-clipboard-dialog-ok").button("enable")}catch(o){if(""!==t){e.addClass("input-error");var r=o.toString();if(r!==a){var s,d=$('<div class="red-ui-clipboard-import-error"></div>').text(r),l=/at position (\d+)/i.exec(r);if(l)s=parseInt(l[1]);else if(l=/at line (\d+) column (\d+)/i.exec(r)){var c=parseInt(l[1])-1,u=parseInt(l[2])-1,p=t.split("\n");s=0;for(i=0;i<c;i++)s+=p[i].length+1;s+=u}if(void 0!==s){t=t.replace(/\n/g,"↵");parseInt(l[1]);var f=$("<div>").appendTo(d),h=$("<pre>").appendTo(f);$("<span>").text(t.substring(s-12,s)).appendTo(h),$('<span class="error">').text(t.charAt(s)).appendTo(h),$("<span>").text(t.substring(s+1,s+12)).appendTo(h)}n.close(!0).setContent(d).open(),a=r}}else a=null;$("#red-ui-clipboard-dialog-ok").button("disable")}}),100);else{var e=u[r].getSelected();e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")}}function g(o){if(!c){o=o||"clipboard",t.empty(),t.append($(i));var s=RED.tabs.create({id:"red-ui-clipboard-dialog-import-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-import-tabs-content").children().hide(),$("#"+e.id).show(),r=e.id,n&&(n.close(!0),a=null),"red-ui-clipboard-dialog-import-tab-clipboard"===e.id?$("#red-ui-clipboard-dialog-import-text").trigger("focus"):u[e.id].focus(),h()}});s.addTab({id:"red-ui-clipboard-dialog-import-tab-clipboard",label:RED._("clipboard.clipboard")}),(RED.settings.libraries||[]).forEach((function(e){var t="red-ui-clipboard-dialog-import-tab-"+e.id;s.addTab({id:t,label:RED._(e.label||e.id)});var o=$('<div id="red-ui-clipboard-dialog-import-tab-library" class="red-ui-clipboard-dialog-tab-library"></div>').attr("id",t).hide().appendTo("#red-ui-clipboard-dialog-import-tabs-content"),i=RED.library.createBrowser({container:o,onselect:function(e){e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")},onconfirm:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-ok").trigger("click")}});b(i,e),u[t]=i})),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",f),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",(function(){setTimeout(f,10)})),$("#red-ui-clipboard-dialog-export").button("enable"),t.i18n(),$("#red-ui-clipboard-dialog-ok").show(),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-import-conflict").hide(),$("#red-ui-clipboard-dialog-ok").button("disable"),$("#red-ui-clipboard-dialog-import-text").on("keyup",h),$("#red-ui-clipboard-dialog-import-text").on("paste",(function(){setTimeout(h,10)})),0===RED.workspaces.active()?($("#red-ui-clipboard-dialog-import-opt-current").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-import-opt-new").addClass("selected")):($("#red-ui-clipboard-dialog-import-opt-current").removeClass("disabled").addClass("selected"),$("#red-ui-clipboard-dialog-import-opt-new").removeClass("selected")),$("#red-ui-clipboard-dialog-import-opt > a").on("click",(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))})),$("#red-ui-clipboard-dialog-import-file-upload").on("change",(function(){var e=new FileReader;e.onload=function(){$("#red-ui-clipboard-dialog-import-text").val(e.result),h()},e.readAsText($(this).prop("files")[0])})),$("#red-ui-clipboard-dialog-import-file-upload-btn").on("click",(function(e){e.preventDefault(),$("#red-ui-clipboard-dialog-import-file-upload").trigger("click")})),s.activateTab("red-ui-clipboard-dialog-import-tab-"+o),"clipboard"===o&&setTimeout((function(){$("#red-ui-clipboard-dialog-import-text").trigger("focus")}),100);var d=400,l=$(window).height();l<600&&(d=400-(600-l)),$(".red-ui-clipboard-dialog-box").height(d),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("option","width",700).dialog("open"),n=RED.popover.create({target:$("#red-ui-clipboard-dialog-import-text"),trigger:"manual",direction:"bottom",content:""})}}function v(i){if(!c){i=i||"clipboard",t.empty(),t.append($(o));var n=RED.tabs.create({id:"red-ui-clipboard-dialog-export-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-export-tabs-content").children().hide(),$("#"+e.id).show(),r=e.id,"red-ui-clipboard-dialog-export-tab-clipboard"===e.id?($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.copy")),$("#red-ui-clipboard-dialog-download").show(),$("#red-ui-clipboard-dialog-export-tab-library-filename").hide()):($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.export")),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-export-tab-library-filename").show(),u[r].focus())}});n.addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard",label:RED._("clipboard.clipboard")}),(RED.settings.libraries||[]).forEach((function(e){if(!e.readOnly){var t="red-ui-clipboard-dialog-export-tab-library-"+e.id;n.addTab({id:t,label:RED._(e.label||e.id)});var o=$('<div class="red-ui-clipboard-dialog-export-tab-library-browser red-ui-clipboard-dialog-tab-library"></div>').attr("id",t).hide().insertBefore("#red-ui-clipboard-dialog-export-tab-library-filename"),i=RED.library.createBrowser({container:o,folderTools:!0,onselect:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-tab-library-name").val(e.label)}});b(i,e),u[t]=i}})),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",f),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",(function(){setTimeout(f,10)})),$("#red-ui-clipboard-dialog-export").button("enable");var a=RED.tabs.create({id:"red-ui-clipboard-dialog-export-tab-clipboard-tabs",onchange:function(e){$(".red-ui-clipboard-dialog-export-tab-clipboard-tab").hide(),$("#"+e.id).show()}});a.addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard-preview",label:RED._("clipboard.exportNodes")}),a.addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard-json",label:RED._("editor.types.json")});$("#red-ui-clipboard-dialog-export-tab-clipboard-preview-list").css({position:"absolute",top:0,right:0,bottom:0,left:0}).treeList({data:[]});m(),$("#red-ui-clipboard-dialog-tab-library-name").val("flows.json").select(),t.i18n();var s=RED.settings.flowFilePretty?"red-ui-clipboard-dialog-export-fmt-full":"red-ui-clipboard-dialog-export-fmt-mini";if($("#red-ui-clipboard-dialog-export-fmt-group > a").on("click",(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#red-ui-clipboard-dialog-export-text").trigger("focus");else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#red-ui-clipboard-dialog-export-text").val();if(t.length>0){var o=JSON.parse(t);t="red-ui-clipboard-dialog-export-fmt-full"===(s=$(this).attr("id"))?JSON.stringify(o,null,4):JSON.stringify(o),$("#red-ui-clipboard-dialog-export-text").val(t),setTimeout((function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0)}),50),$("#red-ui-clipboard-dialog-export-text").trigger("focus")}}})),$("#red-ui-clipboard-dialog-export-rng-group > a").on("click",(function(e){if(e.preventDefault(),!$(this).hasClass("disabled")&&!$(this).hasClass("selected")){$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id").substring("red-ui-clipboard-dialog-export-rng-".length),o="",i=null;if("selected"===t){var n=RED.workspaces.selection();n.length>0?(i=[],n.forEach((function(e){i.push(e),i=(i=i.concat(RED.nodes.groups(e.id))).concat(RED.nodes.filterNodes({z:e.id}))}))):i=RED.view.selection().nodes||[],i=RED.nodes.createExportableNodeSet(i.filter((function(e){return"subflow"!==e.type})))}else if("flow"===t){var a=RED.workspaces.active();i=(i=(i=RED.nodes.groups(a)).concat(RED.nodes.junctions(a))).concat(RED.nodes.filterNodes({z:a})),RED.nodes.eachConfig((function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&i.push(e)}));var r=RED.nodes.workspace(a)||RED.nodes.subflow(a);i.unshift(r),i=RED.nodes.createExportableNodeSet(i)}else"full"===t&&(i=RED.nodes.createCompleteNodeSet(!1));null!==i&&(o="red-ui-clipboard-dialog-export-fmt-full"===s?JSON.stringify(i,null,4):JSON.stringify(i)),o.length>0?$("#red-ui-clipboard-dialog-export").removeClass("disabled"):$("#red-ui-clipboard-dialog-export").addClass("disabled"),$("#red-ui-clipboard-dialog-export-text").val(o),setTimeout((function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0),m(t)}),50)}})),$("#red-ui-clipboard-dialog-ok").hide(),$("#red-ui-clipboard-dialog-cancel").hide(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-import-conflict").hide(),0===RED.workspaces.active())$("#red-ui-clipboard-dialog-export-rng-selected").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-flow").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-full").trigger("click");else{var d=RED.workspaces.selection();d.length>0||(d=RED.view.selection()).nodes?$("#red-ui-clipboard-dialog-export-rng-selected").trigger("click"):($("#red-ui-clipboard-dialog-export-rng-selected").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-flow").trigger("click"))}"red-ui-clipboard-dialog-export-fmt-full"===s?$("#red-ui-clipboard-dialog-export-fmt-full").trigger("click"):$("#red-ui-clipboard-dialog-export-fmt-mini").trigger("click"),n.activateTab("red-ui-clipboard-dialog-export-tab-"+i);var l=400,p=$(window).height();p<600&&(l=400-(600-p)),$(".red-ui-clipboard-dialog-box").height(l),e.dialog("option","title",RED._("clipboard.exportNodes")).dialog("option","width",700).dialog("open"),$("#red-ui-clipboard-dialog-export-text").trigger("focus"),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").show(),$("#red-ui-clipboard-dialog-download").show(),$("#red-ui-clipboard-dialog-import-conflict").hide()}}function m(e){var t=$("#red-ui-clipboard-dialog-export-text").val()||"[]",o=JSON.parse(t),i={},n={},a=[],r=[],s=[];o.forEach((function(t){"tab"===t.type?(i[t.id]={element:x(t),deferBuild:"flow"!==e,expanded:"flow"===e,children:[]},r.push(i[t.id])):"subflow"===t.type?(n[t.id]={element:_(t,!1),deferBuild:!0,children:[]},s.push(n[t.id])):a.push(t)}));var d=[],l=[];a.forEach((function(e){var t={element:_(e,!1)};e.z?i[e.z]||n[e.z]?i[e.z]?i[e.z].children.push(t):n[e.z]&&n[e.z].children.push(t):l.push(t):d.push(t)}));var c=[];l.length>0&&(c=c.concat(l)),"flow"===e?c=c.concat(r):r.length>0&&c.push({label:RED._("menu.label.flows"),deferBuild:r.length>20,expanded:r.length<=20,children:r}),s.length>0&&c.push({label:RED._("menu.label.subflows"),deferBuild:s.length>10,expanded:s.length<=10,children:s}),d.length>0&&c.push({label:RED._("sidebar.info.globalConfig"),deferBuild:d.length>10,expanded:d.length<=10,children:d}),$("#red-ui-clipboard-dialog-export-tab-clipboard-preview-list").treeList("data",c)}function b(e,t){var o="fa fa-hdd-o";if(t.icon){var i=RED.utils.separateIconPath(t.icon);o=("font-awesome"===i.module?"fa ":"")+i.file}e.data([{library:t.id,type:"flows",icon:o,label:RED._(t.label||t.id),path:"",expanded:!0,children:[{library:t.id,type:"flows",icon:"fa fa-cube",label:"flows",path:"",expanded:!0,children:function(e,o){RED.library.loadLibraryFolder(t.id,"flows","",(function(t){o.children=t,e(t)}))}}]}],!0)}function y(){$("#red-ui-drop-target").hide()}function w(e,t,o){var i=!1,n=document.activeElement;"string"!=typeof e&&(e=JSON.stringify(e,(function(e,t){if(null!==t&&"object"==typeof t&&t.__enc__){if(t.hasOwnProperty("data")&&t.hasOwnProperty("length"))return i=t.data.length!==t.length,t.data;if("function"===t.type||"internal"===t.type)return;if("number"===t.type)return null;if("bigint"===t.type)return t.data.toString();if("undefined"===t.type)return}return t}))),i&&(o+="_truncated");var a=$('<textarea type="text" id="red-ui-clipboard-hidden" tabIndex="-1">').appendTo(document.body);a.val(e).focus().select();var r=document.execCommand("copy");if(r&&t){var s=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(o)});setTimeout((function(){s.close()}),1e3),s.open()}return a.remove(),n&&$(n).focus(),r}function E(o,i){var n=o;if("string"==typeof o)try{if(0===(o=o.trim()).length)return;n=JSON.parse(o)}catch(e){var a=new Error(RED._("clipboard.invalidFlow",{message:e.message}));throw a.code="NODE_RED",a}var r={generateIds:!1,addFlow:i};try{RED.view.importNodes(n,r)}catch(o){console.log(o.importConfig),function(o,i,n){var a=RED.notify("<p>"+RED._("clipboard.import.conflictNotification1")+"</p>",{type:"info",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.close()}},{text:RED._("clipboard.import.viewNodes"),click:function(){a.close(),function(o,i,n){var a,r;s={importConfig:o,importNodes:i,importOptions:n};var d,l=[],c=!1;for(a in o.subflows)if(o.subflows.hasOwnProperty(a)){c||(l.push({gutter:$('<span data-i18n="menu.label.subflows"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0);var u=D(r=o.subflows[a],p=o.conflicted[r.id],f=!p);d={id:r.id,gutter:u.gutter.element,element:u.element,class:f?"":"disabled",deferBuild:!0,children:[]},l.push(d),o.zMap[a]&&o.zMap[a].forEach((function(e){var t=D(e,o.conflicted[e.id],f,u.gutter.cb);d.children.push({id:e.id,gutter:t.gutter.element,element:t.element,class:f?"":"disabled"})}))}for(a in c=!1,o.tabs)if(o.tabs.hasOwnProperty(a)){c||(l.push({gutter:$('<span data-i18n="menu.label.flows"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0);var p,f;u=D(r=o.tabs[a],p=o.conflicted[r.id],f=!0);d={id:r.id,gutter:u.gutter.element,element:u.element,icon:"red-ui-icons red-ui-icons-flow",deferBuild:!0,class:f?"":"disabled",children:[]},l.push(d),o.zMap[a]&&o.zMap[a].forEach((function(e){var t=D(e,o.conflicted[e.id],f,u.gutter.cb);d.children.push({id:e.id,gutter:t.gutter.element,element:t.element,class:f?"":"disabled"})}))}c=!1;var h=[];o.all.forEach((function(e){if("tab"!==e.type&&"subflow"!==e.type&&!o.tabs[e.z]&&!o.subflows[e.z]){var t=o.conflicted[e.id],i=!t||!o.configs[e.id],n=D(e,t,i),a={id:e.id,gutter:n.gutter.element,element:n.element,class:i?"":"disabled"};o.configs[e.id]?h.push(a):(c||(l.push({gutter:$('<span data-i18n="menu.label.nodes"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0),l.push(a))}})),h.length>0&&(l.push({gutter:$('<span data-i18n="menu.label.displayConfig"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0,l=l.concat(h));t.empty(),t.append($(importConflictsDialog));$("#red-ui-clipboard-dialog-import-conflicts-list").css({position:"absolute",top:0,right:0,bottom:0,left:0}).treeList({data:l});t.i18n();var g=400,v=$(window).height();v<600&&(g=400-(600-v));$(".red-ui-clipboard-dialog-box").height(g),$("#red-ui-clipboard-dialog-ok").hide(),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-import-conflict").show(),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("option","width",500).dialog("open")}(o,i,n)}},{text:RED._("clipboard.import.importCopy"),click:function(){a.close(),n.generateIds=!0,RED.view.importNodes(i,n)}}]})}(o.importConfig,n,r)}}function D(e,t,o,i){var n;n="tab"===e.type?x(e):_(e,t);var a=$("<div>",{class:"red-ui-clipboard-dialog-import-conflicts-controls"}).appendTo(n);if(a.on("click",(function(e){e.stopPropagation()})),t&&!i){var r=$("<label><input "+(o?"":"disabled ")+'type="checkbox" data-node-id="'+e.id+'"> <span data-i18n="clipboard.import.replace"></span></label>').appendTo(a);("tab"===e.type||"subflow"!==e.type&&e.hasOwnProperty("x")&&e.hasOwnProperty("y"))&&r.hide()}return{element:n,gutter:R(e,o,i)}}function R(e,t,o){var i=$("<label>",{class:"red-ui-clipboard-dialog-import-conflicts-gutter"}),n=$('<input data-node-id="'+e.id+'" type="checkbox" '+(t?"checked":"")+">").appendTo(i);o&&(n.attr("disabled",!0),o.addChild(n)),i.on("click",(function(e){e.stopPropagation()})),n.on("change",(function(e){var t=this.checked;i.parent().toggleClass("disabled",!t),i.parent().find('.red-ui-clipboard-dialog-import-conflicts-controls  input[type="checkbox"]').attr("disabled",!t),a.forEach((function(e){e.attr("checked",t),e.trigger("change")}))}));var a=[];return{cb:{addChild:function(e){a.push(e)}},element:i}}function x(e){(e=JSON.parse(JSON.stringify(e)))._def=RED.nodes.getType(e.type)||{},e._def&&(e._=e._def._);var t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"}),o=$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t),i="string"==typeof e?e:e.label,n=i.indexOf("\\n");return n>-1&&(i=i.substring(0,n)+"..."),o.text(i),t}function _(e,t){(e=JSON.parse(JSON.stringify(e)))._def=RED.nodes.getType(e.type)||{},e._def&&(e._=e._def._);var o=$("<div>",{class:"red-ui-node-list-item"});return RED.utils.createNodeIcon(e,!0).appendTo(o),o}return{init:function(){p(),RED.actions.add("core:show-export-dialog",v),RED.actions.add("core:show-import-dialog",g),RED.actions.add("core:show-library-export-dialog",(function(){v("library")})),RED.actions.add("core:show-library-import-dialog",(function(){g("library")})),RED.actions.add("core:show-examples-import-dialog",(function(){g("examples")})),RED.events.on("editor:open",(function(){c=!0})),RED.events.on("editor:close",(function(){c=!1})),RED.events.on("search:open",(function(){c=!0})),RED.events.on("search:close",(function(){c=!1})),RED.events.on("actionList:open",(function(){c=!0})),RED.events.on("actionList:close",(function(){c=!1})),RED.events.on("type-search:open",(function(){c=!0})),RED.events.on("type-search:close",(function(){c=!1})),$('<div id="red-ui-drop-target"><div data-i18n="[append]workspace.dropFlowHere"><i class="fa fa-download"></i><br></div></div>').appendTo("#red-ui-editor"),RED.keyboard.add("#red-ui-drop-target","escape",y),$("#red-ui-workspace-chart").on("dragenter",(function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||$("#red-ui-drop-target").css({display:"table"}).focus()})),$("#red-ui-drop-target").on("dragover",(function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()})).on("dragleave",(function(e){y()})).on("drop",(function(e){try{if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");E(t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1))}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var o=e.originalEvent.dataTransfer.files;if(1===o.length){var i=o[0],n=new FileReader;n.onload=function(e){E(e.target.result)},n.readAsText(i)}}}catch(e){}y(),e.preventDefault()}))},import:g,export:v,copyText:w}}(),RED.library=function(){var e,t,o,i,n;function a(e,t,o,i){$.getJSON("library/"+e+"/"+t+"/"+o,(function(n){var r=n.map((function(i){return"string"==typeof i?{library:e,type:t,icon:"fa fa-folder",label:i,path:o+i+"/",children:function(n,r){a(e,t,o+i+"/",(function(e){r.children=e,n(e)}))}}:{library:e,type:t,icon:"fa fa-file-o",label:i.fn,path:o+i.fn,props:i}}));r.sort((function(e,t){return e.children&&!t.children?-1:!e.children&&t.children?1:e.label.localeCompare(t.label)})),i(r)}))}function r(e){n&&clearTimeout(n),n=setTimeout((function(){var t=e.val().trim();t.length>0&&!/[\/\\]/.test(t)?(e.removeClass("input-error"),$("#red-ui-library-dialog-save-button").button("enable")):(e.addClass("input-error"),$("#red-ui-library-dialog-save-button").button("disable"))}),100)}return{init:function(){$('<div id="red-ui-library-dialog-save" class="hide"><form class="form-horizontal"><div class="red-ui-library-dialog-box" style="height: 400px; position:relative; "><div id="red-ui-library-dialog-save-browser"></div><div class="form-row"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-library-dialog-save-filename" type="text"></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$('<div id="red-ui-library-dialog-load" class="hide"><form class="form-horizontal"><div class="red-ui-library-dialog-box" style="height: 400px; position:relative; "><div id="red-ui-library-dialog-load-panes"><div class="red-ui-panel" id="red-ui-library-dialog-load-browser"></div><div class="red-ui-panel"><div id="red-ui-library-dialog-load-preview"><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-text" style="position:relative; height: 50%; overflow-y: hidden;"></div><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-details"><table id="red-ui-library-dialog-load-preview-details-table" class="red-ui-info-table"></table></div></div></div></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$("#red-ui-library-dialog-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:800,resizable:!1,open:function(e,t){RED.keyboard.disable()},close:function(e,t){RED.keyboard.enable()},classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-library-dialog-save-button",text:RED._("common.label.save"),class:"primary",click:function(){!function(){var e=i.elementPrefix||"node-input-",o=$("#"+e+"name").val().trim();""===o&&(o=RED._("library.unnamedType",{type:i.type}));var n=$("#red-ui-library-dialog-save-filename").val().trim(),a=t.getSelected();a.children||(a=a.parent);for(var r={},s=0;s<i.fields.length;s++){var d=i.fields[s];"name"===d?r.name=o:"object"==typeof d?r[d.name]=d.get():r[d]=$("#"+e+d).val()}r.text=i.editor.getValue();var l=function(){$.ajax({url:"library/"+a.library+"/"+a.type+"/"+a.path+n,type:"POST",data:JSON.stringify(r),contentType:"application/json; charset=utf-8"}).done((function(e,t,o){RED.notify(RED._("library.savedType",{type:i.type}),"success")})).fail((function(e,t,o){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}))};if(a.children){var c=!1;if(a.children.forEach((function(e){e.label===n&&(c=!0)})),c){$("#red-ui-library-dialog-save").dialog("close");var u=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(n)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){u.hideNotification(),$("#red-ui-library-dialog-save").dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){u.hideNotification(),l()}}]})}else l()}else l()}(),$(this).dialog("close")}}]}),t=RED.library.createBrowser({container:$("#red-ui-library-dialog-save-browser"),folderTools:!0,onselect:function(e){e.label&&(e.children||($("#red-ui-library-dialog-save-filename").val(e.label),e=e.parent),!1===e.writable?$("#red-ui-library-dialog-save-button").button("disable"):$("#red-ui-library-dialog-save-button").button("enable"))}}),$("#red-ui-library-dialog-save-filename").on("keyup",(function(){r($(this))})),$("#red-ui-library-dialog-save-filename").on("paste",(function(){var e=$(this);setTimeout((function(){r(e)}),10)})),$("#red-ui-library-dialog-load").dialog({modal:!0,autoOpen:!1,width:800,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(selectedLibraryItem){for(var e=i.elementPrefix||"node-input-",t=0;t<i.fields.length;t++){var n=i.fields[t];if("object"==typeof n){var a=selectedLibraryItem[n.name];n.set(a)}else $("#"+e+n).val(selectedLibraryItem[n])}i.editor.setValue(o.getValue(),-1)}$(this).dialog("close")}}],open:function(e){RED.keyboard.disable(),$(this).parent().find(".ui-dialog-titlebar-close").hide(),o.resize()},close:function(e){RED.keyboard.enable(),o&&(o.destroy(),o=null)}}),e=RED.library.createBrowser({container:$("#red-ui-library-dialog-load-browser"),onselect:function(e){var t=$("#red-ui-library-dialog-load-preview-details-table").empty();selectedLibraryItem=e.props,e&&e.label&&!e.children?$.get("library/"+e.library+"/"+e.type+"/"+e.path,(function(n){var a=$('<tr class="red-ui-help-info-row"><td>Type</td><td></td></tr>').appendTo(t);for(var r in $(a.children()[1]).text(i.type),e.props.hasOwnProperty("name")&&(a=$('<tr class="red-ui-help-info-row"><td>Name</td><td>'+e.props.name+"</td></tr>").appendTo(t),$(a.children()[1]).text(e.props.name)),e.props)e.props.hasOwnProperty(r)&&"name"!==r&&"fn"!==r&&(a=$('<tr class="red-ui-help-info-row"><td></td><td></td></tr>').appendTo(t),$(a.children()[0]).text(r),RED.utils.createObjectElement(e.props[r]).appendTo(a.children()[1]));o.setValue(n,-1)})):o.setValue("",-1)}}),RED.panels.create({container:$("#red-ui-library-dialog-load-panes"),dir:"horizontal",resize:function(){o.resize()}}),RED.panels.create({container:$("#red-ui-library-dialog-load-preview"),dir:"vertical",resize:function(){o.resize()}})},create:function(n){var r=n.elementPrefix||"node-input-";n.editor.setText&&(n.editor.setValue=function(e,t){n.editor.setText.call(n.editor,e)}),n.editor.getText&&(n.editor.getValue=n.editor.getText),$("#"+r+"name").css("width","calc(100% - 52px)").after('<div style="margin-left:5px; display: inline-block;position: relative;"><a id="node-input-'+n.type+'-lookup" class="red-ui-button"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a></div>'),RED.menu.init({id:"node-input-"+n.type+"-lookup",options:[{id:"node-input-"+n.type+"-menu-open-library",label:RED._("library.openLibrary"),onselect:function(){var t={id:"red-ui-library-dialog-load-preview-text",mode:n.mode,readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1,contextmenu:!1};(o=RED.editor.createEditor(t)).isACE&&(n.mode&&o.getSession().setMode(n.mode),o.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),o.renderer.$cursorLayer.element.style.opacity=0,o.$blockScrolling=1/0),i=n;var r=[];(RED.settings.libraries||[]).forEach((function(e){e.types&&-1===e.types.indexOf(n.url)||r.push({library:e.id,type:n.url,icon:e.icon||"fa fa-hdd-o",label:RED._(e.label||e.id),path:"",expanded:!0,writable:!1,children:[{library:e.id,type:n.url,icon:"fa fa-cube",label:n.type,path:"",expanded:!1,children:function(t,o){a(e.id,n.url,"",(function(e){o.children=e,t(e)}))}}]})})),e.data(r),setTimeout((function(){e.select(r[0].children[0])}),200);var s=400,d=$(window).height();d<570&&(s=400-(570-d)),$("#red-ui-library-dialog-load .red-ui-library-dialog-box").height(s),$("#red-ui-library-dialog-load").dialog("option","title",RED._("library.typeLibrary",{type:n.type})).dialog("open")}},{id:"node-input-"+n.type+"-menu-save-library",label:RED._("library.saveToLibrary"),onselect:function(){i=n;var e=$("#"+r+"name").val().replace(/(^\s*)|(\s*$)/g,"").replace(/[^\w-]/g,"-");""===e&&(e="unnamed-"+n.type),$("#red-ui-library-dialog-save-filename").attr("value",e+"."+(n.ext||"txt"));var o=[];(RED.settings.libraries||[]).forEach((function(e){e.types&&-1===e.types.indexOf(n.url)||o.push({library:e.id,type:n.url,icon:e.icon||"fa fa-hdd-o",label:RED._(e.label||e.id),path:"",expanded:!0,writable:!1,children:[{library:e.id,type:n.url,icon:"fa fa-cube",label:n.type,path:"",expanded:!1,children:function(t,o){a(e.id,n.url,"",(function(e){o.children=e,t(e)}))}}]})})),t.data(o),setTimeout((function(){t.select(o[0].children[0])}),200);var s=400,d=$(window).height();d<570&&(s=400-(570-d)),$("#red-ui-library-dialog-save .red-ui-library-dialog-box").height(s),$("#red-ui-library-dialog-save").dialog("open")}}]})},createBrowser:function(e){var t=$('<div class="red-ui-library-browser"></div>').appendTo(e.container),o=$("<div>").css({width:"100%",height:"100%"}).appendTo(t).treeList({}).on("treelistselect",(function(t,o){e.onselect&&e.onselect(o)})).on("treelistconfirm",(function(t,o){e.onconfirm&&e.onconfirm(o)})),i=null;return e.folderTools&&o.on("treelistselect",(function(e,t){if(!1!==t.writable&&t.treeList){i&&i.remove(),i=$("<div>").css({position:"absolute",bottom:"6px",right:"8px"});var n=$('<button class="red-ui-button red-ui-button-small" type="button"><i class="fa fa-ellipsis-h"></i></button>').on("click",(function(e){e.preventDefault(),e.stopPropagation();var t=n.offset(),i=RED.menu.init({id:"red-ui-library-browser-menu",options:[{id:"red-ui-library-browser-menu-addFolder",label:RED._("library.newFolder"),onselect:function(){var e="new-folder",t={},i=o.treeList("selected");i.children||(i=i.parent);i.treeList.expand((function(){i.children.forEach((function(e){/^new-folder/.test(e.label)&&(t[e.label]=!0)}));for(var o=2;t[e];)e="new-folder-"+o++;i.treeList.expand();var n=$('<input type="text" class="red-ui-treeList-input">').val(e),a={icon:"fa fa-folder-o",children:[],path:i.path,element:n},r=function(){var e=n.val().trim();if(""!==e){for(var t=0;t<i.children.length;t++)if(i.children[t].label===e)return void s();a.treeList.remove();var o={library:i.library,type:i.type,icon:"fa fa-folder",children:[],label:e,path:a.path+e+"/"};i.treeList.addChild(o,!0)}else s()},s=function(){a.treeList.remove()};n.on("keydown",(function(e){e.stopPropagation(),13===e.keyCode?r():27===e.keyCode&&s()})),n.on("blur",(function(){r()})),i.treeList.addChild(a),setTimeout((function(){n.trigger("focus"),n.select()}),400)}))}}]}).on("mouseleave",(function(){$(this).remove(),o.focus()})).on("mouseup",(function(){var e=$(this);e.hide(),o.focus(),setTimeout((function(){e.remove()}),100)})).appendTo("body");i.css({position:"absolute",top:t.top+"px",left:t.left-i.width()+20+"px"}).show()})).appendTo(i);i.appendTo(t.treeList.label)}})),{select:function(e){o.treeList("select",e)},getSelected:function(){return o.treeList("selected")},focus:function(){o.focus()},data:function(e,t){o.treeList("data",e),t&&setTimeout((function(){o.treeList("select",e[0])}),100)}}},export:function(){console.warn("Deprecated call to RED.library.export")},loadLibraryFolder:a}}(),RED.notifications=function(){var e,t,o={},i=(e=0,{show:function(){e++,$("#red-ui-full-shade").show()},hide:function(){0==--e&&$("#red-ui-full-shade").hide()}}),n=[],a=0;function r(e,r,s,d){var l={};if(null!==r&&"object"==typeof r?(s=(l=r).fixed,d=l.timeout,r=l.type):(l.type=r,l.fixed=s,l.timeout=l.timeout),l.id&&o.hasOwnProperty(l.id))return o[l.id].update(e,l),o[l.id];if(l.modal&&i.show(),n.length>4)for(var c=n.length,u=0;c>4&&u<n.length;u+=1){var p=n[u];p.fixed||(window.clearTimeout(p.timeoutid),p.close(),c-=1)}var f=document.createElement("div");if(f.id="red-ui-notification-"+a,f.className="red-ui-notification",f.options=l,f.fixed=s,r&&(f.className="red-ui-notification red-ui-notification-"+r),l.width){var h=$("#red-ui-notifications").width();if(l.width>h){var g=-(l.width-h)/2;$(f).css({width:l.width+"px",marginLeft:g+"px"})}}if(f.style.display="none","string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),f.innerHTML=e):$(f).append(e),l.buttons){var v=$('<div class="ui-dialog-buttonset"></div>').appendTo(f);l.buttons.forEach((function(e){var t=$("<button>").html(e.text).on("click",e.click).appendTo(v);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)}))}return $("#red-ui-notifications").append(f),RED.notifications.hide||$(f).slideDown(300),f.close=function(){var e=f;return function(){e.closed||(e.closed=!0,n.splice(n.indexOf(e),1),l.id&&(delete o[l.id],0===Object.keys(o).length&&t.hide()),RED.notifications.hide?e.parentNode.removeChild(e):$(e).slideUp(300,(function(){e.parentNode.removeChild(e)})),e.options.modal&&i.hide())}}(),f.hideNotification=function(){var e=f;return function(){e.closed||(e.hidden=!0,RED.notifications.hide||$(e).slideUp(300))}}(),f.showNotification=function(){var e=f;return function(){!e.closed&&e.hidden&&(e.hidden=!1,RED.notifications.hide||$(e).slideDown(300))}}(),f.update=function(){var e=f;return function(t,o){var n;if("string"==typeof t?(/<p>/i.test(t)||(t="<p>"+t+"</p>"),e.innerHTML=t):$(e).empty().append(t),"number"==typeof o)n=o,e.options.timeout=n;else if(void 0!==o){!l.modal&&o.modal?(e.options.modal=!0,i.show()):l.modal&&!1===o.modal&&(e.options.modal=!1,i.hide());var a=o.hasOwnProperty("type")?o.type:r;if(a&&(f.className="red-ui-notification red-ui-notification-"+a),s&&!1!==o.fixed||(n=(o.hasOwnProperty("timeout")?o.timeout:d)||5e3),o.buttons){var c=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(e);o.buttons.forEach((function(e){var t=$("<button>").text(e.text).on("click",e.click).appendTo(c);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)}))}}$(e).off("click.red-ui-notification-close"),void 0!==n&&n>0?(window.clearTimeout(e.timeoutid),e.timeoutid=window.setTimeout(e.close,n),setTimeout((function(){$(e).on("click.red-ui-notification-close",(function(){e.close(),window.clearTimeout(e.timeoutid)}))}),50)):window.clearTimeout(e.timeoutid),e.hidden?e.showNotification():o&&o.silent||($(e).addClass("red-ui-notification-shake-horizontal"),setTimeout((function(){$(e).removeClass("red-ui-notification-shake-horizontal")}),300))}}(),s||($(f).on("click.red-ui-notification-close",function(){var e=f;return function(){e.close(),window.clearTimeout(e.timeoutid)}}()),f.timeoutid=window.setTimeout(f.close,d||5e3)),n.push(f),l.id&&(o[l.id]=f,l.fixed&&t.show()),a+=1,f}return RED.notify=r,{init:function(){$('<div id="red-ui-notifications"></div>').appendTo("#red-ui-editor"),t=$("<li></li>").prependTo(".red-ui-header-toolbar").hide(),$('<a class="button" href="#"><i class="fa fa-warning"></i></a>').appendTo(t).on("click",(function(){!function(){for(var e in o)o.hasOwnProperty(e)&&o[e].showNotification()}()}))},notify:r}}(),RED.search=function(){var e,t,o,n=!1,a=null,r=-1,s=!1,d=[],l={},c=[],u=[],p=0;function f(e,t,o){if("string"==typeof o||"number"==typeof o)o=(""+o).toLowerCase(),l[o]=l[o]||{},l[o][e.id]={node:e,label:t};else if(Array.isArray(o))o.forEach((function(o){f(e,t,o)}));else if("object"==typeof o)for(var i in o)o.hasOwnProperty(i)&&f(e,t,o[i])}function h(e,t,o){var i=new RegExp("(?:^| )is:"+t+"(?: |$)");return i.exec(e)&&(e=e.replace(i," ").trim(),o[t]=!0),e}function g(e,t,o){for(var i,n=new RegExp("(?:^| )"+t+":([^ ]+)(?: |$)");i=n.exec(e);)e=e.replace(n," ").trim(),o[t]=o[t]||[],o[t].push(i[1]);return e}function v(e){var t,o=[],i=/(?:^| )type:([^ ]+)/.exec(e);i&&(e=e.replace(/(?:^| )type:[^ ]+/,""),t=i[1]);var n={};e=h(e,"invalid",n),e=h(e,"unused",n),e=h(e,"config",n),e=h(e,"subflow",n),e=h(e,"hidden",n),e=g(e=h(e,"modified",n),"flow",n),e=(e=g(e,"uses",n)).trim();var a=Object.keys(n).length>0;if(n.flow&&n.flow.indexOf("current")>=0){let e=n.flow.indexOf("current");n.flow[e]=RED.workspaces.active()}if(n.flow&&n.flow.length&&(n.flow=[...new Set(n.flow)]),e.length>0||t||a){var r,s;e=e.toLowerCase();var d=[],c={};let i=[];for(i=n.uses?n.uses:Object.keys(l),r=0;r<i.length;r++){var u=i[r],p=i[r].indexOf(e);if(p>-1){var f=Object.keys(l[u]||{});for(s=0;s<f.length;s++){var v=l[u][f[s]],m="config"===v.node._def.category&&"group"!==v.node.type;if(!n.uses||u!==v.node.id){if(n.hasOwnProperty("invalid")){var b=!v.node.hasOwnProperty("valid")||v.node.valid;if(n.invalid===b)continue}if((!n.hasOwnProperty("config")||n.config===m)&&(!n.hasOwnProperty("subflow")||n.subflow===("subflow"===v.node.type))&&(!n.hasOwnProperty("modified")||v.node.changed||v.node.moved)){if(n.hasOwnProperty("hidden")){if("tab"!==v.node.type)continue;if(!RED.workspaces.isHidden(v.node.id))continue}if(n.hasOwnProperty("unused")){var y="subflow"===v.node.type&&0===v.node.instances.length||m&&0===v.node.users.length&&!1!==v.node._def.hasUsers;if(n.unused!==y)continue}n.hasOwnProperty("flow")&&n.flow.indexOf(v.node.z||v.node.id)<0||t&&v.node.type!==t||(c[v.node.id]=c[v.node.id]={node:v.node,label:v.label},c[v.node.id].index=Math.min(c[v.node.id].index||1/0,p))}}}}}for((d=Object.keys(c)).sort((function(e,t){return c[e].index-c[t].index})),r=0;r<d.length;r++)o.push(c[d[r]])}return o}function m(){var e=t.find("li.selected");if(1===e.length){var o=t.parent(),i=o.height(),n=(o.scrollTop(),e.position().top),a=e.height();n+a>i?o.animate({scrollTop:"-="+(i-(n+a)-10)},50):n<0&&o.animate({scrollTop:"+="+(n-10)},50)}}function b(){d.length>0&&(t.editableList("addItem",{historyHeader:!0}),d.forEach((function(e){t.editableList("addItem",{history:!0,value:e})})))}function y(t){var o=e.val(),i=d.indexOf(o);i>-1&&d.splice(i,1),d.unshift(o),$("#red-ui-view-searchtools-search").data("term",o),R(null,(u=Object.assign([],c)).length>0),RED.view.reveal(t.id)}function w(){if(n)return void x();if(!t||!u.length)return void D();p>0?p--:p=u.length-1;const e=u[p];e&&e.node&&e.node.id&&(RED.view.reveal(e.node.id),$("#red-ui-view-searchtools-prev").trigger("focus")),x()}function E(){if(n)return void x();if(!t||!u.length)return void D();p<u.length-1?p++:p=0;const e=u[p];e&&e.node&&e.node.id&&(RED.view.reveal(e.node.id),$("#red-ui-view-searchtools-next").trigger("focus")),x()}function D(l){n?x():(s||(o=document.activeElement,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),null===a?function(){a=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#red-ui-main-container");var o=$("<div>",{class:"red-ui-search-container"}).appendTo(a);e=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(o).searchBox({delay:200,change:function(){t.editableList("empty"),r=-1;var e=$(this).val();if(""!==e)if((c=v(e)).length>0){for(let e=0;e<Math.min(c.length,25);e++)t.editableList("addItem",c[e]);c.length>25&&t.editableList("addItem",{more:{results:c,start:25}})}else t.editableList("addItem",{});else b()},options:L()}),$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-caret-right"></button>').appendTo(o).on("click",(function(t){t.preventDefault(),RED.sidebar.info.outliner.search(e.val()),R()})),e.on("keydown",(function(o){var n;if(c.length>0)if(40===o.keyCode)n=t.children(),r<n.length-1&&(r>-1&&$(n[r]).removeClass("selected"),r++),$(n[r]).addClass("selected"),m(),o.preventDefault();else if(38===o.keyCode)n=t.children(),r>0&&(r<n.length&&$(n[r]).removeClass("selected"),r--),$(n[r]).addClass("selected"),m(),o.preventDefault();else if(13===o.keyCode){var a;if(n=t.children(),$(n[r]).hasClass("red-ui-search-more")&&(a=$(n[r]).find(".red-ui-editableList-item-content").data("data"))){for(t.editableList("removeItem",a),i=a.more.start;i<Math.min(c.length,a.more.start+25);i++)t.editableList("addItem",c[i]);c.length>a.more.start+25&&t.editableList("addItem",{more:{results:c,start:a.more.start+25}})}$(n[r]).hasClass("red-ui-search-history")?(a=$(n[r]).find(".red-ui-editableList-item-content").data("data"))&&e.searchBox("value",a.value):$(n[r]).hasClass("red-ui-search-historyHeader")||c.length>0&&(p=Math.max(0,r),y(c[p].node))}})),e.i18n();var n=$("<div>",{class:"red-ui-search-results-container"}).appendTo(a);t=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(n).editableList({addButton:!1,addItem:function(o,i,n){var a,r=n.node;if(n.historyHeader)o.parent().addClass("red-ui-search-historyHeader"),$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.history")).appendTo(o),$('<button type="button" class="red-ui-button red-ui-button-small"></button>').text(RED._("search.clear")).appendTo(o).on("click",(function(e){e.preventDefault(),d=[],t.editableList("empty")}));else if(n.history)o.parent().addClass("red-ui-search-history"),(a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(o)).text(n.value),a.on("click",(function(t){t.preventDefault(),e.searchBox("value",n.value),e.focus()})),$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-remove"></i></button>').appendTo(o).on("click",(function(e){e.preventDefault();var o=d.indexOf(n.value);d.splice(o,1),t.editableList("removeItem",n)}));else if(n.more)o.parent().addClass("red-ui-search-more"),(a=$("<a>",{href:"#",class:"red-ui-search-result red-ui-search-empty"}).appendTo(o)).text(RED._("palette.editor.more",{count:n.more.results.length-n.more.start})),a.on("click",(function(e){for(e.preventDefault(),t.editableList("removeItem",n),i=n.more.start;i<Math.min(c.length,n.more.start+25);i++)t.editableList("addItem",c[i]);c.length>n.more.start+25&&t.editableList("addItem",{more:{results:c,start:n.more.start+25}})}));else if(void 0===r)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(o);else{r._def,a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(o),RED.utils.createNodeIcon(r).appendTo(a);var s=$("<div>",{class:"red-ui-search-result-node-description"}).appendTo(a);if(r.z){var l=RED.nodes.workspace(r.z);l=l?"flow:"+l.label:"subflow:"+(l=RED.nodes.subflow(r.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).text(l).appendTo(s)}$("<div>",{class:"red-ui-search-result-node-label"}).text(n.label||r.id).appendTo(s),$("<div>",{class:"red-ui-search-result-node-type"}).text(r.type).appendTo(s),$("<div>",{class:"red-ui-search-result-node-id"}).text(r.id).appendTo(s),a.on("click",(function(e){e.preventDefault(),p=i,y(r)}))}},scrollOnAdd:!1})}():t.editableList("empty"),a.slideDown(300),e.searchBox("value",l),l&&""!==l||b(),RED.events.emit("search:open"),s=!0),e.trigger("focus"))}function R(t,i){s&&(s=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==a&&a.slideUp(200,(function(){e.searchBox("value","")})),RED.events.emit("search:close"),!o||i&&u.length||$(o).trigger("focus"),o=null),i||j(),x(),i&&u.length&&$("#red-ui-view-searchtools-next").trigger("focus")}function x(){if(!n&&p>=0&&u&&u.length){let e=$("#red-ui-view-searchtools-search").data("term")||"";e.length>16&&(e=e.substring(0,12)+"...");const t={term:e,result:p+1,count:u.length};$("#red-ui-view-searchtools-counter").text(RED._("actions.search-counter",t)),$("#view-search-tools > :not(:first-child)").show()}else j(),$("#view-search-tools > :not(:first-child)").hide()}function _(){l={}}function k(e){!function(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),l[t]=l[t]||{},l[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var o=["id","type","name","label","info"];const i=e&&e._def;if(i&&(i.defaults&&(o=o.concat(Object.keys(i.defaults))),"group"!==e.type&&i.paletteLabel&&i.paletteLabel!==i.type))try{const o=(""+("function"==typeof i.paletteLabel?i.paletteLabel.call(i):i.paletteLabel)).toLowerCase();o&&o!==(""+i.type).toLowerCase()&&f(e,t,o)}catch(e){console.warn(`error indexing ${t}`,e)}for(var n=0;n<o.length;n++)if(e.hasOwnProperty(o[n])){if("group"===e.type&&"nodes"===o[n])continue;f(e,t,e[o[n]])}}(e)}function T(e){for(var t=Object.keys(l),o=0,i=t.length;o<i;o++)delete l[t[o]][e.id],0===Object.keys(l[t[o]]).length&&delete l[t[o]]}function C(e){T(e),k(e)}function j(){u=[],p=0,$("#red-ui-view-searchtools-search").data("term","")}function L(){return[{label:RED._("search.options.configNodes"),value:"is:config"},{label:RED._("search.options.unusedConfigNodes"),value:"is:config is:unused"},{label:RED._("search.options.modifiedNodes"),value:"is:modified"},{label:RED._("search.options.invalidNodes"),value:"is:invalid"},{label:RED._("search.options.uknownNodes"),value:"type:unknown"},{label:RED._("search.options.unusedSubflows"),value:"is:subflow is:unused"},{label:RED._("search.options.hiddenFlows"),value:"is:hidden"},{label:RED._("search.options.thisFlow"),value:"flow:current"}]}return{init:function(){RED.actions.add("core:search",D),RED.actions.add("core:search-previous",w),RED.actions.add("core:search-next",E),RED.events.on("editor:open",(function(){n=!0})),RED.events.on("editor:close",(function(){n=!1})),RED.events.on("type-search:open",(function(){n=!0})),RED.events.on("type-search:close",(function(){n=!1})),RED.events.on("actionList:open",(function(){n=!0})),RED.events.on("actionList:close",(function(){n=!1})),RED.keyboard.add("red-ui-search","escape",R),RED.keyboard.add("view-search-tools","escape",(function(){j(),x()})),$("#red-ui-header-shade").on("mousedown",R),$("#red-ui-editor-shade").on("mousedown",R),$("#red-ui-palette-shade").on("mousedown",R),$("#red-ui-sidebar-shade").on("mousedown",R),$("#red-ui-view-searchtools-close").on("click",(function(){j(),x()})),$("#red-ui-view-searchtools-close").trigger("click"),RED.events.on("workspace:clear",_),RED.events.on("flows:add",k),RED.events.on("flows:remove",T),RED.events.on("flows:change",C),RED.events.on("subflows:add",k),RED.events.on("subflows:remove",T),RED.events.on("subflows:change",C),RED.events.on("nodes:add",k),RED.events.on("nodes:remove",T),RED.events.on("nodes:change",C),RED.events.on("groups:add",k),RED.events.on("groups:remove",T),RED.events.on("groups:change",C)},show:D,hide:R,search:v,getSearchOptions:L}}(),RED.contextMenu=function(){let e;function t(){$(document).off("mousedown.red-ui-workspace-context-menu"),e&&e.remove(),e=null}return RED.keyboard.add("red-ui-workspace-context-menu","escape",(function(){RED.contextMenu.hide()})),RED.events.on("editor:open",(function(){RED.contextMenu.hide()})),RED.events.on("search:open",(function(){RED.contextMenu.hide()})),RED.events.on("type-search:open",(function(){RED.contextMenu.hide()})),RED.events.on("actionList:open",(function(){RED.contextMenu.hide()})),RED.events.on("view:selection-changed",(function(){RED.contextMenu.hide()})),{show:function(o){e&&e.remove();const i=RED.view.selection(),n=(!i||Object.keys(i).length,i.nodes&&i.nodes.length>0),a=(n&&i.nodes.length,i.links&&i.links.filter((e=>!!e.link)),i.links&&i.links.filter((e=>!e.link))||[]),r=a.length>0,s=!n&&r&&1===a.length,d=(!n&&r&&a.length,n||r),l=n&&1===i.nodes.length&&"group"===i.nodes[0].type,c=n&&!!i.nodes[0].g,u=$("#red-ui-workspace-chart").offset();let p=(o.x+5-u.left+$("#red-ui-workspace-chart").scrollLeft())/RED.view.scale(),f=(o.y+5-u.top+$("#red-ui-workspace-chart").scrollTop())/RED.view.scale();const h=[{onselect:"core:show-action-list",onpostselect:function(){}},{label:RED._("contextMenu.insert"),options:[{label:RED._("contextMenu.node"),onselect:function(){RED.view.showQuickAddDialog({position:[p,f],touchTrigger:!0,splice:s?i.links[0]:void 0})},onpostselect:function(){$("#red-ui-type-search-input").trigger("focus")}},r?{label:RED._("contextMenu.junction"),onselect:"core:split-wires-with-junctions",disabled:!r}:{label:RED._("contextMenu.junction"),onselect:function(){const e={_def:{defaults:{}},type:"junction",z:RED.workspaces.active(),id:RED.nodes.id(),x:p,y:f,w:0,h:0,outputs:1,inputs:1,dirty:!0},t={dirty:RED.nodes.dirty(),t:"add",junctions:[e]};RED.nodes.addJunction(e),RED.history.push(t),RED.nodes.dirty(!0),RED.view.select({nodes:[e]}),RED.view.redraw(!0)}},{label:RED._("contextMenu.linkNodes"),onselect:"core:split-wire-with-link-nodes",disabled:!r}]}];h.push(null,{onselect:"core:undo",disabled:0===RED.history.list().length},{onselect:"core:redo",disabled:0===RED.history.listRedo().length},null,{onselect:"core:cut-selection-to-internal-clipboard",label:RED._("keyboard.cutNode"),disabled:!n},{onselect:"core:copy-selection-to-internal-clipboard",label:RED._("keyboard.copyNode"),disabled:!n},{onselect:"core:paste-from-internal-clipboard",label:RED._("keyboard.pasteNode"),disabled:!RED.view.clipboard()},{onselect:"core:delete-selection",disabled:!d},{onselect:"core:show-export-dialog",label:RED._("menu.label.export")},{onselect:"core:select-all-nodes"}),n&&(h.push(null,l?{onselect:"core:ungroup-selection",disabled:!l}:{onselect:"core:group-selection",disabled:!n}),c&&h.push({onselect:"core:remove-selection-from-group",label:RED._("menu.label.groupRemoveSelection")}));var g="right";o.x-$(document).scrollLeft()>$(window).width()-500&&(g="left"),e=RED.menu.init({direction:g,onpreselect:function(){t()},onpostselect:function(){RED.view.focus()},options:h}),e.attr("id","red-ui-workspace-context-menu"),e.css({position:"absolute"}),e.appendTo("body");var v=o.y,m=o.x;v+e.height()-$(document).scrollTop()>$(window).height()&&(v-=v+e.height()-$(window).height()+22),m+e.width()-$(document).scrollLeft()>$(window).width()&&(m-=m+e.width()-$(window).width()+18),e.css({top:v+"px",left:m+"px"}),$(".red-ui-menu.red-ui-menu-dropdown").hide(),$(document).on("mousedown.red-ui-workspace-context-menu",(function(o){e&&e[0].contains(o.target)||t()})),e.show(),$("#red-ui-workspace-context-menu :first(ul) > a").trigger("focus")},hide:t}}(),RED.actionList=function(){var e,t,o,i=!1,n=null,a=!1,r="",s=[];function d(){var e=t.find("li.selected");if(1===e.length){var o=t.parent(),i=o.height(),n=(o.scrollTop(),e.position().top),a=e.height();n+a>i?o.animate({scrollTop:"-="+(i-(n+a)-10)},50):n<0&&o.animate({scrollTop:"+="+(n-10)},50)}}function l(e){u(),e&&RED.actions.invoke(e.id)}function c(c){if(!i){if(!a){o=document.activeElement,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),null===n&&function(){n=$("<div>",{id:"red-ui-actionList",class:"red-ui-search"}).appendTo("#red-ui-main-container");var o=$("<div>",{class:"red-ui-search-container"}).appendTo(n);(e=$('<input type="text" data-i18n="[placeholder]keyboard.filterActions">').appendTo(o).searchBox({change:function(){r=$(this).val().trim(),s=r.split(" "),t.editableList("filter"),t.find("li.selected").removeClass("selected");var e=t.children(":visible");e.length&&$(e[0]).addClass("selected")}})).on("keydown",(function(e){var o;if(40===e.keyCode){if((o=t.find("li.selected")).length)(n=o.nextAll(":visible").first()).length&&(o.removeClass("selected"),n.addClass("selected"));else{var i=t.children(":visible");i.length&&$(i[0]).addClass("selected")}d(),e.preventDefault()}else if(38===e.keyCode){var n;(n=(o=t.find("li.selected")).prevAll(":visible").first()).length&&(o.removeClass("selected"),n.addClass("selected")),d(),e.preventDefault()}else 13===e.keyCode&&(o=t.find("li.selected"),l(t.editableList("getItem",o)))})),e.i18n();var i=$("<div>",{class:"red-ui-search-results-container"}).appendTo(n);t=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(i).editableList({addButton:!1,addItem:function(e,t,o){if(void 0===o.id)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{var i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),n=$("<div>",{class:"red-ui-search-result-action"}).appendTo(i);$("<div>").text(o.label).appendTo(n),o.key&&$("<div>",{class:"red-ui-search-result-action-key"}).html(RED.keyboard.formatKey(o.key)).appendTo(n),i.on("click",(function(e){e.preventDefault(),l(o)}))}},scrollOnAdd:!1,filter:function(e){if(""!==r){for(var t=0,o=0;o<s.length;o++){var i=e._label.indexOf(s[o],t);if(!(i>-1))return!1;t=i}return!0}return!0}})}(),n.slideDown(300),e.searchBox("value",c),t.editableList("empty"),results=[];var u=RED.actions.list();u.sort((function(e,t){var o=e.label,i=t.label;return o.localeCompare(i)})),u.forEach((function(e){e._label=e.label.toLowerCase(),t.editableList("addItem",e)})),RED.events.emit("actionList:open"),a=!0}e.trigger("focus");var p=t.children(":visible");p.length&&$(p[0]).addClass("selected")}}function u(){a&&(a=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==n&&n.slideUp(200,(function(){e.searchBox("value","")})),RED.events.emit("actionList:close"),o&&($(o).trigger("focus"),o=null))}return{init:function(){RED.actions.add("core:show-action-list",c),RED.events.on("editor:open",(function(){i=!0})),RED.events.on("editor:close",(function(){i=!1})),RED.events.on("search:open",(function(){i=!0})),RED.events.on("search:close",(function(){i=!1})),RED.events.on("type-search:open",(function(){i=!0})),RED.events.on("type-search:close",(function(){i=!1})),RED.keyboard.add("red-ui-actionList","escape",(function(){u()})),$("#red-ui-header-shade").on("mousedown",u),$("#red-ui-editor-shade").on("mousedown",u),$("#red-ui-palette-shade").on("mousedown",u),$("#red-ui-sidebar-shade").on("mousedown",u)},show:c,hide:u}}(),RED.typeSearch=function(){var e,t,o,i,n,a,r=null,s=-1,d=!1,l="",c={};function u(){var e=t.find("li.selected");if(1===e.length){var o=t.parent(),i=o.height(),n=(o.scrollTop(),e.position().top),a=e.height();n+a>i?o.animate({scrollTop:"-="+(i-(n+a)-10)},50):n<0&&o.animate({scrollTop:"+="+(n-10)},50)}}function p(e,t){var o=r.position();o.top=o.top+t+"px",o.left=o.left+e+"px",r.css(o),a(e,t)}function f(){r=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#red-ui-main-container");var n=$("<div>",{class:"red-ui-search-container"}).appendTo(r);(e=$('<input type="text" id="red-ui-type-search-input">').attr("placeholder",RED._("search.addNode")).appendTo(n).searchBox({delay:50,change:function(){var e;e=$(this).val(),l=e.toLowerCase(),t.editableList("filter"),t.editableList("sort"),setTimeout((function(){s=0,t.children().removeClass("selected"),t.children(":visible:first").addClass("selected")}),100)}})).on("keydown",(function(e){var o=t.children(":visible");if(40===e.keyCode&&e.shiftKey)e.preventDefault(),p(0,10);else if(38===e.keyCode&&e.shiftKey)e.preventDefault(),p(0,-10);else if(39===e.keyCode&&e.shiftKey)e.preventDefault(),p(10,0);else if(37===e.keyCode&&e.shiftKey)e.preventDefault(),p(-10,0);else if(o.length>0){if(40===e.keyCode)s<o.length-1&&(s>-1&&$(o[s]).removeClass("selected"),s++),$(o[s]).addClass("selected"),u(),e.preventDefault();else if(38===e.keyCode)s>0&&(s<o.length&&$(o[s]).removeClass("selected"),s--),$(o[s]).addClass("selected"),u(),e.preventDefault();else if((e.metaKey||e.ctrlKey)&&13===e.keyCode){if(e.preventDefault(),(a=Math.max(0,s))<o.length){var n=$(o[a]).find(".red-ui-editableList-item-content").data("data");/^_action_:/.test(n.type)||(c[n.type]=Date.now()),0===n.def.outputs?h(n):i(n.type,!0),$("#red-ui-type-search-input").val("").trigger("keyup"),setTimeout((function(){$("#red-ui-type-search-input").focus()}),100)}}else if(13===e.keyCode){var a;e.preventDefault(),(a=Math.max(0,s))<o.length&&h($(o[a]).find(".red-ui-editableList-item-content").data("data"))}}else 13===e.keyCode&&(e.stopPropagation(),e.preventDefault())})),o=$("<div>",{class:"red-ui-search-results-container"}).appendTo(r),t=$("<ol>",{style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(o).editableList({addButton:!1,filter:function(e){return""===l||!e.recent&&!e.common&&(""===l||e.index.indexOf(l)>-1)},sort:function(e,t){if(""===l)return e.i-t.i;var o=e.index.indexOf(l),i=t.index.indexOf(l);return-1===o?1:-1===i?-1:o===i?b(e,t):o-i},addItem:function(e,t,o){var i=o.def;o.index=o.type.toLowerCase(),o.separator&&e.addClass("red-ui-search-result-separator");var n=$("<div>",{class:"red-ui-search-result"}).appendTo(e),a=$("<div>",{class:"red-ui-search-result-node"}).appendTo(n);if("junction"===o.type)a.addClass("red-ui-palette-icon-junction");else if(/^_action_:/.test(o.type))a.addClass("red-ui-palette-icon-junction");else{var r=RED.utils.getNodeColor(o.type,i);a.css("backgroundColor",r)}var s=RED.utils.getNodeIcon(i),d=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(a);RED.utils.createIconElement(s,d,!1),/^_action_:/.test(o.type)||"junction"===o.type||(i.inputs>0&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(a),i.outputs>0&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(a));var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(n),c=o.label;o.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).text(c).appendTo(l),n.on("click",(function(e){e.preventDefault(),h(o)}))},scrollOnAdd:!1})}function h(e){v(),/^_action_:/.test(e.type)||(c[e.type]=Date.now()),i(e.type)}function g(e){if(d){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}v(!0),n&&n()}}function v(t){d&&(d=!1,null!==r&&o.slideUp(t?50:200,(function(){r.hide(),e.searchBox("value","")})),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"),$(document).off("touchstart.red-ui-type-search"))}function m(e,t){var o=e;if(void 0!==t.paletteLabel)try{o=("function"==typeof t.paletteLabel?t.paletteLabel.call(t):t.paletteLabel)||"",o+=" ("+e+")"}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}return o}function b(e,t){var o=e.label.toLowerCase(),i=t.label.toLowerCase();return o<i?-1:o===i?0:1}function y(e,t,o){return!e||!e.spliceMultiple&&(!e.type||t===e.type)&&(!e.input||"junction"===t||o.inputs>0)&&(!e.output||"junction"===t||o.outputs>0)}function w(o){var i;t.editableList("empty"),e.searchBox("value","").focus(),s=-1;var n=["inject","debug","function","change","switch","junction"].filter((function(e){return y(o.filter,e,RED.nodes.getType(e))})),a=Object.keys(c);a.sort((function(e,t){return c[t]-c[e]})),a=a.filter((function(e){return y(o.filter,e,RED.nodes.getType(e))&&-1===n.indexOf(e)}));var r=[];RED.nodes.registry.getNodeTypes().forEach((function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&r.push({type:e,def:t,label:m(e,t)})})),r.sort(b);var d,l=0;for(i=0;i<n.length;i++){var u=RED.nodes.getType(n[i]);"junction"===n[i]?u={inputs:1,outputs:1,label:"junction",type:"junction"}:/^_action_:/.test(n[i])&&(u={inputs:1,outputs:1,label:n[i],type:n[i]}),u&&((d={type:n[i],common:!0,def:u,i:l++}).label=m(d.type,d.def),i===n.length-1&&(d.separator=!0),t.editableList("addItem",d))}for(i=0;i<Math.min(5,a.length);i++)(d={type:a[i],def:RED.nodes.getType(a[i]),recent:!0,i:l++}).label=m(d.type,d.def),i===a.length-1&&(d.separator=!0),t.editableList("addItem",d);for(i=0;i<r.length;i++)y(o.filter,r[i].type,r[i].def)&&(r[i].i=l++,t.editableList("addItem",r[i]));setTimeout((function(){s=0,t.children(":first").addClass("selected")}),100)}return{show:function(t){d?(r.hide(),o.hide()):(null===r&&(f(),RED.keyboard.add("red-ui-type-search","escape",(function(){v(),n&&n()}))),d=!0),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"),$(document).off("touchstart.red-ui-type-search"),$(document).off("mousedown.red-ui-type-search"),setTimeout((function(){$(document).on("mousedown.red-ui-type-search",g),$(document).on("mouseup.red-ui-type-search",g),$(document).on("click.red-ui-type-search",g),$(document).on("touchstart.red-ui-type-search",g)}),200),w(t),i=t.add,n=t.cancel,a=t.move,RED.events.emit("type-search:open"),$("#red-ui-main-container").height()-t.y-195<0&&(t.y=t.y-275),r.css({left:t.x+"px",top:t.y+"px"}).show(),o.slideDown(300),setTimeout((function(){o.find(".red-ui-editableList-container").scrollTop(0),t.disableFocus||e.trigger("focus")}),200)},refresh:w,hide:v}}(),RED.subflow=function(){function e(e,t){var o={x:50,y:30};t||(o.x+=110);var i=[].concat(e.out).concat(e.in);e.status&&i.push(e.status),i.sort((function(e,t){return e.x-t.x}));for(var n=0;n<i.length;n++){var a=i[n];a.x==o.x&&a.y==o.y&&(o.x+=55)}return o}function t(){var e=RED.nodes.subflow(RED.workspaces.active());if(0!==e.in.length){var t=e.in[0],o=[];return RED.nodes.eachLink((function(i){("subflow"==i.source.type&&i.source.z==e.id&&i.source.i==t.i||i.target.type=="subflow:"+e.id)&&o.push(i)})),o.forEach((function(e){RED.nodes.removeLink(e)})),e.in=[],$("#red-ui-subflow-input-add").removeClass("active"),$("#red-ui-subflow-input-remove").addClass("active"),e.changed=!0,RED.events.emit("subflows:change",e),{subflowInputs:[t],links:o}}}function o(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var o=[];for(e.sort((function(e,t){return t.i-e.i})),i=0;i<e.length;i++){var n=e[i];t.out.splice(n.i,1);var a=[],r=[];RED.nodes.eachLink((function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==n.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==n.i?a.push(e):e.sourcePort>n.i&&r.push(e))})),a.forEach((function(e){RED.nodes.removeLink(e)})),r.forEach((function(e){e.sourcePort--})),o=o.concat(a);for(var s=n.i;s<t.out.length;s++)t.out[s].i--,t.out[s].dirty=!0}return t.changed=!0,RED.events.emit("subflows:change",t),{subflowOutputs:e,links:o}}}function n(){var e=RED.nodes.subflow(RED.workspaces.active());if(e.status){var t=[];return RED.nodes.eachLink((function(o){"subflow"==o.target.type&&o.target.z==e.id&&"status"==o.target.direction&&t.push(o)})),t.forEach((function(e){RED.nodes.removeLink(e)})),delete e.status,$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status),{links:t}}}function a(e){var t=RED.nodes.subflow(RED.workspaces.active());r(t);var o=[];if(t)return RED.nodes.filterNodes({type:"subflow:"+t.id}).forEach((function(i){o.push({id:i.id,changed:i.changed}),e&&(i.changed=!0),i.inputs=t.in.length,i.outputs=t.out.length,i.resize=!0,i.dirty=!0,RED.editor.updateNodeProperties(i)})),RED.editor.validateNode(t),{instances:o}}function r(e){e&&($("#red-ui-subflow-input-add").toggleClass("active",0!==e.in.length),$("#red-ui-subflow-input-remove").toggleClass("active",0===e.in.length),$("#red-ui-subflow-output .spinner-value").text(e.out.length),$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status))}function s(i){var s=$("#red-ui-workspace-toolbar");s.empty(),$('<a class="button" id="red-ui-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="red-ui-subflow-input-remove" class="button active" href="#">0</a><a id="red-ui-subflow-input-add" class="button" href="#">1</a></div>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="red-ui-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="red-ui-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="red-ui-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(s),$('<span class="button-group"><span class="button" style="padding:0"><label for="red-ui-subflow-status"><input id="red-ui-subflow-status" type="checkbox"> <span data-i18n="subflow.status"></span></label></span></span>').appendTo(s),$('<a class="button" id="red-ui-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(s),s.i18n(),$("#red-ui-subflow-output-remove").on("click",(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=i.changed,r=o();if(r){var s=a(!0);RED.history.push({t:"delete",links:r.links,subflowOutputs:r.subflowOutputs,changed:n,dirty:t,subflow:{instances:s.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}})),$("#red-ui-subflow-output-add").on("click",(function(t){t.preventDefault(),function(t){var o=RED.nodes.subflow(RED.workspaces.active()),i=e(o,!1),n={type:"subflow",direction:"out",z:o.id,i:o.out.length,x:i.x,y:i.y,id:RED.nodes.id()},r=o.out.length;o.out.push(n),o.dirty=!0;var s=RED.nodes.dirty(),d=o.changed;o.changed=!0;var l={t:"edit",node:o,dirty:s,changed:d,subflow:{outputCount:r,instances:a(!0).instances}};RED.history.push(l),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-output .spinner-value").text(o.out.length),RED.events.emit("subflows:change",o)}()})),$("#red-ui-subflow-input-add").on("click",(function(t){t.preventDefault(),function(){var t=RED.nodes.subflow(RED.workspaces.active());if(1!==t.in.length){var o=e(t,!0),i={type:"subflow",direction:"in",z:t.id,i:t.in.length,x:o.x,y:o.y,id:RED.nodes.id()},n=t.in.length;t.in.push(i),t.dirty=!0;var r=RED.nodes.dirty(),s=t.changed;t.changed=!0;var d={t:"edit",node:t,dirty:r,changed:s,subflow:{inputCount:n,instances:a(!0).instances}};RED.history.push(d),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-input-add").addClass("active"),$("#red-ui-subflow-input-remove").removeClass("active"),RED.events.emit("subflows:change",t)}}()})),$("#red-ui-subflow-input-remove").on("click",(function(e){e.preventDefault();var o=RED.nodes.dirty(),n=i.changed;i.changed=!0;var r=t();if(r){var s=a(!0);RED.history.push({t:"delete",links:r.links,changed:n,subflowInputs:r.subflowInputs,dirty:o,subflow:{instances:s.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}})),$("#red-ui-subflow-status").on("change",(function(t){if(this.checked)!function(){var t=RED.nodes.subflow(RED.workspaces.active());if(!t.status){var o=e(t,!1),i={type:"subflow",direction:"status",z:t.id,x:o.x,y:o.y,id:RED.nodes.id()};t.status=i,t.dirty=!0;var n=RED.nodes.dirty(),r=t.changed;t.changed=!0,a(!0);var s={t:"edit",node:t,dirty:n,changed:r,subflow:{status:!0}};RED.history.push(s),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),RED.events.emit("subflows:change",t),$("#red-ui-subflow-status").prop("checked",!!t.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!t.status)}}();else{var o=i.status,r=i.changed,s=n();if(s){i.changed=!0;var d=RED.nodes.dirty();RED.history.push({t:"delete",links:s.links,changed:r,dirty:d,subflow:{id:i.id,status:o}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw()}}})),$("#red-ui-subflow-edit").on("click",(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()})),$("#red-ui-subflow-delete").on("click",(function(e){e.preventDefault();var t=RED.nodes.subflow(RED.workspaces.active());if(t.instances.length>0){var o=$("<div>");$("<p>").text(RED._("subflow.subflowInstances",{count:t.instances.length})).appendTo(o),$("<p>").text(RED._("subflow.confirmDelete")).appendTo(o);var i=RED.notify(o,{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close()}},{text:RED._("workspace.confirmDelete"),class:"primary",click:function(){i.close(),n()}}]})}else n();function n(){var e=RED.nodes.dirty(),t=d(RED.workspaces.active());t.t="delete",t.dirty=e,RED.history.push(t)}})),r(i),$("#red-ui-workspace-chart").css({"margin-top":"40px"}),$("#red-ui-workspace-toolbar").show()}function d(e,t){var o=[],i=[],n=[],a=RED.nodes.subflow(e);RED.nodes.eachNode((function(i){t||i.type!="subflow:"+e||o.push(i),i.z==e&&o.push(i)})),RED.nodes.eachConfig((function(t){t.z==e&&o.push(t)})),RED.nodes.groups(e).forEach((function(e){n.push(e)}));for(var r=RED.nodes.junctions(e),s=0;s<r.length;s++){var d=RED.nodes.removeJunction(r[s]);i=i.concat(d.links)}var l=[];for(s=0;s<o.length;s++){d=RED.nodes.remove(o[s].id);i=i.concat(d.links),l=l.concat(d.nodes)}for(o=o.concat(l),n=RED.nodes.groups(e).filter((function(e){return!e.g})),s=0;s<n.length;s++)n[s].nodes.forEach((function(e){"group"===e.type&&n.push(e)}));for(s=n.length-1;s>=0;s--)RED.nodes.removeGroup(n[s]);return RED.nodes.removeSubflow(a),RED.workspaces.remove(a),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:o,links:i,groups:n,junctions:r,subflows:[a]}}function l(){var e=0;RED.nodes.eachSubflow((function(t){var o=new RegExp("^Subflow (\\d+)$").exec(t.name);o&&(e=Math.max(e,o[1]))}));var t="Subflow "+(e+1),o=RED.nodes.id(),i={type:"subflow",id:o,name:t,info:"",in:[],out:[]};RED.nodes.addSubflow(i),RED.history.push({t:"createSubflow",subflow:{subflow:i},dirty:RED.nodes.dirty()}),RED.workspaces.show(o),RED.nodes.dirty(!0)}function c(e){return RED.settings.get("editor").view["view-snap-grid"]&&(e=Math.round(e/RED.view.gridSize())*RED.view.gridSize()),e}function u(e){var t=RED.nodes.node(e);return t||RED.nodes.junction(e)}function p(){var e=RED.view.selection();if(e.nodes){for(var t,o,i=new Set,n=e.nodes.slice(),a=new Set;n.length>0;)"group"===(o=n.shift()).type&&(a.add(o.id),n=n.concat(o.nodes)),i.add(o);var r=(i=Array.from(i))[0].g,s=[];for(t=0;t<i.length;t++)if(i[t].g&&!a.has(i[t].g)&&r!==i[t].g)return void RED.notify("Cannot create subflow across multiple groups","error");r&&(r=RED.nodes.group(r));var d={},l=[],p=[],f=[],h=[],g={},v=[i[0].x,i[0].y,i[0].x,i[0].y];for(t=0;t<i.length;t++)o=i[t],d[o.id]={n:o,outputs:{}},v=[Math.min(v[0],o.x),Math.min(v[1],o.y),Math.max(v[2],o.x),Math.max(v[3],o.y)];var m=c(v[0]-200),b=c(v[1]-80),y=[c((v[2]+v[0])/2),c((v[3]+v[1])/2)];RED.nodes.eachLink((function(e){d[e.source.id]&&d[e.target.id],d[e.source.id]&&!d[e.target.id]&&(h.push(e),p.push(e)),!d[e.source.id]&&d[e.target.id]&&(f.push(e),g[e.target.id]=e.target,p.push(e))}));var w={};if((h=h.filter((function(e){return w[e.source.id+":"+e.sourcePort]?(w[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),w[e.source.id+":"+e.sourcePort]=e,!0)}))).sort((function(e,t){return e.source.y-t.source.y})),Object.keys(g).length>1)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var E=0;RED.nodes.eachSubflow((function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(E=Math.max(E,t[1]))}));var D="Subflow "+(E+1),R=RED.nodes.id(),x={type:"subflow",id:R,name:D,info:"",in:Object.keys(g).map((function(e,t){var o=t;return{type:"subflow",direction:"in",x:c(g[e].x-g[e].w/2-80-m),y:c(g[e].y-b),z:R,i:o,id:RED.nodes.id(),wires:[{id:g[e].id}]}})),out:h.map((function(e,t){var o=t;return{type:"subflow",direction:"out",x:c(e.source.x+e.source.w/2+80-m),y:c(e.source.y-b),z:R,i:o,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}}))};RED.nodes.addSubflow(x);var _={id:RED.nodes.id(),type:"subflow:"+x.id,x:y[0],y:y[1],z:RED.workspaces.active(),inputs:x.in.length,outputs:x.out.length,h:Math.max(30,15*(x.out.length||0)),changed:!0};for(_._def=RED.nodes.getType(_.type),RED.editor.validateNode(_),RED.nodes.add(_),r&&(RED.group.addToGroup(r,_),i.forEach((function(e){if(e.g===r.id){delete e.g;var t=r.nodes.indexOf(e);r.nodes.splice(t,1),s.push(e)}})),r.dirty=!0),f.forEach((function(e){var t={source:e.source,sourcePort:e.sourcePort,target:_};l.push(t),RED.nodes.addLink(t)})),h.forEach((function(e,t){e.targets.forEach((function(e){var o={source:_,sourcePort:t,target:e};l.push(o),RED.nodes.addLink(o)}))})),x.in.forEach((function(e){e.wires.forEach((function(t){var o={source:e,sourcePort:0,target:u(t.id)};l.push(o),RED.nodes.addLink(o)}))})),x.out.forEach((function(e,t){e.wires.forEach((function(t){var o={source:u(t.id),sourcePort:t.port,target:e};l.push(o),RED.nodes.addLink(o)}))})),t=0;t<p.length;t++)RED.nodes.removeLink(p[t]);for(t=0;t<i.length;t++)o=i[t],/^link /.test(o.type)&&(o.links=o.links.filter((function(e){var t=d.hasOwnProperty(e);if(!t){var i=u(e);if(i&&i.links){var n=i.links.indexOf(o.id);n>-1&&i.links.splice(n,1)}}return t}))),o.x-=m,o.y-=b,RED.nodes.moveNodeToTab(o,x.id);var $={t:"createSubflow",nodes:[_.id],links:l,subflow:{subflow:x,offsetX:m,offsetY:b},activeWorkspace:RED.workspaces.active(),removedLinks:p,dirty:RED.nodes.dirty()};r&&(($={t:"multi",events:[$]}).events.push({t:"addToGroup",group:r,nodes:[_]}),$.events.push({t:"removeFromGroup",group:r,nodes:s,reparent:!1})),RED.history.push($),RED.editor.validateNode(x),RED.nodes.dirty(!0),RED.view.updateActive(),RED.view.select(null),RED.view.focus()}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}function f(e,t,o,i){o.label=o.label||{},("cred"===t.type||t.parent&&"cred"===t.parent.type)&&!o.type?(o.type="cred",o.opts={}):o.type?o.opts||(o.opts="select"===o.type?{opts:[]}:{}):(o.type="input",o.opts={types:RED.editor.envVarList.DEFAULT_ENV_TYPE_LIST});var n=o.label||{},a=RED.i18n.lang(),r=RED.editor.envVarList.lookupLabel(n,n["en-US"]||t.name,a),s=$("<label>").appendTo(e);$("<span>&nbsp;</span>").appendTo(e);var d,l=$("<span></span>").appendTo(s);if(o.icon){var c=RED.utils.separateIconPath(o.icon);c&&$("<i class='fa "+c.file+"'/>").appendTo(l)}if("checkbox"!==o.type){var u=o.icon?{"padding-left":"5px"}:{};$("<span>").css(u).text(r).appendTo(s),"none"===o.type&&s.width("100%")}var p={value:"",type:"str"};switch(t.parent&&(p.value=t.parent.value,p.type=t.parent.type),t.hasOwnProperty("value")&&(p.value=t.value),t.hasOwnProperty("type")&&(p.type=t.type),o.type){case"input":if(d=$('<input type="text">').css("width","70%").appendTo(e),o.opts.types&&o.opts.types.length>0){var f=p.type;-1===o.opts.types.indexOf(f)&&(f=o.opts.types[0]),d.typedInput({types:o.opts.types,default:f}),d.typedInput("value",p.value),"cred"===f&&i.credentials&&(i.credentials[t.name]?d.typedInput("value",i.credentials[t.name]):i.credentials["has_"+t.name]?d.typedInput("value","__PWRD__"):d.typedInput("value",""))}else d.val(p.value);break;case"select":d=$("<select>").css("width","70%").appendTo(e),o.opts.opts&&o.opts.opts.forEach((function(e){$("<option>").val(e.v).text(RED.editor.envVarList.lookupLabel(e.l,e.l["en-US"]||e.v,a)).appendTo(d)})),d.val(p.value);break;case"checkbox":s.css("cursor","default");var h=$("<label>").css("width","70%").appendTo(e);d=$('<input type="checkbox">').css({marginTop:0,width:"auto",height:"34px"}).appendTo(h),l.css({"padding-left":"5px"}).appendTo(h),$("<span>").css({"padding-left":"5px"}).text(r).appendTo(h);var g=!1;g="bool"===p.type?"true"===p.value:"num"===p.type?"0"!==p.value:""!==p.value,d.prop("checked",g);break;case"spinner":d=$("<input>").css("width","70%").appendTo(e);var v={};o.opts.hasOwnProperty("min")&&(v.min=o.opts.min),o.opts.hasOwnProperty("max")&&(v.max=o.opts.max),d.spinner(v).parent().width("70%"),d.val(p.value);break;case"cred":d=$('<input type="password">').css("width","70%").appendTo(e),i.credentials?i.credentials[t.name]?d.val(i.credentials[t.name]):i.credentials["has_"+t.name]?d.val("__PWRD__"):d.val(""):d.val(""),d.typedInput({types:["cred"],default:"cred"})}d&&d.attr("id",m(t.name))}function h(e,t,o){e.empty();for(var i=0;i<t.length;i++){var n=t[i];if(!n.ui||"hide"!==n.ui.type)f($("<div/>",{class:"form-row"}).appendTo(e),n,n.ui||{},o)}}function g(e,t){if(e){var o=[];return e.each((function(e){var i=$(this).data("data"),n=(i.parent?i.name:i.nameField.val()).trim();if(""!==n||i.ui&&"none"===i.ui.type){var a=i.valueField,r=a.typedInput("value"),s=a.typedInput("type");if(t||!i.parent||i.parent.value!==r||i.parent.type!==s){var d={name:n,type:s,value:r};if(i.ui){var l={icon:i.ui.icon,label:$.extend(!0,{},i.ui.label),type:i.ui.type,opts:$.extend(!0,{},i.ui.opts)};switch(l.icon||delete l.icon,$.isEmptyObject(l.label)&&delete l.label,l.type){case"input":JSON.stringify(l.opts)===JSON.stringify({types:RED.editor.envVarList.DEFAULT_ENV_TYPE_LIST})&&(delete l.type,delete l.opts);break;case"cred":"cred"===d.type&&delete l.type,delete l.opts;break;case"select":l.opts&&$.isEmptyObject(l.opts.opts)&&delete l.opts;break;case"spinner":$.isEmptyObject(l.opts)&&delete l.opts;break;default:delete l.opts}$.isEmptyObject(l)||(d.ui=l)}o.push(d)}}})),o}return null}function v(e){var t={},o=[];if(/^subflow:/.test(e.type)){var i=RED.nodes.subflow(e.type.substring(8));if(i.env&&i.env.forEach((function(e){var i={name:e.name,parent:{type:e.type,value:e.value},ui:$.extend(!0,{},e.ui)};o.push(i),t[e.name]=i})),e.env)for(var n=0;n<e.env.length;n++){var a=e.env[n];t.hasOwnProperty(a.name)&&(t[a.name].type=a.type,t[a.name].value=a.value)}}else if(e._def.subflowModule){Object.keys(e._def.defaults).forEach((function(t){if("name"!==t){var i,n=e._def.defaults[t],a=e[t],r=a;if(n.ui&&"cred"===n.ui.type)i="cred";else switch(typeof a){case"string":i="str";break;case"number":i="num";break;case"boolean":i="bool",r=a?"true":"false";break;default:i=a.type,r=a.value}var s={name:t,type:i,value:r,parent:{type:n.type,value:n.value},ui:$.extend(!0,{},n.ui)};o.push(s)}}))}return o}function m(e){return"node-input-subflow-env-"+e.replace(/[^a-z0-9-_]/gi,"_")}return{init:function(){RED.events.on("workspace:change",(function(e){var t=RED.nodes.subflow(e.workspace);t?s(t):($("#red-ui-workspace-toolbar").hide().empty(),$("#red-ui-workspace-chart").css({"margin-top":"0"}))})),RED.events.on("view:selection-changed",(function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)})),RED.actions.add("core:create-subflow",l),RED.actions.add("core:convert-to-subflow",p),$('<script type="text/x-red" data-template-name="subflow"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div><div id="subflow-input-ui"></div><\/script>').appendTo("#red-ui-editor-node-configs"),$('<script type="text/x-red" data-template-name="subflow-template"><div class="form-row"><label for="subflow-input-name" data-i18n="[append]common.label.name"><i class="fa fa-tag"></i>  </label><input type="text" id="subflow-input-name" data-i18n="[placeholder]common.label.name"></div><div class="form-row"><ul style="margin-bottom: 20px;" id="subflow-env-tabs"></ul></div><div id="subflow-env-tabs-content"><div id="subflow-env-tab-edit"><div class="form-row node-input-env-container-row" id="subflow-input-edit-ui"><ol id="node-input-env-container"></ol><div class="node-input-env-locales-row"><i class="fa fa-language"></i> <select id="subflow-input-env-locale"></select></div></div></div><div id="subflow-env-tab-preview"><div id="subflow-input-ui"/></div></div><\/script>').appendTo("#red-ui-editor-node-configs")},createSubflow:l,convertToSubflow:p,removeSubflow:d,refresh:a,removeInput:t,removeOutput:o,removeStatus:n,buildEditForm:function(e,t){"subflow-template"===e?(!function(e,t){var o=RED.tabs.create({id:"subflow-env-tabs",onchange:function(o){"subflow-env-tab-preview"===o.id&&h($("#subflow-input-ui"),g(e.editableList("items"),!0),t),$("#subflow-env-tabs-content").children().hide(),$("#"+o.id).show()}});o.addTab({id:"subflow-env-tab-edit",label:RED._("editor-tab.envProperties")}),o.addTab({id:"subflow-env-tab-preview",label:RED._("editor-tab.preview")});var i=RED.settings.theme("languages").map((function(e){return{text:RED._("languages."+e)||e,val:e}})).sort((function(e,t){return e.text.localeCompare(t.text)}));RED.popover.tooltip($(".node-input-env-locales-row i"),RED._("editor.locale"));var n=$("#subflow-input-env-locale");i.forEach((function(e){var t={value:e.val};"en-US"===e.val&&(t.selected=""),$("<option/>",t).text(e.text).appendTo(n)}));var a=RED.i18n.lang();n.val(a),n.on("change",(function(){RED.editor.envVarList.setLocale($(this).val(),$("#node-input-env-container"))})),RED.editor.envVarList.setLocale(a)}($("#node-input-env-container"),t),RED.editor.envVarList.create($("#node-input-env-container"),t)):"subflow"===e&&h($("#subflow-input-ui"),v(t),t)},exportSubflowTemplateEnv:g,exportSubflowInstanceEnv:function(e){var t=[];return v(e).forEach((function(e){var o,i=e.ui||{};i.type?i.opts=i.opts||{}:e.parent&&"cred"===e.parent.type?i.type="cred":(i.type="input",i.opts={types:RED.editor.envVarList.DEFAULT_ENV_TYPE_LIST});var n=$("#"+m(e.name));if(n.length||"cred"===i.type){switch(o={name:e.name},i.type){case"input":i.opts.types&&i.opts.types.length>0?(o.value=n.typedInput("value"),o.type=n.typedInput("type")):(o.value=n.val(),o.type="str");break;case"cred":o.value=n.val(),o.type="cred";break;case"spinner":o.value=n.val(),o.type="num";break;case"select":o.value=n.val(),o.type="str";break;case"checkbox":o.type="bool",o.value=""+n.prop("checked")}"cred"!==i.type&&o.type===e.parent.type&&o.value===e.parent.value||t.push(o)}})),t}}}(),RED.group=function(){for(var e=["#ff0000","#ffC000","#ffff00","#92d04f","#0070c0","#001f60","#6f2fa0","#000000","#777777"],t=e.length,o=0,i=3*e.length;o<i;o++){var n=o%t,a=Math.floor(o/t)+1,r=e[n],s=parseInt(r.substring(1,3),16),d=parseInt(r.substring(3,5),16),l=parseInt(r.substring(5,7),16),c=(255-s)/(3+(n===t-1?0:1)),u=(255-d)/(3+(n===t-1?0:1)),p=(255-l)/(3+(n===t-1?0:1)),f=(((s=Math.min(255,Math.floor(s+a*c)))<<16)+((d=Math.min(255,Math.floor(d+a*u)))<<8)+(l=Math.min(255,Math.floor(l+a*p)))).toString(16);e.push("#"+"000000".slice(0,6-f.length)+f)}var h,g={label:!0,"label-position":"nw"};function v(e){var t=/^rgb\((\d+), (\d+), (\d+)\)$/.exec(e);if(t){var o=((parseInt(t[1])<<16)+(parseInt(t[2])<<8)+parseInt(t[3])).toString(16);return"#"+"000000".slice(0,6-o.length)+o}return e}function m(e){var t=[],o=RED.nodes.group(e.g);return e.nodes.forEach((function(e){t.push(e),o?(e.g=o.id,o.nodes.push(e),o.dirty=!0,e.dirty=!0):delete e.g,"group"===e.type?RED.events.emit("groups:change",e):"junction"!==e.type?RED.events.emit("nodes:change",e):RED.events.emit("junctions:change",e)})),RED.nodes.removeGroup(e),t}function b(e){if(0!==e.length){if(!(e.filter((function(e){return"subflow"===e.type})).length>0)){var t={id:RED.nodes.id(),type:"group",nodes:[],style:JSON.parse(JSON.stringify(g)),x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,w:0,h:0,_def:RED.group.def};t.z=e[0].z,RED.nodes.addGroup(t);try{y(t,e)}catch(e){return void RED.notify(e,"error")}return t}RED.notify(RED._("group.errors.cannotAddSubflowPorts"),"error")}}function y(e,t){var o,i,n,a;for(Array.isArray(t)||(t=[t]),o=0;o<t.length;o++){if(!(i=t[o]).z)throw new Error("Cannot add node without a z property to a group");if(n){if(n!==i.z)throw new Error("Cannot add nooes with different z properties")}else n=i.z;if(i.g&&!a){if(0!==o)throw new Error(RED._("group.errors.cannotCreateDiffGroups"));a=i.g}if(a!==i.g)throw new Error(RED._("group.errors.cannotCreateDiffGroups"))}for(a&&((a=RED.nodes.group(a)).nodes.push(e),a.dirty=!0,e.g=a.id),o=0;o<t.length;o++)if("subflow"!==(i=t[o]).type){if(a&&i.g===a.id){var r=a.nodes.indexOf(i);r>-1&&a.nodes.splice(r,1)}i.g=e.id,i.dirty=!0,e.nodes.push(i),e.x=Math.min(e.x,i.x-i.w/2-25-(i._def.button&&"right"!==i._def.align?20:0)),e.y=Math.min(e.y,i.y-i.h/2-25),e.w=Math.max(e.w,i.x+i.w/2+25+(i._def.button&&"right"==i._def.align?20:0)-e.x),e.h=Math.max(e.h,i.y+i.h/2+25-e.y),"group"===i.type?RED.events.emit("groups:change",i):"junction"!==i.type?RED.events.emit("nodes:change",i):RED.events.emit("junctions:change",i)}a&&RED.events.emit("groups:change",e),E(e)}function w(e,t,o){var i;Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++)if(t[n].g!==e.id)return;var a=RED.nodes.group(e.g);for(n=0;n<t.length;n++){(i=t[n]).dirty=!0;var r=e.nodes.indexOf(i);e.nodes.splice(r,1),o&&e.g?(i.g=e.g,a.nodes.push(i)):delete i.g,"group"===i.type?RED.events.emit("groups:change",i):"junction"!==i.type?RED.events.emit("nodes:change",i):RED.events.emit("junctions:change",i)}E(e)}function E(e){for(e.dirty=!0;e;)e.dirty=!0,e=RED.nodes.group(e.g)}return{def:{defaults:{name:{value:""},style:{value:{label:!0}},nodes:{value:[]},env:{value:[]}},category:"config",oneditprepare:function(){var o=this.style||{};RED.editor.colorPicker.create({id:"node-input-style-stroke",value:o.stroke||g.stroke||"#a4a4a4",defaultValue:"#a4a4a4",palette:e,cellPerRow:t,cellWidth:16,cellHeight:16,cellMargin:3,none:!0,opacity:o.hasOwnProperty("stroke-opacity")?o["stroke-opacity"]:g.hasOwnProperty("stroke-opacity")?g["stroke-opacity"]:1}).appendTo("#node-input-row-style-stroke"),RED.editor.colorPicker.create({id:"node-input-style-fill",value:o.fill||g.fill||"none",defaultValue:"none",palette:e,cellPerRow:t,cellWidth:16,cellHeight:16,cellMargin:3,none:!0,opacity:o.hasOwnProperty("fill-opacity")?o["fill-opacity"]:g.hasOwnProperty("fill-opacity")?g["fill-opacity"]:1}).appendTo("#node-input-row-style-fill"),function(e){var t=$("<div>",{style:"display:inline-block"}),o=$("<input/>",{id:e.id,type:"hidden",value:e.value}).appendTo(t),i=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(t);$('<i class="fa fa-caret-down"></i>').appendTo(i);var n=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),a=$("<div>",{class:"red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"}).appendTo(n),r=function(){var e=o.val();a.removeClass().addClass("red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"+e)};return i.on("click",(function(e){var t,n=$("<div/>",{class:"red-ui-group-layout-picker"}).css({width:"126px"}),a=null;a=$("<div/>").appendTo(n);for(var s=0;s<2;s++){var d="ns"[s];a=$("<div/>").appendTo(n);for(var l=0;l<3;l++){var c=d+["w","","e"][l],u=$("<button/>",{class:"red-ui-search-result-node red-ui-button","data-pos":c}).appendTo(a);u.on("click",(function(e){e.preventDefault(),o.val($(this).data("pos")),p.hide(),r()})),$("<div>",{class:"red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"+c}).appendTo(u),c===o.val()&&(t=u)}}r();var p=RED.popover.panel(n);p.show({target:i,onclose:function(){i.focus()}}),t&&t.focus()})),r(),t}({id:"node-input-style-label-position",value:o["label-position"]||"nw"}).appendTo("#node-input-row-style-label-position"),RED.editor.colorPicker.create({id:"node-input-style-color",value:o.color||g.color||"#a4a4a4",defaultValue:"#a4a4a4",palette:e,cellPerRow:t,cellWidth:16,cellHeight:16,cellMargin:3}).appendTo("#node-input-row-style-label-color"),$("#node-input-style-label").toggleButton({enabledLabel:RED._("editor.show"),disabledLabel:RED._("editor.show")}),$("#node-input-style-label").on("change",(function(e){$("#node-input-row-style-label-options").toggle($(this).prop("checked"))})),$("#node-input-style-label").prop("checked",this.style.label),$("#node-input-style-label").trigger("change")},oneditresize:function(e){},oneditsave:function(){this.style.stroke=$("#node-input-style-stroke").val(),this.style.fill=$("#node-input-style-fill").val(),this.style["stroke-opacity"]=$("#node-input-style-stroke-opacity").val(),this.style["fill-opacity"]=$("#node-input-style-fill-opacity").val(),this.style.label=$("#node-input-style-label").prop("checked"),this.style.label?(this.style["label-position"]=$("#node-input-style-label-position").val(),this.style.color=$("#node-input-style-color").val()):(delete this.style["label-position"],delete this.style.color);var e=this;["stroke","fill","stroke-opacity","fill-opacity","color","label-position"].forEach((function(t){e.style[t]===g[t]&&delete e.style[t]})),this.resize=!0},set:{module:"node-red"}},init:function(){RED.events.on("view:selection-changed",(function(e){var t=!!e.nodes,o=!1,i=!1,n=!1,a=!1;t&&(a=1===e.nodes.length&&"group"===e.nodes[0].type,e.nodes.forEach((function(e){"group"===e.type&&(o=!0),e.g&&(n=!0)})),o&&(i=e.nodes.length>1)),RED.menu.setDisabled("menu-item-group-group",!t),RED.menu.setDisabled("menu-item-group-ungroup",!o),RED.menu.setDisabled("menu-item-group-merge",!i),RED.menu.setDisabled("menu-item-group-remove",!n),RED.menu.setDisabled("menu-item-edit-copy-group-style",!a),RED.menu.setDisabled("menu-item-edit-paste-group-style",!o)})),RED.actions.add("core:group-selection",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){var t=b(e.nodes);if(t){var o={t:"createGroup",groups:[t],dirty:RED.nodes.dirty()};RED.history.push(o),RED.view.select({nodes:[t]}),RED.nodes.dirty(!0),RED.view.focus()}}}()})),RED.actions.add("core:ungroup-selection",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){var t=[];groups=e.nodes.filter((function(e){return"group"===e.type}));var o={t:"ungroup",groups:[],dirty:RED.nodes.dirty()};groups.forEach((function(e){t=t.concat(m(e)),o.groups.push(e)})),RED.history.push(o),RED.view.select({nodes:t}),RED.nodes.dirty(!0),RED.view.focus()}}()})),RED.actions.add("core:merge-selection-to-group",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){for(var t,o,i,n=[],a={t:"multi",events:[]},r={t:"ungroup",groups:[]},s=0;s<e.nodes.length;s++)if(t=e.nodes[s],0===s)o=t.g;else if(t.g!==o)return void RED.notify(RED._("group.errors.cannotCreateDiffGroups"),"error");for(s=0;s<e.nodes.length;s++)"group"===(t=e.nodes[s]).type?(i||(i=t),r.groups.push(t),n=n.concat(m(t))):n.push(t),t.dirty=!0;r.groups.length>0&&a.events.push(r);var d=b(n);d&&(i&&(d.style=i.style,d.name=i.name),RED.view.select({nodes:[d]})),a.events.push({t:"createGroup",groups:[d],dirty:RED.nodes.dirty()}),RED.history.push(a),RED.nodes.dirty(!0),RED.view.focus()}}()})),RED.actions.add("core:remove-selection-from-group",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){var t=RED.nodes.group(e.nodes[0].g);if(t)try{w(t,e.nodes,!0);var o={t:"removeFromGroup",dirty:RED.nodes.dirty(),group:t,nodes:e.nodes};RED.history.push(o),RED.nodes.dirty(!0)}catch(e){return void RED.notify(e,"error")}RED.view.select({nodes:e.nodes}),RED.view.focus()}}()})),RED.actions.add("core:copy-group-style",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();e.nodes&&1===e.nodes.length&&"group"===e.nodes[0].type&&(h=JSON.parse(JSON.stringify(e.nodes[0].style)),RED.notify(RED._("clipboard.groupStyleCopied"),{id:"clipboard"}),RED.menu.setDisabled("menu-item-edit-paste-group-style",!1))}()})),RED.actions.add("core:paste-group-style",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;if(h){var e=RED.view.selection();if(e.nodes){var t={t:"multi",events:[],dirty:RED.nodes.dirty()};e.nodes.forEach((function(e){"group"===e.type&&(t.events.push({t:"edit",node:e,changes:{style:JSON.parse(JSON.stringify(e.style))},dirty:RED.nodes.dirty()}),e.style=JSON.parse(JSON.stringify(h)),e.dirty=!0)})),t.events.length>0&&(RED.history.push(t),RED.nodes.dirty(!0),RED.view.redraw())}}}()})),$('<script type="text/x-red" data-template-name="group"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div><div class="form-row" id="node-input-row-style-stroke"><label data-i18n="editor:common.label.style"></label><label style="width: 70px;margin-right:10px" for="node-input-style-stroke" data-i18n="editor:common.label.line"></label></div><div class="form-row" style="padding-left: 100px;" id="node-input-row-style-fill"><label style="width: 70px;margin-right: 10px "  for="node-input-style-fill" data-i18n="editor:common.label.fill"></label></div><div class="form-row"><label for="node-input-style-label" data-i18n="editor:common.label.label"></label><input type="checkbox" id="node-input-style-label"/></div><div class="form-row" id="node-input-row-style-label-options"><div style="margin-left: 100px; display: inline-block"><div class="form-row"><span style="display: inline-block; min-width: 140px"  id="node-input-row-style-label-color"><label style="width: 70px;margin-right: 10px" for="node-input-style-fill" data-i18n="editor:common.label.color"></label></span></div><div class="form-row"><span style="display: inline-block; min-width: 140px;" id="node-input-row-style-label-position"><label style="width: 70px;margin-right: 10px " for="node-input-style-label-position" data-i18n="editor:common.label.position"></label></span></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs");var e=$("<div>",{class:"red-ui-flow-group-body",style:"position: absolute; top: -1000px;"}).appendTo(document.body),t=getComputedStyle(e[0]);g={stroke:v(t.stroke),"stroke-opacity":t.strokeOpacity,fill:v(t.fill),"fill-opacity":t.fillOpacity,label:!0,"label-position":"nw"},e.remove(),e=$("<div>",{class:"red-ui-flow-group-label",style:"position: absolute; top: -1000px;"}).appendTo(document.body),t=getComputedStyle(e[0]),g.color=v(t.fill),e.remove()},createGroup:b,ungroup:m,addToGroup:y,removeFromGroup:w,getNodes:function e(t,o,i){var n=[];return t.nodes.forEach((function(t){"group"===t.type&&i||n.push(t),o&&"group"===t.type&&(n=n.concat(e(t,o,i)))})),n},contains:function e(t,o){if(o.g===t.id)return!0;for(var i=0;i<t.nodes.length;i++)if("group"===t.nodes[i].type&&e(t.nodes[i],o))return!0;return!1},markDirty:E}}(),RED.userSettings=function(){var e=700,t=!1,o=[];function i(e){o.push(e)}function n(i){if(!t)if(RED.user.hasPermission("settings.write")){t=!0;var n={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(t){e=t.width},open:function(e){var t=e.find(".red-ui-tray-body"),n=$("<div></div>").appendTo(t),a=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(n);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(a);var r=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout((function(){s.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()}),50)}}),s=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(n);o.forEach((function(e){r.addTab({id:"red-ui-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(s)})),n.i18n(),r.activateTab("red-ui-settings-tab-"+(i||"view")),$("#red-ui-sidebar-shade").show()},close:function(){t=!1,o.forEach((function(e){e.close&&e.close()})),$("#red-ui-sidebar-shade").hide()},show:function(){}};null!==e&&(n.width=e),RED.tray.show(n)}else RED.notify(RED._("user.errors.settings"),"error")}function a(e){var t=RED._("languages."+e);return{text:t||e,val:e}}function r(e,t){return e.text.localeCompare(t.text)}var s=[{options:[{setting:"editor-language",local:!0,label:"menu.label.view.language",options:function(e){e([{val:"",text:RED._("menu.label.view.browserDefault")}].concat(RED.settings.theme("languages").map(a).sort(r)))}}]},{title:"menu.label.view.view",options:[{setting:"view-store-zoom",label:"menu.label.view.storeZoom",default:!1,toggle:!0,onchange:function(e){e||RED.settings.removeLocal("zoom-level")}},{setting:"view-store-position",label:"menu.label.view.storePosition",default:!1,toggle:!0,onchange:function(e){e||RED.settings.removeLocal("scroll-positions")}}]},{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",default:!0,toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",default:!0,toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"},{setting:"view-node-show-label",label:"menu.label.showNodeLabelDefault",default:!0,toggle:!0}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"},{setting:"view-show-welcome-tours",label:"menu.label.showWelcomeTours",toggle:!0,default:!0}]}],d={};function l(){var e=$('<div id="red-ui-settings-tab-view" class="red-ui-help"></div>'),t=RED.settings.get("editor")||{};return t.view=t.view||{},s.forEach((function(o){o.title&&$("<h3></h3>").text(RED._(o.title)).appendTo(e),o.options.forEach((function(o){var i;i=o.local?localStorage.getItem(o.setting):t.view[o.setting];var n=$('<div class="red-ui-settings-row"></div>').appendTo(e);if(o.toggle)$('<label for="user-settings-'+o.setting+'"><input id="user-settings-'+o.setting+'" type="checkbox"> '+RED._(o.label)+"</label>").appendTo(n).find("input").prop("checked",i);else if(o.options){$('<label for="user-settings-'+o.setting+'">'+RED._(o.label)+"</label>").appendTo(n);var a=$('<select id="user-settings-'+o.setting+'"></select>').appendTo(n);"function"==typeof o.options&&(o.options((function(e){e.forEach((function(e){var t=e,o=e;"string"!=typeof e&&(t=e.val,o=e.text),$("<option>").val(t).text(o).appendTo(a)}))})),a.val(i))}else $('<label for="user-settings-'+o.setting+'">'+RED._(o.label)+"</label>").appendTo(n),$('<input id="user-settings-'+o.setting+'" type="'+(o.type||"text")+'">').appendTo(n).val(i)}))})),e}function c(e,t){var o=d[e];if(o.local)localStorage.setItem(o.setting,t);else{var i=RED.settings.get("editor")||{};i.view=i.view||{},i.view[o.setting]=t,RED.settings.set("editor",i);var n=o.onchange;"string"==typeof n&&(n=RED.actions.get(n)),n&&n.call(o,t)}}return{init:function(){RED.actions.add("core:show-user-settings",n),RED.actions.add("core:show-help",(function(){n("keyboard")})),i({id:"view",title:RED._("menu.label.view.view"),get:l,close:function(){s.forEach((function(e){e.options.forEach((function(e){var t=$("#user-settings-"+e.setting);e.toggle?c(e.setting,t.prop("checked")):c(e.setting,t.val())}))}))}});var e=RED.settings.get("editor")||{};e.view=e.view||{};var t=!1;s.forEach((function(o){o.options.forEach((function(o){if(o.local)d[o.setting]=o;else{if(o.oldSetting){var i=RED.settings.get(o.oldSetting);null!=i&&(e.view[o.setting]=i,t=!0,RED.settings.remove(o.oldSetting))}d[o.setting]=o;var n=e.view[o.setting];if(null==n&&o.hasOwnProperty("default")&&(n=o.default,e.view[o.setting]=n,t=!0),o.onchange){var a=o.onchange;"string"==typeof a&&(a=RED.actions.get(a)),a&&a.call(o,n)}}}))})),t&&RED.settings.set("editor",e)},toggle:function(e){var t=d[e],o=RED.settings.get("editor")||{};o.view=o.view||{},c(e,!o.view[t.setting])},show:n,add:i}}(),RED.projects=function(){var e,t,o;function i(e){var t;"git_missing_user"===e.code?t=RED.notify("<p>"+RED._("projects.errors.no-username-email")+"</p>",{fixed:!0,type:"error",buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("projects.config-git"),click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),t=RED.notify("<p>"+RED._("projects.errors.unexpected")+":</p><p>"+e.message+"</p><small>"+RED._("projects.errors.code")+": "+e.code+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:RED._("common.label.close"),click:function(){t.close()}}]}))}var n={};function a(){var t=$('<div class="red-ui-projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(t),$("<hr>").appendTo(t);var a,s,l,c,u,p,f,h={};n={welcome:{content:function(e){var o=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(o);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(o);$("<p>").text(RED._("projects.welcome.hello")).appendTo(i),$("<p>").text(RED._("projects.welcome.desc0")).appendTo(i),$("<p>").text(RED._("projects.welcome.desc1")).appendTo(i),$("<p>").text(RED._("projects.welcome.desc2")).appendTo(i);var n=$('<div style="text-align: center"></div>').appendTo(i),a=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.welcome.create")+"</button>").appendTo(n),s=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.welcome.clone")+"</button>").appendTo(n);return a.on("click",(function(e){e.preventDefault(),h={action:"create"},r("git-config")})),s.on("click",(function(e){e.preventDefault(),h={action:"clone"},r("git-config")})),o},buttons:[{text:RED._("projects.welcome.openExistingProject"),class:"secondary",click:function(){h={action:"open"},r("git-config")}},{text:RED._("projects.welcome.not-right-now"),click:function(){h={},$(this).dialog("close")}}]},"git-config":{content:function(e){var o=!1,i=RED.settings.get("git");i&&i.user?i=i.user:RED.settings.git&&RED.settings.git.globalUser&&(o=!0,i=RED.settings.git.globalUser);var n=function(){var e=p.val().trim(),t=f.val().trim(),o=e.length>0&&t.length>0;$("#red-ui-projects-dialog-git-config").prop("disabled",!o).toggleClass("disabled ui-button-disabled ui-state-disabled",!o)},a=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(a);var r=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(a);$("<p>").text(RED._("projects.git-config.setup")).appendTo(r),$("<p>").text(RED._("projects.git-config.desc0")).appendTo(r),$("<p>").text(RED._("projects.git-config.desc1")).appendTo(r),o&&$("<p>").text(RED._("projects.git-config.desc2")).appendTo(r),$("<p>").text(RED._("projects.git-config.desc3")).appendTo(r);var s=$('<div class="form-row"></div>').appendTo(r);return $('<label for="">'+RED._("projects.git-config.username")+"</label>").appendTo(s),(p=$('<input type="text">').val(i&&i.name||"").appendTo(s)).on("change keyup paste",n),s=$('<div class="form-row"></div>').appendTo(r),$('<label for="">'+RED._("projects.git-config.email")+"</label>").appendTo(s),(f=$('<input type="text">').val(i&&i.email||"").appendTo(s)).on("change keyup paste",n),setTimeout((function(){p.trigger("focus"),n()}),50),a},buttons:[{text:RED._("common.label.back"),click:function(){r("welcome")}},{id:"red-ui-projects-dialog-git-config",text:RED._("common.label.next"),class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=p.val(),e.user.email=f.val(),RED.settings.set("git",e),"create"===h.action?r("project-details"):"clone"===h.action?r("clone-project"):"open"===h.action&&r("create",{screen:"open"})}}]},"project-details":{content:function(e){var o=null,i=!1;$.getJSON("projects",(function(e){o={},e.projects.forEach((function(e){o[e]=!0,i&&(i=!1,r())}))}));var n=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(n);var a=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text(RED._("projects.project-details.create")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc0")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc1")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc2")).appendTo(a);var r=function(){var e=c.val(),t=!0;if(g){if(null===o)return void(i=!0);f.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||o[e]?(c.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(f),l=!1,t=!1,o[e]?projectNameSublabel.text(RED._("projects.project-details.already-exists")):projectNameSublabel.text(RED._("projects.project-details.must-contain"))):(c.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(f),projectNameSublabel.text(RED._("projects.project-details.must-contain")),l=!0),v=e}t=l,$("#red-ui-projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},s=$('<div class="form-row"></div>').appendTo(a);$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.project-details.project-name")+"</label>").appendTo(s);var d=$('<div style="position:relative;"></div>').appendTo(s);c=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').val(h.name||"").appendTo(d);var l,p,f=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(d),g=!1,v="";return c.on("change keyup paste",(function(){if(g=c.val()!==v,p)clearTimeout(p);else if(g&&(f.empty(),$('<img src="red/images/spin.svg"/>').appendTo(f),""===c.val()))return void r();p=setTimeout((function(){r(),p=null}),300)})),projectNameSublabel=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.must-contain")+"</small></label>").appendTo(s).find("small"),s=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(a),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.project-details.desc")+"</label>").appendTo(s),u=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').val(h.summary||"").appendTo(s),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.opt")+"</small></label>").appendTo(s),setTimeout((function(){c.trigger("focus"),c.trigger("change")}),50),n},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){r("git-config")}},{id:"red-ui-projects-dialog-create-name",disabled:!0,text:RED._("common.label.next"),class:"primary disabled",click:function(){h.name=c.val(),h.summary=u.val(),r("default-files",e)}}]}},"clone-project":function(){var o,n,a,s,l,c,u,p;return{content:function(i){var r=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(r);var d=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(r);$("<p>").text(RED._("projects.clone-project.clone")).appendTo(d),$("<p>").text(RED._("projects.clone-project.desc0")).appendTo(d);var f=null,h=!1;$.getJSON("projects",(function(e){f={},e.projects.forEach((function(e){f[e]=!0,h&&(h=!1,v())}))}));var g,v=function(){var e=o.val(),t=!0;if(E){if(null===f)return void(h=!0);w.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||f[e]?(o.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(w),b=!1,t=!1,f[e]?c.text(RED._("projects.clone-project.already-exists")):c.text(RED._("projects.clone-project.must-contain"))):(o.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(w),c.text(RED._("projects.clone-project.must-contain")),b=!0),D=e}t=b;var i=a.val(),n=i.length>0&&!/\s/.test(i);/^https?:\/\/[^/]+@/i.test(i)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.no-info-in-url")),n=!1),n?a.removeClass("input-error"):(x&&a.addClass("input-error"),t=!1),/^https?:\/\//.test(i)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(i)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()),$("#red-ui-projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(d),$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.clone-project.project-name")+"</label>").appendTo(g);var m=$('<div style="position:relative;"></div>').appendTo(g);o=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(m);var b,y,w=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(m),E=!1,D="",R="";o.on("change keyup paste",(function(){if(E=o.val()!==D,y)clearTimeout(y);else if(E&&(w.empty(),$('<img src="red/images/spin.svg"/>').appendTo(w),""===o.val()))return void v();y=setTimeout((function(){v(),y=null}),300)})),c=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.must-contain")+"</small></label>").appendTo(g).find("small"),g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(d),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.clone-project.git-url")+"</label>").appendTo(g),a=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(g),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.protocols")+"</small></label>").appendTo(g);var x=!1,_="";a.on("change keyup paste",(function(){x=!0;var e=$(this).val();_!==e&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),_=e;var t=/\/([^/]+?)(?:\.git)?$/.exec(e);if(t){var i=o.val();""!==i&&i!==R||(R=t[1],o.val(R),o.trigger("change"))}v()}));var k=$('<div class="red-ui-projects-dialog-screen-create-row"></div>').appendTo(d);g=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(k),$('<div><i class="fa fa-warning"></i> '+RED._("projects.clone-project.auth-failed")+"</div>").appendTo(g),g=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(k);m=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(g);$('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.clone-project.username")+"</label>").appendTo(m),s=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(m),m=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(g),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.clone-project.passwd")+"</label>").appendTo(m),(l=$('<input style="width:100%" id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(m)).typedInput({type:"cred"}),g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(k),m=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(g),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.ssh-key")+"</label>").appendTo(m),u=$("<select>",{style:"width: 100%"}).appendTo(m),$.getJSON("settings/user/keys",(function(e){var t=0;e.keys.forEach((function(e){u.append($("<option></option>").val(e.name).text(e.name)),t++})),0===t?(u.addClass("input-error"),u.attr("disabled",!0),T.show()):(u.removeClass("input-error"),u.attr("disabled",!1),T.hide())})),m=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(g),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.passphrase")+"</label>").appendTo(m),(p=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(m)).typedInput({type:"cred"}),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(k);var T=$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(m);return $('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.clone-project.ssh-key-desc")+"</div>").appendTo(T),m=$('<div style="text-align: center">').appendTo(T),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("projects.clone-project.ssh-key-add")+"</button>").appendTo(m).on("click",(function(t){t.preventDefault(),e.dialog("close"),RED.userSettings.show("gitconfig"),setTimeout((function(){$("#user-settings-gitconfig-add-key").trigger("click")}),500)})),g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(d),$("<label>"+RED._("projects.clone-project.credential-key")+"</label>").appendTo(g),(n=$('<input style="width: 100%" type="password"></input>').appendTo(g)).typedInput({type:"cred"}),r},buttons:function(t){return[{text:RED._("common.label.back"),click:function(){r("git-config")}},{id:"red-ui-projects-dialog-clone-project",disabled:!0,text:RED._("common.label.clone"),class:"primary disabled",click:function(){$(".red-ui-projects-dialog-screen-create-type.selected").data("type");var t={name:o.val()};t.credentialSecret=n.val();var r=a.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(r)){var c=u.val();if(!c)return void console.log(RED._("projects.clone-project.cant-get-ssh-key"));t.git={remotes:{origin:{url:r,keyFile:c,passphrase:p.val()}}}}else t.git={remotes:{origin:{url:r,username:s.val(),password:l.val()}}};$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),s.removeClass("input-error"),l.removeClass("input-error"),u.removeClass("input-error"),p.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t.name),d({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(t){e.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.clone-project.already-exists2"))},git_error:function(e){console.log(RED._("projects.clone-project.git-error"),e)},git_connection_failed:function(e){a.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.connection-failed"))},git_not_a_repository:function(e){a.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.not-git-repo"))},git_repository_not_found:function(e){a.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.repo-not-found"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),s.addClass("input-error"),l.addClass("input-error"),u.addClass("input-error"),p.addClass("input-error")},missing_flow_file:function(t){e.dialog("close")},missing_package_file:function(t){e.dialog("close")},project_empty:function(t){e.dialog("close")},credentials_load_failed:function(t){e.dialog("close")},"*":function(t){i(t),$(e).dialog("close")}}}},t).then((function(){RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1),RED.events.emit("project:change",{name:name})})).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]}}}(),"default-files":{content:function(e){var o=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(o);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(o);$("<p>").text(RED._("projects.default-files.create")).appendTo(i),$("<p>").text(RED._("projects.default-files.desc0")).appendTo(i),$("<p>").text(RED._("projects.default-files.desc1")).appendTo(i),!e.existingProject&&RED.settings.files&&$("<p>").text(RED._("projects.default-files.desc2")).appendTo(i);var n=function(){var e=!0,t=s.val();""!==t&&/\.json$/.test(t)?(s.hasClass("input-error")&&(s.removeClass("input-error"),s.next().empty()),l.hasClass("input-error")&&(l.removeClass("input-error"),l.next().empty()),l.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,s.hasClass("input-error")||(s.addClass("input-error"),s.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),l.text(""),l.hasClass("input-error")||(l.addClass("input-error"),l.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#red-ui-projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},a=$('<div class="form-row"></div>').appendTo(i);$('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.default-files.flow-file")+"</label>").appendTo(a);var r=$('<div style="position:relative;"></div>').appendTo(a),d=h.files&&h.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";s=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val(d).on("change keyup paste",n).appendTo(r),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(r),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(a);var c=h.files&&h.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return a=$('<div class="form-row"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-credfile">'+RED._("projects.default-files.credentials-file")+"</label>").appendTo(a),r=$('<div style="position:relative;"></div>').appendTo(a),l=$('<div style="width: 100%" class="uneditable-input" id="red-ui-projects-dialog-screen-create-project-credentials">').text(c).appendTo(r),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(r),setTimeout((function(){s.trigger("focus"),n()}),50),o},buttons:function(e){return[{text:RED._(e.existingProject?"common.label.cancel":"common.label.back"),click:function(){e.existingProject?$(this).dialog("close"):r("project-details",e)}},{id:"red-ui-projects-dialog-create-default-files",text:RED._("common.label.next"),class:"primary",click:function(){h.files={flow:s.val(),credentials:l.text()},e.existingProject||(h.migrateFiles=!0),r("encryption-config",e)}}]}},"encryption-config":{content:function(e){var o=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(o);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(o);$("<p>").text(RED._("projects.encryption-config.setup")).appendTo(i),e.existingProject?($("<p>").text(RED._("projects.encryption-config.desc0")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc1")).appendTo(i)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text(RED._("projects.encryption-config.desc2")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc3")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc4")).appendTo(i)):("user"===RED.settings.flowEncryptionType?$("<p>").text(RED._("projects.encryption-config.desc5")).appendTo(i):"system"===RED.settings.flowEncryptionType&&$("<p>").text(RED._("projects.encryption-config.desc6")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc7")).appendTo(i));var n=function(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==a.val()),$("#red-ui-projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},r=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(i);$("<label>"+RED._("projects.encryption-config.credentials")+"</label>").appendTo(r);var s=$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(r),d=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(s),l=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(s),c=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(l);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(c);var u=$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled"></div>').appendTo(l);return $('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(u),l.find("input[name=projects-encryption-type]").on("click",(function(e){var t,o;"enabled"===$(this).val()?(t=c,o=u,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&a.trigger("focus")):(o=c,t=u,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),o.addClass("disabled"),n()})),r=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="red-ui-projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?RED._("projects.encryption-config.disabled"):"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.copy")+"</span></label>").appendTo(r),r=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="red-ui-projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.use-custom")+"</span></label>").appendTo(r),r=$('<div class="projects-encryption-enabled-row"></div>').appendTo(d),(a=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(r)).typedInput({type:"cred"}),a.on("change keyup paste",n),r=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(d),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.encryption-config.desc8")+"</div>").appendTo(r),d.find("input[name=projects-encryption-key]").on("click",(function(){var e=$(this).val();a.attr("disabled","default"===e),"custom"===e&&a.trigger("focus"),n()})),setTimeout((function(){l.find("input[name=projects-encryption-type][value=enabled]").trigger("click"),"user"!==RED.settings.flowEncryptionType?d.find("input[name=projects-encryption-key][value=custom]").trigger("click"):d.find("input[name=projects-encryption-key][value=default]").trigger("click"),n()}),100),o},buttons:function(t){return[{text:RED._("common.label.back"),click:function(){r("default-files",t)}},{id:"red-ui-projects-dialog-create-encryption",text:RED._(t.existingProject?"projects.encryption-config.create-project-files":"projects.encryption-config.create-project"),class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(h.credentialSecret=a.val()):h.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(h.name);var n="POST",s="projects";t.existingProject&&(h.initialise=!0,n="PUT",s="projects/"+o.name);var l=this;d({url:s,type:n,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){h={},t.existingProject?$(l).dialog("close"):(r("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log(RED._("projects.encryption-config.already-exists"))},git_error:function(e){console.log(RED._("projects.encryption-config.git-error"),e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log(RED._("projects.encryption-config.git-auth-error"),e)},"*":function(t){i(t),$(e).dialog("close")}}}},h).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]}},"create-success":{content:function(e){var o=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(o);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(o);return $("<p>").text(RED._("projects.create-success.success")).appendTo(i),$("<p>").text(RED._("projects.create-success.desc0")).appendTo(i),$("<p>").text(RED._("projects.create-success.desc1")).appendTo(i),$("<p>").text(RED._("projects.create-success.desc2")).appendTo(i),o},buttons:[{text:RED._("common.label.done"),click:function(){$(this).dialog("close")}}]},create:function(){var t,n,a,r,s,l,c,u,p,f,h,g,v;return{title:RED._("projects.create.projects"),content:function(e){var i=null;v=null;var s=!1;$.getJSON("projects",(function(e){i={},e.projects.forEach((function(e){i[e]=!0,s&&(s=!1,y())}))}));var m,b=$('<div class="red-ui-projects-dialog-screen-create"></div>'),y=function(){var e=t.val(),o=!0;if(T){if(null===i)return void(s=!0);k.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||i[e]?(t.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(k),x=!1,o=!1,i[e]?f.text(RED._("projects.create.already-exists")):f.text(RED._("projects.create.must-contain"))):(t.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(k),f.text(RED._("projects.create.must-contain")),x=!0),C=e}o=x;var n=$(".red-ui-projects-dialog-screen-create-type.selected").data("type");if("copy"===n)o=!1;else if("clone"===n){var r=l.val(),d=r.length>0&&!/\s/.test(r);/^https?:\/\/[^/]+@/i.test(r)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-info-in-url")),d=!1),d?l.removeClass("input-error"):(P&&l.addClass("input-error"),o=!1),/^https?:\/\//.test(r)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(r)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===n){var u=a.val();if(""!==u&&/\.json$/.test(u)?a.hasClass("input-error")&&(a.removeClass("input-error"),a.next().empty()):(o=!1,a.hasClass("input-error")||(a.addClass("input-error"),a.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val())"custom"===$("input[name=projects-encryption-key]:checked").val()&&(o=o&&""!==c.val())}else"open"===n&&(o=!!v);$("#red-ui-projects-dialog-create").prop("disabled",!o).toggleClass("disabled ui-button-disabled ui-state-disabled",!o)};m=$('<div class="form-row button-group"></div>').appendTo(b);var w=$('<button data-type="open" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>'+RED._("projects.create.open")+"</button>").appendTo(m),E=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.create.create")+"</button>").appendTo(m),D=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.create.clone")+"</button>").appendTo(m);m.find(".red-ui-projects-dialog-screen-create-type").on("click",(function(e){switch(e.preventDefault(),b.find(".red-ui-projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),b.find(".red-ui-projects-dialog-screen-create-row").hide(),b.find(".red-ui-projects-dialog-screen-create-row-"+$(this).data("type")).show(),y(),t.trigger("focus"),$(this).data("type")){case"open":$("#red-ui-projects-dialog-create").text(RED._("projects.create.open"));break;case"empty":$("#red-ui-projects-dialog-create").text(RED._("projects.create.create"));break;case"clone":$("#red-ui-projects-dialog-create").text(RED._("projects.create.clone"))}})),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-open"></div>').hide().appendTo(b),function(e){(e=e||{}).height;var t,i=$("<div></div>",{class:"red-ui-projects-dialog-project-list-container"}),n="",a=$("<div>",{class:"red-ui-search-container"}).appendTo(i),r=$('<input id="red-ui-projects-dialog-project-list-search" type="text" placeholder="'+RED._("projects.create-project-list.search")+'">').appendTo(a).searchBox({delay:200,change:function(){n=$(this).val().toLowerCase(),c.editableList("filter"),t&&!t.is(":visible")?(t.children().children().removeClass("selected"),(t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))):((t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))),s()}});r.on("keydown",(function(o){if(40===o.keyCode){o.preventDefault();var i=t;if(t){do{i=i.next()}while(0!==i.length&&!i.is(":visible"));if(0===i.length)return;t.children().children().removeClass("selected")}else i=c.children(":visible").first();(t=i).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),s()}else if(38===o.keyCode){o.preventDefault();var n=t;if(t){do{n=n.prev()}while(0!==n.length&&!n.is(":visible"));if(0===n.length)return;t.children().children().removeClass("selected")}else n=c.children(":visible").first();(t=n).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),s()}else 13===o.keyCode&&(o.preventDefault(),t&&e.dblclick&&e.dblclick(t.children().data("data")))})),r.i18n();var s=function(){var e=c.find(".red-ui-projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=l,o=t.height(),i=(t.scrollTop(),e.position().top),n=e.height();i+n>o?t.animate({scrollTop:"-="+(o-i-n)},50):i<0&&t.animate({scrollTop:"+="+i},50)}},l=$("<div></div>",{class:"red-ui-projects-dialog-project-list-inner-container"}).appendTo(i),c=$("<ol>",{class:"red-ui-projects-dialog-project-list"}).appendTo(l).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(i,n,a){var l=$("<div></div>",{class:"red-ui-projects-dialog-project-list-entry"}).appendTo(i);if($('<span class="red-ui-projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(l),$('<span class="red-ui-projects-dialog-project-list-entry-name" style=""></span>').text(a.name).appendTo(l),!o||o.name!==a.name||(l.addClass("projects-list-entry-current"),$('<span class="red-ui-projects-dialog-project-list-entry-current">'+RED._("projects.create-project-list.current")+"</span>").appendTo(l),!1!==e.canSelectActive)){l.addClass("selectable");var u=$('<div class="red-ui-projects-dialog-project-list-entry-tools"></div>').appendTo(l);$('<button class="red-ui-button red-ui-projects-dialog-button red-ui-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(u).on("click",(function(t){t.stopPropagation(),t.preventDefault(),function(e,t,o){var i=$('<div class="red-ui-projects-dialog-project-list-entry-delete-confirm"></div>').on("click",(function(e){e.stopPropagation()})).appendTo(e);$("<span>").text(RED._("projects.delete.confirm")).appendTo(i),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("common.label.cancel")+"</button>").appendTo(i).on("click",(function(e){e.stopPropagation(),i.remove(),o(!0)})),$('<button class="red-ui-button red-ui-projects-dialog-button primary">'+RED._("common.label.delete")+"</button>").appendTo(i).on("click",(function(e){e.stopPropagation(),i.remove(),d({url:"projects/"+t,type:"DELETE",responses:{200:function(e){o(!1)},400:{unexpected_error:function(e){i.remove(),o(!0)}}}})})),setTimeout((function(){i.css("left",0)}),50)}(i,a.name,(function(t){t||i.fadeOut(300,(function(){c.editableList("removeItem",a),e.delete&&e.delete(a)}))}))})),i.on("click",(function(o){$(".red-ui-projects-dialog-project-list-entry").removeClass("selected"),l.addClass("selected"),t=i.parent(),e.select&&e.select(a),s(),r.trigger("focus")})),e.dblclick&&i.on("dblclick",(function(t){t.preventDefault(),e.dblclick(a)}))}},filter:function(e){return""===n||-1!==e.name.toLowerCase().indexOf(n)}});return $.getJSON("projects",(function(e){e.projects.forEach((function(e){c.editableList("addItem",{name:e})}))})),i}({canSelectActive:!1,dblclick:function(e){v=e,$("#red-ui-projects-dialog-create").trigger("click")},select:function(e){v=e,y()},delete:function(e){i&&delete i[e.name],v=null,y()}}).appendTo(m),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-open"></div>').hide().appendTo(b),$('<span style="display: flex; align-items: center;"><input style="padding:0; margin: 0 5px 0 0" checked type="checkbox" id="red-ui-projects-dialog-screen-clear-context"> <label for="red-ui-projects-dialog-screen-clear-context" style="padding:0; margin: 0"> <span data-i18n="projects.create.clearContext"></span></label></span>').appendTo(m).i18n(),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(b),$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.create.project-name")+"</label>").appendTo(m);var R=$('<div style="position:relative;"></div>').appendTo(m);t=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(R);var x,_,k=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(R),T=!1,C="",j="";t.on("change keyup paste",(function(){if(T=t.val()!==C,_)clearTimeout(_);else if(T&&(k.empty(),$('<img src="red/images/spin.svg"/>').appendTo(k),""===t.val()))return void y();_=setTimeout((function(){y(),_=null}),300)})),f=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.must-contain")+"</small></label>").appendTo(m).find("small"),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(b),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.create.desc")+"</label>").appendTo(m),n=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').appendTo(m),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.opt")+"</small></label>").appendTo(m),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(b),$('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.create.flow-file")+"</label>").appendTo(m),R=$('<div style="position:relative;"></div>').appendTo(m),a=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",y).appendTo(R),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(R),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(m),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(b),$("<label>"+RED._("projects.create.credentials")+"</label>").appendTo(m);var L=$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(m),S=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(L),O=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(L),I=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(O);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(I);var N=$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled disabled"></div>').appendTo(O);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(N),O.find("input[name=projects-encryption-type]").on("click",(function(e){var t,o;"enabled"===$(this).val()?(t=I,o=N,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&c.trigger("focus")):(o=I,t=N,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),o.addClass("disabled"),y()})),m=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(S),$('<label class="red-ui-projects-edit-form-inline-label">'+RED._("projects.create.encryption-key")+"</label>").appendTo(m),(c=$('<input type="password"></input>').appendTo(m)).typedInput({type:"cred"}),c.on("change keyup paste",y),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.desc0")+"</small></label>").appendTo(m),m=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(S),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.create.desc1")+"</div>").appendTo(m),S.find("input[name=projects-encryption-key]").on("click",(function(){var e=$(this).val();c.attr("disabled","default"===e),"custom"===e&&c.trigger("focus"),y()})),m=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(b),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.create.git-url")+"</label>").appendTo(m),l=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(m),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.protocols")+"</small></label>").appendTo(m);var P=!1,A="";l.on("change keyup paste",(function(){P=!0;var e=$(this).val();A!==e&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),A=e;var o=/\/([^/]+?)(?:\.git)?$/.exec(e);if(o){var i=t.val();""!==i&&i!==j||(j=o[1],t.val(j),t.trigger("change"))}y()}));var M=$('<div class="hide red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').hide().appendTo(b);m=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(M),$('<div><i class="fa fa-warning"></i> '+RED._("projects.create.auth-failed")+"</div>").appendTo(m),m=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(M);R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(m);$('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.create.username")+"</label>").appendTo(R),u=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(R),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(m),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.create.password")+"</label>").appendTo(R),(p=$('<input style="width:100%" id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(R)).typedInput({type:"cred"}),m=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(M),R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(m),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.ssh-key")+"</label>").appendTo(R),h=$("<select>",{style:"width: 100%"}).appendTo(R),$.getJSON("settings/user/keys",(function(e){var t=0;e.keys.forEach((function(e){h.append($("<option></option>").val(e.name).text(e.name)),t++})),0===t?(h.addClass("input-error"),h.attr("disabled",!0),z.show()):(h.removeClass("input-error"),h.attr("disabled",!1),z.hide())})),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(m),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.passphrase")+"</label>").appendTo(R),(g=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(R)).typedInput({type:"cred"}),R=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(M);var z=$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(R);switch($('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.create.desc2")+"</div>").appendTo(z),R=$('<div style="text-align: center">').appendTo(z),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("projects.create.add-ssh-key")+"</button>").appendTo(R).on("click",(function(e){e.preventDefault(),$("#red-ui-projects-dialog-cancel").trigger("click"),RED.userSettings.show("gitconfig"),setTimeout((function(){$("#user-settings-gitconfig-add-key").trigger("click")}),500)})),m=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(b),$("<label>"+RED._("projects.create.credentials-encryption-key")+"</label>").appendTo(m),(r=$('<input style="width:100%" type="password"></input>').appendTo(m)).typedInput({type:"cred"}),e.screen||"empty"){case"empty":E.trigger("click");break;case"open":w.trigger("click");break;case"clone":D.trigger("click")}return setTimeout((function(){"open"!==(e.screen||"empty")?t.trigger("focus"):$("#red-ui-projects-dialog-project-list-search").trigger("focus")}),50),b},buttons:function(o){var f;switch(o.screen||"empty"){case"open":f=RED._("projects.create.open");break;case"empty":f=RED._("projects.create.create");break;case"clone":f=RED._("projects.create.clone")}return[{id:"red-ui-projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-projects-dialog-create",text:f,class:"primary disabled",disabled:!0,click:function(){var o=$(".red-ui-projects-dialog-screen-create-type.selected").data("type"),f={name:t.val()};if("empty"===o){f.summary=n.val(),f.files={flow:a.val()};var m=$("input[name=projects-encryption-type]:checked").val();f.credentialSecret="enabled"===m&&c.val()}else if("copy"===o)f.copy=s.name;else if("clone"===o){f.credentialSecret=r.val();var b=l.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(b)){var y=h.val();if(!y)return void console.log(RED._("projects.create.cant-get-ssh-key-path"));f.git={remotes:{origin:{url:b,keyFile:y,passphrase:g.val()}}}}else f.git={remotes:{origin:{url:b,username:u.val(),password:p.val()}}}}else if("open"===o){var w=$("#red-ui-projects-dialog-screen-clear-context").prop("checked");return function(t,o,i){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t),d({url:"projects/"+t,type:"PUT",responses:{200:function(e){i(null,e)},400:{credentials_load_failed:function(o){e.dialog("close"),RED.events.emit("project:change",{name:t}),i(null,o)},"*":i}}},{active:!0,clearContext:o}).then((function(){e.dialog("close"),RED.events.emit("project:change",{name:t})})).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}(v.name,w,(function(e,t){e&&"credentials_load_failed"!==e.code&&console.log(RED._("projects.create.unexpected_error"),e)}))}$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),u.removeClass("input-error"),p.removeClass("input-error"),h.removeClass("input-error"),g.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(f.name),d({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(t){e.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.create.already-exists-2"))},git_error:function(e){console.log(RED._("projects.create.git-error"),e)},git_connection_failed:function(e){l.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.con-failed"))},git_not_a_repository:function(e){l.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.not-git"))},git_repository_not_found:function(e){l.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-resource"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),u.addClass("input-error"),p.addClass("input-error"),h.addClass("input-error"),g.addClass("input-error")},missing_flow_file:function(t){e.dialog("close")},missing_package_file:function(t){e.dialog("close")},project_empty:function(t){e.dialog("close")},credentials_load_failed:function(t){e.dialog("close")},"*":function(t){i(t),$(e).dialog("close")}}}},f).then((function(){RED.events.emit("project:change",{name:name})})).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]}}}()}}function r(o,i){e||RED.projects.init();var a=n[o],r=a.content(i||{});t.empty();var s=a.buttons;"function"==typeof s&&(s=s(i||{})),e.dialog("option","buttons",s),t.append(r);var d=590,l=$(window).height();l<750&&(d=590-(750-l)),$(".red-ui-projects-dialog-box").height(d),$(".red-ui-projects-dialog-project-list-inner-container").height(Math.max(500,d)-210),e.dialog("option","title",a.title||""),e.dialog("open")}function s(e){if(RED.nodes.dirty())var t=RED._("projects.require-clean.confirm"),o=RED.notify(t,{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close(),e(!0)}},{text:RED._("common.label.cont"),click:function(){o.close(),e(!1)}}]})}function d(e,t){var i,n;if(e.requireCleanWorkspace&&RED.nodes.dirty())return s((function(o){o?e.cancel&&(e.cancel(),n&&n()):(delete e.requireCleanWorkspace,d(e,t).then((function(){i&&i()})).always((function(){n&&n()})))})),{then:function(e){return i=e,{always:function(e){n=e}}},always:function(e){n=e}};var a,r,l=Date.now();return $(".red-ui-component-spinner").show(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),t&&(e.data=JSON.stringify(t),e.contentType="application/json; charset=utf-8"),$.ajax(e).done((function(t,o,i){e.responses&&e.responses[200]&&(a=e.responses[200],r=t)})).fail((function(i,n,s){var l;if(e.responses&&e.responses[i.status]){if("function"==typeof(l=e.responses[i.status]))return a=l,void(r={error:l.statusText});if(!1===e.handleAuthFail||"git_auth_failed"!==i.responseJSON.code&&"git_host_key_verification_failed"!==i.responseJSON.code){if(l[i.responseJSON.code])return a=l[i.responseJSON.code],void(r=i.responseJSON);if(l["*"])return a=l["*"],void(r=i.responseJSON)}else{if("git_auth_failed"===i.responseJSON.code){var c=o.git.remotes[i.responseJSON.remote||e.remote||"origin"].fetch,u=$('<div><div class="form-row">'+RED._("projects.send-req.auth-req")+':</div><div class="form-row"><div style="margin-left: 20px;">'+c+"</div></div></div>"),p=!1;if(/^https?:\/\//.test(c))$('<div class="form-row"><label for="projects-user-auth-username">'+RED._("projects.send-req.username")+'</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for="projects-user-auth-password">'+RED._("projects.send-req.password")+'</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(u),u.find("#projects-user-auth-password").typedInput({type:"cred"});else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(c)){p=!0;var f=$('<div class="form-row"></div>').appendTo(u);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(f);var h=$('<select id="projects-user-auth-key">').width("70%").appendTo(f);$.getJSON("settings/user/keys",(function(e){e.keys.forEach((function(e){h.append($("<option></option>").val(e.name).text(e.name))}))})),f=$('<div class="form-row"></div>').appendTo(u),$('<label for="projects-user-auth-passphrase">'+RED._("projects.send-req.passphrase")+"</label>").appendTo(f),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(f).typedInput({type:"cred"})}var g=RED.notify(u,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){g.close()}},{text:'<span><i class="fa fa-refresh"></i> '+RED._("projects.send-req.retry")+"</span>",click:function(){t=t||{};var n={};p?(n.keyFile=$("#projects-user-auth-key").val(),n.passphrase=$("#projects-user-auth-passphrase").val()):(n.username=$("#projects-user-auth-username").val(),n.password=$("#projects-user-auth-password").val());var a=function(o){o?(console.log(RED._("projects.send-req.update-failed")),console.log(o)):(d(e,t),g.close())};d({url:"projects/"+o.name+"/remotes/"+(i.responseJSON.remote||e.remote||"origin"),type:"PUT",responses:{0:function(e){a(e)},200:function(e){a(null)},400:{unexpected_error:function(e){a(e)}}}},{auth:n})}}]});return}if("git_host_key_verification_failed"===i.responseJSON.code){u=$('<div><div class="form-row">'+RED._("projects.send-req.host-key-verify-failed")+"</div></div>"),g=RED.notify(u,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.close"),click:function(){g.close()}}]});return}}}console.log(l),console.log(RED._("projects.send-req.unhandled")+":"),console.log(i),console.log(n),console.log(s)})).always((function(){var e=Date.now()-l;e=Math.max(0,500-e),setTimeout((function(){$(".red-ui-component-spinner").hide(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),a&&a(r)}),e)}))}function l(e){var t,o="",n=new Set,a=[],r="",s=$('<div class="red-ui-projects-branch-list">').appendTo(e.container),l=$('<input type="text">').attr("placeholder",e.placeholder).appendTo(s).searchBox({delay:200,change:function(){o=$(this).val();var e=!1,i=!1,n=/^([^/]+)\/[^/.~*?\[]/.exec(o);n&&a.indexOf(n[1])>-1&&(e=!0,i=!0),!e&&/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(o)?(t.hasClass("input-error")||(t.addClass("input-error"),t.find("i").addClass("fa-warning").removeClass("fa-code-fork")),t.find("span").text(RED._("projects.create-branch-list.invalid")+": "+(i?"":r)+o)):(t.hasClass("input-error")&&(t.removeClass("input-error"),t.find("i").removeClass("fa-warning").addClass("fa-code-fork")),t.find("span").text(RED._("projects.create-branch-list.create")+":"),t.find(".red-ui-sidebar-vc-branch-list-entry-create-name").text((i?"":r)+o)),u.editableList("filter")}}),u=$("<ol>",{style:"height: 130px;"}).appendTo(s);return u.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(o,i,n){var r=$('<div class="red-ui-sidebar-vc-branch-list-entry">').appendTo(o);n.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(r),$("<span>").text(n.name).appendTo(r),n.current&&(r.addClass("selected"),$('<span class="current"></span>').text(e.currentLabel||RED._("projects.create-branch-list.current")).appendTo(r))):(t=r,$('<i class="fa fa-code-fork"></i>').appendTo(r),$("<span>").text(RED._("projects.create-branch-list.create")+":").appendTo(r),$('<div class="red-ui-sidebar-vc-branch-list-entry-create-name" style="margin-left: 10px;">').text(n.name).appendTo(r)),r.on("click",(function(t){if(t.preventDefault(),!$(this).hasClass("input-error")){var o={};if(n.hasOwnProperty("commit"))$(this).hasClass("selected")&&(o.current=!0),o.name=n.name;else if(o.name=l.val(),o.create=!0,e.remotes){var i=/^([^/]+)\/[^/.~*?\[]/.exec(o.name);i&&-1!==a.indexOf(i[1])||(o.name=a[0]+"/"+o.name)}e.onselect&&e.onselect(o)}}))},filter:function(e){var t=!e.hasOwnProperty("commit"),i=o;if(a.length>0){var r=/^([^/]+)\/[^/.~*?\[]/.exec(i);""===i||r&&-1!=a.indexOf(r[1])||(i=a[0]+"/"+i)}return t&&""!==i&&!n.has(i)||!t&&-1!==e.name.indexOf(o)}}),{refresh:function(t){l.searchBox("value",""),u.editableList("empty");var o=Date.now(),p=c(s).addClass("red-ui-component-spinner-contain");e.remotes?(a=e.remotes(),r=a[0]+"/"):(r="",a=[]),n=new Set,d({url:t,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){e.branches,e.branches.forEach((function(e){u.editableList("addItem",e),n.add(e.name)})),u.editableList("addItem",{}),setTimeout((function(){p.remove()}),Math.max(300-(Date.now()-o),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){i(e)}}}})},filter:function(){u.editableList("filter")},focus:function(){l.trigger("focus")}}}function c(e){return $('<div class="red-ui-component-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function u(){createProjectOptions={},o?r("create",{screen:"empty"}):r("welcome")}return{init:function(){e=$('<div id="red-ui-projects-dialog" class="hide red-ui-projects-edit-form"><div class="red-ui-projects-dialog-box"><form class="form-horizontal"></form><div class="red-ui-component-spinner hide"><img src="red/images/spin.svg"/></div></div></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){RED.keyboard.disable()},close:function(e){RED.keyboard.enable()},classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"}}),t=e.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var o={sendRequest:d,createBranchList:l,addSpinnerOverlay:c,reportUnexpectedError:i};RED.projects.settings.init(o),RED.projects.userSettings.init(o),RED.sidebar.versionControl.init(o),a()},showStartup:function(){console.warn("showStartup"),RED.user.hasPermission("projects.write")?r("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?s((function(e){e||u()})):void u();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?s((function(e){e||r("create",{screen:"open"})})):void r("create",{screen:"open"});RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?(RED.projects.settings.show("settings"),setTimeout((function(){$("#project-settings-tab-settings-file-edit").trigger("click")}),200)):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!o)throw new Error(RED._("projects.create-default-file-set.no-active"));if(!o.empty)throw new Error(RED._("projects.create-default-file-set.no-empty"));RED.user.hasPermission("projects.write")?(createProjectOptions={},r("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(o.name),d({url:"projects/"+o.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log(RED._("projects.create-default-file-set.git-error"),e)},missing_flow_file:function(t){$(e).dialog("close")},"*":function(t){i(t),$(e).dialog("close")}}}},{initialise:!0}).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))},refresh:function(e){$.getJSON("projects",(function(t){t.active?$.getJSON("projects/"+t.active,(function(t){o=t,RED.events.emit("projects:load",o),RED.sidebar.versionControl.refresh(!0),e&&e(o)})):e&&e(null)}))},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return o}}}(),RED.projects.settings=function(){var e,t,o=700,i=!1,n=[];function a(e){n.push(e)}function r(e,o){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:e.description,stateId:"sidebar.project.editDescription",complete:function(i){o.empty();var n=t.addSpinnerOverlay(o),a=function(t,n){if(t)return r(e,o);e.description=i,s(e,o)};t.sendRequest({url:"projects/"+e.name,type:"PUT",responses:{0:function(e){a(e)},200:function(e){a(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){t.reportUnexpectedError(e),a(e)}}}},{description:i}).always((function(){n.remove()}))}})}function s(e,t){var o,i;t.empty(),o=e.description?RED.utils.renderMarkdown(e.description):'<span class="red-ui-help-info-none">'+RED._("sidebar.project.noDescriptionAvailable")+"</span>",(i=$('<span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(o)+'">'+o+"</span>"),$(i).find("a").each((function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")})),i).appendTo(t).find(".red-ui-text-bidi-aware").contents().filter((function(){return 3===this.nodeType&&""!==this.textContent.trim()})).wrap("<span></span>")}function d(e,o,i,n,a){var r=i.prev();r.hide(),i.empty(),a.empty();var s=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(i),u=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(o||"").appendTo(i),p=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(n||"").appendTo(a);$('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(s).on("click",(function(t){t.preventDefault(),l(e.summary,i),c(e.version,a),r.show()})),$('<button class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(s).on("click",(function(s){s.preventDefault();var f=u.val(),h=p.val();l(f,i),c(h,a);var g=t.addSpinnerOverlay(i).addClass("red-ui-component-spinner-contain"),v=function(t,s){if(t)return g.remove(),d(e,o,i,n,a);e.summary=f,e.version=h,g.remove(),l(e.summary,i),c(e.version,a),r.show()};t.sendRequest({url:"projects/"+e.name,type:"PUT",responses:{0:function(e){v(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),v(null)},400:{"*":function(e){t.reportUnexpectedError(e),v(e)}}}},{summary:f,version:h})}))}function l(e,t){t.empty(),e?t.text(e).removeClass("red-ui-help-info-none"):t.text(RED._("sidebar.project.noSummaryAvailable")).addClass("red-ui-help-info-none")}function c(e,t){t.empty(),e&&t.text(e)}function u(e){var t=$('<div id="red-ui-project-settings-tab-main" class="red-ui-project-settings-tab-pane red-ui-help"></div>');$("<h1>").text(e.name).appendTo(t);var o=$('<div style="position: relative">').appendTo(t),i=$("<div></div>").appendTo(o),n=$("<div></div>").addClass("red-ui-help-info-none").appendTo(o);l(e.summary,i),c(e.version,n),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editDescription")+"</button>").prependTo(o).on("click",(function(t){t.preventDefault(),d(e,e.summary,i,e.version,n)})),$("<hr>").appendTo(t);var a=$('<div class="red-ui-help" style="position: relative"></div>').appendTo(t),u=$("<div>",{style:"min-height: 200px"}).appendTo(a);return s(e,u),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editReadme")+"</button>").prependTo(a).on("click",(function(t){t.preventDefault(),r(e,u)})),t}function p(e,t){t.editableList("empty");var o=0;for(var i in E)E.hasOwnProperty(i)&&(t.editableList("addItem",{id:E[i].module,version:E[i].version,count:E[i].count,known:e.dependencies.hasOwnProperty(i),installed:!0}),o++,0===E[i].count&&0,e.dependencies.hasOwnProperty(i)||0);if(e.dependencies)for(var i in e.dependencies)if(e.dependencies.hasOwnProperty(i)&&!E.hasOwnProperty(i)){var n=!!RED.nodes.registry.getModule(i);t.editableList("addItem",{id:i,version:e.dependencies[i],count:0,known:!0,installed:n}),o++,n?0:0}0===o&&t.editableList("addItem",{index:0,label:RED._("sidebar.project.projectSettings.none")})}function f(e,o,i,n){var a=RED.projects.getActiveProject(),r=t.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),s=function(e,t){if(r.remove(),e)return n(e);a.dependencies=i,RED.sidebar.versionControl.refresh(!0),n()};t.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){s(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),s(null)},400:{"*":function(e){s(e)}}}},{dependencies:i})}function h(e,t,o,i){var n=t||JSON.stringify(e.dependencies||{},"",4);"{}"===n&&(n="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:n,requireValid:!0,complete:function(t){try{var n=JSON.parse(t);f(0,o,n,(function(a){if(a)return h(e,t,o,i);e.dependencies=n,p(e,i)}))}catch(n){h(e,t,o,i)}}})}function g(e){var t=$('<div id="red-ui-project-settings-tab-deps" class="red-ui-project-settings-tab-pane red-ui-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="margin-top:10px;float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(t).on("click",(function(i){i.preventDefault(),h(e,null,t,o)}));var o=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return o.editableList({addButton:!1,addItem:function(t,i,n){var a=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(t);if(n.label)0===n.index?a.addClass("red-ui-search-empty"):t.parent().addClass("red-ui-palette-module-section"),a.text(n.label);else{a.addClass("red-ui-palette-module-header"),n.installed?0===n.count?a.addClass("red-ui-palette-module-unused"):n.known||a.addClass("red-ui-palette-module-unknown"):a.addClass("red-ui-palette-module-not-installed"),n.element=a;var r=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"></div>').appendTo(a),s="fa-cube";n.installed||(s="fa-warning");var d=$('<i class="fa '+s+'"></i>').appendTo(r);n.icon=d,$("<span>").text(n.id).appendTo(r);var l=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(a);$("<span>").text(n.version).appendTo(l);l=$('<div class="red-ui-palette-module-meta"></div>').appendTo(a);var c=$('<div class="red-ui-palette-module-button-group"></div>').appendTo(l);RED.user.hasPermission("projects.write")&&(n.installed||!1===RED.settings.get("externalModules.palette.allowInstall",!0)?n.known&&0===n.count?$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.removeFromProject")+"</a>").appendTo(c).on("click",(function(i){i.preventDefault();var a=$.extend(!0,{},e.dependencies);delete a[n.id],f(0,t,a,(function(e){e?console.log(e):t.fadeOut(200,(function(){o.editableList("removeItem",n)}))}))})):n.known||$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.addToProject")+"</a>").appendTo(c).on("click",(function(o){o.preventDefault();var i=$.extend(!0,{},e.dependencies);i[n.id]=E[n.id].version,f(0,t,i,(function(e){e?console.log(e):(c.remove(),a.removeClass("red-ui-palette-module-unknown"))}))})):$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.install")+"</a>").appendTo(c).on("click",(function(e){e.preventDefault(),RED.palette.editor.install(n,t,(function(e){if(!e){n.installed=!0;RED.utils.addSpinnerOverlay(t,!0);setTimeout((function(){o.editableList("removeItem",n),E={},RED.nodes.eachNode(w),RED.nodes.eachConfig(w),E.hasOwnProperty(n.id)?n.count=E[n.id].count:n.count=0,o.editableList("addItem",n)}),500)}}))})))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),p(e,o),t}function v(e,o,i,n,a){var r=$('<div class="red-ui-projects-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),s=t.addSpinnerOverlay(r);return $.getJSON("projects/"+o.name+"/files",(function(e){var t=Object.keys(e);t=t.filter((function(t){return!e[t].status||!/D/.test(e[t].status)}));var o={};t.sort(),t.forEach((function(e){e.split("/").reduce((function(e,t,o,i){if(t)return o<i.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]}),o)}));var d=function(e,t,o){var i={name:e||"/",path:o+(o?"/":"")+e};return!0===t?(i.type="f",i):(i.type="d",i.children=[],i.path=i.path,Object.keys(t).forEach((function(e){i.children.push(d(e,t[e],i.path))})),i.children.sort((function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)})),i)};o=d("",o,"");m(r,o.children,i,n,a,"height: 175px"),s.remove()})),r}function m(e,t,o,i,n,a){a=a||"";var r=$("<ol>",{class:"red-ui-projects-dialog-file-list",style:a}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,a){var r=$("<div></div>",{class:"red-ui-projects-dialog-file-list-entry"}).appendTo(e);if(a.children){if($('<span class="red-ui-projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(r),a.children.length>0){var s=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(e);0===o.indexOf(a.path+"/")?r.addClass("expanded"):s.hide(),m(s,a.children,o,i,n),r.addClass("selectable"),r.on("click",(function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),s.slideUp(200)):($(this).addClass("expanded"),s.slideDown(200))}))}}else{var d="fa-file-o";/\.json$/i.test(a.name)?d="fa-file-code-o":/\.md$/i.test(a.name)?d="fa-book":/^\.git/i.test(a.name)&&(d="fa-code-fork",r.addClass("red-ui-projects-dialog-file-list-entry-file-type-git")),$('<span class="red-ui-projects-dialog-file-list-entry-file"> <i class="fa '+d+'"></i></span>').appendTo(r),i(a)?(r.addClass("selectable"),a.path===o&&r.addClass("selected"),r.on("click",(function(e){$(".red-ui-projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),n(a.path,!0)})),r.on("dblclick",(function(e){e.preventDefault(),n(a.path,!0)}))):r.addClass("unselectable")}$('<span class="red-ui-projects-dialog-file-list-entry-name" style=""></span>').text(a.name).appendTo(r)}});a||r.parent().css("overflow-y",""),t.forEach((function(e){r.editableList("addItem",e)}))}function b(e,o){$("<h3></h3>").text(RED._("sidebar.project.projectSettings.versionControl")).appendTo(o),function(e,o){var i=$('<div class="red-ui-settings-section"></div>').appendTo(o);$("<h4></h4>").text(RED._("sidebar.project.projectSettings.branches")).appendTo(i);var n=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(i),a=$("<ol>").appendTo(n).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(o,i,n){var r=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(o);if(n.empty)return r.addClass("red-ui-search-empty"),void r.text(RED._("sidebar.project.projectSettings.noBranches"));n.current&&r.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(r);var s=$("<span>").appendTo(r),d=$("<div>").appendTo(s);if($('<span class="entry-name">').text(n.name).appendTo(d),n.commit&&$('<span class="entry-detail">').text(n.commit.sha).appendTo(d),n.remote){var l=$("<div>").appendTo(s);$('<span class="entry-detail entry-remote-name">').text(n.remote||"").appendTo(l),n.status.ahead+n.status.behind>0&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+n.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+n.status.behind+"</span></span>").appendTo(l)}if(!n.current){var c=$('<span class="entry-tools">').appendTo(r);$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(c).on("click",(function(i){i.preventDefault();var r=t.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),s=RED.notify(RED._("sidebar.project.projectSettings.deleteConfirm",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){r.remove(),s.close()}},{text:"Delete branch",click:function(){s.close();var i={url:"projects/"+e.name+"/branches/"+n.name,type:"DELETE",responses:{200:function(e){o.fadeOut(200,(function(){a.editableList("removeItem",n),r.remove()}))},400:{git_delete_branch_unmerged:function(e){s=RED.notify(RED._("sidebar.project.projectSettings.unmergedConfirm",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){r.remove(),s.close()}},{text:RED._("sidebar.project.projectSettings.deleteUnmergedBranch"),click:function(){i.url+="?force=true",s.close(),t.sendRequest(i)}}]})},"*":function(e){t.reportUnexpectedError(e),r.remove()}}}};t.sendRequest(i)}}]})}))}}});$.getJSON("projects/"+e.name+"/branches",(function(e){e.branches&&(e.branches.length>0?(e.branches.sort((function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)})),e.branches.forEach((function(e){a.editableList("addItem",e)}))):a.editableList("addItem",{empty:!0}))}))}(e,o);var i=$('<div class="red-ui-settings-section"></div>').appendTo(o),n=$("<h4></h4>").text(RED._("sidebar.project.projectSettings.gitRemotes")).appendTo(i),a=$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("sidebar.project.projectSettings.addRemote")+"</button>").appendTo(n).on("click",(function(e){a.attr("disabled",!0),l.slideDown(200,(function(){l[0].scrollIntoView(),s?(g.val("origin"),v.trigger("focus")):g.trigger("focus"),p()}))})),r={empty:!0},s=!0,d=$('<div class="red-ui-settings-row"></div>').appendTo(i),l=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(d);d=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(i);var c=$("<ol>").appendTo(d);c.editableList({addButton:!1,height:"auto",addItem:function(o,i,n){var a=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(o);if(n.empty)return a.addClass("red-ui-search-empty"),void a.text(RED._("sidebar.project.projectSettings.noRemotes"));$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(a);var d=$("<span>").appendTo(a);$('<div class="entry-name">').text(n.name).appendTo(d),n.urls.fetch===n.urls.push?$('<div class="entry-detail">').text(n.urls.fetch).appendTo(d):($('<div class="entry-detail">').text("fetch: "+n.urls.fetch).appendTo(d),$('<div class="entry-detail">').text("push: "+n.urls.push).appendTo(d));var l=$('<span class="entry-tools">').appendTo(a);$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(l).on("click",(function(i){i.preventDefault();var a=t.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),d=RED.notify(RED._("sidebar.project.projectSettings.deleteRemoteConfrim",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.remove(),d.close()}},{text:RED._("sidebar.project.projectSettings.deleteRemote"),click:function(){d.close(),e.git.branches.remote&&0===e.git.branches.remote.indexOf(n.name+"/")&&delete e.git.branches.remote,e.git.branches.remoteAlt&&0===e.git.branches.remoteAlt.indexOf(n.name+"/")&&delete e.git.branches.remoteAlt;var i={url:"projects/"+e.name+"/remotes/"+n.name,type:"DELETE",responses:{200:function(t){o.fadeOut(200,(function(){c.editableList("removeItem",n),setTimeout(a.remove,100),0===t.remotes.length?(delete e.git.remotes,s=!0,c.editableList("addItem",r)):(e.git.remotes={},t.remotes.forEach((function(t){var o=t.name;delete t.name,e.git.remotes[o]=t}))),delete e.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()}))},400:{"*":function(e){t.reportUnexpectedError(e),a.remove()}}}};t.sendRequest(i)}}]})}))}});var u,p=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(g.val()),t=v.val(),o=t.length>0&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(m.text(RED._("sidebar.project.projectSettings.urlRule2")),o=!1):m.text(RED._("sidebar.project.projectSettings.urlRule")),w.attr("disabled",!e||!o),g.toggleClass("input-error",f&&!e),v.toggleClass("input-error",h&&!o),u&&(u.close(),u=null)},f=!1,h=!1;$('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("sidebar.project.projectSettings.addRemote2")).appendTo(l),d=$('<div class="red-ui-settings-row"></div>').appendTo(l),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.remoteName")).appendTo(d);var g=$('<input type="text">').appendTo(d).on("change keyup paste",(function(){f=!0,p()}));$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.nameRule")+"</small></label>").appendTo(d).find("small"),d=$('<div class="red-ui-settings-row"></div>').appendTo(l),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.url")).appendTo(d);var v=$('<input type="text">').appendTo(d).on("change keyup paste",(function(){h=!0,p()})),m=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.urlRule")+"</small></label>").appendTo(d).find("small"),b=function(){a.attr("disabled",!1),l.hide(),g.val(""),v.val(""),u&&(u.close(),u=null)},y=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(y).on("click",(function(e){e.preventDefault(),b()}));var w=$('<button class="red-ui-button">'+RED._("sidebar.project.projectSettings.addRemote2")+"</button>").appendTo(y).on("click",(function(o){o.preventDefault();var i=t.addSpinnerOverlay(l).addClass("red-ui-component-spinner-contain"),n={name:g.val(),url:v.val()},a=function(e){i.remove(),e||b()};RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+e.name+"/remotes",type:"POST",responses:{0:function(e){a(e)},200:function(t){e.git.remotes={},t.remotes.forEach((function(t){var o=t.name;delete t.name,e.git.remotes[o]=t})),E(),RED.sidebar.versionControl.refresh(),a()},400:{git_remote_already_exists:function(e){u=RED.popover.create({target:g,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),g.addClass("input-error"),a(e)},"*":function(e){t.reportUnexpectedError(e),a(e)}}}},n)})),E=function(){c.editableList("empty");var t=0;if(e.git.hasOwnProperty("remotes"))for(var o in e.git.remotes)e.git.remotes.hasOwnProperty(o)&&(t++,c.editableList("addItem",{name:o,urls:e.git.remotes[o]}));(s=0===t)&&c.editableList("addItem",r)};E()}function y(o){var i=$('<div id="red-ui-project-settings-tab-settings" class="red-ui-project-settings-tab-pane red-ui-help"></div>');return function(o,i){var n,a=$("<h3></h3>").text(RED._("sidebar.project.projectSettings.files")).appendTo(i),r=$('<div class="red-ui-settings-section"></div>').appendTo(i);if(RED.user.hasPermission("projects.write"))var s=$('<button type="button" id="red-ui-project-settings-tab-settings-file-edit" class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(a).on("click",(function(e){e.preventDefault(),V.show(),s.hide(),o.files.package||(p.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.packageCreate")),p.show()),u.show(),y.hide(),E.show(),D.show(),w(),j.addClass("uneditable-input"),$(".red-ui-settings-row-credentials").show(),j.css("height","auto"),I.hide(),L.show()}));n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.package")).appendTo(n);var d=$('<div class="uneditable-input" style="padding:0">').appendTo(n),l=$('<span style="display:inline-block;  padding: 6px">').text(o.files.package||"package.json").appendTo(d),c=$('<input type="hidden">').val(o.files.package||"package.json").appendTo(d),u=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(d).on("click",(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),d.find(".red-ui-projects-file-listing-container").slideUp(200,(function(){$(this).remove(),d.css("height","")})),d.css("color","");else{$(this).addClass("selected"),d.css("color","inherit");var t=v(d,o,c.val(),(function(e){return e.children||/package\.json$/.test(e.path)}),(function(e,t){if(e){c.val(e),l.text(e);var o=e.substring(0,e.length-12);m.text(o),_.text(o),w(),p.hide()}t&&$(u).trigger("click"),C()}));d.css("height","auto"),setTimeout((function(){t.slideDown(200)}),50)}}));RED.popover.tooltip(u,RED._("sidebar.project.projectSettings.selectFile"));var p=$('<label style="margin-left: 110px" class="red-ui-projects-edit-form-sublabel"><small><span class="form-warning"><i class="fa fa-warning"></i> <span class="red-ui-projects-edit-form-sublabel-text"></span></small></label>').appendTo(n).hide();o.files.package||(p.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),p.show());var f=o.files.package||"package.json",h=f.substring(0,f.length-12);n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.flow")).appendTo(n);var g=$('<div class="uneditable-input" style="padding:0">').appendTo(n),m=$('<span style="display:inline-block; padding: 6px 0 6px 6px">').text(h).appendTo(g),b="flows.json";o.files.flow&&(b=0===o.files.flow.indexOf(h)?o.files.flow.substring(h.length):o.files.flow);var y=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(b).appendTo(g),w=function(){E.css({width:"calc(100% - "+(D.width()+m.width())+"px)"})},E=$('<input type="text" style="padding-left:1px; margin-top: -2px; margin-bottom: 0;border: none;">').val(b).hide().appendTo(g),D=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(g).on("click",(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),g.find(".red-ui-projects-file-listing-container").slideUp(200,(function(){$(this).remove(),g.css("height","")})),g.css("color","");else{$(this).addClass("selected"),g.css("color","inherit");var t=c.val(),i=t.substring(0,t.length-12),n=new RegExp("^"+i+".*.json$"),a=v(g,o,E.val(),(function(e){return!/package.json$/.test(e.path)&&n.test(e.path)&&!/_cred\.json$/.test(e.path)}),(function(e,t){e&&E.val(e.substring(i.length)),t&&$(D).trigger("click"),C()}));g.css("height","auto"),setTimeout((function(){a.slideDown(200)}),50)}}));RED.popover.tooltip(D,RED._("sidebar.project.projectSettings.selectFile")),n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.credentials")).appendTo(n);var R="flows_cred.json";o.files.credentials&&(R=0===o.files.flow.indexOf(h)?o.files.credentials.substring(h.length):o.files.credentials);var x=$('<div class="uneditable-input" style="padding:0">').appendTo(n),_=$('<span style="display:inline-block;padding: 6px 0 6px 6px">').text(h).appendTo(x),k=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(R).appendTo(x),T=$('<input type="hidden">').val(R).insertAfter(x),C=function(){var e,t=E.val(),o=/^(.+?)(\.[^.]*)?$/.exec(t);o?k.text(o[1]+"_cred"+(o[2]||".json")):""===t&&k.text(""),T.val(k.text());var i=""===t||/\.\./.test(t)||/\/$/.test(t);e=i||""===k.text(),M.is(":visible")&&(z.toggleClass("input-error",""===z.val()),e=e||""===z.val()),B.is(":visible")&&(G.toggleClass("input-error",""===G.val()),e=e||""===G.val()),E.toggleClass("input-error",i),J.toggleClass("disabled",e),J.prop("disabled",e)};E.on("change keyup paste",C),n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$("<label></label>").appendTo(n);var j=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(n),L=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(n);j.css("color","#666"),L.css("vertical-align","top");var S=$('<button type="button" class="red-ui-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(L).on("click",(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),I.hide()):(G.val(""),M.hide(),B.show(),$(this).addClass("selected"),O.removeClass("selected"),A.show(),F.show(),N.hide(),P.hide(),I.show()),C()}));RED.popover.tooltip(S,RED._("sidebar.project.projectSettings.resetTheEncryptionKey"));var O=$('<button type="button" class="red-ui-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(L).on("click",(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),I.hide()):(z.val(""),G.val(""),o.settings.credentialSecretInvalid||!o.settings.credentialsEncrypted?(N.show(),P.hide(),M.hide()):(M.show(),N.hide(),P.show()),B.show(),O.addClass("selected"),S.removeClass("selected"),A.hide(),F.hide(),I.show()),C()}));RED.popover.tooltip(O,RED._("sidebar.project.projectSettings.changeTheEncryptionKey")),n=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').hide().appendTo(r);var I=$("<div>",{style:"margin-top:10px"}).hide().appendTo(j),N=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.setTheEncryptionKey")+"</div>").hide().appendTo(I),P=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.changeTheEncryptionKey")+"</div>").hide().appendTo(I),A=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.resetTheEncryptionKey")+"</div>").hide().appendTo(I),M=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(I);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.currentKey")).appendTo(M);var z=$('<input type="text">').appendTo(M).typedInput({type:"cred"}).on("change keyup paste",(function(){e&&(e.close(),e=null),C()})),B=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(I);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.newKey")).appendTo(B);var G=$('<input type="text">').appendTo(B).typedInput({type:"cred"}).on("change keyup paste",C),F=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i>'+RED._("sidebar.project.projectSettings.credentialsAlert")+"</div>").hide().appendTo(I),U=function(){s.show(),V.hide(),u.hide(),y.show(),E.hide(),D.hide(),j.removeClass("uneditable-input"),j.css("height",""),D.removeClass("selected"),g.find(".red-ui-projects-file-listing-container").remove(),g.css("height",""),g.css("color",""),$(".red-ui-settings-row-credentials").hide(),I.hide(),L.hide(),S.removeClass("selected"),O.removeClass("selected")},V=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(r);$('<button type="button" class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(V).on("click",(function(e){e.preventDefault();var t=o.files.package||"package.json",i=t.substring(0,t.length-12);m.text(i),_.text(i),l.text(o.files.package||"package.json"),o.files.package?p.hide():(p.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),p.show()),E.val(y.text()),k.text(R),U()}));var J=$('<button type="button" class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(V).on("click",(function(i){i.preventDefault();var n=t.addSpinnerOverlay(r),a=function(e){n.remove(),e?t.reportUnexpectedError(e):(y.text(E.val()),k.text(T.val()),p.hide(),U())},s=c.val();s=s.substring(0,s.length-12);var d={files:{package:c.val(),flow:s+E.val(),credentials:s+T.val()}};S.hasClass("selected")&&(d.resetCredentialSecret=!0),(S.hasClass("selected")||O.hasClass("selected"))&&(d.credentialSecret=G.val(),M.is(":visible")&&(d.currentCredentialSecret=z.val())),RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+o.name,type:"PUT",responses:{0:function(e){a(e)},200:function(e){o=e,RED.sidebar.versionControl.refresh(!0),q(),a()},400:{credentials_load_failed:function(e){a(e)},missing_current_credential_key:function(t){z.addClass("input-error"),e=RED.popover.create({target:z,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),a(t)},"*":function(e){a(e)}}}},d).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))})),q=function(){o.settings.credentialSecretInvalid?(j.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),j.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.invalidEncryptionKey"))):o.settings.credentialsEncrypted?(j.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),j.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionEnabled"))):(j.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),j.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionDisabled"))),S.toggleClass("disabled",!o.settings.credentialSecretInvalid&&!o.settings.credentialsEncrypted),S.prop("disabled",!o.settings.credentialSecretInvalid&&!o.settings.credentialsEncrypted)};C(),q()}(o,i),b(o,i),i}function w(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(E.hasOwnProperty(t)||(E[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),E[t].count++)}}var E={};return{init:function(o){t=o,a({id:"main",title:RED._("sidebar.project.name"),get:u,close:function(){}}),a({id:"deps",title:RED._("sidebar.project.dependencies"),get:g,close:function(){}}),a({id:"settings",title:RED._("sidebar.project.settings"),get:y,close:function(){e&&(e.close(),e=null)}}),RED.events.on("nodes:add",w),RED.events.on("nodes:remove",(function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&E.hasOwnProperty(t)&&(E[t].count--,0===E[t].count&&(E[t].known||delete E[t]))}}))},show:function(e){if(!i)if(RED.user.hasPermission("projects.write")){i=!0;var t={title:RED._("sidebar.project.projectSettings.title"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){o=e.width},open:function(t){var o=RED.projects.getActiveProject(),i=t.find(".red-ui-tray-body"),a=$("<div></div>").appendTo(i),r=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(a);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(r);var s=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout((function(){d.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()}),50)}}),d=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(a);n.forEach((function(e){s.addTab({id:"red-ui-project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(o).hide().appendTo(d)})),a.i18n(),s.activateTab("red-ui-project-settings-tab-"+(e||"main")),$("#red-ui-sidebar-shade").show()},close:function(){i=!1,n.forEach((function(e){e.close&&e.close()})),$("#red-ui-sidebar-shade").hide()},show:function(){}};null!==o&&(t.width=o),RED.tray.show(t)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){E={}}}}(),RED.projects.userSettings=function(){var e,t,o;function i(i){var n=$('<div id="red-ui-settings-tab-gitconfig" class="project-settings-tab-pane red-ui-help"></div>');return function(o){var i=RED.settings.get("git")||{};i.user=i.user||{},$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.committerDetail")).appendTo(o);var n=$('<div class="red-ui-settings-section"></div>').appendTo(o);$('<div class="red-ui-settings-section-description"></div>').appendTo(n).text(RED._("editor:sidebar.project.userSettings.committerTip"));var a=$('<div class="red-ui-settings-row"></div>').appendTo(n);$('<label for="user-settings-gitconfig-username"></label>').text(RED._("editor:sidebar.project.userSettings.userName")).appendTo(a),(e=$('<input type="text" id="user-settings-gitconfig-username">').appendTo(a)).val(i.user.name||""),a=$('<div class="red-ui-settings-row"></div>').appendTo(n),$('<label for="user-settings-gitconfig-email"></label>').text(RED._("editor:sidebar.project.userSettings.email")).appendTo(a),(t=$('<input type="text" id="user-settings-gitconfig-email">').appendTo(a)).val(i.user.email||"")}(n),function(e){var t=RED.settings.theme("projects.workflow.mode","manual"),o=RED.settings.get("git")||{};o.workflow=o.workflow||{},o.workflow.mode=o.workflow.mode||t,$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.workflow")).appendTo(e);var i=$('<div class="red-ui-settings-section"></div>').appendTo(e);$('<div class="red-ui-settings-section-description"></div>').appendTo(i).text(RED._("editor:sidebar.project.userSettings.workfowTip"));var n=$('<div class="red-ui-settings-row"></div>').appendTo(i);$('<label><input type="radio" name="user-setting-gitworkflow" value="manual"> <div style="margin-left: 3px; display: inline-block"><div data-i18n="editor:sidebar.project.userSettings.workflowManual"></div><div style="color:#aaa;" data-i18n="editor:sidebar.project.userSettings.workflowManualTip"></div></div></label>').appendTo(n),n=$('<div class="red-ui-settings-row"></div>').appendTo(i),$('<label><input type="radio" name="user-setting-gitworkflow" value="auto"> <div style="margin-left: 3px; display: inline-block"><div data-i18n="editor:sidebar.project.userSettings.workflowAuto"></div><div style="color:#aaa;" data-i18n="editor:sidebar.project.userSettings.workflowAutoTip"></div></div></label>').appendTo(n),i.find('[name="user-setting-gitworkflow"][type="radio"][value="'+o.workflow.mode+'"]').prop("checked",!0)}(n),function(e){$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.sshKeys")).appendTo(e);var i,n=$('<div class="red-ui-settings-section"></div>').appendTo(e),a=$('<div class="red-ui-settings-section-description"></div>').appendTo(n).text(RED._("editor:sidebar.project.userSettings.sshKeysTip")),r=$('<button id="user-settings-gitconfig-add-key" class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("editor:sidebar.project.userSettings.add")+"</button>").appendTo(a).on("click",(function(e){r.attr("disabled",!0),b.attr("disabled",!0),l.slideDown(200),p.trigger("focus")})),s=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(p.val());p.toggleClass("input-error",u&&!e);var t=h.val(),o=0===t.length||t.length>=8;h.toggleClass("input-error",!o),o?0===t.length?g.text(RED._("editor:sidebar.project.userSettings.optional")):g.text(""):g.text(RED._("editor:sidebar.project.userSettings.passphraseShort")),e=e&&o,b.attr("disabled",!e),i&&(i.close(),i=null)},d=$('<div class="red-ui-settings-row"></div>').appendTo(n),l=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(d);$('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("editor:sidebar.project.userSettings.addSshKey")).appendTo(l);var c=$("<div>").appendTo(l);d=$('<div class="red-ui-settings-row"></div>').appendTo(c),$('<div class="red-ui-settings-section-description"></div>').appendTo(d).text(RED._("editor:sidebar.project.userSettings.addSshKeyTip")),d=$('<div class="red-ui-settings-row"></div>').appendTo(c),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.name")).appendTo(d);var u=!1,p=$('<input type="text">').appendTo(d).on("change keyup paste",(function(){u=!0,s()}));$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.nameRule")+"</small></label>").appendTo(d).find("small");var f=$("<div>").appendTo(c);d=$('<div class="red-ui-settings-row"></div>').appendTo(f),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.passphrase")).appendTo(d);var h=$('<input type="password">').appendTo(d).on("change keyup paste",s),g=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.optional")+"</small></label>").appendTo(d).find("small"),v=function(){r.attr("disabled",!1),l.hide(),p.val(""),u=!1,h.val(""),i&&(i.close(),i=null)},m=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.cancel")+"</button>").appendTo(m).on("click",(function(e){e.preventDefault(),v()}));var b=$('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.generate")+"</button>").appendTo(m).on("click",(function(e){e.preventDefault();var i=o.addSpinnerOverlay(l).addClass("red-ui-component-spinner-contain"),n={name:p.val(),type:"generate"};n.comment=t.val(),n.password=h.val(),n.size=4096;var a=function(e){i.remove(),e||v()};RED.deploy.setDeployInflight(!0),o.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){a(e)},200:function(e){D(n.name),a()},400:{unexpected_error:function(e){console.log(e),a(e)}}}},n)}));d=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(n);var y={empty:!0},w=function(e,t){var i=$('<div class="red-ui-projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),n=$("<pre>",{style:"min-height: 80px"}).appendTo(i),a=o.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),r={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){n.text(e.publickey),a.remove()},400:{unexpected_error:function(e){console.log(e),a.remove()}}}};o.sendRequest(r);var s=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(i);return $('<button class="red-ui-button red-ui-button-small">'+RED._("editor:sidebar.project.userSettings.copyPublicKey")+"</button>").appendTo(s).on("click",(function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(n[0]),document.execCommand("copy"),document.getSelection().empty()}catch(e){}})),i},E=$('<ol class="red-ui-projects-dialog-ssh-key-list">').appendTo(d).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){var n=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(e);if(i.empty)return n.addClass("red-ui-search-empty"),void n.text(RED._("editor:sidebar.project.userSettings.noSshKeys"));var a=$('<div class="red-ui-projects-dialog-ssh-key-header">').appendTo(n);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(a),$('<span class="entry-name">').text(i.name).appendTo(a);var r,s=$('<span class="button-row entry-tools">').appendTo(a);a.on("click",(function(e){r?r.slideUp(200,(function(){r.remove(),r=null})):r=w(n,i)})),i.system||$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(s).on("click",(function(t){t.stopPropagation();var n=o.addSpinnerOverlay(e).addClass("red-ui-component-spinner-contain"),a=RED.notify(RED._("editor:sidebar.project.userSettings.deleteConfirm",{name:i.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.remove(),a.close()}},{text:RED._("editor:sidebar.project.userSettings.delete"),click:function(){a.close();var t={url:"settings/user/keys/"+i.name,type:"DELETE",responses:{200:function(t){e.fadeOut(200,(function(){E.editableList("removeItem",i),setTimeout(n.remove,100),0===E.editableList("length")&&E.editableList("addItem",y)}))},400:{unexpected_error:function(e){console.log(e),n.remove()}}}};o.sendRequest(t)}}]})})),i.expand&&(r=w(n,i))}}),D=function(e){$.getJSON("settings/user/keys",(function(t){t.keys&&(t.keys.sort((function(e,t){return e.name.localeCompare(t.name)})),E.editableList("empty"),t.keys.forEach((function(t){t.name===e&&(t.expand=!0),E.editableList("addItem",t)})),0===E.editableList("length")&&E.editableList("addItem",y))}))};D()}(n),n}return{init:function(n){o=n,RED.userSettings.add({id:"gitconfig",title:RED._("editor:sidebar.project.userSettings.gitConfig"),get:i,close:function(){var o=RED.settings.get("git")||{};o.user=o.user||{},o.user.name=e.val(),o.user.email=t.val(),o.workflow=o.workflow||{},o.workflow.mode=$('[name="user-setting-gitworkflow"][type="radio"]:checked').val(),RED.settings.set("git",o)}})}}}(),RED.sidebar.versionControl=function(){var e,t,o,i,n,a,r,s,d,l,c,u,p,f,h,g,v,m={};function b(e,t,o,i){e.addClass("red-ui-sidebar-vc-change-entry");var n=$("<div>").appendTo(e);if(t.label){if(e.addClass("red-ui-help-info-none"),n.text(t.label),t.button){n.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var a=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(n);$('<button class="red-ui-button red-ui-button-small"></button>').text(t.button.label).appendTo(a).on("click",t.button.click)}}else{var r,s,d=$('<i class=""></i>').appendTo(n),l=$('<a href="#">').appendTo(n).on("click",(function(e){e.preventDefault(),function(e,t){var o=RED.projects.getActiveProject(),i="staged"===t?"index":"tree";h.sendRequest({url:"projects/"+o.name+"/diff/"+i+"/"+encodeURIComponent(e.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(i){var n;n="unstaged"===t?RED._("sidebar.project.versionControl.unstagedChanges")+" : "+e.file:"staged"===t?RED._("sidebar.project.versionControl.stagedChanges")+" : "+e.file:RED._("sidebar.project.versionControl.resolveConflicts")+" : "+e.file;var a={diff:i.diff,title:n,unmerged:"unmerged"===t,project:o};"unstaged"==t?(a.oldRevTitle=" "===e.indexStatus?RED._("sidebar.project.versionControl.head"):RED._("sidebar.project.versionControl.staged"),a.newRevTitle=RED._("sidebar.project.versionControl.unstaged"),a.oldRev=" "===e.indexStatus?"@":":0",a.newRev="_"):"staged"===t?(a.oldRevTitle=RED._("sidebar.project.versionControl.head"),a.newRevTitle=RED._("sidebar.project.versionControl.staged"),a.oldRev="@",a.newRev=":0"):(a.oldRevTitle=RED._("sidebar.project.versionControl.local"),a.newRevTitle=RED._("sidebar.project.versionControl.remote"),a.commonRev=":1",a.oldRev=":2",a.newRev=":3",a.onresolve=function(t){h.sendRequest({url:"projects/"+o.name+"/resolve/"+encodeURIComponent(e.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:t.resolutions[e.file]})}),RED.diff.showUnifiedDiff(a)},400:{unexpected_error:function(e){console.log(e)}}}})}(t,i)})),c=$("<span>").appendTo(l),u=$('<div class="red-ui-sidebar-vc-change-entry-tools">').appendTo(e);if("unstaged"===i&&(r=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(u),s=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(r).on("click",(function(e){e.preventDefault();var o=h.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),i=RED.notify(RED._("sidebar.project.versionControl.revert",{file:t.file}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.remove(),i.close()}},{text:RED._("sidebar.project.versionControl.revertChanges"),click:function(){i.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+t.file,type:"DELETE",responses:{200:function(e){o.remove()},400:{unexpected_error:function(e){o.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),h.sendRequest(e).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]})})),RED.popover.tooltip(s,RED._("sidebar.project.versionControl.revertChanges"))),r=$('<span class="button-group"></span>').appendTo(u),"unmerged"!==i){var p=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-'+("unstaged"===i?"plus":"minus")+'"></i></button>').appendTo(r).on("click",(function(o){o.preventDefault();var n=RED.projects.getActiveProject();t.spinner=h.addSpinnerOverlay(e).addClass("projects-version-control-spinner-sidebar"),h.sendRequest({url:"projects/"+n.name+"/stage/"+encodeURIComponent(t.file),type:"unstaged"===i?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})}));RED.popover.tooltip(p,RED._("sidebar.project.versionControl."+("unstaged"===i?"stage":"unstage")+"Change"))}t["update"+("unstaged"===i?"Unstaged":"Staged")]=function(e,t){n.removeClass();var o="";"A"===t?(n.addClass("red-ui-diff-state-added"),o="fa-plus-square"):"?"===t?(n.addClass("red-ui-diff-state-unchanged"),o="fa-question-circle-o"):"D"===t?(n.addClass("red-ui-diff-state-deleted"),o="fa-minus-square"):"M"===t?(n.addClass("red-ui-diff-state-changed"),o="fa-square"):"R"===t?(n.addClass("red-ui-diff-state-changed"),o="fa-toggle-right"):"U"===t?(n.addClass("red-ui-diff-state-conflicted"),o="fa-exclamation-triangle"):o="fa-exclamation-triangle",c.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(c),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(c),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(c)),d.removeClass(),d.addClass("fa "+o),e.spinner&&(e.spinner.remove(),delete e.spinner),s&&s.toggle("?"!==t),l.toggleClass("disabled","D"===t||"?"===t)},t["update"+("unstaged"===i?"Unstaged":"Staged")](t,o)}}function y(e){var t=Date.now()/1e3-e,o=Math.floor(t/86400);if(o>30)return new Date(1e3*e).toLocaleDateString();if(o>0)return RED._("sidebar.project.versionControl.daysAgo",{count:o});var i=Math.floor(t/3600);if(i>0)return RED._("sidebar.project.versionControl.hoursAgo",{count:i});var n=Math.floor(t/60);return n>0?RED._("sidebar.project.versionControl.minsAgo",{count:n}):RED._("sidebar.project.versionControl.secondsAgo")}function w(e,t){var i=RED.projects.getActiveProject();(r=t?h.addSpinnerOverlay(o.parent()):h.addSpinnerOverlay(n.parent())).addClass("red-ui-component-spinner-sidebar");var a=t?{files:e}:void 0;h.sendRequest({url:"projects/"+i.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},a)}var E=!1;function D(e,t,o,i,n){var a=h.addSpinnerOverlay(o),r=e+"?limit="+(i||20);n&&(r+="&before="+n),h.sendRequest({url:r,type:"GET",responses:{0:function(e){console.log(e)},200:function(o){var n;o.commits.forEach((function(e){t.editableList("addItem",e),n=e.sha})),t.loadMoreItem&&(t.editableList("removeItem",t.loadMoreItem),delete t.loadMoreItem);var r=t.editableList("length");r<o.total&&(t.loadMoreItem={totalKnown:r,total:o.total,url:e,before:n+"~1",limit:i},t.editableList("addItem",t.loadMoreItem)),a.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function R(t){var c=t.files;r&&(r.remove(),r=null),(f=!!t.merging)?(e.addClass("red-ui-sidebar-vc-merging"),s.show()):(e.removeClass("red-ui-sidebar-vc-merging"),s.hide()),o.editableList("removeItem",g),n.editableList("removeItem",g),d.editableList("removeItem",v);var u=Object.keys(c).filter((function(e){return"f"===c[e].type}));u.sort();var p=Date.now()+Math.floor(100*Math.random());u.forEach((function(e){var t=c[e],i=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),m[e]?(m[e].unmerged&&!t.unmerged?(d.editableList("removeItem",m[e]),i=!0):!m[e].unmerged&&t.unmerged&&(o.editableList("removeItem",m[e]),n.editableList("removeItem",m[e])),m[e].status!==t.status&&(" "!==m[e].treeStatus?" "===t.treeStatus?o.editableList("removeItem",m[e]):t.treeStatus!==m[e].treeStatus&&m[e].updateUnstaged(t,t.treeStatus):i=!0," "!==m[e].indexStatus&&"?"!==m[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?n.editableList("removeItem",m[e]):t.indexStatus!==m[e].indexStatus&&m[e].updateStaged(t,t.indexStatus):i=!0),m[e].status=t.status,m[e].indexStatus=t.indexStatus,m[e].treeStatus=t.treeStatus,m[e].oldName=t.oldName,m[e].unmerged=t.unmerged):(i=!0,m[e]=t),m[e].updateIndex=p,i&&(t.unmerged?d.editableList("addItem",m[e]):(" "!==t.treeStatus&&o.editableList("addItem",m[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&n.editableList("addItem",m[e]))))})),Object.keys(m).forEach((function(e){m[e].updateIndex!==p&&(o.editableList("removeItem",m[e]),n.editableList("removeItem",m[e]),delete m[e])}));var h=n.editableList("length"),b=o.editableList("length"),y=d.editableList("length");l.prop("disabled",f&&y>0||!f&&0===h),i.prop("disabled",0===b),a.prop("disabled",0===h),0===h&&n.editableList("addItem",g),0===b&&o.editableList("addItem",g),0===y&&d.editableList("addItem",v)}function x(e,t){if(!E&&(e&&(m={},o.editableList("empty"),n.editableList("empty"),d.editableList("empty")),RED.user.hasPermission("projects.write"))){E=!0,function(){u.editableList("empty");var e=RED.projects.getActiveProject();e&&D("projects/"+e.name+"/commits",u,u.parent())}();var i=RED.projects.getActiveProject();if(i){var a="projects/"+i.name+"/status";t&&(a+="?remote=true"),$.getJSON(a,(function(e){R(e),$("#red-ui-sidebar-vc-local-branch").text(e.branches.local),$("#red-ui-sidebar-vc-remote-branch").text(e.branches.remote||RED._("sidebar.project.versionControl.none"));var t=e.commits.ahead||0,o=e.commits.behind||0;i.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#red-ui-sidebar-vc-repo-status-auth-issue").show(),$("#red-ui-sidebar-vc-repo-status-stats").hide(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-toolbar-message").hide(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").show()):($("#red-ui-sidebar-vc-repo-toolbar-message").show(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").hide(),$("#red-ui-sidebar-vc-repo-status-auth-issue").hide(),$("#red-ui-sidebar-vc-repo-status-stats").show(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-status-button").show(),e.branches.hasOwnProperty("remote")?_(t,o):($("#red-ui-sidebar-vc-commits-ahead").text(""),$("#red-ui-sidebar-vc-commits-behind").text(""),$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.notTracking")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))):$("#red-ui-sidebar-vc-repo-status-button").hide(),E=!1,$(".red-ui-sidebar-vc-shade").hide()})).fail((function(){E=!1}))}else $(".red-ui-sidebar-vc-shade").show(),o.editableList("empty"),n.editableList("empty"),d.editableList("empty")}}function _(e,t){$("#red-ui-sidebar-vc-commits-ahead").text(e),$("#red-ui-sidebar-vc-commits-behind").text(t),f?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.statusUnmergedChanged")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):e>0&&0===t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAhead",{count:e})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1)):0===e&&t>0?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsBehind",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):e>0&&t>0?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAheadAndBehind1",{count:t})+RED._("sidebar.project.versionControl.commitsAheadAndBehind2",{count:e})+RED._("sidebar.project.versionControl.commitsAheadAndBehind3",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0===e&&0===t&&($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.repositoryUpToDate")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))}function k(){x(),RED.sidebar.show("version-control")}return{init:function(r){h=r,RED.actions.add("core:show-version-control-tab",k),RED.events.on("deploy",(function(){var e=RED.projects.getActiveProject();if(e){var t=RED.settings.theme("projects.workflow.mode","manual");"auto"===(((RED.settings.get("git")||{}).workflow||{}).mode||t)?x(!0):(m={},o.editableList("empty"),n.editableList("empty"),d.editableList("empty"),$.getJSON("projects/"+e.name+"/status",(function(e){R(e)})))}})),RED.events.on("login",(function(){x(!0)})),e=$("<div>",{class:"red-ui-sidebar-vc"});var f=$("<div>",{class:"red-ui-sidebar-vc-stack"}).appendTo(e);t=RED.stack.create({container:f,fill:!0,singleExpanded:!0}),(c=t.add({title:RED._("sidebar.project.versionControl.localChanges"),collapsible:!0})).expand(),c.content.css({height:"100%"});var E=$('<div style="float: right"></div>').appendTo(c.header),T=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),x(!0)}));RED.popover.tooltip(T,RED._("sidebar.project.versionControl.refreshChanges")),g={label:RED._("sidebar.project.versionControl.none")},v={label:RED._("sidebar.project.versionControl.conflictResolve")};var C=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(c.content),j=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.localFiles")+"</div>").appendTo(C);i=$('<button class="red-ui-button red-ui-button-small" style="position: absolute; right: 5px; top: 5px;"><i class="fa fa-plus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(j).on("click",(function(e){e.preventDefault(),e.stopPropagation(),w(Object.keys(m).filter((function(e){return" "!==m[e].treeStatus})),!0)})),RED.popover.tooltip(i,RED._("sidebar.project.versionControl.stageAllChange")),(o=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(C)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){b(e,o,o.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),s=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(c.content),j=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.unmergedChanges")+"</div>").appendTo(s),E=$('<div style="position: absolute; right: 5px; top: 5px;"></div>').appendTo(j);var L=$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.abortMerge")+"</button>").appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation();var t=h.addSpinnerOverlay(s),o=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+o.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),x(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}));(d=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(s)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){o===v&&(o.button={label:RED._("sidebar.project.versionControl.commit"),click:function(e){e.preventDefault(),e.stopPropagation(),O()}}),b(e,o,o.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var S=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(c.content);j=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.changeToCommit")+"</div>").appendTo(S),E=$('<div style="position: absolute; right: 5px; top: 5px;"></div>').appendTo(j);var O=function(){I.val(""),A.prop("disabled",!0),C.css("height","30px"),s.is(":visible")?(s.css("height","30px"),S.css("height","calc(100% - 60px - 175px)")):S.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout((function(){commitBox.css("height","175px")}),10),i.prop("disabled",!0),a.prop("disabled",!0),l.prop("disabled",!0),L.prop("disabled",!0),I.trigger("focus")};l=$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.commit")+"</button>").appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),O()})),RED.popover.tooltip(l,RED._("sidebar.project.versionControl.commitChanges")),a=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-minus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),w(Object.keys(m).filter((function(e){return" "!==m[e].indexStatus&&"?"!==m[e].indexStatus})),!1)})),RED.popover.tooltip(a,RED._("sidebar.project.versionControl.unstageAllChange")),(n=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(S)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){b(e,o,o.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-bottom"></div>').hide().appendTo(c.content);var I=$("<textarea></textarea>").attr("placeholder",RED._("sidebar.project.versionControl.commitPlaceholder")).appendTo(commitBox).on("change keyup paste",(function(){A.prop("disabled",""===$(this).val().trim())})),N=$('<div class="red-ui-sidebar-vc-slide-box-toolbar button-group">').appendTo(commitBox),P=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.cancelCapital")+"</button>").appendTo(N).on("click",(function(e){e.preventDefault(),I.val(""),C.css("height",""),s.css("height",""),S.css("height",""),commitBox.css("height",0),setTimeout((function(){commitBox.hide()}),200),i.prop("disabled",!1),a.prop("disabled",!1),l.prop("disabled",!1),L.prop("disabled",!1)})),A=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.commitCapital")+"</button>").appendTo(N).on("click",(function(e){e.preventDefault();var t=h.addSpinnerOverlay(A).addClass("red-ui-component-spinner-sidebar"),o=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+o.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),P.trigger("click"),x(!0)},400:{"*":function(e){h.reportUnexpectedError(e)}}}},{message:I.val()}).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))})),M=t.add({title:RED._("sidebar.project.versionControl.commitHistory"),collapsible:!0});E=$('<div style="float: right"></div>').appendTo(M.header),T=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),x(!0,!0)})),RED.popover.tooltip(T,RED._("sidebar.project.versionControl.refreshCommitHistory"));var z=$('<div class="red-ui-sidebar-vc-change-header" style="text-align: right;"></div>').appendTo(M.content),B=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.branch")+' <span id="red-ui-sidebar-vc-local-branch"></span></button>').appendTo(z).on("click",(function(e){if(e.preventDefault(),$(this).hasClass("selected"))F();else{q(),p.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();V.refresh("projects/"+t.name+"/branches"),U.show(),setTimeout((function(){U.css("height","215px"),V.focus()}),100)}}));RED.popover.tooltip(B,RED._("sidebar.project.versionControl.changeLocalBranch"));var G=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 10px;" id="red-ui-sidebar-vc-repo-status-button"><span id="red-ui-sidebar-vc-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="red-ui-sidebar-vc-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="red-ui-sidebar-vc-commits-behind"></span></span><span id="red-ui-sidebar-vc-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(z).on("click",(function(e){if(e.preventDefault(),$(this).hasClass("selected"))q();else{F(),p.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),J.show(),setTimeout((function(){J.css("height","265px")}),100)}}));RED.popover.tooltip(G,RED._("sidebar.project.versionControl.manageRemoteBranch")),u=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(M.content),p=$('<div class="red-ui-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(M.content),u.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){if(e.addClass("red-ui-sidebar-vc-commit-entry"),o.url)e.addClass("red-ui-sidebar-vc-commit-more"),e.text("+ "+(o.total-o.totalKnown)+RED._("sidebar.project.versionControl.moreCommits")),e.on("click",(function(t){t.preventDefault(),D(o.url,u,e,o.limit,o.before)}));else{e.on("click",(function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+o.sha,(function(e){e.project=t,e.parents=o.parents,e.oldRev=o.sha+"~1",e.newRev=o.sha,e.oldRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+o.sha.substring(0,7)+"~1",e.newRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+o.sha.substring(0,7),e.date=y(parseInt(o.date)),RED.diff.showCommitDiff(e)}))}));var i=$("<div>").appendTo(e);if($('<div class="red-ui-sidebar-vc-commit-subject">').text(o.subject).appendTo(i),o.refs){var n=$('<div class="red-ui-sidebar-vc-commit-refs">').appendTo(i);o.refs.forEach((function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="red-ui-sidebar-vc-commit-ref">').text(t).appendTo(n)})),e.addClass("red-ui-sidebar-vc-commit-head")}$('<div class="red-ui-sidebar-vc-commit-sha">').text(o.sha.substring(0,7)).appendTo(i),$('<div class="red-ui-sidebar-vc-commit-date">').text(y(parseInt(o.date))).appendTo(i)}}});var F=function(e){B.removeClass("selected"),U.css("height","0"),p.hide(),setTimeout((function(){U.hide(),e&&e()}),200)},U=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px;"></div>').hide().appendTo(M.content);$('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.changeLocalBranch")).appendTo(U);var V=h.createBranchList({placeholder:RED._("sidebar.project.versionControl.createBranchPlaceholder"),container:U,onselect:function(e){if(e.current)return F();var t=h.addSpinnerOverlay(U),o=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+o.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){F((function(){t.remove()}))},400:{git_local_overwrite:function(e){t.remove(),RED.notify(RED._("sidebar.project.versionControl.localOverwrite"),{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}),J=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px"></div>').hide().appendTo(M.content),q=function(){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),G.removeClass("selected"),J.css("height","0"),p.hide(),setTimeout((function(){J.hide(),W()}),200)},W=function(e){H.hasClass("selected")&&(H.removeClass("selected"),Z.height(0),J.css("height","265px"),setTimeout((function(){Z.hide(),e&&e()}),200))};$('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.manageRemoteBranch")).appendTo(J);var K=$('<div style="margin-bottom: 5px;"></div>').appendTo(J),H=$('<button id="red-ui-sidebar-vc-repo-branch" class="red-ui-sidebar-vc-repo-action red-ui-button"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.remote")+': <span id="red-ui-sidebar-vc-remote-branch"></span></button>').appendTo(K).on("click",(function(e){if(e.preventDefault(),$(this).hasClass("selected"))W();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();Q.refresh("projects/"+t.name+"/branches/remote"),Z.show(),setTimeout((function(){Z.height(180),J.css("height","445px"),Q.focus()}),100)}}));$('<div id="red-ui-sidebar-vc-repo-toolbar-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').appendTo(J);var X=$('<div id="red-ui-sidebar-vc-repo-toolbar-error-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(J);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> '+RED._("sidebar.project.versionControl.unableToAccess")+"</div>").appendTo(X);var Y=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(X);$('<button class="red-ui-button" style="width: 80%;"><i class="fa fa-refresh"></i> '+RED._("sidebar.project.versionControl.retry")+"</button>").appendTo(Y).on("click",(function(e){e.preventDefault();var t=RED.projects.getActiveProject(),o=h.addSpinnerOverlay(J).addClass("red-ui-component-spinner-contain");h.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always((function(){o.remove()}))})),$('<div class="red-ui-sidebar-vc-slide-box-header" style="height: 20px;"><label id="red-ui-sidebar-vc-repo-toolbar-set-upstream-row" for="red-ui-sidebar-vc-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="red-ui-sidebar-vc-repo-toolbar-set-upstream"> '+RED._("sidebar.project.versionControl.setUpstreamBranch")+"</label></div>").appendTo(J);var Z=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(K),Q=h.createBranchList({placeholder:RED._("sidebar.project.versionControl.createRemoteBranchPlaceholder"),currentLabel:RED._("sidebar.project.versionControl.upstream"),remotes:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)},container:Z,onselect:function(e){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!1),$("#red-ui-sidebar-vc-remote-branch").text(e.name+(e.create?" *":""));var t=RED.projects.getActiveProject();t.git.branches.remote===e.name?delete t.git.branches.remoteAlt:t.git.branches.remoteAlt=e.name,$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),W((function(){if(e.create)t.git.branches.remote?$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.selectUpstreamBranch")):($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.trackedUpstreamBranch")),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!0),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!0)),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1);else{var o=Date.now(),i=h.addSpinnerOverlay($("#red-ui-sidebar-vc-repo-toolbar-message")).addClass("red-ui-component-spinner-contain");$.getJSON("projects/"+t.name+"/branches/remote/"+e.name+"/status",(function(e){setTimeout((function(){_(e.commits.ahead,e.commits.behind),i.remove()}),Math.max(400-(Date.now()-o),0))}))}}))}}),ee=$('<div style="margin-bottom: 5px;"></div>').appendTo(J);$('<button id="red-ui-sidebar-vc-repo-push" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-up"></i> <span data-i18n="sidebar.project.versionControl.push"></span></button>').appendTo(ee).on("click",(function(e){e.preventDefault();var t=h.addSpinnerOverlay(J).addClass("red-ui-component-spinner-contain"),o=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(t);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(o).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}));var i=RED.projects.getActiveProject();RED.eventLog.startEvent("Push changes"+(i.git.branches.remoteAlt?" : "+i.git.branches.remoteAlt:""));var n="projects/"+i.name+"/push";i.git.branches.remoteAlt&&(n+="/"+i.git.branches.remoteAlt);var a=$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked");a&&(n+="?u=true"),h.sendRequest({url:n,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){a&&i.git.branches.remoteAlt&&(i.git.branches.remote=i.git.branches.remoteAlt,delete i.git.branches.remoteAlt),x(!0),q()},400:{git_push_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.pushFailed"),"error")},unexpected_error:function(e){console.log(e)}}}},{}).always((function(){t.remove()}))}));var te=function(e){e=e||{};var t=h.addSpinnerOverlay(J).addClass("red-ui-component-spinner-contain"),o=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(t);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(o).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}));var i=RED.projects.getActiveProject();RED.eventLog.startEvent("Pull changes"+(i.git.branches.remoteAlt?" : "+i.git.branches.remoteAlt:""));var n="projects/"+i.name+"/pull";i.git.branches.remoteAlt&&(n+="/"+i.git.branches.remoteAlt),(e.setUpstream||e.allowUnrelatedHistories)&&(n+="?"),e.setUpstream&&(n+="setUpstream=true",e.allowUnrelatedHistories&&(n+="&")),e.allowUnrelatedHistories&&(n+="allowUnrelatedHistories=true"),h.sendRequest({url:n,type:"POST",responses:{0:function(e){console.log(e)},200:function(t){e.setUpstream&&i.git.branches.remoteAlt&&(i.git.branches.remote=i.git.branches.remoteAlt,delete i.git.branches.remoteAlt),x(!0),q()},400:{git_local_overwrite:function(e){RED.notify(RED._("sidebar.project.versionControl.unablePull")+'<p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">'+RED._("sidebar.project.versionControl.showUnstagedChanges")+"</a></p>","error",!1,1e7)},git_pull_merge_conflict:function(e){x(!0),q()},git_connection_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.connectionFailed")+e.toString(),"warning")},git_pull_unrelated_history:function(t){var o=RED.notify(RED._("sidebar.project.versionControl.pullUnrelatedHistory"),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close()}},{text:RED._("sidebar.project.versionControl.pullChanges"),click:function(){o.close(),e.allowUnrelatedHistories=!0,te(e)}}]})},"*":function(e){h.reportUnexpectedError(e)}}}},{}).always((function(){t.remove()}))};$('<button id="red-ui-sidebar-vc-repo-pull" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-down"></i> <span data-i18n="sidebar.project.versionControl.pull"></span></button>').appendTo(ee).on("click",(function(e){e.preventDefault(),te({setUpstream:$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked")})})),$('<div class="red-ui-shade red-ui-sidebar-vc-shade">').appendTo(e),RED.sidebar.addTab({id:"version-control",label:RED._("sidebar.project.versionControl.history"),name:RED._("sidebar.project.versionControl.projectHistory"),content:e,enableOnEdit:!1,pinned:!0,iconClass:"fa fa-code-fork",action:"core:show-version-control-tab",onchange:function(){setTimeout((function(){t.resize()}),10)}})},show:k,refresh:x,showLocalChanges:function(){RED.sidebar.show("version-control"),c.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var e=null,t=!1,o=!1,i=null;return{show:function(n,a,r){t=!0;try{for(var s=(e=d3.select("body").append("div").classed("red-ui-editor-radial-menu",!0).on("touchstart",(function(){v(),d3.event.preventDefault()}))).append("div").style({top:a[1]-80+"px",left:a[0]-80+"px"}),d=[],l=function(e,t,o){o.el=s.append("div").classed("red-ui-editor-radial-menu-opt",!0).style({top:t+80-25+"px",left:e+80-25+"px"}).classed("red-ui-editor-radial-menu-opt-disabled",!!o.disabled),o.el.html(o.name),o.x=e,o.y=t,d.push(o),o.el.on("touchstart",(function(){o.el.classed("red-ui-editor-radial-menu-opt-active",!0),d3.event.preventDefault(),d3.event.stopPropagation()})),o.el.on("touchend",(function(){v(),o.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()}))},c=r.length,u=Math.max(Math.PI/(c-1),Math.PI/4),p=Math.PI,f=0;f<c;f++){var h=Math.floor(80*Math.cos(p)),g=Math.floor(80*Math.sin(p));r[f].name&&l(h,g,r[f]),p+=u}var v=function(){t=!1,i=null,e.remove(),e=null};n.on("touchend.radial",(function(){if(n.on("touchend.radial",null),n.on("touchmenu.radial",null),i){try{i.onselect()}catch(e){RED._debug(e)}v()}else o&&v()})),n.on("touchmove.radial",(function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-a[0],e.pageY-a[1]],n=0;n<d.length;n++){var r=d[n];r.disabled||(t[0]>r.x-30&&t[0]<r.x+30&&t[1]>r.y-30&&t[1]<r.y+30?r!==i&&(r.el.classed("selected",!0),i=r):(r===i&&(i=null),r.el.classed("selected",!1)))}if(!i){var s=Math.abs(t[0]*t[0]+t[1]*t[1]);o=s>6400}}catch(e){RED._debug(e)}}))}catch(e){RED._debug(e)}},active:function(){return t}}}(),RED.tourGuide=function(){var e,t,o,i,n,a,r=[],s={};function d(e,t){s[e]?t(null,s[e]):import(e).then((function(o){s[e]=o.default,t(null,s[e])})).catch((function(e){t(e)}))}function l(){if(n){if(a)t.css({left:$(window).width()/2+"px",top:$(window).height()/2+"px",width:"0px",height:"0px"});else{var e=n[0].getBoundingClientRect(),i=Math.max(50,1.5*Math.max(e.width,e.height));t.css({left:e.left+e.width/2+"px",top:e.top+e.height/2+"px",width:2*i+"px",height:2*i+"px"});t[0].offsetHeight;t.addClass("transition"),t.css({width:i+"px",height:i+"px"})}o&&o.move({target:n})}}function c(e,t,i){function n(){r.forEach((function(e){"dom-event"===e.type?e.target[0].removeEventListener(e.event,e.listener,e.opts):"nr-event"===e.type&&RED.events.off(e.event,e.listener)})),r=[],setTimeout((function(){i()}),0)}if(e.complete){if(0!==e.complete.length)return o&&(o.element.hide(),a||(a=!0,l())),void e.complete.call(t,(function(){o&&o.element.show(),n()}));e.complete.call(t)}n()}function u(e){if("string"==typeof e)return e;var t=RED.i18n.lang()||"en-US",o=Object.keys(e);return e[t]||e["en-US"]||e[o[0]]}return{load:d,run:function(s,p){p=p||function(e){e&&console.error(e)},d(s,(function(s,d){s?console.warn("Error loading tour:",s):function(s,d){e=$('<div class="red-ui-tourGuide-shade"></div>').appendTo(document.body),t=$('<div class="red-ui-tourGuide-shade-focus"></div>').appendTo(e),$(window).on("resize.red-ui-tourGuide",(function(){l()}));var p=0,f={index:0,count:s.steps.length};function h(t){$(window).off("resize.red-ui-tourGuide"),$(document).off("keydown.red-ui-tourGuide"),o&&o.close(),i=null,o=null,e.remove(),e=null,d(t)}function g(d){if(!1!==d)if(p!==s.steps.length){f.index=p;try{!function(s,d,p){e.fadeIn(),function(e,t,i){if(e.prepare){if(0!==e.prepare.length)return o&&(o.element.hide(),a||(a=!0,l())),void e.prepare.call(t,(function(){o&&o.element.show(),i()}));e.prepare.call(t)}i()}(s,d,(function(){var f,h=s.direction||"bottom";if(a=!1,"string"==typeof s.element?n=$(s.element):"function"==typeof s.element?n=s.element.call(d):s.element?n=s.element:(n=$(".red-ui-editor"),a=!0,h="inset"),0===n.length)throw n=null,e.hide(),new Error("Element not found");$(window).width()<400&&(n=$(".red-ui-editor"),a=!0,h="inset"),f=n.css("z-index"),a||!s.interactive&&!s.wait||n.css("z-index",2002),l(),i?i.empty():i=$('<div style="position:relative"></div>'),$('<button type="button" class="red-ui-button red-ui-button-small" style="float: right; margin-top: -4px; margin-right: -4px;"><i class="fa fa-times"></i></button>').appendTo(i).click((function(e){e.preventDefault(),c(s,d,(function(){p(!1)}))}));var g=$('<div class="red-ui-tourGuide-popover-description"></div>').appendTo(i);s.titleIcon&&$('<h2><i class="'+s.titleIcon+'"></i></h2>').appendTo(g),s.title&&$("<h2>").text(u(s.title)).appendTo(g),$("<div>").css("text-align","left").html(u(s.description)).appendTo(g),s.image&&$(`<img src="red/tours/${s.image}" />`).appendTo(g);var v,m=$("<div>",{class:"red-ui-tourGuide-toolbar"}).appendTo(i);$("<small>").text(d.index+1+"/"+d.count).appendTo(m),!a&&s.wait||(v=$('<button type="button" class="red-ui-button" style="position: absolute; right:0;bottom:0;"></button>').appendTo(m).one("click",(function(e){e.preventDefault(),E()})),d.index===d.count-1?$("<span></span>").text(RED._("common.label.close")).appendTo(v):0===d.index?($("<span>start</span>").text(RED._("tourGuide.start")).appendTo(v),$('<span style="margin-left: 6px"><i class="fa fa-chevron-right"></i></span>').appendTo(v)):d.index<d.count-1&&($("<span></span>").text(RED._("tourGuide.next")).appendTo(v),$('<span style="margin-left: 6px"><i class="fa fa-chevron-right"></i></span>').appendTo(v)));var b=s.width;a&&(b=500);var y=Math.min($(window).width()-10,Math.max(b||0,300));o||(o=RED.popover.create({target:n,width:b||"auto",maxWidth:y+"px",direction:h,class:"red-ui-tourGuide-popover"+(a?" ":""),trigger:"manual",content:i}).open()),$(document).off("keydown.red-ui-tourGuide"),$(document).on("keydown.red-ui-tourGuide",(function(e){"Escape"!==e.key&&"Esc"!==e.key||(e.preventDefault(),e.stopPropagation(),c(s,d,(function(){p(!1)})))})),o.element.toggleClass("red-ui-tourGuide-popover-full",!!a),o.move({target:n,width:b||"auto",maxWidth:y+"px",direction:h}),setTimeout((function(){o.element.position().left<0&&o.element.css({left:0})}),100),v&&setTimeout((function(){v.focus()}),100);var w=n[0]instanceof SVGElement;s.fallback&&t.one("mouseenter",(function(i){setTimeout((function(){var i=n[0].getBoundingClientRect(),a=Math.max(50,1.5*Math.max(i.width,i.height));t.css({width:4*a+"px",height:4*a+"px"}),e.fadeOut(),o.move({target:$(".red-ui-editor"),direction:s.fallback,offset:10,transition:!0})}),w?0:500)}));var E=function(){t.removeClass("transition"),n.css("z-index",f),c(s,d,p)};if(s.wait)if("dom-event"===s.wait.type){var D=n;s.wait.element&&("string"==typeof s.wait.element?D=$(s.wait.element):"function"==typeof s.wait.element&&(D=s.wait.element.call(d)));var R={type:s.wait.type,target:D,event:s.wait.event,listener:function(){E()},opts:{once:!0}};r.push(R),D[0].addEventListener(R.event,R.listener,R.opts)}else if("nr-event"===s.wait.type){R={type:s.wait.type,event:s.wait.event,listener:function(){s.wait.filter&&!s.wait.filter.apply(d,arguments)||E()}};r.push(R),RED.events.on(R.event,R.listener)}}))}(s.steps[p++],f,g)}catch(e){return void h(e)}}else h();else h(!1)}g()}(d,p)}))},list:function(){return[{id:"3_0",label:"3.0",path:"./tours/welcome.js"},{id:"2_2",label:"2.2",path:"./tours/2.2/welcome.js"},{id:"2_1",label:"2.1",path:"./tours/2.1/welcome.js"}]},reset:function(){RED.settings.set("editor.tours.welcome","")}}}();